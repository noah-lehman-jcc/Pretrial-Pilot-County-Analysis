---
title: "County Data Loading"
author: "Noah Lehman"
date: "10/15/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Libraries
```{r}
library(data.table)
library(openxlsx)
library(readxl)
library(lubridate)
library(tidyverse)
```

# Function Creation
```{r}
# name_keeper <- function(df){
#   attr(df, "names_original") <- names(df)
# }

rm(name_keeper)
```


# Alameda

--Next Step: Create Mapping between variables in codebook. 

Jail Data
```{r}{r eval=FALSE, include=FALSE}
original_df <- list()

# Jail Bookings
book_df <- lapply(1:4, function(i){
  fread(paste0("Historical Data Submissions/Alameda/BOOK_", i, ".csv"), colClasses = "character")}) %>%
  bind_rows()

original_field <- names(book_df)

names(book_df) <- c("cii", "fbi", "pfn_x", "first_name", "last_name", "dob", "dln", "dln_state", "race_code", "race", "sex_cd", "arrest_date", "arrest_time", "jail_court_id", "booking_seq", "book_type_code", "book_type", "book_date", "book_time", "release_date", "release_time", "release_type_code", "release_type", "case_id", "case_number")

original_df[[1]] <- tibble(table_name = "book_df", original_field = original_field, modified_field = names(book_df))

book_df <- book_df %>%
  mutate(arrest_date_time = mdy_hms(paste(arrest_date, arrest_time), tz = 'America/Los_Angeles'),
         book_date_time = mdy_hms(paste(book_date, book_time), tz = 'America/Los_Angeles'),
         release_date_time = mdy_hms(paste(release_date, release_time), tz = 'America/Los_Angeles')) %>%
  mutate_at(vars(dob, arrest_date, book_date, release_date), mdy) 

# Jail Booking Charges
book_charge <- lapply(1:2, function(i){
  fread(paste0("Historical Data Submissions/Alameda/ARRCHG_", i, ".csv"), colClasses = "character")}) %>%
  bind_rows()

original_field <- names(book_charge)

names(book_charge) <- c("jail_court_id", "charge_num", "entry_code", "charge_code", "charge", "charge_level")

original_df[[2]] <- tibble(table_name = "book_charge", original_field = original_field, modified_field = names(book_charge))
```

Court Data
```{r}{r eval=FALSE, include=FALSE}
# Court Cases
court_df <- lapply(c("", "_2"), function(i){
  fread(paste0("Historical Data Submissions/Alameda/CASE", i, ".csv"), colClasses = "character")}) %>%
  bind_rows()

original_field <- names(court_df)

names(court_df) <- c("case_id", "case_number", "jail_court_id", "pfn_x", "case_type_code", "case_type", "file_date", "case_status_code", "case_status", "case_status_date", "cii", "fbi", "dln", "dln_state", "dob", "dob_loc", "race_code", "race", "sex_code", "first_name", "last_name")

original_df[[3]] <- tibble(table_name = "court_df", original_field = original_field, modified_field = names(court_df))

court_df <- court_df %>%
  mutate(file_date = ymd(file_date))

# Court FTAs
court_fta <- lapply(c("", "_2"), function(i){
  fread(paste0("Historical Data Submissions/Alameda/FTA", i, ".csv"), colClasses = "character")}) %>%
  bind_rows()

original_field <- names(court_fta)

names(court_fta) <- c("case_id", "fta_date", "fta_id", "fta_type_code", "fta_type")

original_df[[4]] <- tibble(table_name = "court_fta", original_field = original_field, modified_field = names(court_fta))

court_fta <- court_fta %>%
  mutate(fta_date = ymd(fta_date))

# Court FTAs with Warrants
court_fta_war <- lapply(c("", "_2"), function(i){
  fread(paste0("Historical Data Submissions/Alameda/WARR", i, ".csv"), colClasses = "character")}) %>%
  bind_rows()

original_field <- names(court_fta_war)

names(court_fta_war) <- c("case_id", "fta_war_date", "fta_id", "fta_type_code", "fta_type")

original_df[[5]] <- tibble(table_name = "court_fta_war", original_field = original_field, modified_field = names(court_fta_war))

court_fta_war <- court_fta_war %>%
  mutate(fta_war_date = ymd(fta_war_date))

# Court Hearings
court_hearing <- lapply(1:8, function(i){
  fread(paste0("Historical Data Submissions/Alameda/HEA_", i, ".csv"), colClasses = "character")}) %>%
  bind_rows()

original_field <- names(court_hearing)

names(court_hearing) <- c("case_id", "case_number", "event_num", "event_id", "hearing_type_code", "hearing_type", "hearing_date", "hearing_time")

original_df[[6]] <- tibble(table_name = "court_hearing", original_field = original_field, modified_field = names(court_hearing))

court_hearing <- court_hearing %>%
  mutate(hearing_date_time = mdy_hms(paste(hearing_date, hearing_time), tz = "America/Los_Angeles"),
         hearing_date = mdy(hearing_date)) 
  # select(-hearing_time)

# Court Filing Charges
court_charge <- lapply(1:8, function(i){
  fread(paste0("Historical Data Submissions/Alameda/CHG_", i, ".csv"), colClasses = "character")}) %>%
  bind_rows()

original_field <- names(court_charge)

names(court_charge) <- c("case_id", "case_number", "event_num", "chare_id", "charge_history_id", "charge_number", "allegation", "qualifier", "offense_id", "charge", "charge_level", "event_date", "event_hist_id", "stage", "event_id", "event_type_code", "event_type", "amend_reason_id", "amend_reason")

original_df[[7]] <- tibble(table_name = "court_charge", original_field = original_field, modified_field = names(court_charge))

court_charge <- court_charge %>%
  mutate(event_date = ymd(event_date))

# Court Sentences to Confinement 
court_sent <- lapply(c("", "_2"), function(i){
  fread(paste0("Historical Data Submissions/Alameda/JAIL", i, ".csv"), colClasses = "character")}) %>%
  bind_rows()

original_field <- names(court_sent)

names(court_sent) <- c("case_id", "case_number", "event_num", "event_id", "sentence_date", "amend_reason_code", "amend_reason", "sentence_id", "component_instance_id", "start_date", "confinement_type_code", "confinement_type", "facilty_id", "facility", "term_type_code", "term_type", "term_years", "term_months", "term_days", "term_to_life", "life_flag", "death_flag")

original_df[[8]] <- tibble(table_name = "court_sent", original_field = original_field, modified_field = names(court_sent))

court_sent <- court_sent %>%
  mutate_at(vars(sentence_date, start_date), ymd)

# Court Sentences to Supervision
court_sup <- lapply(c("", "_2"), function(i){
  fread(paste0("Historical Data Submissions/Alameda/SUP", i, ".csv"), colClasses = "character")}) %>%
  bind_rows()

original_field <- names(court_sup)

names(court_sup) <- c("case_id", "case_number", "event_num", "event_id", "sentence_date", "amend_reason_code", "amend_reason", "sentence_id", "component_instance_id", "probation_type_code", "probation_type", "start_date", "end_date", "term_years", "term_months", "term_days", "latest_status_code", "latest_status")

original_df[[9]] <- tibble(table_name = "court_sup", original_field = original_field, modified_field = names(court_sup))

court_sup <- court_sup %>%
  mutate_at(vars(sentence_date, start_date, end_date), ymd)
```

Code Book
```{r eval=FALSE, include=FALSE}
rm(original_field)

original_df <- bind_rows(original_df)

Alameda_df <- lapply(ls()[!grepl("original", ls())], function(i){
  df <- get(i)
  
  if(sum(grepl("date", names(df))) > 0){
  df2 <- df %>%
  select(contains("date"), -contains("time")) %>%
  gather("modified_field", "value") %>%
  group_by(modified_field) %>%
  summarise_all(funs(min = as.character(min(., na.rm = T)), mean = as.character(mean(., na.rm = T)), max = as.character(max(., na.rm = T))))
  }else{
    df2 <- tibble(modified_field = NA_character_, min = NA_character_, mean = NA_character_, max = NA_character_)
  }
  
  df <- df %>%
    mutate_if(~length(unique(.)) > 50|is.Date(.)|is.POSIXct(.), ~(. = "not_factor")) %>%    
    mutate_all(~if_else(is.na(.), "na_missing", as.character(.))) %>%
    gather(modified_field, factor_value) %>%
    count(modified_field, factor_value) %>%
    mutate(table_name = i, county = "Alameda") %>%
    mutate(factor_flag = if_else(factor_value == "not_factor", 0, 1)) %>%
    group_by(table_name, modified_field) %>%
    mutate(table_count = sum(n)) %>%
    ungroup() %>%
    rename("factor_count" = "n") %>%
    mutate(factor_count = if_else(factor_value == "not_factor", NA_integer_, factor_count),
           factor_percent = round(factor_count/table_count*100, 1)) %>%
    arrange(desc(factor_flag), modified_field, desc(factor_count))
  
  df <- left_join(df, df2, by = "modified_field")
    }) %>% 
  bind_rows() %>%
  left_join(original_df) %>%
   select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_count,
           factor_percent, table_count, min, mean, max) 

write.xlsx(Alameda_df, file = "Code Books/Alameda Code Book.xlsx")
```

Join
```{r eval=FALSE, include=FALSE}
#Alameda has an integrated criminal justice system. Information is joined across agencies on the jail_court_ID. It is contained in the book_df, court_df, and book_charge tables. 

#Jail Court ID is duplicated when split between cases
book_df <- book_df %>% distinct(jail_court_id, .keep_all = T)

#Jail Court ID is duplicated when split between cases
court_df <- court_df %>% distinct(jail_court_id, .keep_all = T)

book_no_court <- anti_join(book_df, court_df, by = c("jail_court_id"))
nrow(book_df)
nrow(book_no_court)
nrow(book_no_court)/nrow(book_df)

court_no_book <- anti_join(court_df, book_df, by = c("jail_court_id"))
nrow(court_df)
nrow(court_no_book)
nrow(court_no_book)/nrow(court_df)
```

# Calaveras

Jail Data
```{r}
book_df <- read_excel("Historical Data Submissions/Calaveras/JailData.xlsx")

names(book_df) <- c("name", "cii", "fbi", "alpha_num", "dln", "race", "sex", "dob", "arrest_date", "book_num", "book_date", "book_type", "case_number", "charge", "charge_level", "bail_amt", "disposition_type", "disposition_date", "release_date", "release_type")

book_df <- book_df %>%
  mutate(arrest_date_time = mdy_hm(arrest_date),
         book_date_time = mdy_hm(book_date),
         arrest_date = as_date(arrest_date_time),
         book_date =as_date(book_date_time),
         dob = as_date(dob))
```

Probation Data
```{r}
prob_df <- read_excel("Historical Data Submissions/Calaveras/ProbationData.xlsx", col_types = "text")

names(prob_df) <- c("cii", "fbi", "dln", "local_id", "name", "dob", "sex", "race")

prob_df <- prob_df %>%
  mutate(dob = convertToDate(dob))
```

# Kings

Jail Data (Maybe all data?, no FTA information)
```{r}
book_df <- fread("Historical Data Submissions/Kings/Pretrial Pilot Program-2015.csv")
book_df2 <- fread("Historical Data Submissions/Kings/Pretrial Pilot Program-2016.csv")
book_df3 <- fread("Historical Data Submissions/Kings/Pretrial Pilot Program-2017.csv")
book_df4 <- fread("Historical Data Submissions/Kings/Pretrial Pilot Program-2018.csv")
book_df5 <- fread("Historical Data Submissions/Kings/Pretrial Pilot Program-2019.csv")

book_df <- bind_rows(book_df, book_df2, book_df3, book_df4, book_df5)

rm(book_df2, book_df3, book_df4, book_df5)

#bunch of demo info that needs fixing
names(book_df) <- c("title", "demo_info", "book_num", "book_date", "book_type", "release_date", "release_type", "case_id", "charge_ref", "counts_ref", "charge_level_ref", "disposition_type_ref", "disposition_date_ref", "charge", "counts", "charge_level", "disposition_type", "disposition_date", "total")

book_df <- book_df %>%
  separate(demo_info, paste("x", 1:20, sep = "_"), sep = "\\\r\\\n") %>%
  separate(x_20, paste("y", 1:5, sep = "_"), sep = ":") %>%
  rename(cii = y_2, fbi = y_3, local_id = y_4, employed = y_5, dob = x_8, gender = x_10, race = x_12, dln = x_15,
         dln_state = x_17) %>%
  unite(name, c(x_3, x_5, x_1), sep = " ") %>%
  select(-c(x_2, x_4, x_6, x_7, x_9, x_11, x_13, x_14, x_16, x_18, x_19, y_1)) %>%
  mutate(cii = gsub(" FBI", "", cii),
         fbi = gsub(" Local ID", "", fbi),
         local_id = gsub(" Employer", "", local_id),
         employed = if_else(employed != " ", 1, 0),
         total = parse_number(total)) %>%
  mutate_at(vars(book_num:case_id), funs(gsub(".*: ","",.))) %>%
  select(-contains("ref"), -title) %>%
  mutate(dob = mdy(dob),
         book_date_time = mdy_hm(book_date),
         release_date_time = mdy_hm(release_date),
         book_date = as_date(book_date_time),
         release_date = as_date(release_date_time),
         disposition_date = as_date(mdy_hms(disposition_date)))

```

# Los Angeles
Jail Data
```{r}
original_df <- list()

# Jail Bookings
book_df <- lapply(2015:2019, function(i){
  read_xlsx(paste0("Historical Data Submissions/Los Angeles/",i, ".xlsx"))}) %>%
  bind_rows()

original_field <- names(book_df)

names(book_df) <- c("cii", "fbi", "pfn_x", "first_name", "last_name", "dob", "dln", "dln_state", "race_code", "race", "sex_cd", "arrest_date", "arrest_time", "jail_court_id", "booking_seq", "book_type_code", "book_type", "book_date", "book_time", "release_date", "release_time", "release_type_code", "release_type", "case_id", "case_number")

original_df[[1]] <- tibble(table_name = "book_df", original_field = original_field, modified_field = names(book_df))

book_df <- book_df %>%
  mutate(arrest_date_time = mdy_hms(paste(arrest_date, arrest_time), tz = 'America/Los_Angeles'),
         book_date_time = mdy_hms(paste(book_date, book_time), tz = 'America/Los_Angeles'),
         release_date_time = mdy_hms(paste(release_date, release_time), tz = 'America/Los_Angeles')) %>%
  mutate_at(vars(dob, arrest_date, book_date, release_date), mdy) 

# Jail Booking Charges
book_charge <- lapply(1:2, function(i){
  fread(paste0("Historical Data Submissions/Alameda/ARRCHG_", i, ".csv"), colClasses = "character")}) %>%
  bind_rows()

original_field <- names(book_charge)

names(book_charge) <- c("jail_court_id", "charge_num", "entry_code", "charge_code", "charge", "charge_level")

original_df[[2]] <- tibble(table_name = "book_charge", original_field = original_field, modified_field = names(book_charge))

book_df %>%
  filter(BOOKINGDATE != ARRESTDATE)
```

Court Data
```{r}
# Court Cases
court_df <- lapply(c("", "_2"), function(i){
  fread(paste0("Historical Data Submissions/Alameda/CASE", i, ".csv"), colClasses = "character")}) %>%
  bind_rows()

original_field <- names(court_df)

names(court_df) <- c("case_id", "case_number", "jail_court_id", "pfn_x", "case_type_code", "case_type", "file_date", "case_status_code", "case_status", "case_status_date", "cii", "fbi", "dln", "dln_state", "dob", "dob_loc", "race_code", "race", "sex_code", "first_name", "last_name")

original_df[[3]] <- tibble(table_name = "court_df", original_field = original_field, modified_field = names(court_df))

court_df <- court_df %>%
  mutate(file_date = ymd(file_date))

# Court FTAs
court_fta <- lapply(c("", "_2"), function(i){
  fread(paste0("Historical Data Submissions/Alameda/FTA", i, ".csv"), colClasses = "character")}) %>%
  bind_rows()

original_field <- names(court_fta)

names(court_fta) <- c("case_id", "fta_date", "fta_id", "fta_type_code", "fta_type")

original_df[[4]] <- tibble(table_name = "court_fta", original_field = original_field, modified_field = names(court_fta))

court_fta <- court_fta %>%
  mutate(fta_date = ymd(fta_date))

# Court FTAs with Warrants
court_fta_war <- lapply(c("", "_2"), function(i){
  fread(paste0("Historical Data Submissions/Alameda/WARR", i, ".csv"), colClasses = "character")}) %>%
  bind_rows()

original_field <- names(court_fta_war)

names(court_fta_war) <- c("case_id", "fta_war_date", "fta_id", "fta_type_code", "fta_type")

original_df[[5]] <- tibble(table_name = "court_fta_war", original_field = original_field, modified_field = names(court_fta_war))

court_fta_war <- court_fta_war %>%
  mutate(fta_war_date = ymd(fta_war_date))

# Court Hearings
court_hearing <- lapply(1:8, function(i){
  fread(paste0("Historical Data Submissions/Alameda/HEA_", i, ".csv"), colClasses = "character")}) %>%
  bind_rows()

original_field <- names(court_hearing)

names(court_hearing) <- c("case_id", "case_number", "event_num", "event_id", "hearing_type_code", "hearing_type", "hearing_date", "hearing_time")

original_df[[6]] <- tibble(table_name = "court_hearing", original_field = original_field, modified_field = names(court_hearing))

court_hearing <- court_hearing %>%
  mutate(h
         # Modoc

Jail Data
```{r}
#Booking data
book_df <- fread("Historical Data Submissions/Modoc/Modoc Jail Pretrial  January 1 2013-November 30 2019.csv")

#The first 7 observations are test inputs
book_df <- book_df[8:length(book_df),]
```

Court Data 
```{r}
court_df <- read_excel("Historical Data Submissions/Modoc/Modoc Pretrial Assessment Information.xls", sheet = 1)

names(court_df) <- c("case_id", "name", "disposition_type", "disposition_date", "filing_date", "case_type")

court_charge <- read_excel("Historical Data Submissions/Modoc/Modoc Pretrial Assessment Information.xls", sheet = 2)

names(court_charge) <- c("case_id", "counts", "charge", "charge_level", "charge_description", "disposition_type", "disposition_date", "plea_type", "plea_date")

court_sent <- read_excel("Historical Data Submissions/Modoc/Modoc Pretrial Assessment Information.xls", sheet = 3)

names(court_sent) <- c("case_id", "sentence_date", "sentence_type", "term", "term_suspended", "sentence_location", "sentence_status", "count", "charge")

court_hearing <- read_excel("Historical Data Submissions/Modoc/Modoc Pretrial Assessment Information.xls", sheet = 4)

names(court_hearing) <- c("case_id", "hearing_type", "hearing_date", "hearing_time", "hearing_result")

court_lawyer <- read_excel("Historical Data Submissions/Modoc/Modoc Pretrial Assessment Information.xls", sheet = 5)

names(court_lawyer) <- c("case_id", "lawyer_type", "appointment_date", "appointment_status", "appointment_end_date")

court_person <- read_excel("Historical Data Submissions/Modoc/Modoc Pretrial Assessment Information.xls", sheet = 6)

names(court_person) <- c("first_name", "last_name", "dob", "sex", "race", "cii", "fbi", "arrest_num", "book_num")

court_bail <- read_excel("Historical Data Submissions/Modoc/Modoc Pretrial Assessment Information.xls", sheet = 7)

names(court_bail) <- c("case_id", "release_type", "release_date", "bail_status", "bail_status_date")

court_fta <- read_excel("Historical Data Submissions/Modoc/Modoc Pretrial Assessment Information.xls", sheet = 8)

names(court_fta) <- c("case_id", "fta_date", "fta")

court_fta_war <- read_excel("Historical Data Submissions/Modoc/Modoc Pretrial Assessment Information.xls", sheet = 9)

names(court_fta_war) <- c("case_id", "fta_date", "fta")
```

# Napa

Jail Data
```{r}
original_df <- list()

#Jail Demographic and Personal Identification
person_df <- read_excel("Historical Data Submissions/Napa/Historical_1.xlsx", sheet = 1)

original_field <- names(person_df)

names(person_df) <- c("cii", "fbi", "local_id", "dln", "dln_state", "name", "dob", "sex", "race")

original_df[[1]] <- tibble(table_name = "person_df", original_field = original_field, modified_field = names(person_df))

#Jail Booking Events 
book_df <- read_excel("Historical Data Submissions/Napa/Historical_1.xlsx", sheet = 2, col_types = "text")

original_field <- names(book_df)

names(book_df) <- c("book_num", "arrest_date", "case_id", "local_id", "book_type", "book_date", "release_date", "release_type")

original_df[[2]] <- tibble(table_name = "book_df", original_field = original_field, modified_field = names(book_df))

book_df <- book_df %>%
  mutate(release_date = convertToDate(release_date)) %>%
  mutate_at(vars(arrest_date, book_date),  funs("time" = convertToDateTime(.))) %>%
  mutate_at(vars(arrest_date, book_date), convertToDate)
```

DA Data (contains filing dates)
```{r}
#Filing Dates
da_df <- read_excel("Historical Data Submissions/Napa/Historical_1.xlsx", sheet = 3)

original_field <- names(da_df)

names(da_df) <- c("case_id", "local_id", "file_date", "case_status", "case_status_date")

original_df[[3]] <- tibble(table_name = "da_df", original_field = original_field, modified_field = names(da_df))

da_df <- da_df %>%
  mutate(file_date_time = file_date,
         case_status_date_time = case_status_date) %>%
  mutate_at(vars(file_date, case_status_date), as_date)

#Da Charges
da_charge <- read_excel("Historical Data Submissions/Napa/Historical_1.xlsx", sheet = 4)

original_field <- names(da_charge)

names(da_charge) <- c("case_id", "local_id", "charge", "charge_description", "charge_level", "plea_type")

original_df[[4]] <- tibble(table_name = "da_charge", original_field = original_field, modified_field = names(da_charge))
```

Court Data
```{r}

#Court Data on FTAs
court_df <- read_excel("Historical Data Submissions/Napa/Historical_1.xlsx", sheet = 5)

original_field <- names(court_df)

names(court_df) <- c("case_id", "local_id", "fta", "fta_warrant")

original_df[[5]] <- tibble(table_name = "court_df", original_field = original_field, modified_field = names(court_df))

#Court Charges
court_charge <- read_excel("Historical Data Submissions/Napa/Historical_1.xlsx", sheet = 6)

original_field <- names(court_charge)

names(court_charge) <- c("case_id", "local_id", "charge", "charge_description", "dispostion_type", "disposition_date", "sentence_type", "sentence_date")

original_df[[6]] <- tibble(table_name = "court_charge", original_field = original_field, modified_field = names(court_charge))

court_charge <- court_charge %>%
  mutate_at(vars(contains("date")), convertToDate)

#Court FTA Warrants
court_fta_war <- read_excel("Historical Data Submissions/Napa/Historical_1.xlsx", sheet = 7)

original_field <- names(court_fta_war)

names(court_fta_war) <- c("case_id", "local_id", "fta_war_date")

original_df[[7]] <- tibble(table_name = "court_fta_war", original_field = original_field, modified_field = names(court_fta_war))

#Court FTAs
court_fta <- read_excel("Historical Data Submissions/Napa/Historical_1.xlsx", sheet = 8)

original_field <- names(court_fta)

names(court_fta) <- c("case_id", "local_id", "fta_date")

original_df[[8]] <- tibble(table_name = "court_fta", original_field = original_field, modified_field = names(court_fta))
```

Assessment Data
```{r}
prob_df <- read_excel("Historical Data Submissions/Napa/Assessment_Historical.xlsx")

original_field <- names(prob_df)

names(prob_df) <- c("tool_name", "local_id", "zip_code", "assessment_date", "item_label", "assessment_item", "assessment_response", "risk_score", "risk_level")

original_df[[9]] <- tibble(table_name = "prob_df", original_field = original_field, modified_field = names(prob_df))
```

Code Book
```{r eval=FALSE, include=FALSE}
rm(original_field)

original_df <- bind_rows(original_df)

Napa_df <- lapply(ls()[!grepl("original", ls())], function(i){
  df <- get(i)
  
  if(sum(grepl("date", names(df))) > 0){
  df2 <- df %>%
  select(contains("date"), -contains("time")) %>%
  gather("modified_field", "value") %>%
  group_by(modified_field) %>%
  summarise_all(funs(min = as.character(min(., na.rm = T)), mean = as.character(mean(., na.rm = T)), max = as.character(max(., na.rm = T))))
  }else{
    df2 <- tibble(modified_field = NA_character_, min = NA_character_, mean = NA_character_, max = NA_character_)
  }
  
  df <- df %>%
    mutate_if(~length(unique(.)) > 50|is.Date(.)|is.POSIXct(.), ~(. = "not_factor")) %>%    
    mutate_all(~if_else(is.na(.), "na_missing", as.character(.))) %>%
    gather(modified_field, factor_value) %>%
    count(modified_field, factor_value) %>%
    mutate(table_name = i, county = "Napa") %>%
    mutate(factor_flag = if_else(factor_value == "not_factor", 0, 1)) %>%
    group_by(table_name, modified_field) %>%
    mutate(table_count = sum(n)) %>%
    ungroup() %>%
    rename("factor_count" = "n") %>%
    mutate(factor_count = if_else(factor_value == "not_factor", NA_integer_, factor_count),
           factor_percent = round(factor_count/table_count*100, 1)) %>%
    arrange(desc(factor_flag), modified_field, desc(factor_count))
  
  df <- left_join(df, df2, by = "modified_field")
    }) %>% 
  bind_rows() %>%
  left_join(original_df) %>%
   select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_count,
           factor_percent, table_count, min, mean, max) 

write.xlsx(Napa_df, file = "Code Books/Napa Code Book.xlsx")
```

# Nevada-Sierra

Nevada Jail Data
```{r eval=FALSE, include=FALSE}
#original_df <- list()

#Booking Data 
book_df <- lapply(c("Historical Data Submissions/Nevada/SO Pretrial Submitted Data.xlsx",
                    "Historical Data Submissions/Nevada/Aug and Sept 2019.xlsx",
                    "Historical Data Submissions/Nevada/Oct Through Jan Jail Pre Trial Data.xlsx"),
                  function(x) {
                    read_excel(x, col_types = c("text", rep("guess", 18)), na = "NULL")
                  }) %>%
  bind_rows()

original_field <- names(book_df)


names(book_df) <- c("cii", "name", "dob", "arrest_date_time", "book_num", "book_date_time", "book_type_original", "court_case_id", "arrest_charge_original", "arrest_charge_level_original", "release_date_time", "release_type_original", "fbi", "cdl_id", "sex_original", "race_original", "bail_amt", "employment_status", "county")

#original_df[[1]] <- tibble(table_name = "book_df", original_field = original_field, modified_field = names(book_df))

# Standardize Dates and Times
book_df$dob <- as_date(book_df$dob)

book_df$arrest_date_time <- as_datetime(book_df$arrest_date_time)
book_df$arrest_date <- as_date(book_df$arrest_date_time)
# length(unique(book_df$book_num[book_df$arrest_date < as_date("2015-01-01")]))
# 33 rows/17 bookings with arrest dates prior to 2015-01-01

book_df$book_date_time <- as_datetime(book_df$book_date_time)
book_df$book_date <- as_date(book_df$book_date_time)
# book_df[book_df$book_date > as_date("2019-09-30"), ]
# One book date later than 2019-09-30: 2026-02-03 (appears to be typo)
# book dates only go through 2019-08-01

book_df$release_date_time <- as_datetime(book_df$release_date_time)
book_df$release_date <- as_date(book_df$release_date_time)
# earliest release date is 2011-10-07, associated book date is 2016-03-05
# one other release date prior to 2015-01-01, book date is 2016-06-01
# book_df$earlier <- book_df$release_datetime < book_df$book_datetime
# book_df[book_df$earlier & !is.na(book_df$earlier), ]
# 26 rows where book date is later than release date

# case_id: seem to be matching values where only difference is number of leading zeroes following the "-"

# Standardize matching variables for joining data sets
book_df <- book_df %>%
  mutate(name = toupper(name)) %>% 
  mutate(name = (gsub(" -| - |- ", "-", name))) %>%     
        separate(name, c("first_name", "last_name", "middle_name", "suffix"),  sep = " ") %>%
        mutate_at(vars(first_name, last_name, middle_name), trimws) %>%
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, (cii)))
         

#this name fix is not perfect it misses last names that are spelled with a space in them  fix later

# Standardize Charges
book_df <- book_df %>%
  mutate(attempt = if_else(grepl("^664\\/", arrest_charge_original), 1, 0)) %>%
  separate_rows(arrest_charge_original, sep = "\\\\|\\/") %>%
  mutate(arrest_charge_level = case_when(arrest_charge_level_original %in% c("M", "MI") ~ "M",
                                         arrest_charge_level_original %in% c("F", "FE") ~ "F",
                                         arrest_charge_level_original %in% c("I") ~ "I",
                                         T ~ "Other"),
         arrest_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}","", arrest_charge_original))) %>%
 unite(join_var2, arrest_charge_level, arrest_charge, remove = F) 




# No code section in these data
book_df$arrest_charge_code <- NA

# Code for Charge Hierarchy
load("Complete Charge Code Hierarchy.RData")

#remove these flags becasue they are messing up the final join of court and jail data
charge_hier <- charge_hier %>%
  select (-c(fta_flag))

charge_hier<-charge_hier%>%
    unite(join_var2, charge_level, charge, remove = F) 

book_df <- left_join(book_df, charge_hier, by = "join_var2")

# Standardize Factors
book_df <- book_df %>%
  mutate(sex = case_when(sex_original %in% c("M") ~ "Male",
                         sex_original %in% c("F") ~ "Female",
                         sex_original %in% c("U") |
                           is.na(sex_original) ~ "Other_Unknown"),
         
         race = case_when(race_original %in% c("B") ~ "Black",
                          race_original %in% c("H") ~ "Hispanic",
                          race_original %in% c("W") ~ "White",
                          T ~ "Other_Unknown"), 

         book_type = case_when(book_type_original %in% c("STANDARD NEW CHARGES", "STANDARD") ~ "On_View",
                               book_type_original %in% c("COURT COMMIT") ~ "Commitment",
                               book_type_original %in% c("COURTESY" ) ~ "Hold",
                               book_type_original %in% c("COURT BOOK AND RELEA", "CONTRACT" ) ~ "Other"),
         release_type = case_when(release_type_original %in% c("CITE") ~ "Cite_Release",
                                  release_type_original %in% c("CTS") ~ "Time_Served",
                                  release_type_original %in% c("BAIL BOND", "CASH BAIL") ~ "Bail_Bond",
                                  release_type_original %in% c("CASE DISMISSED", "849.5 PC", 
                                                               "48 HR", "825 PC") ~ "Dismissed_Dropped",
                                  release_type_original %in% c("OR") ~ "OR",
                                  release_type_original %in% c("COR", "CD", "JUDGE") ~ "Court_Order",
                                  release_type_original %in% c("SCOR") ~"Pretrial_Sup", 
                                  release_type_original %in% c("BK AND RELEASE") ~"Administrative",
                                  release_type_original %in% c("849 PC", "849(B) PC") ~"Detain_Only",
                                  release_type_original %in% c("TSP") ~ "Prison",
                                  release_type_original %in% c("ICE", "USMS") ~ "Fed",
                                  release_type_original %in% c("") ~ "Unknown",
                                  release_type_original %in% c("AG") ~ "Hold_Released", T ~ "Other"))

#Flag Construction
book_df<- book_df %>%
    mutate(arrest_misd_flag=if_else(arrest_charge_level=="M", 1, 0),
           arrest_felony_flag =if_else(arrest_charge_level=="F", 1, 0),
           attempt_flag=if_else(attempt=="1", 1, 0),
           fta_flag=if_else(arrest_charge%in% c("8537", "1320A", "1320B", "13205", "40508A"), 1, 0)) 

           
            # not seeing any qualifier charges here  arrest_qualifier_flag=if_else()
            #sup_vio_post_flag=if_else(book_type=="Sup_Vio", 1, 0),
           
 


# Diagnostic Code for Charge Hierarchy
# 1 - 7,901/267,372 = 97% non-match rate
(1 - nrow(book_df %>% filter(is.na(hierarchy)))/nrow(book_df))*100

book_df %>%
  filter(is.na(hierarchy)) %>%
  count(join_var2) %>%
  arrange(desc(n))

# book_df%>%
#   filter(grepl("F_12032", join_var2))%>%
#   group_by(join_var2)%>%
#   count()
# 
# charge_hier%>%
#   filter(grepl("PROB", master_charge_description))

length(unique(book_df$book_num))

```

Nevada Jail Collapse
```{r eval=FALSE, include=FALSE}


book_df <- book_df %>%
  mutate(time_first_release = release_date_time - book_date_time) %>%
  mutate(hierarchy = if_else(is.na(hierarchy), 1e6, as.numeric(hierarchy))) %>%
  group_by(book_num, book_date) %>%
  mutate(max_booktype = book_type[hierarchy == min(hierarchy)][1],
        max_arrest_charge = arrest_charge[hierarchy == min(hierarchy)][1],
         max_charge_description = master_charge_description[hierarchy == min(hierarchy)][1],
         max_hier = min(hierarchy)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, .))) %>%
  mutate_at(vars(contains("flag")), funs("count" = sum(.))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  group_by(book_num, book_date, court_case_id) %>%
  filter(hierarchy == min(hierarchy)) %>%
  ungroup() %>%
  distinct(book_num, book_date, court_case_id, .keep_all = T) 

# Diagnostics
book_df %>%
  distinct(book_num, book_date) %>%
  arrange(book_num) %>%
  group_by(book_num) %>%
  add_count() %>%
  filter(n>1)

book_df %>%
  select(book_num, book_date, last_name) %>%
  distinct(book_num, book_date) 
```


Nevada Jail Diagnostics
```{r eval=FALSE, include=FALSE}

table(book_df$arrest_charge_original)[order(table(book_df$arrest_charge_original), decreasing = T)]


table(grep("\\/", book_df$arrest_charge_original, value = TRUE))

table(book_df$arrest_charge_level_original)

table(book_df$arrest_charge_original)[order(table(book_charge$arrest_charge_original), decreasing = T)]

book_df %>%
  count(arrest_charge_original, arrest_charge) %>%
  group_by(arrest_charge_original) %>%
  add_count() %>%
  filter(n > 1)

book_df$aco_count <- sapply(book_df$arrest_charge_original, function(x) length(which(book_df$arrest_charge_original == x)))
book_df$ac_count <- sapply(book_df$arrest_charge, function(x) length(which(book_df$arrest_charge == x)))
book_df$ac_counts_match <- book_df$aco_count == book_df$ac_count
table(book_df$ac_counts_match, useNA = "ifany")

book_df[!(book_df$ac_counts_match),
        c("book_num", "arrest_charge_level_original", "arrest_charge_original", "arrest_charge", "attempt",
          "aco_count", "ac_count")][order(book_df$arrest_charge[!(book_df$ac_counts_match)]), ]
```


Nevada Court Data
```{r eval=FALSE, include=FALSE}
#Court Status
court_df <- lapply(c("Historical Data Submissions/Nevada/PTRiskAss-Case+PtyData.csv",
                     "Historical Data Submissions/Nevada/Submitted 2-3/PTRiskAss-Case+PtyData.csv"),
                   function(x) {
                     fread(x, colClasses = "character")
                   }) %>%
  bind_rows()

original_field <- names(court_df)

#original_df <- list()

names(court_df) <- c("court_docket_id", "court_case_id", "file_date", "status", "status_date_time", "court_charge_description", "disposition_type_original", "disposition_date", "local_id", "first_name", "middle_name", "last_name", "suffix", "party_code", "ssn", "dob", "cii", "fbi", "sex_original", "race_original")
# local_id unknown

#original_df[[1]] <- tibble(table_name = "court_df", original_field = original_field, modified_field = names(court_df))


court_df <- court_df %>%
  mutate(dob = mdy(dob),
         status_date_time = mdy_hms(status_date_time),
         file_date = mdy(file_date),
         disposition_date = mdy(disposition_date),
         status_date = as_date(status_date_time)) %>%
        
  mutate(cii = gsub("-", "", cii), 
         cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, (cii)))


#check stuff
court_df %>%
   select (cii) %>%
  filter(grepl("-", cii))
  


table(court_df$suffix, useNA = "ifany")

# file_date range 1/2/2015-12/31/2019
# status_date_time range 1/6/2015-12/24/2019
# disposition_date range 1/2/2015-9/2/2027 (two later than current date)
# dob range 3/10/1924-6/3/2001

# Standardize Factors
court_df <- court_df %>%
  mutate(sex = case_when(sex_original %in% c("M") ~ "Male",
                         sex_original %in% c("F") ~ "Female", T ~ "Other_Unknown"),
         race = case_when(race_original %in% c("AA") ~ "Black",
                          race_original %in% c("HISP") ~ "Hispanic",
                          race_original %in% c("CAU") ~ "White",
                          T ~ "Other_Unknown"),
         disposition_type = case_when(disposition_type_original %in% c("DISMISSED", 
                                                                       "DISMISS AFTER APPEARANCE",
                                                                       "DISMISSED BEFORE TRIAL (W/O APPEARANCE)",
                                                                       "DISMISS/ACQUIT BEFORE EVIDENCE BY COURT",
                                                                       "DISMISS AFTER EVIDENCE BY JURY TRIAL",
                                                                       "DISMISS/ACQUIT AFTER EVIDENCE BY COURT",
                                                                       "DISMISSAL AFTER HEARING/PRELIM",
                                                                       "DISMISSAL BEFORE HEARING/PRELIM",
                                                                       "DISMISS/ACQUIT BEFORE EVIDENCE BY JURY TRIAL",
                                                                       "DISMISS W/O APPEARANCE") ~ "Dismissed",
                                      # disposition_type_original %in% c() ~ "Dropped",
                                      disposition_type_original %in% c("PLEA GUILTY/NOLO",
                                                                       "PLEA GUILTY/NOLO/MISD OTHER",
                                                                       "PLEA GUILTY/NOLO/MISD 17B",
                                                                       "CONVICT AFTER EVIDENCE BY COURT/FELONY",
                                                                       "CONVICT BEFORE EVIDENCE BY COURT",
                                                                       "CONVICT BEFORE EVIDENCE BY COURT/17B", 
                                                                       "PLEA GUILTY/NOLO/FELONY") ~ "Nolo_Contendere",
                                      disposition_type_original %in% c("CONVICTED",
                                                                       "CONVICT AFTER EVIDENCE BY JURY TRIAL",
                                                                       "CONVICT AFTER EVIDENCE BY JURY TRIAL/FELONY",
                                                                       "CONVICT AFTER EVIDENCE BY COURT",
                                                                       "CONVICT AFTER EVIDENCE BY JURY TRIAL/MISD OTHER",
                                                                       "CONVICT BEFORE EVIDENCE BY COURT/MISD OTHER",
                                                                       "CONVICT BEFORE EVIDENCE BY COURT/FELONY") ~ "Guilty",
                                      disposition_type_original %in% c("ACQUITTED/NOT GUILTY", 
                                                                       "NOT GUILTY/INSANE",
                                                                       "DO NOT USE - ACQUITTAL AFTER JURY TRIAL") ~ "Not_Guilty",
                                      disposition_type_original %in% c("CONSOLIDATED", 
                                                                       "EXTRADITED", 
                                                                       "CERTIFIED TO JUVENILE COURT", 
                                                                       "DO NOT USE THIS CODE!", 
                                                                       " ", 
                                                                       "UNDISPOSED",
                                                                       "PROBATION SUPERVISION - TRANSFER IN",
                                                                       "WAIVER OF EXTRADITION SIGNED",
                                                                       "CONSOLIDATED BEFORE HEARING/PRELIM/TRIAL",
                                                                       "COURT FINDING",
                                                                       "BAIL FORFEITURE",
                                                                       "UNKNOWN",
                                                                       "TRAFFIC SCHOOL - AFTER APPEARANCE/HEARING",
                                                                       "CONSOLIDATED AFTER HEARING/PRELIM/TRIAL",
                                                                       "TRAFFIC SCHOOL - BEFORE APPEARANCE/HEARING",
                                                                       "CHANGE OF VENUE - AFTER HEARING/PRELIM/TRIAL",
                                                                       "TRANSFER TO ANOTHER COURT") ~ "Other"))

# waiting for Dorian to check in with Nevada to see what the responses for STATUS mean
# sort(table(court_df$disposition_type_original[is.na(court_df$disposition_type)]), decreasing = TRUE)
# [grep("vio", court_df$court_charge_description, ignore.case = TRUE)]

court_df %>%
  filter(grepl("F15-000024", court_case_id))


# Court Charges
court_charges <- lapply(c("Historical Data Submissions/Nevada/PTRiskAss-Chg.csv",
                          "Historical Data Submissions/Nevada/Submitted 2-3/PTRiskAss-Chg.csv"),
                        fread) %>%
  bind_rows()

original_field <- names(court_charges)

names(court_charges) <- c("court_docket_id", "court_case_id", "local_id", "court_charge_number", "court_charge_code_original", "court_charge_level_original", "court_charge_description", "plea_type_original", "plea_date", "disposition_type_original", "disposition_date")

#original_df[[2]] <- tibble(table_name = "court_charges", original_field = original_field, modified_field = names(court_charges))

court_charges <- court_charges %>%
  mutate(plea_date = mdy(plea_date),
         disposition_date = mdy(disposition_date))

# plea_date range 9/8/2014-12/24/2019
# disposition_date range 1/22/1949-12/23/2019

# Charge recoding:
court_charges <- court_charges %>%
  mutate(attempt = if_else(grepl("\\(664\\)$|\\/664$|^664\\/", court_charge_code_original), 1, 0)) %>%
  mutate(court_charge_code = substr(court_charge_code_original, 1, 2),
         court_charge_code = ifelse(!(court_charge_code %in% c("PC", "VC", "HS", "BP", "WI","US")), "Other",
                                    court_charge_code),
         court_charge = ifelse(court_charge_code != "Other", substr(court_charge_code_original, 3,
                                                                    nchar(court_charge_code_original)), NA),
         court_charge = gsub("M$|F$|I$", "", court_charge), 
         court_charge = gsub("\\(664\\)$|\\/664$|^664\\)", "", court_charge),
         court_charge = gsub("\\(2ND\\)", "", court_charge),
         court_charge = gsub("\\-U18|\\-O21|\\-?18\\-21", "", court_charge),
         court_charge = gsub("\\+$|\\-", "", court_charge),
         court_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}","", court_charge)),
         court_charge_level = str_extract(court_charge_level_original, "[A-Z]{1}"),
         court_charge_level = if_else(court_charge_level  %in% c("F1"), "F" , court_charge_level),
         court_charge_level = if_else(!court_charge_level %in% c("F", "I", "M"), "Other", court_charge_level)) 

#unique(court_charges$court_charge[order(nchar(court_charges$court_charge), decreasing = TRUE)])
#court_charges[grep("\\(F\\)$|\\(I\\)$", court_charges$court_charge_code_original), ]   


court_charges<-court_charges%>%
unite(join_var, court_charge_level, court_charge_code, court_charge, remove = F) 

# sort(table(court_charges$court_charge_code_original[court_charges$court_charge_code == "Other"]), decreasing = TRUE)


#court_charges%>%
 # table(court_charges$disposition_type, useNA="ifany")


court_charges <- court_charges %>%
  mutate(disposition_type = case_when(disposition_type_original %in% c("DISMISSED") ~ "Dismissed",
                         #disposition_type_original %in% c("") ~ "Dropped",
                         #disposition_type_original %in% c("") ~ "Nolo_Contendere",
                         disposition_type_original %in% c("CONVICTED") ~ "Guilty",
                         disposition_type_original %in% c("ACQUITTED/NOT GUILTY", "NOT GUILTY/INSANE") ~ "Not_Guilty",
                         disposition_type_original %in% c("CONSOLIDATED", "EXTRADITED", "CERTIFIED TO JUVENILE COURT", "DO NOT USE THIS CODE!", " ") ~ "Other"),
         
         plea_type = case_when(plea_type_original %in% c("NO CONTEST PLEA", "NO CONTEST ADMISSION") ~ "Nolo_Contendere",
                               plea_type_original %in% c("ADMIT", "GUILTY") ~ "Guilty",
                               plea_type_original %in% c("DENY", "NOT GUILTY", "NOT GUILTY BY REASON OF INSANITY PLEA") ~ "Not_Guilty",
                               plea_type_original %in% c("NO PLEA", "DIVERSION", " ") ~ "Other"),

         sentence_date = if_else(disposition_type_original %in% c("CONVICTED"), disposition_date, as_date(NA)))


 
# Code for Charge Hierarchy and
#Make flags
load("Complete Charge Code Hierarchy.RData")

#remove these flags becasue they are messing up the final join of court and jail data
charge_hier <- charge_hier %>%
  select (-c(fta_flag))

court_charge <- left_join(court_charges, charge_hier, by = "join_var") %>%
  mutate(felony_flag = if_else(court_charge_level == "F", 1, 0),
         misd_flag = if_else(court_charge_level == "M", 1, 0)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, as.numeric(.)))) %>%
  mutate_at(vars(contains("flag")), funs("conviction" = if_else(. == 1 & disposition_type %in% c("Guilty", "Nolo_Contendere"), 1, 0))) %>%
  rename_at(vars(contains("flag"), -contains("conviction")), funs(paste0("court_", .))) %>%
  rename_at(vars(contains("conviction")), funs(paste0("conviction_", gsub("_conviction", "", .)))) 


       
            # not seeing any qualifier charges here  arrest_qualifier_flag=if_else()
            #sup_vio_post_flag=if_else(book_type=="Sup_Vio", 1, 0),

#Court Charge Diagnosaitics  

# table(court_charges[grep("attempt", court_charges$court_charge_description, ignore.case = T ), c("court_charge_description", "court_attempt_flag")])
# 
# court_charges[grep("attempt", court_charges$court_charge_description, ignore.case = T ), c("court_charge_description", "court_attempt_flag", "court_charge_code_original")]
# 

# "M_VC_231035A" this charge never used during arrest usually arrest is DUI then they plead down to receless driving"wet"
# "Other_PC_6665" special allegation prior auto theft

# Diagnostic Code for Charge Hierarchy
# 1 - 7,901/267,372 = 97% non-match rate
(1 - nrow(court_charge %>% filter(is.na(hierarchy)))/nrow(court_charge))*100

court_charge %>%
  filter(is.na(hierarchy)) %>%
  count(join_var) %>%
  arrange(desc(n))

court_charge%>%
  filter(grepl("Other_Other_NA", join_var))%>%
  group_by()%>%
  count() 


court_charge %>%
   filter(grepl("Other_Other_NA", join_var))%>%
  select(join_var, court_charge_level_original, court_charge_level, court_charge_code,court_charge_code_original, court_charge_level_original, disposition_type_original)

charge_hier%>%
  filter(grepl("12032", charge))

# some charges end with a "+" 
# some end with "M" or "F" or "I"
# some have "(664)" or "/664" at the end (attempt) or "664/" at the beginning
# some have "(2ND)"
# some have "-o21" or "-u18" or "-18-21" at end
# some have multiple statutes, but with either slash between or one in parentheses at end or neither

# court_charges[c("court_charge_code_original", "court_charge_level_original", "court_charge_code", "court_charge")]

# table(court_charges$court_charge_code)[order(table(court_charges$court_charge_code), decreasing = TRUE)]

# Code to check ones that don't start with two letters
# unique(court_charges$court_charge_code_original[!(grepl("^[A-Z]{2}", court_charges$court_charge_code_original)) | grepl("^[A-Z]{3}", court_charges$court_charge_code_original)])

# court_charges[substr(court_charges$court_charge_code_original, 1, 2) == "MC", ]

#Court hearing data
# court_hearing <- lapply(c("Historical Data Submissions/Nevada/PTRiskAss-Evnt3.csv",
#                           "Historical Data Submissions/Nevada/Submitted 2-3/PTRiskAss-Evnts.csv"),
#                         fread) %>%
#   bind_rows()
# new hearings file is actually duplicate of bench warrants data also sent separately. no q1 hearings data yet.


court_hearing <-
  fread("Historical Data Submissions/Nevada/PTRiskAss-Evnt3.csv")


#original_field <- names(court_hearing)

names(court_hearing) <-
  c(
    "court_docket_id",
    "court_case_id",
    "local_id",
    "hearing_id",
    "hearing_date",
    "hearing_type_original",
    "hearing_result"
  )

#original_df[[3]] <- tibble(table_name = "court_hearing", original_field = original_field, modified_field = names(court_hearing))

court_hearing <- court_hearing %>%
  mutate(hearing_date = mdy(hearing_date))

court_hearing <- court_hearing %>%
  mutate(
    hearing_type = case_when(
      hearing_type_original %in% c(
        "ARRAIGNMENT",
        "WARRANT ARRAIGNMENT",
        "ARRAIGNMENT ON VIOLATION OF PROBATION (VOP)",
        "CONTINUED ARRAIGNMENT",
        "ARRAIGNMENT ON VIOLATION OF PROBATION-FELONY",
        "ARRAIGNMENT ON INFORMATION",
        "ARR ON PETITION TO REVOKE/MODIFY PAROLE",
        "ARR ON PETITION TO REV/MOD MANDATORY SUPERVISION",
        "FELONY ARRAIGNMENT",
        "DUI ARRAIGNMENT"
      ) ~ "Arraignment",
      hearing_type_original %in% c(
        "SENTENCING",
        "FELONY SENTENCING",
        "SENTENCING ON VIOLATION OF PROBATION",
        "SENTENCING ON VIOLATION OF PROBATION - FELONY",
        "SENTENCING ON PETITION TO REVOKE/MODIFY PAROLE",
        "SENTENCING ON PET TO REV/MOD MANDATORY SUPERVISION",
        "SENTENCING ON PETITION TO MODIFY/REVOKE PRCS"
      ) ~ "Sentencing",
      T ~ "Other_Unknown"
    ),
    court_fta_flag = if_else(grepl("FTA", hearing_result), 1, 0)
  )



court_hearing %>%
  count(hearing_type, sort = T)



# hearing dates range from 1/2/2015-5/31/2019

#Warrants
court_warrants <- lapply(c("Historical Data Submissions/Nevada/PTRiskAss-BW.csv",
                           "Historical Data Submissions/Nevada/Submitted 2-3/PTRiskAss-BW.csv"),
                         fread) %>%
  bind_rows()

#original_field <- names(court_warrants)

names(court_warrants) <- c("court_docket_id", "court_case_id", "hearing_id", "hearing_date", "fta_warrant", "fta_warrant_date")

#original_df[[4]] <- tibble(table_name = "court_warrants", original_field = original_field, modified_field = names(court_warrants))

court_warrants <- court_warrants %>%
  mutate(hearing_date = mdy(hearing_date),
         fta_warrant_date = mdy(fta_warrant_date),
         fta_flag = 1)
# hearing date range is 1/2/2015-1/4/2020



```

Nevada Court Collapse Modified from Alameda for San Mateo
```{r eval=FALSE, include=FALSE}

# still need to ask Noah about the HTA's and also the strange error message when i didnt filter out disposition date na. returning -Infno non-missing #arguments to max  court_case_id cannot end in -HTA
court_dispo <- court_charge %>%   
  mutate(disposition_type = ordered(disposition_type, levels = c("Other", "Dismissed", "Not_Guilty", "Nolo_Contendere", "Guilty"))) %>%
  group_by(court_case_id) %>%
  #select(-c(offense_id)) %>%
  mutate(hierarchy = if_else(is.na(hierarchy), 1e6, as.numeric(hierarchy))) %>%
  group_by(court_case_id) %>%
  mutate(disposition_date = max(disposition_date), disposition_type = max(disposition_type)) %>%
  mutate(sentence_date=min(sentence_date, na.rm=TRUE)) %>%
  mutate(max_court_charge_level = court_charge_level[hierarchy == min(hierarchy)][1],
         max_court_charge_code = court_charge_code[hierarchy == min(hierarchy)][1],
         max_court_charge = court_charge[hierarchy == min(hierarchy)][1],
         max_charge_description = master_charge_description[hierarchy == min(hierarchy)][1],
         max_hier = min(hierarchy)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, .))) %>%
  mutate_at(vars(contains("flag")), funs("count" = sum(.))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  filter(hierarchy == min(hierarchy)) %>%
  ungroup() %>%
  distinct(court_case_id, .keep_all = T)


#This code adds flags for FTAs this comes from court hearing data that i ran below
court_fta_war <- court_warrants %>%
  #filter (!grepl("-HTA", court_case_id) ) %>%
  arrange(fta_warrant_date) %>%
  group_by(court_case_id) %>%
  mutate(fta_date = min(fta_warrant_date, na.rm = T)[fta_flag == 1][1]) %>%
  mutate(fta_flag = max(fta_flag),
         fta_flag_count = sum(fta_flag))%>%
  distinct(court_case_id, .keep_all = T) %>%  
 select(court_case_id,  fta_warrant_date, fta_flag, fta_date, fta_flag_count)


#This code makes arraignment date
court_arraign <- court_hearing %>%
  filter(hearing_type == "Arraignment") %>%
  arrange(hearing_date) %>%
  rename(arraignment_date = hearing_date) %>%
  arrange(arraignment_date) %>%
  distinct(court_case_id, .keep_all = T) %>%
  select(court_case_id, arraignment_date)


court_charges %>%
  filter(grepl("F19-000069", court_case_id ))



#This code make a plea date
court_plea <- court_charge %>%
  #filter (!grepl("-HTA", court_case_id) ) %>%
  arrange(disposition_date) %>%
  mutate(guilty_flag = if_else(disposition_type == "Guilty", 1, 0)) %>%
  group_by(court_case_id) %>%
  filter(guilty_flag == 1|sum(guilty_flag) == 0) %>%
  ungroup() %>%
  distinct(court_case_id, .keep_all = T) %>%
  select(court_case_id, plea_date , plea_type )

#this creates court sentence dates (I dont have a sentence date in Nevada it was created above so I dont think I need this code)
court_sent <- court_hearing %>%
  # filter (!grepl("-HTA", court_case_id) ) %>%
  arrange(sentence_date) %>%
  distinct(court_case_id, .keep_all = T) %>%
  select(court_case_id, sentence_date)

#this part does something not sure what
court_df2 <- reduce(list(court_df, court_dispo, court_fta_war, court_arraign, court_plea), left_join, by = "court_case_id") %>%
  #filter (!grepl("-HTA", court_case_id) ) %>%
  select(-contains(".y")) %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x", "", .))) %>%
  mutate(final_disposition_date = if_else(disposition_date <= sentence_date|is.na(sentence_date), disposition_date, sentence_date),
       conviction_flag = if_else(disposition_type %in% c("Guilty","Nolo_Contendere"), 1, 0))


Probation Data Old Dont Use
```{r eval=FALSE, include=FALSE}

# decided not to use "PRETRIAL STATS" workbooks, will use "Pretrial.Updated" instead
# also not using "Pretrial.SQL.Historic" (individual item responses) or "Pretrial.Demographics" (unuseable dates)

# prob_sheets <- lapply(c("2016.", "2017.", "2018. "), 
#                       function(i){
#                         getSheetNames(paste0("Historical Data Submissions/Nevada/PRETRIAL STATS ", 
#                                        i, "Nevada.xlsx"))
#                       })
# names(prob_sheets) <- c("2016", "2017", "2018")
# 
# prob_sheets_read <- data.frame(File = c(rep("2016.", length(prob_sheets[["2016"]])), 
#                                         rep("2017.", length(prob_sheets[["2017"]])),
#                                         rep("2018. ", length(prob_sheets[["2018"]]))),
#                                Sheet = unlist(prob_sheets), 
#                                Skip = c(rep(3, 16), rep(2, length(unlist(prob_sheets)) - 16)),
#                                DNR = unlist(prob_sheets) == "Sheet3")

# problem with first sheet -- no actual data, two rows with irrelevant headers
# prob_sheets_read$DNR[prob_sheets_read$File == "2016." & prob_sheets_read$Sheet == "MAY"] <- TRUE
# 
# prob_df <-
#   lapply(c("2016.", "2017.", "2018. "), 
#          function(i){
#            lapply(getSheetNames(paste0("Historical Data Submissions/Nevada/PRETRIAL STATS ", 
#                                        i, "Nevada.xlsx")), 
#                   function(j){
#                     if(!prob_sheets_read$DNR[prob_sheets_read$File == i &
#                                              prob_sheets_read$Sheet == j]) {
#                       read_excel(paste0("Historical Data Submissions/Nevada/PRETRIAL STATS ", 
#                                         i, "Nevada.xlsx"),
#                                  col_names = F, sheet = j, col_types = "text", 
#                                  skip = prob_sheets_read$Skip[prob_sheets_read$File == i &
#                                                               prob_sheets_read$Sheet == j])
#                     }
#                   }) %>% bind_rows()
#          }) %>% bind_rows()
# 
# names(prob_df) <- c("name", "charge_original", "charge_level_original", "risk_level_original", "risk_other", "sex_original", "age", "book_date", "release_date", "po", "ref", "or_flag", "or_condition_flag", "gps_flag", "alcohol_flag", "denied_flag", "other_flag", "termination_type", "termination_date", "termination_reason", "release_recommendation_original", "release_decision_original")

# "ref" is a completely blank column

# original_field <- as.character(read_excel("Historical Data Submissions/Nevada/PRETRIAL STATS 2018. Nevada.xlsx",
#                                        sheet = "JAN", skip = 1, n_max = 1, col_names = FALSE))
# 
# original_field[19:20] <- c("TERM DATE", "TERM REASON")
# 
# original_df[[2]] <- tibble(table_name = "prob_df", original_field = original_field, modified_field = names(prob_df))


# prob_df <- prob_df %>%
#   filter(grepl("^[0-9]", charge))

# prob_df$book_date <- as_date(as.integer(prob_df$book_date), origin = "1899-12-30")
# prob_df[prob_df$book_date < as_date("2015-01-01"), ]
# 8 individuals reported with 2018 data who appear to have dob in place of book date
# (no dob column but there is an "age")
# prob_df$release_date <- as_date(as.integer(prob_df$release_date), origin = "1899-12-30")
# prob_df$termination_date <- as_date(as.integer(prob_df$termination_date), origin = "1899-12-30")

# Factor Standardization
# prob_df <- prob_df %>%
#   mutate(sex = case_when(sex_original %in% c("F") ~ "Female",
#                          sex_original %in% c("M") ~ "Male",
#                          T ~ "Other_Unknown"),
#          charge_level = case_when(charge_level_original %in% c("F", "FELONY") ~ "F",
#                                   charge_level_original %in% c("M") ~ "M",
#                                   charge_level_original %in% c() ~ "I",
#                                   charge_level_original %in% c("F/M") ~ "Other"),
#          risk_level = case_when(risk_level_original %in% c("LOW") ~ "Low",
#                                 risk_level_original %in% c("MOD") ~ "Medium",
#                                 risk_level_original %in% c("HIGH") ~ "High",
#                                 risk_level_original %in% c("N/A") | is.na(risk_level_original) ~ "Unknown"),
#          release_recommendation = case_when(release_recommendation_original %in% c("YES",
#                                                                                    "YES (ORAL REC)",
#                                                                                    "YES (VIA EMAIL)",
#                                                                                    "YES BY REPORT",
#                                                                                    "YES VERBAL IN COURT",
#                                                                                    "GRANTED",
#                                                                                    "VERBAL IN COURT") ~ "OR",
#                                             release_recommendation_original %in% c("DENIED",
#                                                                                    "DENIED RELEASE",
#                                                                                    "NO") ~ "Detain",
#                                             release_recommendation_original %in% c("RELEASE WITH EM") ~ "Monitor",
#                                             prob_df$release_recommendation_original %in% c("BAILED OUT",
#                                                                                    "NO (DIRECT SENTENCE)",
#                                                                                    "NO (OUT OF CUSTODY)") ~ "Other"),
#          release_decision = case_when(release_decision_original %in% c("GRANTED",
#                                                                        "PLACED ON PT (not in custody)") ~ "OR",
#                                       release_decision_original %in% c("DENIED",
#                                                                        "DENIED (POSTED BOND)") ~ "No_Program",
#                                       release_decision_original %in% c("RELEASE WITH EM",
#                                                                        "WITH EM") ~ "Monitor",
#                                       release_decision_original %in% c("PROVIDE PROOF OF SELF HELPS") |
#                                         is.na(release_decision_original) ~ "Other"),
#          pretrial_conditions = case_when(gps_flag %in% c("YES") ~ "EM",
#                                          or_condition_flag %in% c("YES") ~ "Other", 
#                                          T ~ "None"))

         
# charge_original data combination of charge and charge code (and occasionally charge level), not something we are dealing with now
# are these conditions flags recommendations or actual conditions?
         
# table(prob_df$gps_flag, useNA = "ifany")      
# [is.na(prob_df$release_recommendation)]
# table(prob_df[c("release_decision_original", "or_condition_flag", "or_flag")], useNA = "ifany") 
# prob_df[c("or_condition_flag", "gps_flag")]
# names(prob_df)         
# table(prob_df$pretrial_conditions, useNA = "ifany")
# unique(prob_df$gps_flag)
# 
# release_decision
# pretrial_level
# None # Low # Medium # High
# 
# pretrial_service # Phone_Call  # Other # None
# 
# release_authorization # Sheriff # Judge  # NA


# original probation data names are spread across multiple rows in submitted data
# still need to decide how to name these for the code book
# still need to decide what to do with individual assessment items data received
#   -no way to link to other data currently (only 28 digit hexadecimal ID no. provided)
#   -how to incorporate assessment item data into prob_df? one col per item or per response?

# tool_resp_working <- read.csv("Historical Data Submissions/Nevada/Pretrial.SQL.Historic.Nevada.csv", header = F, fill= T, as.is = T,
#                               na.strings = "", fileEncoding = "UTF-8-BOM",
#                               col.names = c("assessment_id", "assessment_item", "assessment_response", "assessment_response_secondary"))
# 
# tool_resp_working$assessment_item[tool_resp_working$assessment_item == "Age at first arrest"] <- "Age at First Arrest"
# 
# tool_resp_working$assessment_item[tool_resp_working$assessment_item == "Illegal Drug Use during Past Six Months"] <- "Illegal Drug Use During Past Six Months"
# 
# tool_response <- spread(tool_resp_working[tool_resp_working$assessment_item != "Other Areas of Concern", 1:3], key = assessment_item, 
#                         value = assessment_response)

# table(tool_resp_working[c("assessment_item", "assessment_response_secondary")], useNA = "ifany")

# tool_response$employment_status <- 
#   sapply(tool_response$assessment_id,
#          function(x) {
#            tool_resp_working$assessment_response_secondary[tool_resp_working$assessment_id == x &
#                                                              tool_resp_working$assessment_item == "Employed at the Time of Arrest"]
#          }) 
# 
# tool_response$other_count <-
#   sapply(tool_response$assessment_id,
#          function(x) {
#            length(which(tool_resp_working$assessment_id == x &
#                           tool_resp_working$assessment_item == "Other Areas of Concern"))
#          })
# 
# table(tool_response$other_count)
# 
# tool_response$other_areas_1[tool_response$other_count > 0] <-
#   sapply(tool_response$assessment_id[tool_response$other_count > 0],
#          function(x) {
#            tool_resp_working$assessment_response[tool_resp_working$assessment_id == x &
#                                                    tool_resp_working$assessment_item == "Other Areas of Concern"][1]
#          })
# 
# tool_response$other_areas_2[tool_response$other_count > 1] <-
#   sapply(tool_response$assessment_id[tool_response$other_count > 1],
#          function(x) {
#            tool_resp_working$assessment_response[tool_resp_working$assessment_id == x &
#                                                    tool_resp_working$assessment_item == "Other Areas of Concern"][2]
#          })
# 
# tool_response$other_areas_3[tool_response$other_count > 2] <-
#   sapply(tool_response$assessment_id[tool_response$other_count > 2],
#          function(x) {
#            tool_resp_working$assessment_response[tool_resp_working$assessment_id == x &
#                                                    tool_resp_working$assessment_item == "Other Areas of Concern"][3]
#          })
# 
# summary(tool_response)

# no matching ID to prob_df table, no assessment dates
# 271 assessments but only 57 rows in main prob_df table
# all assessment IDs have at least one "Other Areas of Concern", mostly "Other" (251)

Probation Data New
```{r eval=FALSE, include=FALSE}
prob_df <- read_excel("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Nevada/Pretrial.Updated.xlsx")

names(prob_df) <- c("name", "local_id", "dob", "sex_original", "race_original", "cii", "fbi", "cdl_id", "zip_code", "case_start_date", "tool_name_original", "assessment_date_time", "assessment_id", "risk_level_original", "release_recommendation_original", "release_date_time", "ftas", "new_law_violations", "release_decision_original", "pretrial_termination_outcome", "book_num", "termination_date")

# Dates and Factors Standardization

prob_df <- prob_df %>%
  mutate_at(vars(contains("time")), convertToDateTime) %>%
  mutate_at(vars(dob, case_start_date, termination_date), convertToDate) %>%
  mutate(assessment_date = as_date(assessment_date_time),
         release_date = as_date(release_date_time)) %>%
  mutate(sex = case_when(sex_original %in% c("Female") ~ "Female",
                         sex_original %in% c("Male") ~ "Male"),
                         # sex_original %in% c() ~ "Other_Unknown"),
         race = case_when(race_original %in% c("Hispanic") ~ "Hispanic",
                          race_original %in% c("Black") ~ "Black",
                          race_original %in% c("White") ~ "White",
                          race_original %in% c("NULL") ~ "Other_Unknown"),
         tool_name = case_when(tool_name_original %in% c("ORAS-PAT") ~ "ORAS"),
         risk_level = case_when(risk_level_original %in% c("Low") ~ "Low",
                                risk_level_original %in% c("Moderate") ~ "Medium",
                                risk_level_original %in% c("High") ~ "High",
                                risk_level_original %in% c("NULL") ~ "Unknown"),
         release_recommendation = case_when(release_recommendation_original %in% c("Grant") ~ 1,
                                            release_recommendation_original %in% c("Deny") ~ 0),
         release_decision = case_when(release_decision_original %in% c("Granted") ~ 1,
                                      release_decision_original %in% c("Denied") ~ 0))
                                                                        
                               

# grep("original", names(prob_df), value = TRUE)
# sort(table(prob_df$release_decision_original, useNA = "ifany"), decreasing = TRUE)
#  [is.na(prob_df$release_decision)]
# table(prob_df$release_recommendation, useNA = "ifany")


```


Code Book
```{r eval=FALSE, include=FALSE}
rm(original_field)
original_df <- bind_rows(original_df)
Nevada_df <- lapply(ls()[!grepl("original", ls())], function(i){
  df <- get(i)
  
  if(sum(grepl("date", names(df))) > 0){
  df2 <- df %>%
  select(contains("date"), -contains("time")) %>%
  gather("modified_field", "value") %>%
  group_by(modified_field) %>%
  summarise_all(funs(min = as.character(min(., na.rm = T)), mean = as.character(mean(., na.rm = T)), max = as.character(max(., na.rm = T))))
  }else{
    df2 <- tibble(modified_field = NA_character_, min = NA_character_, mean = NA_character_, max = NA_character_)
  }
  
  df <- df %>%
    mutate_if(~length(unique(.)) > 50|is.Date(.)|is.POSIXct(.), ~(. = "not_factor")) %>%    
    mutate_all(~if_else(is.na(.), "na_missing", as.character(.))) %>%
    gather(modified_field, factor_value) %>%
    count(modified_field, factor_value) %>%
    mutate(table_name = i, county = "Nevada") %>%
    mutate(factor_flag = if_else(factor_value == "not_factor", 0, 1)) %>%
    group_by(table_name, modified_field) %>%
    mutate(table_count = sum(n)) %>%
    ungroup() %>%
    rename("factor_count" = "n") %>%
    mutate(factor_count = if_else(factor_value == "not_factor", NA_integer_, factor_count),
           factor_percent = round(factor_count/table_count*100, 1)) %>%
    arrange(desc(factor_flag), modified_field, desc(factor_count))
  
  df <- left_join(df, df2, by = "modified_field")
    }) %>% 
  bind_rows() %>%
  left_join(original_df) %>%
   select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_count,
           factor_percent, table_count, min, mean, max) 
write.xlsx(Nevada_df, file = "Code Books/Nevada Code Book.xlsx")


```

DOJ CII/Linking Extraction
```{r}
# Grab Tables with CII
df <- sapply(ls()[which(sapply(ls(), function(i){
  sum(names(get(i)) %in% "cii")
}) == 1)], get)

# Pull CII and other identifiers
doj_book <- df[[1]] %>%
  select(cii, fbi, name, dob, cdl_id, race_original, sex_original) %>%
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) 


doj_court <- df[[2]] %>%
  select(cii, fbi, dob, race_original, sex_original, first_name, middle_name, last_name, suffix, local_id) %>%
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) 



# Examine missing ciis and duplicates on cii. 
# doj_book %>% #Off by about 55,000
#   distinct()
# 
# doj_book %>% 
#   distinct(cii)
# 
# doj_book %>% 
#   distinct() %>%
#   add_count(cii) %>%
#   filter(n > 1) %>%
#   arrange(desc(n)) %>% 
#   View()
# 
# doj_court %>% #Off by about 45,000
#   distinct()
# 
# doj_court %>% 
#   distinct(cii)
# 
# doj_court %>% 
#   distinct() %>%
#   add_count(cii) %>%
#   filter(n > 1) %>%
#   arrange(desc(n)) %>% 
#   View()
# 
# 
# doj_book %>% # Off by about 7,000
#   distinct()
# 
# doj_book %>% 
#   distinct(cii)

# doj_book %>% 
#   distinct() %>%
#   add_count(cii) %>%
#   filter(n > 1) %>%
#   arrange(desc(n)) %>% 
#   View()
# 
# doj_court %>% #Off by about 9,000
#   distinct()
# 
# doj_court %>% 
#   distinct(cii)
# 
# doj_court %>% 
#   distinct() %>%
#   add_count(cii) %>%
#   filter(n > 1) %>%
#   arrange(desc(n)) %>% 
#   View()

#CIIs for DOJ
doj_cii <- bind_rows(doj_book %>% select(cii), doj_court %>% select(cii)) %>% distinct()

doj_court <- doj_court %>%
  mutate_if(is.character, funs(trimws(gsub("[^[:alnum:]]", "", .)))) %>%
  mutate_if(is.character, funs(if_else(. == "", NA_character_, .))) 

#Create an excel workbook with all data table. Make sure to include the cii table first. 
write.xlsx(list(doj_cii, doj_book, doj_court), file = "CIIs for DOJ/Nevada CIIs and Demographics for DOJ.xlsx", sheetName = c("ciis", "booking", "court"))
```

Compile Codebook Notes
```{r}
files <- list.files("G:/CrimJustice/PretrialAssessmentPilot/Code Books/Code Book Notes", pattern = "Nevada", full.names = T)
df <- lapply(files, read_excel)


df[[3]] <- full_join(df[[1]], df[[2]]) %>%
  mutate(factor_standard = "") %>%
  select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_standard, factor_count, factor_percent, 
         table_count, "st_notes" = Notes, "nl_notes_2" = factor_collapse, "nl_notes_1" = notes, min, mean, max, )

df <- list(df[[3]], df[[1]], df[[2]])

write.xlsx(df, file = "G:/CrimJustice/PretrialAssessmentPilot/Code Books/Variable Construction/Nevada Factor Construction.xlsx", asTable = T, tableStyle = "TableStyleMedium1", sheetName = c("Variable Construction", "st_notes", "nl_notes"))
```

Create Factor Codebook
```{r}

factor_df <- lapply(ls()[!grepl("original|^df|hier", ls())], function(i){
  df <- get(i)
  if(sum(grepl("original", names(df))) == 0){
    return(NULL)
  }else{
    var_names <- names(df)[grepl("original", names(df))]
    var_names2 <- gsub("_original", "", var_names)
   
    df1 <- df %>%
     select(var_names) %>%
     gather(original_field, original_value)
   
    df2 <- df %>%
     select(var_names2) %>%
     gather(modified_field, modified_value)
   
   df <- bind_cols(df1, df2) %>%
     count(original_field, modified_field, original_value, modified_value) %>%
     arrange(modified_field, desc(n)) %>%
     group_by(modified_field) %>%
     mutate(row = row_number(),
            percent = round(n/sum(n)*100)) %>%
     ungroup() %>%
     filter(row <= 50) %>%
     select(-row) %>%
     rename("total" = n)
   }
  }) %>%
  bind_rows()

write.xlsx(factor_df, file = "G:/CrimJustice/PretrialAssessmentPilot/Code Books/Factor Code Book/Nevada Factor Code Book.xlsx", asTable = T, tableStyle = "TableStyleMedium1", colWidths = "auto")
```
 Joining All Data Post-Collapse
 Jail Court Join
```{r}
# Remove extraneous objects in the environment
rm(list = ls()[!ls() %in% ls(pattern = "df")])

#Check for common variables
#names(book_df)[names(book_df) %in% names(assess_df)] no assessment data yet

names(book_df)[names(book_df) %in% names(court_df2)]



#Turning NULL to NA to ensure non matching and removing generic charge info from data frames
book_df <- book_df %>%
  mutate_if(is.character, list(~na_if(., "NULL"))) %>%
  select(-c(charge, charge_level, charge_code)) %>%
  mutate_at(vars(first_name, last_name), toupper)

#assess_df <- assess_df %>%
 # mutate_if(is.character, list(~na_if(., "(Missing)"))) %>%
  #select(-c(id, court))

court_df2 <- court_df2 %>%
  mutate_if(is.character, list(~na_if(., "NULL"))) %>%
  select(-c(charge, charge_level, charge_code)) %>%
  mutate_at(vars(first_name, last_name), toupper) %>%
  mutate(court_case_id = as.character(court_case_id))

#Joining Assessment to Jail Data
join1 <- inner_join(book_df, assess_df, by = "book_num", na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x$", "", .))) %>%
  select(-contains(".y")) %>%
  #1 Duplicate with missing dispositions which will be dropped later. 
  distinct()

j1 <- anti_join(book_df, assess_df, by = "book_num", na_matches = "never")
a1 <- anti_join(assess_df, book_df, by = "book_num", na_matches = "never")


  #Examine if set of common variables is distinct--yes
  semi_join(book_df, assess_df, by = "book_num", na_matches = "never") %>%
    distinct()

#Joining on Name and Court ID
join2 <- inner_join(j1, a1, by = c("first_name", "last_name", "book_date" = "interview_date"), 
                    na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x$", "", .))) %>%
  select(-contains(".y")) %>%
  #1 Duplicate with missing dispositions which will be dropped later. 
  distinct()

j2 <- anti_join(j1, a1, by = c("first_name", "last_name", "book_date" = "interview_date"), na_matches = "never")
a2 <- anti_join(a1, j1, by = c("first_name", "last_name", "interview_date" = "book_date"), na_matches = "never")

  #Examine if set of common variables is distinct--yes
  semi_join(j1, a1, by = c("first_name", "last_name", "book_date" = "interview_date"), 
            na_matches = "never") %>%
    distinct()
  
#Diagnostics
  #Jail and Assessment Matches by category
tibble(
  stage = 1:2,
  match = c(
    'c("book_num")',
    'c("first_name", "last_name", "book_date" = "interview_date")'
  ),
  # jail_match_rate = sapply(1:2, function(i) {
  #   (nrow(book_df) - nrow(get(paste0("j", i)))) / nrow(book_df) * 100
  # }),
  assess_match_rate = sapply(1:2, function(i) {
    (nrow(assess_df) - nrow(get(paste0("a", i)))) / nrow(assess_df) * 100
  })
)

#Recreating Booking--Should be same number of rows.
book_df <- bind_rows(join1, join2, j2)  

rm(list = ls()[!ls() %in% ls(pattern = "df")])

#scratch

court_df2 %>%
 ls()
   
book_df %>%
  ls()


 join1 %>%
  select(contains(".x")) %>%
  names() %>%
  sort()

join1 %>%
  select(contains("arrest_")) %>%
  names() %>%
  sort()

names(book_df)[names(book_df) %in% names(court_df2)]

names(join1)[grepl("\\.x", names(join1)) & paste0("arrest_", gsub("\\.x$", "", names(join1))) %in% names(join1)]


names(join1)[grepl("\\.y", names(join1)) & paste0("court_", gsub("\\.y$", "", names(join1))) %in% names(join1)]
#end of scratch


# Court Matching
#Joining on cdl_id
join1 <- inner_join(book_df, court_df2, by = c("first_name", "last_name"), na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(paste0("arrest_", gsub("\\.x$", "", .)))) %>%
  rename_at(vars(contains(".y")), funs(paste0("court_", gsub("\\.y$", "", .)))) %>%
  # 8 Duplicates with missing dispositions which will be dropped later. 
  distinct()

j1 <- anti_join(book_df, court_df2, by = c("first_name", "last_name"), na_matches = "never")
c1 <- anti_join(court_df2, book_df, by = c("first_name", "last_name"), na_matches = "never")



  #Examine if set of common variables is distinct--yes except 8 spurious cases.
  join1 %>%
    select(-contains("flag")) %>%
    add_count("cdl_id") %>%
    filter(n > 1) %>%
    arrange(desc(n))

     

#Joining on Name and Court ID
join2 <- inner_join(j1, c1, by = c("court_case_id"), na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(paste0("arrest_", gsub("\\.x$", "", .)))) %>%
  rename_at(vars(contains(".y")), funs(paste0("court_", gsub("\\.y$", "", .)))) %>%
  #1 Duplicate with missing dispositions which will be dropped later. 
  distinct()

j2 <- anti_join(j1, c1, by = c("court_case_id"), na_matches = "never")
c2 <- anti_join(c1, j1, by = c("court_case_id"), na_matches = "never")

  #Examine if set of common variables is distinct--yes except 8 spurious cases.
  join2 %>%
     select(-contains("flag")) %>%
    add_count("court_case_id") %>%
    filter(n > 1) %>%
    arrange(desc(n))

#Joining on Court ID
join3 <- inner_join(j2, c2, by = c("fbi"), na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(paste0("arrest_", gsub("\\.x$", "", .)))) %>%
  rename_at(vars(contains(".y")), funs(paste0("court_", gsub("\\.y$", "", .)))) %>%
  #1 Duplicate with missing dispositions which will be dropped later. 
  distinct()

j3 <- anti_join(j2, c2, by = c("fbi"), na_matches = "never")
c3 <- anti_join(c2, j2, by = c("fbi"), na_matches = "never")

  #Examine if set of common variables is distinct--yes except 8 spurious cases.
  join3 %>%
    add_count ("fbi") %>%
    filter(n > 1) %>%
    arrange(desc(n))
  
#Diagnostics
  #Jail and Court Matches by category
tibble(
  stage = 1:3,
  match = c(
    'c("first_name", "last_name")',
    'c("court_case_id")',
    'c("fbi")'
  ),
  jail_match_rate = sapply(1:3, function(i) {
    (nrow(book_df) - nrow(get(paste0("j", i)))) / nrow(book_df) * 100
  }),
  court_match_rate = sapply(1:3, function(i) {
    (nrow(court_df2) - nrow(get(paste0("c", i)))) / nrow(court_df2) * 100
  })
)

join_df <- bind_rows(join1, join2, join3)
```


# Sacramento
- Everything is Join

Jail Data
```{r}
original_df <- list()

# Jail Bookings
book_df <- fread("Historical Data Submissions/Sacramento/SacBookingDetail.csv")

original_field <- names(book_df)

names(book_df) <- c("jail_court_id", "book_date_wrong", "release_date_wrong", "registry_num", "registry_sub_num", "book_type_code", "book_type", "charge_level", "charge", "charge_description", "release_type_code", "release_type", "release_comment", "charge_date", "charge_release_date", "court_combined_id", "court_id", "case_id", "release_line")

original_df[[1]] <- tibble(table_name = "book_df", original_field = original_field, modified_field = names(book_df))

book_df <- book_df %>%
  select(-matches("date"))

#Booking Dates
book_date <- fread("Historical Data Submissions/Sacramento/SacBookingMain.csv")

original_field <- names(book_date)

names(book_date) <- c("jail_court_id", "registry_num", "book_date", "release_date", "hours_detained", "days_detained")

original_df[[2]] <- tibble(table_name = "book_date", original_field = original_field, modified_field = names(book_date))

book_date <- book_date %>%
  mutate_at(vars(book_date, release_date), funs(time = as_datetime(., tz = 'America/Los_Angeles'))) %>%
  mutate(book_date = as_date(book_date_time),
         release_date = as_date(release_date_time))

#Jail Bail Amounts
book_bail <- fread("Historical Data Submissions/Sacramento/SacBail.csv")

original_field <- names(book_bail)

names(book_bail) <- c("jail_court_id", "registry_num", "registry_sub_num", "book_type_code", "bail_amt")

original_df[[3]] <- tibble(table_name = "book_bail", original_field = original_field, modified_field = names(book_bail))
```

Court Data
```{r}
#High level casees
court_df <- fread("Historical Data Submissions/Sacramento/SacCases.csv")

original_field <- names(court_df)

names(court_df) <- c("jail_court_id", "court_combined_id", "court_id", "case_id", "file_date")

original_df[[4]] <- tibble(table_name = "court_df", original_field = original_field, modified_field = names(court_df))

court_df <- court_df %>%
  mutate(file_date = as_date(file_date))

#Court Hearing Data
court_hearing <- fread("Historical Data Submissions/Sacramento/SacAppear.csv")

original_field <- names(court_hearing)

names(court_hearing) <- c("jail_court_id", "court_combined_id", "court_id", "case_id", "hearing_date", "hearing_type_code", "hearing_type", "hearing_comment", "hearing_result_code", "hearing_result", "hearing_result_comment")

original_df[[5]] <- tibble(table_name = "court_hearing", original_field = original_field, modified_field = names(court_hearing))

court_hearing <- court_hearing %>%
  mutate(hearing_date_time = as_datetime(hearing_date, tz = 'America/Los_Angeles'),
         hearing_date = as_date(hearing_date_time))

#Court case dispostions
court_dispos <- fread("Historical Data Submissions/Sacramento/SacDispos.csv")

original_field <- names(court_dispos)

names(court_dispos) <- c("jail_court_id", "court_combined_id", "court_id", "case_id", "please_code", "charge_dispo_code", "case_charge_code", "charge_level", "charge", "disposition_date")

original_df[[6]] <- tibble(table_name = "court_dispos", original_field = original_field, modified_field = names(court_dispos))

court_dispos <- court_dispos %>%
  mutate(disposition_date = as_date(disposition_date))

#Court person ids
court_person <- fread("Historical Data Submissions/Sacramento/SacPersonDetail.csv")

original_field <- names(court_person)

names(court_person) <- c("jail_court_id", "first_name", "last_name", "name", "sex", "race", "dob", "cii", "fbi", "dln")

original_df[[7]] <- tibble(table_name = "court_person", original_field = original_field, modified_field = names(court_person))

court_person <- court_person %>%
  mutate(dob = ymd(gsub(" .*", "", trimws(dob))))

#Court Warrants
court_warrants <- fread("Historical Data Submissions/Sacramento/SacWarrants.csv")

original_field <- names(court_warrants)

names(court_warrants) <- c("jail_court_id", "court", "warrant_num", "warrant_id", "warrant_status", "charge_level", "warrant_type", "judge", "judge_comment", "complaint_lea", "lea_loc", "lea", "lea_foreign", "lea_hold", "charges_comments", "warrant_date", "warrant_clear_date", "warrant_duration", "bail_amt", "no_bail_flag", "case_id", "mandatory_appear_flag")

original_df[[8]] <- tibble(table_name = "court_warrants", original_field = original_field, modified_field = names(court_warrants))

court_warrants <- court_warrants %>%
  select(-judge) %>%
  mutate_at(vars(warrant_date, warrant_clear_date), as_date)
```

Code Book
```{r eval=FALSE, include=FALSE}
rm(original_field)

original_df <- bind_rows(original_df)

Sacramento_df <- lapply(ls()[!grepl("original", ls())], function(i){
  df <- get(i)
  
  if(sum(grepl("date", names(df))) > 0){
  df2 <- df %>%
  select(contains("date"), -contains("time")) %>%
  gather("modified_field", "value") %>%
  group_by(modified_field) %>%
  summarise_all(funs(min = as.character(min(., na.rm = T)), mean = as.character(mean(., na.rm = T)), max = as.character(max(., na.rm = T))))
  }else{
    df2 <- tibble(modified_field = NA_character_, min = NA_character_, mean = NA_character_, max = NA_character_)
  }
  
  df <- df %>%
    mutate_if(~length(unique(.)) > 50|is.Date(.)|is.POSIXct(.), ~(. = "not_factor")) %>%    
    mutate_all(~if_else(is.na(.), "na_missing", as.character(.))) %>%
    gather(modified_field, factor_value) %>%
    count(modified_field, factor_value) %>%
    mutate(table_name = i, county = "Sacramento") %>%
    mutate(factor_flag = if_else(factor_value == "not_factor", 0, 1)) %>%
    group_by(table_name, modified_field) %>%
    mutate(table_count = sum(n)) %>%
    ungroup() %>%
    rename("factor_count" = "n") %>%
    mutate(factor_count = if_else(factor_value == "not_factor", NA_integer_, factor_count),
           factor_percent = round(factor_count/table_count*100, 1)) %>%
    arrange(desc(factor_flag), modified_field, desc(factor_count))
  
  df <- left_join(df, df2, by = "modified_field")
    }) %>% 
  bind_rows() %>%
  left_join(original_df) %>%
   select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_count,
           factor_percent, table_count, min, mean, max) 

write.xlsx(Sacramento_df, file = "Code Books/Sacramento Code Book.xlsx")
```

# San Joaquin
- Everything is Join

Jail Data
```{r}
book_df <- fread("Historical Data Submissions/San Joaquin/Jail_ATIMS_Data_BOOKING_20150101_to_20190930_3.csv")

names(book_df) <- c("book_num", "lar", "case_id", "bail_amt", "arrest_date", "book_date", "book_type", 
                    "release_date", "release_type")

book_charge <- fread("Historical Data Submissions/San Joaquin/Jail_ATIMS_Data_CHARGES_20150101_to_20190930_3.csv")

names(book_charge) <- c("book_num", "count", "charge_code", "charge", "charge_description", "charge_level")

book_demo <- fread("Historical Data Submissions/San Joaquin/Jail_ATIMS_Data_PARTY_20150101_to_20190930_3.csv")

names(book_demo) <- c("lar", "cii", "first_name", "last_name", "dln", "dln_state", "dob", "sex", "race")

book_ipid <- fread("Historical Data Submissions/San Joaquin/Jail_ATIMS_Data_LAR_to_IPID_20150101_to_20190930_3.csv")

names(book_ipid) <- c("lar", "ipid")
```

Court Data
```{r}
#High level casees
court_df <- fread("Historical Data Submissions/San Joaquin/pretrial case.csv")

names(court_df) <- c("ipid", "court_id", "case_id", "case_id_previous", "complaint_id", "filing_date", "case_status", "case_status_date")

#Includes Jail Charge 
court_charge <- lapply(1:4, function(i){
  fread(paste0("Historical Data Submissions/San Joaquin/pretrial charge ", i, ".csv"), colClasses = "character")}) %>%
  bind_rows()

names(court_charge) <- c("ipid", "court_id", "case_id", "complaint_id", "charge", "charge_level", "charge_description", 
                         "count", "qualifier", "police_reference", "disposition_type", "disposition_date", "sentence_date", "disposition_result", "dispostion_final_date", "seentence_final_date", "confinement_type", "confinement_facilty", "confinement_date", "confinement_end_date", "term_years", "term_months", "term_days", "today", "to_date", "term_to_days", "term_life", "result_id")

court_hearing <- fread("Historical Data Submissions/San Joaquin/pretrial hearing.csv")

names(court_hearing) <- c("case_id", "case_type", "hearing_date", "hearing_type")

court_person <- fread("Historical Data Submissions/San Joaquin/pretrial party.csv")

names(court_person) <- c("ipid", "court_id", "last_name", "first_name", "dob", "gender", "race", "ethnicity", "dln", "dln_state")

court_fta <- fread("Historical Data Submissions/San Joaquin/pretrial FTA by hearing.csv")

names(court_fta) <- c("case_id", "case_type", "hearing_date", "hearing_type")

court_fta_warrant <- fread("Historical Data Submissions/San Joaquin/pretrial FTA by warrant.csv")

names(court_fta_warrant) <- c("case_id", "case_type", "warrant_num", "fta_warrant_date")
```

DA data 
```{r}
da_df <- fread("Historical Data Submissions/San Joaquin/pretrial booking.csv")

namea(da_df) <- c("ipid", "fce_entity_id", "case_id", "case_id_full", "da_complaint_num", "book_num")

prob_df <- fread("Historical Data Submissions/San Joaquin/pretrial assessment report.csv")

names(prob_df) <- c("case_id", "report_status", "ra_date")
```

Probation (assessment) data--Fix later

```{r}
read_excel("Historical Data Submissions/San Joaquin/MASTER Pretrial Data Collection Variables 2011.xlsx")
```


# San Mateo
```{r eval=FALSE, include=FALSE}

# Jail Bookings Data Import--- San Mateo, 2015-01-01 to 2019-12-31
  ## book_df contains one row per booking and includes information on the person, the time of booking and release,contains charge information, bail amount.
  ## book_num has suffix (.1, .2,...)
  ## 
 
###

# Booking Data
  ## book_df contains one row per booking and includes information on the person as well as the time of booking and release. It contains no charge information.
  ## not using lapply becasue second two files do not have headers

#San Mateo Jail Data Import
book_df <- fread("Historical Data Submissions/San Mateo/41-SO-01OF01-JAN2015-JUN2019.csv", colClasses = "text")
book_df2 <- fread("Historical Data Submissions/San Mateo/41-SO-01OF02-JUL2019-SEPT2019.csv", colClasses = "text", header = F)
book_df3 <- fread("Historical Data Submissions/San Mateo/41-SO-01OF01-OCT2019-DEC2019.csv", colClasses = "text", header = F)

names(book_df2) <- names(book_df)
names(book_df3)<- names(book_df)

book_df <- bind_rows(book_df, book_df2, book_df3)

rm(book_df2, book_df3)

book_df %>%
  distinct()%>%
  arrange (book_num)

book_df %>%  
 filter(grepl("0709937", book_num))

# book_num_gs distinct=84,681
test <- book_df %>%
  mutate(book_num_gs = gsub("\\.[0-9]*", "" , book_num )) 

# book_num, book_date  distinct=84,681
test %>%
  distinct(book_num, book_date) %>%
  arrange(book_num)


# Variable name standardization--See pg. xxx for more details. 
  ##  cdl_id_2 is actually a partially empty, partial duplicate of cdl_id
names(book_df) <- c("cii", "name", "dob", "fbi", "cdl_id_2", "cdl_id", "sex_original", "race_original", "arrest_date", "book_num", "book_date", "book_type_original", "court_case_id", "arrest_charge_original", "arrest_charge_level_original", "release_date", "release_type_original", "bail_amt", "conviction_date", "conviction_charge", "employment_status")



# Date Reformatting (also name and CII reformat)--See pg. xxx for more details.
  ## 8 rows arrest dates 1900-01-01 00:00
  ## 4 rows arrest dates 1919 when probably should be 2019
book_df <- book_df %>%
  select(-c(conviction_date, conviction_charge, employment_status)) %>%
  mutate_at(vars(contains("date")), funs(time = as_datetime(., tz = 'America/Los_Angeles'))) %>%
  mutate_at(vars(contains("date")), as_date) %>%
  mutate(dob = mdy(dob),
         name2 = str_sub(name, end=-3),
         first_name = gsub(".*, ", "", name2),
         last_name= gsub("(?=,).*$", "", name2, perl=TRUE)) %>%
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, (cii)),
         cdl_id = gsub("NONE|NONE ISSUED", "", cdl_id)) 
    
# Standardize Factors
  ## No employment data provided
book_df <- book_df %>%
  mutate(sex = case_when(sex_original %in% c("U", "") ~ "Other_Unknown",
                         sex_original %in% c("M") ~ "Male",
                         sex_original %in% c("F") ~ "Female"),

         race = case_when(race_original %in% c("B") ~ "Black",
                          race_original %in% c("H") ~ "Hispanic",
                          race_original %in% c("W") ~ "White",
                          T ~ "Other_Unknown"), 
         
         book_type = case_when(book_type_original %in% c("LOCAL WARRANT") ~ "Bench_Warrant",
                               book_type_original %in% c("COMMITMENT") ~ "Commitment",
                               book_type_original %in% c("FOREIGN HOLD - STATE SENTENCED", "FOREIGN HOLD - COMMITMENT",
                                                         "FOREIGN HOLD - DETAINER", "FOREIGN HOLD - OTHER", "FOREIGN HOLD - PAROLE", 
                                                         "FOREIGN HOLD - IMMIGRATION" ) ~ "Hold",
                               book_type_original %in% c("FOREIGN WARRANT") ~ "Other_Warrant",
                               book_type_original %in% c("REMAND") ~ "Remand",
                               book_type_original %in% c("OPEN CHARGES") ~ "Street",
                               book_type_original %in% c("PROBATION HOLD 1203.2", "PAROLE PC 3056", "PAROLE PC 3000.08", "PRCS REVOCATION PC 3455(a)", 
                                                          "MANDATORY SUPERVISION REVOCATION PC 1170(H)(5)(B)", 
                                                         "FLASH INCARCERATION PC 3454(b)") ~ "Sup_Vio"),

         release_type = case_when(release_type_original %in% c("PROMISE TO APPEAR","LAW ENFORCEMENT RELEASE") ~ "Cite_Release",
                                  release_type_original %in% c("TIME SERVED") ~ "Time_Served",
                                  release_type_original %in% c("SURETY BOND POSTED", "CHECK BAIL", "CASH BAIL POSTED") ~ "Bail_Bond",
                                  release_type_original %in% c("CASE DISMISSED") ~ "Dismissed_Dropped",
                                  release_type_original %in% c("OWN-RECOGNIZANCE") ~ "OR",
                                  release_type_original %in% c("COURT ORDERED RELEASE") ~ "Court_Order",
                                  release_type_original %in% c("") ~ "Unknown",
                                  release_type_original %in% c("RELEASE TO OTHER AGENCY", "RELEASED TO OTHER AGENCY", 
                                                               "SENTENCED TO CDCR") ~ "Hold_Released", T ~ "Other"))
        

# Standardize Charges, Join Hierarchy and flag construction
 ## some charges separated by slash /
 ## some charges end in "2ND" or "1ST"
 ## "30600  ENHANCEMENT " 8 rows
 ## most end in code: PC, VC, HS, BP, WI, CP, IC, MC, SC, 
book_df <- book_df %>%
  mutate(arrest_charge_code = gsub(".* ", "", arrest_charge_original),
         arrest_charge_code = if_else(arrest_charge_code=="USC", "US", arrest_charge_code),
         arrest_charge_code = if_else(!arrest_charge_code %in% c("PC", "VC", "HS", "BP", "WI", "US"), "Other", arrest_charge_code),
         arrest_charge_level = if_else(!arrest_charge_level_original %in% c("F", "I", "M"), "Other", arrest_charge_level_original),
         arrest_charge = gsub(">.*| .*|MISD|FEL|-FEL|INF" , "", arrest_charge_original),
         arrest_attempt_flag = if_else(grepl("664", arrest_charge_original), 1, 0),
         arrest_charge = gsub("664/", "", arrest_charge)) %>%
         separate_rows(arrest_charge, sep = "/") %>%
         mutate(arrest_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\-.*","", arrest_charge))) %>%
  unite(join_var, arrest_charge_level, arrest_charge_code, arrest_charge, remove = F)

  
# Code for Charge Hierarchy
load("Complete Charge Code Hierarchy.RData")

#remove these flags becasue they are messing up the final join of court and jail data
charge_hier <- charge_hier %>%
  select (-c(fta_flag))


book_df <- left_join(book_df, charge_hier, by = "join_var")
  
book_df<- book_df %>%
    mutate(arrest_misd_flag=if_else(arrest_charge_level=="M", 1, 0),
           arrest_felony_flag =if_else(arrest_charge_level=="F", 1, 0),
           arrest_attempt_flag=if_else(arrest_charge=="664", 1, arrest_attempt_flag),
           # not seeing any qualifier charges here  arrest_qualifier_flag=if_else()
           sup_vio_post_flag=if_else(book_type=="Sup_Vio", 1, 0),
           fta_flag=if_else(arrest_charge%in% c("8537", "1320A", "1320B", "13205", "40508A"), 1, 0))  
 ```

Jail Collapse
```{r}

# Booking Collapse--See pg. xxx for more details about this process. 
 ## No join step needed becasue there is only 1 booking table
 ## Grouped by book_num rather than (book_num and book_date) otherwise some court case ID's would be lost
 ## ungroup not in Noah's code, what does it do, does it amtter

book_df <- book_df %>%
  mutate(time_first_release = release_date_time - book_date_time) %>%
  mutate(hierarchy = if_else(is.na(hierarchy), 1e6, as.numeric(hierarchy))) %>%
  group_by(book_num) %>%
  mutate(max_booktype = book_type[hierarchy == min(hierarchy)][1],
        max_arrest_charge = arrest_charge[hierarchy == min(hierarchy)][1],
         max_charge_description = master_charge_description[hierarchy == min(hierarchy)][1],
         max_hier = min(hierarchy)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, .))) %>%
  mutate_at(vars(contains("flag")), funs("count" = sum(.))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  group_by(book_num, court_case_id) %>%
  filter(hierarchy == min(hierarchy)) %>%
  ungroup() %>%
  distinct(book_num, court_case_id, .keep_all = T)


```
          
San Mateo Jail Diagnostics
```{r eval=FALSE, include=FALSE}

# Diagnostics
book_df %>%
  distinct(book_num, court_case_id) %>%
  arrange(book_num) %>%
  group_by(book_num) %>%
  add_count() %>%
  filter(n>1)

book_df %>%
  distinct(book_num, book_date) 
book_df %>%
  filter(grepl("0771037", book_num))

# sort(table(substr(book_df$arrest_charge_original[grep("[A-Z]{2}$", book_df$arrest_charge_original)], 
#                   nchar(book_df$arrest_charge_original[grep("[A-Z]{2}$", book_df$arrest_charge_original)]) - 1, 
#                   nchar(book_df$arrest_charge_original[grep("[A-Z]{2}$", book_df$arrest_charge_original)]))), decreasing = TRUE)
# 
# sort(table(book_df$arrest_charge_original[grep("[A-Z]{2}$", book_df$arrest_charge_original)]), decreasing = TRUE)

book_df %>%
  count(arrest_charge_level_original)

book_df %>%
  filter(grepl("/", arrest_charge_original)) %>%
  count(arrest_charge) %>%
  arrange(desc(n))

book_df %>%
  filter(grepl)
  count(arrest_charge_original) %>%
  arrange(desc(n))

 # filter(attempt==1)%>%
 
# count(arrest_charge)
  
  
  mutate(attempt = if_else(grepl("^664\\/", arrest_charge_original), 1, 0)) %>%
  separate_rows(arrest_charge_original, sep = "\\\\|\\/") %>%
  mutate(
    # arrest_charge_code_original = paste0(strapplyc(charge_original, "^([A-Z]{2}).*", simplify = T)),
         # code_type = ifelse(code_type == "character(0)", NA, code_type),
         # code_type = na.locf(code_type),
         arrest_charge_level = str_extract(arrest_charge_level_original, "^(.).*"),
         # #Collapsing charge in this way does not result in any mismatched charges
         arrest_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}","", arrest_charge_original)))
         # cii = as.numeric(gsub("[^0-9]", "", cii)),
         # conspire = if_else(grepl("^CONSPIRE", charge_description), 1, 0))
  
# No code section in these data
#book_df$arrest_charge_code <- NA

# Code to check results of above:
#
table(book_df$arrest_charge)[order(table(book_df$arrest_charge), decreasing = T)]
# 
# 
# table(grep("\\/", book_df$arrest_charge_original, value = TRUE))
# 
# table(book_df$arrest_charge_level_original)
# 
# table(book_df$arrest_charge_original)[order(table(book_charge$arrest_charge_original), decreasing = T)]
# 
# book_df %>%
#   count(arrest_charge_original, arrest_charge) %>%
#   group_by(arrest_charge_original) %>%
#   add_count() %>%
#   filter(n > 1)
# 
# book_df$aco_count <- sapply(book_df$arrest_charge_original, function(x) length(which(book_df$arrest_charge_original == x)))
# book_df$ac_count <- sapply(book_df$arrest_charge, function(x) length(which(book_df$arrest_charge == x)))
# book_df$ac_counts_match <- book_df$aco_count == book_df$ac_count
# table(book_df$ac_counts_match, useNA = "ifany")
# 
# book_df[!(book_df$ac_counts_match), 
#         c("book_num", "arrest_charge_level_original", "arrest_charge_original", "arrest_charge", "attempt", 
#           "aco_count", "ac_count")][order(book_df$arrest_charge[!(book_df$ac_counts_match)]), ]


df <- tibble(x = 1:5, y = c("a,b,c", "F", "H, I, J", "L", "V"))

df %>%
  separate_rows(y, sep = ",")

# Diagnostic Code for Charge Hierarchy
# 1 - 7,901/267,372 = 97% non-match rate
(1 - nrow(book_df %>% filter(is.na(hierarchy)))/nrow(book_df))*100

book_df %>%
  filter(is.na(hierarchy)) %>%
  count(join_var) %>%
  arrange(desc(n))

# the most common unmatching code is Other_Other_  which is almost all foreign warrants, foreign_holds committments, and F_PC_13892 it is a #foregin hold detainer, F_PC_3454B is flash incarceration, F_PC_120221 allways has an enhancement in the orginal arrest charge.
# M_VC_23578 this code says if a person is convicted of a violation of Section 23152 or 23153 and refuses breathalyzer or has BAC >.15 it is #a special factor for imposting penalties

book_df%>%
  filter(grepl("0771037", book_num))%>%
  group_by(book_type_original)%>%
  count()
```


San Mateo Court Data
```{r eval=FALSE, include=FALSE}


# Court Case Data Import--- San Mateo, start date  to end date
  ## court_df contains multiple rows per court case, one for a complaint/indictment and another if there is an information. It includes information on the person.
  ## the letters at the end of the case number indicate co-defendants (eg -A and -B for co-defendants)
  ## Only felonies have an HTA associated with them.  If at the prelim or before the defendant admits or pleads NOLO the disposition            will show certified up but no HTA case is created.  The case starts out like 16-NF-000086-A  when the matter is held to answer that        original case gets the –HTA added and a new case is created when the information is filed with the same number as it started out minus      the HTA. (st...I think this means we strip off HTA and sort by  date, casaes start with complaints or indictments)
  ## court_sentence data  contains case type, case case status, charges, pleas and sentence information. 
  ## court_hearing data contains files date, case_type, hearing dates and types, hearing results and fta, and fta warrants
    

####

# Court Cases
court_df <- lapply(c("Historical Data Submissions/San Mateo/41-COURT-01OF03-JAN2016-SEP2019.csv", 
                    "Historical Data Submissions/San Mateo/41-COURT-01OF03-OCT2019-DEC2019.csv"), 
                                     function(x) {
                    fread(x, na.strings=c("NULL",""), colClasses = "character")
                  }) %>%
  bind_rows() %>%
  distinct()


# Variable name standardization--See pg. xxx for more details. 
names(court_df) <- c("court_docket_id", "court_case_id_original", "file_date", "court_case_type", "court_party_id", "cii", "fbi", "local_id", 
                     "cdl_id", "name", "dob", "sex_original", "race_original")


# Date Reformatting--See pg. xxx for more details.
court_df <- court_df %>%
     mutate(dob = as_date(dob)) %>%
     mutate(file_date = ymd(file_date))


# Standardize Factors, also standardize CII and name formatting--See pg. xxx for more details.
court_df <- court_df %>%
     ## remove -HTA from court_case_id_original so that information and complaint will have the same court_case_id since they are the same case at different stages
   mutate(court_case_id = gsub("-HTA", "", court_case_id_original)) %>%
    mutate(cii = as.character(cii)) %>%
    mutate(sex = case_when(sex_original %in% c("M") ~ "Male",
                         sex_original %in% c("F") ~ "Female",
                         T~"Other_Unknown"),
         race = case_when(race_original %in% c("Black") ~ "Black",
                          race_original %in% c("Hispanic") ~ "Hispanic",
                          race_original %in% c("White") ~ "White",
                          T ~ "Other_Unknown"),
        name = toupper(name)) %>% 
        separate(name, c("last_name", "first_name", "suffix"),  sep = ",") %>%
        mutate_at(vars(first_name, last_name, suffix), trimws) %>%
        separate(first_name, c("first_name", "middle_name"), sep = " ") %>%
        mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, (cii)))

####

# Court Sentences and Court Filing Charges 
 ## court sentence contains all of the court charge data
 ## court_sentence contains one row per charge (charge_id) (with about 400 repeats, assumedly from when separate_rows was used to divide combined charges, for example PC484-490.1)
 ## dropping sentence location, it was in the first extract, but not in second extract, we dont need that variable for analysis
 ## historical data submitted had to be stripped of new line characters in the middle of lines that interfered with reading the data in


court_sentence <- read_file("Historical Data Submissions/San Mateo/41-COURT-02OF03-JAN2016-SEP2019.csv")

court_sentence <- gsub("\n,", ",", court_sentence)

court_sentence <- read_csv(court_sentence, col_types = "iccccccccciiiccccccccccc_ciiiciii", na = c("", "NULL")) 

court_sentence_1 <- fread("Historical Data Submissions/San Mateo/41-COURT-02OF03-OCT2019-DEC2019.csv", na.strings=c("NULL",""))

court_sentence <- bind_rows(court_sentence, court_sentence_1) %>% distinct()

rm(court_sentence_1)


# Variable name standardization--See pg. xxx for more details.
names(court_sentence) <- c("court_docket_id", "court_case_id_original", "file_date", "court_case_type", "court_case_status_original", "court_case_status_date", "book_num", "arrest_date", "arrest_control", "arrest_agency", "offense_id", "charge_id", "charge_num", "offense_date", "court_charge_original", "court_charge_level_original", "court_charge_description", "plea_type_original", "plea_date", "disposition_type_original", "disposition_date", "final_date", "sentence_type_original", "sentence_date",  "probation_type", "term_years_probation", "term_months_probation", "term_days_probation", "jail_type", "term_years_jail", "term_months_jail", "term_days_jail")


# Date Reformatting--See pg. xxx for more details.
court_sentence <- court_sentence %>%
  mutate_at(vars(contains("date")), as_date)


# Standardize Factors--See pg. xxx for more details.
court_sentence <- court_sentence %>%
     ## remove -HTA from court_case_id_original so that information and complaint will have the same court_case_id since they are the same case at different stages
   mutate(court_case_id = gsub("-HTA", "", court_case_id_original)) %>%
  mutate(
    disposition_type = case_when(
      disposition_type_original %in% c(
        "Dismissal: Negotiated Plea",
        "Dismissal: Insufficient Evidence",
        "Dismissal: Interest of Justice",
        "Dismissal: Motion of the People",
        "Dismissal: Lack of Prosecution",
        "Dismissal",
        "No Finding",
        "Dismissal: Other Dismissal",
        "Dismissal: Insufficient Grounds to HTA",
        "Dismissal: After Drug Court",
        "Dismissal: Civil Compromise",
        "Dismissal: After Military Diversion",
        "Dismissal: No Reason Available",
        "Dismissal: PC1100 -Insufficient Evid. -Witness for Co-Defend",
        "Dismissal: PC995",
        "Dismissal: Prop 64",
        "Dismissal: PC1385 PC-Furtherance of Justice",
        "Dismissal: After Deferred Entry of Judgment",
        "Dismissal: Other Dismissal",
        "Dismissal: After Diversion",
        "Dismissal: PC1377/1378-Case Compromise/Rest of Satis. Made",
        "Dismissal: Post Sentence",
        "Dismissal: PC1381/1381.5/1382-Delay; Not Timely",
        "Dismissal: PC995-Accusation Set Aside",
        "Dismissal: PC871-Court Found Insufficient Cause",
        "Dismissal: 1203.4"
      ) ~ "Dismissed",
      
      disposition_type_original %in% c(
        "Pled Nolo Contendere",
        "Pled Nolo Contendere Lesser Included Offense"
      ) ~ "Nolo_Contendere",
      
      disposition_type_original %in% c(
        "Admitted",
        "Found True",
        "Pled Guilty",
        "Jury verdict of guilty",
        "Sentenced: Plea of Guilty/Nolo Contendere",
        "Court trial found guilty",
        "Found True",
        "Found Guilty",
        "Found Guilty Lesser Included Offense"
      ) ~ "Gulity",
      
      disposition_type_original %in% c(
        "DOJ - Found Not Guilty",
        "Denied",
        "Dismissal: Insufficient Grounds to HTA",
        "Jury verdict of not guilty",
        "Found Not True",
        "Court trial found not guilty"
      ) ~ "Not_Guilty",
      
      disposition_type_original %in% c(
        "Held to Answer",
        "Certified to Superior Court: PN859",
        "Stricken",
        "Held to Answer",
        "Certified to Superior Court",
        "Not Held to Answer",
        "No Finding",
        "Extradited",
        "Consolidated",
        "Veteran's Treatment/Military Diversion",
        "NULL",
        "Mistrial",
        "Certified to Juvenile Court",
        "Certified to Superior Court: PG859"
      ) ~ "Other"
    ),
    
    plea_type = case_when(
      plea_type_original %in% c("No Contest / Nolo Contendere") ~ "Nolo_Contendere",
      plea_type_original %in% c("Admit", "Guilty") ~ "Guilty",
      plea_type_original %in% c("Deny", "Not Guilty", "Not Guilty by Reason of Insanity") ~ "Not_Guilty",
      plea_type_original %in% c("NULL", "Once in Jeopardy", "Traffic School") ~ "Other"
    ),
    
    sentence_type = case_when(
      sentence_type_original %in% c("Prison Sentence") ~ "Prison",
      sentence_type_original %in% c(
        "Sentenced  PC1170(h) - Straight",
        "Mandatory Supervision Violation Sentence",
        "Probation Violation Sentence",
        "Sentenced PC1170(h) - Split"
      ) ~ "Jail",
      sentence_type_original %in% c("Probation Sentence", "Sentenced Prop 36") ~ "Probation",
      sentence_type_original %in% c(
        "Sentenced",
        "DIVERSION",
        "na_missing",
        "Sentence Modified",
        "Drug Court Sentence"
        ,
        "DUI Court Sentence"
      ) ~ "Other"
    ),
    
    court_case_status = case_when(
      court_case_status_original %in% c("Active") ~ "Active",
      court_case_status_original %in% c("Closed") ~ "Inactive"
    )
  )


# Charge Standardization can't add Flag her becasue flags are in court hearing table below--See pg. xxx for more details.
court_sentence <- court_sentence %>%
  mutate(court_charge_code = str_extract(court_charge_original, "^([A-Z]{2})"),
         court_charge_code = if_else(!court_charge_code %in% c("PC", "VC", "HS", "BP", "WI", "US"), "Other", court_charge_code),
         court_charge = gsub("^[A-Z]{2}|^[A-Z]{3}", "", court_charge_original ),
         court_charge_level = if_else(court_charge_level_original  %in% c("F1"), "F" , court_charge_level_original),
         court_charge_level = if_else(!court_charge_level %in% c("F", "I", "M"), "Other", court_charge_level),
         court_attempt_flag = if_else(grepl("664", court_charge_original), 1, 0),
         court_charge = gsub("664-|-[a-z]$", "", court_charge))%>%
         separate_rows(court_charge, sep = "-") %>%
         mutate(court_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\-.*","", court_charge)))%>%
  unite(join_var, court_charge_level, court_charge_code, court_charge, remove = F) 

         
# Code for Charge Hierarchy and
#Flag Construction

load("Complete Charge Code Hierarchy.RData")

 court_charge <- left_join(court_sentence, charge_hier, by = "join_var") %>%
  mutate(felony_flag = if_else(court_charge_level == "F", 1, 0),
         misd_flag = if_else(court_charge_level == "M", 1, 0)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, as.numeric(.)))) %>%
  mutate_at(vars(contains("flag")), funs("conviction" = if_else(. == 1 & disposition_type %in% c("Guilty", "Nolo_Contendere"), 1, 0))) %>%
  rename_at(vars(contains("flag"), -contains("conviction")), funs(paste0("court_", .))) %>%
  rename_at(vars(contains("conviction")), funs(paste0("conviction_", gsub("_conviction", "", .))))  

 
 ####
 
# Court Hearings
  ## court_hearing contains one row per setting_id (a unique hearing event on each court case) and includes information about each hearing. 
  ## still organized by court case type (complaint, indictment, information), which are given a different suffix on the court_case_id which will need to be stripped in order to collapse to the court case
  ## NOTE: between tables court_case_id is formatted differently, fix this (aka remove dashes) across all the san mateo tables so that they will match later

   court_hearing <-
   fread("Historical Data Submissions/San Mateo/41-COURT-03OF03-JAN2016-SEP2019.csv") 
   
   # Date Reformatting--See pg. xxx for more details.
   court_hearing <- court_hearing %>%
   mutate_at(vars(contains("date"), DtFile), as_date)
   
   
 
 court_hearing_1 <-
   fread(
     "Historical Data Submissions/San Mateo/41-COURT-03OF03-OCT2019-DEC2019.csv",
     na.strings = c("NULL", "")
   ) %>%
   mutate_at(vars(contains("date"), DtFile), mdy)
 
 
 court_hearing <-
   bind_rows(court_hearing, court_hearing_1) %>% distinct()
 
 rm(court_hearing_1)
 
 names(court_hearing) <-
   c( "court_docket_id", "court_case_id_original", "file_date", "court_case_type", "setting_id",  "hearing_date", "hearing_type_loc", "court_loc", "hearing_type_code", "hearing_type_original",
     "hearing_result",  "hearing_date_next",  "fta", "fta_warrant" )
 
 
 court_hearing <- court_hearing %>%
   ## remove -HTA from court_case_id_original so that information and complaint will have the same court_case_id since they are the same case at different stages
   mutate(court_case_id = gsub("-HTA", "", court_case_id_original)) %>%
   mutate(
     hearing_type = case_when(
       hearing_type_original %in% c(
         "Arraignment",
         "Arraignment on Information",
         "Warrant-Arraignment",
         "Domestic Violence Complaint Arraignment",
         "Further Arraignment",
         "Arraignment - Felony Fugitive",
         "Arraignment FTA",
         "Arraignment on Information after Preliminary Hearing",
         "Arraignment Parole Violation"
       ) ~ "Arraignment",
       hearing_type_original %in% c(
         "Sentencing",
         "Probation Report and Sentencing",
         "Sentence Hearing",
         "Prob Report and Sentencing - Proof of Firearm Relinquishment",
         "Proof of Firearm and Ammo Relinquishment and Sentencing",
         "Restitution Memo and Sentencing",
         "Sentencing on Violation of Probation",
         "Surrender for execution of sentence",
         "Probation Report and Sentencing (DUI)"
       ) ~ "Sentencing",
       hearing_type_original %in% c(
         "Jury Trial",
         "Pretrial Conference",
         "Warrant-Failed to Appear",
         "To Trail",
         "Jury Trail",
         "Preliminary Hearing",
         "To Set",
         "Warrant-Arraignment",
         "Warrant-Arraignment",
         "Warrant-Arraignment",
         "Warrant-Arraignment",
         "Attorney and Plea",
         "PC 1538.5 motion",
         "Domestic Violence Pretrial",
         "Further Proceedings",
         "Continued Jury Trial",
         "Motion to Continue Trial Date",
         "Motion hearings",
         "Motion to Continue",
         "Disposition and To Set",
         "Pathways Intake",
         "Further O.R. Report",
         "Disposition",
         "Bail Motion",
         "Drug Court Status Hearing - Predisposition",
         "Reset",
         "Order for Return of Prisoner",
         "Pretrial and To Set",
         "Penal Code section 995 motion",
         "Warrant - Failure to comply",
         "Diversion Violation Arraignment",
         "ID of Counsel",
         "Military Diversion Review",
         "Veteran Treatment Court Review",
         "Marsden motion",
         "Review",
         "Warrant-Probation Violation",
         "Civil Compromise",
         "Drug Court Decision on Suitability for Drug Court Diversion",
         "Diversion Violation Conference",
         "Probation Violation Conference",
         "Motion to Consolidate",
         "Proof of Drivers License",
         "Receipt of Doctors Report",
         "Bail Bond Motion",
         "Military Diversion Intake",
         "Modification of Sentence",
         "Motion to Dismiss",
         "AB208 Diversion Violation Arr-Reinstate Criminal Proceeding",
         "Continued Preliminary Hearing",
         "Subpoenaed Records Status and Further Proceedings",
         "Probation Violation To Trail",
         "Extradition Review",
         "AB 208 Diversion Violation Conference",
         "Pitchess Motion",
         "Superior Court Review and To Set",
         "Motion to Compel",
         "Bail Review hearing",
         "Status of:",
         "Hearing on Demurrer",
         "Entry of Plea",
         "Diversion Violation to Trail",
         "Court Trial",
         "Status of Appeal",
         "Humphreys Hearing",
         "Probation Violation Arraignment",
         "Receipt of Subpoenaed Records",
         "Substitution of Attorney",
         "Petition to Extend Commitment",
         "Status Hearing",
         "AB 208 Diversion Violation to Trail",
         "Veteran Treatment Court Intake",
         "Drug Court Treatment Plan",
         "Motion - PC1203.4",
         "Drug Court Status Hearing - Post Disposition",
         "Faretta Motion",
         "Restoration of Competency Certification - PC 1372",
         "DEJ Violation Arr and Reinstate Criminal Proceedings",
         "Status Conference",
         "Identification Hearing",
         "Plea Hearings",
         "AB 208 Diversion Violation Arraignment",
         "Bail Bond Surrender",
         "Failure to Comply",
         "Proof of Completion",
         "Restitution Memo",
         "Motion to Vacate",
         "Receipt of Placement Report",
         "PC 1170.95 Petitions for Resentencing",
         "AB 208 Diversion Violation Hearing",
         "MDUI Court Review",
         "Motion to Quash",
         "Other hearing",
         "Proof of Enrollment",
         "Serna Motion (Right to Speedy Trial)",
         "Diversion hearing",
         "Order to Show Cause Hearing",
         "Proof of Firearm and Ammunition Relinquishment",
         "Probation Violation Hearing",
         "Appointment of Doctor(s)",
         "Mental Health Diversion Eligibility",
         "Doctors Report Referral",
         "Domestic Violence Probation Violation Pretrial",
         "Bridges Review Intake",
         "Hearing Re: Outpatient Status Pursuant to PC 1606",
         "Military Diversion Determination",
         "DEJ Violation Arraignment",
         "O.R. Review",
         "Bridges Review",
         "Motion - 17(b) PC",
         "Motion to Strike Prior Conviction(s)",
         "Motion to Withdraw as Attorney",
         "Domestic Violence Progress Report",
         "To Set Probation Violation",
         "Further Court Trial",
         "In Camera Hearing",
         "Mental Competence Hearing",
         "Restitution Hearing",
         "Disposition or To Set Probation Violation",
         "Hearing Re: Cert of Restoration of Competency PC 1372",
         "Order to Show Cause - Attorney",
         "Pathways Review",
         "Conference",
         "Placement Report Referral",
         "Resentencing/modification hearing",
         "Court Trial on Prior Convictions",
         "Pre-Court Trial",
         "Mental Competency Progress Report PC1370(b)(1)",
         "Proof of Restitution",
         "DEJ Violation Hearing",
         "Mental Health Diversion Suitability Hearing",
         "Petition for or Status of Commitment Regarding Competency",
         "Receipt of Medical Records",
         "Certificate of Rehabilitation and Pardon",
         "Court Trial Pursuant to PC 1026-1027",
         "DEJ Violation Pretrial",
         "Ruling on Submitted Matter",
         "Order to Show Cause - Witness",
         "Restitution Court Status Review",
         "To Set Mental Health Diversion Suitability Hearing",
         "Evidentiary Hearing",
         "Examination of Source of Bail",
         "To Set Bail",
         "Jury Trial PC 1367-68",
         "Jury Trial Pursuant to PC 1026-1027",
         "Referral to courthouse clinic for mental health evaluation",
         "Mandatory Supervision to Trail",
         "Order to Show Cause Re: Contempt",
         "Petition for Release of Commitment - PC 1026.2",
         "Petition of Writ for Habeas Corpus",
         "PRCS To Trail",
         "Return on Appeal",
         "HIV Test Results",
         "Mandatory Supervision Violation Arraignment",
         "Mandatory Supervision Violation Conference",
         "Mandatory Supervision Violation Hearing",
         "Motion for a new trial",
         "Pretrial on Probation Violation",
         "Proof of Firearms Ammo Relinquishment and Restitution Report",
         "Return on Appeal - Remittitur Issued",
         "Veteran Treatment Court Probation Violation",
         "Jury Trial - Prior Convictions",
         "Lifting of no contact order",
         "Mental Health Diversion Review",
         "Motion for Modification",
         "OSC hearing - Predisposition hearing",
         "Resentencing Pursuant to PC 1170.18",
         "Return after PC 1203.03 90-day Diagnostic",
         "Status of DA case filing",
         "Warrant-Mandatory Supervision Violation",
         "Discovery hearing",
         "Franklin Hearing",
         "Further Proceedings on Probation Violation",
         "Motion to Sanction",
         "Motion to Strike",
         "Parole Revocation Conference",
         "Petition Hearing",
         "Proof of Correction",
         "Resentencing Pursuant to Prop 64",
         "Veterans Treatment Court Graduation",
         "Superior Court Review",
         "Dispo/Confirm",
         "Mental Competency Progress Report PC1370(b)(1)"
       ) ~ "Other"
     )
   )
 
 #Flag Construction
 court_hearing <- court_hearing %>%
   mutate(
     fta_flag = if_else(fta_warrant == "Warrant", 1, 0),
     fta_nowar_flag = if_else(fta == "FTA", 1, 0)
   )
 
 
``` 
court diagnostics and notes 
```{r eval=FALSE, include=FALSE}
 
court_sentence %>%
  add_count(charge_id) %>%
  filter(n>1) %>%
  arrange(charge_id)


# move to diagnostics when ready
court_df %>% 
  arrange(court_case_id, file_date) %>%
  select (court_docket_id, court_case_id, file_date, court_case_type, court_party_id)
   
# court_df diagnostics
#court_df  %>%
#court_df[, grepl("id", names(court_df))]

#court_df %>%
#distinct(court_docket_id, court_case_id)
#court_df %>%
#filter(is.na(court_docket_id))
#court_df %>%
#count(court_docket_id)
  

#court_df <- court_df %>%
  #mutate_at(vars(dob, file_date), as_date) these dates semm fine now

#court_df[, grepl("id", names(court_df))]


 #court_charge %>%  
   #arrange (court_case_id)
 #filter(grepl("2341697", court_docket_id))  
 #ls(court_charge)  
 #court_charge %>%  
 
 
  #filter(grepl("2341697", court_docket_id))  

# "M_VC_231035A" this charge never used during arrest usually arrest is DUI then they plead down to receless driving"wet"
# "Other_PC_6665" special allegation prior auto theft
           #sup_vio_post_flag=if_else(book_type=="Sup_Vio", 1, 0))

 
# write.csv(court_sentence[court_sentence$court_qualifier_flag == 1, c("court_charge_code", "court_charge",
#                                                                      "court_charge_original", 
#                                                                      "court_charge_level", "court_charge_level_original", 
#                                                                      "court_charge_description")],
#           file = "G:/CrimJustice/PretrialAssessmentPilot/Charge Definitions and Hierarchy/San_Mateo_Qualifier_Flags_Court_charges.csv")
# 
# table(court_sentence$court_qualifier_flag, useNA = "ifany")

```

Diagnostic Code for Charge Hierarchy
```{r eval=FALSE, include=FALSE}

# 1 - 7,901/267,372 = 97% non-match rate
(1 - nrow(court_sentence %>% filter(is.na(hierarchy)))/nrow(court_sentence))*100

court_sentence %>%
  filter(is.na(hierarchy)) %>%
  count(join_var) %>%
  arrange(desc(n))



court_sentence%>%
  filter(grepl("Other_PC_460A", join_var))%>%
  group_by()%>%
  count()


court_sentence %>%
  filter(grepl("2341697", court_docket_id))%>%
  count()

court_df %>%
filter(is.na(court_docket_id))

court_charge %>%
  filter(is.na(disposition_date))%>%
  select(disposition_date, sentence_date)

```
San Mateo Court Collapse 
```{r eval=FALSE, include=FALSE}

# Court Charge Collapse--See pg. xxx for more details about this process. 

  ## still need to ask Noah about the HTA's and also the strange error message when i didnt filter out disposition date na. returning -Infno non-missing #arguments to max  court_case_id cannot      end in -HTA
court_dispo <- court_charge %>%   
  mutate(disposition_type = ordered(disposition_type, levels = c("Other", "Dismissed", "Not_Guilty", "Nolo_Contendere", "Guilty"))) %>%
  filter (!grepl("-HTA", court_case_id) ) %>%
  group_by(court_case_id) %>%
  select(-c(charge_id,  offense_id)) %>%
  mutate(hierarchy = if_else(is.na(hierarchy), 1e6, as.numeric(hierarchy))) %>%
  group_by(court_case_id) %>%
  mutate(disposition_date = max(disposition_date), disposition_type = max(disposition_type)) %>%
  mutate(max_court_charge_level = court_charge_level[hierarchy == min(hierarchy)][1],
         max_court_charge_code = court_charge_code[hierarchy == min(hierarchy)][1],
         max_court_charge = court_charge[hierarchy == min(hierarchy)][1],
         max_charge_description = master_charge_description[hierarchy == min(hierarchy)][1],
         max_hier = min(hierarchy)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, .))) %>%
  mutate_at(vars(contains("flag")), funs("count" = sum(.))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  filter(hierarchy == min(hierarchy)) %>%
  ungroup() %>%
  distinct(court_case_id, .keep_all = T)

# Court FTAs are collapsed to each case. 
court_fta_war <- court_hearing %>%
  filter (!grepl("-HTA", court_case_id) ) %>%
  arrange(hearing_date) %>%
  group_by(court_case_id) %>%
  mutate(fta_date = min(hearing_date, na.rm = T)[fta_flag == 1][1]) %>%
  mutate(fta_flag = max(fta_flag),
         fta_flag_count = sum(fta_flag))%>%
  distinct(court_case_id, .keep_all = T) %>%  
 select(court_case_id, fta, fta_warrant, fta_flag, fta_nowar_flag, fta_date, fta_flag_count)


# Court hearings are filtered for arraignment information and collapsed to court case id and arraignment date??). 
court_arraign <- court_hearing %>%
  filter (!grepl("-HTA", court_case_id) ) %>%
  filter(hearing_type == "Arraignment") %>%
  arrange(hearing_date) %>%
  rename(arraignment_date = hearing_date) %>%
  arrange(arraignment_date) %>%
  distinct(court_case_id, .keep_all = T) %>%
  select(court_case_id, arraignment_date)

# Court sentence data  are filtered for plea events  and collapsed to (??court case id and??). 
court_plea <- court_sentence %>%
  filter (!grepl("-HTA", court_case_id) ) %>%
  arrange(disposition_date) %>%
  mutate(guilty_flag = if_else(disposition_type == "Guilty", 1, 0)) %>%
  group_by(court_case_id) %>%
  filter(guilty_flag == 1|sum(guilty_flag) == 0) %>%
  ungroup() %>%
  distinct(court_case_id, .keep_all = T) %>%
  select(court_case_id, plea_date = disposition_date, plea_type = disposition_type)

# Court sentences are combined and collapsed to (?? court case id). 
court_sent <- court_sentence %>%
  filter (!grepl("-HTA", court_case_id) ) %>%
  arrange(sentence_date) %>%
  distinct(court_case_id, .keep_all = T) %>%
  select(court_case_id, sentence_date, sentence_type_original, sentence_type)

# All data is joined.
court_df2 <- reduce(list(court_df, court_dispo, court_fta_war, court_arraign, court_plea, court_sent), left_join, by = "court_case_id") %>%
  filter (!grepl("-HTA", court_case_id) ) %>%
  select(-contains(".y")) %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x", "", .))) %>%
  mutate(final_disposition_date = if_else(disposition_date <= sentence_date|is.na(sentence_date), disposition_date, sentence_date),
         conviction_flag = if_else(disposition_type %in% c("Guilty","Nolo_Contendere"), 1, 0)) %>%
 

# assumes that if all charges dismissed then its over
 
```



San Mateo Court Hearing Diagnostics
```{r eval=FALSE, include=FALSE}

ls(court_charge)

court_dispo %>%
  filter(grepl("0771037", book_num))

charge_hier %>%
  filter(grepl("30800", hierarchy))

ls(charge_hier)

arrange(charge_hier, hierarchy)

court_hearing%>%
    count(hearing_type, sort=TRUE)

court_hearing %>%
  filter(grepl("0097379", court_docket_id))

court_hearing%>%
  filter(fta=="FTA")

# original_df[[4]] <- tibble(table_name = "court_hearing", original_field = original_field, modified_field = names(court_hearing))
court_hearing %>%
  count(hearing_type_code_description) %>%
  arrange(desc(n)) %>%
  mutate(hearing_type_code_description = paste0('"', hearing_type_code_description, '",'))

# Diagnostics for court collapse


court_fta_war %>%
  count(fta_flag)

# need to ask
full_join(court_fta %>% filter(fta_flag == 1), court_fta_war %>% filter(fta_flag == 1) %>% rename(fta_date = fta_war_date), by = c("court_case_id", "fta_date")) %>%
  filter(fta_all_flag != fta_flag) %>%
  add_count(court_case_id) %>%
  filter(n > 1) %>%
  arrange(court_case_id, fta_date)

court_hearing %>%
  count(hearing_type_original) %>%
  arrange(desc(n))
  
court_charge %>%
  filter(stage %in% c("DISPOSITION EVENT")) %>%
  select(-c(disposition_num, charge_id, charge_history_id, offense_id, disposition_hist_id, disposition_id, disposition_type_code, amend_reason_id, amend_reason))
  # filter(stage %in% c("Sentence Event")) %>%
  count(dispos) %>%
  arrange(desc(n))
  
court_dispo %>%
  distinct(court_case_id, disposition_date, .keep_all = T) %>%
  add_count(court_case_id) %>%
  filter(n > 1) %>%
  arrange(desc(n))

court_charge %>%
  filter(stage %in% c("PLEA EVENT")) %>%
  count(disposition_type_original) %>%
  arrange(desc(n))
  distinct(court_case_id, disposition_date, .keep_all = T) %>%
  add_count(court_case_id) %>%
  filter(n > 1) %>%
  arrange(desc(n))
  # select(-c(disposition_num, charge_id, charge_history_id, offense_id, disposition_hist_id, disposition_id, disposition_type_code, amend_reason_id, amend_reason))
  # filter(stage %in% c("Sentence Event")) %>%
  count(dispos) %>%
  arrange(desc(n))

court_charge %>%
  # filter(stage %in% c("CASE FILING")) %>%
  # filter(stage %in% c("SENTENCE EVENT", "DISPOSITION EVENT")) %>%
  # distinct(court_case_id) 
  count(stage)
  filter(court_case_id == "921214") 
  #Alameda end example
```


Probation. No Actual Assessment data. Do not use. Go live date is scheduled for Jan. 23, 2020
```{r}
# prob_df1 <- fread("Historical Data Submissions/San Mateo/41-PROBATION-01OF04-JAN2015-SEP2019.csv")
# prob_df2 <- fread("Historical Data Submissions/San Mateo/41-PROBATION-02OF04-JAN2015-SEP2019.csv")
# prob_df3 <- fread("Historical Data Submissions/San Mateo/41-PROBATION-03OF04-JAN2015-SEP2019.csv")
# prob_df4 <- fread("Historical Data Submissions/San Mateo/41-PROBATION-04OF04-JAN2015-SEP2019.csv")
```

Code Book
```{r eval=FALSE, include=FALSE}
# the original codebook got messed up, so it had to be remade
rm(original_field)

original_df <- bind_rows(original_df)

San_Mateo_df <- lapply(ls()[!grepl("original", ls())], function(i){
  df <- get(i)
  
  if(sum(grepl("date", names(df))) > 0){
  df2 <- df %>%
  select(contains("date"), -contains("time")) %>%
  gather("modified_field", "value") %>%
  group_by(modified_field) %>%
  summarise_all(funs(min = as.character(min(., na.rm = T)), mean = as.character(mean(., na.rm = T)), max = as.character(max(., na.rm = T))))
  }else{
    df2 <- tibble(modified_field = NA_character_, min = NA_character_, mean = NA_character_, max = NA_character_)
  }
  
  df <- df %>%
    mutate_if(~length(unique(.)) > 50|is.Date(.)|is.POSIXct(.), ~(. = "not_factor")) %>%    
    mutate_all(~if_else(is.na(.), "na_missing", as.character(.))) %>%
    gather(modified_field, factor_value) %>%
    count(modified_field, factor_value) %>%
    mutate(table_name = i, county = "San Mateo") %>%
    mutate(factor_flag = if_else(factor_value == "not_factor", 0, 1)) %>%
    group_by(table_name, modified_field) %>%
    mutate(table_count = sum(n)) %>%
    ungroup() %>%
    rename("factor_count" = "n") %>%
    mutate(factor_count = if_else(factor_value == "not_factor", NA_integer_, factor_count),
           factor_percent = round(factor_count/table_count*100, 1)) %>%
    arrange(desc(factor_flag), modified_field, desc(factor_count))
  
  df <- left_join(df, df2, by = "modified_field")
    }) %>% 
  bind_rows() %>%
  left_join(original_df) %>%
   select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_count,
           factor_percent, table_count, min, mean, max) 

write.xlsx(San_Mateo_df, file = "Code Books/San Mateo Code Book.xlsx")
```

DOJ CII/Linking Extraction
```{r}
# Grab Tables with CII
# df <- sapply(ls()[which(sapply(ls(), function(i){
#   sum(names(get(i)) %in% "cii")
# }) == 1)], get)

# Pull CII and other identifiers
doj_book <- book_df %>%
  select(cii, fbi, name, dob, cdl_id, race_original, sex_original) %>%
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) %>%
  distinct()


# doj_court <- df[[2]] %>%
#   select(cii, fbi, dob, race_original, sex_original, name, local_id) %>%
#   mutate(cii = parse_number(cii),
#          cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
#                          nchar(cii) == 7 ~ paste0("000", cii),
#                          nchar(cii) == 8 ~ paste0("00", cii),
#                          nchar(cii) == 9 ~ paste0("0", cii)),
#                          T ~ as.character(cii)),
#          cii = if_else(nchar(cii) != 10, NA_character_, cii)) %>%
#   distinct()
# 
# court_df %>%
#   filter(!is.na(cii))

# Examine missing ciis and duplicates on cii. 
# doj_book %>% #Off by about 55,000
#   distinct()
# 
# doj_book %>% 
#   distinct(cii)
# 
# doj_book %>% 
#   distinct() %>%
#   add_count(cii) %>%
#   filter(n > 1) %>%
#   arrange(desc(n)) %>% 
#   View()
# 
# doj_court %>% #Off by about 45,000
#   distinct()
# 
# doj_court %>% 
#   distinct(cii)
# 
# doj_court %>% 
#   distinct() %>%
#   add_count(cii) %>%
#   filter(n > 1) %>%
#   arrange(desc(n)) %>% 
#   View()
# 
# 
# doj_book %>% # Off by about 7,000
#   distinct()
# 
# doj_book %>% 
#   distinct(cii)

# doj_book %>% 
#   distinct() %>%
#   add_count(cii) %>%
#   filter(n > 1) %>%
#   arrange(desc(n)) %>% 
#   View()
# 
# doj_court %>% #Off by about 9,000
#   distinct()
# 
# doj_court %>% 
#   distinct(cii)
# 
# doj_court %>% 
#   distinct() %>%
#   add_count(cii) %>%
#   filter(n > 1) %>%
#   arrange(desc(n)) %>% 
#   View()

#CIIs for DOJ
doj_cii <- (doj_book %>% select(cii)) %>% distinct()


#Create an excel workbook with all data table. Make sure to include the cii table first. 
write.xlsx(list(doj_cii, doj_book), file = "CIIs for DOJ/San Mateo CIIs and Demographics for DOJ.xlsx", sheetName = c("ciis", "booking"))


```
Compile Codebook Notes
```{r}
files <- list.files("G:/CrimJustice/PretrialAssessmentPilot/Code Books/Code Book Notes", pattern = "San Mateo", full.names = T)
df <- lapply(files, read_excel)


df[[3]] <- full_join(df[[1]], df[[2]]) %>%
  mutate(factor_standard = "") %>%
  select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_standard, factor_count, factor_percent, 
         table_count, "nl_notes_2" = factor_collapse, "nl_notes_1" = notes, min, mean, max, "st_notes" = Notes)

df <- list(df[[3]], df[[1]], df[[2]])

write.xlsx(df, file = "G:/CrimJustice/PretrialAssessmentPilot/Code Books/Variable Construction/San Mateo Factor Construction.xlsx", asTable = T, tableStyle = "TableStyleMedium1", sheetName = c("Variable Construction", "st_notes", "nl_notes"))
```
Create Factor Codebook
```{r}
#Create Factor Codebook
factor_df <- lapply(ls()[!grepl("original|^df|hier", ls())], function(i){
  df <- get(i)
  if(sum(grepl("original", names(df))) == 0){
    return(NULL)
  }else{
    var_names <- names(df)[grepl("original", names(df))]
    var_names2 <- gsub("_original", "", var_names)
   
    df1 <- df %>%
     select(var_names) %>%
     gather(original_field, original_value)
   
    df2 <- df %>%
     select(var_names2) %>%
     gather(modified_field, modified_value)
   
   df <- bind_cols(df1, df2) %>%
     count(original_field, modified_field, original_value, modified_value) %>%
     arrange(modified_field, desc(n)) %>%
     group_by(modified_field) %>%
     mutate(row = row_number(),
            percent = round(n/sum(n)*100)) %>%
     ungroup() %>%
     filter(row <= 50) %>%
     select(-row) %>%
     rename("total" = n)
   }
  }) %>%
  bind_rows()

write.xlsx(factor_df, file = "G:/CrimJustice/PretrialAssessmentPilot/Code Books/Factor Code Book/San Mateo Factor Code Book.xlsx", asTable = T, tableStyle = "TableStyleMedium1", colWidths = "auto")

```
 Joining All Data Post-Collapse
 Jail Court Join
```{r}
# Remove extraneous objects in the environment
rm(list = ls()[!ls() %in% ls(pattern = "df")])

#Check for common variables
#names(book_df)[names(book_df) %in% names(assess_df)] no assessment data yet

names(book_df)[names(book_df) %in% names(court_df2)]



#Turning NULL to NA to ensure non matching and removing generic charge info from data frames
book_df <- book_df %>%
  mutate_if(is.character, list(~na_if(., "NULL"))) %>%
  select(-c(charge, charge_level, charge_code)) %>%
  mutate_at(vars(first_name, last_name), toupper)

#assess_df <- assess_df %>%
 # mutate_if(is.character, list(~na_if(., "(Missing)"))) %>%
  #select(-c(id, court))

court_df2 <- court_df2 %>%
  mutate_if(is.character, list(~na_if(., "NULL"))) %>%
  select(-c(charge, charge_level, charge_code)) %>%
  mutate_at(vars(first_name, last_name), toupper) %>%
  mutate(court_case_id = as.character(court_case_id))

#Joining Assessment to Jail Data
join1 <- inner_join(book_df, assess_df, by = "book_num", na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x$", "", .))) %>%
  select(-contains(".y")) %>%
  #1 Duplicate with missing dispositions which will be dropped later. 
  distinct()

j1 <- anti_join(book_df, assess_df, by = "book_num", na_matches = "never")
a1 <- anti_join(assess_df, book_df, by = "book_num", na_matches = "never")


  #Examine if set of common variables is distinct--yes
  semi_join(book_df, assess_df, by = "book_num", na_matches = "never") %>%
    distinct()

#Joining on Name and Court ID
join2 <- inner_join(j1, a1, by = c("first_name", "last_name", "book_date" = "interview_date"), 
                    na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x$", "", .))) %>%
  select(-contains(".y")) %>%
  #1 Duplicate with missing dispositions which will be dropped later. 
  distinct()

j2 <- anti_join(j1, a1, by = c("first_name", "last_name", "book_date" = "interview_date"), na_matches = "never")
a2 <- anti_join(a1, j1, by = c("first_name", "last_name", "interview_date" = "book_date"), na_matches = "never")

  #Examine if set of common variables is distinct--yes
  semi_join(j1, a1, by = c("first_name", "last_name", "book_date" = "interview_date"), 
            na_matches = "never") %>%
    distinct()
  
#Diagnostics
  #Jail and Assessment Matches by category
tibble(
  stage = 1:2,
  match = c(
    'c("book_num")',
    'c("first_name", "last_name", "book_date" = "interview_date")'
  ),
  # jail_match_rate = sapply(1:2, function(i) {
  #   (nrow(book_df) - nrow(get(paste0("j", i)))) / nrow(book_df) * 100
  # }),
  assess_match_rate = sapply(1:2, function(i) {
    (nrow(assess_df) - nrow(get(paste0("a", i)))) / nrow(assess_df) * 100
  })
)

#Recreating Booking--Should be same number of rows.
book_df <- bind_rows(join1, join2, j2)  

rm(list = ls()[!ls() %in% ls(pattern = "df")])

#scratch

court_df2 %>%
 ls()
   
book_df %>%
  ls()


 join1 %>%
  select(contains(".x")) %>%
  names() %>%
  sort()

join1 %>%
  select(contains("arrest_")) %>%
  names() %>%
  sort()

names(book_df)[names(book_df) %in% names(court_df2)]

names(join1)[grepl("\\.x", names(join1)) & paste0("arrest_", gsub("\\.x$", "", names(join1))) %in% names(join1)]


names(join1)[grepl("\\.y", names(join1)) & paste0("court_", gsub("\\.y$", "", names(join1))) %in% names(join1)]
#end of scratch


# Court Matching
#Joining on cdl_id
join1 <- inner_join(book_df, court_df2, by = c("cdl_id"), na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(paste0("arrest_", gsub("\\.x$", "", .)))) %>%
  rename_at(vars(contains(".y")), funs(paste0("court_", gsub("\\.y$", "", .)))) %>%
  # 8 Duplicates with missing dispositions which will be dropped later. 
  distinct()

j1 <- anti_join(book_df, court_df2, by = c("cdl_id"), na_matches = "never")
c1 <- anti_join(court_df2, book_df, by = c("cdl_id"), na_matches = "never")



  #Examine if set of common variables is distinct--yes except 8 spurious cases.
  join1 %>%
    select(-contains("flag")) %>%
    add_count("cdl_id") %>%
    filter(n > 1) %>%
    arrange(desc(n))

     

#Joining on Name and Court ID
join2 <- inner_join(j1, c1, by = c("last_name", "first_name", "dob"), na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(paste0("arrest_", gsub("\\.x$", "", .)))) %>%
  rename_at(vars(contains(".y")), funs(paste0("court_", gsub("\\.y$", "", .)))) %>%
  #1 Duplicate with missing dispositions which will be dropped later. 
  distinct()

j2 <- anti_join(j1, c1, by = c("last_name", "first_name", "dob"), na_matches = "never")
c2 <- anti_join(c1, j1, by = c("last_name", "first_name", "dob"), na_matches = "never")

  #Examine if set of common variables is distinct--yes except 8 spurious cases.
  join2 %>%
     select(-contains("flag")) %>%
    add_count("last_name", "first_name", "dob") %>%
    filter(n > 1) %>%
    arrange(desc(n))

#Joining on Court ID
join3 <- inner_join(j2, c2, by = c("fbi"), na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(paste0("arrest_", gsub("\\.x$", "", .)))) %>%
  rename_at(vars(contains(".y")), funs(paste0("court_", gsub("\\.y$", "", .)))) %>%
  #1 Duplicate with missing dispositions which will be dropped later. 
  distinct()

j3 <- anti_join(j2, c2, by = c("fbi"), na_matches = "never")
c3 <- anti_join(c2, j2, by = c("fbi"), na_matches = "never")

  #Examine if set of common variables is distinct--yes except 8 spurious cases.
  join3 %>%
    add_count ("fbi") %>%
    filter(n > 1) %>%
    arrange(desc(n))
  
#Diagnostics
  #Jail and Court Matches by category
tibble(
  stage = 1:3,
  match = c(
    'c("cdl_id")',
    'c("cdl_id", "first_name", "last_name", dob")',
    'c("cdl_id", "fbi")'
  ),
  jail_match_rate = sapply(1:3, function(i) {
    (nrow(book_df) - nrow(get(paste0("j", i)))) / nrow(book_df) * 100
  }),
  court_match_rate = sapply(1:3, function(i) {
    (nrow(court_df2) - nrow(get(paste0("c", i)))) / nrow(court_df2) * 100
  })
)

join_df <- bind_rows(join1, join2, join3)
```

# Santa Barbara

Jail Data
```{r}
book_df <- read_excel("Historical Data Submissions/Santa Barbara/Jail.Data.12.5.xlsx", col_types = "text")

names(book_df) <- c("cii", "first_name", "last_name", "dob", "arrest_date_time", "book_num", "book_date_time", "book_type", "case_id", "charge_code", "charge", "charge_level", "release_date_time", "release_type", "gender", "race")
```

Court Data
```{r}
#Court Status
court_status <- fread("Historical Data Submissions/Santa Barbara/CaseStatus.csv", header = F)

names(court_status) <- c("case_id", "case_num", "status_date", "status")

#Court Charges
court_charges <- fread("Historical Data Submissions/Santa Barbara/Charges.csv", header = F)

names(court_charges) <- c("case_id", "case_num", "charge_code", "charge", "charge_level", "charge_description", "plea_date", "plea_type", "disposition_date", "dispositiontype", "disposition_date_final")

#Court hearing data
court_hearing <- fread("Historical Data Submissions/Santa Barbara/Hearings.csv", header = F)

names(court_hearing) <- c("case_id", "case_num", "hearing_date", "hearing_type", "hearing_result")

#The following is for confinement sentencing.
court_confinement <- fread("Historical Data Submissions/Santa Barbara/SentConf.csv")

names(court_confinement) <- c("case_id", "case_num", "sentence_date", "setence_type", "sentence_loc",
                              "sentence_term", "term_length")

#The following is for probation sentencing.
court_probation <- fread("Historical Data Submissions/Santa Barbara/SentProb.csv", header = F)

names(court_probation) <- c("case_id", "case_num", "sentence_date", "setence_type", "sentence_loc",
                              "sentence_term", "term_length")

#Court Person IDs
court_person <- fread("Historical Data Submissions/Santa Barbara/TechElements.csv", header = F)

names(court_person) <- c("case_id", "case_num", "last_name", "first_name", "middle_name", "file_date", "dob", "cii", "dln", "fbi", "sex", "race", "dln_state", "ra_date")

#FTA Warrants
court_fta_war <- fread("Historical Data Submissions/Santa Barbara/Warrants.csv", header = F)

names(court_fta_war) <- c("case_id", "case_num", "fta", "fta_date", "fta_warrant", "fta_warrant_date", "fta_description")
```

Assessment Data (Court)
```{r}
#Assessment with Full Interviews
assess_interview <- read_excel("Historical Data Submissions/Santa Barbara/Full.xlsm", skip = 1)

names(assess_interview) <- c("name", "dob", "book_num", "arrest_date", "interview_type", "interviewer", "interview_date", "location", "refferal_type", "court_loc", "case", "cid", "alcohol_flag", "civic_flag", "drug_flag", "financial_flag", "personal_flag", "property_flag", "order_flag", "sex_flag", "traffic_flag", "violation_flag", "violent_flag", "other_flag", "other2_flag", "charge_level", "charge_score", "pending_flag", "pending_score", "residence_type", "residence_score", "employment_type", "employment_score", "crim_history", "crim_history_score", "drug_abuse_history", "drug_abuse_history_score", "fta_history", "fta_score", "vc_history", "vc_score", "risk_score", "pretrial_recommendation", "sup_agency", "conern_risk", "concern_public_safety", "concern_poi", "concern_no_bail", "concern_fta_possibilty", "concern_ineligible", "concern_other", "concern2_other", "bail_recommend", "custody", "cond_call_in", "cond_ptco", "cond_avoid_place", "cond_avoid_contact", "cond_maths", "cond_passport", "cond_drugs", "cond_scram", "cond_gps", "cond_weapons", "cond_sands", "cond_other", "aoda_recommend", "reassess_change", "reassess_ref", "reassess_victim", "reassess_info", "reassess_charges", "comments", "pts_assessment", "sex", "race_ai", "race_asian", "race_black", "race_hispanic", "race_me", "race_pi", "race_white", "race_other", "race2_other", "language", "bw", "gang", "supervision", "sbc_partner", "sbc_family", "sbc_children", "sbc_work", "sbc_school", "sbc_none", "ca_partner", "ca_family", "ca_children", "ca_work", "ca_school", "ca_none", "outside_partner", "outside_family", "outside_children", "outside_work", "outside_schoool", "outside_none", "cellphone", "email", "alcohol_use", "narcotics_use", "employed", "in_school", "living_conditions", "information_quality", "references", "omissions", "deception", "no_refs", "other_issues", "other2_issues", "id", "data")

assess_tracking <- read_excel("Historical Data Submissions/Santa Barbara/Full.xlsm", skip = 1, sheet = 3)

names(assess_tracking) <- c("id", "name", "dob", "cide", "interview_date", "book_num", "referral_type", "court", "risk_score", "pretrial_recommend", "supervision_agency", "custody", "bail_before_court_flag", "pretrial_decision", "bailed_after_court", "continue_tracking_flag")

assess_outcome <- read_excel("Historical Data Submissions/Santa Barbara/Full.xlsm", skip = 1, sheet = 4)

names(assess_outcome) <- c("id", "name", "cid", "interview_date", "referral_type", "decision", "case_num", "charge_level", "case_status", "cd1", "cd1_appeared", "cd2", "cd2_appeared", "cd3", "cd3_appeared", "cd4", "cd4_appeared", "cd5", "cd5_appeared", "cd6", "cd6_appeared", "cd7", "cd7_appeared", "cd8", "cd8_appeared", "cd9", "cd9_appeared", "pretrial_rearrest", "pretrial_rearrest_date", "remand_flag", "rearrest_remand_case", "phone_num", "contact_notes", "other")

assess_nointerview <- read_excel("Historical Data Submissions/Santa Barbara/Non.xlsm", skip = 1)

names(assess_nointerview) <- c("name", "dob", "book_num", "arrest_date", "reviewer", "review_date", "review_loc", "referral_type", "court", "cid", "case_num", "stage_none", "stage_preinterview", "stage_interview", "stage_references", "stage_victim", "stage_assess", "alcohol_flag", "civic_flag", "drug_flag", "financial_flag", "personal_flag", "property_flag", "order_flag", "sex_flag", "traffic_flag", "violation_flag", "violent_flag", "other_flag", "other2_flag", "non_unwilling", "non", "non_capital", "non_supervision", "non_other_agency", "non_sick", "non_849", "non_warrants", "non_other", "non_other_more", "aoda", "reassess_cricumstance", "reassess_willing", "reassess_info", "reassess_holds", "reassess_charge", "sex", "race_ai", "race_asian", "race_black", "race_hispanic", "race_me", "race_pi", "race_white", "race_other", "race2_other", "language", "id", "filename")
```

# Sierra

Court Data
```{r}

original_df <- list()

# > list.files("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Sierra/")
# [1] "Charges-Disposition 01-14-20.csv" "Demographics-01-14-20.csv"        "FTA 09-15-19 thru 01-14-2020.csv" "Pretrial Grant Cases.xlsx"       
# [5] "Pretrial_1_FTA.csv"  

# "Pretrial Grant Cases.xlsx" is case information, being read to court_df

# "Demographics-01-14-20.csv" being read to court_demo

# "Charges-disposition 01-14-20.csv" being read to court_dispos


# "FTA 09-15-19 thru 01-14-2020.csv" apppers to be mostly the same as "Pretrial_1_FTA.csv" in that both share the following columns:
# "Case Number", "Case Name", "Issue Date", "Warrant Type"
# "FTA 09-15-19 thru 01-14-2020.csv" has "Type" [of hearing?], Result Date" & "Result Type" while
# "Pretrial_1_FTA.csv" has FN, LN, DL#, "Filing Date", "Case Type" [fel/misd], Disposition Date", "Disposition Type", "Disposition Manner"
# former could be list of appearances resulting in FTA warrant and latter could be list of warrants issued [?]

court_df <- read.xlsx("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Sierra/Pretrial Grant Cases.xlsx")

original_field <- names(court_df)

names(court_df) <- c("case_id", "case_name", "charge_number", "charge_level", "charge", "violation_date", "file_date", "disposition_date", "disposition_type", "disposition_manner")

original_df[[1]] <- tibble(table_name = "court_df", original_field = original_field, modified_field = names(court_df))

court_df <- court_df %>%
  mutate_at(vars(contains("date")), as_date, origin = "1899-12-30")
                       
court_demo <- read.csv("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Sierra/Demographics-01-14-20.csv",
                       as.is = TRUE)

original_field <- names(court_demo)

names(court_demo) <- c("case_id", "first_name", "last_name", "dob", "race", "sex")

original_df[[2]] <- tibble(table_name = "court_demo", original_field = original_field, modified_field = names(court_demo))
                       
court_demo$dob <- mdy(court_demo$dob)

court_dispos <- read.csv("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Sierra/Charges-Disposition 01-14-20.csv",
                         as.is = TRUE)

original_field <- names(court_dispos)

names(court_dispos) <- c("case_id", "case_name", "file_date", "charge_number", "charge_level", "charge", "disposition_date", "disposition_type", "disposition_manner", "sentence_date", "sentence_type", "sentence_amount", "sentence_length", "sentence_length_unit")

original_df[[3]] <- tibble(table_name = "court_dispos", original_field = original_field, modified_field = names(court_dispos))

court_dispos <- court_dispos %>%
  mutate_at(vars(contains("date")), mdy)

court_fta <- read.csv("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Sierra/FTA 09-15-19 thru 01-14-2020.csv",
                      as.is = TRUE)

original_field <- names(court_fta)

names(court_fta) <- c("case_id", "case_name", "hearing_type", "hearing_result_date", "hearing_result_type", "fta_warrant_date", "fta_warrant_type")

original_df[[4]] <- tibble(table_name = "court_fta", original_field = original_field, modified_field = names(court_fta))

court_fta <- court_fta %>%
  mutate_at(vars(contains("date")), mdy)

court_fta_warrant <- read.csv("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Sierra/Pretrial_1_FTA.csv",
                              as.is = TRUE)

original_field <- names(court_fta_warrant)

names(court_fta_warrant) <- c("case_id", "case_name", "first_name", "last_name", "cdl_id", "cdl_id_type", "file_date", "charge_level", "disposition_date", "disposition_type", "disposition_manner", "fta_warrant_date", "fta_warrant_type")

original_df[[5]] <- tibble(table_name = "court_fta_warrant", original_field = original_field, modified_field = names(court_fta_warrant))

court_fta_warrant <- court_fta_warrant %>%
  mutate_at(vars(contains("date")), mdy)

```


Code Book
```{r eval=FALSE, include=FALSE}
rm(original_field)
original_df <- bind_rows(original_df)
Sierra_df <- lapply(ls()[!grepl("original", ls())], function(i){
  df <- get(i)
  
  if(sum(grepl("date", names(df))) > 0){
    df2 <- df %>%
      select(contains("date"), -contains("time")) %>%
      gather("modified_field", "value") %>%
      group_by(modified_field) %>%
    summarise_all(funs(min = as.character(min(., na.rm = T)), mean = as.character(mean(., na.rm = T)), 
                       max = as.character(max(., na.rm = T))))
  }else{
    df2 <- tibble(modified_field = NA_character_, min = NA_character_, mean = NA_character_, max = NA_character_)
  }
  
  df <- df %>%
    mutate_if(~length(unique(.)) > 50|is.Date(.)|is.POSIXct(.), ~(. = "not_factor")) %>%
    mutate_at(vars(contains("name")), ~(.="not_factor")) %>%
    mutate_at(vars(contains("_id$")), ~(.="not_factor")) %>%
    mutate_all(~if_else(is.na(.), "na_missing", as.character(.))) %>%
    gather(modified_field, factor_value) %>%
    count(modified_field, factor_value) %>%
    mutate(table_name = i, county = "Sierra") %>%
    mutate(factor_flag = if_else(factor_value == "not_factor", 0, 1)) %>%
    group_by(table_name, modified_field) %>%
    mutate(table_count = sum(n)) %>%
    ungroup() %>%
    rename("factor_count" = "n") %>%
    mutate(factor_count = if_else(factor_value == "not_factor", NA_integer_, factor_count),
           factor_percent = round(factor_count/table_count*100, 1)) %>%
    arrange(desc(factor_flag), modified_field, desc(factor_count))
  
  df <- left_join(df, df2, by = "modified_field")
    }) %>% 
  bind_rows() %>%
  left_join(original_df) %>%
   select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_count,
           factor_percent, table_count, min, mean, max) 
write.xlsx(Sierra_df, file = "Code Books/Sierra Code Book.xlsx")


```



# Tulare
- Everything is Join

Jail Data
```{r}
book_df <- fread("Historical Data Submissions/Tulare/JMS data.csv", sep = NULL, col.names = "x")

book_df <- book_df %>%
  mutate(x = gsub(", ,", ",NA,", x),
         x = gsub(", ", " ", x),
         x = gsub("[A-Z](,,,,)[A-Z]", ",,,", x)) %>%
  separate(x, c("cii", "fbi", "ref", "dln", "name", "dob", "ref2", "race", "bail_amt", "date",
                "charge", "ref3", "ref4", "name2", "dob2", "date2", "unknown", "date3", "ref5", 
                "ref6", "charge2", "date4", "date5", "numeric"),
           sep = ",") %>%
  select(-contains("ref"))

book_df <- book_df %>%
  mutate_at(vars(dob, dob2), funs(mdy(if_else(nchar(.) == 7, paste0("0", .), .)))) %>%
  mutate_at(vars(contains("date")), ymd_hms)
```

Court Data
```{r}
original_df <- list()

court_df <- lapply(c("15-16", "16-17", "17-18", "18-19"), function(i){
  fread(paste0("Historical Data Submissions/Tulare/PretrialStatsFY", i, ".csv"), colClasses = "character", header = F)}) %>%
  bind_rows()

original_field <- names(court_df)

names(court_df) <- c("case_id", "filing_date", "disposition_date", "case_type", "name", "dob", "sex", "race", "fbi", "cii", "dln", "arrest_date", "arrest_agency", "report_id", "charge_level", "charge", "charge_filing_date", "charge_type", "charge_code", "charge_description", "disposition_date_charge", "disposition", "sentence_date", "sentence_charge", "sentence", "sentence_amt", "sentence_type", "term", "sentence_status", "hearing_date", "hearing_type", "hearing_result", "warrant_date", "warrant_type", "total")

original_df[[1]] <- tibble(table_name = "court_df", original_field = original_field, modified_field = names(court_df))

court_df <- court_df %>%
  mutate_at(vars(contains("date"), dob), mdy)
```

Probation (assessment)--Confusing Data. Figure out later. 
```{r}
prob_df <- fread("Historical Data Submissions/Tulare/Extremely Rough DRAFT Pretrial Project data 20191008 1722.csv")

original_field <- names(prob_df)

names(prob_df) <- c("event_id", "tool_name", "ra_date", "zip_code", "tool_response", "risk_score", "release_recommendation", "release_decision", "release_type", "release_date", "release_conditions", "pretrial_violation", "pretrial_violation_date", "court_date_reminder", "termination_outcome", "termination_date", "cii", "fbi", "local_id", "dln", "name", "dob", "sex", "race")

original_df[[2]] <- tibble(table_name = "prob_df", original_field = original_field, modified_field = names(prob_df))

prob_df <- prob_df %>%
  mutate(ra_date_time = mdy_hms(ra_date),
         ra_date = as_date(ra_date_time),
         release_date_time = mdy_hms(release_date),
         release_date = as_date(release_date_time)) %>%
  mutate_at(vars(pretrial_violation_date, termination_date, dob), mdy)
```

Code Book
```{r eval=FALSE, include=FALSE}
rm(original_field)

original_df <- bind_rows(original_df)

Tulare_df <- lapply(ls()[!grepl("original", ls())], function(i){
  df <- get(i)
  
  if(sum(grepl("date", names(df))) > 0){
  df2 <- df %>%
  select(contains("date"), -contains("time")) %>%
  gather("modified_field", "value") %>%
  group_by(modified_field) %>%
  summarise_all(funs(min = as.character(min(., na.rm = T)), mean = as.character(mean(., na.rm = T)), max = as.character(max(., na.rm = T))))
  }else{
    df2 <- tibble(modified_field = NA_character_, min = NA_character_, mean = NA_character_, max = NA_character_)
  }
  
  df <- df %>%
    mutate_if(~length(unique(.)) > 50|is.Date(.)|is.POSIXct(.), ~(. = "not_factor")) %>%    
    mutate_all(~if_else(is.na(.), "na_missing", as.character(.))) %>%
    gather(modified_field, factor_value) %>%
    count(modified_field, factor_value) %>%
    mutate(table_name = i, county = "Tulare") %>%
    mutate(factor_flag = if_else(factor_value == "not_factor", 0, 1)) %>%
    group_by(table_name, modified_field) %>%
    mutate(table_count = sum(n)) %>%
    ungroup() %>%
    rename("factor_count" = "n") %>%
    mutate(factor_count = if_else(factor_value == "not_factor", NA_integer_, factor_count),
           factor_percent = round(factor_count/table_count*100, 1)) %>%
    arrange(desc(factor_flag), modified_field, desc(factor_count))
  
  df <- left_join(df, df2, by = "modified_field")
    }) %>% 
  bind_rows() %>%
  left_join(original_df) %>%
   select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_count,
           factor_percent, table_count, min, mean, max) 

write.xlsx(Tulare_df, file = "Code Books/Tulare Code Book.xlsx")
```


Join
```{r eval=FALSE, include=FALSE}
#Alameda has an integrated criminal justice system. Information is joined across agencies on the jail_court_ID. It is contained in the book_df, court_df, and book_charge tables. 

#Jail Court ID is duplicated when split between cases
book_df <- book_df %>% distinct(jail_court_id, .keep_all = T)

#Jail Court ID is duplicated when split between cases
court_df <- court_df %>% distinct(jail_court_id, .keep_all = T)

book_no_court <- anti_join(book_df, court_df, by = c("jail_court_id"))
nrow(book_df)
nrow(book_no_court)
nrow(book_no_court)/nrow(book_df)

court_no_book <- anti_join(court_df, book_df, by = c("jail_court_id"))
nrow(court_df)
nrow(court_no_book)
nrow(court_no_book)/nrow(court_df)
```


# Tuolumne

Jail Data
```{r}

```

Court Data
```{r}
court_df <- read_excel("Historical Data Submissions/Tuolomne/Tuolumne Pretrial Assessment Information.xls", sheet = 1)

court_charges <- read_excel("Historical Data Submissions/Tuolomne/Tuolumne Pretrial Assessment Information.xls", sheet = 2)

court_sentence <- read_excel("Historical Data Submissions/Tuolomne/Tuolumne Pretrial Assessment Information.xls", sheet = 3)

court_hearing <- read_excel("Historical Data Submissions/Tuolomne/Tuolumne Pretrial Assessment Information.xls", sheet = 4)
court_hearing2 <- read_excel("Historical Data Submissions/Tuolomne/Tuolumne Pretrial Assessment Information.xls", sheet = 5)

court_hearing <- bind_rows(court_hearing, court_hearing2)
rm(court_hearing2)

court_lawyer <- read_excel("Historical Data Submissions/Tuolomne/Tuolumne Pretrial Assessment Information.xls", sheet = 6)

court_demo <- read_excel("Historical Data Submissions/Tuolomne/Tuolumne Pretrial Assessment Information.xls", sheet = 7)

court_demo2 <- read_excel("Historical Data Submissions/Tuolomne/Tuolumne Pretrial Assessment Information.xls", sheet = 8)
```

Probation (assessment)--Confusing Data. Figure out later. 
```{r}
# prob_df <- lapply(2018:2019, function(i){
#   lapply(getSheetNames(paste0("Historical Data Submissions/Tuolomne/Tuolumne County Probation Pre-Trial Data ", i, ".xlsx")),
#          function(j){
#     df <- read_excel(paste0("Historical Data Submissions/Tuolomne/Tuolumne County Probation Pre-Trial Data ", i, ".xlsx"),
#                      skip = 2, sheet = j, col_types = "text")
#     df$risk_score <- j
#     return(df)
# }) %>% bind_rows() 
# }) %>% bind_rows()
```


# Ventura

Jail Data
```{r}
book_df <- read_excel("Historical Data Submissions/Ventura/jcc_ptm_vcsh_2015_2019.xlsx")

names(book_df) <- c("cii", "name", "dob", "arrest_date", "book_num", "book_date", "book_type", "case_id", "charge", "charge_level", "release_date", "release_type", "cii_2", "fbi", "local_id", "dln", "name-2", "dob_2", "sex", "race", "bail_amt", "conviction_date", "conviction_charge", "employee_status")
```

Court Data
```{r}
court_df <- read_excel("Historical Data Submissions/Ventura/jcc_ptm_vcct_2015_2019.xlsx")

names(court_df) <- c("case_id", "other_id", "hearing_fta_flag", "fta_date", "fta_warrant_flag", "fta_warrant_date", "disposition", "disposition_date", "disposition_final_date", "sentence_type", "sentence_date", "cii", "fbi", "local_id", "dln", "name", "dob", "sex", "race", "filing_date", "case_status", "case_status_date", "charge", "charge_level", "charge_description", "hearing_type", "hearing_date", "plea_type", "plea_date", "sentence_loc", "term", "ra_date")
```

Probation (assessment)--Confusing Data. Figure out later. 
```{r}
prob_df <- read_excel("Historical Data Submissions/Ventura/Pretrial Supervision - VCPA.xlsx")

names(prob_df) <- c("person_id", "case_id", "name", "dob", "sex", "race", "cii", "fbi", "dln", "date", "dv", "pretrial_recommendation", "pretrial_screening_flag", "pat_flag", "pretrial_decision", "success_date", "fta_date", "new_arrest_date", "offense_type", "charge_level", "pretrial_violation_date", "pretrial_outcome", "outcome_type", "pretrial_time_spent")
```

Code Book
```{r eval=FALSE, include=FALSE}
rm(original_field)

original_df <- bind_rows(original_df)

Sacramento_df <- lapply(ls()[!grepl("original", ls())], function(i){
  df <- get(i)
  
  if(sum(grepl("date", names(df))) > 0){
  df2 <- df %>%
  select(contains("date"), -contains("time")) %>%
  gather("modified_field", "value") %>%
  group_by(modified_field) %>%
  summarise_all(funs(min = as.character(min(., na.rm = T)), mean = as.character(mean(., na.rm = T)), max = as.character(max(., na.rm = T))))
  }else{
    df2 <- tibble(modified_field = NA_character_, min = NA_character_, mean = NA_character_, max = NA_character_)
  }
  
  df <- df %>%
    mutate_if(~length(unique(.)) > 50|is.Date(.)|is.POSIXct(.), ~(. = "not_factor")) %>%    
    mutate_all(~if_else(is.na(.), "na_missing", as.character(.))) %>%
    gather(modified_field, factor_value) %>%
    count(modified_field, factor_value) %>%
    mutate(table_name = i, county = "Sacramento") %>%
    mutate(factor_flag = if_else(factor_value == "not_factor", 0, 1)) %>%
    group_by(table_name, modified_field) %>%
    mutate(table_count = sum(n)) %>%
    ungroup() %>%
    rename("factor_count" = "n") %>%
    mutate(factor_count = if_else(factor_value == "not_factor", NA_integer_, factor_count),
           factor_percent = round(factor_count/table_count*100, 1)) %>%
    arrange(desc(factor_flag), modified_field, desc(factor_count))
  
  df <- left_join(df, df2, by = "modified_field")
    }) %>% 
  bind_rows() %>%
  left_join(original_df) %>%
   select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_count,
           factor_percent, table_count, min, mean, max) 

write.xlsx(Sacramento_df, file = "Code Books/Sacramento Code Book.xlsx")
```


# Yuba

Jail Data
```{r}
original_df <- list()

#Jail Data
book_df <- fread("Historical Data Submissions/Yuba/JailExtract.csv")
book_df2 <- fread("Historical Data Submissions/Yuba/JailExtractQ2.csv")

original_field <- names(book_df)
names(book_df2) <- names(book_df)

book_df <- bind_rows(book_df, book_df2)

rm(book_df2)

original_field <- names(book_df)


names(book_df) <- c("cii", "fbi", "last_name", "first_name", "middle_name", "dob", "arrest_date_time", "book_num", "book_date_time", "court_case_id", "arrest_charge_code_original", "arrest_charge_original", "arrest_charge_level_original", "release_date", "release_type_original", "local_id", "cdl_id", "cdl_state", "sex_original", "race_original", "nationality", "bail_amt", "no_bail", "cash_bail", "bail_reduction", "employment", "status")


#original_df[[1]] <- tibble(table_name = "book_df", original_field = original_field, modified_field = names(book_df))



# cii(?) 8 digits sometimes with leading "A", sometimes "A-"
# release_type not a factor -- text field including info like first scheduled appearance
# not as many no release date folks as expected

#Time Cleaning 
book_df <- book_df %>%
  mutate_at(vars(contains("time")), mdy_hm) %>%
  mutate_at(vars(dob, release_date), mdy) %>%
  mutate(book_date = as_date(book_date_time),
         arrest_date = as_date(arrest_date_time)) 
# only release dates match expected minimum of Jan 1 2015 (thru Jun 30 2019)
# bookings through Nov 25 2019 (earliest is Jun 25 1999)
# at least one DOB in 2006 (earliest 1935)
  
#Charge Adding
book_df <- book_df %>%
  mutate(attempt = if_else(grepl("664", arrest_charge_original), 1, 0)) %>%
  # separate_rows(arrest_charge_original, sep = "\\\\|\\-|\\/") %>%
  mutate(arrest_charge_level = str_extract(trimws(arrest_charge_level_original), "^."),
         arrest_charge_level = if_else(!arrest_charge_level %in% c("F", "M", "I"), "Other", arrest_charge_level),
         arrest_charge_code = if_else(!arrest_charge_code_original %in% c("PC", "VC", "HS", "BP", "WI", "US"), "Other",
         arrest_charge_code_original),
         arrest_charge = gsub("664/", "", arrest_charge_original),
         arrest_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}|/.*|OUT.*","", arrest_charge)),
         #Changing all 1320.5 FTAs to felonies in accordance with statute. 
         arrest_charge_level = if_else(arrest_charge == "13205", "F", arrest_charge_level))%>%
      unite(join_var, arrest_charge_level, arrest_charge_code, arrest_charge, remove = F)


#F_PC_3454 this is a flash incar
#F_PC_1203 this is a grant of probation?
#M_PC_12032A this is a probation violation

#Flags
book_df <- book_df %>%
  mutate(hold = if_else(arrest_charge_code_original == "HOA|OUT", 1, 0))


  
# Code for Charge Hierarchy
load("Complete Charge Code Hierarchy.RData")

book_df <- left_join(book_df, charge_hier, by = "join_var")

#above not working


# Factors

# No book_type

book_df <- book_df %>%
  mutate(sex = case_when(sex_original %in% c("M") ~ "Male",
                         sex_original %in% c("F") ~ "Female",
                         T ~ "Other_Unknown"),
         race = case_when(race_original %in% c("B") ~ "Black",
                          race_original %in% c("H") ~ "Hispanic",
                          race_original %in% c("W") ~ "White",
                          T ~ "Other_Unknown"))

book_df <- book_df %>%
  filter(!(release_type_original %in% c("JUVENILE BOOKING ONLY",
                                        "TRANSPORTED TO JUVENILE HALL",
                                        "JUVENILE BOOKING",
                                        "TRANS TO JUVENILE HALL",
                                        "RELEASED TO JUVENILE HALL",
                                        "RELEASE TO JUVENILE HALL",
                                        "TO JUVENILE HALL",
                                        "JUV BOOKING"))) %>%
  mutate(release_type = case_when(grepl("^(CT |CRT |COURT |CT\\.?[ /]?|RELEASED (- )?)?O(\\.|/)?R\\.?[ '/:\\|(TO APPEAR)]|O\\.?R\\.?( CT ?)?$|^(PROMISE )?(TO )?APPEAR",
                                        release_type_original) ~ "OR",
                                  release_type_original %in% c("BOOK AND RELEASE") ~ "Cite_Release",
                                  grepl("B/?B|(BAIL(ED)?([ /]?BONDS?)?|BOND) ?(OUT|POST(ED)?|TO APP[.(EAR)]?)?", 
                                        release_type_original) ~ "Bail_Bond",
                                  # ~ "Pretrial_Sup",
                                  release_type_original %in% c("CASE DISMISSED",
                                                               "COMPLAINT DENIED",
                                                               "COMPLAINT DENIED PER DA",
                                                               "COMPLAINT DENIED BY DA",
                                                               "WARRANT RECALLED")  ~ "Dismissed_Dropped",
                                  grepl("(RELEASED )?TIMED? ?SERE?VER?D?|T/S", release_type_original) ~ "Time_Served",
                                  release_type_original %in% c("PER COURTS ORDER") ~ "Court_Order",
                                  grepl("(RELEASED? TO|PICK(ED)? UP BY|P/U BY|TRANSPORTED TO|RETURNED TO) (YCPD|YUBA CITY( PD)?|(SAC|SUTTER|PLACER|BUTTE|NEVADA|COLUSA) CO(UNTY)?|PAROLE|RCCC)|HO?LD (REMOVED|DROP(PED)?)", 
                                        release_type_original) ~ "Hold_Release",
                                  grepl("INTOX|DETOX|SOBERING|849|DETAINER REMOVED|647", release_type_original) ~ "Detain_Only",
                                  grepl("ICE|G4-?[S3]|RELEASED? TO INS| I C E", release_type_original) ~ "Fed",
                                  # ~ "Sent_Cap",
                                  # ~ "Unsent_Cap",
                                  # ~ "Unspec_Cap",
                                  # ~ "Administrative",
                                  # ~ "OR_Conditions",
                                  grepl("PRISON|CDCR|DVI|TO S/P", release_type_original) ~ "Prison",
                                  release_type_original %in% c("NOT ARRAIGNED IN TIME",
                                                               "NOT ARRAINED IN TIME",
                                                               "NOT ARRAIGNED",
                                                               "DID NOT GO TO CT IN TIME",
                                                               "DID NOT GO TO CT ON TIME",
                                                               "DID NOT GO TO COURT ON TIME",
                                                               "RELEASED TO PROGRAM",
                                                               "RELEASE TO PROGRAM",
                                                               "RE-BOOKED ON YCPD WARRANT",
                                                               "BOOKED ON LOCAL CHARGES",
                                                               "RELEASED DUE TO EVACUATION") ~ "Other",
                                  grepl("^ *$", release_type_original) | release_type_original %in% c("") ~ "Unknown"))
  



# sort(table(gsub("[0-9]{1,2}[-/]?[0-9]{1,2}[-/]?[0-9]{2,4} *(@|AT|-)? *[0-9]{1,4} *(HOURS|HRS|AM|PM)? *", "",
#                 book_df$release_type_original[is.na(book_df$release_type)]),
#            useNA = "ifany"), decreasing = TRUE)
# 
# sort(gsub("[0-9]{1,2}[-/]?[0-9]{1,2}[-/]?[0-9]{2,4} *(@|AT|-)? *[0-9]{1,4} *(HOURS|HRS|AM|PM)? *", "",
#                 book_df$release_type_original[is.na(book_df$release_type)]))
# 
# table(book_df$release_type, useNA = "ifany")
# 
# book_df$release_type_original[gsub("[0-9]{1,2}[-/]?[0-9]{1,2}[-/]?[0-9]{2,4} *(@|AT|-)? *[0-9]{1,4} *(HOURS|HRS|AM|PM)? *", "",
#                 book_df$release_type_original) == "TIME SERVED"]
# 
# mean(!is.na(book_df$release_type))
# .91

# nrow(unique(book_df[c("cii", "book_date_time")]))

# length(which(book_df$cii == " "))
# 5218

# length(unique(book_df$book_num))
# 28903

# length(unique(book_df$local_id))
# 15224
# local id individual-level

# nrow(unique(book_df[c("book_num", "local_id")]))
# 28904

# unique(book_df$cii)[1:1000]

# nrow(unique(book_df[c("book_num", "book_date_time")]))
# 28904

# sort(table(book_df$book_num), decreasing = TRUE)

# book_df[duplicated(book_df$book_num)|duplicated(book_df$book_num, fromLast = TRUE),][order(book_df$book_num[duplicated(book_df$book_num)|duplicated(book_df$book_num, fromLast = TRUE)]),]


```

Jail Collapse
```{r}

book_df <- book_df %>%
  # mutate(time_first_release = release_date_time - book_date_time) %>%
  mutate(hierarchy = if_else(is.na(hierarchy), 1e6, as.numeric(hierarchy))) %>%
  group_by(book_num, book_date_time) %>%
  mutate(max_arrest_charge = arrest_charge[hierarchy == min(hierarchy)][1],
         # max_booktype = book_type[hierarchy == min(hierarchy)][1], # no book_type
         max_charge_description = master_charge_description[hierarchy == min(hierarchy)][1],
         max_hier = min(hierarchy)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, .))) %>%
  mutate_at(vars(contains("flag")), funs("count" = sum(.))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  group_by(book_num, book_date_time, court_case_id) %>%
  filter(hierarchy == min(hierarchy)) %>%
  ungroup() %>%
  distinct(book_num, book_date, court_case_id, .keep_all = T) 

# Diagnostics
book_df %>%
  distinct(book_num, book_date) %>%
  arrange(book_num) %>%
  group_by(book_num) %>%
  add_count() %>%
  filter(n>1)

# book_df[book_df$book_num == 232005, ]
# two individuals w/ same book_num, court_id
#
# book_df %>%
#   distinct(local_id, book_date) 
```


  Jail Diagnostics
```{r eval=FALSE, include=FALSE}
book_df %>%
  count(arrest_charge_level_original) %>%
  arrange(desc(n))

book_df %>%
  # filter(arrest_charge_level_original == "SA") %>%
  count(arrest_charge_code_original) %>%
  arrange(desc(n))

book_df %>%
  count(arrest_charge_original) %>%
  arrange(desc(n))

book_df %>%
  count(arrest_charge_level) %>%
  arrange(desc(n))

book_df %>%
  count(arrest_charge) %>%
  arrange(desc(n))

#No Ambiguity
book_df %>%
  count(arrest_charge, ) %>%
  group_by(arrest_charge) %>%
  add_count() %>%
  filter(n > 1) %>%
  arrange(desc(n))

#No combined charges
book_charge %>%
  filter(grepl("/", arrest_charge_original))

book_df %>%
  filter(grepl("OUT", arrest_charge_code_original)) %>%
  count(arrest_charge_original) %>%
  arrange(desc(n))

# Diagnostic Code for Charge Hierarchy
# 1 - 7,901/267,372 = 97% non-match rate
(1 - nrow(book_charge %>% filter(is.na(hierarchy)))/nrow(book_charge))*100

book_charge %>%
  filter(is.na(hierarchy)) %>%
  count(join_var) %>%
  arrange(desc(n))

book_df%>%
  filter(grepl("F_PC_1203", join_var))%>%
  group_by(join_var)%>%
  count()

charge_hier%>%
  filter(grepl("FTA", master_charge_description))
  
book_charge %>%
  filter(book_num %in% book_num[join_var == "M_PC_13205"]) %>%
  arrange(book_num) %>%
  add_count() %>%
  filter(n > 1)
```


Court Data
```{r}
setwd("G:/CrimJustice/PretrialAssessmentPilot")

# Court cases status
court_status <- lapply(c("Yuba/Yuba.xlsx", "Yuba SQL Results 1-30-2020.xlsx"),
                       function(x) {
                         read_excel(paste0("Historical Data Submissions/Yuba/",
                                           x),
                                    sheet = 1, na="NULL", col_types="text")
                       }) %>%
  bind_rows()

# original_field <- names(court_status)

names(court_status) <- c("court_docket_id", "court_case_id", "case_status_date", "case_status")

# original_df[[2]] <- tibble(table_name = "court_status", original_field = original_field, modified_field = names(court_status))

court_status <- court_status %>%
  mutate(case_status_date = convertToDate(case_status_date))

# Court charges
court_charge <- lapply(c("Yuba/Yuba.xlsx", "Yuba SQL Results 1-30-2020.xlsx"),
                       function(x) {
                         read_excel(paste0("Historical Data Submissions/Yuba/",
                                           x),
                                    sheet = 2, na="NULL", col_types="text")
                       }) %>%
  bind_rows()

# original_field <- names(court_charge)

names(court_charge) <- c("court_docket_id", "court_case_id", "court_charge_number", "court_charge_original", "court_charge_level_original", "court_charge_description", "plea_date", "plea_type_original", "disposition_date", "disposition_type_original", "final_date")

# court_charge_code contained w/in "court_charge_description_original"


# original_df[[3]] <- tibble(table_name = "court_charge", original_field = original_field, modified_field = names(court_charge))

court_charge <- court_charge %>%
  mutate_at(vars(plea_date, disposition_date, final_date), convertToDate) %>%
  mutate(attempt = if_else(grepl("664", court_charge_original), 1, 0)) %>%
  # separate_rows(court_charge_original, sep = "\\/") %>%
  mutate(court_charge_level = str_extract(trimws(court_charge_level_original), "^."),
         court_charge_level = if_else(!court_charge_level %in% c("F", "M", "I"), "Other", court_charge_level),
         court_charge_code = toupper(str_extract(court_charge_description, "^..")),
         court_charge_code = if_else(!court_charge_code %in% c("PC", "VC", "HS", "BP", "WI", "US"), "Other", court_charge_code),
         court_charge = gsub("664/", "", court_charge_original),
         court_charge = toupper(gsub("\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}|\\&.*|w/.*|\\-.*|\\/.*","", court_charge)))%>%
 unite(join_var, court_charge_level, court_charge_code, court_charge, remove = F)%>%
  
 # F_PC_29800A this is possesion of a firearm, but DOPH deosnt have it unless it also has a 1 or 2 after it, both have same charge heir
 # M_PC_12032A this is always charges as a misd in the county but DOJs misd charge omits the A
#PC148(a)(1)- M -Resist, Delay, or Obstruct any Officer the original court charge read in as 148(a)(11
#HS 11358 C is the obnly DOJ charge that is a misd, so I changed the original Yuba code
# M_HS_11701199999999999 this is what is in Yuba code, but charge desc says Other_PC_117012 special enhancement
 mutate(join_var=case_when(join_var=="F_PC_29800A"~"F_PC_29800A1",
                           join_var=="M_PC_12032A"~"M_PC_12032",
                           join_var=="M_PC_148A11"~"M_PC_148A1",
                           join_var=="F_PC_12032B"~"F_Other_12032",
                           join_var=="M_HS_11358"~"M_HS_11358C",
                            join_var=="M_HS_11358A"~"M_HS_11358C",
                           join_var=="Other_PC_11701199999999999"~"Other_PC_117012",
                           join_var=="Other_PC_117012B"~"Other_PC_117012",
                           TRUE~join_var)) 
                 
# Factors

court_charge <- court_charge %>%
  filter(!(disposition_type_original %in% c("Admitted Juvenile",
                                            "Juvenile Wardship"))) %>%
  mutate(disposition_type = case_when(disposition_type_original %in% c("DOJ - Dism: Motion of the People",
                                                                       "DOJ - Dism: Plea Negotiation",
                                                                       "DOJ - Dismissal",
                                                                       "Proof of Correction Provided Dismissed",
                                                                       "DOJ - Stricken",
                                                                       "DOJ - Dismissal - Harvey Waiver",
                                                                       "DOJ - Dism: Motion of People",
                                                                       "Dismissal",
                                                                       "DOJ - Dismisal - Other Dismissal",
                                                                       "DOJ - Dism pursuant to 1203.4PC",
                                                                       "Stricken",
                                                                       "DOJ -Dismissal - Other dismissal",
                                                                       "DOJ - Dism/1381/1381.5/1382 PC",
                                                                       "DOJ -Dism: PC1185/1187/1188-Def Discharged") ~ "Dismissed",
                                      disposition_type_original %in% c("DOJ - Charges not filed by DA's office") ~ "Dropped",
                                      disposition_type_original %in% c("DOJ - Sentenced-Plea of guilty/nolo",
                                                                       "DOJ - No Contest Plea",
                                                                       "Sentenced-Plea of guilty/nolo",
                                                                       "No Contest Plea") ~ "Nolo_Contendere",
                                      disposition_type_original %in% c("DOJ - Found in VOP New Sentence Imposed",
                                                                       "Guilty Plea",
                                                                       "Found Guilty Court Trial",
                                                                       "DOJ - Admitted - New Sentence Imposed",
                                                                       "DOJ - Admitted - No New Sentence Imposed",
                                                                       "Admitted Enhancement/Allegations",
                                                                       "DOJ - Found in VOP No New Sentence Imposed",
                                                                       "DOJ - Found True",
                                                                       "Sentenced/court finding of guilty",
                                                                       "Trial by declaration - Court finding of guilt",
                                                                       "Found Guilty",
                                                                       "DOJ - Found Guilty - Jury",
                                                                       "Found True",
                                                                       "Allegation Proven",
                                                                       "DOJ - Convicted") ~ "Guilty",
                                      disposition_type_original %in% c("DOJ - Found Not Guilty",
                                                                       "DOJ - Found Not Guilty - Jury",
                                                                       "Found Not True",
                                                                       "DOJ - Found Not Guilty: Court") ~ "Not_Guilty",
                                      disposition_type_original %in% c("AF: Traffic School Conviction",
                                                                       "Bail Forfeiture",
                                                                       "VOP Set Aside",
                                                                       "DOJ - Deferred Entry of Judgment",
                                                                       "DOJ - Diversion",
                                                                       "DOJ - Dismissal - After drug court",
                                                                       "DOJ - Dismissal - After Diversion",
                                                                       "Change of venue - transfer",
                                                                       "Diversion Terminated",
                                                                       "DOJ - Dism: After Deferred Entry of Judgment",
                                                                       "DOJ - Reduced to Misdemeanor 17bPC",
                                                                       "DOJ - Reduced to misdemeanor 17b/Dism pursuant to 1203.4PC",
                                                                       "Reduced to Infraction",
                                                                       "Sentence Modified",
                                                                       "Prop 47 Reduced To Misdemeanor") | 
                                        is.na(disposition_type_original) ~ "Other"),
         plea_type = case_when(plea_type_original %in% c("No Contest",
                                                         "Nolo Contendere") ~ "Nolo_Contendere",
                               plea_type_original %in% c("Guilty",
                                                         "Admit") ~ "Guilty",
                               plea_type_original %in% c("Not Guilty",
                                                         "Deny") ~ "Not_Guilty",
                               plea_type_original %in% c("Case Disposed",
                                                         "Plea Set Aside",
                                                         "Unknown",
                                                         "VOP Monies ordered") ~ "Other"))

# sort(table(court_charge$plea_type_original[is.na(court_charge$plea_type)], useNA = "ifany"), decreasing = TRUE)
# 
# mean(!is.na(court_charge$plea_type))

# table(court_charge$plea_type, useNA = "ifany")


# Court hearings
court_hearings <- lapply(c("Yuba/Yuba.xlsx", "Yuba SQL Results 1-30-2020.xlsx"),
                       function(x) {
                         read_excel(paste0("Historical Data Submissions/Yuba/",
                                           x),
                                    sheet = 3, na="NULL", col_types="text")
                       }) %>%
  bind_rows()

# original_field <- names(court_hearings)

names(court_hearings) <- c("court_docket_id", "court_case_id", "hearing_date", "hearing_type_original", "hearing_outcome")

# original_df[[4]] <- tibble(table_name = "court_hearings", original_field = original_field, modified_field = names(court_hearings))

court_hearings <- court_hearings %>%
  mutate_at(vars(hearing_date),convertToDate)

court_hearings <- court_hearings %>%
  filter(!(hearing_type_original %in% c("JV Boot Camp Review Hearing",
                                        "JV Pretrial Hearing",
                                        "JV DEOJ Review Hearing",
                                        "JV Dispositional Hearing",
                                        "JV Detention Hearing",
                                        "JV Return on Warrant Hearing",
                                        "JV Transfer In Hearing",
                                        "JV Detention Hearing 602W&I Subsequent Petition",
                                        "JV W&I725(a) Review Hearing",
                                        "JV 15-Day Placement Review",
                                        "JV-DEOJ Non-Compliance Hearing",
                                        "JV Transfer In Hearing Existing 602 W&I Case",
                                        "JV Transfer Hearing",
                                        "JV Jurisdictional Hearing",
                                        "JV-DEOJ Non-Compliance Hearing",
                                        "JV Detention Hearing on W&I 777  Petition"))) %>%
  mutate(hearing_type = case_when(hearing_type_original %in% c("Arraignment in Custody",
                                                               "Arraignment",
                                                               "VOP Arraignment",
                                                               "Arraignment on Notice to Appear",
                                                               "Arraignment on Citation",
                                                               "Parole - Arraignment",
                                                               "Arraignment on Information",
                                                               "PRCS - Arraignment",
                                                               "Continued Arraignment",
                                                               "Mandatory Supervision - Arraignment",
                                                               "Community Court - Arraignment",
                                                               "Arraignment on Violation of Probation",
                                                               "SARB Arraignment Hearing",
                                                               "Arraignment on Warrant",
                                                               "Arraignment Notice of Hearing (Criminal)",
                                                               "Traffic Arraignment") ~ "Arraignment",
                                  hearing_type_original %in% c("Sentencing",
                                                               "Sentencing - Probation Report",
                                                               "VOP Sentencing",
                                                               "Parole - Sentencing",
                                                               "PRCS - Sentencing",
                                                               "Mandatory Supervision - Sentencing",
                                                               "Sentencing - Firearms Relinquishment Report") ~ "Sentencing",
                                  hearing_type_original %in% c("PreTrial Conference",
                                                               "Pre Hearing Conference",
                                                               "Review Hearing",
                                                               "VOP Pre Hearing Conference",
                                                               "Case Pull w/Criminal",
                                                               "Walk-In Traffic",
                                                               "Walk-In Criminal",
                                                               "Stay on Warrant",
                                                               "Hearing",
                                                               "Drug Court Review",
                                                               "Misdo Pretrial Setting",
                                                               "Court Trial",
                                                               "Motion to Recall Warrant",
                                                               "SARB Hearing",
                                                               "Parole - PHC",
                                                               "Preliminary Hearing",
                                                               "Discovery Compliance Hearing",
                                                               "PRCS - Pretrial",
                                                               "Trial Readiness Conference",
                                                               "Trial Setting Conference",
                                                               "Motion Hearing",
                                                               "J&S Setting",
                                                               "Detention Hearing",
                                                               "Trial by Declaration",
                                                               "Restitution Hearing",
                                                               "PHC/PX Setting",
                                                               "Disposition Hearing",
                                                               "Firearms Relinquishment Hearing",
                                                               "Drug Diversion Eligibility Hearing",
                                                               "Entry of Plea",
                                                               "Further Proceedings",
                                                               "Motion to Transfer per 1203.9PC",
                                                               "VOP PreTrial Conference",
                                                               "Motion - 1538.5 PC (Motion to Suppress)",
                                                               "Jury Trial - Ongoing",
                                                               "Community Court - Review Hearing",
                                                               "Extradition Hearing",
                                                               "VOP Court Trial",
                                                               "Bail Bond Motion",
                                                               "Jurisdiction Hearing",
                                                               "Bail Hearing",
                                                               "Marsden Hearing",
                                                               "Prop 36 Review Hearing",
                                                               "Transfer-Out Hearing",
                                                               "Parole - Court Trial",
                                                               "Mandatory Supervision - PHC",
                                                               "Motion to Continue",
                                                               "Motions in Limine Hearing",
                                                               "Parole Revocation Hearing",
                                                               "Violation of PRCS PreTrial Conference",
                                                               "Jury Trial",
                                                               "Diversion Review",
                                                               "SARB Review Hearing",
                                                               "Prop 36 Initial Hearing",
                                                               "PRCS - Hearing",
                                                               "Violation of Cruz Waiver Hearing",
                                                               "Transfer-In Hearing",
                                                               "PRCS - Court Trial",
                                                               "Settlement Conference",
                                                               "Motion - 995 PC (Motion to Dismiss Information)",
                                                               "Motion to Amend Complaint",
                                                               "Modification Hearing",
                                                               "Pitchess Motion",
                                                               "MH Competency Hearing",
                                                               "Parole - Probable Cause Hearing",
                                                               "Informal Review - 654.2 W&I",
                                                               "Motion to Change / Set Aside / Withdraw Plea",
                                                               "VOP Hearing",
                                                               "Parole - Hearing",
                                                               "241.1 W&I Hearing",
                                                               "OSC Hearing",
                                                               "MH Court Trial PC 1369",
                                                               "Trial de Novo",
                                                               "Walk-In Court",
                                                               "Motion - 1203.4 PC",
                                                               "Demurrer Hearing",
                                                               "Mental Competence Hearing",
                                                               "Motion for Discovery",
                                                               "Mandatory Supervision - Hearing",
                                                               "Petition for Disclosure Hearing",
                                                               "Order to Show Cause re Contempt",
                                                               "Initial Hearing") ~ "Other"))

# sort(table(court_hearings$hearing_type_original[is.na(court_hearings$hearing_type)], useNA = "ifany"), decreasing = TRUE)
# 
# mean(!is.na(court_hearings$hearing_type))
# >99.9%

# table(court_hearings$hearing_type, useNA = "ifany")



# Court fta
court_fta <- lapply(c("Yuba/Yuba.xlsx", "Yuba SQL Results 1-30-2020.xlsx"),
                       function(x) {
                         read_excel(paste0("Historical Data Submissions/Yuba/",
                                           x),
                                    sheet = 4, na="NULL", col_types="text")
                       }) %>%
  bind_rows()

# original_field <- names(court_fta)

names(court_fta) <- c("court_docket_id", "court_case_id", "fta_hearing", "fta_date", "fta_warrant", "fta_warrant_date", "fta_warrant_type")

# original_df[[5]] <- tibble(table_name = "court_fta", original_field = original_field, modified_field = names(court_fta))

court_fta <- court_fta %>%
  mutate_at(vars(fta_date, fta_warrant_date),convertToDate)


# Court sentence
court_sentence <- lapply(c("Yuba/Yuba.xlsx", "Yuba SQL Results 1-30-2020.xlsx"),
                       function(x) {
                         read_excel(paste0("Historical Data Submissions/Yuba/",
                                           x),
                                    sheet = 5, na="NULL", col_types="text")
                       }) %>%
  bind_rows()

# original_field <- names(court_sentence)

names(court_sentence) <- c("court_docket_id", "court_case_id", "sentence_date", "sentence_type_incarceration", "sentence_location", "sentence_term", "sentence_term_value")

# original_df[[6]] <- tibble(table_name = "court_sentence", original_field = original_field, modified_field = names(court_sentence))

court_sentence <- court_sentence %>%
  mutate_at(vars(sentence_date), convertToDate)

# court_sentence <- court_sentence %>%
#   mutate(sentence_type = case_when(sentence_type_original %in% c() ~ "Prison",
#                                    sentence_type_original %in% c() ~ "Jail",
#                                    sentence_type_original %in% c() ~ "Probation",
#                                    sentence_type_original %in% c() ~ "Other"))

# sort(table(court_sentence$sentence_type_original, useNA = "ifany"), decreasing = TRUE)
# [is.na(court_sentence$sentence_type)]
# mean(!is.na(court_sentence$sentence_type))
#
# table(court_sentence$sentence_type, useNA = "ifany")

# different sentence types appear in different tables, we need to combine these
# this table (court_sentencing) has sentences to jail and prison
# court_sent_prob has probation sentences
# court_fine has fine sentences
# court_sent_dl_cond has driver's license conditions


# Court sentence dl conditions
court_sent_dl_cond <- lapply(c("Yuba/Yuba.xlsx", "Yuba SQL Results 1-30-2020.xlsx"),
                       function(x) {
                         read_excel(paste0("Historical Data Submissions/Yuba/",
                                           x),
                                    sheet = 6, na="NULL", col_types="text")
                       }) %>%
  bind_rows()

# original_field <- names(court_sent_dl_cond)

names(court_sent_dl_cond) <- c("court_case_id", "court_docket_id", "sentence_date", "config_desc", "screenbuilderdataentrynumber", "dl_cond_desc", "dl_cond_desc2", "dl_cond_fieldname", "dl_cond_fieldvalue", "dl_cond_fieldname2", "dl_cond_fieldvalue2")

# original_df[[7]] <- tibble(table_name = "court_sent_dl_cond", original_field = original_field, modified_field = names(court_sent_dl_cond))

court_sent_dl_cond <- court_sent_dl_cond %>%
  mutate_at(vars(sentence_date), convertToDate)

# Court fine
court_fine <- lapply(c("Yuba/Yuba.xlsx", "Yuba SQL Results 1-30-2020.xlsx"),
                       function(x) {
                         read_excel(paste0("Historical Data Submissions/Yuba/",
                                           x),
                                    sheet = 7, na="NULL", col_types="text")
                       }) %>%
  bind_rows()          

# original_field <- names(court_fine)

names(court_fine) <- c("court_docket_id", "fine")

# original_df[[8]] <- tibble(table_name = "court_fine", original_field = original_field, modified_field = names(court_fine))

# Court sentence probation
court_sent_prob <- lapply(c("Yuba/Yuba.xlsx", "Yuba SQL Results 1-30-2020.xlsx"),
                       function(x) {
                         read_excel(paste0("Historical Data Submissions/Yuba/",
                                           x),
                                    sheet = 8, na="NULL", col_types="text")
                       }) %>%
  bind_rows()

# original_field <- names(court_sent_prob)

names(court_sent_prob) <- c("court_docket_id", "court_case_id","sentence_date", "sent_prob_type", "sent_prob_location", "sentence_term_value", "sentence_term")

# original_df[[9]] <- tibble(table_name = "court_sent_prob", original_field = original_field, modified_field = names(court_sent_prob))

court_sent_prob <- court_sent_prob %>%
  mutate_at(vars(sentence_date), convertToDate)

# Court technical elements
court_tech <- lapply(c("Yuba/Yuba.xlsx", "Yuba SQL Results 1-30-2020.xlsx"),
                       function(x) {
                         read_excel(paste0("Historical Data Submissions/Yuba/",
                                           x),
                                    sheet = 9, na="NULL", col_types="text")
                       }) %>%
  bind_rows()          

# original_field <- names(court_tech)

names(court_tech) <- c("court_docket_id", "court_case_id", "last_name", "first_name", "middle_name", "file_date", "dob", "cii", "cdl_id", "fbi", "sex_original", "race_original", "cdl_state", "risk_report_date")

# original_df[[10]] <- tibble(table_name = "court_tech", original_field = original_field, modified_field = names(court_tech))

court_tech<- court_tech %>%
  mutate_at(vars(file_date, dob, risk_report_date), convertToDate)

court_tech <- court_tech %>%
  mutate(sex = case_when(sex_original %in% c("Male") ~ "Male",
                         sex_original %in% c("Female") ~ "Female",
                         is.na(sex_original) ~ "Other_Unknown"),
         race = case_when(race_original %in% c("Hispanic") ~ "Hispanic",
                          race_original %in% c("Black") ~ "Black",
                          race_original %in% c("White") ~ "White",
                          race_original %in% c("Other Asian",
                                               "Other",
                                               "Asian",
                                               "Indian",
                                               "Asian Indian",
                                               "Cambodian",
                                               "Chinese",
                                               "Hawaiian",
                                               "Filipino",
                                               "Pacific Islander",
                                               "Unavailable",
                                               "Laotian",
                                               "Native Hawaiian or Other Pacific Islander",
                                               "Vietnamese",
                                               "Multiracial") |
                            is.na(race_original) ~ "Other_Unknown"))
         






# sort(table(court_tech$race_original, useNA = "ifany"), decreasing = TRUE)
# [is.na(court_tech$race)]
# mean(!is.na(court_tech$race))
#
# table(court_tech$race, useNA = "ifany")



# Code for Charge Hierarchy
load("Complete Charge Code Hierarchy.RData")

court_charge <- left_join(court_charge, charge_hier, by = "join_var")  

court_charge <- court_charge %>%
  mutate(
    enhancement = if_else(
      join_var %in% c(
        "Other_VC_14601B2",
        "Other_VC_146011B2",
        "Other_VC_146012D2",
        "Other_VC_146015D2",
        "Other_VC_23578",
        "Other_VC_231035",
        "Other_VC_23540",
        "Other_PC_117012C1",
        "Other_PC_120225A",
        "Other_PC_1170H3",
        "Other_PC_1170H",
        "Other_PC_120227A",
        "Other_PC_117012",
        "Other_PC_120221",
        "Other_PC_667A1",
        "Other_PC_667D",
        "Other_PC_667A1",
        "Other_PC_12022A1",
        "Other_PC_12022B1",
        "Other_PC_1203E4",
        "Other_VC_23577",
        "Other_Other_120225A",
        "Other_PC_1202253C",
        "Other_PC_290018BZ",
        "Other_PC_290018BZ",
        "Other_PC_1202253B",
        "Other_PC_6676D",
        "Other_PC_1202253D",
        "Other_PC_1203K",
        "Other_HS_113702A",
        "Other_PC_120307A11",
        "Other_HS_11370A",
        "Other_PC_6665",
        "Other_PC_6675B",
        "Other_PC_6675C21",
        "Other_Other_18622B1",
        "M_VC_23578",
        "M_VC_231035",
        "F_PC_117012C1",
        "F_PC_120225A",
        "F_PC_1170H3",
        "F_PC_1170H",
        "F_PC_120227A",
        "F_PC_120221",
        "F_PC_667A1",
        "F_PC_667A1",
        "F_PC_12022A1",
        "F_PC_12022B1",
        "F_VC_23577",
        "F_PC_1202253C",
        "F_PC_290018BZ",
        "F_PC_290018BZ",
        "F_PC_1202253B",
        "F_PC_6676D",
        "F_PC_1202253D",
        "F_PC_1203K",
        "F_HS_113702A",
        "F_PC_120307A11",
        "F_HS_11370A",
        "F_PC_6675C21",
        "M_VC_231035A" ), 1,0),
    hierarchy = if_else(is.na(hierarchy) & enhancement == 1, 1e6, hierarchy),
    enhancement = if_else(court_charge_level_original %in% c("E"), 1, 0),
    hierarchy = if_else(is.na(hierarchy) & enhancement == 1, 1e6,   hierarchy)) %>%
  mutate(hierarchy = if_else(court_charge_level == "I" & is.na(hierarchy), 1e6, hierarchy))



# Diagnostic Code for Charge Hierarchy
# 1 - 7,901/267,372 = 97% non-match rate
(1 - nrow(court_charge %>% filter(is.na(hierarchy)))/nrow(court_charge))*100

court_charge %>%
  filter(is.na(hierarchy)) %>%
  count(join_var) %>%
  arrange(desc(n))



court_charge%>%
  filter(grepl("M_HS_11358A", join_var))%>%
  group_by()%>%
  count()         


charge_hier%>%
  filter(grepl("120227", charge))
  
# Checking to see if there are enhancements, priors, or special allegations in court charge data

grep("charge", names(court_charge), value = TRUE)

table(court_charge$court_charge_level_original)

court_charge <- court_charge %>%
  mutate(court_qualifier_flag = if_else(court_charge_level_original %in% c("AL", "E"), 1, 0))

# write.csv(court_charge[court_charge$court_qualifier_flag == 1, c("court_charge_code", "court_charge", "court_charge_original",
#                                                                  "court_charge_level", "court_charge_level_original",
#                                                                  "court_charge_description")],
#           file = "G:/CrimJustice/PretrialAssessmentPilot/Charge Definitions and Hierarchy/Yuba_Qualifier_Flags_Court_charges.csv")
# 
# table(court_charge$court_qualifier_flag, useNA = "ifany")


```

 Court Diagnostics
```{r eval=FALSE, include=FALSE}
court_charge %>%
  count(court_charge_level_original) %>%
  arrange(desc(n))

court_charge %>%
  # filter(court_charge_level_original == "SA") %>%
  count(court_charge_code_original) %>%
  arrange(desc(n))

court_charge %>%
  count(court_charge_original) %>%
  arrange(desc(n))

court_charge %>%
  count(court_charge_level)

court_charge %>%
  count(court_charge) %>%
  arrange(desc(n))

#No Ambiguity
court_charge %>%
  count(court_charge, court_charge_original) %>%
  group_by(court_charge) %>%
  add_count() %>%
  filter(n > 1) %>%
  arrange(desc(n))

#No combined charges
court_charge %>%
  filter(grepl("664", court_charge_original))
```

Probation Data
```{r}


```

Codebook
```{r}
#Code Book
rm(original_field)

original_df <- bind_rows(original_df)

Yuba_df <- lapply(ls()[!grepl("original", ls())], function(i){
  df <- get(i)
  
  if(sum(grepl("date", names(df))) > 0){
  df2 <- df %>%
  select(contains("date"), -contains("time")) %>%
  gather("modified_field", "value") %>%
  group_by(modified_field) %>%
  summarise_all(funs(min = as.character(min(., na.rm = T)), mean = as.character(mean(., na.rm = T)), max = as.character(max(., na.rm = T))))
  }else{
    df2 <- tibble(modified_field = NA_character_, min = NA_character_, mean = NA_character_, max = NA_character_)
  }
  
  df <- df %>%
    mutate_if(~length(unique(.)) > 50|is.Date(.)|is.POSIXct(.), ~(. = "not_factor")) %>%    
    mutate_all(~if_else(is.na(.), "na_missing", as.character(.))) %>%
    gather(modified_field, factor_value) %>%
    count(modified_field, factor_value) %>%
    mutate(table_name = i, county = "Yuba") %>%
    mutate(factor_flag = if_else(factor_value == "not_factor", 0, 1)) %>%
    group_by(table_name, modified_field) %>%
    mutate(table_count = sum(n)) %>%
    ungroup() %>%
    rename("factor_count" = "n") %>%
    mutate(factor_count = if_else(factor_value == "not_factor", NA_integer_, factor_count),
           factor_percent = round(factor_count/table_count*100, 1)) %>%
    arrange(desc(factor_flag), modified_field, desc(factor_count))
  
  df <- left_join(df, df2, by = "modified_field")
    }) %>% 
  bind_rows() %>%
  left_join(original_df) %>%
   select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_count,
           factor_percent, table_count, min, mean, max) 

write.xlsx(Yuba_df, file = "Code Books/Yuba Code Book.xlsx")

```

DOJ CII/Linking Extraction
```{r}
# Grab Tables with CII
df <- sapply(ls()[which(sapply(ls(), function(i){
  sum(names(get(i)) %in% "cii")
}) == 1)], get)

# Pull CII and other identifiers
doj_book <- df[[1]] %>%
  select(cii, fbi, first_name, middle_name, last_name, dob, cdl_id, cdl_state, race_original, sex_original, local_id) %>%
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) 

doj_court <- df[[2]] %>%
  select(cii, fbi, cdl_id, cdl_state, dob, race_original, sex_original, first_name, middle_name, last_name) %>%
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) 


# Examine missing ciis and duplicates on cii. 
# doj_book %>% #Off by about 55,000
#   distinct()
# 
# doj_book %>% 
#   distinct(cii)
# 
# doj_book %>% 
#   distinct() %>%
#   add_count(cii) %>%
#   filter(n > 1) %>%
#   arrange(desc(n)) %>% 
#   View()
# 
# doj_court %>% #Off by about 45,000
#   distinct()
# 
# doj_court %>% 
#   distinct(cii)
# 
# doj_court %>% 
#   distinct() %>%
#   add_count(cii) %>%
#   filter(n > 1) %>%
#   arrange(desc(n)) %>% 
#   View()
# 
# #In this case, it is clear that the local ID is not a true person identifier but rather an event identifier and so should be removed.
# 
# doj_book <- doj_book %>% select(-local_id)
# doj_court <- doj_court %>% select(-local_id)
# 
# doj_book %>% # Off by about 7,000
#   distinct()
# 
# doj_book %>% 
#   distinct(cii)
# 
# doj_book %>% 
#   distinct() %>%
#   add_count(cii) %>%
#   filter(n > 1) %>%
#   arrange(desc(n)) %>% 
#   View()
# 
# doj_court %>% #Off by about 9,000
#   distinct()
# 
# doj_court %>% 
#   distinct(cii)
# 
# doj_court %>% 
#   distinct() %>%
#   add_count(cii) %>%
#   filter(n > 1) %>%
#   arrange(desc(n)) %>% 
#   View()

#CIIs for DOJ
doj_cii <- bind_rows(doj_book %>% select(cii), doj_court %>% select(cii)) %>% distinct()

#Create an excel workbook with all data table. Make sure to include the cii table first. 
write.xlsx(list(doj_cii, doj_book, doj_court), file = "CIIs for DOJ/Yuba CIIs and Demographics for DOJ.xlsx", sheetName = c("ciis", "booking", "court"))
```

Factors Codebook
```{r}
factor_df <- lapply(ls()[!grepl("original|^df|hier", ls())], function(i){
  df <- get(i)
  if(sum(grepl("original", names(df))) == 0){
    return(NULL)
  }else{
    var_names <- names(df)[grepl("original", names(df))]
    var_names2 <- gsub("_original", "", var_names)
   
    df1 <- df %>%
     select(var_names) %>%
     gather(original_field, original_value)
   
    df2 <- df %>%
     select(var_names2) %>%
     gather(modified_field, modified_value)
   
   df <- bind_cols(df1, df2) %>%
     count(original_field, modified_field, original_value, modified_value) %>%
     arrange(modified_field, desc(n)) %>%
     group_by(modified_field) %>%
     mutate(row = row_number(),
            percent = round(n/sum(n)*100)) %>%
     ungroup() %>%
     filter(row <= 50) %>%
     select(-row) %>%
     rename("total" = n)
   }
  }) %>%
  bind_rows()

write.xlsx(factor_df, file = "G:/CrimJustice/PretrialAssessmentPilot/Code Books/Factor Code Book/Yuba Factor Code Book.xlsx", asTable = T, tableStyle = "TableStyleMedium1", colWidths = "auto")
```




