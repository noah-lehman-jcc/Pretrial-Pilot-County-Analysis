---
title: "County Data Loading"
author: "Sal Lempert"
date: "10/15/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

 
knitr::opts_knit$set(root.dir = "G:/CrimJustice/PretrialAssessmentPilot")
```

# Libraries
```{r}
library(data.table)
library(openxlsx)
library(readxl)
library(lubridate)
library(tidyverse)
library(XML)
library(xml2)
library(xmltools)
library(fuzzyjoin)

```


# Kings

Jail Data (Maybe all data?, no FTA information)
```{r}


# Jail Bookings Data Import --- Kings, 2015-01-01 to 2019-12-31
  ## book_df contains one row for each combination of book_num, arrest_charge_original, arrest_charge_count ,court_case_id, disposition_date, disposition_type_original. It had 377 duplicate lines which are removed. It contains information on the booking

###

# Jail Bookings
  ## book_df contains one row for each combination of book_num, arrest_charge_original, arrest_charge_count ,court_case_id, disposition_date, disposition_type_original. It had 377 duplicate lines which are removed. It contains information on the booking
book_df <- lapply(2015:2018, function(i){
  fread(paste0("Historical Data Submissions/Kings/Pretrial Pilot Program-", i, ".csv"))
}) %>% bind_rows()

book_df2 <- 
  fread("Historical Data Submissions/Kings/Pretrial Pilot Program-2019 updated to 123119.csv") 

book_df <- book_df2 %>%
  bind_rows(book_df) %>%
  distinct()

rm(book_df2)

# Variable name standardization--See pg. xxx for more details. 
names(book_df) <- c("title", "demo_info", "book_num", "book_date", "book_type_original", "release_date", "release_type_original", "court_case_id", "charge_ref", "counts_ref", "charge_level_ref", "disposition_type_ref", "disposition_date_ref", "arrest_charge_original", "arrest_charge_count", "arrest_charge_level_original", "disposition_type_original", "disposition_date", "total")

## the demographic information was in a weird format, this code fixes it
book_df <- book_df %>%
  separate(demo_info, paste("x", 1:20, sep = "_"), sep = "\\\r\\\n") %>%
  separate(x_20, paste("y", 1:5, sep = "_"), sep = ":") %>%
  rename(cii = y_2, fbi = y_3, local_id = y_4, employed = y_5, dob = x_8, sex_original = x_10, race_original = x_12, cdl_id = x_15,
         dln_state = x_17) %>%
  unite(name, c(x_3, x_5, x_1), sep = " ") %>%
  select(-c(x_2, x_4, x_6, x_7, x_9, x_11, x_13, x_14, x_16, x_18, x_19, y_1)) %>%
  mutate(cii = gsub(" FBI", "", cii),
         fbi = gsub(" Local ID", "", fbi),
         local_id = gsub(" Employer", "", local_id),
         employed = if_else(employed != " ", 1, 0),
         total = parse_number(total)) %>%
  mutate_at(vars(book_num:court_case_id), funs(gsub(".*: ","",.))) %>%
  select(-contains("ref"), -title) %>%
  select(-total) %>%
  select(-dln_state)

# Date Reformatting --See pg. xxx for more details.
book_df <- book_df %>%
  mutate(dob = mdy(dob),
         book_date_time = mdy_hm(book_date),
         release_date_time = mdy_hm(release_date),
         book_date = as_date(book_date_time),
         release_date = as_date(release_date_time),
         disposition_date = as_date(mdy_hms(disposition_date))) 

# Standardize Charges and join charge hierarchy--See pg. xxx for more details about this process. 
book_df <- book_df %>%
  mutate(
      arrest_charge = gsub("Misd|\\(Misd\\)|MISD|F-1|F-2|M-1|M-2|\\(M\\)|Auto|-Felony|Felony|FELONY|-DRUGSALCOHOL|First Degree|\\(F\\)|-Alcohol|Alcohol|-Drugs|Second Degree|B\\/W-M|B\\/W-F|O\\/W-M|O\\/W-F", "", arrest_charge_original),
      arrest_charge_code_original = str_extract(arrest_charge, "[A-Z]{2}|[A-Z]{1}&[A-Z]{1}"),
      arrest_charge_code = gsub("&", "", arrest_charge_code_original),
      arrest_charge_code = case_when(
        arrest_charge_code %in% c("PC", "VC", "HS", "BP", "WI", "US") ~ arrest_charge_code,
        T ~ "Other"),
      arrest_charge = gsub("[A-Z]{2}|[A-Z]{1}&[A-Z]{1}", "", arrest_charge),
      arrest_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}","", arrest_charge)),
      arrest_attempt_flag = if_else(grepl("^664", arrest_charge), 1,0),
      arrest_charge = gsub("^664", "", arrest_charge),
      arrest_charge = gsub("849B2$", "", arrest_charge),
      arrest_charge_level = case_when(
        arrest_charge_level_original == "M" ~ "M",
        arrest_charge_level_original == "F" ~ "F",
        arrest_charge_level_original == "I" ~ "I",
        T ~ "Other")
      ) %>%
  unite(join_var, arrest_charge_level, arrest_charge_code, arrest_charge, remove = F) %>%
  mutate(
    join_var = case_when(
      join_var == "M_PC_12033" ~ "Other_PC_12033",
      join_var == "M_VC_23152AB" ~ "M_VC_23152B",
      T ~ join_var
    )
  )


load("Complete Charge Code Hierarchy.RData")

book_df <- left_join(book_df, charge_hier, by = "join_var")

# Standardize Factors
book_df <- book_df %>%
  mutate(sex = case_when(sex_original %in% c("M") ~ "Male",
                         sex_original %in% c("F") ~ "Female"),
         
         race = case_when(race_original %in% c("B") ~ "Black",
                          race_original %in% c("H") ~ "Hispanic",
                          race_original %in% c("W") ~ "White",
                          T ~ "Other_Unknown"),
         
         book_type = case_when(book_type_original %in% c("Fresh Arrest") ~ "On_View",
                               book_type_original %in% c("Arrest Warrant") ~ "New_Warrant",
                               book_type_original %in% c("Bench Warrant") ~ "Bench_Warrant",
                               book_type_original %in% c("Electronic Monitoring Roll-Up") ~ "Sup_Vio_Post",
                               book_type_original %in% c("Court Remand") ~ "Court_Order",
                               book_type_original %in% c("Detention Only 851.6 PC", "Flash Incarceration") ~ "Detention_Only",
                               book_type_original %in% c("Book & Release") ~ "Cite_Release",
                               book_type_original %in% c("Courtesy Hold", "Parole Hold", "Probation Hold") ~ "Hold",
                               book_type_original %in% c("Sentenced") ~ "Commitment",
                               book_type_original %in% c("Transportation Order", "Juvenile Hall Transfer", "Civil Commitment", "Bail Bond Surrender") ~ "Other",
                               T ~ "Other"),
         
         
         release_type = case_when(release_type_original %in% c("Time Served") ~ "Time_Served",
                                  release_type_original %in% c("6 Hour Hold/849(b)(2)", "Parole Hold Dropped", "Out of County Pickup", "Extradited") ~ "Hold_Release",
                                  release_type_original %in% c("Cite & Release") ~ "Cite_Release",
                                  release_type_original %in% c("Bail Bond Posted") ~ "Bail_Bond",
                                  release_type_original %in% c("Case Dismissed", "DA Denial", "No Complaint") ~ "Dismissed_Dropped",
                                  release_type_original %in% c("PROBATION RELEASE") ~ "Probation",
                                  release_type_original %in% c("Own Recognizance") ~ "OR",
                                  release_type_original %in% c("Court Ordered Release") ~ "Court_Order",
                                  release_type_original %in% c("Released") ~ "Unknown",
                                  release_type_original %in% c("Sentenced to State Prison") ~ "Prison",
                                  release_type_original %in% c("Detention Only 851.6 PC") ~ "Detain_Only",
                                  release_type_original %in% c("Released to ICE") ~ "Fed",
                                  T ~ "Other"),
         
         disposition_type = case_when(disposition_type_original %in% c("DISMISSED", "NO COMPLAINT", "DA DENIAL") ~ "Dismissed_Dropped",
                                      disposition_type_original %in% c("SENTENCED", "SENTENCED TO STATE PRISON") ~ "Sentenced",
                                      disposition_type_original %in% c("TIME SERVED") ~ "Time_Served",
                                      disposition_type_original %in% c("CITED TO APPEAR") ~ "Cite_Release",
                                      disposition_type_original %in% c("OWN RECOGNIZANCE") ~ "OR",
                                      disposition_type_original %in% c("COURT ORDERED RELEASE") ~ "Court_Order",
                                      disposition_type_original %in% c("DROP HOLD") ~ "Hold_Release",
                                      T ~ "Other"))

# Flag Construction--See pg. xxx for more details.
book_df <- book_df %>%
  mutate(arrest_felony_flag = if_else(arrest_charge_level == "F", 1,0),
         arrest_misd_flag = if_else(arrest_charge_level == "M", 1, 0),
         arrest_attempt_flag = if_else(arrest_charge == "664", 1, arrest_attempt_flag),
         arrest_sup_vio_post_flag = if_else(book_type == "Sup_Vio_Post", 1, 0)
         )



book_df %>%
  distinct() %>%
  add_count(book_num, arrest_charge_original, arrest_charge_count ,court_case_id, disposition_date, disposition_type_original) %>%
  filter(n>1) %>%
  arrange(book_num)

book_df %>%
  distinct()

book_df %>%
  select(book_num, book_date, book_type_original, court_case_id, arrest_charge_original, arrest_charge_count, disposition_type_original, disposition_date)

```


Diagnostic code
```{r}

#unrelated search of charge hierarchy for LAO question abt DV proxy in exclusion estimate
# test <- charge_hier %>%
#   mutate(dv_flag_new = if_else(grepl("DOMESTIC|SPOUSE|PARTNER|COHABITANT", master_charge_description) &
#                              !grepl("MARRY|CRT ORD|COURT ORDER|FOREIGN|LAND|FAIL|SHELTER", master_charge_description), 1, 0),
#          dv_flag_old = if_else(grepl("DOMESTIC|SPOUSE|PARTNER|COHABITANT", master_charge_description), 1, 0))
# 
# old_codes <- test %>%
#   filter(dv_flag_old == 1) %>%
#   distinct(charge_level, charge, charge_code, master_charge_description)
# 
# new_codes <- test %>%
#   filter(dv_flag_new == 1) %>%
#   distinct(charge_level, charge, charge_code, master_charge_description)


#write.xlsx(file = ".xlsx")

#names(charge_hier)

#test_output <- list(old_codes, new_codes)

#write.xlsx(test_output, file = "I:/Random for Shelley/SB 10 exclusion estimates/DV codes for LAO.xlsx", asTable = T, tableStyle = "TableStyleMedium1", sheetName = c("Codes used in estimate", "Pared down codes"))

# Diagnostic Code for Charge Hierarchy
# 1 - 7,901/267,372 = 97% non-match rate
#(1 - nrow(book_df %>% filter(arrest_charge_code != "NA") %>% filter(is.na(hierarchy)))/nrow(book_df))*100

# book_df %>%
#   filter(is.na(hierarchy)) %>%
#   count(join_var) %>%
#   arrange(desc(n))
# 
# book_df %>%
#   filter(join_var == "M_PC_12033")
# 
# charge_hier %>%
#   filter(charge == "12033")


#table(book_df$arrest_charge_original)[order(table(book_df$arrest_charge_original), decreasing = T)]
# table(book_df$arrest_charge)[order(table(book_df$arrest_charge), decreasing = T)]
# table(book_df$arrest_charge_code)[order(table(book_df$arrest_charge_code), decreasing = T)]

# book_df %>%
#   count(arrest_charge_original, arrest_charge) %>%
#   group_by(arrest_charge) %>%
#   add_count() %>%
#   filter(n > 1)



# book_df %>% count(release_type_original) %>% arrange(desc(n))
# book_df %>% count(disposition_type_original) %>% arrange(desc(n))
# book_df %>% count(book_type_original) %>% arrange(desc(n))

#original_field <- names(book_df)

#original_df[[1]] <- tibble(table_name = "book_df", original_field = original_field, modified_field = names(book_df))



#
```

Jail Collapse
```{r}

book_df <- book_df %>%
  mutate(time_first_release = release_date_time - book_date_time) %>%
  mutate(hierarchy = if_else(is.na(hierarchy), 1e6, as.numeric(hierarchy)),
         warrant_flag = if_else(grepl("Warrant", book_type), 1, 0),
         onview_flag = if_else(grepl("On_View", book_type), 1, 0)) %>%
  group_by(book_num) %>%
  mutate(max_booktype = book_type[hierarchy == min(hierarchy)][1],
         max_arrest_charge = arrest_charge[hierarchy == min(hierarchy)][1],
         max_charge_description = master_charge_description[hierarchy == min(hierarchy)][1],
         max_charge_description = master_charge_description[hierarchy == min(hierarchy)][1],
         max_hier = min(hierarchy)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, as.numeric(.)))) %>%
  mutate_at(vars(contains("flag")), funs("count" = sum(.))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  group_by(book_num, court_case_id, onview_flag) %>%
  filter(hierarchy == min(hierarchy)) %>%
  group_by(book_num, court_case_id) %>%
  filter(onview_flag == 1 |sum(onview_flag) == 0) %>%
  ungroup() %>%
  distinct(book_num, court_case_id, .keep_all = T)


# Diagnostics
# book_df %>%
#   distinct(book_num, court_case_id) %>%
#   arrange(book_num) %>%
#   group_by(book_num) %>%
#   add_count() %>%
#   filter(n>1)
# 
# book_df %>%
#   distinct(local_id, book_date) 
```


Court Data
```{r}

setwd("G:/CrimJustice/PretrialAssessmentPilot")

# Court cases status
court_status <- read_excel("Historical Data Submissions/Kings/KINGS/KINGS.xlsx", sheet = 1)

#original_field <- names(court_status)

names(court_status) <- c("court_case_id", "court_docket_id", "case_status_date", "case_status")

#original_df[[2]] <- tibble(table_name = "court_status", original_field = original_field, modified_field = names(court_status))

court_status <- court_status %>%
  mutate(case_status_date = as_date(case_status_date))

# Court charges
court_charges <- read_excel("Historical Data Submissions/Kings/KINGS/KINGS.xlsx", sheet = 2)

#original_field <- names(court_charges)

names(court_charges) <- c("court_case_id", "court_docket_id", "court_charge_count", "court_charge_original", "court_charge_level_original", "court_charge_description", "plea_date", "plea_type_original", "disposition_date", "disposition_type_original", "final_date")

#original_df[[3]] <- tibble(table_name = "court_charges", original_field = original_field, modified_field = names(court_charges))

court_charges <- court_charges %>%
  mutate_at(vars(plea_date),as_date) %>%
  mutate_at(vars(disposition_date, final_date),convertToDate)

court_charges <- court_charges %>%
  mutate(
    attempt_flag = if_else(grepl("^664\\/", court_charge_original), 1,0),
    court_charge = gsub("^664\\/", "", court_charge_original),
    court_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}","", court_charge)),
    court_charge = gsub("0000000000002|999999999996|00000000003|000000000004", "", court_charge),
    court_charge_code_original = str_extract(court_charge_description, "^[A-Z]{2}"),
    court_charge_code = if_else(court_charge_code_original %in% c("PC", "VC", "HS", "BP", "WI","US"), court_charge_code_original, "Other"),
    court_charge_level = str_extract(court_charge_level_original, "^."),
    court_charge_level = if_else(court_charge_level %in% c("F", "M", "I"), court_charge_level, "Other"),
    court_charge_degree = gsub("^.", "", court_charge_level_original)
  ) %>%
  unite(join_var, court_charge_level, court_charge_code, court_charge, remove = F)

#table(court_charges$court_charge_original)[order(table(court_charges$court_charge_original), decreasing = T)]
# table(court_charges$court_charge)[order(table(court_charges$court_charge), decreasing = T)]
#table(court_charges$court_charge_code_original)[order(table(court_charges$court_charge_code_original), decreasing = T)]
#table(court_charges$plea_type)[order(table(court_charges$plea_type), decreasing = T)]

load("Complete Charge Code Hierarchy.RData")

court_charges <- left_join(court_charges, charge_hier, by = "join_var")


# Diagnostic Code for Charge Hierarchy
# 1 - 7,901/267,372 = 97% non-match rate
#(1 - nrow(court_charges %>% filter(court_charge_level %in% c("F", "M", "I")) %>% filter(is.na(hierarchy)))/nrow(court_charges))*100

# court_charges %>%
#   filter(is.na(hierarchy)) %>%
#   count(join_var) %>%
#   arrange(desc(n))

# charge_hier %>%
#   filter(charge == "667")

# court_charges %>%
#   filter(court_case_id %in% court_case_id[court_charge == "6675B"]) %>%
#   arrange(court_case_id) %>%
#   count(court_case_id) %>%
#   filter(n == 1)

# charge_hier %>%
#   filter(charge == "666")

# court_charges %>%
#   group_by(court_charge_level) %>%
#   count()


# Court hearings
court_hearings <- read_excel("Historical Data Submissions/Kings/KINGS/KINGS.xlsx", sheet = 3)

#original_field <- names(court_hearings)

names(court_hearings) <- c("court_case_id", "court_docket_id", "hearing_date", "hearing_type_original", "hearing_outcome")

#original_df[[4]] <- tibble(table_name = "court_hearings", original_field = original_field, modified_field = names(court_hearings))

court_hearings <- court_hearings %>%
  mutate_at(vars(hearing_date),as_date)

# Court fta
court_fta <- read_excel("Historical Data Submissions/Kings/KINGS/KINGS.xlsx", sheet = 4)

#original_field <- names(court_fta)

names(court_fta) <- c("court_case_id", "court_docket_id", "fta", "fta_date", "fta_warrant", "fta_warrant_date", "fta_warrant_description")

#original_df[[5]] <- tibble(table_name = "court_fta", original_field = original_field, modified_field = names(court_fta))

court_fta <- court_fta %>%
  mutate_at(vars(fta_date, fta_warrant_date),convertToDate)

# Court sentence
court_sentence <- read_excel("Historical Data Submissions/Kings/KINGS/KINGS.xlsx", sheet = 5)

#original_field <- names(court_sentence)

names(court_sentence) <- c("court_case_id", "court_docket_id", "sentence_date", "sentence_type", "sentence_location", "sentence_term", "sentence_term_value")

#original_df[[6]] <- tibble(table_name = "court_sentence", original_field = original_field, modified_field = names(court_sentence))

court_sentence <- court_sentence %>%
  mutate_at(vars(sentence_date), as_date)

# Court sentence dl conditions
court_sent_dl_cond <- read_excel("Historical Data Submissions/Kings/KINGS/KINGS.xlsx", sheet = 6)

#original_field <- names(court_sent_dl_cond)

names(court_sent_dl_cond) <- c("court_docket_id", "court_case_id", "sentence_date", "config_desc", "screenbuilderdataentrynumber", "dl_cond_desc", "dl_cond_desc2", "dl_cond_fieldname", "dl_cond_fieldvalue", "dl_cond_fieldname2", "dl_cond_fieldvalue2")

#original_df[[7]] <- tibble(table_name = "court_sent_dl_cond", original_field = original_field, modified_field = names(court_sent_dl_cond))

court_sent_dl_cond <- court_sent_dl_cond %>%
  mutate_at(vars(sentence_date), as_date) %>%
  mutate(sentence_type = "DL_Cond")

# Court fine
court_fine <- read_excel("Historical Data Submissions/Kings/KINGS/KINGS.xlsx", sheet = 7)

#original_field <- names(court_fine)

names(court_fine) <- c("court_case_id", "fine")

#original_df[[8]] <- tibble(table_name = "court_fine", original_field = original_field, modified_field = names(court_fine))

# Court sentence probation
court_sent_prob <- read_excel("Historical Data Submissions/Kings/KINGS/KINGS.xlsx", sheet = 8)

#original_field <- names(court_sent_prob)

names(court_sent_prob) <- c("court_case_id", "court_docket_id","sentence_date", "sentence_prob_type", "sentence_prob_location", "sentence_term_value", "sentence_term")

#original_df[[9]] <- tibble(table_name = "court_sent_prob", original_field = original_field, modified_field = names(court_sent_prob))

court_sent_prob <- court_sent_prob %>%
  mutate_at(vars(sentence_date), as_date) %>%
  mutate(sentence_type = "Probation")

# Court technical elements
court_tech <- read_excel("Historical Data Submissions/Kings/KINGS/KINGS.xlsx", sheet = 9)

#original_field <- names(court_tech)

names(court_tech) <- c("court_case_id", "court_docket_id", "last_name", "first_name", "middle_name", "file_date", "dob", "cii", "cdl_id", "fbi", "sex_original", "race_original", "dl_state", "risk_report_date")

#original_df[[10]] <- tibble(table_name = "court_tech", original_field = original_field, modified_field = names(court_tech))

court_tech<- court_tech %>%
  mutate_at(vars(file_date, dob, risk_report_date), as_date)


#court_charges %>% select(court_charge_original) %>% filter(grepl("&", court_charge_original)) %>% group_by(court_charge_original) %>% count()

# Standardize Factors
court_charges <- court_charges %>%
  mutate(plea_type = case_when(plea_type_original %in% c("Guilty", "Admission", 'Guilty Plea pursuant to "People vs. West"' ) ~ "Guilty",
                               plea_type_original %in% c("Not Guilty", "Denial", "Not Guilty Insane", "Not Guilty / Not Guilty Insane (both)") ~ "Not_Guilty",
                               plea_type_original %in% c("Nolo Contendre", "No Contest / People vs West") ~ "Nolo_Contendere",
                               plea_type_original %in% c("Set Aside and Vacated", "Withdraw of Plea", "Once in Jeopardy", "No plea entered pursuant to 1368PC") ~ "Other",
                               T ~ "Other"),
         disposition_type = case_when(disposition_type_original %in% c("Bail Forfeiture") ~ "Guilty", #this is for traffic offenses, almost all with Guilty plea
                                      disposition_type_original %in% c("Conviction-Sentenced Plea of Guilty/Nolo-Misd/Infraction", "Conviction-Sentenced Plea Guilty/Nolo-BeforePrelim Hrg.", "Conviction-Sentenced Plea of Guilty/Nolo-After Prelim Hrg") ~ "Nolo_Contendere",
                                      disposition_type_original %in% c("Convicted", "Admitted", "Admission to Violation of Parole/Community Supervision", "Found True", "Found Guilty by Declaration", "Found Guilty by Jury", "Found True by Trial (Jury/Court)") ~ "Guilty",
                                      disposition_type_original %in% c("Stricken", "Dism: PC1385-Furtherance of Justice-Before Hrg", "Dism: Motion of The People-After Hearing", "Dism: PC1385-Futherance of Justice-After Hearing", "Dism: PC1385-Futherance of Justice-After Hearing", "Dism: Motion of the People-Before Prelim", "Dism: Motion of the People-Before Hearing", "Dism: Plea Negotiation-Before Hearing", "Dism: PC1385-Furtherance of Justice-Before Prelim", "Finding-Not Held to Answer") ~ "Dismissed",
                                      disposition_type_original %in% c("Acquitted-Not Guilty by Jury", "Found Not Guilty by Declaration", "Found Not True", "Found Not Guilty by Court Trial") ~ "Not_Guilty",
                                      grepl("^Dism", disposition_type_original) ~ "Dismissed",
                                      T ~ "Other"
         )
  )

court_hearings <- court_hearings %>%
  mutate(hearing_type = case_when(grepl("Arraignment", hearing_type_original) ~ "Arraignment",
         T ~ "Other"))

  
court_tech <- court_tech %>%  
  mutate(sex = case_when(sex_original %in% c("Male") ~ "Male",
                         sex_original %in% c("Female") ~ "Female",
                         T ~ "Other_Unknown"),
         
         race = case_when(race_original %in% c("Black") ~ "Black",
                          race_original %in% c("Hispanic") ~ "Hispanic",
                          race_original %in% c("White") ~ "White",
                          T ~ "Other_Unknown")
  )
         
      
# court_charges %>%
#   count(disposition_type_original) %>%
#   arrange(desc(n))

#Create Flags

court_charges <- court_charges %>%
  mutate(felony_flag = if_else(court_charge_level == "F", 1, 0),
         misd_flag = if_else(court_charge_level == "M", 1, 0),
         qualifier_flag = if_else(court_charge_level_original %in% c("A", "E"), 1, 0)) %>%
  mutate_at(vars(contains("flag")), funs("conviction" = if_else(. == 1 & disposition_type %in% c("Guilty", "Nolo_Contendere"), 1, 0))) %>%
  rename_at(vars(contains("flag"), -contains("conviction")), funs(paste0("court_", .))) %>%
  rename_at(vars(contains("conviction")), funs(paste0("conviction_", gsub("_conviction", "", .))))



court_fta <- court_fta %>%
  mutate(fta_flag = if_else(fta_warrant == 1, 1, 0),
         fta_nowar_flag = if_else(fta == 1, 1, 0)) #these flags are unclear because there is also a warrant description which only sometimes is a bench warrant and sometimes other types of warrant, need to ask them about this.

# court_charges %>% count(court_charge_level_original) %>% arrange(desc(n))

#court_charges %>% filter(disposition_type_original == "Bail Forfeiture") %>% count(plea_type_original)

#court_fta %>% count(WarDesc)

# court_charges %>% filter(grepl("Attempt", court_charge_description ))

# court_charges %>% 
#   filter(court_charge_level_original %in% c("A", "E")) %>% 
#   select(court_charge_original, court_charge, court_charge_level_original, court_charge_level, court_charge_code_original, court_charge_code, court_charge_description) %>%
#   unique() # %>%
  # write.xlsx(file = "qualifier_codes_for_Noah_Kings_Court.xlsx")

```

Court Collapse
```{r}
# court_charges
# 
# court_charges %>%
#   filter(grepl("TR", court_docket_id)) %>%
#   count(charge_level)
# 
# court_charges <- court_charges %>%
#   filter(!grepl("TR|JQ", court_docket_id)) 
# 
# court_charges %>%
#   filter(grepl("RV", court_docket_id))

court_dispo <- court_charges %>%
  mutate(disposition_type = ordered(disposition_type, levels = c("Other", "Dismissed", "Not_Guilty", "Nolo_Contendere", "Guilty"))) %>%
  group_by(court_case_id) %>%
  #select(-c(disposition_num, charge_id, charge_history_id, offense_id, disposition_hist_id, disposition_id, disposition_type_code, amend_reason_id, amend_reason)) %>%
  mutate(hierarchy = if_else(is.na(hierarchy), 1e6, as.numeric(hierarchy))) %>%
  group_by(court_case_id) %>%
  mutate(disposition_date = max(disposition_date),
         disposition_type = max(disposition_type)) %>%
  mutate(max_court_charge_level = court_charge_level[hierarchy == min(hierarchy)][1],
         max_court_charge_code = court_charge_code[hierarchy == min(hierarchy)][1],
         max_court_charge = court_charge[hierarchy == min(hierarchy)][1],
         max_charge_description = master_charge_description[hierarchy == min(hierarchy)][1],
         max_hier = min(hierarchy)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, as.numeric(.)))) %>%
  mutate_at(vars(contains("flag")), funs("count" = sum(.))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  filter(hierarchy == min(hierarchy)) %>%
  ungroup() %>%
  distinct(court_case_id, .keep_all = T) %>%
  select(-c(plea_date, plea_type_original, plea_type))
  
  # court_charges %>%
  #   count(disposition_type)


# court_charges %>%
#   filter(!is.na(disposition_date)) %>%
#   distinct(court_case_id)

#Court Ftas are not separate from warrants
court_fta_war <- court_fta %>%
  arrange(fta_warrant_date) %>%
  group_by(court_case_id) %>%
  mutate(fta_flag = max(fta_flag),
         fta_flag_count = sum(fta_flag)) %>%
  ungroup() %>%
  distinct(court_case_id, .keep_all = T) %>%
  select(-c(fta, fta_warrant))
#double check, fta warrant descriptions sometimes are arrest warrants, why not all bench warrants?

# court_fta %>%
#   distinct(court_case_id, fta_date)


court_hearing <- court_hearings %>%
  filter(hearing_type == "Arraignment") %>%
  rename(arraignment_date = hearing_date) %>%
  arrange(arraignment_date) %>%
  distinct(court_case_id, .keep_all = T) %>%
  select(court_case_id, court_docket_id, arraignment_date)

# court_hearings %>%
#   filter(is.na(hearing_type))
#   count(hearing_type)
#   
#   court_fta %>%
#     count(fta_date)



court_plea <- court_charges %>%
  arrange(plea_date) %>%
  mutate(guilty_flag = if_else(plea_type == "Guilty", 1, 0)) %>%
  group_by(court_case_id) %>%
  filter(guilty_flag == 1|sum(guilty_flag) == 0) %>%
  ungroup() %>%
  distinct(court_case_id, .keep_all = T) %>%
  select(court_case_id, court_docket_id, plea_date, plea_type)


court_sent <- bind_rows(court_sent_prob, court_sentence, court_sent_dl_cond) %>%
  arrange(sentence_date) %>%
  distinct(court_case_id, .keep_all = T) %>%
  select(court_case_id, court_docket_id, sentence_date, sentence_type)

# court_sent_dl_cond
# court_sent_prob
# court_sentence
# 
# court_sentence %>%
#   count(sentence_location) %>%
#   arrange(desc(n))
# 
# court_sent_prob %>%
#   count(sentence_location) %>%
#   arrange(desc(n))


# court_tech %>%
#   distinct(court_case_id) #already distinct


court_df <- reduce(list(court_dispo, court_fta_war, court_hearing, court_plea, court_sent, court_tech), left_join, by = "court_case_id") %>%
  select(-contains(".y")) %>%
  select(-contains(".x.x")) %>%
  #select(-court_docket_id) %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x", "", .))) %>%
  mutate(final_disposition_date = if_else(disposition_date <= sentence_date|is.na(sentence_date), disposition_date, sentence_date),
         conviction_flag = if_else(disposition_type %in% c("Guilty","Nolo_Contendere"), 1, 0))
# names(court_dispo)
# names(court_fta_war)
# names(court_hearing)
# names(court_plea)
# names(court_sent)
# court_df %>%
#   names()

  
# Diagnostics
# court_fta %>%
#   count(fta_all_flag)
# 
# court_fta_war %>%
#   count(fta_flag)
# 
# full_join(court_fta %>% filter(fta_all_flag == 1), court_fta_war %>% filter(fta_flag == 1) %>% rename(fta_date = fta_war_date), by = c("court_case_id", "fta_date")) %>%
#   filter(fta_all_flag != fta_flag) %>%
#   add_count(court_case_id) %>%
#   filter(n > 1) %>%
#   arrange(court_case_id, fta_date)
# 
# court_hearing %>%
#   count(hearing_type_original) %>%
#   arrange(desc(n))
#   
# court_charge %>%
#   filter(stage %in% c("DISPOSITION EVENT")) %>%
#   select(-c(disposition_num, charge_id, charge_history_id, offense_id, disposition_hist_id, disposition_id, disposition_type_code, amend_reason_id, amend_reason))
#   # filter(stage %in% c("Sentence Event")) %>%
#   count(dispos) %>%
#   arrange(desc(n))
#   
# court_dispo %>%
#   distinct(court_case_id, disposition_date, .keep_all = T) %>%
#   add_count(court_case_id) %>%
#   filter(n > 1) %>%
#   arrange(desc(n))
# 
# court_charge %>%
#   filter(stage %in% c("PLEA EVENT")) %>%
#   count(disposition_type_original) %>%
#   arrange(desc(n))
#   distinct(court_case_id, disposition_date, .keep_all = T) %>%
#   add_count(court_case_id) %>%
#   filter(n > 1) %>%
#   arrange(desc(n))
#   # select(-c(disposition_num, charge_id, charge_history_id, offense_id, disposition_hist_id, disposition_id, disposition_type_code, amend_reason_id, amend_reason))
#   # filter(stage %in% c("Sentence Event")) %>%
#   count(dispos) %>%
#   arrange(desc(n))
# 
# court_charge %>%
#   # filter(stage %in% c("CASE FILING")) %>%
#   # filter(stage %in% c("SENTENCE EVENT", "DISPOSITION EVENT")) %>%
#   # distinct(court_case_id) 
#   count(stage)
#   filter(court_case_id == "921214")
# 
#   court_df %>%
#     filter(conviction_flag == 1) %>%
#     filter(!disposition_type %in% c("Guilty", "Nolo_Contendere")) %>%
#     count(disposition_type, sentence_type) %>%
#     #count(court_charge_code, court_charge_level) %>%
#     arrange(desc(n))


court_charges <- court_charges %>%
  distinct(court_case_id, .keep_all = T)

court_hearings <- court_hearings %>%
  distinct(court_case_id, .keep_all = T)

court_tech <- court_tech %>%
  distinct(court_case_id, .keep_all = T)

court_sentence <- court_sentence %>%
  distinct(court_case_id, .keep_all = T)


ajch <- anti_join(court_charges, court_hearings)
sjch <- semi_join(court_charges, court_hearings)

anti_join(court_charges, court_hearings)
anti_join(court_hearings, court_charges)
anti_join(court_charges, court_tech)
anti_join(court_tech, court_charges)
anti_join(court_tech, court_hearings)
anti_join(court_hearings, court_tech)

anti_join(court_sentence, court_charges)
anti_join(court_sentence, court_tech)
anti_join(court_sentence, court_hearings)


summary(ajch$disposition_date)
summary(sjch$disposition_date)

summary(court_tech$file_date)
semi_join(court_tech, court_charges, by = "court_docket_id")
semi_join(court_tech, court_hearings)
```

Join
  Jail Court Join
```{r}

#remember that jail data was collapsed not to the unique booking, but to the unique booking AND court case id, so it will need to be collapsed at some point after all possible court cases are attached.

# Remove extraneous objects in the environment
rm(list = ls()[!ls() %in% ls(pattern = "df")])

#Check for common variables
#names(book_df)[names(book_df) %in% names(assess_df)]

names(book_df)[names(book_df) %in% names(court_df)]
names(book_df)
names(court_df)

court_df %>%
  select(court_case_id)


#Turning NULL to NA to ensure non matching and removing generic charge info from data frames
book_df2 <- book_df %>%
  mutate_if(is.character, list(~na_if(., "NULL"))) %>%
  select(-c(charge, charge_level, charge_code)) %>%
  mutate_at(vars(name), toupper)

# assess_df <- assess_df %>%
#   mutate_if(is.character, list(~na_if(., "(Missing)"))) %>%
#   select(-c(id, court))

court_df2 <- court_df %>%
  mutate_if(is.character, list(~na_if(., "NULL"))) %>%
  select(-c(charge, charge_level, charge_code)) %>%
  mutate_at(vars(first_name, middle_name, last_name), toupper) %>%
  mutate(name = str_c(first_name, middle_name, last_name, sep = " ")) %>%
  mutate(court_case_id = as.character(court_case_id))

court_df2 %>%
  select(court_docket_id.x)

book_df2 %>%
  select(court_case_id)

book_df2 <- book_df2 %>%
  mutate(court_case_id = gsub("-", "", court_case_id))

court_df2 <- court_df2 %>%
  mutate(court_docket_id = gsub("-", "", court_docket_id))


inner_join(book_df2, court_df2, by = c("court_case_id" = "court_docket_id"), na_matches = "never")

#Joining ACourt to Jail Data
join1 <- inner_join(book_df2, court_df2, by = c("court_case_id" = "court_docket_id"), na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x$", "", .))) %>%
  select(-contains(".y")) %>%
  #1 Duplicate with missing dispositions which will be dropped later. 
  distinct()

j1 <- anti_join(book_df2, court_df2, by = c("court_case_id" = "court_docket_id"), na_matches = "never")
a1 <- anti_join(court_df2, book_df2, by = c("court_docket_id" = "court_case_id"), na_matches = "never")

# court_df2 %>%
#   mutate(court_docket_id.y = gsub("-", "", court_docket_id.y)) %>%
#   filter(court_docket_id.x != court_docket_id.y) %>%
#   select(court_docket_id.x, court_docket_id.y)


  #Examine if set of common variables is distinct--yes
  semi_join(book_df2, court_df2, by = c("court_case_id" = "court_docket_id"), na_matches = "never") %>%
    distinct()

j1 %>%
  select(contains("date"))

a1 %>%
  select(contains("date"))

#second stage no good bc not unique
# #Joining on Name and Court ID -- NO GOOD
# join2 <- inner_join(j1, a1, by = c("cdl_id", "disposition_date"), na_matches = "never") %>%
#   rename_at(vars(contains(".x")), funs(gsub("\\.x$", "", .))) %>%
#   select(-contains(".y")) %>%
#   #1 Duplicate with missing dispositions which will be dropped later. 
#   distinct()
# 
# j2 <- anti_join(j1, a1, by = c("cdl_id", "disposition_date"), na_matches = "never")
# a2 <- anti_join(a1, j1, by = c("cdl_id", "disposition_date"), na_matches = "never")



#   #Examine if set of common variables is distinct--NOPE
#   semi_join(j1, a1, by = c("cdl_id", "disposition_date"), 
#             na_matches = "never") %>%
#     distinct()
#   
# j1 %>%
#   names()
# 
# a1 %>%
#   names()
# 
# join2 %>%
#   arrange(cdl_id) %>%
#   select(court_case_id, court_docket_id)

# #Diagnostics
#   #Jail and Assessment Matches by category
# tibble(
#   stage = 1:2,
#   match = c(
#     'c("book_num")',
#     'c("first_name", "last_name", "book_date" = "interview_date")'
#   ),
#   # jail_match_rate = sapply(1:2, function(i) {
#   #   (nrow(book_df) - nrow(get(paste0("j", i)))) / nrow(book_df) * 100
#   # }),
#   assess_match_rate = sapply(1:2, function(i) {
#     (nrow(assess_df) - nrow(get(paste0("a", i)))) / nrow(assess_df) * 100
#   })
# )
# 
# #Recreating Booking--Should be same number of rows.
# book_df <- bind_rows(join1, join2, j2)  
# 
# rm(list = ls()[!ls() %in% ls(pattern = "df")])
# 
# # Court Matching
# #Joining on CII and Court ID
# join1 <- inner_join(book_df, court_df, by = c("court_docket_id", "cii", "dob"), na_matches = "never") %>%
#   rename_at(vars(contains(".x")), funs(paste0("arrest_", gsub("\\.x$", "", .)))) %>%
#   rename_at(vars(contains(".y")), funs(paste0("court_", gsub("\\.y$", "", .)))) %>%
#   # 8 Duplicates with missing dispositions which will be dropped later. 
#   distinct()
# 
# j1 <- anti_join(book_df, court_df, by = c("court_docket_id", "cii", "dob"), na_matches = "never")
# c1 <- anti_join(court_df, book_df, by = c("court_docket_id", "cii", "dob"), na_matches = "never")
# 
#   #Examine if set of common variables is distinct--yes except 8 spurious cases.
#   join1 %>%
#     add_count(cii, court_docket_id, book_num, dob) %>%
#     filter(n > 1) %>%
#     arrange(desc(n))
# 
# #Joining on Name and Court ID
# join2 <- inner_join(j1, c1, by = c("court_docket_id", "first_name", "dob"), na_matches = "never") %>%
#   rename_at(vars(contains(".x")), funs(paste0("arrest_", gsub("\\.x$", "", .)))) %>%
#   rename_at(vars(contains(".y")), funs(paste0("court_", gsub("\\.y$", "", .)))) %>%
#   #1 Duplicate with missing dispositions which will be dropped later. 
#   distinct()
# 
# j2 <- anti_join(j1, c1, by = c("court_docket_id", "first_name", "dob"), na_matches = "never")
# c2 <- anti_join(c1, j1, by = c("court_docket_id", "first_name", "dob"), na_matches = "never")
# 
#   #Examine if set of common variables is distinct--yes except 8 spurious cases.
#   join2 %>%
#     add_count(first_name, court_docket_id, book_num) %>%
#     filter(n > 1) %>%
#     arrange(desc(n))
# 
# #Joining on Court ID
# join3 <- inner_join(j2, c2, by = c("court_docket_id", "first_name"), na_matches = "never") %>%
#   rename_at(vars(contains(".x")), funs(paste0("arrest_", gsub("\\.x$", "", .)))) %>%
#   rename_at(vars(contains(".y")), funs(paste0("court_", gsub("\\.y$", "", .)))) %>%
#   #1 Duplicate with missing dispositions which will be dropped later. 
#   distinct()
# 
# j3 <- anti_join(j2, c2, by = c("court_docket_id", "first_name"), na_matches = "never")
# c3 <- anti_join(c2, j2, by = c("court_docket_id", "first_name"), na_matches = "never")
# 
#   #Examine if set of common variables is distinct--yes except 8 spurious cases.
#   join3 %>%
#     add_count(court_docket_id, book_num) %>%
#     filter(n > 1) %>%
#     arrange(desc(n))
#   
# #Diagnostics
#   #Jail and Court Matches by category
# tibble(
#   stage = 1:3,
#   match = c(
#     'c("court_docket_id", "cii", "dob")',
#     'c("court_docket_id", "first_name", "dob")',
#     'c("court_docket_id", "dob")'
#   ),
#   jail_match_rate = sapply(1:3, function(i) {
#     (nrow(book_df) - nrow(get(paste0("j", i)))) / nrow(book_df) * 100
#   }),
#   court_match_rate = sapply(1:3, function(i) {
#     (nrow(court_df) - nrow(get(paste0("c", i)))) / nrow(court_df) * 100
#   })
# )
# 
# join_df <- bind_rows(join1, join2, join3)
```

Probation Data
```{r}
assess_df <- read_excel("Historical Data Submissions/Kings/P2 Submission-June 30/Kings County Data Collection - 01.01.20 - 07.28.20.xlsx", skip = 1)


assess_df <- assess_df %>%
  separate(AssessmentAnswer, c("vpraio_tool_response_1", "vpraio_tool_response_2", "vpraio_tool_response_3", "vpraio_tool_response_4", "vpraio_tool_response_5", "vpraio_tool_response_6", "vpraio_tool_response_7", "vpraio_tool_response_8", "vpraio_tool_response_9"), sep = ",") %>%
  mutate(across(contains("vpraio_tool_response"), ~gsub("^.*:", "", .x)))

names_df <- tibble(original_field = names(assess_df)) 

# Variable name standardization--See pg. xxx for more details.
names(assess_df) <- c("tool_name", "name", "dob", "sex_original", "race_original", "fbi", "cdl_id", "cii", "book_num", "zip_code", "referral_status", "court_date_reminder_original", "release_recommendation_original", "release_decision_original", "pretrial_decision_date", "assessment_date", "vpraio_risk_score", "vpraio_tool_response_1", "vpraio_tool_response_2", "vpraio_tool_response_3", "vpraio_tool_response_4", "vpraio_tool_response_5", "vpraio_tool_response_6", "vpraio_tool_response_7", "vpraio_tool_response_8", "vpraio_tool_response_9", "pretrial_release_type_original",  "release_date_time", "release_authorization_original", "release_conditions_original", "pretrial_violation_date", "pretrial_violation_original")

names_df$field <- names(assess_df)

# Date Reformatting--See pg. xxx for more details.
assess_df <- assess_df %>%
  mutate(across(c(pretrial_decision_date, assessment_date, dob, pretrial_violation_date), mdy),
         release_date_time = mdy_hms(release_date_time),
         release_date = as_date(release_date_time))


  
#aa = after arraignment, pa = pre-arraignment

# Standardize Factors--See pg. xxx for more details.
assess_df <- assess_df %>%
  mutate(sex = case_when(sex_original %in% c("Male") ~ "Male",
                         sex_original %in% c("Female") ~ "Female",
                         T ~ "Other_Unknown"),
         
         #Trimming white space on original race first
         race_original = trimws(race_original),
         race = case_when(race_original %in% c("Black") ~ "Black",
                          race_original %in% c("Hispanic") ~ "Hispanic",
                          race_original %in% c("White") ~ "White",
                          #All Other races/ethnicities collapsed into other
                          T ~ "Other_Unknown"),
         
         #separate risk score from risk level and standardize risk level
         risk_level_original = trimws(gsub("[0-9]|\\(|\\)", "", vpraio_risk_score)),
         risk_level = case_when(risk_level_original %in% c("Low", "Low-Average") ~ "Low",
                                risk_level_original %in% c("Average", "Average-High") ~ "Medium",
                                risk_level_original %in% c("High") ~ "High"),
         vpraio_risk_score = parse_number(vpraio_risk_score),
         
         #standardize release recommendation
         ## check what "Override - Detain" means, currently placed in "other_unknown" category
         release_recommendation = case_when(release_recommendation_original %in% c("AA Release w/Conditions", "PA Release w/Conditions") ~ "Monitor",
                                            release_recommendation_original %in% c("Detain") ~ "Detain",
                                            T ~ "Other_Unknown"),
         release_decision = case_when(release_decision_original %in% c("Denied by On Call Judge") ~ "Detain",
                                      pretrial_release_type_original %in% c("Pretrial - Supervision") ~ "Monitor",
                                      release_decision_original %in% c("Bail Before Arraignment", "DA Declines to File", "No Bail Warrant") ~ "Ineligible",
                                      T ~ "Other_Unknown"),
         
         pretrial_ineligible_reason = case_when(release_decision_original %in% c("Bail Before Arraignment") ~ "Bail_Bond",
                                                release_decision_original %in% c("DA Declines to File") ~ "Case_Disposed",
                                                T ~ "Other_Unknown"),
         
         release_authorization = if_else(grepl("Judge", release_authorization_original), "Judge", "Other_Unknown"),
         
         tool_name = "vpraio") 
         


# Flag Standardization---See pg. xxx for more details.
  ## According to their RCM, scores 4 and above are recommended for detention. Score 0 reminder only, score 1 basic monitoring, score 2 enhanced monitoring, score 3 intensive monitoring including GPS and detain pending arraignment. It looks like everyone is recommended for court reminders calls, but need to ask.

assess_df <- assess_df %>%
  mutate(assess_flag = if_else(is.na(assessment_date), 0, 1),
         rec_release_flag = if_else(release_recommendation %in% c("OR", "Monitor"), 1, 0),
         decision_release_flag = if_else(release_decision %in% c("OR", "Monitor"), 1, 0),
         #This field needs to come from the jail data.
         # pretrial_release_flag = if_else(),
         release_override_flag = if_else(rec_release_flag != decision_release_flag &
                                            !release_recommendation %in% c("Ineligible", "Other_Unknown") &
                                            !release_decision %in% c("Ineligible", "Other_Unknown"), 1, 0),
         #rec_em_flag = if_else(grepl("SCRAM", toupper(release_recommendation_original)), 1, 0),
         # rec_phone_flag = if_else(),
         # rec_inperson_flag = if_else(),
         # rec_drug_test_flag = if_else(grepl("TEST", toupper(release_recommendation_original)), 1, 0),
         # rec_other_flag = if_else(),
         condition_em_flag = if_else(grepl("ELECTRONIC MONITOR|GPS|SCRAM", toupper(release_conditions_original)), 1, 0),
         # Discuss release_conditions_original with Kings along with their original materials to determine phone and inperson flag.
         # condition_phone_flag = if_else(),
         # condition_inperson_flag = if_else(),
         ## Does test as requested entail a request flag? What is the treatment program?
         # condition_drug_test_flag = if_else(grepl("SCRAM|TEST", toupper(release_conditions_original)), 1, 0),
         #condition_no_contact_flag = if_else(grepl("NO CONTACT|136", toupper(release_conditions_original)), 1, 0),
         court_date_reminder_flag = if_else(court_date_reminder_original == "Yes", 1, 0),
         # Transit service doesn't actually exist here.
         #transit_service_flag = if_else(grepl("BUS", toupper(other_pretrial_service_original)), 1, 0),
         ## Are all violations violations that result in termation?
         pretrial_violation_flag = if_else(!is.na(pretrial_violation_original), 1, 0))

## does the matrix determine the condition recommendation? is the level of monitoring for rec or decision recorded anywehre?

```

  Assessment Collapse
```{r}
# Kings data is already organized by one row per assessment  

```

Assessment Tables 
```{r}
assess_table <- assess_df %>%
  # Filter for only those actually assessed
  filter(!is.na(assessment_date)) %>%
  # Create county name.
  mutate(county = "Kings",
         pretrial_termination_outcome = NA_character_,
         pretrial_termination_reason = NA_character_) %>%
  # Select relevant variables.
  select(county, risk_level, release_recommendation, release_decision, assessment_date, risk_score = vpraio_risk_score, tool_name, assessment_date, dob, sex, race, pretrial_termination_outcome, pretrial_termination_reason, book_num)

# Save file  O
#fwrite(assess_table, file = "G:/CrimJustice/PretrialAssessmentPilot/Assessment Output Tables/Kings Assessment Output 09-2020.csv")
```

Assessment Tables 10/2020
```{r}

book_join <-  book_df %>%
  select(book_num, charge_level) %>%
  mutate(charge_level = ordered(charge_level, levels = c("Other", "I", "M", "F"))) %>%
  group_by(book_num) %>%
  mutate(charge_level = max(charge_level, na.rm = T)) %>%
  ungroup() %>%
  distinct(book_num, .keep_all = T)

assess_table <- assess_df %>%
  # Filter for only those actually assessed
  filter(!is.na(assessment_date)) %>%
  left_join(book_join) %>%
  # Create county name.
  mutate(county = "Kings",
         pretrial_termination_outcome = NA_character_,
         pretrial_termination_reason = NA_character_,
         monitor_level = NA_character_) %>%
  # Select relevant variables.
  select(county, risk_level, release_recommendation, release_decision, assessment_date, risk_score = vpraio_risk_score, tool_name, assessment_date, dob, sex, race, charge_level, risk_level, monitor_level, pretrial_termination_outcome, pretrial_termination_reason)

# Save file  
#fwrite(assess_table, file = "G:/CrimJustice/PretrialAssessmentPilot/Assessment Output Tables/Kings Assessment Output 10-2020.csv")

## match is bad with jail data bc jail data only goes through end of 2019 whereas assessments are in 2020


```


Assessment (9/2020) 
```{r}

names_df <- names_df %>%
  mutate(
    modified_field = case_when(
      field == "sex_original" ~ "sex",
      field == "race_original" ~ "race",
      field == "risk_level_original" ~ "risk_level",
      field == "release_recommendation_original" ~ "release_recommendation",
      field == "pretrial_release_type_original" ~ "release_decision",
      field == "release_decision_original" ~ "release_decision, pretrial_ineligible_reason",
      field == "release_conditions_original" ~ "condition_em_flag",
      field == "release_authorization_original" ~ "release_authorization",
      field == "court_date_reminder_original" ~ "court_date_reminder_flag",
      field =="pretrial_violation_original" ~ "pretrial_violation_flag")) %>%
  filter(!is.na(modified_field)) %>%
  separate_rows(modified_field, sep = ",") %>%
  mutate_all(trimws)

factor_df <- lapply(ls()[!grepl("original|^df|hier|names|factor|date|flag", ls())], function(i){
  df <- get(i)
  
  df <- lapply(c(1:nrow(names_df))[!grepl("flag", names_df$modified_field)], function(j){
    df <- df %>%
      select(value = names_df$field[j], modified_value = names_df$modified_field[j]) %>%
      group_by_all() %>%
      count() %>%
      arrange(desc(n)) %>%
      group_by(modified_value) %>%
      summarise(value = paste(value, collapse = ", "), n = sum(n)) %>%
      ungroup() %>%
      mutate(percent = round(n/sum(n)*100, 1),
             total = sum(n)) %>%
      mutate(field = names_df$field[j], modified_field = names_df$modified_field[j]) %>%
      arrange(desc(n)) %>%
      select(field, modified_field, value, modified_value, n, percent, total) %>%
      mutate_all(as.character) 
      
      
    
    return(df)
  }) %>% bind_rows()
 
  df <- df %>% mutate(table_name = i)
   }) %>% 
  bind_rows() %>%
  left_join(names_df) %>%
  select(table_name, original_field, field, modified_field, value, modified_value, total, percent)

factor_df <- factor_df %>%
  # mutate(value = case_when(
  # modified_field == "pretrial_ineligible_reason" & modified_value == "Bail_Bond" ~ "pretrial_release_type_original = 'Posted Bail' OR release_recommendation_original = 'Posted Bail'",
  # modified_field == "pretrial_ineligible_reason" & modified_value == "Case_Disposed" ~ "pretrial_release_type_original = ('No Complaint Filed', 'Time Served') OR release_recommendation_original = ('No Complaint Filed', 'Time Served')",
  # modified_field == "pretrial_ineligible_reason" & modified_value == "Other_Unknown" ~ "Other Values",
  # T ~ value)) %>%
  # filter(modified_field == "pretrial_ineligible_reason") %>%
  group_by(modified_field, value) %>%
  mutate_at(vars(original_field, field), funs(paste(., collapse = ", "))) %>%
  distinct(modified_field, value, .keep_all = T) %>%
  ungroup() %>%
  slice(-13)


flag_df <- lapply(ls()[!grepl("original|^df|hier|names|factor|date|flag", ls())], function(i){
  df <- get(i)
  
  df <- lapply(c(1:nrow(names_df))[grepl("flag", names_df$modified_field)], function(j){
    df <- df %>%
      select(value = names_df$field[j], modified_value = names_df$modified_field[j]) %>%
      group_by_all() %>%
      count() %>%
      arrange(desc(n)) %>%
      group_by(modified_value) %>%
      summarise(value = paste(value, collapse = ", "), n = sum(n)) %>%
      ungroup() %>%
      mutate(percent = round(n/sum(n)*100, 1),
             total = sum(n)) %>%
      mutate(field = names_df$field[j], modified_field = names_df$modified_field[j]) %>%
      arrange(desc(n)) %>%
      select(field, modified_field, value, modified_value, n, percent, total) %>%
      mutate_all(as.character)
    
    return(df)
  }) %>% bind_rows() 
  
 df <- df %>% mutate(table_name = i)
   }) %>%

  bind_rows() %>%
  left_join(names_df) %>%
  select(table_name, original_field, field, modified_field, value, modified_value, total, percent)


flag_df <- flag_df %>%
  filter(modified_value == 1) %>%
  mutate(value = case_when(
  modified_field == "condition_drug_test_flag" & modified_value == "1" ~ "MATCHES (SCRAM, TEST)",
  modified_field == "condition_em_flag" & modified_value == "1" ~ "MATCHES (SCRAM, ELECTRONIC MONITOR, GPS)",
  modified_field == "pretrial_violation_flag" & modified_value == "1" ~ "IF pretrial_violation_original EXISTS",
  T ~ value)) %>%
  # filter(modified_field == "pretrial_ineligible_reason") %>%
  group_by(modified_field, value) %>%
  mutate_at(vars(original_field, field), funs(paste(., collapse = ", "))) %>%
  distinct(modified_field, value, .keep_all = T) %>%
  ungroup()
  
  


date_df <- lapply(ls()[!grepl("original|^df|hier|names|factor|date|flag", ls())], function(i){
  df <- get(i)
  
   if(sum(grepl("date", names(df))) > 0){
  df2 <- df %>%
  select(contains("date"), -contains("time"), -contains("court")) %>%
  gather("field", "value") %>%
  group_by(field) %>%
  summarise_all(funs(min_date = as.character(min(., na.rm = T)),  max_date = as.character(max(., na.rm = T)))) %>%
    mutate(table_name = i)
  }else{
    df2 <- tibble(field = NA_character_, min_date = NA_character_,  max_date = NA_character_, table_name = i)
  }
}) %>%
  bind_rows() %>%
  select(table_name, field, min_date, max_date)
  

#write.xlsx(list(factor_df, flag_df, date_df), file = "G:/CrimJustice/PretrialAssessmentPilot/Code Books/Assessment Code Book/Kings Assessment Code Book 9-20.xlsx", asTable = T, tableStyle = "TableStyleMedium1", colWidths = "auto", sheetName = c("Factors", "Flags", "Dates"))

```


Code Book
```{r}
rm(original_field)

original_df <- bind_rows(original_df)

Kings_df <- lapply(ls()[!grepl("original", ls())], function(i){
  df <- get(i)
  
  if(sum(grepl("date", names(df))) > 0){
  df2 <- df %>%
  select(contains("date"), -contains("time")) %>%
  gather("modified_field", "value") %>%
  group_by(modified_field) %>%
  summarise_all(funs(min = as.character(min(., na.rm = T)), mean = as.character(mean(., na.rm = T)), max = as.character(max(., na.rm = T))))
  }else{
    df2 <- tibble(modified_field = NA_character_, min = NA_character_, mean = NA_character_, max = NA_character_)
  }
  
  df <- df %>%
    mutate_if(~length(unique(.)) > 50|is.Date(.)|is.POSIXct(.), ~(. = "not_factor")) %>%    
    mutate_all(~if_else(is.na(.), "na_missing", as.character(.))) %>%
    gather(modified_field, factor_value) %>%
    count(modified_field, factor_value) %>%
    mutate(table_name = i, county = "Kings") %>%
    mutate(factor_flag = if_else(factor_value == "not_factor", 0, 1)) %>%
    group_by(table_name, modified_field) %>%
    mutate(table_count = sum(n)) %>%
    ungroup() %>%
    rename("factor_count" = "n") %>%
    mutate(factor_count = if_else(factor_value == "not_factor", NA_integer_, factor_count),
           factor_percent = round(factor_count/table_count*100, 1)) %>%
    arrange(desc(factor_flag), modified_field, desc(factor_count))
  
  df <- left_join(df, df2, by = "modified_field")
    }) %>% 
  bind_rows() %>%
  left_join(original_df) %>%
   select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_count,
           factor_percent, table_count, min, mean, max) 

write.xlsx(Kings_df, file = "Code Books/Kings Code Book.xlsx")
```

Completion
```{r}
files <- list.files("G:/CrimJustice/PretrialAssessmentPilot/Code Books/Code Book Notes", pattern = "Kings", full.names = T)

df <- lapply(files, read_excel)

df[[3]] <- full_join(df[[1]], df[[2]]) %>%
  mutate(factor_standard = "") %>%
  select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_standard, factor_count, factor_percent, 
         table_count, "sl_notes" = Sal_Notes, "nl_notes_1" = factor_collapse, "nl_notes_2" = notes, min, mean, max)

df <- list(df[[3]], df[[1]], df[[2]])

#write.xlsx(df, file = "G:/CrimJustice/PretrialAssessmentPilot/Code Books/Variable Construction/Kings Factor Construction.xlsx", asTable = T, tableStyle = "TableStyleMedium1", sheetName = c("Variable Construction", "sl_notes", "nl_notes"))
```

Factors codebook
```{r}
factor_df <- lapply(ls()[!grepl("original|^df|hier", ls())], function(i){
  df <- get(i)
  if(sum(grepl("original", names(df))) == 0){
    return(NULL)
  }else{
    var_names <- names(df)[grepl("original", names(df))]
    var_names2 <- gsub("_original", "", var_names)
   
    df1 <- df %>%
     select(var_names) %>%
     gather(original_field, original_value)
   
    df2 <- df %>%
     select(var_names2) %>%
     gather(modified_field, modified_value)
   
   df <- bind_cols(df1, df2) %>%
     count(original_field, modified_field, original_value, modified_value) %>%
     arrange(modified_field, desc(n)) %>%
     group_by(modified_field) %>%
     mutate(row = row_number(),
            percent = round(n/sum(n)*100)) %>%
     ungroup() %>%
     filter(row <= 50) %>%
     select(-row) %>%
     rename("total" = n)
   }
  }) %>%
  bind_rows()

#write.xlsx(factor_df, file = "G:/CrimJustice/PretrialAssessmentPilot/Code Books/Factor Code Book/Kings Factor Code Book.xlsx", asTable = T, tableStyle = "TableStyleMedium1", colWidths = "auto")
```


DOJ CII/Linking Extraction
```{r}
# Grab Tables with CIIo
df <- sapply(ls()[which(sapply(ls(), function(i){
  sum(names(get(i)) %in% "cii")
}) == 1)], get)

# Pull CII and other identifiers
doj_book <- df[[1]] %>%
  select(cii, fbi, cdl_id, local_id, name, dob, race_original, sex_original) %>%
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) %>%
  distinct()

doj_court <- df[[2]] %>%
  select(cii, fbi, cdl_num, first_name, middle_name, last_name, dob, sex_original, race_original) %>%
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) %>%
  distinct()

# Examine missing ciis and duplicates on cii. 
doj_book %>% #Off by about 55,000
  distinct()

doj_book %>% 
  distinct(cii)

doj_book %>% 
  distinct() %>%
  add_count(cii) %>%
  filter(n > 1) %>%
  arrange(desc(n)) %>% 
  View()

doj_court %>% #Off by about 45,000
  distinct()

doj_court %>% 
  distinct(cii)

doj_court %>% 
  distinct() %>%o
  add_count(cii) %>%
  filter(n > 1) %>%
  arrange(desc(n)) %>% 
  View()


#CIIs for DOJ
doj_cii <- bind_rows(doj_book %>% select(cii), doj_court %>% select(cii)) %>% distinct()


#Create an excel workbook with all data table. Make sure to include the cii table first. 
write.xlsx(list(doj_cii, doj_book, doj_court), file = "CIIs for DOJ/Kings CIIs and Demographics for DOJ.xlsx", sheetName = c("ciis", "booking", "court"))
```

CII extraction 10.2020
```{r}
# Grab Tables with CII
df_list <- sapply(
  ls()[which(sapply(ls(), function(i){
    sum(names(get(i)) %in% "cii")
    }) == 1)],
  function(j){
    df <- get(j)
    df <- df %>%
      select(any_of(c("cii", "cdl_id", "fbi", "name", "last_name", "first_name", "middle_name", "dob", "sex_original", "race_original"))) %>%
       mutate(
         cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) %>%
  distinct()
 
})

# CIIs from assessment tables
doj_assess <- bind_rows(df_list[[1]])

# CIIs from booking tables
doj_book <- bind_rows(df_list[[2]])

# CIIs from court tables
doj_court <- bind_rows(df_list[[3]])


#CIIs for DOJ
doj_cii <- bind_rows(doj_book %>% select(cii), doj_court %>% select(cii), doj_assess %>% select(cii))  %>% 
  distinct() %>%
  filter(nchar(cii) == 10)


#Create an excel workbook with all data table. Make sure to include the cii table first.
write.xlsx(list(doj_cii, doj_book, doj_court, doj_assess), file = "G:/CrimJustice/PretrialAssessmentPilot/CIIs for DOJ/October 2020/Kings P2 CIIs and Demographics for DOJ.xlsx", sheetName = c("ciis", "booking", "court", "assessment"))
```

# Napa

Jail Data
```{r}
#setwd("G:/CrimJustice/PretrialAssessmentPilot")

# Jail Bookings Data Import--- Napa, 2020-01-01 to 2020-06-30
  ## person_df contains one row per person (local_id) with demographic information on the person, Napa has an integrated criminal justice system, so this is just a person table, without any booking or event information
  ## book_df contains one row per occurrence_id, which represenets a unique combination of book_num, book_date, booking_type, and associated court case
  ## book_charge contains one row per charge, a combination of book_num, court_case_id, and arrest_charge. Some rows are duplicated exactly, need to follow up with Napa to determine if this is a data duplication error or represents multiple counts of the same charge.


####


#Integrated criminal justice Demographic and Personal Identification
  ## person_df contains one row per person (local_id) with demographic information on the person
  ## Napa has an integrated criminal justice system, so this is just a person table, without any booking or event information
  ## Historical_7-1-2020 was missing sex, so Historical_7_1_2020_2 was submitted with sex included
person_df <- read_excel("Historical Data Submissions/Napa/P2 Submission-June 30/Historical_7-1-2020_2.xlsx", sheet = 1)


# Variable name standardization--See pg. xxx for more details. 
names(person_df) <- c("fbi", "cii", "local_id", "cdl_id", "cdl_id_state", "name", "dob", "race_original", "sex_original") 


# Standardize Factors--See pg. xxx for more details.
person_df <- person_df %>%
  mutate(race = case_when(race_original %in% c("Black") ~ "Black",
                          race_original %in% c("Hispanic") ~ "Hispanic",
                          race_original %in% c("White") ~ "White",
                          T ~ "Other_Unknown"),
         sex = case_when(sex_original %in% c("M") ~ "Male",
                         sex_original %in% c("F") ~ "Female",
                         T ~ "Other_Unknown")
  )



####


#Jail Booking Events 
  ## book_df contains one row per occurrence_id, which represenets a unique combination of book_num, book_date, booking_type, and associated court case

book_df <- read_excel("Historical Data Submissions/Napa/P2 Submission-June 30/Historical_7-1-2020_2.xlsx", sheet = 2, col_types = "text")


# Variable name standardization--See pg. xxx for more details. 
names(book_df) <- c("book_num", "court_case_id", "arrest_date", "local_id", "book_type_original", "book_date", "release_date", "release_type_original")


# Date Reformatting (as well as booking sequence and courtcase_id)--See pg. xxx for more details.
book_df <- book_df %>%
  mutate(release_date = convertToDate(release_date)) %>%
  mutate_at(vars(arrest_date, book_date),  funs("time" = convertToDateTime(.))) %>%
  mutate_at(vars(arrest_date, book_date), convertToDate)


# Standardize Factors--See pg. xxx for more details.
book_df <- book_df %>%
  mutate(book_type = case_when(book_type_original %in% c("New Crime") ~ "On_View",
                               book_type_original %in% c("Local Warrant") ~ "New_Warrant",
                               book_type_original %in% c("Violation of Formal Probation", "Summary Vop", "Parole Violation", "Violation of PRCS", "Violation of Juvenile Probation", "Mandatory Vop") ~ "Sup_Vio_Post",
                               book_type_original %in% c("Supervised OR Violation") ~ "Sup_Vio_Pre",
                               book_type_original %in% c("Formal Flash", "PRCS Flash", "Mandatory Flash") ~ "Detain_Only",
                               T ~ "Other"),
         
         release_type = case_when(release_type_original %in% c("Time Served") ~ "Time_Served",
                                  release_type_original %in% c("Released to other agency") ~ "Hold_Release",
                                  release_type_original %in% c("Cite Release") ~ "Cite_Release",
                                  release_type_original %in% c("Bailed - Bond") ~ "Bail_Bond",
                                  release_type_original %in% c("No Complaint") ~ "Dismissed_Dropped",
                                  release_type_original %in% c("4024", "4018") ~ "Unspec_Cap",
                                  release_type_original %in% c("Court Ordered Pretrial Release") ~ "Pretrial_Sup",
                                  T ~ "Other")
  )


# Flag Construction--See pg. xxx for more details. 
book_df <- book_df %>%
  mutate(arrest_sup_vio_post_flag = if_else(book_type_original %in% c("Violation of Formal Probation", "Summary Vop", "Parole Violation", "Violation of PRCS", "Violation of Juvenile Probation", "Mandatory Vop","Formal Flash", "PRCS Flash", "Mandatory Flash"), 1, 0),
         arrest_sup_vio_pre_flag = if_else(book_type_original == "Supervised OR Violation", 1, 0),
         warrant_flag = if_else(grepl("Warrant", book_type), 1, 0),
         onview_flag = if_else(book_type == "On_View", 1, 0))



####


#Jail Booking Charges 
  ## book_charge contains one row per charge, a combination of book_num, court_case_id, and arrest_charge. Some rows are duplicated exactly, need to follow up with Napa to determine if this is a data duplication error or represents multiple counts of the same charge.
  ## book_charge need to look at probation violations, charges are included in book_charge for old cases, but should be fine because we will catch with filter for dispo date earlier than book date.
book_charge <- read_excel("Historical Data Submissions/Napa/P2 Submission-June 30/Historical_7-1-2020_2.xlsx", sheet = 3, col_types = "text")


# Variable name standardization--See pg. xxx for more details. 
names(book_charge) <- c("book_num", "court_case_id", "local_id", "arrest_charge_original", "arrest_charge_level_original")


# Standardize Factors--See pg. xxx for more details.
book_charge <- book_charge %>%
#Add enhacement flag when arrest_charge_level original is "SA" (Special Allegation). 
  mutate(arrest_attempt_flag = if_else(grepl("\\/664", arrest_charge_original), 1, 0),
         arrest_charge = gsub("\\&|COMMITTING FE|\\/664(a)*", "", arrest_charge_original),
         arrest_charge_code = str_extract(arrest_charge, "..$")) %>%
  separate_rows(arrest_charge_original, sep = "\\/") %>%
  mutate(arrest_charge_code = if_else(!arrest_charge_code %in% c("PC", "VC", "HS", "BP", "WI", "US"), "Other", arrest_charge_code),
         arrest_charge = gsub("..$", "", arrest_charge),
         arrest_charge_level = if_else(grepl("^F", arrest_charge_level_original), "F", arrest_charge_level_original),
         arrest_charge_level = if_else(!arrest_charge_level_original %in% c("F", "I", "M"), "Other", arrest_charge_level_original),
         arrest_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}|EX|\\+|","", arrest_charge))) %>%
   filter(!arrest_charge %in% c("")) %>%
   unite(join_var, arrest_charge_level, arrest_charge_code, arrest_charge, remove = F) %>%
   mutate(
    join_var = case_when(
      join_var == "M_PC_12032A1" ~ "M_PC_12032",
      join_var == "F_PC_12032A1" ~ "F_PC_12032A",
      join_var == "M_PC_12032A2" ~ "M_PC_12032",
      T ~ join_var
      )
   )

load("Complete Charge Code Hierarchy.RData")

book_charge <- left_join(book_charge, charge_hier, by = "join_var")


# Flag Construction--See pg. xxx for more details. 
book_charge <- book_charge %>%
  mutate(arrest_felony_flag = if_else(arrest_charge_level == "F", 1,0),
         arrest_misd_flag = if_else(arrest_charge_level == "M", 1,0),
         arrest_qualifier_flag = if_else(arrest_charge_level_original == "SA", 1, 0)
         )


```


Jail Collapse
```{r}

book_df <- book_df %>% 
  group_by(book_num, court_case_id) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, .))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  ungroup() %>%
  distinct(book_num, court_case_id, .keep_all = TRUE) 
  ##data has book_date_time but only has release_date without the time
  # mutate(time_first_release = release_date_time - book_date_time)


book_charge <- book_charge %>%
  mutate(hierarchy = if_else(is.na(hierarchy), 1e6, as.numeric(hierarchy))) %>%
  group_by(book_num, court_case_id) %>%
  mutate(max_arrest_charge = arrest_charge[hierarchy == min(hierarchy)][1],
         max_charge_description = master_charge_description[hierarchy == min(hierarchy)][1],
         max_hier = min(hierarchy)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, .))) %>%
  mutate_at(vars(contains("flag")), funs("count" = sum(.))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  filter(hierarchy == min(hierarchy)) %>%
  ungroup() %>%
  distinct(book_num, court_case_id, .keep_all = T) 

book_df <-left_join(book_df, book_charge) %>%
  mutate(local_id = as.numeric(local_id))

book_df <- left_join(book_df, person_df)
```

Jail Diagnostics
```{r eval=FALSE, include=FALSE}
# Diagnostics
book_df %>%
  distinct(local_id, book_date) %>%
  arrange(local_id) %>%
  group_by(local_id) %>%
  count() %>%
  filter(n>1)

book_df %>%
  #filter(book_type != "New_Warrant") %>%
  #distinct(book_num, court_case_id) %>%
  arrange(book_num, court_case_id) %>%
  group_by(book_num, court_case_id, book_type_original) %>%
  add_count() %>%
  filter(n>1) %>%
  ungroup() %>%
  count(book_type_original)



book_df %>%
  distinct(local_id, book_date) 

person_df

book_charge %>% filter(local_id == "199500474")
book_df %>% filter(local_id == "199500474")
book_df %>% distinct(court_case_id, local_id, book_date)

book_df
book_charge
book_df2

book_df %>% distinct(court_case_id) %>% arrange(desc(court_case_id))
book_charge %>% distinct(court_case_id) %>% arrange(desc(court_case_id))

book_df %>% filter(!grepl("^[0-9]{2}", court_case_id))
book_charge %>% filter(!grepl("^[0-9]{2}", court_case_id))

book_df %>% mutate(book_year = year(book_date)) %>% distinct(court_case_id, book_year) %>% arrange(desc(court_case_id))

book_df %>% distinct(book_num) %>% arrange(book_num)
book_charge %>% distinct(book_num) %>% arrange(book_num)

book_df %>% filter(court_case_id == "19CR000704")
book_charge %>% filter(court_case_id == "19CR000704")

book_df %>% filter(court_case_id == "CR181207")
book_charge %>% filter(court_case_id == "CR181207")


book_df %>% filter(local_id == "200200244") %>% arrange(book_date)
book_charge %>% filter(local_id == "200200244")
#book_df %>% count(book_type_original) %>% arrange(desc(n))

# charge_hier %>%
#   filter(grepl("6675", charge))


# Diagnostic Code for Charge Hierarchy
# 1 - 7,901/267,372 = 97% non-match rate
#(1 - nrow(book_charge %>% filter(is.na(hierarchy)))/nrow(book_charge))*100

# book_charge %>%
#   filter(is.na(hierarchy)) %>%
#   count(join_var) %>%
#   arrange(desc(n))



#table(book_charge$arrest_charge_original)[order(table(book_charge$arrest_charge_original), decreasing = T)]
# table(book_charge$arrest_charge)[order(table(book_charge$arrest_charge), decreasing = T)]
# table(book_charge$arrest_charge_code)[order(table(book_charge$arrest_charge_code), decreasing = T)]

# book_charge %>%
#   count(arrest_charge_original, arrest_charge) %>%
#   group_by(arrest_charge) %>%
#   add_count() %>%
#   filter(n > 1)

book_charge %>%
  # count(arrest_charge_level_original) %>%
  filter(grepl("COMMITTING", arrest_charge_original))
  arrange(desc(n))

book_charge %>%
  # filter(arrest_charge_level_original == "SA") %>%
  count(arrest_charge) %>%
  arrange(desc(n))

#No Ambiguity
book_charge %>%
  count(arrest_charge, arrest_charge_original) %>%
  group_by(arrest_charge) %>%
  add_count() %>%
  filter(n > 1)

#No combined charges
book_charge %>%
  filter(grepl("/", arrest_charge_original))

```

DA Data (only used to attach filing dates to the court data)
```{r}
# DA Case Data Import--- Napa, **DATES**
  ## da_df contains one row per court case and has information on the filing date and sometimes on case status (which is often just CJNet Migration)
  ## da_charge
  ## da_vop

####


#Filing Dates
  ##da_df contains one row per court case and has information on the filing date and sometimes on case status (which is often just CJNet Migration)
da_df <- read_excel("Historical Data Submissions/Napa/P2 Submission-June 30/Historical_7-1-2020.xlsx", sheet = 4)


# Variable name standardization--See pg. xxx for more details.
names(da_df) <- c("court_case_id", "local_id", "file_date", "case_status", "case_status_date")


# Date Reformatting--See pg. xxx for more details.
da_df <- da_df %>%
  mutate(file_date_time = file_date,
         case_status_date_time = case_status_date) %>%
  mutate_at(vars(file_date, case_status_date), as_date)


#### NOT USED


# #Da Charges
#   ##da_charge contains
# da_charge <- read_excel("Historical Data Submissions/Napa/Historical_1-15-2020.xlsx", sheet = 5)
# 
# 
# # Variable name standardization--See pg. xxx for more details.
# names(da_charge) <- c("court_case_id", "local_id", "da_charge_original", "da_charge_level_original", "da_charge_description", "plea_type_original")
# 
# 
# # Standardize Factors--See pg. xxx for more details.
# da_charge <- da_charge %>%
#   mutate(plea_type = case_when(plea_type_original %in% c("Admits", "Glty/NCPlea17b4", "Proven/True", "AdmitCount", "AdmitsVOP", "Acquitted") ~ "Guilty",
#                                plea_type_original %in% c("DsmMODA", "DsmHrvWaiv", "Unprovn/NotTrue", "DsmOther", "Conv Jury", "DismCt") ~ "Not_Guilty",
#                                plea_type_original %in% c("Glty/NCPlea", "Guilty/NC Plea 17b4") ~ "Nolo_Contendere",
#                                plea_type_original %in% c("DrugDiversion", "Diversion") ~ "Other",
#                                plea_type_original %in% c("NULL", "N/A") ~ "NA",
#                                       T ~ "Other") )
# 
# 
# # Charge Standardization and Flag Adds--See pg. xxx for more details.
# da_charge <- da_charge %>%
#   mutate(da_charge = gsub("\\&|COMMITTING FE", "", da_charge_original),
#          da_charge_code = str_extract(da_charge, "..$"),
#          da_charge_code = if_else(!da_charge_code %in% c("PC", "VC", "HS", "BP", "WI", "US"), "Other", da_charge_code),
#          da_charge = gsub("..$", "", da_charge),
#          da_charge_level = if_else(grepl("^F", da_charge_level_original), "F", da_charge_level_original),
#          da_charge_level = if_else(!da_charge_level_original %in% c("F", "I", "M"), "Other", da_charge_level_original),
#          da_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}|EX|\\+|\\-","", da_charge))) %>%
#    filter(da_charge != "") %>%
# 
#   unite(join_var, da_charge_level, da_charge_code, da_charge, remove = F) %>%
#   mutate(
#     join_var = case_when(
#       join_var == "M_PC_12033" ~ "Other_PC_12033",
#       join_var == "M_VC_23152AB" ~ "M_VC_23152B",
#       join_var == "M_VC_231035" ~ "Other_Other_231035",
#       T ~ join_var
#     )
#   )
# 
# load("Complete Charge Code Hierarchy.RData")
# 
# da_charge <- left_join(da_charge, charge_hier, by = "join_var")
# 
# 
# ####
# 
# 
# #Da vop
#   ##da_vop contains
# da_vop <- read_excel("Historical Data Submissions/Napa/Historical_1-15-2020.xlsx", sheet = 6)
# 
# 
# # Variable name standardization--See pg. xxx for more details.
# names(da_vop) <- c("court_case_id", "local_id", "file_date_time", "case_status", "case_status_date_time")
# 
# 
# # Date Reformatting--See pg. xxx for more details.
# da_vop <- da_vop %>%
#   mutate_at(vars(case_status_date_time), convertToDateTime) %>%
#   mutate(case_status_date = as.Date(case_status_date_time),
#          file_date = as.Date(file_date_time))


```

DA Diagnostic
```{r}
# Diagnostic Code for Charge Hierarchy
# 1 - 7,901/267,372 = 97% non-match rate
(1 - nrow(da_charge %>% filter(is.na(hierarchy)))/nrow(da_charge))*100

(1 - nrow(da_charge %>% filter(da_charge_level_original %in% c("M", "F")) %>% filter(is.na(hierarchy)))/nrow(da_charge))*100

da_charge %>%
  filter(da_charge_level_original %in% c("M", "F")) %>%
  filter(is.na(hierarchy)) %>%
  count(join_var) %>%
  arrange(desc(n))

charge_hier %>%
  filter(charge == "667")

table(da_charge$da_charge_original)[order(table(da_charge$da_charge_original), decreasing = T)]
table(da_charge$da_charge)[order(table(da_charge$da_charge), decreasing = T)]
table(da_charge$da_charge_code_original)[order(table(da_charge$da_charge_code_original), decreasing = T)]
table(da_charge$da_charge_code_original)[order(table(da_charge$da_charge_code_original), decreasing = T)]


# book_df %>%
#   count(arrest_charge_original, arrest_charge) %>%
#   group_by(arrest_charge) %>%
#   add_count() %>%
#   filter(n > 1)

da_charge %>% count(plea_type_original) %>% arrange(desc(n))


```



Court Data
```{r}

# Court Case Data Import--- Napa, 2015-01-05 to 2020-01-13
  ## court_charge
  ## re court_charge: In Napa's data, some charges have multiple repeated rows, often only one of which contains the sentencing information. We believe these are duplicated data rather than additional counts (will check with Napa to confirm), so we are prioritizing keeping the row with the sentencing information.
  ## court_war contains one row per warrant, including warrants of various types. It includes information on the warrant date and type of warrant. FTA warrants can be identified here.
  ## court_fta contains one row per FTA event
  ## court_hearing contains one row per hearing (combination of court case, hearing date-time, and hearing type). 
  ## NOT USED: court_df contains flags they made about fta and fta warrant, but as there are separate tables for these, this table is not necessary (and possibly incorrect, since their fta and fta_warrant flags are identical, which is not the case with their other fta tables)



####

#Court Charges
  ##court_charge contains
  ## In Napa's data, some charges have multiple repeated rows, often only one of which contains the sentencing information. We believe these are duplicated data rather than additional counts (will check with Napa to confirm), so we are prioritizing keeping the row with the sentencing information.
court_charge <- read_excel("Historical Data Submissions/Napa/P2 Submission-June 30/Historical_7-1-2020.xlsx", sheet = 8)


# Variable name standardization--See pg. xxx for more details. 
names(court_charge) <- c("court_case_id", "local_id", "court_charge_original", "court_charge_description", "disposition_type_original", "disposition_date", "sentence_type_original", "sentence_date")


# Date Reformatting--See pg. xxx for more details.
court_charge <- court_charge %>%
  mutate_at(vars(contains("date")), convertToDate)


# Standardize Factors--See pg. xxx for more details.
  ##there are a number of sentence types that are "probation or jail", put these as jail
court_charge <- court_charge %>%
  mutate(disposition_type = case_when(disposition_type_original %in% c("After hearing - Conviction - Sentenced-Plea of guilty/nolo c", "Plea of Guilty/Nolo", "Admit", "Before hearing - Conviction - Sentenced-Plea of guilty/nolo") ~ "Nolo_Contendere",
                                      disposition_type_original %in% c("Dism: Motion of the People", "Before hearing - Other dismissal", "After hearing - Other dismissal", "Dism: Plea Negotiation/Harvey Waiver", "Dism: Not Included on Charging Document", "Dism: After Diversion/DEJ", "Dism: PC1385-Furtherance of Justice", "Dism: PC1203.4 Expungement", "Dism: Other Dismissal", "After hearing - Dismissal after diversion", "Not Held to Answer", "Dism: PC871-Court Found Insufficient Cause", "Dism: PC995-Accusation Set Aside", "Dism: PC1381/1381.5/1382-Delay; Not Timely", "After jury trial - Dismissal") ~ "Dismissed",
                                      disposition_type_original %in% c("Found Not True", "After jury trial - Acquittal", "Found Not Guilty: Jury", "Found Not Guilty: Court") ~ "Not_Guilty",
                                      disposition_type_original %in% c("Found True", "After jury trial - Conviction - Jury verdict of guilty", "Before hearing - Conviction - Bail forfeiture", "Court Finding of Guilt") ~ "Guilty",
                                      T ~ "Other"),
         
         sentence_type = case_when(grepl("Prison", sentence_type_original) ~ "Prison",
                                   grepl("Jail", sentence_type_original) ~ "Jail", 
                                   grepl("Probation", sentence_type_original) ~ "Probation",
                                   T ~ "Other") )


# Charge Standardization and Flag Adds--See pg. xxx for more details.
court_charge <- court_charge %>%
  mutate(qualifier_flag = if_else(grepl("^SA", court_charge_description), 1, 0),
         court_charge_code = gsub("SA: ", "", court_charge_description),
         court_charge_code = str_extract(court_charge_code, "^.."),
         court_charge_level = str_extract(court_charge_description, "\\-[A-Z]\\-"),
         court_charge_level = gsub("-", "", court_charge_level),
         court_charge_level = if_else(is.na(court_charge_level), "Other", court_charge_level),
         attempt_flag = if_else(grepl("^664\\/|\\/664$", court_charge_original), 1,0),
         court_charge = gsub("^664\\/|\\/664$", "", court_charge_original),
         court_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}|EX|\\+|\\-","", court_charge))) %>%
 unite(join_var, court_charge_level, court_charge_code, court_charge, remove = F) %>%
  mutate(
    join_var = case_when(
      join_var == "M_VC_231035" ~ "Other_Other_231035",
      T ~ join_var
     )
   )

load("Complete Charge Code Hierarchy.RData")

court_charge <- left_join(court_charge, charge_hier, by = "join_var")


# Flag Adds--See pg. xxx for more details.
court_charge <- court_charge %>%
  mutate(felony_flag = if_else(court_charge_level == "F", 1, 0),
         misd_flag = if_else(court_charge_level == "M", 1, 0)) %>%
  mutate_at(vars(contains("flag")), funs("conviction" = if_else(. == 1 & disposition_type %in% c("Guilty", "Nolo_Contendere"), 1, 0))) %>%
  rename_at(vars(contains("flag"), -contains("conviction")), funs(paste0("court_", .))) %>%
  rename_at(vars(contains("conviction")), funs(paste0("conviction_", gsub("_conviction", "", .))))


#De-duplicating rows
  ## In Napa's data, some charges have multiple repeated rows, often only one of which contains the sentencing information. We believe these are duplicated data rather than additional counts (will check with Napa to confirm), so we are prioritizing keeping the row with the sentencing information.
court_charge <- court_charge %>%
  arrange(sentence_date, disposition_date, sentence_type_original, disposition_type_original) %>%
  distinct(court_case_id, join_var, .keep_all = T)



####


#Court FTA Warrants
  ## court_war contains one row per warrant, including warrants of various types. It includes information on the warrant date and type of warrant. FTA warrants can be identified here.
court_war <- read_excel("Historical Data Submissions/Napa/P2 Submission-June 30/Historical_7-1-2020.xlsx", sheet = 10)


# Variable name standardization--See pg. xxx for more details. 
names(court_war) <- c("court_case_id", "local_id", "war_date", "warrant_description", "warrant_code", "warrant_type")


# Flag Adds--See pg. xxx for more details.
court_war <- court_war %>%
  mutate(court_fta_flag = if_else(grepl("FTA", warrant_type), 1, 0),
         court_sup_vio_post_flag = if_else(warrant_type %in% c("PC1170-Viol Mandatory Supervision", "PC3000.08(f)-Violation Parole", "PC3455-Violation Post Release CS", "Violation of Probation-PC1203.2"), 1, 0))



####


#Court FTAs
  ## court_fta contains one row per FTA event
  ## contains some duplicates which are removed
court_fta <- read_excel("Historical Data Submissions/Napa/P2 Submission-June 30/Historical_7-1-2020.xlsx", sheet = 11) %>%
  distinct()


# Variable name standardization--See pg. xxx for more details. 
names(court_fta) <- c("court_case_id", "local_id", "fta_date")


# Flag Adds--See pg. xxx for more details.
court_fta <- court_fta %>%
  mutate(court_fta_all_flag = 1)


####


#Court Hearings
  ## court_hearing contains one row per hearing (combination of court case, hearing date-time, and hearing type). 
  ## Sometimes there are two arraignment hearings at the same date-time for a single court case because they are two different types of arraignments (e.g. arraignment and VOP arraignment or Information Arraignment)
court_hearing <- read_excel("Historical Data Submissions/Napa/P2 Submission-June 30/Historical_7-1-2020.xlsx", sheet = 9)


# Variable name standardization--See pg. xxx for more details. 
names(court_hearing) <- c("court_case_id", "local_id", "hearing_date_time", "hearing_type_original")

# Date Reformatting--See pg. xxx for more details.
court_hearing <- court_hearing %>%
  mutate(hearing_date = as_date(hearing_date_time))


# Standardize Factors--See pg. xxx for more details.
court_hearing <- court_hearing %>%
  mutate(hearing_type = case_when(grepl("Arraignment", hearing_type_original) ~ "Arraignment",
                                  hearing_type_original %in% c("Sentencing") ~ "Sentencing",
                                  T ~ "Other"))



#### NOT USED


#Court Data on FTAs
  ## court_df contains flags they made about fta and fta warrant, but as there are separate tables for these, this table is not necessary (and possibly incorrect, since their fta and fta_warrant flags are identical, which is not the case with their other fta tables)
court_df <- read_excel("Historical Data Submissions/Napa/P2 Submission-June 30/Historical_7-1-2020.xlsx", sheet = 7)


# Variable name standardization--See pg. xxx for more details. 
names(court_df) <- c("court_case_id", "local_id", "fta", "fta_warrant")


# Flag Adds--See pg. xxx for more details.
court_df <- court_df %>%
  mutate(court_fta_flag = if_else(fta_warrant == "1", 1, 0),
         court_fta_nowar_flag = if_else(fta == "1", 1, 0))



```


Court Collapse
```{r}

# Court Charge Collapse--See pg. xxx for more details about this process. 
suppressWarnings(court_dispo <- court_charge %>%
  mutate(disposition_type = ordered(disposition_type, levels = c("Other", "Dismissed", "Not_Guilty", "Nolo_Contendere", "Guilty"))) %>%
  mutate(sentence_type = ordered(sentence_type, levels = c("Other", "Probation", "Jail", "Prison"))) %>%
  group_by(court_case_id) %>%
  mutate(hierarchy = if_else(is.na(hierarchy), 1e6, as.numeric(hierarchy))) %>%
  group_by(court_case_id) %>%
  mutate(disposition_date = max(disposition_date, na.rm = T),
         disposition_type = max(disposition_type),
         conviction_flag = if_else(disposition_type %in% c("Guilty","Nolo_Contendere"), 1, 0),
         sentence_date = if_else(conviction_flag == 1, min(sentence_date, na.rm = T), as_date(NA)),
         sentence_type = max(sentence_type)) %>%
  mutate(max_court_charge_level = court_charge_level[hierarchy == min(hierarchy)][1],
         max_court_charge_code = court_charge_code[hierarchy == min(hierarchy)][1],
         max_court_charge = court_charge[hierarchy == min(hierarchy)][1],
         max_charge_description = master_charge_description[hierarchy == min(hierarchy)][1],
         max_hier = min(hierarchy)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, as.numeric(.)))) %>%
  mutate_at(vars(contains("flag")), funs("count" = sum(.))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  filter(hierarchy == min(hierarchy)) %>%
  ungroup() %>%
  distinct(court_case_id, .keep_all = T))




#Court Ftas are separate from warrants
court_fta <- court_fta %>%
  arrange(fta_date) %>%
  group_by(court_case_id) %>%
  mutate(court_fta_all_flag = max(court_fta_all_flag),
         court_fta_all_flag_count = sum(court_fta_all_flag)) %>%
  ungroup() %>%
  distinct(court_case_id, .keep_all = T) 

  ## court_fta_flag currently includes FTAs for which an Arrest Warrant (rather than a Bench Warrant) was issued. Follow up with the lawyers to see what the correct way to handle this is.
  ## are there any case where one would get an FTA on a probation violation case, which we would then not be picking up on by filtering out disposed cases? Theoretically one could FTA on a disposed case while out on pretrial for an undisposed case, do we need to account for this in looking for FTAs during the pretrial period?
court_war <- court_war %>%
  arrange(war_date) %>%
  group_by(court_case_id) %>%
  mutate(court_fta_flag = max(court_fta_flag),
         court_fta_flag_count = sum(court_fta_flag),
         court_sup_vio_post_flag = max(court_sup_vio_post_flag),
         court_sup_vio_post_flag_count = sum(court_sup_vio_post_flag)) %>%
  ungroup() %>%
  distinct(court_case_id, .keep_all = T) %>%
  select(-c(warrant_code, warrant_type, warrant_description))



# Court hearings are filtered for arraignment information and collapsed to court case id. 
court_hearing <- court_hearing %>%
  filter(hearing_type == "Arraignment") %>%
  rename(arraignment_date_time = hearing_date_time,
         arraignment_date = hearing_date) %>%
  arrange(arraignment_date_time) %>%
  distinct(court_case_id, .keep_all = T) %>%
  select(court_case_id, local_id, arraignment_date_time, arraignment_date)

# Court filings from DA data
da_df <- da_df %>%
  select(court_case_id, file_date)

# All data is joined.
court_df <- reduce(list(court_dispo, court_fta, court_war, court_hearing, da_df), left_join, by = "court_case_id") %>%
  select(-contains(".y")) %>%
  select(-contains(".x.x")) %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x", "", .))) %>%
  mutate(final_disposition_date = if_else(disposition_date <= sentence_date|is.na(sentence_date), disposition_date, sentence_date))


```


Court Diagnostics
```{r eval=FALSE, include=FALSE}

# Diagnostic Code for Charge Hierarchy
# 1 - 7,901/267,372 = 97% non-match rate
# (1 - nrow(court_charge %>% filter(is.na(hierarchy)))/nrow(court_charge))*100
# (1 - nrow(court_charge %>% filter(court_charge_level %in% c("F", "M")) %>% filter(is.na(hierarchy)))/nrow(court_charge))*100



# court_charge %>%
#   filter(is.na(hierarchy)) %>%
#   count(join_var) %>%
#   arrange(desc(n))

# charge_hier %>%
#   filter(grepl("231035", charge))

# table(court_charge$court_charge_original)[order(table(court_charge$court_charge_original), decreasing = T)]
# table(court_charge$court_charge)[order(table(court_charge$court_charge), decreasing = T)]
# table(court_charge$court_charge_code_original)[order(table(court_charge$court_charge_code_original), decreasing = T)]
# table(court_charge$court_charge_code_original)[order(table(court_charge$court_charge_code_original), decreasing = T)]


# court_charge %>% filter(grepl("Attempt|attempt", court_charge_description))
# 
# court_charge %>% filter(grepl("664", court_charge_original))
# 
# court_war %>% count(warrant_type) #under what circumstance would you get a warrant for "Failed to Comply with Court Order"? is this pretrial?
# 
# court_war %>% filter(grepl("FTA", warrant_type))
# 
# court_war %>% filter(warrant_type == "Failed to Comply with Court Order")
# 
# court_charge %>% count(disposition_type_original) %>% arrange(desc(n))
# 
# court_charge %>% count(sentence_type_original, sentence_type) %>% arrange(desc(n))
# 
# court_hearing %>% count(hearing_type_original) %>% arrange(desc(n))



# court_charge %>% 
#   filter(court_qualifier_flag == 1) %>% 
#   select(court_charge_original, court_charge_level, court_charge_code, court_charge, court_charge_description) %>%
#   unique()# %>%
#   #write.xlsx(file = "qualifier_codes_for_Noah_Napa_Court.xlsx")


court_charge %>%
  count(court_charge_original) %>%
  arrange(desc(n))

court_charge %>%
  # filter(arrest_charge_level_original == "SA") %>%
  count(court_charge_original) %>%
  arrange(desc(n))

court_charge %>%
  count(court_charge_code)

court_charge %>%
  count(court_charge_level)

court_charge %>%
  count(court_charge) %>%
  arrange(desc(n))

#No Ambiguity
court_charge %>%
  count(court_charge, court_charge_original) %>%
  group_by(court_charge) %>%
  add_count() %>%
  filter(n > 1)


# court_charges
# 
# court_charges %>%
#   filter(grepl("TR", court_docket_id)) %>%
#   count(charge_level)
# 
# court_charges <- court_charges %>%
#   filter(!grepl("TR|JQ", court_docket_id)) 
# 
# court_charges %>%
#   filter(grepl("RV", court_docket_id))

  
  # court_charges %>%
  #   count(disposition_type)

#sum(court_dispo$court_misd_flag_count) + sum(court_dispo$court_felony_flag_count)+ sum(court_dispo$court_special_flag_count)


# court_charges %>%
#   filter(!is.na(disposition_date)) %>%
#   distinct(court_case_id)

# court_fta %>%
#   distinct(court_case_id, fta_date)

# court_war %>%
#   distinct(court_case_id, local_id)


#court_df contains duplicate information
# court_df %>%
#   left_join(court_fta)


# court_plea <- court_charges %>%
#   arrange(plea_date) %>%
#   mutate(guilty_flag = if_else(plea_type == "Guilty", 1, 0)) %>%
#   group_by(court_case_id) %>%
#   filter(guilty_flag == 1|sum(guilty_flag) == 0) %>%
#   ungroup() %>%
#   distinct(court_case_id, .keep_all = T) %>%
#   select(court_case_id, court_docket_id, plea_date, plea_type)


# court_sent <- bind_rows(court_sent_prob, court_sentence, court_sent_dl_cond) %>%
#   arrange(sentence_date) %>%
#   distinct(court_case_id, .keep_all = T) %>%
#   select(court_case_id, court_docket_id, sentence_date, sentence_type)

# court_sent_dl_cond
# court_sent_prob
# court_sentence
# 
# court_sentence %>%
#   count(sentence_location) %>%
#   arrange(desc(n))
# 
# court_sent_prob %>%
#   count(sentence_location) %>%
#   arrange(desc(n))


# court_hearings %>%
#   filter(is.na(hearing_type))
#   count(hearing_type)
#   
#   court_fta %>%
#     count(fta_date)

# names(court_dispo)
# names(court_fta_war)
# names(court_hearing)
# names(court_plea)
# names(court_sent)
# court_df %>%
#   names()


# Diagnostics
court_fta %>%
  count(fta_all_flag)

court_fta_war %>%
  count(fta_flag)

full_join(court_fta %>% filter(fta_all_flag == 1), court_fta_war %>% filter(fta_flag == 1) %>% rename(fta_date = fta_war_date), by = c("court_case_id", "fta_date")) %>%
  filter(fta_all_flag != fta_flag) %>%
  add_count(court_case_id) %>%
  filter(n > 1) %>%
  arrange(court_case_id, fta_date)

court_hearing %>%
  count(hearing_type_original) %>%
  arrange(desc(n))
  
court_charge %>%
  filter(stage %in% c("DISPOSITION EVENT")) %>%
  select(-c(disposition_num, charge_id, charge_history_id, offense_id, disposition_hist_id, disposition_id, disposition_type_code, amend_reason_id, amend_reason))
  # filter(stage %in% c("Sentence Event")) %>%
  count(dispos) %>%
  arrange(desc(n))
  
court_dispo %>%
  distinct(court_case_id, disposition_date, .keep_all = T) %>%
  add_count(court_case_id) %>%
  filter(n > 1) %>%
  arrange(desc(n))

court_charge %>%
  filter(stage %in% c("PLEA EVENT")) %>%
  count(disposition_type_original) %>%
  arrange(desc(n))
  distinct(court_case_id, disposition_date, .keep_all = T) %>%
  add_count(court_case_id) %>%
  filter(n > 1) %>%
  arrange(desc(n))
  # select(-c(disposition_num, charge_id, charge_history_id, offense_id, disposition_hist_id, disposition_id, disposition_type_code, amend_reason_id, amend_reason))
  # filter(stage %in% c("Sentence Event")) %>%
  count(dispos) %>%
  arrange(desc(n))

court_charge %>%
  # filter(stage %in% c("CASE FILING")) %>%
  # filter(stage %in% c("SENTENCE EVENT", "DISPOSITION EVENT")) %>%
  # distinct(court_case_id) 
  count(stage)
  filter(court_case_id == "921214")

  court_df %>%
    filter(conviction_flag == 1) %>%
    filter(!disposition_type %in% c("Guilty", "Nolo_Contendere")) %>%
    count(disposition_type, sentence_type) %>%
    #count(court_charge_code, court_charge_level) %>%
    arrange(desc(n))

  court_fta
  court_war
  
  court_df %>%
  filter(conviction_flag == 1, conviction_felony_flag == 0, conviction_misd_flag == 0, conviction_qualifier_flag == 0) %>%
  select(court_felony_flag, court_misd_flag, court_qualifier_flag)
  # count(conviction_felony_flag, conviction_misd_flag, conviction_minor_flag)
  

  
```



Assessment Data
```{r}

#Probation data on assessments performed from 
  ##prob_df contains one row per assessment question, and has information on risk score, risk level, assessment date, and zip code
prob_df <- read_excel("Historical Data Submissions/Napa/P2 Submission-June 30/Historical_7-1-2020_2.xlsx", sheet = 12)

names_df1 <- tibble(original_field = names(prob_df)) 

# Variable name standardization--See pg. xxx for more details. 
names(prob_df) <- c("local_id", "zip_code", "assessment_id", "assessment_date", "item_label", "assessment_item", "assessment_response", "risk_score", "risk_level_original")

names_df1$field <- names(prob_df)

# Date Reformatting--See pg. xxx for more details.
prob_df <- prob_df %>%
  mutate(assessment_date = as_date(assessment_date))


# Standardize Factors--See pg. xxx for more details.
prob_df <- prob_df %>%
  mutate(risk_level = case_when(risk_level_original %in% c("High") ~ "High",
                                risk_level_original %in% c("Moderate") ~ "Medium",
                                risk_level_original %in% c("Low") ~ "Low"),
         tool_name = "ORAS"
  )

prob_df <- prob_df %>%
  select(-assessment_item) %>%
  mutate(item_label = str_c("oras_tool_response_", str_extract(item_label, ".$"))) %>%
  pivot_wider(names_from = item_label, values_from = assessment_response) %>%
  mutate(oras_tool_response_1 = if_else(oras_tool_response_1 == "Under 33", 1, 0),
         oras_tool_response_2 = case_when(oras_tool_response_2 == "None" ~ 0,
                                          oras_tool_response_2 == "One Warrant for FTA" ~ 1,
                                          oras_tool_response_2 == "Two or more FTA Warrants" ~ 2),
         oras_tool_response_3 = if_else(oras_tool_response_3 == "Yes", 1, 0),
         oras_tool_response_4 = case_when(oras_tool_response_4 == "Yes, Full-time" ~ 0,
                                          oras_tool_response_4 == "Yes, Part-time" ~ 1,
                                          oras_tool_response_4 == "Not employed" ~ 2),
         oras_tool_response_5 = if_else(oras_tool_response_5 == "Not Lived at Same Residence", 1, 0),
         oras_tool_response_6 = if_else(oras_tool_response_6 == "Yes", 1, 0),
         oras_tool_response_7 = if_else(oras_tool_response_7 == "Yes", 1, 0))

#Flags
prob_df <- prob_df %>%
  mutate(assess_flag = if_else(is.na(assessment_date), 0, 1))


####

##prob_bookings contains mostly one row per book_num. There are a few duplicated rows which are eliminated, and one case where a book_num has two rows with the only difference is one has excluded value 1 the other has excluded value 0. 
## this table can link pretrial_id with assessment_id across the other tables
## prob_bookings has date range 2020-02-05 to 2020-06-30
prob_bookings <- read_excel("Historical Data Submissions/Napa/P2 Submission-June 30/Historical_7-1-2020_ProbData_4.xlsx", sheet = 1) %>%
  distinct()

names_df2 <- tibble(original_field = names(prob_bookings)) 

# Variable name standardization--See pg. xxx for more details. 
names(prob_bookings) <- c("pretrial_id", "local_id", "book_num", "assessment_id", "no_assessment_reason", "book_date_time", "excluded")

names_df2$field <- names(prob_bookings)
## as per Dan Glascott on call 7.16.20, "excluded" indicates whether defendant is excluded from pre-arraignment release

# Date Reformatting--See pg. xxx for more details.
prob_bookings <- prob_bookings %>%
  mutate(book_date = as_date(book_date_time))


####

##prob_reports contains one row per book_num and report_type combination (aka a single book_num will have multiple rows if it has both a pre-arraignment report and an arraignment report). There are two book_num instances that have more rows than this (one with two different release decisions, and the other with multiple report times over the same date and different release decisions). Not sure what is happening in those special cases. 
## prob_reports has date range 2020-03-16 to 2020-06-30
prob_reports <- read_excel("Historical Data Submissions/Napa/P2 Submission-June 30/Historical_7-1-2020_ProbData_4.xlsx", sheet = 2)

names_df3 <- tibble(original_field = names(prob_reports)) 

# Variable name standardization--See pg. xxx for more details. 
names(prob_reports) <- c("pretrial_id", "local_id", "book_num", "report_date_time", "report_type", "release_recommendation_original", "release_decision_original")

names_df3$field <- names(prob_reports)

# Date Reformatting--See pg. xxx for more details.
prob_reports <- prob_reports %>%
  mutate(report_date = as_date(report_date_time))

# Standardize Factors--See pg. xxx for more details.
prob_reports <- prob_reports %>%
  mutate(release_recommendation = case_when(release_recommendation_original %in% c("Detain") ~ "Detain",
                                            release_recommendation_original %in% c("Supervised OR") ~ "Monitor",
                                            release_recommendation_original %in% c("Jail Released") ~ "Ineligible",
                                            T ~ "Other_Unknown"),
         release_decision = case_when(release_decision_original %in% c("Detain") ~ "Detain",
                                      release_decision_original %in% c("OR") ~ "OR",
                                      release_decision_original %in% c("Supervised OR") ~ "Monitor",
                                      release_decision_original %in% c("Sentenced", "No Complaint") ~ "Ineligible",
                                      T ~ "Other_Unknown"),
         pretrial_ineligible_reason = case_when(release_decision_original %in% c("Sentenced", "No Complaint") ~ "Case_Disposed",
                                                T ~ "Other_Unknown"))


#Flags

prob_reports <- prob_reports %>%
  mutate(rec_release_flag = if_else(release_recommendation %in% c("OR", "Monitor"), 1, 0),
         decision_release_flag = if_else(release_decision %in% c("OR", "Monitor"), 1, 0),
         release_override_flag = if_else(rec_release_flag != decision_release_flag &
                                            !release_recommendation %in% c("Ineligible", "Other_Unknown") &
                                            !release_decision %in% c("Ineligible", "Other_Unknown"), 1, 0))


##TO ASK: what does a release recommendation of "Jail Released" mean?

####


prob_case <- read_excel("Historical Data Submissions/Napa/P2 Submission-June 30/Historical_7-1-2020_ProbData_4.xlsx", sheet = 3)

names_df4 <- tibble(original_field = names(prob_case)) 

# Variable name standardization--See pg. xxx for more details. 
names(prob_case) <- c("pretrial_id", "local_id", "court_case_id", "case_type", "case_status", "case_status_date_time")

names_df4$field <- names(prob_case)

prob_case <- prob_case %>%
  mutate(case_status_date = as_date(case_status_date_time))

prob_case %>%
  add_count(court_case_id) %>%
  filter(n>1, court_case_id != "NULL") %>%
  arrange(court_case_id, case_status_date)

prob_case %>%
  filter(case_type == "Pretrial SOR")

## TO ASK: is there a way to determine termination information from prob_case? e.g. does "Revoked" case_status mean a violation? is any case_status beside "Active" mean a termination? what is happening with case_type "Pretrial" vs "Pretrial SOR"? Does "Jail Released" case_status mean they bailed out? what does it mean if a person has multiple pretrial_ids for one court_case_id? why does this table have pretrial_id but the prob_df table has assessment_id?

## make a separate code book for this table with counts of case_type and case_status


prob_cond <- read_excel("Historical Data Submissions/Napa/P2 Submission-June 30/Historical_7-1-2020_ProbData_4.xlsx", sheet = 4)

names_df5 <- tibble(original_field = names(prob_cond)) 

# Variable name standardization--See pg. xxx for more details. 
names(prob_cond) <- c("pretrial_id", "local_id", "court_case_id", "condition_status", "release_conditions_original")

names_df5$field <- names(prob_cond)


#Flags

prob_cond <- prob_cond %>%
  mutate(
         #rec_em_flag = if_else(grepl("SCRAM", toupper(release_recommendation_original)), 1, 0),
         # rec_phone_flag = if_else(),
         # rec_inperson_flag = if_else(),
         # rec_drug_test_flag = if_else(grepl("TEST", toupper(release_recommendation_original)), 1, 0),
         # rec_other_flag = if_else(),
         condition_em_flag = if_else(grepl("ELECTRONIC MONITOR|GPS|SCRAM", toupper(release_conditions_original)), 1, 0),
         # Discuss release_conditions_original with Kings along with their original materials to determine phone and inperson flag.
         # condition_phone_flag = if_else(),
         # condition_inperson_flag = if_else(),
         ## Does test as requested entail a request flag? What is the treatment program?
         # condition_drug_test_flag = if_else(grepl("SCRAM|TEST", toupper(release_conditions_original)), 1, 0),
         condition_no_contact_flag = if_else(grepl("NOT TO CONTACT|136", toupper(release_conditions_original)), 1, 0),
         #court_date_reminder_flag = if_else(court_date_reminder_original == "Yes", 1, 0),
         # Transit service doesn't actually exist here.
         #transit_service_flag = if_else(grepl("BUS", toupper(other_pretrial_service_original)), 1, 0),
         ## Are all violations violations that result in termation?
         #pretrial_violation_flag = if_else(!is.na(pretrial_violation_original), 1, 0))
  )



## Ask about the condition "install a GPS or SCRAM device at the discretion of the Probation Officer". Ask about condition "I promise not to contact" when it involves a place -- could this just be like a stayaway from a store or is it always a no contact about a person? Does everyone get court date reminders? Is the "submit to blood, breath, or urine test, if requested" condition an actual drug test condition or more like a rights waiver? Are the levels of supervision recorded anywhere?

####

## probation data is missing several fields, including: release_authorization (though this can be figured out through release_recommendation which indicates if it was a sheriff release), pretrial terms and conditions, violation of PTR, PTR violation date, court date reminder, other pretrial services, termination outcome, termination date
## as per call with Dan Glascott 7.16.20 he will give us more data
## new data acquired 7/23/20


#Integrated criminal justice Demographic and Personal Identification
  ## person_df contains one row per person (local_id) with demographic information on the person
  ## Napa has an integrated criminal justice system, so this is just a person table, without any booking or event information
  ## Historical_7-1-2020 was missing sex, so Historical_7_1_2020_2 was submitted with sex included
person_df <- read_excel("Historical Data Submissions/Napa/P2 Submission-June 30/Historical_7-1-2020_2.xlsx", sheet = 1)

names_df6 <- tibble(original_field = names(person_df)) 

# Variable name standardization--See pg. xxx for more details. 
names(person_df) <- c("fbi", "cii", "local_id", "cdl_id", "cdl_id_state", "name", "dob", "race_original", "sex_original") 

names_df6$field <- names(person_df)

# Standardize Factors--See pg. xxx for more details.
person_df <- person_df %>%
  mutate(race = case_when(race_original %in% c("Black") ~ "Black",
                          race_original %in% c("Hispanic") ~ "Hispanic",
                          race_original %in% c("White") ~ "White",
                          T ~ "Other_Unknown"),
         sex = case_when(sex_original %in% c("M") ~ "Male",
                         sex_original %in% c("F") ~ "Female",
                         T ~ "Other_Unknown")
  )


```


Probation diagnostics
```{r}
prob_df %>%
  distinct(assessment_id, .keep_all = T)

prob_bookings %>%
  distinct(assessment_id, .keep_all = T)

prob_reports %>%
  distinct(book_num)

prob_cond %>%
  distinct(local_id, court_case_id)

prob_cond %>%
  filter(local_id == 201101473 & court_case_id == "19CR002008")

prob_bookings
prob_reports
prob_df
prob_cond
prob_case

prob_case %>%
  distinct(local_id, court_case_id)

prob_case %>%
  distinct(assessment_id)

prob_case %>%
  distinct(local_id) %>%
  semi_join(prob_df, by = "local_id")

prob_reports %>%
  count(release_decision_original)

prob_case %>%
  count(case_status)

prob_bookings %>%
  distinct(assessment_id) %>%
  mutate(assessment_id = as.numeric(assessment_id)) %>%
  semi_join(prob_df, by = "assessment_id")

prob_cond %>%
  distinct(pretrial_id)

prob_case %>%
  distinct(pretrial_id)

prob_bookings %>%
  distinct(pretrial_id) %>%
  semi_join(prob_reports, by = "pretrial_id")
```

Assessment collapse
```{r}

#this join is not very good.

assess_df <- prob_df %>%
  mutate(assessment_id = as.character(assessment_id)) %>%
  left_join(prob_bookings) %>%
  left_join(prob_reports) %>%
  left_join(person_df) %>%
  left_join(prob_cond) %>%
  left_join(prob_case) %>%
  distinct(local_id, assessment_date, .keep_all = T)

# assess_df %>%
#   filter(!is.na(assessment_date))
#   distinct(pretrial_id)
  
prob_df %>%
  mutate(assessment_id = as.character(assessment_id)) %>%
  semi_join(prob_reports)

prob_reports %>%
  anti_join(prob_df)

```

Assessment code book (9/2020) 
```{r}

names_df <- bind_rows(names_df1, names_df2, names_df3, names_df4, names_df5, names_df6)

names_df <- names_df %>%
  mutate(
    modified_field = case_when(
      field == "sex_original" ~ "sex",
      field == "race_original" ~ "race",
      field == "risk_level_original" ~ "risk_level",
      field == "release_recommendation_original" ~ "release_recommendation",
      field == "pretrial_release_type_original" ~ "release_decision",
      field == "release_decision_original" ~ "release_decision, pretrial_ineligible_reason",
      field == "release_conditions_original" ~ "condition_em_flag, condition_no_contact_flag"
      #field == "release_authorization_original" ~ "release_authorization",
      #field == "court_date_reminder_original" ~ "court_date_reminder_flag",
      #field =="pretrial_violation_original" ~ "pretrial_violation_flag")
    )) %>%
  filter(!is.na(modified_field)) %>%
  separate_rows(modified_field, sep = ",") %>%
  mutate_all(trimws)



factor_df <- lapply(c('prob_df', 'person_df', 'prob_reports'), function(i){
  df <- get(i)
  
  df <- lapply(c(1:nrow(names_df))[names_df$field %in% names(df)], function(j){
    df <- df %>%
      select(value = names_df$field[j], 
             modified_value = names_df$modified_field[j]) %>%
      group_by_all() %>%
      count() %>%
      arrange(desc(n)) %>%
      group_by(modified_value)  %>%
      summarise(value = paste(value, collapse = ", "), n = sum(n)) %>%
      ungroup() %>%
      mutate(percent = round(n/sum(n)*100, 1),
             total = sum(n)) %>%
      mutate(field = names_df$field[j], modified_field = names_df$modified_field[j]) %>%
      arrange(desc(n)) %>%
      select(field, modified_field, value, modified_value, n, percent, total) %>%
      mutate_all(as.character)
      
      
    
    return(df)
  }) %>% bind_rows()
 
  df <- df %>% mutate(table_name = i)
   }) %>% 
  bind_rows() %>%
  left_join(names_df) %>%
  select(table_name, original_field, field, modified_field, value, modified_value, total, percent)
  
##not needed because no complex logic
# factor_df <- factor_df %>%
#   # mutate(value = case_when(
#   # modified_field == "pretrial_ineligible_reason" & modified_value == "Bail_Bond" ~ "pretrial_release_type_original = 'Posted Bail' OR release_recommendation_original = 'Posted Bail'",
#   # modified_field == "pretrial_ineligible_reason" & modified_value == "Case_Disposed" ~ "pretrial_release_type_original = ('No Complaint Filed', 'Time Served') OR release_recommendation_original = ('No Complaint Filed', 'Time Served')",
#   # modified_field == "pretrial_ineligible_reason" & modified_value == "Other_Unknown" ~ "Other Values",
#   # T ~ value)) %>%
#   # filter(modified_field == "pretrial_ineligible_reason") %>%
#   group_by(modified_field, value) %>%
#   mutate_at(vars(original_field, field), funs(paste(., collapse = ", "))) %>%
#   distinct(modified_field, value, .keep_all = T) %>%
#   ungroup() %>%
#   slice(-13)


flag_df <- lapply('prob_cond', function(i){
  df <- get(i)
  
  df <- lapply(c(1:nrow(names_df))[grepl("flag", names_df$modified_field)], function(j){
    df <- df %>%
      select(value = names_df$field[j], modified_value = names_df$modified_field[j]) %>%
      group_by_all() %>%
      count() %>%
      arrange(desc(n)) %>%
      group_by(modified_value) %>%
      summarise(value = paste(value, collapse = ", "), n = sum(n)) %>%
      ungroup() %>%
      mutate(percent = round(n/sum(n)*100, 1),
             total = sum(n)) %>%
      mutate(field = names_df$field[j], modified_field = names_df$modified_field[j]) %>%
      arrange(desc(n)) %>%
      select(field, modified_field, value, modified_value, n, percent, total) %>%
      mutate_all(as.character)
    
    return(df)
  }) %>% bind_rows() 
  
 df <- df %>% mutate(table_name = i)
   }) %>%

  bind_rows() %>%
  left_join(names_df) %>%
  select(table_name, original_field, field, modified_field, value, modified_value, total, percent)


flag_df <- flag_df %>%
  filter(modified_value == 1) %>%
  mutate(value = case_when(
  modified_field == "condition_no_contact_flag" & modified_value == "1" ~ "MATCHES (NOT TO CONTACT)",
  modified_field == "condition_em_flag" & modified_value == "1" ~ "MATCHES (SCRAM, ELECTRONIC MONITOR, GPS)",
  #modified_field == "pretrial_violation_flag" & modified_value == "1" ~ "IF pretrial_violation_original EXISTS",
  T ~ value)) %>%
  # filter(modified_field == "pretrial_ineligible_reason") %>%
  group_by(modified_field, value) %>%
  mutate_at(vars(original_field, field), funs(paste(., collapse = ", "))) %>%
  distinct(modified_field, value, .keep_all = T) %>%
  ungroup()
  



date_df <- lapply(ls()[!grepl("original|^df|hier|names|factor|date|flag", ls())], function(i){
  df <- get(i)
  
   if(sum(grepl("date", names(df))) > 0){
  df2 <- df %>%
  select(contains("date"), -contains("time"), -contains("court")) %>%
  gather("field", "value") %>%
  group_by(field) %>%
  summarise_all(funs(min_date = as.character(min(., na.rm = T)),  max_date = as.character(max(., na.rm = T)))) %>%
    mutate(table_name = i)
  }else{
    df2 <- tibble(field = NA_character_, min_date = NA_character_,  max_date = NA_character_, table_name = i)
  }
}) %>%
  bind_rows() %>%
  select(table_name, field, min_date, max_date) %>%
  filter(!is.na(field))
  

case_df <- prob_case %>%
  count(case_type, case_status) %>%
  arrange(case_type, desc(n))

#write.xlsx(list(factor_df, flag_df, date_df, case_df), file = "G:/CrimJustice/PretrialAssessmentPilot/Code Books/Assessment Code Book/Napa Assessment Code Book 9-20.xlsx", asTable = T, tableStyle = "TableStyleMedium1", colWidths = "auto", sheetName = c("Factors", "Flags", "Dates", "Case status"))

```


Assessment Tables 
```{r}
assess_table <- assess_df %>%
  # Collapse to each assessment.
  #distinct(pretrial_id, .keep_all = T) %>%
  # Filter for only those actually assessed
  filter(!is.na(assessment_date)) %>%
  # Create county name.
  mutate(county = "Napa",
         pretrial_termination_outcome = NA_character_,
         pretrial_termination_reason = NA_character_) %>%
  # Select relevants variables.
  select(county, risk_level, release_recommendation, release_decision, assessment_date, risk_score, tool_name, assessment_date, dob, sex, race, pretrial_termination_outcome, pretrial_termination_reason, book_num)

# Save file  
#fwrite(assess_table, file = "G:/CrimJustice/PretrialAssessmentPilot/Assessment Output Tables/Napa Assessment Output 09-2020.csv")
#shell.exec("G:/CrimJustice/PretrialAssessmentPilot/Assessment Output Tables")

```

Assessment Tables 10/2020
```{r}

book_join <-  book_df %>%
  select(book_num, charge_level) %>%
  mutate(charge_level = ordered(charge_level, levels = c("Other", "I", "M", "F"))) %>%
  group_by(book_num) %>%
  mutate(charge_level = max(charge_level, na.rm = T)) %>%
  ungroup() %>%
  distinct(book_num, .keep_all = T) %>%
  mutate(book_num = as.numeric(book_num))

assess_table <- assess_df %>%
  # Collapse to each assessment.
  #distinct(pretrial_id, .keep_all = T) %>%
  # Filter for only those actually assessed
  filter(!is.na(assessment_date)) %>%
  left_join(book_join) %>%
  # Create county name.
  mutate(county = "Napa",
         pretrial_termination_outcome = NA_character_,
         pretrial_termination_reason = NA_character_,
         monitor_level = NA_character_) %>%
  # Select relevants variables.
  select(county, risk_level, release_recommendation, release_decision, assessment_date, risk_score, tool_name, assessment_date, dob, sex, race, charge_level, monitor_level, pretrial_termination_outcome, pretrial_termination_reason)

# Save file  
#fwrite(assess_table, file = "G:/CrimJustice/PretrialAssessmentPilot/Assessment Output Tables/Napa Assessment Output 10-2020.csv")
#shell.exec("G:/CrimJustice/PretrialAssessmentPilot/Assessment Output Tables")

```


Code Book
```{r eval=FALSE, include=FALSE}
rm(original_field)

original_df <- bind_rows(original_df)

Napa_df <- lapply(ls()[!grepl("original", ls())], function(i){
  df <- get(i)
  
  if(sum(grepl("date", names(df))) > 0){
  df2 <- df %>%
  select(contains("date"), -contains("time")) %>%
  gather("modified_field", "value") %>%
  group_by(modified_field) %>%
  summarise_all(funs(min = as.character(min(., na.rm = T)), mean = as.character(mean(., na.rm = T)), max = as.character(max(., na.rm = T))))
  }else{
    df2 <- tibble(modified_field = NA_character_, min = NA_character_, mean = NA_character_, max = NA_character_)
  }
  
  df <- df %>%
    mutate_if(~length(unique(.)) > 50|is.Date(.)|is.POSIXct(.), ~(. = "not_factor")) %>%    
    mutate_all(~if_else(is.na(.), "na_missing", as.character(.))) %>%
    gather(modified_field, factor_value) %>%
    count(modified_field, factor_value) %>%
    mutate(table_name = i, county = "Napa") %>%
    mutate(factor_flag = if_else(factor_value == "not_factor", 0, 1)) %>%
    group_by(table_name, modified_field) %>%
    mutate(table_count = sum(n)) %>%
    ungroup() %>%
    rename("factor_count" = "n") %>%
    mutate(factor_count = if_else(factor_value == "not_factor", NA_integer_, factor_count),
           factor_percent = round(factor_count/table_count*100, 1)) %>%
    arrange(desc(factor_flag), modified_field, desc(factor_count))
  
  df <- left_join(df, df2, by = "modified_field")
    }) %>% 
  bind_rows() %>%
  left_join(original_df) %>%
   select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_count,
           factor_percent, table_count, min, mean, max) 

write.xlsx(Napa_df, file = "Code Books/Napa Code Book.xlsx")
```

Factors codebook
```{r}
factor_df <- lapply(ls()[!grepl("original|^df|hier", ls())], function(i){
  df <- get(i)
  if(sum(grepl("original", names(df))) == 0){
    return(NULL)
  }else{
    var_names <- names(df)[grepl("original", names(df))]
    var_names2 <- gsub("_original", "", var_names)
   
    df1 <- df %>%
     select(var_names) %>%
     gather(original_field, original_value)
   
    df2 <- df %>%
     select(var_names2) %>%
     gather(modified_field, modified_value)
   
   df <- bind_cols(df1, df2) %>%
     count(original_field, modified_field, original_value, modified_value) %>%
     arrange(modified_field, desc(n)) %>%
     group_by(modified_field) %>%
     mutate(row = row_number(),
            percent = round(n/sum(n)*100)) %>%
     ungroup() %>%
     filter(row <= 50) %>%
     select(-row) %>%
     rename("total" = n)
   }
  }) %>%
  bind_rows()

#write.xlsx(factor_df, file = "G:/CrimJustice/PretrialAssessmentPilot/Code Books/Factor Code Book/Napa Factor Code Book.xlsx", asTable = T, tableStyle = "TableStyleMedium1", colWidths = "auto")
```


Completion
```{r}
files <- list.files("G:/CrimJustice/PretrialAssessmentPilot/Code Books/Code Book Notes", pattern = "Napa", full.names = T)

df <- lapply(files, read_excel)

df[[2]] <- df[[1]] %>%
  mutate(factor_standard = "") %>%
  select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_standard, factor_count, factor_percent, 
         table_count, "nl_notes_1" = collapsed_value, "nl_notes_2" = notes, min, mean, max)

df <- list(df[[2]], df[[1]])

#write.xlsx(df, file = "G:/CrimJustice/PretrialAssessmentPilot/Code Books/Variable Construction/Napa Factor Construction.xlsx", asTable = T, tableStyle = "TableStyleMedium1", sheetName = c("Variable Construction", "nl_notes"))
```


Join
  Jail Court Join
```{r}
# Remove extraneous objects in the environment
rm(list = ls()[!ls() %in% ls(pattern = "df")])

#Check for common variables
names(book_df)[names(book_df) %in% names(prob_df)]
#local_id

names(book_df)[names(book_df) %in% names(court_df)]
#court_case_id and local_id


names(court_df)

#Turning NULL to NA to ensure non matching and removing generic charge info from data frames
book_df <- book_df %>%
  mutate_if(is.character, list(~na_if(., "NULL"))) %>%
  select(-c(charge, charge_level, charge_code)) %>%
  mutate_at(vars(name), toupper)

assess_df <- assess_df %>%
  mutate_if(is.character, list(~na_if(., "(Missing)"))) 


court_df <- court_df %>%
  mutate_if(is.character, list(~na_if(., "NULL"))) %>%
  select(-c(charge, charge_level, charge_code))  #%>%
  #mutate_at(vars(first_name, last_name), toupper) %>%
  #mutate(court_case_id = as.character(court_case_id))

# #Joining Assessment to Jail Data
# #4.13.20 -- this join is not working, I did a fuzzy join after the jail-court join. some assessments are still duplicating records because of the jail bookings still having duplicates (because they map to unique court case ids). will need a final collapse later.
# join1 <- inner_join(book_df, assess_df, by = c("local_id"), na_matches = "never") %>%
#   rename_at(vars(contains(".x")), funs(gsub("\\.x$", "", .))) %>%
#   select(-contains(".y")) %>%
#   #1 Duplicate with missing dispositions which will be dropped later. 
#   distinct()
# 
# join1 <- fuzzy_inner_join(book_df, assess_df, 
#                 by=c("local_id", "book_date"="assessment_date", "release_date"="assessment_date"),
#                 match_fun=list(`==`, `<=`, `>=`)) 
# 
# join1 %>%
#   group_by(book_num) %>%
#   add_count() %>%
#   filter(n>1) #%>%
#   # arrange(assessment_id) %>%
#   # select(local_id.x, assessment_id, book_date, assessment_date, release_date)
# 
# assess_df %>%
#   select(local_id)
# 
# book_df %>%
#   select(local_id)
# 
# j1 <- anti_join(book_df, assess_df, by = "book_num", na_matches = "never")
# a1 <- anti_join(assess_df, book_df, by = "book_num", na_matches = "never")
# 
# book_df %>%
#   select(contains("date"))
# 
# assess_df %>%
#   select(assessment_date) %>%
#   mutate(assessment_date = as_date(assessment_date))
# 
# 
#   #Examine if set of common variables is distinct--yes
#   semi_join(book_df, assess_df, by = "book_num", na_matches = "never") %>%
#     distinct()
# 
# #Joining on Name and Court ID
# join2 <- inner_join(j1, a1, by = c("first_name", "last_name", "book_date" = "interview_date"), 
#                     na_matches = "never") %>%
#   rename_at(vars(contains(".x")), funs(gsub("\\.x$", "", .))) %>%
#   select(-contains(".y")) %>%
#   #1 Duplicate with missing dispositions which will be dropped later. 
#   distinct()
# 
# j2 <- anti_join(j1, a1, by = c("first_name", "last_name", "book_date" = "interview_date"), na_matches = "never")
# a2 <- anti_join(a1, j1, by = c("first_name", "last_name", "interview_date" = "book_date"), na_matches = "never")
# 
#   #Examine if set of common variables is distinct--yes
#   semi_join(j1, a1, by = c("first_name", "last_name", "book_date" = "interview_date"), 
#             na_matches = "never") %>%
#     distinct()
#   
# #Diagnostics
#   #Jail and Assessment Matches by category
# tibble(
#   stage = 1:2,
#   match = c(
#     'c("book_num")',
#     'c("first_name", "last_name", "book_date" = "interview_date")'
#   ),
#   # jail_match_rate = sapply(1:2, function(i) {
#   #   (nrow(book_df) - nrow(get(paste0("j", i)))) / nrow(book_df) * 100
#   # }),
#   assess_match_rate = sapply(1:2, function(i) {
#     (nrow(assess_df) - nrow(get(paste0("a", i)))) / nrow(assess_df) * 100
#   })
# )
# 
# #Recreating Booking--Should be same number of rows.
# book_df <- bind_rows(join1, join2, j2)  
# 
# rm(list = ls()[!ls() %in% ls(pattern = "df")])

# Court Matching
#Joining court data to jail data
join1 <- inner_join(book_df, court_df, by = c("court_case_id", "local_id"), na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(paste0("arrest_", gsub("\\.x$", "", .)))) %>%
  rename_at(vars(contains(".y")), funs(paste0("court_", gsub("\\.y$", "", .)))) %>%
  # 8 Duplicates with missing dispositions which will be dropped later. 
  distinct()

j1 <- anti_join(book_df, court_df, by = c("court_case_id", "local_id"), na_matches = "never")
c1 <- anti_join(court_df, book_df, by = c("court_case_id", "local_id"), na_matches = "never")

#   #Examine if set of common variables is distinct--yes except 8 spurious cases.
#   join1 %>%
#     add_count(cii, court_docket_id, book_num, dob) %>%
#     filter(n > 1) %>%
#     arrange(desc(n))
# 
# #Joining on Name and Court ID
# join2 <- inner_join(j1, c1, by = c("court_docket_id", "first_name", "dob"), na_matches = "never") %>%
#   rename_at(vars(contains(".x")), funs(paste0("arrest_", gsub("\\.x$", "", .)))) %>%
#   rename_at(vars(contains(".y")), funs(paste0("court_", gsub("\\.y$", "", .)))) %>%
#   #1 Duplicate with missing dispositions which will be dropped later. 
#   distinct()
# 
# j2 <- anti_join(j1, c1, by = c("court_docket_id", "first_name", "dob"), na_matches = "never")
# c2 <- anti_join(c1, j1, by = c("court_docket_id", "first_name", "dob"), na_matches = "never")
# 
#   #Examine if set of common variables is distinct--yes except 8 spurious cases.
#   join2 %>%
#     add_count(first_name, court_docket_id, book_num) %>%
#     filter(n > 1) %>%
#     arrange(desc(n))
# 
# #Joining on Court ID
# join3 <- inner_join(j2, c2, by = c("court_docket_id", "first_name"), na_matches = "never") %>%
#   rename_at(vars(contains(".x")), funs(paste0("arrest_", gsub("\\.x$", "", .)))) %>%
#   rename_at(vars(contains(".y")), funs(paste0("court_", gsub("\\.y$", "", .)))) %>%
#   #1 Duplicate with missing dispositions which will be dropped later. 
#   distinct()
# 
# j3 <- anti_join(j2, c2, by = c("court_docket_id", "first_name"), na_matches = "never")
# c3 <- anti_join(c2, j2, by = c("court_docket_id", "first_name"), na_matches = "never")
# 
#   #Examine if set of common variables is distinct--yes except 8 spurious cases.
#   join3 %>%
#     add_count(court_docket_id, book_num) %>%
#     filter(n > 1) %>%
#     arrange(desc(n))
#   
# #Diagnostics
#   #Jail and Court Matches by category
# tibble(
#   stage = 1:3,
#   match = c(
#     'c("court_docket_id", "cii", "dob")',
#     'c("court_docket_id", "first_name", "dob")',
#     'c("court_docket_id", "dob")'
#   ),
#   jail_match_rate = sapply(1:3, function(i) {
#     (nrow(book_df) - nrow(get(paste0("j", i)))) / nrow(book_df) * 100
#   }),
#   court_match_rate = sapply(1:3, function(i) {
#     (nrow(court_df) - nrow(get(paste0("c", i)))) / nrow(court_df) * 100
#   })
# )
# 
# join_df <- bind_rows(join1, join2, join3)

join2 <- fuzzy_left_join(join1, assess_df, 
                by=c("local_id", "book_date"="assessment_date", "release_date"="assessment_date"),
                match_fun=list(`==`, `<=`, `>=`))

test <- fuzzy_semi_join(join1, assess_df, 
                by=c("local_id", "book_date"="assessment_date", "release_date"="assessment_date"),
                match_fun=list(`==`, `<=`, `>=`))

join2 %>%
  distinct(book_num, court_case_id, assessment_id)
```



DOJ CII/Linking Extraction
```{r}
# Grab Tables with CII

doj_person <- person_df %>%
  select(cii, fbi, cdl_id, cdl_id_state, dob, race_original, sex_original, name, local_id) %>%
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) %>%
  distinct()

# Examine missing ciis and duplicates on cii. 
doj_person %>% #Off by about 3000 almost all due to missing CII.
  distinct()

doj_person %>% 
  distinct(cii)

doj_person %>% 
  distinct() %>%
  add_count(cii) %>%
  filter(n > 1) %>%
  arrange(desc(n)) %>% 
  View()

#CIIs for DOJ
doj_cii <- doj_person %>%
  select(cii) %>% 
  distinct()

#Create an excel workbook with all data table. Make sure to include the cii table first. 
write.xlsx(list(doj_cii, doj_person), file = "CIIs for DOJ/Napa CIIs and Demographics for DOJ.xlsx", sheetName = c("ciis", "person"))
```

CII extraction 10.2020
```{r}
# Grab Tables with CII
df_list <- lapply(
  ls()[which(lapply(ls(), function(i){
    sum(names(get(i)) %in% "cii")
    }) == 1)],
  function(j){
    df <- get(j)
    df <- df %>%
      select(any_of(c("cii", "cdl_id", "fbi", "name", "last_name", "first_name", "middle_name", "dob", "sex_original", "race_original"))) %>%
       mutate(
         cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) %>%
  distinct()
 
})

# # CIIs from assessment tables
# doj_assess <- bind_rows(df_list[[1]])
# 
# # CIIs from booking tables
# doj_book <- bind_rows(df_list[[2]])
# 
# # CIIs from court tables
# doj_court <- bind_rows(df_list[[3]])

# CIIs from person tables
doj_person <- bind_rows(df_list[[1]])

#CIIs for DOJ
doj_cii <- bind_rows(doj_person %>% select(cii))  %>% 
  distinct() %>%
  filter(nchar(cii) == 10)


#Create an excel workbook with all data table. Make sure to include the cii table first.
#write.xlsx(list(doj_cii, doj_person), file = "G:/CrimJustice/PretrialAssessmentPilot/CIIs for DOJ/October 2020/Napa P2 CIIs and Demographics for DOJ.xlsx", sheetName = c("ciis", "integrated"))
```


# Sacramento

Jail Data
```{r}

# Jail Bookings Data Import--- Sacramento 

# Jail Bookings
book_df <- fread("Historical Data Submissions/Sacramento/P2 Submission-June 30/SacBookingDetail07132020.csv")


names(book_df) <- c("case_id", "book_date_wrong", "release_date_wrong", "registry_num", "registry_sub_num", "book_type_code", "book_type_original", "arrest_charge_level_original", "arrest_charge_original", "arrest_charge_description", "release_type_code", "release_type_original", "release_comment", "charge_date", "charge_release_date", "court_combined_id", "court_case_id", "court_docket_id", "release_line")


book_df <- book_df %>%
  select(-matches("date"))

book_df <- book_df %>%
  mutate(
        arrest_charge_code_original = str_extract(arrest_charge_original, "[A-Z]{3}|[A-Z]{2}"),
        arrest_charge_code = if_else(arrest_charge_code_original %in% c("PC", "VC", "HS", "BP", "WI","US"), arrest_charge_code_original, "Other"),
        arrest_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}","", arrest_charge_original)),
        arrest_charge_level = case_when(
          arrest_charge_level_original == "FEL" ~ "F",
          arrest_charge_level_original == "MIS" ~ "M",
          arrest_charge_level_original == "INF" ~ "I",
          T ~ "Other"
        )) %>%
  unite(join_var, arrest_charge_level, arrest_charge_code, arrest_charge, remove = F)

load("Complete Charge Code Hierarchy.RData")

book_df <- left_join(book_df, charge_hier, by = "join_var")


#Factor Standardization
book_df <- book_df %>%
  mutate(book_type = case_when(book_type_original %in% c("PICKUP (FRESH ARREST)") ~ "On_View",
                               book_type_original %in% c("WARRANT ARREST") ~ "Warrant",
                               book_type_original %in% c("COMMITMENT", "COMMITMENT WARRANT") ~ "Commitment",
                               book_type_original %in% c("PAROLE HOLD", "WARRANTS ENROUTE HOLD", "PC 1275 HOLD", "MISCELLANEOUS HOLD", "STATE HOSPITAL", "JUVENILE HOLD", "2620 HOLD", "EXTRADITION HOLD", "DETAINER HOLD", "PC 1372 HOLD", "RESTORATION OF COMPETENCY HOLD", "DRUG-COURT HOLD", "ENROUTE HOLD", "MEDICAL HOLD", "MILITARY HOLD", "IDENTIFICATION HOLD", "FOREIGN COMMITMENT HOLD") ~ "Hold",
                               book_type_original %in% c("FEDERAL HOLD", "USBP HOLD", "INS HOLD") ~ "Fed",
                               book_type_original %in% c("COURT REMAND REARREST", "O.R. REVOKED REARREST") ~ "Court_Order",
                               book_type_original %in% c("Flash Incarceration", "PROBATION VIOLATION") ~ "Sup_Vio_Post",
                               book_type_original %in% c("") ~ "Unknown",
                               T ~ "Other"),
         
         release_type = case_when(release_type_original %in% c("853.6 CITATION RELEASE") ~ "Cite_Release",
                                  release_type_original %in% c("SENTENCED - COUNTY", "SENTENCED - STATE", "SENT") ~ "Sentenced",
                                  release_type_original %in% c("TIME SERVED") ~ "Time_Served",
                                  release_type_original %in% c("BAIL BOND RELEASE", "CASH BAIL RELEASE") ~ "Bail_Bond",
                                  release_type_original %in% c("NO CHARGES FILED RELEASE", "COURT CASE DISMISSAL", "COURT CASE ACQUITTAL") ~ "Dismissed_Dropped",
                                  release_type_original %in% c("FOREIGN CUSTODY TRANSFER", "FOREIGN HOLD EXPIRED", "FOREIGN PICKUP TIME EXPIRED", "FOREIGN HOLD FORWARDED") ~ "Hold_Release",
                                  release_type_original %in% c("OWN RECOGNIZANCE RELEASE") ~ "OR",
                                  release_type_original %in% c("849B(2) RELEASE", "849B(1) RELEASE") ~ "Detain_Only",
                                  release_type_original %in% c("FILED AS SUPR COURT CASE", "SENT BACK TO MUNI COURT", "") ~ "Unknown",
                                  T ~ "Other")
         )



# Flag Creation

book_df <- book_df %>%
  mutate(arrest_felony_flag = if_else(arrest_charge_level == "F", 1, 0),
         arrest_misd_flag = if_else(arrest_charge_level == "M", 1, 0),
         arrest_sup_vio_post = if_else(arrest_charge_code_original == "PAR" | book_type == "Sup_Vio_Post", 1,0)
         )
#need attempt and qualifier flags




####

## book dates 2020-01-01 to 2020-06-30
#Booking Dates
book_date <- fread("Historical Data Submissions/Sacramento/P2 Submission-June 30/SacBookingMain07132020.csv")


names(book_date) <- c("jail_court_id", "registry_num", "book_date", "release_date", "hours_detained", "days_detained")


book_date <- book_date %>%
  mutate_at(vars(book_date, release_date), funs(time = parse_date_time(., c('%m/%d/%Y %H:%M:%S %p')))) %>%
  mutate(book_date = as_date(book_date_time),
         release_date = as_date(release_date_time))



####


#Jail Bail Amounts
book_bail <- fread("Historical Data Submissions/Sacramento/P2 Submission-June 30/SacBail07132020.csv")


names(book_bail) <- c("jail_court_id", "registry_num", "registry_sub_num", "book_type_code", "bail_amt")



```


Jail Diagnostics
```{r}
book_df
book_date
book_bail
book_date %>%
  distinct(registry_num)

# book_df %>%
#   group_by(arrest_charge_level_original) %>%
#   count()
# 
# book_df %>%
#   filter(arrest_charge_level_original == "") %>%
#   count(arrest_charge_original) %>%
#   arrange(desc(n))


# book_df %>% filter(book_type == "Sup_Vio_Post") %>% count(arrest_charge_code_original)
# 
# book_df %>% filter(arrest_charge_code_original == "PAR") %>% count(book_type)


# Diagnostic Code for Charge Hierarchy
# 1 - 7,901/267,372 = 97% non-match rate

#(1 - nrow(book_df %>% filter(is.na(hierarchy)))/nrow(book_df))*100

# book_df %>%
#   filter(is.na(hierarchy)) %>%
#   count(join_var) %>%
#   arrange(desc(n))
# 
# book_df %>%
#   filter(grepl("11377A", arrest_charge))
# 
# book_df %>%
#   filter(grepl("WARRANT", book_type_original)) %>%
#   count(arrest_charge_level_original)
# 
# charge_hier %>%
#   filter(grepl("1370", charge))

# table(book_df$arrest_charge)[order(table(book_df$arrest_charge), decreasing = T)]
# table(book_df$arrest_charge_code_original)[order(table(book_df$arrest_charge_code_original), decreasing = T)]

# book_df %>%
#   filter(registry_num %in% registry_num[grepl("13700", arrest_charge_original)]) %>%
#   arrange(registry_num) %>%
#   filter(!registry_num %in% registry_num[grepl("273.5|243|242|273.6", arrest_charge_original)])
# 


```



Jail Collapse
```{r}
book_df <- left_join(book_date, book_df)

book_df <- book_df %>%
  mutate(time_first_release = release_date_time - book_date_time) %>%
  mutate(hierarchy = if_else(is.na(hierarchy), 1e6, as.numeric(hierarchy)),
         warrant_flag = if_else(grepl("Warrant", book_type), 1, 0),
         onview_flag = if_else(grepl("On_View", book_type), 1, 0)) %>%
  group_by(registry_num) %>%
  mutate(max_booktype = book_type[hierarchy == min(hierarchy)][1],
         max_arrest_charge = arrest_charge[hierarchy == min(hierarchy)][1],
         max_charge_description = master_charge_description[hierarchy == min(hierarchy)][1],
         max_charge_description = master_charge_description[hierarchy == min(hierarchy)][1],
         max_hier = min(hierarchy)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, as.numeric(.)))) %>%
  mutate_at(vars(contains("flag")), funs("count" = sum(.))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  group_by(registry_num, court_case_id)  %>%
  filter(hierarchy == min(hierarchy)) %>%
  ungroup() %>%
  distinct(registry_num, court_case_id, .keep_all = T)




# Diagnostics
# book_df %>%
#   distinct(local_id, book_date) %>%
#   arrange(local_id) %>%
#   group_by(local_id) %>%
#   add_count() %>%
#   filter(n>1)
# 
# book_df %>%
#   distinct(local_id, book_date) 
```


Court Data
```{r}

# Court Case Data Import--- Sacramento   min "1992-09-01" 1st qu "2020-01-14" to max 2020-07-09

#High level casees
court_df <- fread("Historical Data Submissions/Sacramento/P2 Submission-June 30/SacCases.csv")

# Variable name standardization--See pg. xxx for more details. 
names(court_df) <- c("jail_court_id", "court_combined_id", "court_id", "case_id", "file_date", "case_status", "case_status_desc", "case_status_date")

# Date Reformatting--See pg. xxx for more details.
court_df <- court_df %>%
  mutate(file_date = as_date(parse_date_time(file_date, c('%m/%d/%Y %H:%M:%S %p'))))



####


#Court Hearing Data
court_hearing <- fread("Historical Data Submissions/Sacramento/P2 Submission-June 30/SacAppear.csv")

# Variable name standardization--See pg. xxx for more details. 
names(court_hearing) <- c("jail_court_id", "court_combined_id", "court_id", "case_id", "hearing_date", "hearing_type_original", "hearing_strange", "hearing_comment", "hearing_result_code", "hearing_result", "hearing_result_comment")

# Date Reformatting--See pg. xxx for more details.
court_hearing <- court_hearing %>%
  mutate(hearing_date_time = parse_date_time(hearing_date, c('%m/%d/%Y %H:%M:%S %p')),
         hearing_date = as_date(hearing_date_time))

# Standardize Factors--See pg. xxx for more details.
court_hearing <- court_hearing %>%
  mutate(hearing_type = case_when(grepl("ARRAIGN", hearing_type_original) ~ "Arraignment",
                                  T ~ "Other"))
court_hearing <- court_hearing %>% 
  mutate(court_fta_nowar_flag = if_else(grepl("FTA", hearing_result_code), 1, 0))


####


#Court case dispostions
court_dispos <- fread("Historical Data Submissions/Sacramento/P2 Submission-June 30/SacDispos.csv")

# Variable name standardization--See pg. xxx for more details. 
names(court_dispos) <- c("jail_court_id", "court_combined_id", "court_id", "case_id", "plea_type_original", "disposition_type_original", "case_charge_code", "court_charge_level_original", "court_charge_original", "disposition_date")

# Date Reformatting--See pg. xxx for more details.
court_dispos <- court_dispos %>%
  mutate(disposition_date = parse_date_time(disposition_date, c('%m/%d/%Y %H:%M:%S %p')),
         disposition_date = as_date(disposition_date))


court_dispos <- court_dispos %>%
  mutate(
        court_charge_code_original = str_extract(court_charge_original, "[A-Z]{3}|[A-Z]{2}"),
        court_charge_code = if_else(court_charge_code_original %in% c("PC", "VC", "HS", "BP", "WI","US"), court_charge_code_original, "Other"),
        court_attempt_flag = if_else(grepl("664\\/", court_charge_original), 1,0),
        court_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}|664\\/","", court_charge_original)),
        court_charge_level = case_when(
          court_charge_level_original == "FEL" ~ "F",
          court_charge_level_original == "MIS" ~ "M",
          court_charge_level_original == "INF" ~ "I",
          T ~ "Other")
        ) %>%
  unite(join_var, court_charge_level, court_charge_code, court_charge, remove = F) %>%
  mutate(
    join_var = case_when(
      join_var == "M_HS_11359" ~ "M_HS_11359B",
      join_var == "M_VC_23152G" ~ "M_VC_23152F",
      T ~ join_var
    )
  )

load("Complete Charge Code Hierarchy.RData")

court_dispos <- left_join(court_dispos, charge_hier, by = "join_var")

# Standardize Factors--See pg. xxx for more details.
court_dispos <- court_dispos %>%
  mutate(disposition_type = case_when(disposition_type_original %in% c("DI", "DC") ~ "Dismissed",
                                      disposition_type_original %in% c("NC") ~ "Nolo_Contendere",
                                      disposition_type_original %in% c("GP", "GC") ~ "Guilty",
                                      disposition_type_original %in% c("AQ") ~ "Not_Guilty",
                                      T ~ "Other"),
  
         plea_type = case_when(plea_type_original %in% c("NC") ~ "Nolo_Contendere",
                               plea_type_original %in% c("NG") ~ "Not_Guilty",
                               plea_type_original %in% c("GU") ~ "Guilty",
                               plea_type_original %in% c("NP", "NULL") ~ "NA",
                               T ~ "Other")
         )

court_dispos <- court_dispos %>%
  mutate(felony_flag = if_else(court_charge_level == "F", 1,0),
         misd_flag = if_else(court_charge_level == "M", 1, 0)) %>%
  mutate_at(vars(contains("flag")), funs("conviction" = if_else(. == 1 & disposition_type %in% c("Guilty", "Nolo_Contendere"), 1, 0))) %>%
  rename_at(vars(contains("flag"), -contains("conviction")), funs(paste0("court_", .))) %>%
  rename_at(vars(contains("conviction")), funs(paste0("conviction_", gsub("_conviction", "", .))))


####


#Court person ids
court_person <- fread("Historical Data Submissions/Sacramento/P2 Submission-June 30/SacPersonDetail.csv")

# Variable name standardization--See pg. xxx for more details. 
names(court_person) <- c("jail_court_id", "first_name", "last_name", "name", "sex_original", "race_original", "dob", "cii", "fbi", "dln")

# Date Reformatting--See pg. xxx for more details.
court_person <- court_person %>%
  mutate(dob = ymd(gsub(" .*", "", trimws(dob))))

# Standardize Factors--See pg. xxx for more details.
court_person <- court_person %>%
  mutate(race = case_when(race_original %in% c("W") ~ "White",
                          race_original %in% c("B") ~ "Black",
                          race_original %in% c("H") ~ "Hispanic",
                          T ~ "Other_Unknown"),
         
         sex = case_when(sex_original %in% c("M") ~ "Male",
                         sex_original %in% c("F") ~ "Female",
                         sex_original %in% c("X") ~ "Other_Unknown",
                         T ~ "Other_Unknown"))


####


#Court Warrants
court_warrants <- fread("Historical Data Submissions/Sacramento/P2 Submission-June 30/SacWarrants.csv")

# Variable name standardization--See pg. xxx for more details. 
names(court_warrants) <- c("jail_court_id", "court", "warrant_num", "warrant_id", "warrant_status", "charge_level", "warrant_type", "judge", "judge_comment", "complaint_lea", "lea_loc", "lea", "lea_foreign", "lea_hold", "charges_comments", "warrant_date", "warrant_clear_date", "warrant_duration", "bail_amt", "no_bail_flag", "case_id", "mandatory_appear_flag")


court_warrants <- court_warrants %>%
  select(-judge) %>%
  mutate(warrant_date = as_date(parse_date_time(warrant_date, c('%m/%d/%Y %H:%M:%S %p'))),
          warrant_clear_date = as_date(parse_date_time(warrant_clear_date, c('%m/%d/%Y %H:%M:%S %p'))))

court_warrants <- court_warrants %>%
  mutate(court_fta_flag = 1)


court_df %>%
  #distinct(case_id, .keep_all = T) %>%
  anti_join(court_dispos, by = "case_id")

court_dispos %>%
  #distinct(case_id) %>%
  semi_join(court_df, by = "case_id")

# all dispos match to court_df. 11k court_df do not match to dispos

court_df %>%
  semi_join(court_hearing, by = "case_id")

court_df %>%
  #distinct(jail_court_id) %>%
  semi_join(court_person, by = "jail_court_id")

summary(court_dispos$disposition_date)
summary(court_df$file_date)

####

#there is also a sentence table that has not been pulled in

```


Court diagnostic
```{r}
# court_dispos %>%
#   mutate(disposition_date = parse_date_time(disposition_date, c('%m/%d/%Y %H:%M:%S %p'))) %>% 
#   #filter(disposition_date != "")
#   filter(!is.na(disposition_date)) %>%
#   select(disposition_date) %>%
#   arrange(desc(disposition_date))



# court_dispos %>%
#   group_by(court_charge_level_original) %>%
#   count()
# 
# court_dispos %>%
#   count(charge_dispo_code) %>%
#   arrange(desc(n))


# Diagnostic Code for Charge Hierarchy
#
#(1 - nrow(court_dispos %>% filter(court_charge_code_original != "PAR") %>% filter(is.na(hierarchy)))/nrow(court_dispos))*100

# court_dispos %>%
#   filter(is.na(hierarchy)) %>%
#   count(join_var) %>%
#   arrange(desc(n))

# court_dispos %>%
#   filter(court_charge_code_original == "PAR")
# 
# book_df %>%
#   filter(grepl("WARRANT", book_type_original)) %>%
#   count(arrest_charge_level_original)
# 
# charge_hier %>%
#   filter(grepl("23152", charge))
# 
# charge_hier %>%
#   filter(charge_code == "Other")
# 
# charge_hier %>%
#   count(charge_code)

#table(court_dispos$court_charge)[order(table(court_dispos$court_charge), decreasing = T)]
#table(court_dispos$court_charge_code_original)[order(table(court_dispos$court_charge_code_original), decreasing = T)]


# court_hearing %>%
#   count(hearing_type_code) %>%
#   arrange(desc(n))

# court_df
# court_dispos %>%
#   count(disposition_type)
# court_hearing
# court_person
# court_warrants
```

Court Collapse
```{r}
# court_charges
# 
# court_charges %>%
#   filter(grepl("TR", court_docket_id)) %>%
#   count(charge_level)
# 
# court_charges <- court_charges %>%
#   filter(!grepl("TR|JQ", court_docket_id)) 
# 
# court_charges %>%
#   filter(grepl("RV", court_docket_id))

suppressWarnings(court_dispo <- court_dispos %>%
  mutate(disposition_type = ordered(disposition_type, levels = c("Other", "Dismissed", "Not_Guilty", "Nolo_Contendere", "Guilty")),
         sentence_date = if_else(disposition_type %in% c("Guilty", "Nolo_Contendere"), disposition_date, as_date(NA_character_))) %>%
  rename(court_case_id = court_combined_id) %>%
  mutate(hierarchy = if_else(is.na(hierarchy), 1e6, as.numeric(hierarchy))) %>%
  group_by(court_case_id, jail_court_id) %>%
  mutate(disposition_date = max(disposition_date),
         disposition_type = max(disposition_type),
         sentence_date = max(sentence_date, na.rm = TRUE)) %>%
  mutate(max_court_charge_level = court_charge_level[hierarchy == min(hierarchy)][1],
         max_court_charge_code = court_charge_code[hierarchy == min(hierarchy)][1],
         max_court_charge = court_charge[hierarchy == min(hierarchy)][1],
         max_charge_description = master_charge_description[hierarchy == min(hierarchy)][1],
         max_hier = min(hierarchy)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, as.numeric(.)))) %>%
  mutate_at(vars(contains("flag")), funs("count" = sum(.))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  filter(hierarchy == min(hierarchy)) %>%
  ungroup() %>%
  distinct(court_case_id, jail_court_id, .keep_all = T) )
  
# court_dispos %>%
#   filter(!is.na(disposition_date))
# court_dispo %>%
#   filter(!is.na(disposition_date)) %>%
#   filter(disposition_date != sentence_date) %>%
#   select(disposition_date, sentence_date)

  # court_charges %>%
  #   count(disposition_type)

# court_dispos %>%
#   distinct(court_combined_id)


# court_charges %>%
#   filter(!is.na(disposition_date)) %>%
#   distinct(court_case_id)

#Court Ftas are not separate from warrants
court_fta_war <- court_warrants %>%
  mutate(court_id = case_when(court == "SACRAMENTO MUNICIPAL" ~ "34470", 
                              court == "SACRAMENTO SUPERIOR" ~ "34100",
                              T ~ ""),
         court_case_id = str_c(court_id, case_id),
         no_bail_flag = if_else(no_bail_flag == "X", 1,0)) %>%
  arrange(warrant_date) %>%
  group_by(court_case_id, jail_court_id) %>%
  mutate(fta_flag = max(court_fta_flag),
         fta_flag_count = sum(court_fta_flag),
         no_bail_flag = max(no_bail_flag)) %>%
  ungroup() %>%
  distinct(court_case_id, jail_court_id, .keep_all = T) %>%
  select(-c(court_fta_flag, mandatory_appear_flag, complaint_lea, lea_loc, lea, lea_foreign, lea_hold, warrant_type, court, charge_level)) #all but 44 of them are mandatory appear
#double check lea_foreign and lea_hold. there are very few values in these, almost entirely blank, but maybe for those few is important?


# court_fta %>%
#   distinct(court_case_id, fta_date)

# court_warrants %>%
#   mutate(court_id = if_else(court == "SACRAMENTO MUNICIPAL", 334470, 34100),
#          court_combined_id = str_c(court_id, case_id)) %>%
#   distinct(court_combined_id)

# court_warrants %>%
#   count(lea_hold)
#   distinct(jail_court_id, case_id)


court_hearings <- court_hearing %>%
  rename(court_case_id = court_combined_id) %>%
  group_by(court_case_id, jail_court_id) %>%
  mutate(court_fta_nowar_flag = max(court_fta_nowar_flag),
         court_fta_nowar_flag_count = sum(court_fta_nowar_flag)) %>%
  ungroup() %>%
  filter(hearing_type == "Arraignment") %>%
  rename(arraignment_date_time = hearing_date_time, arraignment_date = hearing_date) %>%
  arrange(arraignment_date_time) %>%
  distinct(court_case_id, jail_court_id, .keep_all = T) %>%
  select(court_case_id, jail_court_id, court_id, case_id, arraignment_date_time, arraignment_date, court_fta_nowar_flag, court_fta_nowar_flag_count)
#

# court_hearing %>%
#   filter(!is.na(hearing_date_time))

# court_hearings %>%
#   filter(is.na(hearing_type))
#   count(hearing_type)
#   
#   court_fta %>%
#     count(fta_date)

# court_hearing %>%
#   count(hearing_type_original) %>%
#   arrange(desc(n))


# 
# court_plea <- court_charges %>%
#   arrange(plea_date) %>%
#   mutate(guilty_flag = if_else(plea_type == "Guilty", 1, 0)) %>%
#   group_by(court_case_id) %>%
#   filter(guilty_flag == 1|sum(guilty_flag) == 0) %>%
#   ungroup() %>%
#   distinct(court_case_id, .keep_all = T) %>%
#   select(court_case_id, court_docket_id, plea_date, plea_type)
# 
# 
# court_sent <- bind_rows(court_sent_prob, court_sentence, court_sent_dl_cond) %>%
#   arrange(sentence_date) %>%
#   distinct(court_case_id, .keep_all = T) %>%
#   select(court_case_id, court_docket_id, sentence_date, sentence_type)

# court_sent_dl_cond
# court_sent_prob
# court_sentence
# 
# court_sentence %>%
#   count(sentence_location) %>%
#   arrange(desc(n))
# 
# court_sent_prob %>%
#   count(sentence_location) %>%
#   arrange(desc(n))
# court_person
# court_df



court_df2 <- reduce(list(court_dispo, court_fta_war, court_hearings), left_join, by = c("court_case_id", "jail_court_id")) %>%
  #rename(jail_court_id.2 = jail_court_id.x, jail_court_id.3 = jail_court_id.y) %>%
  select(-contains(".y")) %>%
  select(-contains(".x")) %>%
  #select(-court_docket_id) %>%
  #rename_at(vars(contains(".x")), funs(gsub("\\.x", "", .))) %>%
  mutate(final_disposition_date = if_else(disposition_date <= sentence_date|is.na(sentence_date), disposition_date, sentence_date),
         conviction_flag = if_else(disposition_type %in% c("Guilty","Nolo_Contendere"), 1, 0))
# names(court_dispo)
# names(court_fta_war)
# names(court_hearing)
# names(court_plea)
# names(court_sent)
# court_df %>%
#   names()



# court_df2 %>%
#   filter(is.na(jail_court_id.3) & is.na(jail_court_id.2) & is.na(jail_court_id))
# 
# court_df %>%
#   count(case_status_desc) %>%
#   arrange(desc(n))

court_df3 <- court_df2 %>%
  left_join(court_person)  #1,049 unmatched

# court_df2 %>%
#   anti_join(court_person) %>%
#   distinct(court_case_id)
# 
# court_df3 %>%
#   distinct(court_case_id)


# %>%
  #left_join(court_person, by = "jail_court_id") %>%
  #left_join(court_person, by = c("jail_court_id.3" = "jail_court_id"))

test %>%
  mutate(test_var = if_else(is.na(sex), 0, 1)) %>%
  group_by(court_case_id) %>%
  mutate(test_var = max(test_var)) %>%
  ungroup() %>%
  distinct(court_case_id,  .keep_all = T) %>%
  count(test_var)

test %>%
  group_by(court_case_id) %>%
  mutate(test_var = n_distinct(fbi, na.rm = T)) %>%
  filter(test_var >1) %>%
  select(jail_court_id.2, test_var, court_case_id, fbi, name, sex, race, dob)


  ungroup() %>%
  distinct(court_case_id,  .keep_all = T) %>%


  count(test_var)

court_person %>%
  filter(is.na(fbi))
  
names(court_df2)

court_df2 %>%
  select(jail_court_id, jail_court_id.x, jail_court_id.y, court_case_id) %>%
  group_by(court_case_id) %>%
  filter(!(jail_court_id == jail_court_id.x & jail_court_id.x == jail_court_id.y)) #jail_court_ids do not align

court_df2 %>%
  select(case_id, case_id.x, case_id.y) %>%
  filter(!case_id.y == case_id.x)     #case ids all align

court_df2 %>%
  select(court_id, court_id.x, court_id.y) %>%
  filter(!court_id.x == court_id.y)   #court ids all align

court_df2 %>%
  select(contains("date")) 

court_df2 %>%
  filter


  
# Diagnostics
court_fta %>%
  count(fta_all_flag)

court_fta_war %>%
  count(fta_flag)

full_join(court_fta %>% filter(fta_all_flag == 1), court_fta_war %>% filter(fta_flag == 1) %>% rename(fta_date = fta_war_date), by = c("court_case_id", "fta_date")) %>%
  filter(fta_all_flag != fta_flag) %>%
  add_count(court_case_id) %>%
  filter(n > 1) %>%
  arrange(court_case_id, fta_date)

court_hearing %>%
  count(hearing_type_original) %>%
  arrange(desc(n))
  
court_charge %>%
  filter(stage %in% c("DISPOSITION EVENT")) %>%
  select(-c(disposition_num, charge_id, charge_history_id, offense_id, disposition_hist_id, disposition_id, disposition_type_code, amend_reason_id, amend_reason))
  # filter(stage %in% c("Sentence Event")) %>%
  count(dispos) %>%
  arrange(desc(n))
  
court_dispo %>%
  distinct(court_case_id, disposition_date, .keep_all = T) %>%
  add_count(court_case_id) %>%
  filter(n > 1) %>%
  arrange(desc(n))

court_charge %>%
  filter(stage %in% c("PLEA EVENT")) %>%
  count(disposition_type_original) %>%
  arrange(desc(n))
  distinct(court_case_id, disposition_date, .keep_all = T) %>%
  add_count(court_case_id) %>%
  filter(n > 1) %>%
  arrange(desc(n))
  # select(-c(disposition_num, charge_id, charge_history_id, offense_id, disposition_hist_id, disposition_id, disposition_type_code, amend_reason_id, amend_reason))
  # filter(stage %in% c("Sentence Event")) %>%
  count(dispos) %>%
  arrange(desc(n))

court_charge %>%
  # filter(stage %in% c("CASE FILING")) %>%
  # filter(stage %in% c("SENTENCE EVENT", "DISPOSITION EVENT")) %>%
  # distinct(court_case_id) 
  count(stage)
  filter(court_case_id == "921214")

  court_df %>%
    filter(conviction_flag == 1) %>%
    filter(!disposition_type %in% c("Guilty", "Nolo_Contendere")) %>%
    count(disposition_type, sentence_type) %>%
    #count(court_charge_code, court_charge_level) %>%
    arrange(desc(n))


```

Probation data
```{r}

# #OLD DO NOT USE --- probation data -- Sacramento, 
# prob_df <- fread("Historical Data Submissions/Sacramento/P2 Submission-June 30/SacProbationPSA07132020.csv")
# 
# names(prob_df) <- c("cii", "fbi", "local_id", "cdl", "name", "dob","sex_original", "race_original", "tool_name_id", "assessment_date_time", "zipcode", "tool_responses", "release_level", "release_recommendation", "release_authorization", "release_type", "release_date_time", "terms_and_conditions", "violation", "violation_date_time", "court_date_reminder", "termination_outcome", "termination_date")
# 
# 
# prob_df <- prob_df %>%
#   mutate(assessment_date_time = parse_date_time(assessment_date_time, c('%m/%d/%Y %H:%M:%S %p')),
#          assessment_date = as_date(assessment_date_time),
#          release_date_time = parse_date_time(release_date_time, c('%m/%d/%Y %H:%M:%S %p')),
#          release_date = as_date(release_date_time),
#          violation_date_time = parse_date_time(violation_date_time, c('%m/%d/%Y %H:%M:%S %p')),
#          violation_date = as_date(violation_date_time),
#          termination_date = as_date(parse_date_time(termination_date, c('%m/%d/%Y %H:%M:%S %p'))),
#          dob = as_date(parse_date_time(dob, c('%m/%d/%Y %H:%M:%S %p'))))
# 
# summary(prob_df$assessment_date)
# 
# lapply(prob_df, function(i){
#   if(is.character(i) ==T){ 
#     sum(is.na(i)|i== "NULL") 
#   } 
#   else{ 
#     sum(is.na(i)) 
#   } 
# }) 
# 
# #check factor levels
# lapply(prob_df, function(i){ 
#   if(length(unique(i)) <= 50) 
#     table(i, useNA = "always") 
# }) 
# 
# #missing data: tool responses, score, violation, violation date, release_type is missing for over 4,000 records, and will need some help on termination_outcome (~800 missing, blank not na, not sure what the rest mean). event identifier (court case id and/or booking id). release authorization category (sheriff, judge).

#[10:52 AM] Lehman, Noah
    
## Noah's notes from call with Sac 8.27.2020:
# Sacramento:
# 
# -Have booking number. Most fields are autopopulated in PSA report.
# 
# -Violent offense (local definition)
# 
# -Deferred for arraignment is temporarily denied 
# 
# -Sentence date from assessments refers to release to pretrial OR it is the date the closure is processed.
# 
#             -Closed means not tracked by monitoring. 
# 
# -Referral date is day they came to pretrial.  
# 
# -Expiration date is end of pretrial date
# 
# -Assessment and case will get dropped, no charges, or 0 bail. 
# 
# -Probation only looks at person as a whole not by case. 
# 
# - StatusTypeCode Should be Assessment Status Closed 
# 
# -ActiveAtSomePoint = sometimes on pretrial. 
# 


# prob_df %>%
#   filter(release_type == "")
# 
# prob_df %>%
#   count(termination_outcome) %>%
#   arrange(desc(n))
# 
# prob_df %>%
#   summarise(
#     across(where(is.numeric), mean),
#     across(where(is.factor), nlevels),
#     n = n())

#Updated data re-submission, 10.15.2020
prob_df <- fread("Historical Data Submissions/Sacramento/P2 Submission-June 30/SacProbationPSA.csv")

names(prob_df) <- c("cii", "fbi", "local_id", "cdl", "name", "dob","sex_original", "race_original", "tool_name", "assessment_date_time", "case_processing_date_time", "zipcode", "psa_fta_risk_score", "psa_nca_risk_score", "psa_nvca_risk_score", "psa_tool_response_1", "psa_tool_response_2", "psa_tool_response_3", "psa_tool_response_4", "psa_tool_response_5", "psa_tool_response_6", "psa_tool_response_7", "psa_tool_response_8", "psa_tool_response_9", "psa_score", "monitor_level_original", "release_recommendation_original", "release_decision_original",  "release_authorization", "release_date_time", "comments",  "release_conditions_original", "court_date_reminder", "pretrial_termination_outcome_original", "pretrial_termination_date", "active_at_some_point", "book_num")


## variables missing: pretrial_violation

# Date Reformatting--See pg. xxx for more details.
prob_df <- prob_df %>%
  mutate(assessment_date_time = parse_date_time(assessment_date_time, c('%m/%d/%Y %H:%M:%S %p')),
         assessment_date = as_date(assessment_date_time),
         release_date_time = parse_date_time(release_date_time, c('%m/%d/%Y %H:%M:%S %p')),
         release_date = as_date(release_date_time),
         case_processing_date_time = parse_date_time(case_processing_date_time, c('%m/%d/%Y %H:%M:%S %p')),
         case_processing_date = as_date(case_processing_date_time),
         #violation_date_time = parse_date_time(violation_date_time, c('%m/%d/%Y %H:%M:%S %p')),
         #violation_date = as_date(violation_date_time),
         pretrial_termination_date = as_date(parse_date_time(pretrial_termination_date, c('%m/%d/%Y %H:%M:%S %p'))),
         dob = as_date(parse_date_time(dob, c('%m/%d/%Y %H:%M:%S %p'))))


# Standardize Factors--See pg. xxx for more details.
prob_df <- prob_df %>%
  mutate(tool_name = "PSA",
         
         sex = case_when(sex_original %in% c("M") ~ "Male",
                         sex_original %in% c("F") ~ "Female",
                         T ~ "Other_Unknown"),
         
         #Trimming white space on original race first
         race_original = trimws(race_original),
         race = case_when(race_original %in% c("B") ~ "Black",
                          race_original %in% c("H") ~ "Hispanic",
                          race_original %in% c("W") ~ "White",
                          #All Other races/ethnicities collapsed into other
                          T ~ "Other_Unknown"),
         
         #separate risk score from risk level and standardize risk level

         #standardize release recommendation

         release_recommendation = case_when(release_recommendation_original %in% c("OR-Conditions") ~ "Monitor",
                                            release_recommendation_original %in% c("Detain") ~ "Detain",
                                            release_recommendation_original %in% c("OR") ~ "OR",
                                            T ~ "Other_Unknown"),
         release_decision = case_when(release_decision_original %in% c("Detain") ~ "Detain",
                                      release_decision_original %in% c("OR-Conditions") ~ "Monitor",
                                      release_decision_original %in% c("OR") ~ "OR",
                                      release_decision_original %in% c("Dropped") ~ "Ineligible",
                                      T ~ "Other_Unknown"),
         
         pretrial_ineligible_reason = case_when(pretrial_termination_outcome_original %in% c("Bailed", "Zero Bail") ~ "Bail_Bond",
                                                release_decision_original %in% c("No Charges Filed") ~ "Case_Disposed",
                                                T ~ "Other_Unknown"),
         
         monitor_level = monitor_level_original,
         
         pretrial_termination_outcome = case_when(pretrial_termination_outcome_original %in% c("Completed", "No Charges Filed", "Sentenced-CJP", "Sentenced-Dismissed", "Sentenced-Formal", "Sentenced-Informal", "Sentenced-Jail", "Sentenced-Other") ~ "Successful",
                                                  pretrial_termination_outcome_original %in% c("Failed", "Abscond") ~ "Unsuccessful",
                                                  pretrial_termination_outcome_original %in% c("Bailed", "Zero Bail", "Ineligible", "Judge Denied", "Opt Out", "OR Release", "Parole-Not PRCS eligible") ~ "Not_Tracked",
                                                  T ~ "Other_Unknown"),
         pretrial_termination_reason = case_when(pretrial_termination_outcome_original %in% c("Completed", "No Charges Filed", "Sentenced-CJP", "Sentenced-Dismissed", "Sentenced-Formal", "Sentenced-Informal", "Sentenced-Jail", "Sentenced-Other") ~ "Case_Disposed",
                                                  pretrial_termination_outcome_original %in% c("Abscond") ~ "Abscond",
                                                  pretrial_termination_outcome_original %in% c("Bailed", "Zero Bail", "Ineligible", "Judge Denied", "Opt Out", "OR Release", "Parole-Not PRCS eligible") ~ "Not_Tracked",
                                                  T ~ "Other_Unknown")                                       
         ) 
  


#Flags
## Need to make flags
# prob_df <- prob_df %>%
#   mutate(assess_flag = if_else(is.na(assessment_date), 0, 1))

## basically already collapsed (minus 3 oddballs)
# prob_df %>%
#   distinct(local_id, assessment_date)

```


Assessment Tables 10.2020
```{r}
assess_table <- prob_df %>%
  # Collapse to each assessment.
  #distinct(pretrial_id, .keep_all = T) %>%
  # Filter for only those actually assessed
  filter(!is.na(assessment_date)) %>%
  left_join(book_df %>% select(registry_num, charge_level), by = c("book_num" = "registry_num"))  %>%
  # Create county name.
  mutate(county = "Sacramento",
         risk_level = NA_character_) %>%
  # Select relevants variables.
  select(county, risk_level, release_recommendation, release_decision, assessment_date, psa_fta_risk_score, psa_nca_risk_score, psa_nvca_risk_score, tool_name, assessment_date, dob, sex, race, charge_level, monitor_level, pretrial_termination_outcome, pretrial_termination_reason)

# Save file  
#fwrite(assess_table, file = "G:/CrimJustice/PretrialAssessmentPilot/Assessment Output Tables/Sacramento Assessment Output 10-2020.csv")
#shell.exec("G:/CrimJustice/PretrialAssessmentPilot/Assessment Output Tables")

```


Join
  Jail Court Join
```{r}
# Remove extraneous objects in the environment
#rm(list = ls()[!ls() %in% ls(pattern = "df")])

#Check for common variables
names(book_df)[names(book_df) %in% names(court_df3)]
#jail_court_id, court_case_id

#Turning NULL to NA to ensure non matching and removing generic charge info from data frames
book_df <- book_df %>%
  mutate_if(is.character, list(~na_if(., "NULL"))) %>%
  select(-c(charge, charge_level, charge_code, case_id)) %>%  #case_id is identical to jail_court_id except when na in 23 cases
  rename(court_case_id_partial = court_case_id) %>%
  rename(court_case_id = court_combined_id)



book_df %>%
  distinct(registry_num, .keep_all = T) %>%
  distinct(case_id, court_combined_id)

court_df3 <- court_df3 %>%
  mutate_if(is.character, list(~na_if(., "NULL"))) %>%
  select(-c(charge, charge_level, charge_code)) %>%
  mutate_at(vars(first_name, last_name), toupper) %>%
  mutate(court_case_id = as.character(court_case_id)) 

#jail_court_id, case_id, court_combined_id

# Court Matching
#Joining on 
join1 <- inner_join(book_df, court_df3, by = c("jail_court_id", "court_case_id"), na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(paste0("arrest_", gsub("\\.x$", "", .)))) %>%
  rename_at(vars(contains(".y")), funs(paste0("court_", gsub("\\.y$", "", .)))) %>%
  # 8 Duplicates with missing dispositions which will be dropped later. 
  distinct()


j1 <- anti_join(book_df, court_df3, by = c("jail_court_id", "court_case_id"), na_matches = "never")
c1 <- anti_join(court_df3, book_df, by = c("jail_court_id", "court_case_id"), na_matches = "never")

  #Examine if set of common variables is distinct-- uhh ohhh. NOPE. Repeats due to case_status, case_status_desc, case_status_date repeats. that was with the wrong court_df. distinct with court_df3 used for join
  join1 %>%
    add_count(jail_court_id, court_case_id, registry_num) %>%
    filter(n == 1) %>%
    arrange(desc(n))
  
    court_df3 %>%
    add_count(jail_court_id, court_combined_id) %>%
    filter(n > 1) %>%
    arrange(desc(n))
    
    book_df %>%
      select(court_combined_id) #court_combined_id in book_df is the same as court_case_id in court_df3
    book_df$court_
    
    names(join1)
    
    join1 %>%
      distinct(registry_num)

    j1 %>%
      distinct(registry_num)
   
    
# 
# #Joining on Name and Court ID
# join2 <- inner_join(j1, c1, by = c("court_docket_id", "first_name", "dob"), na_matches = "never") %>%
#   rename_at(vars(contains(".x")), funs(paste0("arrest_", gsub("\\.x$", "", .)))) %>%
#   rename_at(vars(contains(".y")), funs(paste0("court_", gsub("\\.y$", "", .)))) %>%
#   #1 Duplicate with missing dispositions which will be dropped later. 
#   distinct()
# 
# j2 <- anti_join(j1, c1, by = c("court_docket_id", "first_name", "dob"), na_matches = "never")
# c2 <- anti_join(c1, j1, by = c("court_docket_id", "first_name", "dob"), na_matches = "never")
# 
#   #Examine if set of common variables is distinct--yes except 8 spurious cases.
#   join2 %>%
#     add_count(first_name, court_docket_id, book_num) %>%
#     filter(n > 1) %>%
#     arrange(desc(n))

#Joining on Court ID
#     
# join3 <- inner_join(j2, c2, by = c("court_docket_id", "first_name"), na_matches = "never") %>%
#   rename_at(vars(contains(".x")), funs(paste0("arrest_", gsub("\\.x$", "", .)))) %>%
#   rename_at(vars(contains(".y")), funs(paste0("court_", gsub("\\.y$", "", .)))) %>%
#   #1 Duplicate with missing dispositions which will be dropped later. 
#   distinct()
# 
# j3 <- anti_join(j2, c2, by = c("court_docket_id", "first_name"), na_matches = "never")
# c3 <- anti_join(c2, j2, by = c("court_docket_id", "first_name"), na_matches = "never")
# 
#   #Examine if set of common variables is distinct--yes except 8 spurious cases.
#   join3 %>%
#     add_count(court_docket_id, book_num) %>%
#     filter(n > 1) %>%
#     arrange(desc(n))
#   
# #Diagnostics
#   #Jail and Court Matches by category
# tibble(
#   stage = 1:3,
#   match = c(
#     'c("court_docket_id", "cii", "dob")',
#     'c("court_docket_id", "first_name", "dob")',
#     'c("court_docket_id", "dob")'
#   ),
#   jail_match_rate = sapply(1:3, function(i) {
#     (nrow(book_df) - nrow(get(paste0("j", i)))) / nrow(book_df) * 100
#   }),
#   court_match_rate = sapply(1:3, function(i) {
#     (nrow(court_df) - nrow(get(paste0("c", i)))) / nrow(court_df) * 100
#   })
# )
# 
# join_df <- bind_rows(join1, join2, join3)
```



Code Book
```{r eval=FALSE, include=FALSE}
rm(original_field)

original_df <- bind_rows(original_df)

Sacramento_df <- lapply(ls()[!grepl("original", ls())], function(i){
  df <- get(i)
  
  if(sum(grepl("date", names(df))) > 0){
  df2 <- df %>%
  select(contains("date"), -contains("time")) %>%
  gather("modified_field", "value") %>%
  group_by(modified_field) %>%
  summarise_all(funs(min = as.character(min(., na.rm = T)), mean = as.character(mean(., na.rm = T)), max = as.character(max(., na.rm = T))))
  }else{
    df2 <- tibble(modified_field = NA_character_, min = NA_character_, mean = NA_character_, max = NA_character_)
  }
  
  df <- df %>%
    mutate_if(~length(unique(.)) > 50|is.Date(.)|is.POSIXct(.), ~(. = "not_factor")) %>%    
    mutate_all(~if_else(is.na(.), "na_missing", as.character(.))) %>%
    gather(modified_field, factor_value) %>%
    count(modified_field, factor_value) %>%
    mutate(table_name = i, county = "Sacramento") %>%
    mutate(factor_flag = if_else(factor_value == "not_factor", 0, 1)) %>%
    group_by(table_name, modified_field) %>%
    mutate(table_count = sum(n)) %>%
    ungroup() %>%
    rename("factor_count" = "n") %>%
    mutate(factor_count = if_else(factor_value == "not_factor", NA_integer_, factor_count),
           factor_percent = round(factor_count/table_count*100, 1)) %>%
    arrange(desc(factor_flag), modified_field, desc(factor_count))
  
  df <- left_join(df, df2, by = "modified_field")
    }) %>% 
  bind_rows() %>%
  left_join(original_df) %>%
   select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_count,
           factor_percent, table_count, min, mean, max) 

write.xlsx(Sacramento_df, file = "Code Books/Sacramento Code Book.xlsx")
```

Completion
```{r}
files <- list.files("G:/CrimJustice/PretrialAssessmentPilot/Code Books/Code Book Notes", pattern = "Sacramento", full.names = T)

df <- lapply(files, read_excel)

df[[4]] <- full_join(df[[1]], df[[2]]) %>%
  full_join(df[[3]]) %>%
  mutate(factor_standard = "") %>%
  select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_standard, factor_count, factor_percent, 
         table_count, "sl_notes" = Sal_Notes, "nl_notes_1" = factor_collapse, "nl_notes_2" = notes, "st_notes_1" = Column1, "st_notes_2" = Column2, min, mean, max)

df <- list(df[[4]], df[[3]], df[[2]], df[[1]])

#write.xlsx(df, file = "G:/CrimJustice/PretrialAssessmentPilot/Code Books/Variable Construction/Sacramento Factor Construction.xlsx", asTable = T, tableStyle = "TableStyleMedium1", sheetName = c("Variable Construction", "st_notes", "sl_notes", "nl_notes"))
```

Factors codebook
```{r}
factor_df <- lapply(ls()[!grepl("original|^df|hier", ls())], function(i){
  df <- get(i)
  if(sum(grepl("original", names(df))) == 0){
    return(NULL)
  }else{
    var_names <- names(df)[grepl("original", names(df))]
    var_names2 <- gsub("_original", "", var_names)
   
    df1 <- df %>%
     select(var_names) %>%
     gather(original_field, original_value)
   
    df2 <- df %>%
     select(var_names2) %>%
     gather(modified_field, modified_value)
   
   df <- bind_cols(df1, df2) %>%
     count(original_field, modified_field, original_value, modified_value) %>%
     arrange(modified_field, desc(n)) %>%
     group_by(modified_field) %>%
     mutate(row = row_number(),
            percent = round(n/sum(n)*100)) %>%
     ungroup() %>%
     filter(row <= 50) %>%
     select(-row) %>%
     rename("total" = n)
   }
  }) %>%
  bind_rows()

#write.xlsx(factor_df, file = "G:/CrimJustice/PretrialAssessmentPilot/Code Books/Factor Code Book/Sacramento Factor Code Book.xlsx", asTable = T, tableStyle = "TableStyleMedium1", colWidths = "auto")
```


DOJ CII/Linking Extraction
```{r}
# Grab Tables with CII

doj_person <- court_person %>%
  # select(cii, fbi, cdl_id, cdl_id_state, dob, race_original, sex_original, name, local_id) %>%
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) %>%
  distinct()

# Examine missing ciis and duplicates on cii. 
doj_person %>% #Off by about 3000 almost all due to missing CII.
  distinct()

doj_person %>% 
  distinct(cii)

doj_person %>% 
  distinct() %>%
  add_count(cii) %>%
  filter(n > 1) %>%
  arrange(desc(n)) %>% 
  View()

#CIIs for DOJ
doj_cii <- doj_person %>%
  select(cii) %>% 
  distinct()

#Create an excel workbook with all data table. Make sure to include the cii table first. 
write.xlsx(list(doj_cii, doj_person), file = "CIIs for DOJ/Sacramento CIIs and Demographics for DOJ.xlsx", sheetName = c("ciis", "person"))
```

CII extraction 10.2020
```{r}
# Grab Tables with CII
df_list <- sapply(
  ls()[which(sapply(ls(), function(i){
    sum(names(get(i)) %in% "cii")
    }) == 1)],
  function(j){
    df <- get(j)
    df <- df %>%
      select(any_of(c("cii", "cdl_id", "fbi", "name", "last_name", "first_name", "middle_name", "dob", "sex_original", "race_original"))) %>%
       mutate(
         cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) %>%
  distinct()
 
})

# CIIs from assessment tables
doj_assess <- bind_rows(df_list[[2]])

# # CIIs from booking tables
# doj_book <- bind_rows(df_list[[2]])

# CIIs from court tables
doj_court <- bind_rows(df_list[[1]])

# # CIIs from person tables
# doj_person <- bind_rows(df_list[[1]])

#CIIs for DOJ
doj_cii <- bind_rows(doj_assess %>% select(cii), doj_court %>% select(cii))  %>% 
  distinct() %>%
  filter(nchar(cii) == 10)


#Create an excel workbook with all data table. Make sure to include the cii table first.
#write.xlsx(list(doj_cii, doj_court, doj_assess), file = "G:/CrimJustice/PretrialAssessmentPilot/CIIs for DOJ/October 2020/Sacramento P2 CIIs and Demographics for DOJ.xlsx", sheetName = c("ciis", "court", "assessment"))
```


# Sonoma
Sonoma has their own documentation files included, they are quite good. Check them out.

Jail Data
```{r}
# Jail Bookings Data Import --- Sonoma 2015-01-01 to 2020-06-29
  ## book_df contains one row per charge per case associated with a booking into the Sonoma County Jail between 2015-01-01 and 2020-06-29. One booking will have as many rows as there are related booked and pending filed charges. 
  ## book_demo contains the individual-level data elements used to identify each individual in the jail dataset.  
  ## book_charge contains all convicted charges for any booking or pending filed charges that were included in book_df

#setwd("G:/CrimJustice/PretrialAssessmentPilot")

###


# Jail Bookings
  ## book_df contains one row per charge per case associated with a booking into the Sonoma County Jail between xxx and xxx. One booking will have as many rows as there are related booked and pending filed charges. 
book_df <- fread("Historical Data Submissions/Sonoma/P2 Submission-June 30/Jail Data Set - File 1 of 3 - 20200713.csv") 


# Variable name standardization--See pg. xxx for more details. 
names(book_df) <- c("lent_key", "arrest_date_time", "book_num", "book_date_time", "book_type_rollup", "book_type_original", "booked_or_pending_charge", "ccas_key", "court_case_id", "court_docket_id", "arrest_charge_code_original", "arrest_charge_original", "arrest_charge_level_original", "arrest_charge_description", "arrest_charge_counts", "release_date_time", "release_type_original", "release_info", "bail_amt", "employment_status_employer", "employment_type")


# Date Reformatting --See pg. xxx for more details.
  ## note that the dates are formatted differently than in the last extract (mdy_hm instead of mdy_hms)
book_df <- book_df %>%
  mutate_at(vars(arrest_date_time, book_date_time, release_date_time), mdy_hm) %>%
  mutate(arrest_date = as_date(arrest_date_time),
         book_date = as_date(book_date_time),
         release_date = as_date(release_date_time))



# Standardize Charges and join charge hierarchy--See pg. xxx for more details about this process. 
book_df <- book_df %>%
  mutate(arrest_attempt_flag = if_else(grepl("664\\/", arrest_charge_original), 1, 0),
         arrest_charge = gsub("664\\/","", arrest_charge_original),
         arrest_charge = gsub("PRE20170516|pre2014", "", arrest_charge),
         ## These next specific replacements are appended after the charge as enhancements, so here they are removed. The enhancements are dealt with in the court data.
         arrest_charge = gsub("\\(11370.2\\(a\\)\\)|\\(1192.7\\(c|\\(pc1203.07\\(a\\)\\(1|\\(12022.95\\)|\\(pc1203.07|\\(pc1203.0", "", arrest_charge),
         arrest_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}","", arrest_charge)),
         arrest_charge_code = trimws(arrest_charge_code_original),
         arrest_charge_code = if_else(arrest_charge_code %in% c("PC", "VC", "HS", "BP", "WI","US"), arrest_charge_code, "Other"),
         arrest_charge_level = if_else(arrest_charge_level_original %in% c("M", "F", "I"), arrest_charge_level_original, "Other")) %>%
  unite(join_var, arrest_charge_level, arrest_charge_code, arrest_charge, remove = F)

load("Complete Charge Code Hierarchy.RData")

book_df <- left_join(book_df, charge_hier, by = "join_var")


# Standardize Factors--See pg. xxx for more details.
book_df <- book_df %>%
  mutate(book_type = case_when(book_type_original %in% c("ON VIEW") ~ "On_View",
                               book_type_original %in% c("WARRANT") ~ "Warrant",
                               book_type_original %in% c("SENTENCED") ~ "Commitment",
                               book_type_original %in% c("REMAND") ~ "Court_Order",
                               book_type_original %in% c("HOLD") ~ "Hold",
                               book_type_original %in% c("VIO/PROBATION") ~ "Sup_Vio_Post",
                               book_type_original %in% c("VIO/PRETRIAL", "VIO/SUPERVISED OR") ~ "Sup_Vio_Pre",
                               book_type_original %in% c("Book, Print, Release", "BPR CITE") ~ "Cite_Release",
                               book_type_original %in% c("") ~ "Unknown",
                               T ~ "Other"),
         
         release_type = case_when(release_type_original %in% c("BAIL BOND", "CASH BAIL", "BAIL REINSTATED") ~ "Bail_Bond",
                                  release_type_original %in% c("TIME SERVED", "PROBATION/COND SENTENCE
", "CREDIT FOR TIME SERVED", "4024.1-EARLY RELEASE", "MODIFICATION-TIME SERVED") ~ "Time_Served",
                                  release_type_original %in% c("CITATION") ~ "Cite_Release",
                                  release_type_original %in% c("PRETRIAL SERVICES RELEASE") ~ "Pretrial_Sup",
                                  release_type_original %in% c("RELEASE TO OTHER AGENCY", "HOLD DROPPED") ~ "Hold_Release",
                                  release_type_original %in% c("ENROUTE TO STATE PRISON") ~ "Prison",
                                  release_type_original %in% c("OWN RECOGNIZANCE", "BPR CITATION") ~ "OR",
                                  release_type_original %in% c("RELEASE W/COURT CONDITIONS") ~ "OR_Cond",
                                  release_type_original %in% c("NO COMPLAINT FILED", "DEFENDANT DISCHARGED", "COMPLAINT DISMISSED", "WARRANT RECALLED", "ACQUITTED", "INSUFF PROBABLE CAUSE") ~ "Dismissed_Dropped",
                                  release_type_original %in% c("DETENTION ONLY", "849B2", "849B1") ~ "Detain_Only",
                                  release_type_original %in% c("RELEASE TO ICE") ~ "Fed",
                                  release_type_original %in% c("") ~ "Unknown",
                                  T ~ "Other")
         )


# Flag Construction--See pg. xxx for more details. 
book_df <- book_df %>%
  mutate(arrest_felony_flag = if_else(arrest_charge_level == "F", 1, 0),
         arrest_misd_flag = if_else(arrest_charge_level == "M", 1, 0),
         arrest_qualifier_flag = if_else(arrest_charge_level_original == "x", 1, 0),
         arrest_sup_vio_post_flag = if_else(book_type == "Sup_Vio_Post", 1, 0),
         arrest_sup_vio_pre_flag = if_else(book_type == "Sup_Vio_Pre", 1, 0),
         warrant_flag = if_else(grepl("Warrant", book_type), 1, 0),
         onview_flag = if_else(grepl("On_View", book_type), 1, 0))


####

#Jail demo
  ## book_demo contains the individual-level data elements used to identify each individual in the jail dataset.  
book_demo <-fread("Historical Data Submissions/Sonoma/P2 Submission-June 30/Jail Data Set - File 2 of 3 - 20200713.csv")


# Variable name standardization--See pg. xxx for more details. 
names(book_demo) <- c("lent_key", "cii", "fbi", "dl_state", "cdl_id", "name", "dob", "sex_original", "race_original")


# Date Reformatting --See pg. xxx for more details.
book_demo <- book_demo %>%
  mutate_at(vars(dob), mdy) 


# Standardize Factors--See pg. xxx for more details.
book_demo <- book_demo %>%
  mutate(sex = case_when(sex_original %in% c("M") ~ "Male",
                         sex_original %in% c("F") ~ "Female",
                         T ~ "Other_Unknown"),
         
         race = case_when(race_original %in% c("White") ~ "White",
                          race_original %in% c("Black") ~ "Black",
                          race_original %in% c("Hispanic") ~ "Hispanic",
                          T ~ "Other_Unknown"))



#### NOT USED


# Jail Conviction Charges
  ## book_charge contains all convicted charges for any booking or pending filed charges that were included in book_df
  ## this df will not be used because the conviction information will come from the court data

book_charge <- fread("Historical Data Submissions/Sonoma/P2 Submission-June 30/Jail Data Set - File 3 of 3 - 20200713.csv")


# Variable name standardization--See pg. xxx for more details. 
names(book_charge) <- c("lent_key", "ccas_key", "court_docket_id", "court_case_id", "conv_date", "conv_charge_code", "conv_charge_original", "conv_charge_level")


# Date Reformatting (as well as booking sequence and courtcase_id)--See pg. xxx for more details.
book_charge <- book_charge %>%
  mutate_at(vars(conv_date), mdy)


# Standardize Charges and join charge hierarchy--See pg. xxx for more details about this process. 
book_charge <- book_charge %>%
  mutate(conv_attempt = if_else(grepl("664\\/", conv_charge_original), 1, 0),
         conv_charge = gsub("664\\/","", conv_charge_original),
         conv_charge = gsub("PRE20170516|pre2014", "", conv_charge),
         conv_charge = gsub("\\(11370.2\\(a\\)\\)|\\(1192.7\\(c|\\(pc1203.07\\(a\\)\\(1|\\(12022.95\\)|\\(pc1203.07|\\(pc1203.0", "", conv_charge),
         conv_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}","", conv_charge))) 


```


Jail Collapse
```{r}
# Booking Join--All booking data frames are combined.
book_df <- left_join(book_df, book_demo)


# Booking Collapse--See pg. xxx for more details about this process. 
book_df <- book_df %>%
  mutate(time_first_release = release_date_time - book_date_time) %>%
  mutate(hierarchy = if_else(is.na(hierarchy), 1e6, as.numeric(hierarchy))) %>%
  group_by(book_num) %>%
  mutate(max_booktype = book_type[hierarchy == min(hierarchy)][1],
         max_arrest_charge = arrest_charge[hierarchy == min(hierarchy)][1],
         max_charge_description = master_charge_description[hierarchy == min(hierarchy)][1],
         max_charge_description = master_charge_description[hierarchy == min(hierarchy)][1],
         max_hier = min(hierarchy)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, as.numeric(.)))) %>%
  mutate_at(vars(contains("flag")), funs("count" = sum(.))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  group_by(book_num, court_case_id) %>%
  filter(hierarchy == min(hierarchy)) %>%
  ungroup() %>%
  distinct(book_num, court_case_id, .keep_all = T)



```

Jail Diagnostics
```{r}


# Diagnostic Code for Charge Hierarchy
# x charge level are enhancements

#(1 - nrow(book_df %>% filter(arrest_charge_level_original != "x") %>% filter(is.na(hierarchy)))/nrow(book_charge))*100

# book_df %>%
#   filter(is.na(hierarchy)) %>%
#   count(join_var) %>%
#   arrange(desc(n))


# table(book_df$arrest_charge_code_original)[order(table(book_df$arrest_charge_code_original), decreasing = T)]
# 
# table(book_df$arrest_charge_original)[order(table(book_df$arrest_charge_original), decreasing = T)]
# 
# table(book_df$arrest_charge)[order(table(book_df$arrest_charge), decreasing = T)]

# book_df %>%
#   count(arrest_charge_original, arrest_charge) %>%
#   group_by(arrest_charge) %>%
#   add_count() %>%
#   filter(n > 1) %>%
#   arrange(arrest_charge)




#arrest_charge_code_original = paste0(strapplyc(charge_original, "^([A-Z]{2}).*", simplify = T)),
    #code_type = ifelse(code_type == "character(0)", NA, code_type),
    #code_type = na.locf(code_type),
    #arrest_charge_level = strapplyc(charge_level_original, "^(.).*", simplify = T),
    #Collapsing charge in this way does not result in any mismatched charges
      # separate_rows(arrest_charge_original, sep = "\\\\|\\/") %>%
         # cii = as.numeric(gsub("[^0-9]", "", cii)),
         # attempt = if_else(grepl("^ATTEMPT", arrest_charge_description), 1, 0),
         # conspire = if_else(grepl("^CONSPIRE", arrest_charge_description), 1, 0),
         # county = "Sonoma



# Diagnostics
# book_df %>%
#   distinct(local_id, book_date) %>%
#   arrange(local_id) %>%
#   group_by(local_id) %>%
#   add_count() %>%
#   filter(n>1)


```


Court Data
```{r}
# Court Case Data Import--- Sonoma, min "1999-08-30" 1st qu "2016-05-16" to max "2020-06-29" (cumulative)
  ## court_cases contains one row per court case and includes some basic information about the court case
  ## court_charges contains one row per each charge associated with a court case and includes information on the charges.
  ## court_disposition contains one row per disposition for each charge. 
  ## court_charge_disp was created as a join of court_charges and court_disposition, matching each charge to its disposition so that court_ and conviction_ flags could be specified. One row per charge.
  ## court_sentence contains one row per sentence  
  ## court_plea has one row per plea. This is generally one plea per charge, but some charges have multiple pleas. In the collapse we will filter down to the earliest plea.
  ## court_person contains one row per court case, with basic information on the defendant
  ## court_fta contains one row per fta and court case. distinct was called to remove duplicate rows
  ## court_hearing contains one row per hearing.distinct was called to remove duplicate rows
  ## NOT USED: court_ra contains one row per assessment event, which can be a report received, filed, or requested. Sometimes there is more than one line per case and date when there is more than one event. 
  ## NOT USED: court_status contains information about the status of the case that was deemed irrelevant and not included in the court collapse. There are only 214 rows.
 ## NOT USED: court_final_disposition contains one row per case, with the date of the final disposition and some information about the disposition of the overall case. 

####


# Court cases
  ## court_cases contains one row per court case and includes some basic information about the court case
court_cases <- read.csv("Historical Data Submissions/Sonoma/P2 Submission-June 30/PTR_Cases.csv", stringsAsFactors = FALSE) 


# Variable name standardization--See pg. xxx for more details. 
names(court_cases) <- c("court_case_id", "court_docket_id", "party_id", "name", "file_date", "ra_referal", "ra_report")


# Date Reformatting--See pg. xxx for more details.
court_cases <- court_cases %>%
  mutate_at(vars(file_date), ymd_hms)%>%
  mutate_at(vars(file_date), as_date)



####

# Court charges
  ## court_charges contains one row per each charge associated with a court case and includes information on the charges.
  ##The column names are changed in the import because there are a few extra columns with sparsely populated strings that do not import correctly if the columns are not named. The text in these excess columns is likely part of the last filled in column, court_charge_description, with improper separators creating new columns. Currently the extra columns are being deleted, but if court_charge_description is needed the trash columns could also be appended to the court_charge_description text
court_charges <- read.csv("Historical Data Submissions/Sonoma/P2 Submission-June 30/PTR_Charges.csv", stringsAsFactors = FALSE, col.names = c("court_case_id", "court_docket_id", "charge_id", "file_type", "court_charge_original", "court_charge_level_original", "court_charge_description", "trash1", "trash2", "trash3")) %>%
  select(-c(trash1, trash2, trash3))


# Charge Standardization and Flag Adds--See pg. xxx for more details.
court_charges <- court_charges %>%
  mutate(
    court_charge_code_original = str_extract(court_charge_original, "^[A-Z]{2}"),
    court_charge = gsub("^[A-Z]{2}", "", court_charge_original),
    attempt_flag = if_else(grepl("^664", court_charge), 1, 0),
    court_charge = gsub("^664", "", court_charge),
    ## need to fix this next line so that it flags these as enhancements
    court_charge = gsub("\\(11370.2\\(a\\)\\)|\\(1192.7\\(c|\\(pc1203.07\\(a\\)\\(1|\\(12022.95\\)|\\(pc1203.07|\\(pc1203.0", "", court_charge),
    court_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}","", court_charge)),
    court_charge_level = gsub("\\*", "", court_charge_level_original),
    court_charge_level = str_extract(court_charge_level, "^."),
    qualifier_flag = if_else(court_charge_level == "E", 1, 0),
    court_charge_level = if_else(court_charge_level %in% c("F", "M", "I"), court_charge_level, "Other"),
    court_charge_code = if_else(court_charge_code_original %in% c("PC", "VC", "HS", "BP", "WI","US"), court_charge_code_original, "Other")) %>%
  unite(join_var, court_charge_level, court_charge_code, court_charge, remove = F) 

load("Complete Charge Code Hierarchy.RData")

court_charges <- left_join(court_charges, charge_hier, by = "join_var")

####

# Court disposition
  ## court_disposition contains one row per disposition for each charge. 
  ##Because a small number of charges have multiple dispositions (eg deferred entry of judgment followed by convicted, or convicted followed by expungement), we will take the first disposition on each charge.
court_disposition <- read.csv("Historical Data Submissions/Sonoma/P2 Submission-June 30/PTR_Disposition.csv", stringsAsFactors = FALSE) 


# Variable name standardization--See pg. xxx for more details.
names(court_disposition) <- c("court_case_id", "court_docket_id", "charge_id", "disposition_type_original", "dispo_type_description", "disposition_date")


# Date Reformatting--See pg. xxx for more details.
  ## Also here eliminating secondary dispositions so that there is only one row per charge, representing the earliest disposition
court_disposition <- court_disposition %>%
  mutate_at(vars(disposition_date),ymd_hms) %>%
  mutate_at(vars(disposition_date), as_date) %>%
  arrange(disposition_date) %>%
  distinct(charge_id, .keep_all = T)

# Standardize Factors--See pg. xxx for more details.
court_disposition <- court_disposition %>%
  mutate(disposition_type = case_when(disposition_type_original %in% c("DISM", "P", "DI", "A", "DSCGPX", "D1203.4", "DSCH", "M", "CSA", "E", "DWHW") ~ "Dismissed",
                                      disposition_type_original %in% c("GNC") ~ "Nolo_Contendere",
                                      disposition_type_original %in% c("CONV", "ADMT", "FGC", "FT", "FGJ", "PRV") ~ "Guilty",
                                      disposition_type_original %in% c("AA", "FNGJ", "FNT") ~ "Not_Guilty",
                                      disposition_type_original %in% c("") ~ "Unknown",
                                      T ~ "Other"))



####

# court_charge_disp was created as a join of court_charges and court_disposition, matching each charge to its disposition so that court_ and conviction_ flags could be specified. One row per charge.
  ##creating court_charge_disp which joins each charge with its corresponding disposition so that we can put conviction flags on the charges
court_charge_disp <- court_charges %>%
  mutate(charge_id = as.numeric(charge_id)) %>%
  left_join(court_disposition) 


# Charge Flags Add--See pg. xxx for more details.
court_charge_disp <- court_charge_disp %>%
  mutate(felony_flag = if_else(court_charge_level == "F", 1, 0),
         misd_flag = if_else(court_charge_level == "M", 1, 0)) %>%
  mutate_at(vars(contains("flag")), funs("conviction" = if_else(. == 1 & disposition_type %in% c("Guilty", "Nolo_Contendere"), 1, 0))) %>%
  rename_at(vars(contains("flag"), -contains("conviction")), funs(paste0("court_", .))) %>%
  rename_at(vars(contains("conviction")), funs(paste0("conviction_", gsub("_conviction", "", .))))


####

# Court sentence
  ## court_sentence contains one row per sentence
court_sentence <- read.csv("Historical Data Submissions/Sonoma/P2 Submission-June 30/PTR_Sentence.csv", stringsAsFactors = FALSE) 

# Variable name standardization--See pg. xxx for more details.
names(court_sentence) <- c("court_case_id", "court_docket_id", "charge_id", "sentence_type_original", "sentence_type_desc", "sentence_date", "confinement_type", "sentence_location", "years", "months", "days", "ytl", "ytl_parole_elig", "life", "life_parole_elig", "death", "confinement_stayed", "probation_type", "probation_status_date", "probation_status_code", "probation_status_code_desc")


# Date Reformatting--See pg. xxx for more details.
court_sentence <- court_sentence %>%
  mutate_at(vars(sentence_date, probation_status_date),ymd_hms) %>%
  mutate_at(vars(sentence_date, probation_status_date),as_date)



# Flags Add--See pg. xxx for more details.
court_sentence <- court_sentence %>%
  mutate(court_sup_vio_post_flag = if_else(sentence_type_original == "VOP", 1, 0)) %>%
  mutate(sentence_type = case_when(sentence_type_original %in% c("JAL", "1170H", "1170MS") ~ "Jail",
                                      sentence_type_original %in% c("CDCR") ~ "Prison",
                                      sentence_type_original %in% c("FP") ~ "Probation",
                                       T ~ "Other"))



####


# Court plea
  ## court_plea has one row per plea. This is generally one plea per charge, but some charges have multiple pleas. In the collapse we will filter down to the earliest plea.
court_plea <- read.csv("Historical Data Submissions/Sonoma/P2 Submission-June 30/PTR_Plea.csv", stringsAsFactors = FALSE) 


# Variable name standardization--See pg. xxx for more details.
names(court_plea) <- c("court_case_id", "court_docket_id", "charge_id", "plea_type_original", "plea_type_desc", "plea_date")


# Date Reformatting--See pg. xxx for more details.
court_plea <- court_plea%>%
  mutate_at(vars(plea_date),ymd_hms) %>%
  mutate_at(vars(plea_date),as_date)


# Standardize Factors--See pg. xxx for more details.
court_plea <- court_plea %>%
  mutate(plea_type = case_when(plea_type_original %in% c("NP", "V") ~ "Other",
                               plea_type_original %in% c("N", "DEN") ~ "Not_Guilty",
                               plea_type_original %in% c("C") ~ "Nolo_Contendere",
                               plea_type_original %in% c("") ~ "NA",
                               plea_type_original %in% c("G", "ADM") ~ "Guilty",
                               T ~ "Other"))



####

# Court person
  ## court_person contains one row per court case, with basic information on the defendant
court_person <- read.csv("Historical Data Submissions/Sonoma/P2 Submission-June 30/PTR_Defendant.csv", stringsAsFactors = FALSE) 


# Variable name standardization--See pg. xxx for more details.
names(court_person) <- c("court_case_id", "court_docket_id", "case_party_id","party_id",  "cii", "fbi", "local_id", "cdl_id", "name", "dob", "sex_original", "race_original")


# Date Reformatting--See pg. xxx for more details.
court_person <- court_person %>%
  mutate_at(vars(dob),mdy) 


# Standardize Factors--See pg. xxx for more details.
court_person <- court_person %>%
  mutate(race = case_when(race_original %in% c("White") ~ "White",
                          race_original %in% c("Black") ~ "Black",
                          race_original %in% c("Hispanic") ~ "Hispanic",
                          T ~ "Other_Unknown"),
         sex = case_when(sex_original %in% c("Male") ~ "Male",
                         sex_original %in% c("Female") ~ "Female",
                         T ~ "Other_Unknown")
         )




####



# Court fta
  ## court_fta contains one row per fta and court case. distinct was called to remove duplicate rows
court_fta <- read.csv("Historical Data Submissions/Sonoma/P2 Submission-June 30/PTR_FTA.csv", stringsAsFactors = FALSE) %>%
  distinct()


# Variable name standardization--See pg. xxx for more details.
names(court_fta) <- c("court_case_id", "court_docket_id", "court_fta_nowar_flag", "fta_date_time", "court_fta_flag", "fta_warrant_date_time")


# Date Reformatting--See pg. xxx for more details.
court_fta <- court_fta %>%
  mutate_at(vars(fta_date_time, fta_warrant_date_time),ymd_hms) %>%
  mutate(fta_date =  as_date(fta_date_time)) %>%
  mutate(fta_warrant_date = as_date(fta_warrant_date_time))



####


# Court hearing
  ## court_hearing contains one row per hearing.distinct was called to remove duplicate rows
court_hearing <- read.csv("Historical Data Submissions/Sonoma/P2 Submission-June 30/PTR_Hearing.csv", stringsAsFactors = FALSE) %>%
  distinct()


# Variable name standardization--See pg. xxx for more details.
names(court_hearing) <- c("court_case_id", "court_docket_id", "hearing_type_original", "hearing_type_desc", "hearing_date_time")


# Date Reformatting--See pg. xxx for more details.
court_hearing <- court_hearing %>%
  mutate_at(vars(hearing_date_time),ymd_hms) %>%
  mutate(hearing_date =  as_date(hearing_date_time)) 

# Standardize Factors--See pg. xxx for more details.
  ## Sonoma said that the hearing type is not their primary way of identifying arraignments. The word searches used here to identify arraignment hearings are incomplete and do not identify all arraignments, but when asked Sonoma said that other hearing types can identify arraignments or other non-arraignment hearings so these data may be insufficient to identify arraignments. They said to use event codes instead. ARCOMP - defendant arraigned on complaint by court/stipulation; ARINFO - defendant arraigned on information by court/stipulation.
court_hearing <- court_hearing %>%
  mutate(hearing_type = case_when(grepl("Arraignment", hearing_type_desc) ~ "Arraignment",
                                  grepl("First Appearance", hearing_type_desc) ~ "Arraignment",
                                  grepl("Sentencing", hearing_type_desc) ~ "Sentencing",
                                  T ~ "Other"))



# Flags Add--See pg. xxx for more details.
court_hearing <- court_hearing %>%
  mutate(court_sup_vio_post_flag = if_else(hearing_type_desc %in% c("Violation of Probation", "Violation of Formal Probation", "Possible Violation of Probation", "Hearing Re: Violation of Probation", "Violation of Mandatory Supervision", "Violation of Formal Probation Hearing", "Violation of Post Release Community Supervision", "Violation of Parole Supervision", "RPO RE VOP", "Trailing - Violation of Probation", "Violation of Parole Supervision Hearing"), 1, 0),
         court_sup_vio_pre_flag = if_else(hearing_type_desc %in% c("Violation of Pretrial Release"), 1, 0))



#### NOT USED


# Court risk assessment
  ## court_ra contains one row per assessment event, which can be a report received, filed, or requested. Sometimes there is more than one line per case and date when there is more than one event. 
court_ra <- read.csv("Historical Data Submissions/Sonoma/P2 Submission-June 30/PTR_Risk_Assessment.csv", stringsAsFactors = FALSE) 

# Variable name standardization--See pg. xxx for more details.
names(court_ra) <- c("court_case_id", "case_party_id", "party_id", "ra_report_date", "assessment_code", "assessment_code_desc", "cii", "fbi", "local_id", "cdl_id", "name", "dob", "sex_original", "race_original")


# Date Reformatting--See pg. xxx for more details.
court_ra <- court_ra%>%
  mutate_at(vars(ra_report_date),ymd_hms) %>%
  mutate_at(vars(ra_report_date),as_date) %>%
  mutate_at(vars(dob), mdy) 


# Standardize Factors--See pg. xxx for more details.
court_ra <- court_ra %>%
  mutate(race = case_when(race_original %in% c("White") ~ "White",
                          race_original %in% c("Black") ~ "Black",
                          race_original %in% c("Hispanic") ~ "Hispanic",
                          T ~ "Other_Unknown"),
         sex = case_when(sex_original %in% c("Male") ~ "Male",
                         sex_original %in% c("Female") ~ "Female",
                         T ~ "Other_Unknown")
         )



#### NOT USED

# Court case status
  ## court_status contains information about the status of the case that was deemed irrelevant and not included in the court collapse. There are only 214 rows.
court_status <- read.csv("Historical Data Submissions/Sonoma/P2 Submission-June 30/PTR_Case_Status.csv", stringsAsFactors = FALSE) 


names(court_status) <- c("table", "code_id", "case_status", "case_status_desc", "obsolete_date")

court_status <- court_status %>%
  mutate_at(vars(obsolete_date), mdy_hm) %>%
  mutate_at(vars(obsolete_date), as_date)



#### NOT USED

# Court disposition
  ## court_final_disposition contains one row per case, with the date of the final disposition and some information about the disposition of the overall case. 
  ## This table is not needed because we have the diposition information for each charge in the case as well as the dates in other tables.
court_final_disposition <- read.csv("Historical Data Submissions/Sonoma/P2 Submission-June 30/SonomaCourt_Final_Case_Disposition_20200110_1.csv", stringsAsFactors = FALSE) 


names(court_final_disposition) <- c("court_case_id", "court_docket_id", "final_dispo_date", "closure_code", "closure_desc")

court_final_disposition <- court_final_disposition %>%
  mutate_at(vars(final_dispo_date),ymd_hms) %>%
  mutate_at(vars(final_dispo_date), as_date) 


#### they added another table, PTR_Final_Disp_Date
```


Court Collapse
```{r}
# Court Charge Collapse--See pg. xxx for more details about this process. 
  ## warnings suppressed because when you min the sentence date it returns a warning when sentence date is missing which crashes the code in bulk.
suppressWarnings(court_dispo <- court_charge_disp %>%
  mutate(disposition_type = ordered(disposition_type, levels = c("Other", "Dismissed", "Not_Guilty", "Nolo_Contendere", "Guilty"))) %>%
  mutate(hierarchy = if_else(is.na(hierarchy), 1e6, as.numeric(hierarchy))) %>%
  group_by(court_case_id) %>%
  mutate(disposition_date = max(disposition_date),
         disposition_type = max(disposition_type),
         sentence_date = min(sentence_date, na.rm = T)) %>%
  mutate(max_court_charge_level = court_charge_level[hierarchy == min(hierarchy)][1],
         max_court_charge_code = court_charge_code[hierarchy == min(hierarchy)][1],
         max_court_charge = court_charge[hierarchy == min(hierarchy)][1],
         max_charge_description = master_charge_description[hierarchy == min(hierarchy)][1],
         max_hier = min(hierarchy)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, as.numeric(.)))) %>%
  mutate_at(vars(contains("flag")), funs("count" = sum(.))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  filter(hierarchy == min(hierarchy)) %>%
  ungroup() %>%
  distinct(court_case_id, .keep_all = T) )


# Court FTAs are collapsed to each case. 
  ## Court Ftas are not separate from warrants
court_fta_war <- court_fta %>%
  arrange(fta_date) %>%
  group_by(court_case_id) %>%
  mutate(fta_flag = max(court_fta_flag),
         fta_flag_count = sum(court_fta_flag)) %>%
  ungroup() %>%
  distinct(court_case_id, .keep_all = T) 


# Court hearings are filtered for arraignment information and collapsed to court case id. 
  ## some arraignments are missing, see court data section for more detail
court_hearings <- court_hearing %>%
  group_by(court_case_id) %>%
  mutate(court_sup_vio_post_flag = max(court_sup_vio_post_flag),
         court_sup_vio_pre_flag = max(court_sup_vio_pre_flag)) %>%
  ungroup() %>%
  filter(hearing_type == "Arraignment") %>%
  rename(arraignment_date_time = hearing_date_time, arraignment_date = hearing_date) %>%
  arrange(arraignment_date_time) %>%
  distinct(court_case_id, .keep_all = T) %>%
  select(-c(hearing_type_original, hearing_type_desc, hearing_type))



# collapse pleas by case
  ## we are keeping the earliest plea date, but adding a guilty plea flag in case they later changed their plea
court_pleas <- court_plea %>%
  filter(!is.na(plea_date)) %>%
  arrange(plea_date) %>%
  mutate(guilty_plea_flag = if_else(plea_type %in% c("Guilty", "Nolo_Contendere"), 1, 0)) %>%
  group_by(court_case_id) %>%
  mutate(guilty_plea_flag = max(guilty_plea_flag)) %>%
  ungroup() %>%
  distinct(court_case_id, .keep_all = T) %>%
  select(court_case_id, court_docket_id, plea_date, plea_type, guilty_plea_flag)


# collapse sentences by case --See pg. xxx for more details about this process.
court_sent <- court_sentence %>%
  arrange(sentence_date) %>%
  mutate(sentence_type = ordered(sentence_type, levels = c("Other", "Probation", "Jail", "Prison"))) %>% 
  group_by(court_case_id) %>%
  mutate(sentence_type = max(sentence_type)) %>%
  ungroup() %>%
  distinct(court_case_id, .keep_all = T)


## court_person is already collapsed
court_person

court_df <- reduce(list(court_person, court_dispo, court_fta_war, court_hearings, court_pleas, court_sent), left_join, by = c("court_case_id")) %>%
  #rename(jail_court_id.2 = jail_court_id.x, jail_court_id.3 = jail_court_id.y) %>%
  select(-contains(".y")) %>%
  select(-contains(".x.x")) %>%
  select(-c(party_id, name)) %>%
  #select(-court_docket_id) %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x", "", .))) %>%
  mutate(pretrial_end_date = if_else(disposition_date <= sentence_date|is.na(sentence_date), disposition_date, sentence_date),
         conviction_flag = if_else(disposition_type %in% c("Guilty","Nolo_Contendere"), 1, 0))


#### NOT USED

court_rat <- court_ra %>%
  arrange(ra_report_date) %>%
  distinct(court_case_id, .keep_all = T) 


```

Court diagnostics
```{r}

  
# Diagnostics
# court_fta %>%
#   count(fta_all_flag)
# 
# court_fta_war %>%
#   count(fta_flag)
# 
# full_join(court_fta %>% filter(fta_all_flag == 1), court_fta_war %>% filter(fta_flag == 1) %>% rename(fta_date = fta_war_date), by = c("court_case_id", "fta_date")) %>%
#   filter(fta_all_flag != fta_flag) %>%
#   add_count(court_case_id) %>%
#   filter(n > 1) %>%
#   arrange(court_case_id, fta_date)
# 
# court_hearing %>%
#   count(hearing_type_original) %>%
#   arrange(desc(n))
#   
# court_charge %>%
#   filter(stage %in% c("DISPOSITION EVENT")) %>%
#   select(-c(disposition_num, charge_id, charge_history_id, offense_id, disposition_hist_id, disposition_id, disposition_type_code, amend_reason_id, amend_reason))
#   # filter(stage %in% c("Sentence Event")) %>%
#   count(dispos) %>%
#   arrange(desc(n))
#   
# court_dispo %>%
#   distinct(court_case_id, disposition_date, .keep_all = T) %>%
#   add_count(court_case_id) %>%
#   filter(n > 1) %>%
#   arrange(desc(n))
# 
# court_charge %>%
#   filter(stage %in% c("PLEA EVENT")) %>%
#   count(disposition_type_original) %>%
#   arrange(desc(n))
#   distinct(court_case_id, disposition_date, .keep_all = T) %>%
#   add_count(court_case_id) %>%
#   filter(n > 1) %>%
#   arrange(desc(n))
#   # select(-c(disposition_num, charge_id, charge_history_id, offense_id, disposition_hist_id, disposition_id, disposition_type_code, amend_reason_id, amend_reason))
#   # filter(stage %in% c("Sentence Event")) %>%
#   count(dispos) %>%
#   arrange(desc(n))
# 
# court_charge %>%
#   # filter(stage %in% c("CASE FILING")) %>%
#   # filter(stage %in% c("SENTENCE EVENT", "DISPOSITION EVENT")) %>%
#   # distinct(court_case_id) 
#   count(stage)
#   filter(court_case_id == "921214")
# 
#   court_df %>%
#     filter(conviction_flag == 1) %>%
#     filter(!disposition_type %in% c("Guilty", "Nolo_Contendere")) %>%
#     count(disposition_type, sentence_type) %>%
#     #count(court_charge_code, court_charge_level) %>%
#     arrange(desc(n))

```



Probation Data
```{r}

# Probation Data Import--- Sonoma, 2015-01-01 to 2020-07-07
  ## prob_assess contains one row per pretrial risk assessment (SPRAT), with data for any pretrial release event pertaining to that SPRAT, and one row for any pretrial release event that was not associated to a SPRAT. The primary keys in this file are the sprat_id (unique identifier for each SPRAT assessment) and croa_key (unique identifier for each pretrial grant). 
  ##prob_cond includes the terms and conditions ordered by the Court that are associated with a pretrial grant. The file contains one row per condition, for each pretrial grant. The unique grant of pretrial can be identified by the croa_key field. 
  ##prob_court_date_notification presents the each court reminder phone call made to a defendant while on pretrial release. The file is structured with 1 row per notification attempt. For each defendant on pretrial, it includes the defendant’s court date, the date of the reminder notification(s) and the result of each notification attempt. 
  ##prob_violation includes a row for each documented technical violation of pretrial release. 
  ##prob_case will assist in linking the Court’s dataset to Probation’s dataset at the case level. It includes a row for each case with a grant of Pretrial release, along with the court’s case number (SCR number) as well as the ccas_key, an internal case identifier.  
  ##prob_link will assist in linking Probation’s pretrial assessment data with the Jail’s and Court’s datasets. This file presents each case that is associated with the booking on which the pretrial assessment was conducted. Cases with both pending filed charges at the time of booking and new booking charges are included. Charge information for each of these cases can be obtained through the Jail data elements. 


####


# Probation assessments
  ## prob_assess contains one row per pretrial risk assessment (SPRAT), with data for any pretrial release event pertaining to that SPRAT, and one row for any pretrial release event that was not associated to a SPRAT. The primary keys in this file are the sprat_id (unique identifier for each SPRAT assessment) and croa_key (unique identifier for each pretrial grant). 
prob_assess <- read.csv("Historical Data Submissions/Sonoma/P2 Submission-June 30/Probation Data File - 1 of 6 - 20200713.csv", stringsAsFactors = FALSE) 

names_df1 <- tibble(original_field = names(prob_assess)) 


# Variable name standardization--See pg. xxx for more details. 
names(prob_assess) <- c("record_type", "sprat_id", "croa_key", "tool_name", "assessment_date_time", "booking_adr_street", "booking_adr_city", "zip_code_booking", 
                        "ptr_adr_line1", "ptr_adr_line2", "ptr_adr_street", "ptr_adr_city", "ptr_adr_state", "zip_code_ptr", "x1_dv_arrest", "x2_dui_arrest", 
                        "x3_violence_arrest", "x4_employed_or_student", "x5_gang_affiliation", "x6_homeless", "x7_MH_code_violent_behavior", "x8_no_prior_FTA", 
                        "x9_pending_cases", "x10_prior_jail", "x11_2orless_charges", "enh1_dv_order_last7yr", "enh2_dui_conv", "enh2_dv_conv", "enh3_FTAs", 
                        "enh5_prior_conv", "enh_bac", "enh_dv_injury", "enh_children_present", "enh_victim_injury", "enh_victim_injury_pc243", "enh_victim_injury_pc273_5", "enh_on_probation", "risk_score", "recommendation_before_enhancements", "release_recommendation_original", "release_override", "override_reason", "pretrial_release_type_original", "release_authorization", "release_date_time", "other_pretrial_service", "pretrial_termination_date", "outcome_fta_signup", "outcome_fta_court", "outcome_new_criminal_referral", "cii", "fbi", "lent_key", "dl_state", "cdl_id", "name", "dob", "sex_original", "race_original")

names_df1$field <- names(prob_assess)

# Date Reformatting--See pg. xxx for more details.
prob_assess <- prob_assess %>%
  mutate_at(vars(assessment_date_time, release_date_time), mdy_hm) %>%
  mutate_at(vars(pretrial_termination_date, dob), dmy) %>%
  mutate(assessment_date = as_date(assessment_date_time),
         release_date = as_date(release_date_time))



# Standardize Factors--See pg. xxx for more details.
prob_assess <- prob_assess %>%
    mutate(race_original = trimws(race_original),
        race = case_when(race_original %in% c("White") ~ "White",
                          race_original %in% c("Black") ~ "Black",
                          race_original %in% c("Hispanic") ~ "Hispanic",
                          T ~ "Other_Unknown"),
         sex = case_when(sex_original %in% c("M") ~ "Male",
                         sex_original %in% c("F") ~ "Female",
                         T ~ "Other_Unknown")
         ) %>%
  mutate(assess_flag = if_else(is.na(sprat_id), 0, 1),
         release_recommendation_original = trimws(release_recommendation_original),
         release_recommendation = case_when(release_recommendation_original %in% c("Detain or Enhanced Supervision") ~ "Detain",
                                            release_recommendation_original %in% c("Court Reminder") ~ "OR",
                                            release_recommendation_original %in% c("Basic Supervision", "Moderate Supervision", "Enhanced Supervision") ~ "Monitor",
                                            T ~ "Other_Unknown"),
         monitor_level_recommended = case_when(release_recommendation == "Basic Supervision" ~ "Low",
                                               release_recommendation == "Moderate Supervision" ~ "Medium",
                                               release_recommendation %in% c("Enhanced Supervision", "Detain or Enhanced Supervision") ~ "High",
                                               release_recommendation == "Court Reminder" ~ "None",
                                               T ~ NA_character_),
         monitor_level = case_when(pretrial_release_type_original == "Basic Supervision" ~ "Low",
                                   pretrial_release_type_original == "Moderate Supervision" ~ "Medium",
                                   pretrial_release_type_original == "Enhanced Supervision" ~ "High",
                                   pretrial_release_type_original == "Court Reminder" ~ "None",
                                   T ~ NA_character_),
         release_decision = case_when(pretrial_release_type_original %in% c("Basic Supervision", "Moderate Supervision", "Enhanced Supervision") ~ "Monitor",
                                      pretrial_release_type_original %in% c("Court Reminder") ~ "OR",
                                      T ~ "Other_Unknown"),
         
         pretrial_termination_reason = case_when(outcome_new_criminal_referral == "New Criminal Referral" ~ "New_Crime",
                                                 outcome_fta_court == "FTA Court" ~ "FTA",
                                                 outcome_fta_signup == "FTA Sign Up" ~ "Violation",
                                                 !is.na(pretrial_termination_date) ~ "Case_Disposed", 
                                                 T ~ "Other_Unknown"
                                                 ),
         
         pretrial_termination_outcome = case_when(pretrial_termination_reason %in% c("Case_Disposed") ~ "Successful",
                                                  pretrial_termination_reason %in% c("Abscond", "FTA", "New_Crime", "Violation") ~ "Unsuccessful",
                                                  pretrial_termination_reason %in% c("Not_Tracked") ~ "Not_Tracked",
                                                  T ~ "Other_Unknown")
  )
## TO ASK: does outcome_fta_signup result in a termination? how about the other otucomes? if they are missing a termination date does it mean they haven't been terminated or that we are missing a termination date? if they don't have a fta/signup/new crime outcome but they do have a termination date, does that mean the case was successfully disposed?

## TO ASK: for the 20K missing pretrial release type, what is the release type? How should we interpret?


####


# Probation conditions
  ##prob_cond includes the terms and conditions ordered by the Court that are associated with a pretrial grant. The file contains one row per condition, for each pretrial grant. The unique grant of pretrial can be identified by the croa_key field. 
  ##Terms and conditions are provided in text format as displayed in the court minutes, however, if the term or condition has an alpha-numeric register action code associated with it, the court register code is provided. 
  ##NOTE: orders for electronic monitoring (including GPS and Alcohol Monitoring) frequently appear in text format. While we identified EM conditions by searching the court register text for commonly used terms related to EM orders, the data on EM conditions might be incomplete. 
prob_cond <- read.csv("Historical Data Submissions/Sonoma/P2 Submission-June 30/Probation Data File - 2 of 6 - 20200713.csv", stringsAsFactors = FALSE) 

names_df2 <- tibble(original_field = names(prob_cond)) 

# Variable name standardization--See pg. xxx for more details.
names(prob_cond) <- c("lent_key", "croa_key", "release_conditions_original", "registercode")

names_df2$field <- names(prob_cond)

# Flag Adds--See pg. xxx for more details.
prob_cond <- prob_cond %>%
  mutate(condition_em_flag = if_else(grepl("MONITOR|CAM|GPS", toupper(release_conditions_original)), 1, 0),
         condition_no_contact_flag = if_else(grepl("DO NOT CONTACT|NO CONTACT", toupper(release_conditions_original)), 1, 0),
         condition_drug_test_flag = if_else(grepl("ALCOHOL MONITOR|CAM", toupper(release_conditions_original)), 1, 0)
  )




####


# Probation court date notifications
  ##prob_court_date_notification presents the each court reminder phone call made to a defendant while on pretrial release. The file is structured with 1 row per notification attempt. For each defendant on pretrial, it includes the defendant’s court date, the date of the reminder notification(s) and the result of each notification attempt. 
  ##This data file is at the individual level; the Lent_Key field can be used to identify the defendant receiving the call. 
prob_court_date_notification <- read.csv("Historical Data Submissions/Sonoma/P2 Submission-June 30/Probation Data File - 3 of 6 - 20200713.csv", stringsAsFactors = FALSE) 

names_df3 <- tibble(original_field = names(prob_court_date_notification)) 

# Variable name standardization--See pg. xxx for more details.
names(prob_court_date_notification) <- c("lent_key", "court_date_time", "notification_date_time", "notification_result")

names_df3$field <- names(prob_court_date_notification)

# Date Reformatting--See pg. xxx for more details.
prob_court_date_notification <- prob_court_date_notification %>%
  mutate_at(vars(court_date_time, notification_date_time), mdy_hms) %>%
  mutate(court_date = as_date(court_date_time),
         notification_date = as_date(notification_date_time))


# Flag Adds--See pg. xxx for more details.
prob_court_date_notification <- prob_court_date_notification %>%
  mutate(court_date_reminder_flag = if_else(grepl("Delivered", notification_result), 1, 0))


####


# Probation violations
  ##prob_violation includes a row for each documented technical violation of pretrial release. 
  ##There are 2 methods used to identify pretrial violations: (1) Presence of a bench warrant issued for a Violation of Pretrial Release, and (2) a court register action indicating the Petition for Violation of Pretrial has been filed. Individuals who failed to sign up or report to Pretrial are excluded. Violations may also be filed in response to one of the other pretrial outcomes (failure to appear in court, or new criminal referrals). 
  ##NOTE: the Violations data provided is incomplete. We know there are other technical violations that occur and to which Pretrial Officers respond, that are not identified through a bench warrant or through this particular register action. The Probation Department manually tracks violations each month, though this was not feasible to report for the 5 year history. In addition, these register actions and category of bench warrant were not utilized regularly until mid-2017, so the data are not available prior to mid-2017. 
prob_violation <- read.csv("Historical Data Submissions/Sonoma/P2 Submission-June 30/Probation Data File - 4 of 6 - 20200713.csv", stringsAsFactors = FALSE) 

names_df4 <- tibble(original_field = names(prob_violation)) 

# Variable name standardization--See pg. xxx for more details.
names(prob_violation) <- c("croa_key", "lent_key", "pretrial_violation_original", "pretrial_violation_date")

names_df4$field <- names(prob_violation)

# Date Reformatting--See pg. xxx for more details.
prob_violation <- prob_violation %>%
  mutate_at(vars(pretrial_violation_date), mdy) %>%
  mutate(pretrial_violation_flag = if_else(is.na(pretrial_violation_original), 0, 1))


####


# Probation court case
  ##prob_case will assist in linking the Court’s dataset to Probation’s dataset at the case level. It includes a row for each case with a grant of Pretrial release, along with the court’s case number (SCR number) as well as the ccas_key, an internal case identifier.  
prob_case <- read.csv("Historical Data Submissions/Sonoma/P2 Submission-June 30/Probation Data File - 5 of 6 - 20200713.csv", stringsAsFactors = FALSE) 
names_df5 <- tibble(original_field = names(prob_case)) 


# Variable name standardization--See pg. xxx for more details.
names(prob_case) <- c("croa_key", "ccas_key", "lent_key", "court_docket_id", "court_case_id")

names_df5$field <- names(prob_case)

####


# Probation linking info
  ##prob_link will assist in linking Probation’s pretrial assessment data with the Jail’s and Court’s datasets. This file presents each case that is associated with the booking on which the pretrial assessment was conducted. Cases with both pending filed charges at the time of booking and new booking charges are included. Charge information for each of these cases can be obtained through the Jail data elements. 
prob_link <- read.csv("Historical Data Submissions/Sonoma/P2 Submission-June 30/Probation Data File - 6 of 6 - 20200713.csv", stringsAsFactors = FALSE) 

names_df6 <- tibble(original_field = names(prob_link)) 

# Variable name standardization--See pg. xxx for more details.
names(prob_link) <- c("sprat_id", "lent_key", "book_num", "book_date", "ccas_key", "court_docket_id", "court_case_id")

names_df6$field <- names(prob_link)

# Date Reformatting--See pg. xxx for more details.
prob_link <- prob_link %>%
  mutate_at(vars(book_date), mdy)

# prob_assess %>%
#   view()
#   count(outcome_fta_signup)
# 
# 
# prob_violation %>%
#   count(violation)
```

Probation Collapse
```{r}

#collapse violations to each release
prob_vio <- prob_violation %>%
  arrange(pretrial_violation_date) %>%
  distinct(croa_key, .keep_all = T)

#collapse conditions to each release
  ##for now just using EM flag, ignoring all other conditions. can create flags for other conditions as well here.
prob_conds <- prob_cond %>%
  #rename(lent_key = lent_jey) %>% #typo got in somewhere
  group_by(croa_key) %>%
  mutate(condition_em_flag = max(condition_em_flag)) %>%
  ungroup() %>%
  distinct(croa_key, .keep_all = T) %>%
  select(-c(registercode))
  
  
# join the linking files
prob_join <- prob_link %>%
  full_join(prob_case)


## assess_df contains one row per person, assessment, release, court case, booking combination. The reason it is not collapsed to each assessment is because it is valuable to join the jail/court/probation data. It will be collapsed later.
assess_df <- prob_assess %>%
  left_join(prob_vio, by = c("croa_key", "lent_key")) %>%
  left_join(prob_conds, by = c("croa_key", "lent_key")) %>%
  left_join(prob_join) 
  

```

Assessment Tables 
```{r}
assess_table <- prob_assess %>%
  # Collapse to each assessment.
  distinct(sprat_id, .keep_all = T) %>%
  # Filter for only those actually assessed
  filter(!is.na(assessment_date)) %>%
  # Create county name.
  mutate(county = "Sonoma") %>%
  mutate(tool_name = "SPRAT") %>%
  # Select relevants variables.
  select(county, release_recommendation, release_decision, assessment_date, risk_score, tool_name, assessment_date, dob, sex, race, pretrial_termination_outcome, pretrial_termination_reason)

# Save file  
#fwrite(assess_table, file = "G:/CrimJustice/PretrialAssessmentPilot/Assessment Output Tables/Sonoma Assessment Output 09-2020.csv")


```


  
Assessment Tables 10/2020
```{r}
suppressWarnings(book_join <-  book_df %>%
  select(book_num, charge_level) %>%
  mutate(charge_level = ordered(charge_level, levels = c("Other", "I", "M", "F"))) %>%
  group_by(book_num) %>%
  mutate(charge_level = max(charge_level, na.rm = T)) %>%
  ungroup() %>%
  distinct(book_num, .keep_all = T) %>%
  mutate(book_num = as.numeric(book_num)))

assess_table <- assess_df %>%
  # Collapse to each assessment.
  distinct(sprat_id, .keep_all = T) %>%
  # Filter for only those actually assessed
  filter(!is.na(assessment_date)) %>%
  left_join(book_join) %>%
  # Create county name.
  mutate(county = "Sonoma") %>%
  mutate(tool_name = "SPRAT") %>%
  mutate(risk_level = NA_character_) %>%
  # Select relevants variables.
  select(county, release_recommendation, release_decision, assessment_date, risk_score, tool_name, assessment_date, dob, sex, race, charge_level, risk_level, monitor_level, pretrial_termination_outcome, pretrial_termination_reason)

# Save file  
#fwrite(assess_table, file = "G:/CrimJustice/PretrialAssessmentPilot/Assessment Output Tables/Sonoma Assessment Output 10-2020.csv")


```
  
Probation Diagnostics
```{r}
prob_assess  #sprat_id is a unique identifier for each SPRAT assessment. croa_key is a unique identifier for each pretrial grant
prob_case  #croa_key is a unique identifier for each pretrial grant. lent_key is a unique identifier for a defendant used by probation
prob_cond  #join on croa_key, collapse first to unique croa_key with condition flags #need to figure out what all the register codes are. or can just use the EM flag and ignore the rest?
prob_court_date_notification #only has lent_key and dates #just use notification flag?
prob_link
prob_violation #just use warrants issued? also has petitions filed #join by croa_key. but one croa_key can have multiple violations. keep the earliest violation and date

# prob_link <- prob_link %>%
#   mutate(croa_key = NA_integer_)
# 
# prob_case <- prob_case %>%
#   mutate(sprat_id = NA_integer_, book_num = NA_integer_, book_date = as_date(NA))
# 
# prob_join <- union(prob_link, prob_case)

prob_assess %>%
  add_count(lent_key, release_date_time) %>%
  filter(n>1)

prob_assess %>%
  distinct(croa_key, lent_key) %>%
  arrange(croa_key) %>%
  group_by(croa_key) %>%
  add_count() %>%
  ungroup() %>%
  filter(n>1)

prob_assess %>%
  filter(is.na(sprat_id) & is.na(croa_key))
#croa_key is na if there was no pretrial release
#sprat_id is na if there was no risk assessment performed
#these are never both na

prob_case %>%
  distinct(croa_key)

prob_case %>%
  group_by(croa_key) %>%
  add_count() %>%
  filter(n>1) %>%
  arrange(croa_key)  #one croa_key can map onto many court cases

prob_link %>%
  distinct(sprat_id) #one sprat_id can map onto many court cases

semi_join(prob_case, prob_link)  
semi_join(prob_link, prob_case)
anti_join(prob_case, prob_link)
anti_join(prob_link, prob_case)

sort(names(prob_link))
sort(names(prob_case)) #only unique variable is croa_key
```

Assessment code book (9/2020) 
```{r}

names_df <- bind_rows(names_df1, names_df2, names_df3, names_df4, names_df5, names_df6)

names_df <- names_df %>%
  mutate(
    modified_field = case_when(
      field == "sex_original" ~ "sex",
      field == "race_original" ~ "race",
      field == "risk_level_original" ~ "risk_level",
      field == "release_recommendation_original" ~ "release_recommendation, monitor_level_recommended",
      field == "pretrial_release_type_original" ~ "release_decision, monitor_level",
      field == "release_decision_original" ~ "release_decision, pretrial_ineligible_reason",
      field == "release_conditions_original" ~ "condition_em_flag, condition_no_contact_flag",
      field == "outcome_new_criminal_referral" ~ "pretrial_termination_reason",
      field == "outcome_fta_court" ~ "pretrial_termination_reason",
      field == "outcome_fta_signup" ~ "pretrial_termination_reason",
      field == "pretrial_termination_date" ~ "pretrial_termination_reason",
      #field == "release_authorization_original" ~ "release_authorization",
      field == "notification_result" ~ "court_date_reminder_flag",
      field == "release_conditions_original" ~ "condition_em_flag, condition_no_contact_flag, condition_drug_test_flag",
      field =="pretrial_violation_original" ~ "pretrial_violation_flag"
    )) %>%
  filter(!is.na(modified_field)) %>%
  separate_rows(modified_field, sep = ",") %>%
  mutate_all(trimws)



factor_df <- lapply(c('prob_assess'), function(i){
  df <- get(i)
  
  df <- lapply(c(1:nrow(names_df))[names_df$field %in% names(df)], function(j){
    df <- df %>%
      select(value = names_df$field[j], 
             modified_value = names_df$modified_field[j]) %>%
      group_by_all() %>%
      count() %>%
      arrange(desc(n)) %>%
      group_by(modified_value)  %>%
      summarise(value = paste(value, collapse = ", "), n = sum(n)) %>%
      ungroup() %>%
      mutate(percent = round(n/sum(n)*100, 1),
             total = sum(n)) %>%
      mutate(field = names_df$field[j], modified_field = names_df$modified_field[j]) %>%
      arrange(desc(n)) %>%
      select(field, modified_field, value, modified_value, n, percent, total) %>%
      mutate_all(as.character)
      
      
    
    return(df)
  }) %>% bind_rows()
 
  df <- df %>% mutate(table_name = i)
   }) %>% 
  bind_rows() %>%
  left_join(names_df) %>%
  select(table_name, original_field, field, modified_field, value, modified_value, total, percent)
  



factor_df <- factor_df %>%
  mutate(value = case_when(
    modified_field == "pretrial_termination_reason" & modified_value == "FTA" ~ "outcome_fta_court = 'FTA Court'",
    modified_field == "pretrial_termination_reason" & modified_value == "New_Crime" ~ "outcome_new_criminal_referral = 'New Criminal Referral'",
    modified_field == "pretrial_termination_reason" & modified_value == "Violation" ~ "outcome_fta_signup = 'FTA Sign Up'",
    modified_field == "pretrial_termination_reason" & modified_value == "Case_Disposed" ~ "pretrial_termination_date EXISTS AND outcome_new_criminal_referral BLANK AND outcome_fta_court BLANK AND outcome_fta_signup BLANK",
    T ~ value)) %>%
  group_by(modified_field, value) %>%
  mutate_at(vars(original_field, field), funs(paste(., collapse = ", "))) %>%
  distinct(modified_field, value, .keep_all = T) %>%
  ungroup()


flag_df <- lapply(c('prob_cond', 'prob_violation', 'prob_court_date_notification'), function(i){
  df <- get(i)
  
  df <- lapply(c(1:nrow(names_df))[names_df$field %in% names(df)], function(j){
    df <- df %>%
      select(value = names_df$field[j], modified_value = names_df$modified_field[j]) %>%
      group_by_all() %>%
      count() %>%
      arrange(desc(n)) %>%
      group_by(modified_value) %>%
      summarise(value = paste(value, collapse = ", "), n = sum(n)) %>%
      ungroup() %>%
      mutate(percent = round(n/sum(n)*100, 1),
             total = sum(n)) %>%
      mutate(field = names_df$field[j], modified_field = names_df$modified_field[j]) %>%
      arrange(desc(n)) %>%
      select(field, modified_field, value, modified_value, n, percent, total) %>%
      mutate_all(as.character)
    
    return(df)
  }) %>% bind_rows() 
  
 df <- df %>% mutate(table_name = i)
   }) %>%

  bind_rows() %>%
  left_join(names_df) %>%
  select(table_name, original_field, field, modified_field, value, modified_value, total, percent)


flag_df <- flag_df %>%
  filter(modified_value == 1) %>%
  mutate(value = case_when(
  modified_field == "condition_no_contact_flag" & modified_value == "1" ~ "MATCHES (DO NOT CONTACT, NO CONTACT)",
  modified_field == "condition_em_flag" & modified_value == "1" ~ "MATCHES (CAM, MONITOR, GPS)",
  modified_field == "condition_drug_test_flag" & modified_value == "1" ~ "MATCHES (ALCOHOL MONITOR, CAM)",
  modified_field == "pretrial_violation_flag" & modified_value == "1" ~ "IF pretrial_violation_original EXISTS",
  modified_field == "court_date_reminder_flag" & modified_value == "1" ~ "MATCHES (DELIVERED)",
  T ~ value)) %>%
  group_by(modified_field, value) %>%
  mutate_at(vars(original_field, field), funs(paste(., collapse = ", "))) %>%
  distinct(modified_field, value, .keep_all = T) %>%
  ungroup()
  



date_df <- lapply(ls()[!grepl("original|^df|hier|names|factor|date|flag", ls())], function(i){
  df <- get(i)
  
   if(sum(grepl("date", names(df))) > 0){
  df2 <- df %>%
  select(contains("date"), -contains("time"), -contains("court")) %>%
  gather("field", "value") %>%
  group_by(field) %>%
  summarise_all(funs(min_date = as.character(min(., na.rm = T)),  max_date = as.character(max(., na.rm = T)))) %>%
    mutate(table_name = i)
  }else{
    df2 <- tibble(field = NA_character_, min_date = NA_character_,  max_date = NA_character_, table_name = i)
  }
}) %>%
  bind_rows() %>%
  select(table_name, field, min_date, max_date) %>%
  filter(!is.na(field))
  



#write.xlsx(list(factor_df, flag_df, date_df), file = "G:/CrimJustice/PretrialAssessmentPilot/Code Books/Assessment Code Book/Sonoma Assessment Code Book 9-20.xlsx", asTable = T, tableStyle = "TableStyleMedium1", colWidths = "auto", sheetName = c("Factors", "Flags", "Dates"))

```


Code Book
```{r eval=FALSE, include=FALSE}
rm(original_field)

original_df <- bind_rows(original_df)

Sonoma_df <- lapply(ls()[!grepl("original", ls())], function(i){
  df <- get(i)
  
  if(sum(grepl("date", names(df))) > 0){
  df2 <- df %>%
  select(contains("date"), -contains("time")) %>%
  gather("modified_field", "value") %>%
  group_by(modified_field) %>%
  summarise_all(funs(min = as.character(min(., na.rm = T)), mean = as.character(mean(., na.rm = T)), max = as.character(max(., na.rm = T))))
  }else{
    df2 <- tibble(modified_field = NA_character_, min = NA_character_, mean = NA_character_, max = NA_character_)
  }
  
  df <- df %>%
    mutate_if(~length(unique(.)) > 50|is.Date(.)|is.POSIXct(.), ~(. = "not_factor")) %>%    
    mutate_all(~if_else(is.na(.), "na_missing", as.character(.))) %>%
    gather(modified_field, factor_value) %>%
    count(modified_field, factor_value) %>%
    mutate(table_name = i, county = "Sonoma") %>%
    mutate(factor_flag = if_else(factor_value == "not_factor", 0, 1)) %>%
    group_by(table_name, modified_field) %>%
    mutate(table_count = sum(n)) %>%
    ungroup() %>%
    rename("factor_count" = "n") %>%
    mutate(factor_count = if_else(factor_value == "not_factor", NA_integer_, factor_count),
           factor_percent = round(factor_count/table_count*100, 1)) %>%
    arrange(desc(factor_flag), modified_field, desc(factor_count))
  
  df <- left_join(df, df2, by = "modified_field")
    }) %>% 
  bind_rows() %>%
  left_join(original_df) %>%
   select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_count,
           factor_percent, table_count, min, mean, max) 

write.xlsx(Sonoma_df, file = "Code Books/Sonoma Code Book.xlsx")
```

Completion
```{r}
files <- list.files("G:/CrimJustice/PretrialAssessmentPilot/Code Books/Code Book Notes", pattern = "Sonoma", full.names = T)

df <- lapply(files, read_excel)

df[[2]] <- df[[1]] %>%
  mutate(factor_standard = "") %>%
  select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_standard, factor_count, factor_percent, 
         table_count, "sl_notes" = NOTES, min, mean, max)

df <- list(df[[2]], df[[1]])

#write.xlsx(df, file = "G:/CrimJustice/PretrialAssessmentPilot/Code Books/Variable Construction/Sonoma Factor Construction.xlsx", asTable = T, tableStyle = "TableStyleMedium1", sheetName = c("Variable Construction", "sl_notes"))
```


Factors codebook
```{r}
factor_df <- lapply(ls()[!grepl("original|^df|hier", ls())], function(i){
  df <- get(i)
  if(sum(grepl("original", names(df))) == 0){
    return(NULL)
  }else{
    var_names <- names(df)[grepl("original", names(df))]
    var_names2 <- gsub("_original", "", var_names)
   
    df1 <- df %>%
     select(var_names) %>%
     gather(original_field, original_value)
   
    df2 <- df %>%
     select(var_names2) %>%
     gather(modified_field, modified_value)
   
   df <- bind_cols(df1, df2) %>%
     count(original_field, modified_field, original_value, modified_value) %>%
     arrange(modified_field, desc(n)) %>%
     group_by(modified_field) %>%
     mutate(row = row_number(),
            percent = round(n/sum(n)*100)) %>%
     ungroup() %>%
     filter(row <= 50) %>%
     select(-row) %>%
     rename("total" = n)
   }
  }) %>%
  bind_rows()

#write.xlsx(factor_df, file = "G:/CrimJustice/PretrialAssessmentPilot/Code Books/Factor Code Book/Sonoma Factor Code Book.xlsx", asTable = T, tableStyle = "TableStyleMedium1", colWidths = "auto")
```


DOJ CII/Linking Extraction
```{r}
# Grab Tables with CIIo
df <- sapply(ls()[which(sapply(ls(), function(i){
  sum(names(get(i)) %in% "cii")
}) == 1)], get)

# Pull CII and other identifiers
doj_book <- df[[1]] %>%
  select(cii, fbi, dl_number, name, dob, sex, race, lent_key) %>%
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) %>%
  distinct()

doj_court <- df[[2]] %>%
  select(cii, fbi, local_id, cdl_id, name, dob, sex, race, party_id) %>%
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) %>%
  distinct()

doj_court2 <- df[[3]] %>%
  select(cii, fbi, local_id, cdl_id, name, dob, sex, race, party_id) %>%
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) %>%
  distinct()

doj_prob <- df[[4]] %>%
  select(cii, fbi, dl_number, name, dob, race, sex) %>%
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) %>%
  distinct()


# Examine missing ciis and duplicates on cii. 
doj_book %>% #Off by about 55,000
  distinct()

doj_book %>% 
  distinct(cii)

doj_book %>% 
  distinct() %>%
  add_count(cii) %>%
  filter(n > 1) %>%
  arrange(desc(n)) %>% 
  View()

doj_court %>% #Off by about 45,000
  distinct()

doj_court %>% 
  distinct(cii)

doj_court %>% 
  distinct() %>%o
  add_count(cii) %>%
  filter(n > 1) %>%
  arrange(desc(n)) %>% 
  View()


#CIIs for DOJ
doj_cii <- bind_rows(doj_book %>% select(cii), doj_court %>% select(cii), doj_court2 %>% select(cii), doj_prob %>% select(cii)) %>% distinct()


#Create an excel workbook with all data table. Make sure to include the cii table first. 
write.xlsx(list(doj_cii, doj_book, doj_court, doj_court2, doj_prob), file = "CIIs for DOJ/Sonoma CIIs and Demographics for DOJ.xlsx", sheetName = c("ciis", "booking", "court", "court2", "assessment"))
```

CII extraction 10.2020
```{r}
# Grab Tables with CII
df_list <- lapply(
  ls()[which(lapply(ls(), function(i){
    sum(names(get(i)) %in% "cii")
    }) == 1)],
  function(j){
    df <- get(j)
    df <- df %>%
      select(any_of(c("cii", "cdl_id", "fbi", "name", "last_name", "first_name", "middle_name", "dob", "sex_original", "race_original"))) %>%
       mutate(
         cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) %>%
  distinct()
 
})

# CIIs from assessment tables
doj_assess <- bind_rows(df_list[[4]])

# CIIs from booking tables
doj_book <- bind_rows(df_list[[1]])

# CIIs from court person tables
doj_court_person <- bind_rows(df_list[[2]])

# CIIs from court RA tables
doj_court_ra <- bind_rows(df_list[[3]])

#CIIs for DOJ
doj_cii <- bind_rows(doj_assess %>% select(cii), doj_book %>% select(cii), doj_court_person %>% select(cii), doj_court_ra %>% select(cii))  %>% 
  distinct() %>%
  filter(nchar(cii) == 10)


#Create an excel workbook with all data table. Make sure to include the cii table first.
#write.xlsx(list(doj_cii, doj_book, doj_court_person, doj_court_ra, doj_assess), file = "G:/CrimJustice/PretrialAssessmentPilot/CIIs for DOJ/October 2020/Sonoma P2 CIIs and Demographics for DOJ.xlsx", sheetName = c("ciis", "booking", "court person", "court ra", "assessment"))
```


Join
  Jail Court Join
```{r}
# Remove extraneous objects in the environment
#rm(list = ls()[!ls() %in% ls(pattern = "df")])

#Check for common variables
names(book_df2)[names(book_df2) %in% names(assess_df)]

names(book_df2)[names(book_df2) %in% names(court_df)]
#court_docket_id, court_case_id, cii, fbi, cdl_id, name, dob

#Turning NULL to NA to ensure non matching and removing generic charge info from data frames
book_df2 <- book_df2 %>%
  mutate_if(is.character, list(~na_if(., "NULL"))) %>%
  select(-c(charge, charge_level, charge_code)) %>%
  mutate_at(vars(name), toupper)

assess_df <- assess_df %>%
  mutate_if(is.character, list(~na_if(., "(Missing)"))) %>%
  select(-c(id, court))

court_df <- court_df %>%
  mutate_if(is.character, list(~na_if(., "NULL"))) %>%
  select(-c(charge, charge_level, charge_code)) %>%
  mutate_at(vars(name), toupper)


court_df %>%
  select(court_case_id, court_docket_id)

book_df2 %>%
  select(court_case_id, court_docket_id)
#one of them needs to be switched, court_case_id in one is court_docket_id in the other. FIXED.

# #Joining Assessment to Jail Data
# join1 <- inner_join(book_df, assess_df, by = "book_num", na_matches = "never") %>%
#   rename_at(vars(contains(".x")), funs(gsub("\\.x$", "", .))) %>%
#   select(-contains(".y")) %>%
#   #1 Duplicate with missing dispositions which will be dropped later. 
#   distinct()
# 
# j1 <- anti_join(book_df, assess_df, by = "book_num", na_matches = "never")
# a1 <- anti_join(assess_df, book_df, by = "book_num", na_matches = "never")
# 
# 
#   #Examine if set of common variables is distinct--yes
#   semi_join(book_df, assess_df, by = "book_num", na_matches = "never") %>%
#     distinct()
# 
# #Joining on Name and Court ID
# join2 <- inner_join(j1, a1, by = c("first_name", "last_name", "book_date" = "interview_date"), 
#                     na_matches = "never") %>%
#   rename_at(vars(contains(".x")), funs(gsub("\\.x$", "", .))) %>%
#   select(-contains(".y")) %>%
#   #1 Duplicate with missing dispositions which will be dropped later. 
#   distinct()
# 
# j2 <- anti_join(j1, a1, by = c("first_name", "last_name", "book_date" = "interview_date"), na_matches = "never")
# a2 <- anti_join(a1, j1, by = c("first_name", "last_name", "interview_date" = "book_date"), na_matches = "never")
# 
#   #Examine if set of common variables is distinct--yes
#   semi_join(j1, a1, by = c("first_name", "last_name", "book_date" = "interview_date"), 
#             na_matches = "never") %>%
#     distinct()
#   
# #Diagnostics
#   #Jail and Assessment Matches by category
# tibble(
#   stage = 1:2,
#   match = c(
#     'c("book_num")',
#     'c("first_name", "last_name", "book_date" = "interview_date")'
#   ),
#   # jail_match_rate = sapply(1:2, function(i) {
#   #   (nrow(book_df) - nrow(get(paste0("j", i)))) / nrow(book_df) * 100
#   # }),
#   assess_match_rate = sapply(1:2, function(i) {
#     (nrow(assess_df) - nrow(get(paste0("a", i)))) / nrow(assess_df) * 100
#   })
# )
# 
# #Recreating Booking--Should be same number of rows.
# book_df <- bind_rows(join1, join2, j2)  
# 
# rm(list = ls()[!ls() %in% ls(pattern = "df")])

# Court Matching
#Joining on CII and Court ID
join1 <- inner_join(book_df2, court_df, by = c("court_case_id"), na_matches = "never") %>%
  rename(court_fta_data_flag = court_fta_flag) %>%
  rename(court_fta_data_flag_count = court_fta_flag_count) %>%
  rename_at(vars(contains(".x")), funs(paste0("arrest_", gsub("\\.x$", "", .)))) %>%
  rename_at(vars(contains(".y")), funs(paste0("court_", gsub("\\.y$", "", .)))) %>%
  distinct()

j1 <- anti_join(book_df2, court_df, by = c("court_case_id"), na_matches = "never")
c1 <- anti_join(court_df, book_df2, by = c("court_case_id"), na_matches = "never")

  #Examine if set of common variables is distinct
  join1 %>%
    add_count(court_case_id) %>%
    filter(n > 1) %>%
    arrange(desc(n))

names(join1)[names(join1) %in% names(assess_df)]

assess_df <- assess_df %>%
  mutate(court_case_id = as.character(court_case_id))

join2 <- join1 %>%
  left_join(assess_df, by = c("book_num", "court_case_id"), na_matches = "never")


# 
# #Joining on Name and Court ID
# join2 <- inner_join(j1, c1, by = c("court_docket_id", "first_name", "dob"), na_matches = "never") %>%
#   rename_at(vars(contains(".x")), funs(paste0("arrest_", gsub("\\.x$", "", .)))) %>%
#   rename_at(vars(contains(".y")), funs(paste0("court_", gsub("\\.y$", "", .)))) %>%
#   #1 Duplicate with missing dispositions which will be dropped later. 
#   distinct()
# 
# j2 <- anti_join(j1, c1, by = c("court_docket_id", "first_name", "dob"), na_matches = "never")
# c2 <- anti_join(c1, j1, by = c("court_docket_id", "first_name", "dob"), na_matches = "never")
# 
#   #Examine if set of common variables is distinct--yes except 8 spurious cases.
#   join2 %>%
#     add_count(first_name, court_docket_id, book_num) %>%
#     filter(n > 1) %>%
#     arrange(desc(n))
# 
# #Joining on Court ID
# join3 <- inner_join(j2, c2, by = c("court_docket_id", "first_name"), na_matches = "never") %>%
#   rename_at(vars(contains(".x")), funs(paste0("arrest_", gsub("\\.x$", "", .)))) %>%
#   rename_at(vars(contains(".y")), funs(paste0("court_", gsub("\\.y$", "", .)))) %>%
#   #1 Duplicate with missing dispositions which will be dropped later. 
#   distinct()
# 
# j3 <- anti_join(j2, c2, by = c("court_docket_id", "first_name"), na_matches = "never")
# c3 <- anti_join(c2, j2, by = c("court_docket_id", "first_name"), na_matches = "never")
# 
#   #Examine if set of common variables is distinct--yes except 8 spurious cases.
#   join3 %>%
#     add_count(court_docket_id, book_num) %>%
#     filter(n > 1) %>%
#     arrange(desc(n))
#   
#Diagnostics
  #Jail and Court Matches by category
# tibble(
#   stage = 1:3,
#   match = c(
#     'c("court_docket_id", "cii", "dob")',
#     'c("court_docket_id", "first_name", "dob")',
#     'c("court_docket_id", "dob")'
#   ),
#   jail_match_rate = sapply(1:3, function(i) {
#     (nrow(book_df) - nrow(get(paste0("j", i)))) / nrow(book_df) * 100
#   }),
#   court_match_rate = sapply(1:3, function(i) {
#     (nrow(court_df) - nrow(get(paste0("c", i)))) / nrow(court_df) * 100
#   })
# )
# 
# join_df <- bind_rows(join1, join2, join3)
  
# join1 %>%
#   select(contains(".x")) %>%
#   names() %>%
#   sort()
# 
# join1 %>%
#   select(contains(".y")) %>%
#   names() %>%
#   sort()

#find the problem variable names that are messing up the rename
# names(join1)[grepl("\\.x", names(join1)) & paste0("arrest_", gsub("\\.x$", "", names(join1))) %in% names(join1)]
# 
# names(join1)[grepl("\\.y", names(join1)) & paste0("court_", gsub("\\.y$", "", names(join1))) %in% names(join1)]
#problem variables are fta_flag.y and fta_flag_count.y


```


