---
title: "R Notebook"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T)

knitr::opts_knit$set(root.dir = "G:/CrimJustice/PretrialAssessmentPilot")
```

# library
```{r include=FALSE}
library(data.table)
library(lubridate)
library(openxlsx)
library(readxl)
library(scales)
library(tidyverse)
```

# data element check
```{r}
lapply(df, function(i){
  if(is.character(i) == T)
    sum(is.na(i)|i == "NULL")
  else
    sum(is.na(i))
})

lapply(df, function(i){
  if(length(unique(i)) <= 50)
    table(i, useNA = "always")
})
```

# Calaveras

Jail Data
```{r}
# Jail Bookings Data Import--- Calaveras, 2015-01-01 to 2019-12-09
  ## book_df contains one row per booking and includes information on the person as well as the time of booking and release and booking charges.

####

# Booking Data
  ## book_df contains one row per booking and includes information on the person as well as the time of booking and release and booking charges.
book_df <- read_excel("Historical Data Submissions/Calaveras/JailData.xlsx", col_types = "text")

book_df <- book_df %>%
  # Disposition type is removed because the court data has cleaner disposition information.
  select(-`Offense Disposition`) %>%
  mutate_at(vars(`Offenders DOB`, `Release Date`), convertToDate)

  ## Use period 2 data to replace period 1 data.
  ## Period 2 data is imported separately because the data was submitted in a different format from the historical data.
  ## The format is changed to match the historical data before they are combined.
book_df_p2 <- fread("Historical Data Submissions/Calaveras/P2 Submission-June 30/1920 Q4 JailBooking.csv", colClasses = "character")

book_df_p2 <- book_df_p2 %>%
  # BJMHS variables and employment status are not in the historical data submissions.
  select(-contains("BJMHS"), -c(Employment_Status)) %>%
  mutate_at(vars(DOB, Physical_Release_Date), mdy) %>%
  mutate(Charge = gsub(";$", "", Charge))

con_df_p2 <- fread("Historical Data Submissions/Calaveras/P2 Submission-June 30/1920 Q4 Jail_Case_Convictions.csv", colClasses = "character")

con_df_p2 <- con_df_p2 %>%
  # Conviction variables are not in the historical data submissions.
  select(Court_Case_ID)

book_df_p2 <- bind_cols(book_df_p2, con_df_p2) %>%
  separate_rows(Charge, sep = ";") %>%
  mutate(`Offense Level` = case_when(
    grepl("misd", Charge, ignore.case = T) ~ "M",
    grepl("fel", Charge, ignore.case = T) ~ "F"
  ),
  Charge = trimws(gsub("Misd|Misd.|Fel|Fel.", "", Charge, ignore.case = T)))

names(book_df_p2) <- c("Offender's CII#", "Offender's FBI #", "Alpha #", "OLN#", "Offender's Name", "Offenders DOB", "Sex", "Race", "Arrest Date/Time", "Booking #", "Booking Date/Time", "Booking Type", "Offense", "Release Date", "Release Type/Reason", "Bail Amount", "Docket #", "Offense Level")

book_df <- book_df %>%
  bind_rows(book_df_p2) %>%
  distinct()

rm(book_df_p2, con_df_p2)

# Variable name standardization--See pg. xxx for more details.
names(book_df) <- c("name", "cii", "fbi", "alpha_num", "cdl_id", "race_original", "sex_original", "dob", "arrest_date", "book_num", "book_date", "book_type_original", "court_docket_id", "arrest_charge_original", "arrest_charge_level_original", "bail_amt", "disposition_date", "release_date", "release_type_original")

# Date Reformatting--See pg. xxx for more details.
book_df <- book_df %>%
  mutate_at(vars(arrest_date, book_date), funs(time = mdy_hm(.))) %>%
  mutate(arrest_date = as_date(arrest_date_time),
         book_date = as_date(book_date_time),
         disposition_date = convertToDate(disposition_date))

# Standardize Factors--See pg. xxx for more details.--See pg. xxx for more details.
  ## Dismissed/Cite and Release is ambiguous and needs to be followed up with Calaveras.
book_df <- book_df %>%
  mutate(race = case_when(
    race_original %in% c("H") ~ "Hispanic",
    race_original %in% c("B") ~ "Black",
    race_original %in% c("W") ~ "White",
    T ~ "Other_Unknown"
  ),
  sex = case_when(
    sex_original %in% c("F") ~ "Female",
    sex_original %in% c("M") ~ "Male",
    T ~ "Other_Unknown"
  ),
  # The book type provided only said "Local", so it is set to "Unknown".
  book_type = "Unknown",
  release_type = case_when(
    release_type_original %in% c("Own Recognizance", "Prearraignment O/R", "Pretrial O/R") ~ "OR",
    release_type_original %in% c("Citation", "DA Citation", "Cite and Release", "Dismissed/ Cite and Release") ~ "Cite_Release",
    release_type_original %in% c("Bonded", "Cash Bailed", "Bail") ~ "Bail_Bond",
    release_type_original %in% c("Pre trial release to Probation on EMP") ~ "Pretrial_Sup",
    release_type_original %in% c("Charges Dismissed or Dropped", "Insufficient Evidence 849 (b)(1) PC", "Charges not filed") ~ "Dismissed_Dropped",
    release_type_original %in% c("Served Time", "Time Served on EMP") ~ "Time_Served",
    release_type_original %in% c("Court Release") ~ "Court_Order",
    release_type_original %in% c("Transferred to Another Agency", "Transported to Program", "Hold", "Hold No Bail", "No Bail Felony Hold") ~ "Hold_Release",
    release_type_original %in% c("Detention Only 849 (b)(2) PC") ~ "Detain_Only",
    release_type_original %in% c("Time Served Over Capacity") ~ "Sent_Cap",
    release_type_original %in% c("Pre-Trial Release Lack of Housing") ~ "Unsent_Cap",
    release_type_original %in% c("Early Release Lack of Housing 4024.1 PC", "Early Work Release 4024.2 PC", "Over Capacity") ~ "Unspec_Cap",
    release_type_original %in% c("Pretrial O/R with Terms", "Prearraignment O/R with Terms") ~ "OR_Conditions",
    release_type_original %in% c("Transferred to CDCR", "Sentenced") ~ "Prison",
    release_type_original %in% c("Booking Only", "Transported to Program", "Failed Program", "No release") ~ "Unknown",
    T ~ "Other"
  ))

# Charge Standardization and Flag Adds--See pg. xxx for more details.
book_df <- book_df %>%
  mutate(attempt_flag = if_else(grepl("664/", arrest_charge_original), 1, 0),
         arrest_charge = gsub("664/", "", arrest_charge_original),
         arrest_charge = if_else(arrest_charge == "11377 PC", "11377 HS", arrest_charge)) %>%
  separate_rows(arrest_charge, sep = "/") %>%
  mutate(arrest_charge_code = case_when(
    grepl("PC", arrest_charge, ignore.case = T) ~ "PC",
    grepl("VC", arrest_charge, ignore.case = T) ~ "VC",
    grepl("HS", arrest_charge, ignore.case = T) ~ "HS",
    grepl("BP", arrest_charge, ignore.case = T) ~ "BP",
    grepl("WI", arrest_charge, ignore.case = T) ~ "WI",
    grepl("US", arrest_charge, ignore.case = T) ~ "US",
    T ~ "Other"
  ),
  arrest_charge = gsub(" [A-Z][A-Z]$| [A-Z][A-Z] fel| [A-Z][A-Z] f| [A-Z][A-Z] misd| [A-Z][A-Z] m", "", arrest_charge, ignore.case = T),
  arrest_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}", "", arrest_charge)),
  # These variables did not match the initial hierarchy. Check if they match the new hierarchy after the joining.
  arrest_charge = case_when(
    arrest_charge == "12032A" ~ "12032",
    arrest_charge == "29800A" ~ "29800A2",
    arrest_charge == "30305A" ~ "30305A1",
    arrest_charge == "3454B" ~ "3454C",
    T ~ arrest_charge
  ),
  arrest_charge_level = if_else(!arrest_charge_level_original %in% c("F", "M", "I"), "Other", arrest_charge_level_original)) %>%
  unite(join_var, arrest_charge_level, arrest_charge_code, arrest_charge, remove = F) %>%
  distinct()

load("Complete Charge Code Hierarchy.RData")

book_df <- book_df %>%
  left_join(charge_hier) %>%
  mutate(arrest_felony_flag = if_else(arrest_charge_level == "F", 1, 0),
         arrest_misd_flag = if_else(arrest_charge_level == "M", 1, 0)) %>%
  rename_at(vars(contains("flag")), funs(paste0("arrest_", .)))
```

  Jail Collapse
```{r}
# Booking Collapse--See pg. xxx for more details about this process.
book_df <- book_df %>%
  mutate(time_first_release = release_date - book_date,
         hierarchy = if_else(is.na(hierarchy), 1e6, as.numeric(hierarchy))) %>%
  group_by(book_num) %>%
  mutate(max_booktype = book_type[hierarchy == min(hierarchy)][1],
         max_arrest_charge = arrest_charge[hierarchy == min(hierarchy)][1],
         max_charge_description = master_charge_description[hierarchy == min(hierarchy)][1],
         max_charge_description = master_charge_description[hierarchy == min(hierarchy)][1],
         max_hier = min(hierarchy)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, as.numeric(.)))) %>%
  mutate_at(vars(contains("flag")), funs("count" = sum(.))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  group_by(book_num, court_docket_id) %>%
  filter(hierarchy == min(hierarchy)) %>%
  ungroup() %>%
  distinct(book_num, court_docket_id, .keep_all = T)
```

  Jail Diagnostics
```{r}
# charges
# 97.07805%
(1 - nrow(book_df %>% filter(is.na(hierarchy))) / nrow(book_df)) * 100

book_df %>%
  filter(is.na(hierarchy)) %>%
  count(join_var) %>%
  arrange(desc(n))

charge_hier %>%
  filter(grepl(3454, join_var))

book_df %>%
  filter(grepl(11377, join_var)) %>%
  count(arrest_charge_level_original, arrest_charge_original)

# collapse
book_df %>%
  # distinct(book_num, book_date) %>%
  arrange(book_num) %>%
  group_by(book_num) %>%
  add_count() %>%
  filter(n > 1)

book_df %>%
  distinct(book_num, book_date) 

book_df %>%
  distinct(book_num)

book_df %>%
  distinct(cii, book_num)
```

Court Data
```{r}
# Court Case Data Import--- Calaveras, 2015-06-26 to 2019-12-31
  ## court_person contains one row per court case and includes information on the person as well as file date.
  ## court_charge contains one row per each charge and charge disposition associated with a court case and includes information on the charges and dispostions of the court case.
  ## court_hearing contains one row per hearing event on each court case and includes informatioin about each hearing.
  ## court_sent contains one row per sentence event component in which the sentence event is confinement and one NULL row for each court case without a sentence event.

####

# Calaveras Excel sheets
  ## Calaveras submitted the data in an Excel file with multiple sheets and they are being imported separately and turned into the respective tables described above and below.
  ## Period 1 data was submitted in the same format.
court_sheets <- excel_sheets("Historical Data Submissions/Calaveras/CALAVERAS.xlsx")

court_df <- lapply(court_sheets, function(i) {
  read_excel("Historical Data Submissions/Calaveras/CALAVERAS.xlsx", sheet = i, col_types = "text")
})

court_sheets_p1 <- excel_sheets("Historical Data Submissions/Calaveras/CALAVERAS SQL Results 1-30-2020.xlsx")

court_df_p1 <- lapply(court_sheets_p1, function(i) {
  read_excel("Historical Data Submissions/Calaveras/CALAVERAS SQL Results 1-30-2020.xlsx", sheet = i, col_types = "text")
})

####

# Court Person Information
  ## court_person contains one row per court case and includes information on the person as well as file date.
court_person <- court_df[[9]] %>%
  bind_rows(court_df_p1[[9]]) %>%
  distinct()

# Variable name standardization--See pg. xxx for more details.
names(court_person) <- c("court_case_id", "court_docket_id", "last_name", "first_name", "middle_name", "file_date", "dob", "cii", "cdl_id", "fbi", "sex_original", "race_original", "dln_state", "ra_date")

# Date Reformatting--See pg. xxx for more details.
court_person <- court_person %>%
  mutate_at(vars(contains("date"), dob), convertToDate)

# Standardize Factors--See pg. xxx for more details.
court_person <- court_person %>%
  mutate(race = if_else(!race_original %in% c("Hispanic", "Black", "White"), "Other_Unknown", race_original),
         sex = if_else(sex_original == "NULL", "Other_Unknown", sex_original))

####

# Court Filing Charges
  ## court_charge contains one row per each charge and charge disposition associated with a court case and includes information on the charges and dispostions of the court case.
  ## Make sure to collapse dates before counting flags.
court_charge <- court_df[[2]] %>%
  bind_rows(court_df_p1[[2]]) %>%
  distinct()

# Variable name standardization--See pg. xxx for more details.
names(court_charge) <- c("court_case_id", "court_docket_id", "charge_num", "court_charge_original", "court_charge_level_original", "charge_description", "plea_date", "plea_type_original", "disposition_date", "disposition_type_original", "disposition_date_final")

# Date Reformatting--See pg. xxx for more details.
court_charge <- court_charge %>%
  mutate_at(vars(contains("date")), convertToDate)

# Standardize Factors--See pg. xxx for more details.
court_charge <- court_charge %>%
  mutate(plea_type = case_when(
    plea_type_original %in% c("No Contest") ~ "Nolo_Contendere",
    plea_type_original %in% c("Admit", "Guilty") ~ "Guilty",
    plea_type_original %in% c("Not Guilty", "Deny", "Not Guilty & Not Guilty by Reason of Insanity") ~ "Not_Guilty",
    T ~ "Other"
  ),
  disposition_type = case_when(
    disposition_type_original %in% c("Dismissed-Motion of the People", "Dismissed-Plea Negotiation", "Dismissed with Harvey Waiver", "Proof of Correction Provided Dismissed", "Dismissed-After Diversion", "Dismissed-Other Dismissal", "Dismissed-PC1385-Furtherance of Justice", "Dismissed VOP/OSC-Probation Reinstated", "Dismissal-Probation Supervision Transfer In", "Dismissed-PC871-Court Found Insufficient Cause", "Dismissed-PC995-Accusation Set Aside", "After hearing - Other dismissal", "Dismissed-PC1099-Defendant Became Witness for People") ~ "Dismissed",
    disposition_type_original %in% c("Nolo Contendre") ~ "Nolo_Contendere",
    disposition_type_original %in% c("Sentenced-Plea of Guilty/Nolo", "Sentenced-VOP/OSC/PRCS", "Found Guilty Court Trial", "Admits", "Trial by Declaration - Court Finding of Guilt", "Pled Guilty", "Court Finding of Guilt", "Jury Verdict of Guilty", "Sentenced-Violation of Parole", "Conviction after Jury Trial", "Probation Supervision Transfer In-Plea of Guilty/Nolo", "Sentenced-Probation Supervision Transfer In", "After hearing - Conviction - Sentenced-Plea of guilty/nolo c", "Before hearing - Conviction - Sentenced-Plea of guilty/nolo") ~ "Guilty",
    disposition_type_original %in% c("Found Not Guilty Court Trial", "Trial by Declaration - Acquital", "Jury Verdict-Acquittal", "Acquittal") ~ "Not_Guilty",
    T ~ "Other",
  ))

# Charge Standardization and Flag Adds--See pg. xxx for more details.
court_charge <- court_charge %>%
  mutate(attempt_flag = if_else(grepl("664/", court_charge_original), 1, 0),
         court_charge = gsub(".*/", "", court_charge_original),
         court_charge_code = gsub("[0-9].*", "", charge_description),
         court_charge_code = case_when(
           grepl("PC", court_charge_code, ignore.case = T) ~ "PC",
           grepl("VC", court_charge_code, ignore.case = T) ~ "VC",
           grepl("HS", court_charge_code, ignore.case = T) ~ "HS",
           grepl("BP", court_charge_code, ignore.case = T) ~ "BP",
           grepl("WI", court_charge_code, ignore.case = T) ~ "WI",
           grepl("US", court_charge_code, ignore.case = T) ~ "US",
           T ~ "Other"
         ),
         court_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}", "", court_charge)),
         # These variables did not match the initial hierarchy. Check if they match the new hierarchy after the joining.
         court_charge = case_when(
           court_charge == "12032A" ~ "12032",
           court_charge == "667D" ~ "667",
           court_charge == "29800A" ~ "29800A2",
           court_charge == "11358" ~ "11358C",
           court_charge == "11359" ~ "11359B",
           T ~ court_charge
         ),
         court_charge_level = case_when(
           court_charge_level_original %in% c("F", "F1", "F2") ~ "F",
           court_charge_level_original %in% c("M", "M1", "M2") ~ "M",
           court_charge_level_original %in% c("I") ~ "I",
           T ~ "Other"
         )) %>%
  unite(join_var, court_charge_level, court_charge_code, court_charge, remove = F) %>%
  distinct()

load("Complete Charge Code Hierarchy.RData")

court_charge <- court_charge %>%
  left_join(charge_hier) %>%
  mutate(felony_flag = if_else(court_charge_level == "F", 1, 0),
         misd_flag = if_else(court_charge_level == "M", 1, 0)) %>%
  rename_at(vars(contains("_flag")), funs(paste0("court_", .))) %>%
  mutate_at(vars(contains("_flag")), funs("conviction" = if_else(disposition_type %in% c("Nolo_Contendere", "Guilty") & . == 1, 1, 0))) %>%
  rename_at(vars(contains("_conviction")), funs(paste0("conviction_", gsub("court_|_conviction", "", .))))

####

# Court Hearings
  ## court_hearing contains one row per hearing event on each court case and includes informatioin about each hearing.
  ## Sometimes, multiple hearing types are on the same day.
court_hearing <- court_df[[3]] %>%
  bind_rows(court_df_p1[[3]]) %>%
  distinct()

# Variable name standardization--See pg. xxx for more details.
names(court_hearing) <- c("court_case_id", "court_docket_id", "hearing_date", "hearing_type_original", "hearing_result")

# Date Reformatting--See pg. xxx for more details.
court_hearing <- court_hearing %>%
  mutate(hearing_date = convertToDate(hearing_date))

# Standardize Factors--See pg. xxx for more details.
court_hearing <- court_hearing %>%
  mutate(hearing_type = case_when(
    grepl("arraignment", hearing_type_original, ignore.case = T) ~ "Arraignment",
    grepl("sentencing", hearing_type_original, ignore.case = T) ~ "Sentencing",
    T ~ "Other"
  ))

####

# Court FTAs with Warrants
court_fta_war <- court_df[[4]] %>%
  bind_rows(court_df_p1[[4]]) %>%
  distinct()

# Variable name standardization--See pg. xxx for more details.
names(court_fta_war) <- c("court_case_id", "court_docket_id", "fta", "fta_date", "fta_warrant", "fta_warrant_date", "fta_description")

# Date Reformatting--See pg. xxx for more details.
court_fta_war <- court_fta_war %>%
  mutate_at(vars(fta_date, fta_warrant_date), convertToDate)

# Flag Adds--See pg. xxx for more details.
court_fta_war <- court_fta_war %>%
  mutate(fta_flag = if_else(fta_description == "Bench Warrant", 1, 0),
         fta_all_flag = fta) %>%
  select(-c(fta, fta_warrant)) %>%
  # One duplicate FTA based on different FTA descriptions is removed.
  arrange(desc(fta_flag)) %>%
  distinct_at(vars(-c(fta_description, fta_flag)), .keep_all = T)

####

# Court Sentences to Confinement
  ## court_sent contains one row per sentence event component in which the sentence event is confinement and one NULL row for each court case without a sentence event.
court_sent <- court_df[[5]] %>%
  bind_rows(court_df_p1[[5]]) %>%
  distinct()

# Variable name standardization--See pg. xxx for more details.
names(court_sent) <- c("court_case_id", "court_docket_id", "sentence_date", "sentence_type_original", "sentence_loc", "sentence_term", "term_length")

# Date Reformatting--See pg. xxx for more details.
court_sent <- court_sent %>%
  mutate(sentence_date = convertToDate(sentence_date))

# Standardize Factors--See pg. xxx for more details.
court_sent <- court_sent %>%
  mutate(sentence_type = case_when(
    sentence_loc %in% c("County Jail") ~ "Jail",
    sentence_loc %in% c("State Prison") ~ "Prison",
    T ~ "Unk/Other Confinement"
  ))

####

# Court Sentences to Probation
court_probation <- court_df[[8]] %>%
  bind_rows(court_df_p1[[8]]) %>%
  distinct()

# Variable name standardization--See pg. xxx for more details.
names(court_probation) <- c("court_case_id", "court_docket_id", "sentence_date", "sentence_type_original", "sentence_loc", "term_length", "sentence_term")

# Date Reformatting--See pg. xxx for more details.
court_probation <- court_probation %>%
  mutate(sentence_date = convertToDate(sentence_date))

# Standardize Factors--See pg. xxx for more details.
court_probation <- court_probation %>%
  mutate(sentence_type = "Probation")

####

# Court Sentences Driver's License Conditions
  ## Use period 1 data to replace historical data submission.
court_dl_cond <- court_df_p1[[6]]

names(court_dl_cond) <- c("court_docket_id", "court_case_id", "sentence_date", "configuration_description", "screen_builder_data_entry_number", "description", "description2", "field_name", "field_value", "field_name2", "field_value2")

court_dl_cond <- court_dl_cond %>%
  mutate(sentence_date = as_date(sentence_date))

court_dl_cond <- court_dl_cond %>%
  mutate(sentence_type = "Other")

rm(court_df, court_df_p1, court_sheets, court_sheets_p1)

#### NOT USED ####

# # Court Statuses
# court_status <- court_df[[1]] %>%
#  bind_rows(court_df_p1[[1]]) %>%
#  distinct()
# 
# names(court_status) <- c("court_case_id", "court_docket_id", "status_date", "status")
# 
# court_status <- court_status %>%
#  mutate(status_date = as_date(status_date))
# 
# # Court Fines
#   ## Use period 1 data to replace historical data submission.
# court_fine <- court_df_p1[[7]]
# 
# names(court_fine) <- c("court_case_id", "fine")
```

  Court Collapse
```{r}
# Court Charge Collapse--See pg. xxx for more details about this process.
  ## Follow up with Calaveras about their disposition date information. Sometimes, disposition_date_final is before disposition_date. For now, we are using the earliest disposition date for each charge.

# Create court disposition table from court charge table.
court_dispo <- court_charge %>%
  select(-plea_date, -plea_type_original, -plea_type) %>%
  distinct() %>%
  mutate(disposition_date = if_else(disposition_date > disposition_date_final|is.na(disposition_date),
                                    disposition_date_final, disposition_date)) %>%
  arrange(disposition_date) %>%
  select(-disposition_date_final) %>%
  distinct(charge_num, court_case_id, join_var, .keep_all = T)

# Court dispositions are collapse to each case.
court_dispo <- court_dispo %>%
  mutate(disposition_type = ordered(disposition_type, levels = c("Other", "Dismissed", "Not_Guilty", "Nolo_Contendere", "Guilty"))) %>%
  group_by(court_case_id) %>%
  mutate(hierarchy = if_else(is.na(hierarchy), 1e6, as.numeric(hierarchy)),
         disposition_date = max(disposition_date),
         disposition_type = max(disposition_type),
         max_court_charge_level = court_charge_level[hierarchy == min(hierarchy)][1],
         max_court_charge_code = court_charge_code[hierarchy == min(hierarchy)][1],
         max_court_charge = court_charge[hierarchy == min(hierarchy)][1],
         max_charge_description = master_charge_description[hierarchy == min(hierarchy)][1],
         max_hier = min(hierarchy)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, .))) %>%
  mutate_at(vars(contains("flag")), funs("count" = sum(.))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  filter(hierarchy == min(hierarchy)) %>%
  ungroup() %>%
  distinct(court_case_id, .keep_all = T)

# Court FTAs are collapsed to each case.
court_fta_war <- court_fta_war %>%
  arrange(fta_warrant_date) %>%
  group_by(court_case_id) %>%
  mutate(fta_flag_count = sum(fta_flag),
         fta_flag = max(fta_flag),
         fta_all_flag_count = sum(fta_all_flag),
         fta_all_flag = max(fta_all_flag)) %>%
  distinct(court_case_id, .keep_all = T) %>%
  select(-c(fta_description))

# Court hearings are filtered for arraignment information and collapsed to court case id.
court_hearing <- court_hearing %>%
  filter(hearing_type == "Arraignment") %>%
  arrange(hearing_date) %>%
  rename(arraignment_date = hearing_date) %>%
  distinct(court_case_id, .keep_all = T) %>%
  select(court_case_id, court_docket_id, arraignment_date)

# Collapse pleas by case
  ## we are keeping the earliest plea date, but adding a guilty plea flag in case they later changed their plea
court_plea <- court_charge %>%
  filter(!is.na(plea_date)) %>%
  arrange(plea_date) %>%
  mutate(guilty_plea_flag = if_else(plea_type %in% c("Guilty", "Nolo_Contendere"), 1, 0)) %>%
  group_by(court_case_id) %>%
  mutate(guilty_plea_flag = max(guilty_plea_flag)) %>%
  ungroup() %>%
  distinct(court_case_id, .keep_all = T) %>%
  select(court_case_id, court_docket_id, plea_date, plea_type, guilty_plea_flag)

# Collapse sentences by case --See pg. xxx for more details about this process.
  ## Sentences to confinement and probation were initially separate and are now joined.
court_sent <- court_sent %>%
  bind_rows(court_probation) %>%
  arrange(sentence_date) %>%
  mutate(sentence_type = ordered(sentence_type, levels = c("Other", "Probation", "Jail", "Prison"))) %>%
  group_by(court_case_id) %>%
  mutate(sentence_type = max(sentence_type)) %>%
  ungroup() %>%
  distinct(court_case_id, .keep_all = T)

court_df <- reduce(list(court_person, court_dispo, court_fta_war, court_hearing, court_plea, court_sent), left_join, by = "court_case_id") %>%
  select(-contains(".x.x"), -contains(".y")) %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x", "", .))) %>%
  mutate(pretrial_end_date = if_else(disposition_date <= sentence_date|is.na(sentence_date), disposition_date, sentence_date),
         conviction_flag = if_else(disposition_type %in% c("Guilty","Nolo_Contendere"), 1, 0))
```

  Court Diagnostics
```{r}
# charges
# 97.08033%
(1 - nrow(court_charge %>% filter(is.na(hierarchy))) / nrow(court_charge)) * 100

court_charge %>%
  filter(is.na(hierarchy)) %>%
  count(join_var) %>%
  arrange(desc(n))

charge_hier %>%
  filter(grepl(66761, join_var))

court_charge %>%
  filter(grepl(66761, join_var)) %>%
  count(court_charge_level_original, court_charge_original, charge_description)
```

Probation Data
```{r}
  ## Use period 2 data to replace historical data submission and period 1 data.
prob_df <- fread("Historical Data Submissions/Calaveras/P2 Submission-June 30/1920 Q4 Probation_Pretrial.csv", colClasses = "character")

prob_df <- prob_df %>%
  filter(CII != "")

vio_df <- fread("Historical Data Submissions/Calaveras/P2 Submission-June 30/1920 Q4 Probation_Pretrial_Violations.csv", colClasses = "character")

vio_df <- vio_df %>%
  filter(CII != "")

prob_df <- prob_df %>%
  left_join(vio_df) %>%
  distinct()

rm(prob_df, vio_df)

# Variable name standardization--See pg. xxx for more details.
names(prob_df) <- c("cii", "fbi", "local_id", "cdl_id", "name", "dob", "sex_original", "race_original", "zip_code", "tool_name_original", "assessment_date_time", "tool_response1", "tool_response2", "tool_response2a", "tool_response3", "tool_response4", "tool_response5", "tool_response5a", "tool_response6", "tool_response7", "tool_response8", "tool_response9", "fta_score", "nca_score", "nvca_score", "release_recommendation_original", "release_authorization_original", "release_type_original", "release_date_time", "pretrial_conditions_original", "court_date_reminder", "pretrial_service_original", "termination_outcome", "termination_date", "ptr_violation", "ptr_violation_date_time", "ptr_warrant")

# Date Reformatting--See pg. xxx for more details.
prob_df <- prob_df %>%
  rename(assessment_date = assessment_date_time,
         termination_date_time = termination_date) %>%
  mutate_at(vars(release_date_time, termination_date_time, ptr_violation_date_time), funs(mdy_hm(if_else(grepl("[0-9]$", .), paste0(., "; 12:00 AM"), .)))) %>%
  mutate(dob = mdy(dob),
         assessment_date = mdy(assessment_date),
         release_date = as_date(release_date_time),
         termination_date = as_date(termination_date_time),
         ptr_violation_date = as_date(ptr_violation_date_time))

# Standardize Factors--See pg. xxx for more details.
prob_df <- prob_df %>%
  mutate(race = case_when(
    race_original %in% c("H") ~ "Hispanic",
    race_original %in% c("B") ~ "Black",
    race_original %in% c("W") ~ "White",
    T ~ "Other_Unknown"
  ),
  sex = case_when(
    sex_original %in% c("F") ~ "Female",
    sex_original %in% c("M") ~ "Male",
    T ~ "Other_Unknown"
  ),
  release_type = case_when(
    release_type_original %in% c("Dismissed/ Cite and Release") ~ "Cite_Release",
    release_type_original %in% c("Hold", "Hold No Bail", "No Bail on Felony Cases", "Parole Hold") ~ "Hold_Release",
    release_type_original %in% c("Detain") ~ "Detain_Only",
    release_type_original %in% c("O/R with Terms") ~ "OR_Conditions",
    release_type_original %in% c("Sentenced") ~ "Prison",
    T ~ "Other"
  ),
  tool_name = tool_name_original,
  release_recommendation = if_else(grepl("No Release", release_recommendation_original), "Detain", "Monitoring"),
  pretrial_conditions = case_when(
    grepl("EM", pretrial_conditions_original) ~ "EM",
    pretrial_conditions_original %in% c("N/A") ~ "None",
    T ~ "Other"
  ),
  pretrial_service = if_else(pretrial_service_original %in% c("No", "N/A"), "None", "Other"),
  release_authorization = release_authorization_original)

# Flag Adds--See pg. xxx for more details.
prob_df <- prob_df %>%
  mutate(sup_pre_flag = if_else(release_type == "OR_Conditions", 1, 0),
         sup_vio_pre_flag = if_else(!is.na(ptr_violation), 1, 0))
```

  Assessment Collapse
```{r}
# Assessment Collapse--See pg. xxx for more details about this process.
assess_df <- prob_df %>%
  distinct(local_id, assessment_date, .keep_all = T) %>%
  select(cii, fbi, cdl_id, local_id, name, dob, sex_original, race_original, sex, race, zip_code, tool_name, assessment_date, release_recommendation_original, release_recommendation)
```

Join
```{r}
# Remove extraneous objects in the environment
rm(list = ls()[!ls() %in% ls(pattern = "df")])

#Check for common variables
names(book_df)[names(book_df) %in% names(assess_df)]

names(book_df)[names(book_df) %in% names(court_df)]

#Turning NULL to NA to ensure non matching and removing generic charge info from data frames
book_df <- book_df %>%
  mutate_if(is.character, list(~na_if(., "NULL"))) %>%
  select(-c(charge, charge_level, charge_code)) %>%
  mutate_at(vars(name), toupper)

assess_df <- assess_df %>%
  mutate_if(is.character, list(~na_if(., "(Missing)")))
  # select(-c(id, court))

court_df <- court_df %>%
  mutate_if(is.character, list(~na_if(., "NULL"))) %>%
  select(-c(charge, charge_level, charge_code)) %>%
  # mutate_at(vars(first_name, last_name), toupper) %>%
  mutate(court_case_id = as.character(court_case_id))

#Joining Assessment to Jail Data
join1 <- inner_join(book_df, assess_df, by = c("cii", "book_date" = "assessment_date"), na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x$", "", .))) %>%
  select(-contains(".y")) %>%
  #1 Duplicate with missing dispositions which will be dropped later. 
  distinct()

j1 <- anti_join(book_df, assess_df, by = c("cii", "book_date" = "assessment_date"), na_matches = "never")
a1 <- anti_join(assess_df, book_df, by = c("cii", "assessment_date" = "book_date"), na_matches = "never")


  #Examine if set of common variables is distinct--yes
  semi_join(book_df, assess_df, by = c("cii", "book_date" = "assessment_date"), na_matches = "never") %>%
    distinct()
  
#Diagnostics
  #Jail and Assessment Matches by category
  # 5.333333%
tibble(
  stage = 1,
  match = c(
    # 'c("cii")',
    'c("cii", "book_date" = "assessment_date")'
  ),
  # jail_match_rate = sapply(1:2, function(i) {
  #   (nrow(book_df) - nrow(get(paste0("j", i)))) / nrow(book_df) * 100
  # }),
  assess_match_rate = sapply(1, function(i) {
    (nrow(assess_df) - nrow(get(paste0("a", i)))) / nrow(assess_df) * 100
  })
)

#Recreating Booking--Should be same number of rows.
book_df <- bind_rows(join1, j1)

rm(list = ls()[!ls() %in% ls(pattern = "df")])

# Court Matching
#Joining on CII and Court ID
join1 <- inner_join(book_df, court_df, by = c("cii", "dob"), na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(paste0("arrest_", gsub("\\.x$", "", .)))) %>%
  rename_at(vars(contains(".y")), funs(paste0("court_", gsub("\\.y$", "", .)))) %>%
  # 8 Duplicates with missing dispositions which will be dropped later.
  distinct()

j1 <- anti_join(book_df, court_df, by = c("cii", "dob"), na_matches = "never")
c1 <- anti_join(court_df, book_df, by = c("cii", "dob"), na_matches = "never")

  #Examine if set of common variables is distinct--yes except 8 spurious cases.
  join1 %>%
    add_count(cii, court_docket_id, book_num, dob) %>%
    filter(n > 1) %>%
    arrange(desc(n))

#Diagnostics
  #Jail and Court Matches by category
tibble(
  stage = 1,
  match = c(
    'c("cii", "dob")'
    # 'cii'
    # 'c("court_docket_id", "dob")'
  ),
  jail_match_rate = sapply(1, function(i) {
    (nrow(book_df) - nrow(get(paste0("j", i)))) / nrow(book_df) * 100
  }),
  court_match_rate = sapply(1, function(i) {
    (nrow(court_df) - nrow(get(paste0("c", i)))) / nrow(court_df) * 100
  })
)

join_df <- bind_rows(join1, j1)
```

Code Book
```{r eval=FALSE, include=FALSE}
rm(original_field)

original_df <- bind_rows(original_df)

Calaveras_df <- lapply(ls()[!grepl("original", ls())], function(i){
  df <- get(i)
  
  if(sum(grepl("date", names(df))) > 0){
  df2 <- df %>%
  select(contains("date"), -contains("time")) %>%
  gather("modified_field", "value") %>%
  group_by(modified_field) %>%
  summarise_all(funs(min = as.character(min(., na.rm = T)), mean = as.character(mean(., na.rm = T)), max = as.character(max(., na.rm = T))))
  }else{
    df2 <- tibble(modified_field = NA_character_, min = NA_character_, mean = NA_character_, max = NA_character_)
  }
  
  df <- df %>%
    mutate_if(~length(unique(.)) > 50|is.Date(.)|is.POSIXct(.), ~(. = "not_factor")) %>%    
    mutate_all(~if_else(is.na(.), "na_missing", as.character(.))) %>%
    gather(modified_field, factor_value) %>%
    count(modified_field, factor_value) %>%
    mutate(table_name = i, county = "Calaveras") %>%
    mutate(factor_flag = if_else(factor_value == "not_factor", 0, 1)) %>%
    group_by(table_name, modified_field) %>%
    mutate(table_count = sum(n)) %>%
    ungroup() %>%
    rename("factor_count" = "n") %>%
    mutate(factor_count = if_else(factor_value == "not_factor", NA_integer_, factor_count),
           factor_percent = round(factor_count/table_count*100, 1)) %>%
    arrange(desc(factor_flag), modified_field, desc(factor_count))
  
  df <- left_join(df, df2, by = "modified_field")
    }) %>% 
  bind_rows() %>%
  left_join(original_df) %>%
   select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_count,
           factor_percent, table_count, min, mean, max) 

write.xlsx(Calaveras_df, file = "Code Books/Calaveras Code Book.xlsx")
```

DOJ CII/Linking Extraction
```{r}
# Grab Tables with CII
df <- sapply(ls()[which(sapply(ls(), function(i){
  sum(names(get(i)) %in% "cii")
}) == 1)], get)

# Pull CII and other identifiers
doj_book <- df[[1]] %>%
  select(cii, fbi, pfn_x, first_name, last_name, dob, cld_id, cdl_state, race_original, sex_original, local_id) %>%
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) %>%
  distinct()


doj_court <- df[[2]] %>%
  select(cii, fbi, cld_id, cdl_state, dob, race_original, sex_original, first_name, last_name, local_id, pfn_x) %>%
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) %>%
  distinct()

# Examine missing ciis and duplicates on cii. 
doj_book %>% #Off by about 55,000
  distinct()

doj_book %>% 
  distinct(cii)

doj_book %>% 
  distinct() %>%
  add_count(cii) %>%
  filter(n > 1) %>%
  arrange(desc(n)) %>% 
  View()

doj_court %>% #Off by about 45,000
  distinct()

doj_court %>% 
  distinct(cii)

doj_court %>% 
  distinct() %>%
  add_count(cii) %>%
  filter(n > 1) %>%
  arrange(desc(n)) %>% 
  View()

#In this case, it is clear that the local ID is not a true person identifier but rather an event identifier and so should be removed.

doj_book <- doj_book %>% select(-local_id)
doj_court <- doj_court %>% select(-local_id)

doj_book %>% # Off by about 7,000
  distinct()

doj_book %>% 
  distinct(cii)

doj_book %>% 
  distinct() %>%
  add_count(cii) %>%
  filter(n > 1) %>%
  arrange(desc(n)) %>% 
  View()

doj_court %>% #Off by about 9,000
  distinct()

doj_court %>% 
  distinct(cii)

doj_court %>% 
  distinct() %>%
  add_count(cii) %>%
  filter(n > 1) %>%
  arrange(desc(n)) %>% 
  View()

#CIIs for DOJ
doj_cii <- bind_rows(doj_book %>% select(cii), doj_court %>% select(cii)) %>% distinct()

doj_cii <- doj_cii %>% 
  mutate(row = as.character(row_number() + 1e11)) %>%
  mutate(cii = paste(row, cii, sep = "|")) %>%
  select(cii)

#Create an excel workbook with all data table. Make sure to include the cii table first. 
write.xlsx(list(doj_cii, doj_book, doj_court), file = "CIIs for DOJ/Calaveras CIIs and Demographics for DOJ.xlsx", sheetName = c("ciis", "booking", "court"))
```

Completion
```{r}
files <- list.files("G:/CrimJustice/PretrialAssessmentPilot/Code Books/Code Book Notes", pattern = "Calaveras", full.names = T)

df <- lapply(files, read_excel)

df[[3]] <- full_join(df[[1]], df[[2]]) %>%
  mutate(factor_standard = "") %>%
  select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_standard, factor_count, factor_percent, table_count, "jw_notes" = Notes, "nl_notes_1" = factor_collapse, "nl_notes_2" = notes, min, mean, max)

df <- list(df[[3]], df[[1]], df[[2]])

write.xlsx(df, file = "G:/CrimJustice/PretrialAssessmentPilot/Code Books/Variable Construction/Calaveras Factor Construction.xlsx", asTable = T, tableStyle = "TableStyleMedium1", sheetName = c("Variable Construction", "jw_notes", "nl_notes"))
```

Factor Code Book
```{r}
factor_df <- lapply(ls()[!grepl("original|^df|hier", ls())], function(i){
  df <- get(i)
  if(sum(grepl("original", names(df))) == 0){
    return(NULL)
  }else{
    var_names <- names(df)[grepl("original", names(df))]
    var_names2 <- gsub("_original", "", var_names)
   
    df1 <- df %>%
     select(var_names) %>%
     gather(original_field, original_value)
   
    df2 <- df %>%
     select(var_names2) %>%
     gather(modified_field, modified_value)
   
   df <- bind_cols(df1, df2) %>%
     count(original_field, modified_field, original_value, modified_value) %>%
     arrange(modified_field, desc(n)) %>%
     group_by(modified_field) %>%
     mutate(row = row_number(),
            percent = round(n/sum(n)*100)) %>%
     ungroup() %>%
     filter(row <= 50) %>%
     select(-row) %>%
     rename("total" = n)
   }
  }) %>%
  bind_rows()

write.xlsx(factor_df, file = "G:/CrimJustice/PretrialAssessmentPilot/Code Books/Factor Code Book/Calaveras Factor Code Book.xlsx", asTable = T, tableStyle = "TableStyleMedium1", colWidths = "auto")
```

# Modoc

Jail Data
```{r}
# Jail Bookings Data Import--- Modoc, 2013-01-01 to 2019-12-31
  ## There are a few book dates before 2013.
  ## book_df contains one row per booking after duplicate rows are removed and contains information about the booking including demographic and charge information. Currently, the charges are separated by semicolons within in the charge field, but we separate_rows to make each row a unique booking charge combination.

####

# Booking data
  ## book_df contains one row per booking after duplicate rows are removed and contains information about the booking including demographic and charge information. Currently, the charges are separated by semicolons within in the charge field, but we separate_rows to make each row a unique booking charge combination.
book_df <- fread("Historical Data Submissions/Modoc/Modoc Jail Pretrial  January 1 2013-November 30 2019.csv", colClasses = "character")

  ## The first 7 observations are test inputs
book_df <- book_df[8:nrow(book_df),]

book_df_p1 <- fread("Historical Data Submissions/Modoc/Modoc Jail Pretrial  December 1 2019-December 31 2019.csv", colClasses = "character")

book_df_p2 <- fread("Historical Data Submissions/Modoc/P2 Submission-June 30/Modoc Jail Pretrial  January 1 2020-June 30 2020.csv", colClasses = "character")

book_df <- book_df %>%
  bind_rows(book_df_p1, book_df_p2) %>%
  distinct()

rm(book_df_p1, book_df_p2)

# Variable name standardization--See pg. xxx for more details.
names(book_df) <- c("book_date", "book_num", "arrest_date", "cii", "fbi", "local_id", "name", "dob", "sex_original", "race_original", "cdl_id", "employment_status", "book_type_original", "arrest_charge_original", "arrest_charge_level_original", "bail_amt", "release_date", "release_type_original")

# Removing duplicates
  ## Some of the bookings contain duplicate rows with empty fields and are removed.
book_df <- book_df %>%
  group_by(book_num) %>%
  mutate_all(max) %>%
  distinct()

# Date Reformatting--See pg. xxx for more details.
book_df <- book_df %>%
  mutate(release_type = gsub("\\d+/\\d+/\\d+|\\d+-\\d+-\\d+", "", release_type_original),
         release_type_date = str_extract_all(release_type_original, "\\d+/\\d+/\\d+|\\d+-\\d+-\\d+")) %>%
  unnest(cols = release_type_date) %>%
  bind_rows(book_df) %>%
  distinct_at(vars(-c(release_type, release_type_date)), .keep_all = T) %>%
  mutate(release_date_time = mdy_hms(case_when(
    release_date == "" ~ paste(release_type_date, "00:00:00"),
    !is.na(hms(release_date)) ~ paste(release_type_date, release_date),
    T ~ release_date)
  ),
  release_date = as_date(release_date_time)) %>%
  mutate_at(vars(book_date, arrest_date, dob), mdy) %>%
  select(-release_type_date)

# Standardize Factors--See pg. xxx for more details.
  ## Follow up with a lawyer about 853.6(a).
book_df <- book_df %>%
  mutate_at(vars(contains("original")), trimws) %>%
  mutate(race = case_when(
    race_original %in% c("H", "h", "HIS", "His", "Hisp", "hispanic", "HISPANIC") ~ "Hispanic",
    race_original %in% c("B", "BLK") ~ "Black",
    race_original %in% c("W", "w", "WHITE", "White", "WHI", "Wht", "WHT", "white", "wht", "whi") ~ "White",
    T ~ "Other_Unknown"
  ),
  sex = case_when(
    sex_original %in% c("F", "W", "f", "F?") ~ "Female",
    sex_original %in% c("M", "m") ~ "Male",
    T ~ "Other_Unknown"
  ),
  book_type = if_else(book_type_original %in% c("", "N/A", "n/a", "NONE", "NA"), "Unknown", "Warrant"),
  release_type = case_when(
    grepl("OR|853.6\\(a)|849\\(b)", release_type, ignore.case = T) ~ "OR",
    grepl("Book / Release|Book & Release|BOOK/RELEASE|cite and release|DA CITE", release_type, ignore.case = T) ~ "Cite_Release",
    grepl("Bail", release_type, ignore.case = T) ~ "Bail_Bond",
    grepl("Release Case Dissmissed", release_type, ignore.case = T) ~ "Dismissed_Dropped",
    grepl("Time Served|T/S", release_type, ignore.case = T) ~ "Time_Served",
    grepl("Court", release_type, ignore.case = T) ~ "Court_Order",
    grepl("Transported to prison|Trasported to prison", release_type, ignore.case = T) ~ "Prison",
    grepl("Old Files Transferred|Released per DA|DA MC|closed|DA|^released$|^transported$|transported n/a|Transported NA", release_type, ignore.case = T) ~ "Unknown",
    T ~ "Other"
  ))

# Charge Standardization and Flag Adds--See pg. xxx for more details.
book_df <- book_df %>%
  mutate(attempt_flag = if_else(grepl("664", arrest_charge_original), 1, 0),
         arrest_charge_level = case_when(
           arrest_charge_level_original == "" & grepl("-f|f-", arrest_charge_original, ignore.case = T) ~ "fel",
           arrest_charge_level_original == "" & grepl("-m|m-", arrest_charge_original, ignore.case = T) ~ "misd",
           T ~ arrest_charge_level_original
         ),
         arrest_charge = gsub("664/|664; ", "", arrest_charge_original),
         arrest_charge = gsub(".*for", "", arrest_charge, ignore.case = T),
         arrest_charge = gsub("x[0-9]|x [0-9]", "", arrest_charge, ignore.case = T),
         arrest_charge = gsub("a/w|b/w|r/w", "", arrest_charge, ignore.case = T),
         arrest_charge = gsub("-f|-m", "", arrest_charge, ignore.case = T),
         arrest_charge = gsub("m-.*|f-.*", "", arrest_charge, ignore.case = T),
         arrest_charge = gsub(":\v|^\v|\v$", "", trimws(arrest_charge), ignore.case = T),
         arrest_charge = gsub("released.*|time.*", "", trimws(arrest_charge), ignore.case = T),
         arrest_charge = gsub("([a-z]) ([0-9])", "\\1;\\2", arrest_charge, ignore.case = T),
         arrest_charge = gsub("h/s|h&s", "HS", arrest_charge, ignore.case = T),
         arrest_charge = gsub("/", ";", trimws(arrest_charge)),
         arrest_charge = gsub("\v", ";", trimws(arrest_charge), ignore.case = T),
         arrest_charge = gsub(", , , ,  |, ,  |, ", ";", arrest_charge),
         arrest_charge_code = case_when(
           grepl("PC", arrest_charge, ignore.case = T) ~ "PC",
           grepl("VC", arrest_charge, ignore.case = T) ~ "VC",
           grepl("HS", arrest_charge, ignore.case = T) ~ "HS",
           grepl("BP", arrest_charge, ignore.case = T) ~ "BP",
           grepl("WI", arrest_charge, ignore.case = T) ~ "WI",
           grepl("US", arrest_charge, ignore.case = T) ~ "US",
           T ~ "Other"
         )) %>%
  separate_rows(arrest_charge, sep = ";") %>%
  mutate(arrest_charge_code = case_when(
           grepl("PC", arrest_charge, ignore.case = T) ~ "PC",
           grepl("VC", arrest_charge, ignore.case = T) ~ "VC",
           grepl("HS", arrest_charge, ignore.case = T) ~ "HS",
           grepl("BP", arrest_charge, ignore.case = T) ~ "BP",
           grepl("WI", arrest_charge, ignore.case = T) ~ "WI",
           grepl("US", arrest_charge, ignore.case = T) ~ "US",
           T ~ arrest_charge_code
         )) %>%
  mutate(arrest_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}|\\*|#", "", arrest_charge)),
         arrest_charge = str_remove(arrest_charge, arrest_charge_code),
         # These variables did not match the initial hierarchy. Check if they match the new hierarchy after the joining.
         arrest_charge_code = if_else(arrest_charge == "240", "PC", arrest_charge_code),
         arrest_charge = case_when(
           arrest_charge == "23152AB" ~ "23152A23152B",
           arrest_charge == "647FALCOHOL" ~ "647F",
           arrest_charge == "11550" ~ "11550A",
           T ~ arrest_charge
         ),
         arrest_charge_level = case_when(
           grepl("fel", arrest_charge_level, ignore.case = T) ~ "F",
           grepl("misd", arrest_charge_level, ignore.case = T) | (arrest_charge_level == "Other" & arrest_charge == "166A4") ~ "M",
           T ~ "Other"
         )) %>%
  unite(join_var, arrest_charge_level, arrest_charge_code, arrest_charge, remove = F) %>%
  distinct()

load("Complete Charge Code Hierarchy.RData")

book_df <- book_df %>%
  left_join(charge_hier) %>%
  mutate(felony_flag = if_else(arrest_charge_level == "F", 1, 0),
         misd_flag = if_else(arrest_charge_level == "M", 1, 0)) %>%
  rename_at(vars(contains("flag")), funs(paste0("arrest_", .)))
```

  Jail Collapse
```{r}
# Booking Collapse--See pg. xxx for more details about this process.
book_df <- book_df %>%
  mutate(time_first_release = release_date - book_date,
         hierarchy = if_else(is.na(hierarchy), 1e6, as.numeric(hierarchy))) %>%
  group_by(book_num) %>%
  mutate(max_booktype = book_type[hierarchy == min(hierarchy)][1],
         max_arrest_charge = arrest_charge[hierarchy == min(hierarchy)][1],
         max_charge_description = master_charge_description[hierarchy == min(hierarchy)][1],
         max_hier = min(hierarchy)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, .))) %>%
  mutate_at(vars(contains("flag")), funs("count" = sum(.))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  group_by(book_num, book_date) %>%
  filter(hierarchy == min(hierarchy)) %>%
  ungroup() %>%
  distinct(book_num, .keep_all = T) 
```

  Jail Diagnostics
```{r}
# charges
# 83.36834% small county
(1 - nrow(book_df %>% filter(is.na(hierarchy))) / nrow(book_df)) * 100

book_df %>%
  filter(is.na(hierarchy)) %>%
  count(join_var) %>%
  arrange(desc(n))

charge_hier %>%
  filter(grepl(849, join_var))

book_df %>%
  filter(grepl("849B", join_var)) %>%
  count(arrest_charge_level_original, arrest_charge_original)

# collapse
book_df %>%
  distinct(book_num, book_date) %>%
  arrange(book_num) %>%
  group_by(book_num) %>%
  add_count() %>%
  filter(n > 1)

book_df %>%
  distinct(book_num, book_date)
```

Court Data 
```{r}
# Court Case Data Import--- Modoc, 2015-01-06 to 2019-12-30
  ## court_df contains one row per booking after duplicate rows are removed and contains information about the court case including information about relevant dates.
  ## court_charge contains one row per court case and charge combination, as well as information on each of the charges. Initially, it also duplicated information when a charge had multiple disposition dates. The first date is taken.
  ## court_sent contains one row per court_case_id and sentence event. Initially, it also duplicated rows based on charge. Charge information is deduplicated and removed as it is redundant with the court_charge table.
  ## court_hearing contains one row per court_case_id and hearing event.
  ## court_person contains one row per person, court case, arrest number, and booking number combination.
  ## court_fta contains one row per FTA event.
  ## court_fta_war contains one row per FTA event with a bench warrant issued.

####

# Modoc Excel sheets
  ## Modoc submitted the data in an Excel file with multiple sheets and they are being imported separately and turned into the respective tables described above and below.
court_sheets <- excel_sheets("Historical Data Submissions/Modoc/Modoc Pretrial Assessment Information.xls")

court_df <- lapply(court_sheets, function(i) {
  read_excel("Historical Data Submissions/Modoc/Modoc Pretrial Assessment Information.xls", sheet = i, col_types = "text")
})

court_sheets_p1 <- excel_sheets("Historical Data Submissions/Modoc/Modoc Pretrial Assessment Information_2nd quarter_2019_2020.xls")

court_df_p1 <- lapply(court_sheets_p1, function(i) {
  read_excel("Historical Data Submissions/Modoc/Modoc Pretrial Assessment Information_2nd quarter_2019_2020.xls", sheet = i, col_types = "text")
})

court_sheets_p2 <- excel_sheets("Historical Data Submissions/Modoc/P2 Submission-June 30/Copy of Modoc Pretrial Assessment Information_1st Half_2020.xls")

court_df_p2 <- lapply(court_sheets_p2, function(i) {
  read_excel("Historical Data Submissions/Modoc/P2 Submission-June 30/Copy of Modoc Pretrial Assessment Information_1st Half_2020.xls", sheet = i, col_types = "text")
})

# Court Cases
court_case <- court_df[[1]] %>%
  bind_rows(court_df_p1[[1]]) %>%
  distinct()

# Variable name standardization--See pg. xxx for more details.
names(court_case) <- c("court_case_id", "name", "disposition_type_original", "disposition_date", "filing_date", "case_type")

# Removing duplicates
  ## Some of the court data contain duplicate rows with missing fields and are removed.
court_case <- court_case %>%
  arrange(disposition_date) %>%
  distinct(court_case_id, .keep_all = T)

# Date Reformatting--See pg. xxx for more details.
court_case <- court_case %>%
  mutate_at(vars(contains("date")), convertToDate)

# Standardize Factors--See pg. xxx for more details.
court_case <- court_case %>%
  mutate(disposition_type = case_when(
    disposition_type_original %in% c("Dismissal", "Dismissal: Diversion Successful", "Dismissal: DEJ Successful", "Dismissal: Conviction Set Aside") ~ "Dismissed",
    disposition_type_original %in% c("Conviction: Nolo Plea") ~ "Nolo_Contendere",
    disposition_type_original %in% c("Conviction: Guilty Plea", "Conviction: Jury Verdict", "Conviction: Bail Forfeiture", "Conviction: Court Finding of Guilt", "Conviction: DEJ Unsuccessful") ~ "Guilty",
    disposition_type_original %in% c("Acquittal") ~ "Not_Guilty",
    T ~ "Other"
  ))

####

# Court Filing Charges
  ## court_charge contains one row per court case and charge combination, as well as information on each of the charges. Initially, it also duplicated information when a charge had multiple disposition dates. The first date is taken.
court_charge <- court_df[[2]] %>%
  bind_rows(court_df_p1[[2]]) %>%
  distinct()

# Variable name standardization--See pg. xxx for more details.
names(court_charge) <- c("court_case_id", "counts", "court_charge_original", "court_charge_level_original", "charge_description", "disposition_type_original", "disposition_date", "plea_type_original", "plea_date")

# Date Reformatting--See pg. xxx for more details.
court_charge <- court_charge %>%
  mutate_at(vars(contains("date")), convertToDate)

# Standardize Factors--See pg. xxx for more details.
court_charge <- court_charge %>%
  mutate(disposition_type = case_when(
    disposition_type_original %in% c("Dismissal", "Dismissed with a Harvey Waiver", "Dismissal: Diversion Successful", "Dismissal: DEJ Successful") ~ "Dismissed",
    disposition_type_original %in% c("") ~ "Dropped",
    disposition_type_original %in% c("Conviction: Nolo Plea") ~ "Nolo_Contendere",
    disposition_type_original %in% c("Conviction: Guilty Plea", "Conviction: Jury Verdict", "Conviction: Bail Forfeiture", "Guilty Plea: DEJ", "Admitted", "Conviction: Court Finding of Guilt", "Conviction: DEJ Unsuccessful", "Conviction: Traf Sch Not Complete") ~ "Guilty",
    disposition_type_original %in% c("Acquittal") ~ "Not_Guilty",
    T ~ "Other"
  ),
  plea_type = case_when(
    plea_type_original %in% c("Guilty") ~ "Guilty",
    plea_type_original %in% c("Not Guilty") ~ "Not_Guilty",
    T ~ "Other"
  ))

# Charge Standardization and Flag Adds--See pg. xxx for more details.
court_charge <- court_charge %>%
  mutate(court_charge_code = case_when(
    grepl("PC", court_charge_original, ignore.case = T) ~ "PC",
    grepl("VC", court_charge_original, ignore.case = T) ~ "VC",
    grepl("HS", court_charge_original, ignore.case = T) ~ "HS",
    grepl("BP", court_charge_original, ignore.case = T) ~ "BP",
    grepl("WI", court_charge_original, ignore.case = T) ~ "WI",
    grepl("US", court_charge_original, ignore.case = T) ~ "US",
    T ~ "Other"
  ),
  attempt_flag = if_else(grepl("664/", court_charge_original), 1, 0),
  court_charge = gsub(".*/", "", court_charge_original),
  court_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}", "", court_charge)),
  # These variables did not match the initial hierarchy. Check if they match the new hierarchy after the joining.
  court_charge = if_else(court_charge == "29800A", "29800A2", court_charge),
  court_charge_code = if_else(court_charge == "11360B", "HS", court_charge_code),
  court_charge_level = case_when(
    grepl("Felony", court_charge_level_original) ~ "F",
    grepl("Misdemeanor", court_charge_level_original) ~ "M",
    grepl("Infraction", court_charge_level_original) ~ "I",
    T ~ "Other"
  )) %>%
  distinct()

load("Complete Charge Code Hierarchy.RData")

court_charge <- court_charge %>%
  unite(join_var, court_charge_level, court_charge_code, court_charge, remove = F) %>%
  left_join(charge_hier) %>%
  mutate(felony_flag = if_else(court_charge_level == "F", 1, 0),
         misd_flag = if_else(court_charge_level == "M", 1, 0)) %>%
  rename_at(vars(contains("_flag")), funs(paste0("court_", .))) %>%
  mutate_at(vars(contains("_flag")), funs("conviction" = if_else(disposition_type %in% c("Nolo_Contendere", "Guilty") & . == 1, 1, 0))) %>%
  rename_at(vars(contains("_conviction")), funs(paste0("conviction_", gsub("court_|_conviction", "", .))))

# Removing duplicates
  ## Some of the court data contain duplicate rows with missing fields and are removed.
court_charge <- court_charge %>%
  arrange(disposition_date) %>%
  distinct(counts, court_case_id, join_var, .keep_all = T)

####

# Court Sentences
  ## court_sent contains one row per court_case_id and sentence event. Initially, it also duplicated rows based on charge. Charge information is deduplicated and removed as it is redundant with the court_charge table.
  ## Combining tables and deduplicating
court_sent <- court_df[[3]] %>%
  bind_rows(court_df_p1[[3]]) %>%
  select(-Count, -Violation) %>%
  distinct()

# Variable name standardization--See pg. xxx for more details.
names(court_sent) <- c("court_case_id", "sentence_date", "sentence_type_original", "term", "term_suspended", "sentence_location", "sentence_status")

# Date Reformatting--See pg. xxx for more details.
court_sent <- court_sent %>%
  mutate(sentence_date = convertToDate(sentence_date))

# Standardize Factors--See pg. xxx for more details.
  ## Double check about "Mandatory Supervision".
court_sent <- court_sent %>%
  mutate(sentence_type = case_when(
    sentence_type_original %in% c("State Prison") ~ "Prison",
    sentence_type_original %in% c("County Jail", "County Jail: VOP", "County Jail: PC1170", "County Jail: Supervision Violation") ~ "Jail",
    sentence_type_original %in% c("Probation: Summary", "Probation: Formal", "Probation: Prop 36", "Mandatory Supervision") ~ "Probation",
    T ~ "Other"
  ))

####

# Court Hearings
  ## court_hearing contains one row per court_case_id and hearing event.
court_hearing <- court_df[[4]] %>%
  bind_rows(court_df_p1[[4]]) %>%
  distinct()

# Variable name standardization--See pg. xxx for more details.
names(court_hearing) <- c("court_case_id", "hearing_type_original", "hearing_date", "hearing_time", "hearing_result")

# Date Reformatting--See pg. xxx for more details.
court_hearing <- court_hearing %>%
  mutate_at(vars(hearing_date, hearing_time), as.numeric) %>%
  mutate(hearing_date_time = convertToDateTime(hearing_date + hearing_time),
         hearing_date = convertToDate(hearing_date)) %>%
  select(-hearing_time)

# Standardize Factors--See pg. xxx for more details.
court_hearing <- court_hearing %>%
  mutate(hearing_type = case_when(
    grepl("Arraignment", hearing_type_original, ignore.case = T) ~ "Arraignment",
    grepl("Sentencing", hearing_type_original, ignore.case = T) ~ "Sentencing",
    T ~ "Other"
  ))

####

# Court Person Information
  ## court_person contains one row per person, court case, arrest number, and booking number combination.
court_person <- court_df[[6]] %>%
  bind_rows(court_df_p1[[6]]) %>%
  distinct()

# Variable name standardization--See pg. xxx for more details.
names(court_person) <- c("court_case_id", "first_name", "last_name", "dob", "sex_original", "race_original", "cii", "fbi", "arrest_num", "book_num")

# Date Reformatting--See pg. xxx for more details.
court_person <- court_person %>%
  mutate(dob = convertToDate(if_else(dob != 0, dob, NA_character_)))

# Standardize Factors--See pg. xxx for more details.
court_person <- court_person %>%
  mutate(race = if_else(!race_original %in% c("Hispanic", "Black", "White"), "Other_Unknown", race_original),
         sex = if_else(!sex_original %in% c("Female", "Male"), "Other_Unknown", sex_original))

# Removing duplicates
  ## Some of the court data contain duplicate rows with missing fields and are removed.
court_person <- court_person %>%
  arrange(desc(dob)) %>%
  distinct(first_name, last_name, court_case_id, arrest_num, book_num, .keep_all = T)

####

# Court FTAs
  ## court_fta contains one row per FTA event.
court_fta <- court_df[[8]] %>%
  bind_rows(court_df_p1[[8]]) %>%
  distinct()

# Variable name standardization--See pg. xxx for more details.
names(court_fta) <- c("court_case_id", "fta_date", "fta")

# Date Reformatting--See pg. xxx for more details.
court_fta <- court_fta %>%
  mutate(fta_date = convertToDate(fta_date))

# Flag Adds--See pg. xxx for more details.
court_fta <- court_fta %>%
  mutate(fta_flag = if_else(grepl("Issued", fta), 1, 0),
         fta_all_flag = 1) %>%
  rename_at(vars(contains("flag")), funs(paste0("court_", .)))

####

# Court FTAs with Warrants
  ## court_fta_war contains one row per FTA event with a bench warrant issued.
court_fta_war <- court_df[[9]] %>%
  bind_rows(court_df_p1[[9]]) %>%
  distinct()

# Variable name standardization--See pg. xxx for more details.
names(court_fta_war) <- c("court_case_id", "fta_date", "fta")

# Date Reformatting--See pg. xxx for more details.
court_fta_war <- court_fta_war %>%
  mutate(fta_date = convertToDate(fta_date))

# Flag Adds--See pg. xxx for more details.
court_fta_war <- court_fta_war %>%
  mutate(fta_flag = 1,
         fta_all_flag = 1) %>%
  rename_at(vars(contains("flag")), funs(paste0("court_", .)))

rm(court_df, court_df_p1, court_sheets, court_sheets_p1)

#### NOT USED ####

# # Court Case Lawyer Information
# court_lawyer <- court_df[[5]] %>%
#   bind_rows(court_df_p1[[5]]) %>%
#   distinct()
# 
# names(court_lawyer) <- c("court_case_id", "lawyer_type", "appointment_date", "appointment_status", "appointment_end_date")
# 
# court_lawyer <- court_lawyer %>%
#   mutate_at(vars(contains("date")), convertToDate)
# 
# ####
# 
# # Court Bail Information
# court_bail <- court_df[[7]] %>%
#   bind_rows(court_df_p1[[7]]) %>%
#   distinct()
# 
# # Variable name standardization--See pg. xxx for more details.
# names(court_bail) <- c("court_case_id", "release_type_original", "release_date", "bail_status", "bail_status_date")
# 
# # Date Reformatting--See pg. xxx for more details.
# court_bail <- court_bail %>%
#   mutate_at(vars(contains("date")), convertToDate)
# 
# # Standardize Factors--See pg. xxx for more details.
# court_bail <- court_bail %>%
#   mutate(release_type = "Bail_Bond")
```

  Court Collapse
```{r}
# Court Charge Collapse--See pg. xxx for more details about this process.

# Create court disposition table from court charge table.
  ## Court dispositions are collapse to each case.
court_dispo <- court_charge %>%
  mutate(disposition_type = ordered(disposition_type, levels = c("Other", "Dismissed", "Not_Guilty", "Nolo_Contendere", "Guilty"))) %>%
  group_by(court_case_id) %>%
  mutate(hierarchy = if_else(is.na(hierarchy), 1e6, as.numeric(hierarchy)),
         disposition_date = max(disposition_date),
         disposition_type = max(disposition_type),
         max_court_charge_level = court_charge_level[hierarchy == min(hierarchy)][1],
         max_court_charge_code = court_charge_code[hierarchy == min(hierarchy)][1],
         max_court_charge = court_charge[hierarchy == min(hierarchy)][1],
         max_charge_description = master_charge_description[hierarchy == min(hierarchy)][1],
         max_hier = min(hierarchy)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, .))) %>%
  mutate_at(vars(contains("flag")), funs("count" = sum(.))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  filter(hierarchy == min(hierarchy)) %>%
  ungroup() %>%
  distinct(court_case_id, .keep_all = T) %>%
  select(-c(plea_date, plea_type_original, plea_type))

# Court FTAs with bench warrants issued and all court FTAs combined and collapsed
court_fta <- court_fta %>%
  bind_rows(court_fta_war) %>%
  select(-fta) %>%
  group_by(court_case_id, fta_date) %>%
  # In some cases of discrepancies where one data point said a bench warrant issued and the other said held, we treated it as issued.
  mutate(court_fta_flag = max(court_fta_flag)) %>%
  distinct() %>%
  arrange(fta_date) %>%
  group_by(court_case_id) %>%
  mutate(court_fta_flag = max(court_fta_flag),
         fta_flag_count = sum(court_fta_flag)) %>%
  distinct(court_case_id, .keep_all = T)

# Court hearings are filtered for arraignment information and collapsed to court case id.
court_hearing <- court_hearing %>%
  filter(hearing_type == "Arraignment") %>%
  arrange(hearing_date) %>%
  rename(arraignment_date = hearing_date,
         arraignment_date_time = hearing_date_time) %>%
  distinct(court_case_id, .keep_all = T) %>%
  select(court_case_id, arraignment_date, arraignment_date_time)

# Collapse pleas by case
  ## we are keeping the earliest plea date, but adding a guilty plea flag in case they later changed their plea
court_plea <- court_charge %>%
  filter(!is.na(plea_date)) %>%
  arrange(plea_date) %>%
  mutate(guilty_plea_flag = if_else(plea_type %in% c("Guilty", "Nolo_Contendere"), 1, 0)) %>%
  group_by(court_case_id) %>%
  mutate(guilty_plea_flag = max(guilty_plea_flag)) %>%
  ungroup() %>%
  distinct(court_case_id, .keep_all = T) %>%
  select(court_case_id, plea_date, plea_type, guilty_plea_flag)

# Collapse sentences by case --See pg. xxx for more details about this process.
  ## Sentences to confinement and probation were initially separate and are now joined.
court_sent <- court_sent %>%
  arrange(sentence_date) %>%
  mutate(sentence_type = ordered(sentence_type, levels = c("Other", "Probation", "Jail", "Prison"))) %>%
  group_by(court_case_id) %>%
  mutate(sentence_type = max(sentence_type)) %>%
  ungroup() %>%
  distinct(court_case_id, .keep_all = T)

court_df <- reduce(list(court_df, court_dispo, court_fta, court_hearing, court_plea, court_sent), left_join, by = "court_case_id") %>%
  select(-contains(".x.x"), -contains(".y")) %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x", "", .))) %>%
  mutate(pretrial_end_date = if_else(disposition_date <= sentence_date|is.na(sentence_date), disposition_date, sentence_date),
         conviction_flag = if_else(disposition_type %in% c("Guilty","Nolo_Contendere"), 1, 0))
```

  Court Diagnostics
```{r}
# charges
# 97.24054%
(1 - nrow(court_charge %>% filter(is.na(hierarchy))) / nrow(court_charge)) * 100

court_charge %>%
  filter(is.na(hierarchy)) %>%
  count(join_var) %>%
  arrange(desc(n))

charge_hier %>%
  filter(grepl(1170, join_var))

court_charge %>%
  filter(grepl("1170H5", join_var)) %>%
  count(court_charge_level_original, court_charge_original, charge_description)

court_charge %>%
  filter(grepl("/|&|\\\\", court_charge_original)) %>%
  filter(!grepl("664", court_charge_original)) %>%
  # mutate(court_charge_original = gsub("/.*", "", court_charge_original)) %>%
  count(court_charge_original, charge_description) %>%
  arrange(desc(n))
```

Probation Data
```{r}
prob_df <- read_excel("Historical Data Submissions/Modoc/P2 Submission-June 30/4 Quarter Pretrial Data Sheet  2020 List.xlsx", col_types = "text")

# Variable name standardization--See pg. xxx for more details.
names(prob_df) <- c("assessment_date", "name", "dob", "sex_original", "race_original", "zip_code", "cii", "fbi", "local_id", "cdl_id", "dln_state", "oras_rating", "oras_score", "srna_rating", "srna_score", "release_date", "bail_amt", "release_recommendation_original", "release_authorization_original", "release_type_original", "release_date_time", "pretrial_conditions_original", "ptr_violation", "ptr_violation_date_time", "court_date_reminder", "pretrial_service_original", "notes")

# Date Reformatting--See pg. xxx for more details.
prob_df <- prob_df %>%
  mutate_at(vars(contains("date"), dob), convertToDate)

# Standardize Factors--See pg. xxx for more details.--See pg. xxx for more details.
prob_df <- prob_df %>%
  mutate(race = case_when(
    race_original %in% c("Hispanic or Latino") ~ "Hispanic",
    race_original %in% c("White") ~ "White",
    T ~ "Other_Unknown"
  ),
  sex = sex_original,
  release_type = if_else(release_type_original == "Datain", "No_Release", release_type_original),
  release_recommendation = case_when(
    release_recommendation_original %in% c("OR") ~ "OR",
    release_recommendation_original %in% c("Detain") ~ "No_Release",
    release_recommendation_original %in% c("OR with Conditions") ~ "Monitor",
    T ~ release_recommendation_original
  ),
  release_authorization = release_authorization_original)

# Flag Adds--See pg. xxx for more details.
prob_df <- prob_df %>%
  mutate(sup_pre_flag = if_else(release_type == "OR_Conditions", 1, 0),
         sup_vio_pre_flag = if_else(!is.na(ptr_violation), 1, 0))
```

Join
```{r}
# Remove extraneous objects in the environment
rm(list = ls()[!ls() %in% ls(pattern = "df")])

#Check for common variables
# names(book_df)[names(book_df) %in% names(assess_df)]

names(book_df)[names(book_df) %in% names(court_df2)]

#Turning NULL to NA to ensure non matching and removing generic charge info from data frames
book_df <- book_df %>%
  mutate_if(is.character, list(~na_if(., "NULL"))) %>%
  select(-c(charge, charge_level, charge_code)) %>%
  mutate_at(vars(name), toupper)

# assess_df <- assess_df %>%
#   mutate_if(is.character, list(~na_if(., "(Missing)"))) %>%
#   select(-c(id, court))

court_df2 <- court_df2 %>%
  mutate_if(is.character, list(~na_if(., "NULL"))) %>%
  select(-c(charge, charge_level, charge_code)) %>%
  mutate_at(vars(name), toupper) %>%
  mutate(court_case_id = as.character(court_case_id))

# Court Matching
#Joining on CII and Court ID
join1 <- inner_join(book_df, court_df2, by = "name", na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(paste0("arrest_", gsub("\\.x$", "", .)))) %>%
  rename_at(vars(contains(".y")), funs(paste0("court_", gsub("\\.y$", "", .)))) %>%
  # 8 Duplicates with missing dispositions which will be dropped later. 
  distinct()

j1 <- anti_join(book_df, court_df2, by = "name", na_matches = "never")
c1 <- anti_join(court_df2, book_df, by = "name", na_matches = "never")

  #Examine if set of common variables is distinct--yes except 8 spurious cases.
  join1 %>%
    add_count(name) %>%
    filter(n > 1) %>%
    arrange(desc(n))
  
#Diagnostics
  #Jail and Court Matches by category
  # 0.07134364% and 0.04397537%
tibble(
  stage = 1,
  match = c(
    # 'c("court_docket_id", "cii", "dob")',
    # 'c("court_docket_id", "first_name", "dob")',
    'name'
  ),
  jail_match_rate = sapply(1, function(i) {
    (nrow(book_df) - nrow(get(paste0("j", i)))) / nrow(book_df) * 100
  }),
  court_match_rate = sapply(1, function(i) {
    (nrow(court_df2) - nrow(get(paste0("c", i)))) / nrow(court_df2) * 100
  })
)

join_df <- bind_rows(join1, j1)
```

Code Book
```{r eval=FALSE, include=FALSE}
rm(original_field)

original_df <- bind_rows(original_df)

Modoc_df <- lapply(ls()[!grepl("original", ls())], function(i){
  df <- get(i)
  
  if(sum(grepl("date", names(df))) > 0){
  df2 <- df %>%
  select(contains("date"), -contains("time")) %>%
  gather("modified_field", "value") %>%
  group_by(modified_field) %>%
  summarise_all(funs(min = as.character(min(., na.rm = T)), mean = as.character(mean(., na.rm = T)), max = as.character(max(., na.rm = T))))
  }else{
    df2 <- tibble(modified_field = NA_character_, min = NA_character_, mean = NA_character_, max = NA_character_)
  }
  
  df <- df %>%
    mutate_if(~length(unique(.)) > 50|is.Date(.)|is.POSIXct(.), ~(. = "not_factor")) %>%    
    mutate_all(~if_else(is.na(.), "na_missing", as.character(.))) %>%
    gather(modified_field, factor_value) %>%
    count(modified_field, factor_value) %>%
    mutate(table_name = i, county = "Modoc") %>%
    mutate(factor_flag = if_else(factor_value == "not_factor", 0, 1)) %>%
    group_by(table_name, modified_field) %>%
    mutate(table_count = sum(n)) %>%
    ungroup() %>%
    rename("factor_count" = "n") %>%
    mutate(factor_count = if_else(factor_value == "not_factor", NA_integer_, factor_count),
           factor_percent = round(factor_count/table_count*100, 1)) %>%
    arrange(desc(factor_flag), modified_field, desc(factor_count))
  
  df <- left_join(df, df2, by = "modified_field")
    }) %>% 
  bind_rows() %>%
  left_join(original_df) %>%
   select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_count,
           factor_percent, table_count, min, mean, max) 

write.xlsx(Modoc_df, file = "Code Books/Modoc Code Book.xlsx")
```

DOJ CII/Linking Extraction
```{r}
# Grab Tables with CII
df <- sapply(ls()[which(sapply(ls(), function(i){
  sum(names(get(i)) %in% "cii")
}) == 1)], get)

# Pull CII and other identifiers
doj_book <- df[[1]] %>%
  select(cii, fbi, name, dob, cdl_id, race_original, sex_original, local_id) %>%
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) %>%
  distinct()


doj_court <- df[[2]] %>%
  select(cii, fbi, dob, race_original, sex_original, first_name, last_name) %>%
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) %>%
  distinct()

# Examine missing ciis and duplicates on cii. 
# doj_book %>% #Off by about 55,000
#   distinct()
# 
# doj_book %>% 
#   distinct(cii)
# 
# doj_book %>% 
#   distinct() %>%
#   add_count(cii) %>%
#   filter(n > 1) %>%
#   arrange(desc(n)) %>% 
#   View()
# 
# doj_court %>% #Off by about 45,000
#   distinct()
# 
# doj_court %>% 
#   distinct(cii)
# 
# doj_court %>% 
#   distinct() %>%
#   add_count(cii) %>%
#   filter(n > 1) %>%
#   arrange(desc(n)) %>% 
#   View()

#In this case, it is clear that the local ID is not a true person identifier but rather an event identifier and so should be removed.

#CIIs for DOJ
doj_cii <- bind_rows(doj_book %>% select(cii), doj_court %>% select(cii)) %>% distinct()

# doj_cii <- doj_cii %>% 
#   mutate(row = as.character(row_number() + 1e11)) %>%
#   mutate(cii = paste(row, cii, sep = "|")) %>%
#   select(cii)

#Create an excel workbook with all data table. Make sure to include the cii table first. 
write.xlsx(list(doj_cii, doj_book, doj_court), file = "CIIs for DOJ/Modoc CIIs and Demographics for DOJ.xlsx", sheetName = c("ciis", "booking", "court"))
```

Completion
```{r}
files <- list.files("G:/CrimJustice/PretrialAssessmentPilot/Code Books/Code Book Notes", pattern = "Modoc", full.names = T)

df <- lapply(files, read_excel)

df[[3]] <- full_join(df[[1]], df[[2]]) %>%
  mutate(factor_standard = "") %>%
  select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_standard, factor_count, factor_percent, table_count, "jw_notes" = Notes, "nl_notes_1" = factor_collapse, "nl_notes_2" = notes, min, mean, max)

df <- list(df[[3]], df[[1]], df[[2]])

write.xlsx(df, file = "G:/CrimJustice/PretrialAssessmentPilot/Code Books/Variable Construction/Modoc Factor Construction.xlsx", asTable = T, tableStyle = "TableStyleMedium1", sheetName = c("Variable Construction", "jw_notes", "nl_notes"))
```

Factor Code Book
```{r}
factor_df <- lapply(ls()[!grepl("original|^df|hier", ls())], function(i){
  df <- get(i)
  if(sum(grepl("original", names(df))) == 0){
    return(NULL)
  }else{
    var_names <- names(df)[grepl("original", names(df))]
    var_names2 <- gsub("_original", "", var_names)
   
    df1 <- df %>%
     select(var_names) %>%
     gather(original_field, original_value)
   
    df2 <- df %>%
     select(var_names2) %>%
     gather(modified_field, modified_value)
   
   df <- bind_cols(df1, df2) %>%
     count(original_field, modified_field, original_value, modified_value) %>%
     arrange(modified_field, desc(n)) %>%
     group_by(modified_field) %>%
     mutate(row = row_number(),
            percent = round(n/sum(n)*100)) %>%
     ungroup() %>%
     filter(row <= 50) %>%
     select(-row) %>%
     rename("total" = n)
   }
  }) %>%
  bind_rows()

write.xlsx(factor_df, file = "G:/CrimJustice/PretrialAssessmentPilot/Code Books/Factor Code Book/Modoc Factor Code Book.xlsx", asTable = T, tableStyle = "TableStyleMedium1", colWidths = "auto")
```

# San Joaquin
- Everything is Join

Jail Data
```{r}
# Jail Bookings Data Import--- San Joaquin, 2015-01-01 to 2019-12-31
  ## book_df contains one row per booking event and related court case. 10 duplicates are removed.
  ## book_charge contains one row per booking charge. Currently, wobblers are duplicated and removed. However, the correct charge is ambiguous in this case. We need to follow up with San Joaquin.
  ## book_demo contains one row per defendant and contains demographic information on them.
  ## book_ipid contains one row per person and contains the jail to court local id match.

####

# Booking Data
  ## book_df contains one row per booking event and related court case. 10 duplicates are removed.
  ## Use period 2 data to replace historical data submission and period 1 data.
  ## Date variables from period 2 data only have times, not dates.
book_df <- fread("Historical Data Submissions/San Joaquin/P2 Submission-June 30/Jail/20200714_ATIMS_20160101_to_20200630_BOOKING.csv", colClasses = "character")

# Variable name standardization--See pg. xxx for more details.
names(book_df) <- c("book_num", "local_id", "court_case_id", "bail_amt", "arrest_date_time", "book_date_time", "book_type_original", "release_date_time", "release_type_original")

# Date Reformatting--See pg. xxx for more details.
book_df <- book_df %>%
  mutate_at(vars(contains("date")), as_datetime) %>%
  mutate(arrest_date = as_date(arrest_date_time),
         book_date = as_date(book_date_time),
         release_date = as_date(release_date_time))

# Removing 10 instances of duplicated bookings added in error.
book_df <- book_df %>%
  group_by(book_num, court_case_id) %>%
  arrange(desc(book_date_time)) %>%
  distinct(book_num, court_case_id, .keep_all = T) %>%
  ungroup()

# Standardize Factors--See pg. xxx for more details.
book_df <- book_df %>%
  mutate(book_num = gsub("\\..*", "", book_num),
         book_type = case_when(
           book_type_original %in% c("OPEN CHARGES") ~ "On_View",
           book_type_original %in% c("WARRANT - LOCAL") ~ "Warrant",
           book_type_original %in% c("VIOL-CDCR PAROLE", "VIOL-PRCS", "VIOL - PROBATION", "VIOL-INTERSTATE PAROLE", "VIOL - LCS") ~ "Sup_Vio_Post",
           book_type_original %in% c("REMAND", "REMAND - CIVIL") ~ "Court_Order",
           book_type_original %in% c("WARRANT - OTHER COUNTY", "WARRANT - OTHER STATE", "HOLD-DETAINER", "HOLD-ENROUTER", "WARRANT - FEDERAL", "HOLD - CDCR", "WARRANT - CIVIL", "HOLD - CDCR/JJD") ~ "Hold",
           book_type_original %in% c("COMMITMENT", "COMMITMENT-FOREIGN", "COMMITMENT - CIVIL") ~ "Commitment",
           T ~ "Other"
         ),
         release_type_original = trimws(release_type_original),
         release_type = case_when(
           release_type_original %in% c("PROMISE TO APPEAR", "OWN RECOGNIZANCE", "RELEASED BY LAW ENFORCEMENT", "O/R - SC 43450", "PTA", "O/R PER P.T.S.", "OR", "O.R. PER P.T.S.") ~ "OR",
           release_type_original %in% c("CITE & RELEASE", "BOOK AND RELEASE") ~ "Cite_Release",
           release_type_original %in% c("SURETY BOND POSTED", "CASH BAIL POSTED") ~ "Bail_Bond",
           release_type_original %in% c("CASE DISMISSED", "CHARGES DROPPED") ~ "Dismissed_Dropped",
           release_type_original %in% c("TIME SERVED", "TIME SERVED - SC43450", "TIME SERVED \200 SC43450") ~ "Time_Served",
           release_type_original %in% c("RELEASED TO OTHER AGENCY", "DROP HOLD", "RELEASED TO OTHER AGENCY-TOPIC", "OTH CO/ST HOLD DROPPED BY RESP AGNCY") ~ "Hold_Release",
           release_type_original %in% c("DETENTION ONLY/DECLINE TO FILE", "INTOXICATION ONLY - PC 849B(2) 849B(3)", "DETENTION ONLY/DECLINE TO FILE - PC 849B(1)") ~ "Detain_Only",
           release_type_original %in% c("COMPULSORY - SENTENCED") ~ "Sent_Cap",
           release_type_original %in% c("COMPULSORY - UNSENTENCED") ~ "Unsent_Cap",
           release_type_original %in% c("O/R TO PROGRAM", "OR TO PROG") ~ "OR_Conditions",
           release_type_original %in% c("SENTENCED/ STR", "STATE PRISON", "SENTENCED TO STATE PRISON") ~ "Prison",
           release_type_original %in% c("RELEASED TO PERSON") ~ "Unknown",
           T ~ "Other"
         ))

# Flag Adds--See pg. xxx for more details.
book_df <- book_df %>%
  mutate(sup_vio_post_flag = if_else(book_type == "Sup_Vio_Post", 1, 0)) %>%
  rename_at(vars(contains("flag")), funs(paste0("arrest_", .)))

####

# Booking Filing Charges
  ## book_charge contains one row per booking charge. Currently, wobblers are duplicated and removed. However, the correct charge is ambiguous in this case. We need to follow up with San Joaquin.
  ## Use period 2 data to replace historical data submission and period 1 data.
book_charge <- fread("Historical Data Submissions/San Joaquin/P2 Submission-June 30/Jail/20200714_ATIMS_20160101-to-20200630_CHARGES.csv", colClasses = "character")

# Variable name standardization--See pg. xxx for more details.
names(book_charge) <- c("book_num", "book_num_suffix", "count", "arrest_charge_code_original", "arrest_charge_original", "arrest_charge_level_original", "book_type_charge_original")

# Deduplicating instances where wobbler charges (F and M) were both applied. Follow up with San Joaquin about which charge to take. Currently, we are prioritizing the highest charge.
book_charge <- book_charge %>%
  group_by(book_num, count, arrest_charge_original) %>%
  mutate(arrest_charge_level_original = min(arrest_charge_level_original)) %>%
  ungroup() %>%
  distinct(book_num, count, arrest_charge_original, .keep_all = T)

# Standardize Factors--See pg. xxx for more details.
book_charge <- book_charge %>%
  mutate(book_type_charge = case_when(
    book_type_charge_original %in% c("OPEN CHARGES") ~ "On_View",
    book_type_charge_original %in% c("WARRANT - LOCAL") ~ "Warrant",
    book_type_charge_original %in% c("VIOL-PRCS", "VIOL - PROBATION", "VIOL-INTERSTATE PAROLE") ~ "Sup_Vio_Post",
    book_type_charge_original %in% c("REMAND") ~ "Court_Order",
    book_type_charge_original %in% c("FLASH INCARCERATION") ~ "Detain_Only",
    book_type_charge_original %in% c("BOOK & RELEASE") ~ "Cite_Release",
    book_type_charge_original %in% c("WARRANT - OTHER COUNTY", "WARRANT - OTHER STATE", "HOLD-DETAINER", "HOLD-ENROUTER", "WARRANT - FEDERAL", "HOLD - CDCR", "WARRANT - CIVIL") ~ "Hold",
    book_type_charge_original %in% c("COMMITMENT") ~ "Commitment",
    T ~ "Other"
  ))

# Charge Standardization and Flag Adds--See pg. xxx for more details.
  ## Special allegations and codes relating to extra charge information come after the forward slash.
book_charge <- book_charge %>%
  mutate(arrest_charge = case_when(
           grepl("647\\(f\\)[0-9]", arrest_charge_original, ignore.case = T) ~ sub(")", ")/", arrest_charge_original, ignore.case = T),
           arrest_charge_original == "484(A)666B" ~ "484(A)/666B",
           T ~ gsub("664/|/664|^664$", "", arrest_charge_original)
         ),
         special_allegation_flag = if_else(grepl("/667", arrest_charge), 1, 0),
         attempt_flag = if_else(grepl("^664", arrest_charge), 1, 0),
         arrest_charge = gsub("664\\(A\\)/", "", arrest_charge),
         arrest_charge = gsub("/.*|<.*", "", arrest_charge_original)) %>%
  mutate(arrest_charge_code = if_else(!arrest_charge_code_original %in% c("PC", "VC", "HS", "BP", "WI", "US"), "Other", arrest_charge_code_original),
         arrest_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}", "", arrest_charge)),
         # These variables did not match the initial hierarchy. Check if they match the new hierarchy after the joining.
         arrest_charge = if_else(arrest_charge == "300008C", "300008", arrest_charge),
         arrest_charge_level = if_else(!arrest_charge_level_original %in% c("F", "M", "I"), "Other", arrest_charge_level_original)) %>%
  distinct()

load("Complete Charge Code Hierarchy.RData")

book_charge <- book_charge %>%
  unite(join_var, arrest_charge_level, arrest_charge_code, arrest_charge, remove = F) %>%
  left_join(charge_hier) %>%
  mutate(felony_flag = if_else(arrest_charge_level == "F", 1, 0),
         misd_flag = if_else(arrest_charge_level == "M", 1, 0),
         sup_vio_post_flag = if_else(book_type_charge == "Sup_Vio_Post", 1, 0)) %>%
  rename_at(vars(contains("flag")), funs(paste0("arrest_", .)))

####

# Booking Demographic Information
  ## book_demo contains one row per defendant and contains demographic information on them.
  ## Use period 2 data to replace historical data submission and period 1 data.
book_demo <- fread("Historical Data Submissions/San Joaquin/P2 Submission-June 30/Jail/20200714_ATIMS_20160101_to_20200630_PARTY.csv", colClasses = "character")

# Variable name standardization--See pg. xxx for more details.
names(book_demo) <- c("local_id", "cii", "first_name", "last_name", "cdl_id", "dln_state", "dob", "sex_original", "race_original")

# Date Reformatting--See pg. xxx for more details.
book_demo <- book_demo %>%
  mutate(dob = if_else(mdy(dob) > "2002-01-01", mdy(dob) - years(100), mdy(dob)))

# Standardize Factors--See pg. xxx for more details.
book_demo <- book_demo %>%
  mutate(race = case_when(
    race_original %in% c("HISPANIC/LATIN") ~ "Hispanic",
    race_original %in% c("BLACK") ~ "Black",
    race_original %in% c("WHITE") ~ "White",
    T ~ "Other_Unknown"
  ),
  sex = case_when(
    sex_original %in% c("FEMALE") ~ "Female",
    sex_original %in% c("MALE") ~ "Male",
    T ~ "Other_Unknown"
  ))

####

# Booking IPIDs
  ## book_ipid contains one row per person and contains the jail to court local id match.
  ## Use period 2 data to replace historical data submission and period 1 data.
book_ipid <- fread("Historical Data Submissions/San Joaquin/P2 Submission-June 30/Jail/20200714_ATIMS_20160101-to-20200630_LAR-to-IPID.csv", colClasses = "character")

names(book_ipid) <- c("local_id", "ipid")
```

  Jail Collapse
```{r}
# Booking Collapse--See pg. xxx for more details about this process.

# Booking information is merged onto the charges, so we can collapse to the booking/court case level. book_charge did not initially contain the court cases.
book_df <- book_df %>%
  left_join(book_charge, by = "book_num") %>%
  mutate(arrest_sup_vio_post_flag = if_else(arrest_sup_vio_post_flag.x == 1|arrest_sup_vio_post_flag.y == 1, 1, 0)) %>%
  select(-arrest_sup_vio_post_flag.x, arrest_sup_vio_post_flag.y)

book_df <- book_df %>%
  mutate(time_first_release = release_date - book_date) %>%
  mutate(hierarchy = if_else(is.na(hierarchy), 1e6, as.numeric(hierarchy))) %>%
  group_by(book_num, book_date) %>%
  mutate(max_booktype = book_type[hierarchy == min(hierarchy)][1],
         max_arrest_charge = arrest_charge[hierarchy == min(hierarchy)][1],
         max_charge_description = master_charge_description[hierarchy == min(hierarchy)][1],
         max_hier = min(hierarchy)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, .))) %>%
  mutate_at(vars(contains("flag")), funs("count" = sum(.))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  group_by(book_num, court_case_id) %>%
  filter(hierarchy == min(hierarchy)) %>%
  ungroup() %>%
  distinct(book_num, court_case_id, .keep_all = T)

# Joining the booking demographic and court_case_id variables
book_df <- book_df %>%
  left_join(book_demo) %>%
  left_join(book_ipid)

# Separating booking numbers between the main booking and subsequent bookings on the same initial charges. E.g. 1912345.01 to 1912345 for book_num and 01 for book_num_suffix. This is done so we can match the data with the DA filing data.
book_df <- book_df %>%
  mutate(book_num = trimws(book_num)) %>%
  separate(book_num, into = c("book_num", "book_num_suffix"), sep = "\\.")
```

  Jail Diagnostics
```{r}
# charges
# 97.42598%
(1 - nrow(book_charge %>% filter(is.na(hierarchy))) / nrow(book_charge)) * 100

book_charge %>%
  filter(is.na(hierarchy)) %>%
  count(join_var) %>%
  arrange(desc(n))

charge_hier %>%
  filter(grepl(3015, join_var))

book_charge %>%
  filter(grepl(3015, join_var)) %>%
  count(arrest_charge_level_original, arrest_charge_original, charge_description)

# collapse
book_df %>%
  select(contains("book_type"))
```

Court Data
```{r}
# Court Case Data Import--- San Joaquin, 2016-01-04 to 2020-01-27
  ## court_df contians one row per court case and contains information on the filing date and the defendant ID.
  ## court_charge contains one row per court case, charge, disposition type, and sentence type combination. In the collapse section, the sentencing and court charge dispositions are separated into court_dispo and court_sent tables.
  ## court_hearing contains one row per hearing event on each court case and contains information about the hearing. Rarely, multiple hearing types were done on the same day.
  ## court_person contains one row per person and contains demographic information. However, there appears to be multiple duplicates of the same person with ambiguous differences, such as the same driver's license but a different race. Follow up with San Joaquin.
  ## court_fta contains one row per hearing with any type of FTA issued.
####

# Court Cases
  ## court_df contians one row per court case and contains information on the filing date and the defendant ID.
  ## Use period 2 data to replace historical data submission and period 1 data.
court_df <- fread("Historical Data Submissions/San Joaquin/P2 Submission-June 30/Court/pretrial cases.csv", colClasses = "character")

# Variable name standardization--See pg. xxx for more details.
names(court_df) <- c("ipid", "court_case_id", "court_docket_id", "court_docket_id_previous", "complaint_id", "filing_date", "case_status_original", "case_status_date")

# Date Reformatting--See pg. xxx for more details.
court_df <- court_df %>%
  mutate_at(vars(contains("date")), as_date)

# Standardize Factors--See pg. xxx for more details.
court_df <- court_df %>%
  mutate(case_status = case_when(
    case_status_original %in% c("Pending", "Reopened") ~ "Active",
    case_status_original %in% c("Disposed", "Closed") ~ "Inactive",
    T ~ "Other"
  ))

####

# Court Filing Charges
  ## court_charge contains one row per court case, charge, disposition type, and sentence type combination. In the collapse section, the sentencing and court charge dispositions are separated into court_dispo and court_sent tables.
  ## Use period 2 data to replace historical data submission and period 1 data.
court_charge <- lapply(1:4, function(i) {
  fread(paste0("Historical Data Submissions/San Joaquin/P2 Submission-June 30/Court/pretrial charges ", i, ".csv"), colClasses = "character")}) %>%
  bind_rows() %>%
  distinct()

# Variable name standardization--See pg. xxx for more details.
names(court_charge) <- c("ipid", "court_case_id", "court_docket_id", "complaint_id", "court_charge_original", "court_charge_level_original", "charge_description", "count", "qualifier", "police_reference", "disposition_type_original", "disposition_date", "sentence_date", "disposition_result", "dispostion_final_date", "sentence_final_date", "sentence_type_original", "confinement_facilty", "confinement_date", "confinement_end_date", "term_years", "term_months", "term_days", "today", "to_date", "term_to_days", "term_life", "result_id")

# Date Reformatting--See pg. xxx for more details.
court_charge <- court_charge %>%
  mutate_at(vars(contains("date"), today), as_date) %>%
  mutate(court_case_id = parse_number(court_case_id))

# Standardize Factors--See pg. xxx for more details.
court_charge <- court_charge %>%
  mutate(disposition_type = case_when(
    disposition_type_original %in% c("Dismissed in View of Plea", "Dismissed on motion of the People", "Dismissed Other", "Dismissal/1385 PC Lack of Prosecution", "Not held to Answer - Dismissal 871 PC", "Dismissal 995 PC", "Dismissed 1381/1382 PC", "Proof of Correction/Dismissed", "1203.4 Conv Set Aside& Dism", "Dismissal After Diversion", "Sentence Vacated, Plea set aside, and Dismissed", "Dismissed - Plea Withdrawn", "Dismissed 530.6 PC", "Mistrial Discharged/Dismissed", "Demurrer Sustained - Dismissal 1008 PC", "Dismissal After Drug Court", "DEJ Completed - Dismissal", "Stricken") ~ "Dismissed",
    disposition_type_original %in% c("Withdrawn by DA") ~ "Dropped",
    disposition_type_original %in% c("Sentenced", "Jury Verdict of Guilty", "Court Finding of Guilt", "Resentenced") ~ "Guilty",
    disposition_type_original %in% c("Jury Verdict of Not Guilty", "Court Finding of Not Guilty", "Acquittal", "Sealed 851.85 Factually Innocent") ~ "Not_Guilty",
    T ~ "Other"
  ),
  # They have 2 separate disposition type variables. Using both of them, we prioritized "Not Guilty"/"Dismissed" over "Guilty" and everytihng over "Other" for each charge. This is different from when we collapsed the whole case where we prioritized "Guilty"
  disposition_check = case_when(
    grepl("Dismiss", disposition_result) ~ "Dismissed",
    grepl("Sentenced|Guilty", disposition_result) ~ "Guilty",
    T ~ "Other"
  ),
  disposition_type = if_else(disposition_type == "Other", disposition_check, disposition_type),
  disposition_type = if_else(disposition_type == "Guilty" & disposition_check != "Other", disposition_check, disposition_type),
  sentence_type = case_when(
    grepl("JAIL", sentence_type_original) ~ "Jail",
    grepl("TERM|LIFE|PENITENTIARY", sentence_type_original) ~ "Prison",
    T ~ "Other"
  ))

# Charge Standardization and Flag Adds--See pg. xxx for more details.
court_charge <- court_charge %>%
  mutate(attempt_flag = if_else(grepl("664/", court_charge_original), 1, 0),
         court_charge = gsub("664/", "", court_charge_original),
         conspiracy_flag = if_else(grepl("PC 182(a)(1)", court_charge_original), 1, 0),
         court_charge = gsub("PC 182(a)(1)/", "", court_charge)) %>%
  mutate(court_charge_code = case_when(
    grepl("PC", court_charge, ignore.case = T) ~ "PC",
    grepl("VC", court_charge, ignore.case = T) ~ "VC",
    grepl("HS", court_charge, ignore.case = T) ~ "HS",
    grepl("BP", court_charge, ignore.case = T) ~ "BP",
    grepl("WI", court_charge, ignore.case = T) ~ "WI",
    grepl("US", court_charge, ignore.case = T) ~ "US",
    T ~ "Other"
  ),
  court_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}", "", court_charge)),
  court_charge_level = case_when(
    court_charge_level_original %in% c("FE") ~ "F",
    court_charge_level_original %in% c("MI") ~ "M",
    T ~ "Other"
  )) %>%
  distinct()

load("Complete Charge Code Hierarchy.RData")

court_charge <- court_charge %>%
  unite(join_var, court_charge_level, court_charge_code, court_charge, remove = F) %>%
  left_join(charge_hier) %>%
  mutate(felony_flag = if_else(court_charge_level == "F", 1, 0),
         misd_flag = if_else(court_charge_level == "M", 1, 0)) %>%
  rename_at(vars(contains("_flag")), funs(paste0("court_", .))) %>%
  mutate_at(vars(contains("_flag")), funs("conviction" = if_else(disposition_type %in% c("Nolo_Contendere", "Guilty") & . == 1, 1, 0))) %>%
  rename_at(vars(contains("_conviction")), funs(paste0("conviction_", gsub("court_|_conviction", "", .))))

# Fixing inconsistencies, between tables, in court_docket_id having leading zeros after the year by removing the zeros. E.g. CR-1966-0000002 is changed to CR-1966-2 for all tables.
court_charge <- court_charge %>%
  mutate(court_docket_id = gsub("-0+", "-", court_docket_id))

####

# Court Hearings
  ## court_hearing contains one row per hearing event on each court case and contains information about the hearing. Rarely, multiple hearing types were done on the same day.
  ## Use period 1 data to replace historical data submission.
court_hearing <- fread("Historical Data Submissions/San Joaquin/hearings.csv", colClasses = "character")

court_hearing_p2 <- fread("Historical Data Submissions/San Joaquin/P2 Submission-June 30/Court/pretrial hearings using hearing results.csv", colClasses = "character")

court_hearing <- court_hearing %>%
  bind_rows(court_hearing_p2) %>%
  distinct()

rm(court_hearing_p2)

# Variable name standardization--See pg. xxx for more details.
names(court_hearing) <- c("court_docket_id", "case_type", "hearing_date", "hearing_type_original")

# Date Reformatting--See pg. xxx for more details.
court_hearing <- court_hearing %>%
  mutate(hearing_date = as_date(hearing_date))

# Standardize Factors--See pg. xxx for more details.
court_hearing <- court_hearing %>%
  mutate(hearing_type = case_when(
    grepl("Arraignment", hearing_type_original, ignore.case = T) ~ "Arraignment",
    grepl("Sentencing", hearing_type_original, ignore.case = T) ~ "Sentencing",
    T ~ "Other"
  ))

# Fixing inconsistencies, between tables, in court_docket_id having leading zeros after the year by removing the zeros. E.g. CR-1966-0000002 is changed to CR-1966-2 for all tables.
court_hearing <- court_hearing %>%
  mutate(court_docket_id = gsub("-0+", "-", court_docket_id))

####

# Court Person Information
  ## court_person contains one row per person and contains demographic information. However, there appears to be multiple duplicates of the same person with ambiguous differences, such as the same driver's license but a different race. Follow up with San Joaquin.
  ## Use period 2 data to replace historical data submission and period 1 data.
court_person <- fread("Historical Data Submissions/San Joaquin/P2 Submission-June 30/Court/pretrial parties.csv", colClasses = "character")

# Variable name standardization--See pg. xxx for more details.
names(court_person) <- c("ipid", "court_case_id", "last_name", "first_name", "dob", "gender", "race_original", "ethnicity", "cdl_id", "dln_state")

# Date Reformatting--See pg. xxx for more details.
court_person <- court_person %>%
  mutate(dob = as_date(dob))

# Standardize Factors--See pg. xxx for more details.
court_person <- court_person %>%
  mutate(race = if_else(!race_original %in% c("Hispanic", "Black", "White"), "Other_Unknown", race_original))

####

# Court FTAs
  ## court_fta contains one row per hearing with any type of FTA issued.
court_fta <- fread("Historical Data Submissions/San Joaquin/P2 Submission-June 30/Court/pretrial hearings using warrants issued.csv", colClasses = "character")

# Variable name standardization--See pg. xxx for more details.
names(court_fta) <- c("court_docket_id", "case_type", "warrant_num", "fta_warrant_date")

# Date Reformatting--See pg. xxx for more details.
court_fta <- court_fta %>%
  mutate(hearing_date = as_date(hearing_date))

# Flag Adds--See pg. xxx for more details.
court_fta <- court_fta %>%
  mutate(court_fta_all_flag = 1)

# Fixing inconsistencies, between tables, in court_docket_id having leading zeros after the year by removing the zeros. E.g. CR-1966-0000002 is changed to CR-1966-2 for all tables.
court_fta <- court_fta %>%
  mutate(court_docket_id = gsub("-0+", "-", court_docket_id))

####

# Court FTAs with Warrants
  ## court_fta_war contains one row per bench warrant issued for a court case and contains information on the FTA.
  ## Use period 2 data to replace historical data submission and period 1 data.
court_fta_war <- fread("Historical Data Submissions/San Joaquin/P2 Submission-June 30/Court/pretrial warrants.csv", colClasses = "character")

# Variable name standardization--See pg. xxx for more details.
names(court_fta_war) <- c("court_docket_id", "warrant_num", "fta_warrant_status", "fta_warrant_date", "fta_recall_date")

# Date Reformatting--See pg. xxx for more details.
court_fta_war <- court_fta_war %>%
  mutate_at(vars(contains("date")), as_date)

# Flag Adds--See pg. xxx for more details.
  ## some of the FTA warrants were recalled.
court_fta_war <- court_fta_war %>%
  mutate(court_fta_flag = 1)
```

  Court Collapse
```{r}
# Court Charge Collapse--See pg. xxx for more details about this process.
  ## Sentencing information is contained in the charge table. We are separating this into court_dispo, which contains the charge and charge disposition information and court_sent, which contains the sentencing information on each case.
court_dispo <- court_charge %>%
  select(-contains("confinement"), -contains("term"), -to_date, -sentence_date, -sentence_final_date) %>%
  distinct() %>%
  group_by(court_docket_id, count, join_var) %>%
  arrange(disposition_date) %>%
  # 20 cases had 2 dispositions and we are taking the original one.
  distinct(court_docket_id, count, join_var, .keep_all = T) %>%
  ungroup()

court_dispo <- court_dispo %>%
  mutate(disposition_type = ordered(disposition_type, levels = c("Other", "Dismissed", "Not_Guilty", "Nolo_Contendere", "Guilty"))) %>%
  group_by(court_docket_id) %>%
  # Charges that have not been disposed of are removed
  mutate(hierarchy = if_else(is.na(hierarchy), 1e6, as.numeric(hierarchy))) %>%
  group_by(court_docket_id) %>%
  mutate(disposition_date = max(disposition_date),
         disposition_type = max(disposition_type),
         max_court_charge_level = court_charge_level[hierarchy == min(hierarchy)][1],
         max_court_charge_code = court_charge_code[hierarchy == min(hierarchy)][1],
         max_court_charge = court_charge[hierarchy == min(hierarchy)][1],
         max_charge_description = master_charge_description[hierarchy == min(hierarchy)][1],
         max_hier = min(hierarchy)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, .))) %>%
  mutate_at(vars(contains("flag")), funs("count" = sum(.))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  filter(hierarchy == min(hierarchy)) %>%
  ungroup() %>%
  distinct(court_docket_id, .keep_all = T)

# Court Sentencing Information
court_sent <- court_charge %>%
  select(court_docket_id, contains("confinement"), contains("term"), to_date, contains("sentence")) %>%
  mutate(sentence_type = ordered(sentence_type, levels = c("Other", "Probation", "Jail", "Prison"))) %>%
  group_by(court_docket_id) %>%
  mutate(sentence_type = max(sentence_type)) %>%
  ungroup() %>%
  mutate(sentence_date = if_else(is.na(sentence_date), sentence_final_date, sentence_date)) %>%
  arrange(sentence_date) %>%
  distinct(court_docket_id, .keep_all = T) %>%
  filter(!is.na(sentence_date))

  ## There is some sentencing information in the court_hearing data frame, but not on the charges. We are pulling them in here.
court_sent2 <- court_hearing %>%
  filter(hearing_type == "Sentencing") %>%
  arrange(hearing_date) %>%
  rename(sentence_date = hearing_date) %>%
  distinct(court_docket_id, .keep_all = T) %>%
  select(court_docket_id, sentence_date) %>%
  mutate(sentence_type = "Other")

court_sent <- court_sent %>%
  bind_rows(court_sent2) %>%
  distinct(court_case_id, .keep_all = T)

rm(court_sent2)

# Court Ftas are not separate from warrants
court_fta_war <- court_fta_war %>%
  arrange(fta_warrant_date) %>%
  group_by(court_docket_id) %>%
  mutate(court_fta_flag = max(court_fta_flag),
         fta_flag_count = sum(court_fta_flag)) %>%
  distinct(court_docket_id, .keep_all = T) %>%
  ungroup()

# Court hearings are filtered for arraignment information and collapsed to court case id.
court_hearing <- court_hearing %>%
  filter(hearing_type == "Arraignment") %>%
  arrange(hearing_date) %>%
  rename(arraignment_date = hearing_date) %>%
  distinct(court_docket_id, .keep_all = T) %>%
  select(court_docket_id, arraignment_date)

court_df2 <- reduce(list(court_df, court_dispo, court_sent, court_fta_war, court_hearing), left_join, by = "court_docket_id") %>%
  select(-contains(".x.x"), -contains(".y")) %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x", "", .))) %>%
  mutate(pretrial_end_date = if_else(disposition_date <= sentence_date|is.na(sentence_date), disposition_date, sentence_date),
         conviction_flag = if_else(disposition_type %in% c("Guilty","Nolo_Contendere"), 1, 0)) %>%
  # 28,129 out of the 110,729 court cases do not have a unique person identifier. Follow up with San Joaquin. Many instances of the court_df have NULL for ipid and we are unable to match the people for any of these.
  left_join(court_person, by = "court_case_id") %>%
  select(-ipid.y) %>%
  rename(ipid = ipid.x)
```

  Court Diagnostics
```{r}
# charges
# 97.4647%
(1 - nrow(court_charge %>% filter(is.na(hierarchy))) / nrow(court_charge)) * 100

court_charge %>%
  filter(is.na(hierarchy)) %>%
  count(join_var) %>%
  arrange(desc(n))

charge_hier %>%
  filter(grepl(3015, join_var))

court_charge %>%
  filter(grepl(3015, join_var)) %>%
  count(court_charge_level_original, court_charge_original, charge_description)
```

DA data 
```{r}
# DA Data Import--- San Joaquin, 2016-01-04 to 2020-01-27 (from court data)
  ## da_df contians one row per court case booking combination and contains information on the court docket ID and booking number.
  ## NOT USED: prob_df contains one row per court case risk assessment combination, but has no information other than the risk assessment date and the court docket ID.

####

# DA Data
  ## da_df contians one row per court case booking combination and contains information on the court docket ID and booking number.
  ## Use period 2 data to replace historical data submission and period 1 data.
da_df <- fread("Historical Data Submissions/San Joaquin/P2 Submission-June 30/Court/pretrial bookings.csv", colClasses = "character")

# Variable name standardization--See pg. xxx for more details.
names(da_df) <- c("ipid", "fce_entity_id", "court_docket_id", "court_docket_id_full", "da_complaint_num", "book_num")

# Deduplication and booking number fixes
  ## Booking data matches with DA data based on booking number. However, many book_nums in the da_df start with 99. These also start with LOD in the court_docket_id_full. Follow up with San joaquin about LOD.
  ## Also removing duplicates
da_df <- da_df %>%
  mutate(book_num = gsub("[A-Z]", "", book_num),
         book_num = gsub("^(.{1,2})(-)(.*)", "\\1\\3", book_num)) %>%
  separate(book_num, into = c("book_num", "book_num_suffix"), sep = "-|\\.| ") %>%
  distinct()

#### NOT USED ####

# # Probation data on which cases had risk assessment.
#   ## prob_df contains one row per court case risk assessment combination, but has no information other than the risk assessment date and the court docket ID.
#   ## Use period 2 data to replace historical data submission and period 1 data.
# prob_df <- fread("Historical Data Submissions/San Joaquin/P2 Submission-June 30/Court/pretrial assessment reports.csv", colClasses = "character")
# 
# # Variable name standardization--See pg. xxx for more details.
# names(prob_df) <- c("court_docket_id", "report_status", "ra_date")
# 
# # Date Reformatting--See pg. xxx for more details.
# prob_df <- prob_df %>%
#   mutate(ra_date = as_date(ra_date))
# 
# # Removing duplicates
# prob_df <- prob_df %>%
#   distinct(court_docket_id, ra_date, .keep_all = T)
```

Probation (assessment) data--Fix later

```{r}
prob_df_17 <- read_excel("Historical Data Submissions/San Joaquin/MASTER Pretrial Data Collection Variables  2019.xlsx", sheet = "Pretrial Variables since 2017", col_types = "text")

prob_df_17 <- prob_df_17 %>%
  slice(-1) %>%
  rename_all(str_squish) %>%
  rename_at(vars(contains("...")), funs(paste0("...", as.numeric(gsub("...", "", .)) - 8)))

prob_df_14_16 <- lapply(c("2014", "2015", "2016"), function(i) {
  read_excel("Historical Data Submissions/San Joaquin/MASTER Pretrial Data Collection Variables  2019.xlsx", sheet = i, col_types = "text")
}) %>%
  bind_rows()

prob_df_14_16 <- prob_df_14_16 %>%
  slice(-1) %>%
  rename_all(str_squish)

prob_df2 <- prob_df_17 %>%
  bind_rows(prob_df_14_16)

rm(prob_df_14_16, prob_df_17)

# Variable name standardization--See pg. xxx for more details.
names(prob_df2) <- c("count", "assessment_date", "unknown_id", "court_docket_id", "book_num", "assessment_charge", "last_name", "first_name", "cii", "local_id", "dln_state", "cdl_id", "dob", "sex_original", "race_original", "zipcode", "risk_score_original", "tansdermal_study", "overide", "auto_hold_1270.1", "auto_hold_1319", "auto_hold_other", "release_authorization_prearraignment", "release_authorization_postarraignment", "concurrence", "judge_name", "gps", "pretrial_release_date", "pretrial_monitor_start_date", "pretrial_monitor_end_date", "monitor_level", "fta_warrant", "court_remand", "remand_date", "remand_memo", "rearrest", "rearrest_date", "rearrest_charge", "charge_description", "assessment_charge_level", "termination_outcome", "notes")

# Date Reformatting--See pg. xxx for more details.
prob_df2 <- prob_df2 %>%
  mutate_at(vars(contains("date"), dob), convertToDate)

# Standardize Factors--See pg. xxx for more details.
prob_df2 <- prob_df2 %>%
  mutate(race = case_when(
    race_original %in% c("HISPANIC", "H", "HIspanic") ~ "Hispanic",
    race_original %in% c("BLACK", "black") ~ "Black",
    race_original %in% c("WHITE", "white", "W", "WHI", "wHITE") ~ "White",
    T ~ "Other_Unknown"
  ),
  sex = case_when(
    sex_original %in% c("FEMALE", "female") ~ "Female",
    sex_original %in% c("MALE", "male", "M", "MM") ~ "Male",
    T ~ "Other_Unknown"
  ),
  risk_score = case_when(
    risk_score_original %in% c("THREE") ~ 3,
    risk_score_original %in% c("four", "FOUR") ~ 4,
    risk_score_original %in% c("EIGHT") ~ 8,
    T ~ as.numeric(risk_score_original)
  ))

# Flag Adds--See pg. xxx for more details.
prob_df2 <- prob_df2 %>%
  mutate(fta_flag = if_else(fta_warrant %in% c("Y", "y"), 1, 0),
         fta_all_flag = if_else(!is.na(fta_warrant), 1, 0),
         sup_pre_flag = if_else(!is.na(pretrial_monitor_start_date), 1, 0),
         sup_vio_pre_flag = if_else(rearrest %in% c("Y", "y"), 1, 0))
```

  Assessment Collapse
```{r}
# Assessment Collapse--See pg. xxx for more details about this process.
assess_df <- prob_df2 %>%
  filter(!is.na(risk_score)) %>%
  distinct(unknown_id, assessment_date, .keep_all = T) %>%
  select(unknown_id, court_docket_id, cii, cdl_id, local_id, last_name, first_name, dob, sex_original, race_original, sex, race, zipcode, assessment_date, risk_score)
```

Join
```{r}
# Remove extraneous objects in the environment
rm(list = ls()[!ls() %in% ls(pattern = "df")])

#Check for common variables
names(book_df)[names(book_df) %in% names(assess_df)]

names(book_df)[names(book_df) %in% names(court_df2)]

#Turning NULL to NA to ensure non matching and removing generic charge info from data frames
book_df <- book_df %>%
  mutate_if(is.character, list(~na_if(., "NULL"))) %>%
  select(-c(charge, charge_level, charge_code))
  # mutate_at(vars(first_name, last_name), toupper)

assess_df <- assess_df %>%
  mutate_if(is.character, list(~na_if(., "(Missing)")))
  # select(-c(id, court))

court_df2 <- court_df2 %>%
  mutate_if(is.character, list(~na_if(., "NULL"))) %>%
  select(-c(charge, charge_level, charge_code)) %>%
  # mutate_at(vars(first_name, last_name), toupper) %>%
  mutate(court_docket_id = as.character(court_docket_id))

#Joining Assessment to Jail Data
join1 <- inner_join(book_df, assess_df, by = "court_docket_id", na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x$", "", .))) %>%
  select(-contains(".y")) %>%
  #1 Duplicate with missing dispositions which will be dropped later. 
  distinct()

j1 <- anti_join(book_df, assess_df, by = "court_docket_id", na_matches = "never")
a1 <- anti_join(assess_df, book_df, by = "court_docket_id", na_matches = "never")


  #Examine if set of common variables is distinct--yes
  semi_join(book_df, assess_df, by = "court_docket_id", na_matches = "never") %>%
    distinct()

#Joining on Name and Court ID
join2 <- inner_join(j1, a1, by = c("court_docket_id", "book_date" = "assessment_date"), 
                    na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x$", "", .))) %>%
  select(-contains(".y")) %>%
  #1 Duplicate with missing dispositions which will be dropped later. 
  distinct()

j2 <- anti_join(j1, a1, by = c("court_docket_id", "book_date" = "assessment_date"), na_matches = "never")
a2 <- anti_join(a1, j1, by = c("court_docket_id", "assessment_date" = "book_date"), na_matches = "never")

  #Examine if set of common variables is distinct--yes
  semi_join(j1, a1, by = c("court_docket_id", "book_date" = "assessment_date"), 
            na_matches = "never") %>%
    distinct()
  
#Diagnostics
  #Jail and Assessment Matches by category
  # 0.08133608%
tibble(
  stage = 1:2,
  match = c(
    'c("court_docket_id")',
    'c("court_docket_id", "book_date" = "assesment_date")'
  ),
  # jail_match_rate = sapply(1:2, function(i) {
  #   (nrow(book_df) - nrow(get(paste0("j", i)))) / nrow(book_df) * 100
  # }),
  assess_match_rate = sapply(1:2, function(i) {
    (nrow(assess_df) - nrow(get(paste0("a", i)))) / nrow(assess_df) * 100
  })
)

#Recreating Booking--Should be same number of rows.
book_df <- bind_rows(join1, join2, j2)  

rm(list = ls()[!ls() %in% ls(pattern = "df")])

# Court Matching
#Joining on CII and Court ID
join1 <- inner_join(book_df, court_df2, by = "court_docket_id", na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(paste0("arrest_", gsub("\\.x$", "", .)))) %>%
  rename_at(vars(contains(".y")), funs(paste0("court_", gsub("\\.y$", "", .)))) %>%
  # 8 Duplicates with missing dispositions which will be dropped later. 
  distinct()

j1 <- anti_join(book_df, court_df2, by = "court_docket_id", na_matches = "never")
c1 <- anti_join(court_df2, book_df, by = "court_docket_id", na_matches = "never")

  #Examine if set of common variables is distinct--yes except 8 spurious cases.
  join1 %>%
    add_count(court_docket_id) %>%
    filter(n > 1) %>%
    arrange(desc(n))

#Diagnostics
  #Jail and Court Matches by category
  # 0.03502452% and 0.03793044%
tibble(
  stage = 1,
  match = c(
    # 'c("court_docket_id", "cii", "dob")',
    # 'c("court_docket_id", "first_name", "dob")',
    'court_docket_id'
  ),
  jail_match_rate = sapply(1, function(i) {
    (nrow(book_df) - nrow(get(paste0("j", i)))) / nrow(book_df) * 100
  }),
  court_match_rate = sapply(1, function(i) {
    (nrow(court_df2) - nrow(get(paste0("c", i)))) / nrow(court_df2) * 100
  })
)

join_df <- bind_rows(join1, j1)
```

Code Book
```{r eval=FALSE, include=FALSE}
rm(original_field)

original_df <- bind_rows(original_df)

San_Joaquin_df <- lapply(ls()[!grepl("original", ls())], function(i){
  df <- get(i)
  
  if(sum(grepl("date", names(df))) > 0){
  df2 <- df %>%
  select(contains("date"), -contains("time")) %>%
  gather("modified_field", "value") %>%
  group_by(modified_field) %>%
  summarise_all(funs(min = as.character(min(., na.rm = T)), mean = as.character(mean(., na.rm = T)), max = as.character(max(., na.rm = T))))
  }else{
    df2 <- tibble(modified_field = NA_character_, min = NA_character_, mean = NA_character_, max = NA_character_)
  }
  
  df <- df %>%
    mutate_if(~length(unique(.)) > 50|is.Date(.)|is.POSIXct(.), ~(. = "not_factor")) %>%    
    mutate_all(~if_else(is.na(.), "na_missing", as.character(.))) %>%
    gather(modified_field, factor_value) %>%
    count(modified_field, factor_value) %>%
    mutate(table_name = i, county = "San_Joaquin") %>%
    mutate(factor_flag = if_else(factor_value == "not_factor", 0, 1)) %>%
    group_by(table_name, modified_field) %>%
    mutate(table_count = sum(n)) %>%
    ungroup() %>%
    rename("factor_count" = "n") %>%
    mutate(factor_count = if_else(factor_value == "not_factor", NA_integer_, factor_count),
           factor_percent = round(factor_count/table_count*100, 1)) %>%
    arrange(desc(factor_flag), modified_field, desc(factor_count))
  
  df <- left_join(df, df2, by = "modified_field")
    }) %>% 
  bind_rows() %>%
  left_join(original_df) %>%
   select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_count,
           factor_percent, table_count, min, mean, max) 

write.xlsx(San_Joaquin_df, file = "Code Books/San Joaquin Code Book.xlsx")
```

DOJ CII/Linking Extraction
```{r}
# Grab Tables with CII
df <- sapply(ls()[which(sapply(ls(), function(i){
  sum(names(get(i)) %in% "cii")
}) == 1)], get)

# Pull CII and other identifiers
doj_book <- df[[1]] %>%
  select(cii, fbi, pfn_x, first_name, last_name, dob, cld_id, cdl_state, race_original, sex_original, local_id) %>%
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) %>%
  distinct()


doj_court <- df[[2]] %>%
  select(cii, fbi, cld_id, cdl_state, dob, race_original, sex_original, first_name, last_name, local_id, pfn_x) %>%
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) %>%
  distinct()

# Examine missing ciis and duplicates on cii. 
doj_book %>% #Off by about 55,000
  distinct()

doj_book %>% 
  distinct(cii)

doj_book %>% 
  distinct() %>%
  add_count(cii) %>%
  filter(n > 1) %>%
  arrange(desc(n)) %>% 
  View()

doj_court %>% #Off by about 45,000
  distinct()

doj_court %>% 
  distinct(cii)

doj_court %>% 
  distinct() %>%
  add_count(cii) %>%
  filter(n > 1) %>%
  arrange(desc(n)) %>% 
  View()

#In this case, it is clear that the local ID is not a true person identifier but rather an event identifier and so should be removed.

doj_book <- doj_book %>% select(-local_id)
doj_court <- doj_court %>% select(-local_id)

doj_book %>% # Off by about 7,000
  distinct()

doj_book %>% 
  distinct(cii)

doj_book %>% 
  distinct() %>%
  add_count(cii) %>%
  filter(n > 1) %>%
  arrange(desc(n)) %>% 
  View()

doj_court %>% #Off by about 9,000
  distinct()

doj_court %>% 
  distinct(cii)

doj_court %>% 
  distinct() %>%
  add_count(cii) %>%
  filter(n > 1) %>%
  arrange(desc(n)) %>% 
  View()

#CIIs for DOJ
doj_cii <- bind_rows(doj_book %>% select(cii), doj_court %>% select(cii)) %>% distinct()

doj_cii <- doj_cii %>% 
  mutate(row = as.character(row_number() + 1e11)) %>%
  mutate(cii = paste(row, cii, sep = "|")) %>%
  select(cii)

#Create an excel workbook with all data table. Make sure to include the cii table first. 
write.xlsx(list(doj_cii, doj_book, doj_court), file = "CIIs for DOJ/San Joaquin CIIs and Demographics for DOJ.xlsx", sheetName = c("ciis", "booking", "court"))
```

Completion
```{r}
files <- list.files("G:/CrimJustice/PretrialAssessmentPilot/Code Books/Code Book Notes", pattern = "San Joaquin", full.names = T)

df <- lapply(files, read_excel)

df[[3]] <- full_join(df[[1]], df[[2]]) %>%
  mutate(factor_standard = "") %>%
  select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_standard, factor_count, factor_percent, table_count, "jw_notes" = Notes, "nl_notes_1" = factor_collapse, "nl_notes_2" = notes, min, mean, max)

df <- list(df[[3]], df[[1]], df[[2]])

write.xlsx(df, file = "G:/CrimJustice/PretrialAssessmentPilot/Code Books/Variable Construction/San Joaquin Factor Construction.xlsx", asTable = T, tableStyle = "TableStyleMedium1", sheetName = c("Variable Construction", "jw_notes", "nl_notes"))
```

Factor Code Book
```{r}
factor_df <- lapply(ls()[!grepl("original|^df|hier", ls())], function(i){
  df <- get(i)
  if(sum(grepl("original", names(df))) == 0){
    return(NULL)
  }else{
    var_names <- names(df)[grepl("original", names(df))]
    var_names2 <- gsub("_original", "", var_names)
   
    df1 <- df %>%
     select(var_names) %>%
     gather(original_field, original_value)
   
    df2 <- df %>%
     select(var_names2) %>%
     gather(modified_field, modified_value)
   
   df <- bind_cols(df1, df2) %>%
     count(original_field, modified_field, original_value, modified_value) %>%
     arrange(modified_field, desc(n)) %>%
     group_by(modified_field) %>%
     mutate(row = row_number(),
            percent = round(n/sum(n)*100)) %>%
     ungroup() %>%
     filter(row <= 50) %>%
     select(-row) %>%
     rename("total" = n)
   }
  }) %>%
  bind_rows()

write.xlsx(factor_df, file = "G:/CrimJustice/PretrialAssessmentPilot/Code Books/Factor Code Book/San Joaquin Factor Code Book.xlsx", asTable = T, tableStyle = "TableStyleMedium1", colWidths = "auto")
```

# Ventura

Jail Data
```{r}
# Jail Bookings Data Import--- Ventura, 2015-01-01 to 2020-06-30
  ## book_df contains one row per booking event and contains information on the person as well as the booking date and the release date. The primary key variable is book_num.
  ## book_case contains one row per booking event, related court case, arrest date, bail amount, and booking type. The primary key variables are book_num, court_case_id, and local_id. Join book_df by book_num and join court_df by court_case_id and local_id.
  ## book_charge contains one row per booking event, related court case, local ID, arrest charge, and arrest charge level and contains information on the booking charge. It has no primary key variables because there can be multiple counts of the same charge. Join book_case by book_num, court_case_id, and local_id.

####

# Booking Data
  ## book_df contains one row per booking event and contains information on the person as well as the booking date and the release date.
book_df <- read.csv("Historical Data Submissions/Ventura/P2 Submission-June 30/ventura_jail_bookings.csv", fileEncoding = "UTF-16", colClasses = "character")

# Variable name standardization--See pg. xxx for more details.
names(book_df) <- c("book_num", "local_id", "book_date", "cii", "release_date", "release_type_original", "fbi", "cdl_id", "sex_original", "race_original", "employment_status")

# Date Reformatting--See pg. xxx for more details.
book_df <- book_df %>%
  mutate_at(vars(contains("date")), mdy)

# Standardize Factors--See pg. xxx for more details.--See pg. xxx for more details.
book_df <- book_df %>%
  mutate(race = case_when(
    race_original %in% c("Hispanic/Latin/Mexican") ~ "Hispanic",
    race_original %in% c("Black") ~ "Black",
    race_original %in% c("White") ~ "White",
    T ~ "Other_Unknown"
  ),
  sex = sex_original,
  release_type = case_when(
    release_type_original %in% c("Own Recognizance", "Sheriff's Release") ~ "OR",
    release_type_original %in% c("Cite & Release", "Citation", "Book and Release") ~ "Cite_Release",
    release_type_original %in% c("Bail Bond", "Paid Bail", "Cash Bail", "Appeal Bond") ~ "Bail_Bond",
    release_type_original %in% c("Dismissed") ~ "Dismissed_Dropped",
    release_type_original %in% c("Served Sentence") ~ "Time_Served",
    release_type_original %in% c("Court Order") ~ "Court_Order",
    release_type_original %in% c("Other County", "Hold Dropped", "Extradition", "Enroute") ~ "Hold_Release",
    release_type_original %in% c("ICE") ~ "Fed",
    release_type_original %in% c("Accelerated Release") ~ "Unspec_Cap",
    release_type_original %in% c("California Department of Corrections", "State Prison") ~ "Prison",
    T ~ "Other"
  ))

####

# Booking Cases
  ## book_case contains one row per booking event, related court case, arrest date, bail amount, and booking type.
book_case <- read.csv("Historical Data Submissions/Ventura/P2 Submission-June 30/ventura_jail_cases.csv", fileEncoding = "UTF-16", colClasses = "character")

# Variable name standardization--See pg. xxx for more details.
names(book_case) <- c("book_num", "court_case_id", "local_id", "name", "dob", "arrest_date", "book_type_original", "bail_amt")

# Date Reformatting--See pg. xxx for more details.
book_case <- book_case %>%
  mutate_at(vars(dob, arrest_date), mdy)

# Standardize Factors--See pg. xxx for more details.--See pg. xxx for more details.
book_case <- book_case %>%
  mutate(book_type = case_when(
    book_type_original %in% c("Probable Cause", "VOP - Probable Cause", "Citizen's Arrest") ~ "On_View",
    book_type_original %in% c("Civil Warrant", "Parole Warrant", "PC Order of Production", "Ramey Warrant", "Order of Production") ~ "Other_Warrant",
    book_type_original %in% c("Warrant Arrest") ~ "Warrant",
    book_type_original %in% c("PROSFI", "PROSHD", "PROS Warrant", "PAROLEREV", "PROSWAIV", "PR", "PROS", "PROSFI,") ~ "Sup_Vio_Post",
    book_type_original %in% c("Remand", "Remand - VOP", "Remand -", "Remand - VO", "Remand - VOP,", "Remand,") ~ "Court_Order",
    book_type_original %in% c("Parole Flash Incarceration", "Parole Flash Incarcerati") ~ "Detain_Only",
    book_type_original %in% c("Citation") ~ "Cite_Release",
    book_type_original %in% c("OOC Warrant", "Parole Hold", "Hold", "Enrouter", "CYA Hold", "OOC Ramey Warrant", "Enrouter - Civil", "ICE Hold", "OOC Warr", "OOC Warra") ~ "Hold",
    book_type_original %in% c("Commit - VOP", "VOP - Commitment", "Commitme", "Co", "Com", "Comm", "Commi", "Commit", "Commit - V", "Commitm") ~ "Commitment",
    T ~ "Other"
  ))

# Flag Adds--See pg. xxx for more details.
book_case <- book_case %>%
  mutate(sup_vio_post_flag = if_else(book_type == "Sup_Vio_Post", 1, 0))

####

# Booking Filing Charges
  ## book_charge contains one row per booking event, related court case, local ID, arrest charge, and arrest charge level and contains information on the booking charge.
book_charge <- fread("Historical Data Submissions/Ventura/P2 Submission-June 30/ventura_jail_booking_charges.csv", colClasses = "character")

# Variable name standardization--See pg. xxx for more details.
names(book_charge) <- c("book_num", "court_case_id", "local_id", "arrest_charge_original", "arrest_charge_level_original")

# Charge Standardization and Flag Adds--See pg. xxx for more details.
book_charge <- book_charge %>%
  mutate(attempt_flag = if_else(grepl("664/", arrest_charge_original), 1, 0),
         arrest_charge_code = str_extract(arrest_charge_original, "^[A-Z]*"),
         arrest_charge_code = if_else(!arrest_charge_code %in% c("PC", "VC", "HS", "BP", "WI", "US"), "Other", arrest_charge_code),
         arrest_charge = gsub("664/", "", arrest_charge_original),
         arrest_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}|EX|\\+|\\-| M$| F$", "", trimws(arrest_charge))),
         arrest_charge_level = if_else(!arrest_charge_level_original %in% c("F", "M", "I"), "Other", arrest_charge_level_original)) %>%
  unite(join_var, arrest_charge_level, arrest_charge_code, arrest_charge, remove = F) %>%
  distinct()

load("Complete Charge Code Hierarchy.RData")

book_charge <- book_charge %>%
  left_join(charge_hier) %>%
  mutate(felony_flag = if_else(arrest_charge_level == "F", 1, 0),
         misd_flag = if_else(arrest_charge_level == "M", 1, 0)) %>%
  rename_at(vars(contains("flag")), funs(paste0("arrest_", .)))
```

  Jail Collapse
```{r}
# Booking Collapse--See pg. xxx for more details about this process.

# Booking information is merged onto the charges, so we can collapse to the booking/court case level.
book_df <- book_df %>%
  left_join(book_charge)

book_df <- book_df %>%
  mutate(time_first_release = release_date - book_date) %>%
  mutate(hierarchy = if_else(is.na(hierarchy), 1e6, as.numeric(hierarchy))) %>%
  group_by(book_num, book_date) %>%
  mutate(max_arrest_charge = arrest_charge[hierarchy == min(hierarchy)][1],
         max_charge_description = master_charge_description[hierarchy == min(hierarchy)][1],
         max_hier = min(hierarchy)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, .))) %>%
  mutate_at(vars(contains("flag")), funs("count" = sum(.))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  group_by(book_num, court_case_id) %>%
  filter(hierarchy == min(hierarchy)) %>%
  ungroup() %>%
  distinct(book_num, court_case_id, .keep_all = T)

# Joining the booking cases and court_case_id variables
book_df <- book_df %>%
  left_join(book_case) %>%
  mutate(max_booktype = book_type[hierarchy == min(hierarchy)][1])
```

  Jail Diagnostics
```{r}
# charges
# 97.50896%
(1 - nrow(book_df %>% filter(is.na(hierarchy))) / nrow(book_df)) * 100

book_df %>%
  filter(is.na(hierarchy)) %>%
  count(join_var) %>%
  arrange(desc(n))

charge_hier %>%
  filter(grepl(849, join_var))

book_df %>%
  filter(grepl("849B", join_var)) %>%
  count(arrest_charge_level_original, arrest_charge_original)

# collapse
book_df %>%
  # distinct(book_num, book_date) %>%
  arrange(book_num) %>%
  group_by(book_num) %>%
  add_count() %>%
  filter(n > 1)

book_df %>%
  distinct(book_num, book_date) 

book_df %>%
  distinct(book_num)

book_df %>%
  distinct(court_case_id, book_num)
```

Court Data
```{r}
# Court Case Data Import--- Ventura, 1956-03-05 to 2020-07-23
  ## court_df contains one row per related court case and local ID and contains information on the person as well as the file date. The primary key variables are court_case_id and local_id.
  ## court_charge contains one row per related court case, local ID, count, and special allegation sequence and contains information on the charge and disposition of each court case. The primary key variables are court_case_id, local_id, count, and spec_alleg_seq. count and spec_alleg_seq are not in the JCC data elements list. However, Jag included them in the data to join court_plea and court_sent. Join with court_df by court_case_id and local_id.
  ## court_sent contains one row per related court case, local ID, sentence sequence, count, and special allegation sequence and contains information on each sentence. It has no primary key variables because there can be multiple sentences of the same type on the same counts on the same day. They internally have a sequence number as part of the primary key (e.g. There could be multiple restitution sentences ordered on same day on same count). Sentencing can be case level or count level. For example, a probation sentence is usually case level, which means even though there are probation sentence records for each convicted count, it is actually one probation sentence for the case. Where as state prison sentence is usually at count level, so each record is a separate sentence. Join court_charge by court_case_id, local_id, count, spec_alleg_seq.
  ## court_hearing contains one row per related court case, local ID, hearing date, and hearing type and contains information on each hearing. The primary key variables are court_case_id, local_id, hearing_date_time, and hearing_type. Join court_df by court_case_id and local_id.
  ## court_fta contains one row per FTA event. The primary key variables are court_case_id, local_id, and fta_date. Join court_df by court_case_id and local_id.
  ## court_fta_war contains one row per FTA event with a bench warrant issued. The primary key variables are court_case_id, local_id, and fta_warrant_date. Join court_df by court_case_id and local_id.
  ## court_plea contains one row per related court case, local ID, count, special allegation sequence, plea type, and plea date and contains information on each plea. The primary key variables are court_case_id, local_id, count, and spec_alleg_seq. count and spec_alleg_seq are not in the JCC data elements list. However, Jag included them in the data to join court_plea and court_sent. Join court_charge by court_case_id, local_id, count, and spec_alleg_seq.
  ## court_ra contains one row per risk assessment event. The primary key variables are court_case_id, local_id, ra_date. Join court_df by court_case_id and local_id.

####

# Court Cases
  ## court_df contains one row per related court case and local ID and contains information on the person as well as the file date.
court_df <- read.csv("Historical Data Submissions/Ventura/P2 Submission-June 30/ventura_court_cases.csv", fileEncoding = "UTF-16", colClasses = "character")

court_df <- court_df %>%
  # secondary_identification is the same as local_id.
  select(-secondary_identification)

# Variable name standardization--See pg. xxx for more details.
names(court_df) <- c("court_case_id", "hearing_fta_flag", "fta_warrant_flag", "disposition_final_date", "cii", "fbi", "local_id", "cdl_id", "name", "dob", "sex_original", "race_original", "filing_date", "case_status_original", "case_status_date")

# Date Reformatting--See pg. xxx for more details.
court_df <- court_df %>%
  mutate_at(vars(contains("date"), "dob"), mdy)

# Standardize Factors--See pg. xxx for more details.--See pg. xxx for more details.
court_df <- court_df %>%
  mutate(race = case_when(
    race_original %in% c("Hispanic/Latin/Mexican") ~ "Hispanic",
    race_original %in% c("Black") ~ "Black",
    race_original %in% c("White") ~ "White",
    T ~ "Other_Unknown"
  ),
  sex = sex_original,
  case_status = case_when(
    case_status_original %in% c("Open", "Open - Civil Assessment") ~ "Active",
    case_status_original %in% c("Closed", "Closed-Not Filed", "Closed-Prefile Diversion") ~ "Inactive",
    T ~ "Other"
  ))

# Flag Adds--See pg. xxx for more details.
court_df <- court_df %>%
  mutate(fta_flag = fta_warrant_flag,
         fta_all_flag = hearing_fta_flag) %>%
  rename_at(vars(contains("_flag")), funs(paste0("court_", .)))

####

# Court Filing Charges
  ## court_charge contains one row per related court case, local ID, count, and special allegation sequence and contains information on the charge and disposition of each court case.
court_charge <- read.csv("Historical Data Submissions/Ventura/P2 Submission-June 30/ventura_court_charges.csv", fileEncoding = "UTF-16", colClasses = "character")

# Variable name standardization--See pg. xxx for more details.
names(court_charge) <- c("court_case_id", "local_id", "count", "spec_alleg_seq", "court_charge_original", "court_charge_level_original", "charge_description", "disposition_type_original", "disposition_date")

# Date Reformatting--See pg. xxx for more details.
court_charge <- court_charge %>%
  mutate(disposition_date = mdy(disposition_date))

# Standardize Factors--See pg. xxx for more details.--See pg. xxx for more details.
court_charge <- court_charge %>%
  mutate(disposition_type = case_when(
    disposition_type_original %in% c("Dismissed Abated Case", "Dismissed Expunged", "Discharged", "Dismissed - Proof of Correction", "Dismissed,", "Dismissed 236.14 PC", "Dism", "Di", "Dismi", "D", "Dis", "Dismisse", "Dismissed 41500 VC", "DA Deleted", "Dism Exp 1000.3 PC", "Dism Exp 1203.41 PC", "Dismis", "Dismissed Abated,", "Dismissed DEJ", "Dismissed Expunged,") ~ "Dismissed",
    disposition_type_original %in% c("Rejected") ~ "Dropped",
    disposition_type_original %in% c("Nolo contendre") ~ "Nolo_Contendere",
    disposition_type_original %in% c("Pled guilty", "Found guilty by court", "Found guilty by Jury", "Convicted", "Found guilty by c", "TVS - Conviction", "Pl", "Pled", "Pled guilt", "Been Found Guilty") ~ "Guilty",
    disposition_type_original %in% c("Found not guilty by Jury", "Found not guilty by Court", "Found not guilty (insanity) by Court") ~ "Not_Guilty",
    T ~ "Other"
  ))

# Charge Standardization and Flag Adds--See pg. xxx for more details.
court_charge <- court_charge %>%
  mutate(attempt_flag = if_else(grepl("664/", court_charge_original), 1, 0),
         court_charge_code = str_extract(court_charge_original, "^[A-Z]*"),
         court_charge_code = if_else(!court_charge_code %in% c("PC", "VC", "HS", "BP", "WI", "US"), "Other", court_charge_code),
         court_charge = gsub("664/", "", court_charge_original),
         court_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}|EX|\\+|\\-| M$| F$", "", trimws(court_charge))),
         court_charge_level = if_else(!court_charge_level_original %in% c("F", "M", "I"), "Other", court_charge_level_original)) %>%
  unite(join_var, court_charge_level, court_charge_code, court_charge, remove = F) %>%
  distinct()

load("Complete Charge Code Hierarchy.RData")

court_charge <- court_charge %>%
  left_join(charge_hier)

####

# Court Sentences to Confinement
  ## court_sent contains one row per related court case, local ID, sentence sequence, count, and special allegation sequence and contains information on each sentence.
court_sent <- read.csv("Historical Data Submissions/Ventura/P2 Submission-June 30/ventura_court_sentences.csv", fileEncoding = "UTF-16", colClasses = "character")

# Variable name standardization--See pg. xxx for more details.
names(court_sent) <- c("court_case_id", "local_id", "sent_seq", "count", "spec_alleg_seq", "sentence_type_original", "sentence_date", "sentence_loc", "sentence_term")

# Date Reformatting--See pg. xxx for more details.
court_sent <- court_sent %>%
  mutate(sentence_date = mdy(sentence_date))

# Standardize Factors--See pg. xxx for more details.--See pg. xxx for more details.
court_sent <- court_sent %>%
  mutate(sentence_type = case_when(
    sentence_type_original %in% c("State Prison") ~ "Prison",
    sentence_type_original %in% c("Jail") ~ "Jail",
    sentence_type_original %in% c("Probation") ~ "Probation",
    T ~ "Other"
  ))

####

# Court Hearings
  ## court_hearing contains one row per related court case, local ID, hearing date, and hearing type and contains information on each hearing.
court_hearing <- read.csv("Historical Data Submissions/Ventura/P2 Submission-June 30/ventura_court_hearings.csv", fileEncoding = "UTF-16", colClasses = "character")

# Variable name standardization--See pg. xxx for more details.
names(court_hearing) <- c("court_case_id", "local_id", "hearing_date", "hearing_type_original")

# Date Reformatting--See pg. xxx for more details.
court_hearing <- court_hearing %>%
  mutate(hearing_date = mdy(hearing_date))

# Standardize Factors--See pg. xxx for more details.--See pg. xxx for more details.
court_hearing <- court_hearing %>%
  mutate(hearing_type = case_when(
    grepl("Arraignment|Appearance", hearing_type_original, ignore.case = T) ~ "Arraignment",
    grepl("Sentencing|Disposition", hearing_type_original, ignore.case = T) ~ "Sentencing",
    T ~ "Other"
  )) %>%
  distinct()

####

# Court FTAs
  ## court_fta contains one row per FTA event.
court_fta <- read.csv("Historical Data Submissions/Ventura/P2 Submission-June 30/ventura_court_ftas.csv", fileEncoding = "UTF-16", colClasses = "character")

# Variable name standardization--See pg. xxx for more details.
names(court_fta) <- c("court_case_id", "local_id", "fta_date")

# Date Reformatting--See pg. xxx for more details.
court_fta <- court_fta %>%
  mutate(fta_date = mdy(fta_date))

####

# Court FTAs with Warrants
  ## court_fta_war contains one row per FTA event with a bench warrant issued.
court_fta_war <- read.csv("Historical Data Submissions/Ventura/P2 Submission-June 30/ventura_court_bw_dates.csv", fileEncoding = "UTF-16", colClasses = "character")

# Variable name standardization--See pg. xxx for more details.
names(court_fta_war) <- c("court_case_id", "local_id", "fta_warrant_date")

# Date Reformatting--See pg. xxx for more details.
court_fta_war <- court_fta_war %>%
  mutate(fta_warrant_date = mdy(fta_warrant_date))

####

# Court Pleas
  ## court_plea contains one row per related court case, local ID, count, special allegation sequence, plea type, and plea date and contains information on each plea.
court_plea <- read.csv("Historical Data Submissions/Ventura/P2 Submission-June 30/ventura_court_pleas.csv", fileEncoding = "UTF-16", colClasses = "character")

# Variable name standardization--See pg. xxx for more details.
names(court_plea) <- c("court_case_id", "local_id", "count", "spec_alleg_seq", "plea_type_original", "plea_date")

# Date Reformatting--See pg. xxx for more details.
court_plea <- court_plea %>%
  mutate(plea_date = mdy(plea_date))

# Standardize Factors--See pg. xxx for more details.--See pg. xxx for more details.
court_plea <- court_plea %>%
  mutate(plea_type = case_when(
    plea_type_original %in% c("Nolo Contendere", "Nolo Con", "Nolo Contendere - Set Aside") ~ "Nolo_Contendere",
    plea_type_original %in% c("Guilty - Set Aside", "Admitted", "Guilty - Set Aside,", "Guilty,") ~ "Guilty",
    plea_type_original %in% c("Not Guilty", "Not Guilty - By Reason of Insanity", "Not,", "Not Guil", "N", "Not", "Not Guilt", "Not Guilty - By Re", "Not Guilty Withdrawn", "Not Guilty,") ~ "Not_Guilty",
    T ~ "Other"
  ))

####

# Court Risk Assessments
  ## court_ra contains one row per risk assessment event.
court_ra <- read.csv("Historical Data Submissions/Ventura/P2 Submission-June 30/ventura_court_risk_assessment.csv", fileEncoding = "UTF-16", colClasses = "character")

# Variable name standardization--See pg. xxx for more details.
names(court_ra) <- c("court_case_id", "local_id", "assessment_date")

# Date Reformatting--See pg. xxx for more details.
court_ra <- court_ra %>%
  mutate(assessment_date = mdy(assessment_date))
```

  Court Collapse
```{r}
# Court Charge Collapse--See pg. xxx for more details about this process.
court_dispo <- court_charge %>%
  mutate(disposition_type = ordered(disposition_type, levels = c("Other", "Dismissed", "Not_Guilty", "Nolo_Contendere", "Guilty"))) %>%
  group_by(court_case_id) %>%
  # Charges that have not been disposed of are removed
  # filter(stage %in% c("DISPOSITION EVENT")) %>%
  # select(-c(disposition_num, charge_id, charge_history_id, offense_id, disposition_hist_id, disposition_id, disposition_type_code, amend_reason_id, amend_reason)) %>%
  mutate(hierarchy = if_else(is.na(hierarchy), 1e6, as.numeric(hierarchy))) %>%
  group_by(court_case_id) %>%
  mutate(disposition_date = max(disposition_date),
         disposition_type = max(disposition_type)) %>%
  mutate(max_court_charge_level = court_charge_level[hierarchy == min(hierarchy)][1],
         max_court_charge_code = court_charge_code[hierarchy == min(hierarchy)][1],
         max_court_charge = court_charge[hierarchy == min(hierarchy)][1],
         max_charge_description = master_charge_description[hierarchy == min(hierarchy)][1],
         max_hier = min(hierarchy)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, .))) %>%
  mutate_at(vars(contains("flag")), funs("count" = sum(.))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  filter(hierarchy == min(hierarchy)) %>%
  ungroup() %>%
  distinct(court_case_id, .keep_all = T) %>%
  select(court_case_id, contains("charge"), contains("disposition"))

# Court Ftas are not separate from warrants
court_fta_war <- court_fta_war %>%
  arrange(fta_warrant_date) %>%
  group_by(court_case_id) %>%
  mutate(court_fta_flag = 1,
         fta_flag_count = sum(court_fta_flag)) %>%
  distinct(court_case_id, .keep_all = T) %>%
  select(contains("fta"))

court_hearing <- court_hearing %>%
  filter(hearing_type == "Arraignment") %>%
  arrange(hearing_date) %>%
  rename(arraignment_date = hearing_date) %>%
  distinct(court_case_id, .keep_all = T) %>%
  select(court_case_id, arraignment_date)

court_plea <- court_plea %>%
  arrange(plea_date) %>%
  mutate(guilty_flag = if_else(plea_type == "Guilty", 1, 0)) %>%
  group_by(court_case_id) %>%
  filter(guilty_flag == 1|sum(guilty_flag) == 0) %>%
  ungroup() %>%
  distinct(court_case_id, .keep_all = T) %>%
  select(court_case_id, plea_date, plea_type)

court_sent <- court_sent %>%
  arrange(sentence_date) %>%
  distinct(court_case_id, .keep_all = T) %>%
  select(court_case_id, sentence_date, sentence_type_original, sentence_type)

court_df2 <- reduce(list(court_df, court_dispo, court_fta_war, court_hearing, court_plea, court_sent), left_join, by = "court_case_id") %>%
  select(-contains(".x.x"), -contains(".y")) %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x", "", .))) %>%
  mutate(final_disposition_date = if_else(disposition_date <= sentence_date|is.na(sentence_date), disposition_date, sentence_date),
         # conviction_flag = if_else(!is.na(sentence_date), 1, 0))
         conviction_flag = if_else(disposition_type %in% c("Guilty","Nolo_Contendere"), 1, 0))
```

  Court Diagnostics
```{r}
# charges
# 97.92066%
(1 - nrow(court_charge %>% filter(is.na(hierarchy))) / nrow(court_charge)) * 100

court_charge %>%
  filter(is.na(hierarchy)) %>%
  count(join_var) %>%
  arrange(desc(n))

charge_hier %>%
  filter(grepl(849, join_var))

court_charge %>%
  filter(grepl("849B", join_var)) %>%
  count(court_charge_original)
```

Probation (assessment)--Confusing Data. Figure out later. 
```{r}
prob_df <- read_excel("Historical Data Submissions/Ventura/Pretrial Supervision - VCPA.xlsx") %>%
  mutate(pretrial_violation_excel_date = convertToDate(`Unsucc- PT Violation`),
         pretrial_violation = case_when(
           grepl("[0-9]/", `Unsucc- PT Violation`) ~ sub(".*?-|.*?,|.*? ", "", `Unsucc- PT Violation`),
           !is.na(pretrial_violation_excel_date) ~ NA_character_,
           T ~ `Unsucc- PT Violation`
         ),
         `Unsucc- PT Violation` = case_when(
           grepl("[0-9]/", `Unsucc- PT Violation`) ~ mdy(sub("-.*|,.*| .*", "", `Unsucc- PT Violation`)),
           !is.na(pretrial_violation_excel_date) ~ pretrial_violation_excel_date
         )) %>%
  select(-pretrial_violation_excel_date)

prob_df_p1 <- lapply(1:6, function(i) {
  if (i == 1)
    read_excel("Historical Data Submissions/Ventura/Pretrial Data - VCPA.xlsx", sheet = i, skip = 1)
  else
    read_excel("Historical Data Submissions/Ventura/Pretrial Data - VCPA.xlsx", sheet = i)
})

prob_df_p1 <- prob_df_p1[c(1, 3:6)] %>%
  reduce(left_join) %>%
  left_join(prob_df_p1[[2]], by = c("ScreeningID", "Local_ID")) %>%
  rename_at(vars(Termination_Outcome, CDL_ID, Sex, Race, Violation, `Date Violation`), funs(c("Outcome", "DLN", "Gender", "Ethnicity", "pretrial_violation", "Unsucc- PT Violation"))) %>%
  mutate(`Unsucc- PT Violation` = as_date(`Unsucc- PT Violation`))

prob_df <- prob_df %>%
  bind_rows(prob_df_p1) %>%
  distinct()

rm(prob_df_p1)

# Variable name standardization--See pg. xxx for more details.
names(prob_df) <- c("person_id", "court_case_id", "name", "dob", "sex_original", "race_original", "cii", "fbi", "cdl_id", "date", "dv", "pretrial_recommendation", "pretrial_screening_flag", "pat_flag", "release_decision_original", "success_date", "fta_date", "assessment_arrest_date", "offense_type", "assessment_charge_level", "pretrial_violation_date", "pretrial_termination_outcome", "outcome_type", "pretrial_time_spent", "pretrial_violation", "tool_name_original", "screening_id", "assessment_date", "zip_code", "risk_score_original", "release_recommendation_original", "release_authorization_original", "release_type_original", "release_date_time", "court_date_reminder", "pretrial_termination_date", "local_id", "release_conditions", "pretrial_service_original", "assessment_id", "question_id", "question", "answer", "response_score")

# Date Reformatting--See pg. xxx for more details.
prob_df <- prob_df %>%
  mutate_at(vars(dob, success_date, fta_date, assessment_date, release_date_time, pretrial_termination_date), as_date) %>%
  mutate(assessment_arrest_excel_date = convertToDate(assessment_arrest_date),
         assessment_charge = case_when(
           grepl("[0-9]/", assessment_arrest_date) ~ sub(".*?-|.*?,|.*? ", "", assessment_arrest_date),
           !is.na(assessment_arrest_excel_date) ~ NA_character_,
           T ~ assessment_arrest_date
         ),
         assessment_arrest_date = case_when(
           grepl("8-3.06", assessment_arrest_date) ~ mdy("8/3/06"),
           grepl("02/16/19", assessment_arrest_date) ~ mdy("02/16/19"),
           grepl("[0-9]/", assessment_arrest_date) ~ mdy(sub("-.*|,.*| .*", "", assessment_arrest_date)),
           !is.na(assessment_arrest_excel_date) ~ assessment_arrest_excel_date
         )) %>%
  select(-assessment_arrest_excel_date)

# Standardize Factors--See pg. xxx for more details.
prob_df <- prob_df %>%
  mutate(race = case_when(
    race_original %in% c("Hispanic/Latin/Mexican") ~ "Hispanic",
    race_original %in% c("Black") ~ "Black",
    race_original %in% c("White") ~ "White",
    T ~ "Other_Unknown"
  ),
  sex = case_when(
    sex_original %in% c("F") ~ "Female",
    sex_original %in% c("M") ~ "Male",
    T ~ "Other_Unknown"
  ),
  release_type = case_when(
    release_type_original %in% c("OR w/ no PTM") ~ "OR",
    release_type_original %in% c("Detained") ~ "No_Release",
    release_type_original %in% c("OR WITH PTM") ~ "OR_Conditions",
    T ~ "Other"
  ),
  tool_name = "ORAS",
  risk_score = as.numeric(risk_score_original),
  release_recommendation = case_when(
    release_recommendation_original %in% c("OR w/ no PTM") ~ "OR",
    release_recommendation_original %in% c("Detained") ~ "No_Release",
    release_recommendation_original %in% c("OR WITH PTM") ~ "Monitor",
    T ~ "Other"
  ),
  release_decision = case_when(
    release_decision_original %in% c("OR no Sup") ~ "OR",
    release_decision_original %in% c("Detained", "detained") ~ "No_Release",
    release_decision_original %in% c("OR with PT Sup", "OR with PT SUP") ~ "Monitor",
    T ~ "Other"
  ),
  pretrial_service = if_else(is.na(pretrial_service_original), "None", "Other"),
  release_authorization = release_authorization_original)

# Flag Adds--See pg. xxx for more details.
prob_df <- prob_df %>%
  mutate(fta_all_flag = if_else(!is.na(fta_date), 1, 0),
         sup_pre_flag = if_else(release_type == "OR_Conditions", 1, 0),
         sup_vio_pre_flag = if_else(!is.na(pretrial_violation), 1, 0))
```

  Assessment Collapse
```{r}
assess_df <- prob_df %>%
  filter(!is.na(risk_score)) %>%
  mutate(court_case_id = as.character(court_case_id)) %>%
  distinct(court_case_id, assessment_date, .keep_all = T) %>%
  select(court_case_id, cii, fbi, cdl_id, local_id, name, dob, sex_original, race_original, sex, race, zip_code, tool_name, assessment_date, risk_score, release_recommendation_original, release_decision_original, release_recommendation, release_decision, release_conditions)
```

Join
```{r}
#Jail Court ID is duplicated when split between cases
book_df <- book_df %>% distinct(court_case_id, .keep_all = T)

#Jail Court ID is duplicated when split between cases
court_df <- court_df %>% distinct(court_case_id, .keep_all = T)

book_no_court <- anti_join(book_df, court_df, by = c("court_case_id"))
nrow(book_df)
nrow(book_no_court)
nrow(book_no_court)/nrow(book_df)

court_no_book <- anti_join(court_df, book_df, by = c("court_case_id"))
nrow(court_df)
nrow(court_no_book)
nrow(court_no_book)/nrow(court_df)

assess_no_book <- anti_join(assess_df, book_df, by = c("court_case_id"))
nrow(assess_df)
nrow(assess_no_book)
nrow(assess_no_book)/nrow(assess_df)
```

Code Book
```{r eval=FALSE, include=FALSE}
rm(original_field)

original_df <- bind_rows(original_df)

Ventura_df <- lapply(ls()[!grepl("original", ls())], function(i){
  df <- get(i)
  
  if(sum(grepl("date", names(df))) > 0){
  df2 <- df %>%
  select(contains("date"), -contains("time")) %>%
  gather("modified_field", "value") %>%
  group_by(modified_field) %>%
  summarise_all(funs(min = as.character(min(., na.rm = T)), mean = as.character(mean(., na.rm = T)), max = as.character(max(., na.rm = T))))
  }else{
    df2 <- tibble(modified_field = NA_character_, min = NA_character_, mean = NA_character_, max = NA_character_)
  }
  
  df <- df %>%
    mutate_if(~length(unique(.)) > 50|is.Date(.)|is.POSIXct(.), ~(. = "not_factor")) %>%    
    mutate_all(~if_else(is.na(.), "na_missing", as.character(.))) %>%
    gather(modified_field, factor_value) %>%
    count(modified_field, factor_value) %>%
    mutate(table_name = i, county = "Ventura") %>%
    mutate(factor_flag = if_else(factor_value == "not_factor", 0, 1)) %>%
    group_by(table_name, modified_field) %>%
    mutate(table_count = sum(n)) %>%
    ungroup() %>%
    rename("factor_count" = "n") %>%
    mutate(factor_count = if_else(factor_value == "not_factor", NA_integer_, factor_count),
           factor_percent = round(factor_count/table_count*100, 1)) %>%
    arrange(desc(factor_flag), modified_field, desc(factor_count))
  
  df <- left_join(df, df2, by = "modified_field")
    }) %>% 
  bind_rows() %>%
  left_join(original_df) %>%
   select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_count,
           factor_percent, table_count, min, mean, max) 

write.xlsx(Ventura_df, file = "Code Books/Ventura Code Book.xlsx")
```

DOJ CII/Linking Extraction
```{r}
# Grab Tables with CII
df <- sapply(ls()[which(sapply(ls(), function(i){
  sum(names(get(i)) %in% "cii")
}) == 1)], get)

# Pull CII and other identifiers
doj_book <- df[[1]] %>%
  select(cii, fbi, pfn_x, first_name, last_name, dob, cld_id, cdl_state, race_original, sex_original, local_id) %>%
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) %>%
  distinct()


doj_court <- df[[2]] %>%
  select(cii, fbi, cld_id, cdl_state, dob, race_original, sex_original, first_name, last_name, local_id, pfn_x) %>%
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) %>%
  distinct()

# Examine missing ciis and duplicates on cii. 
doj_book %>% #Off by about 55,000
  distinct()

doj_book %>% 
  distinct(cii)

doj_book %>% 
  distinct() %>%
  add_count(cii) %>%
  filter(n > 1) %>%
  arrange(desc(n)) %>% 
  View()

doj_court %>% #Off by about 45,000
  distinct()

doj_court %>% 
  distinct(cii)

doj_court %>% 
  distinct() %>%
  add_count(cii) %>%
  filter(n > 1) %>%
  arrange(desc(n)) %>% 
  View()

#In this case, it is clear that the local ID is not a true person identifier but rather an event identifier and so should be removed.

doj_book <- doj_book %>% select(-local_id)
doj_court <- doj_court %>% select(-local_id)

doj_book %>% # Off by about 7,000
  distinct()

doj_book %>% 
  distinct(cii)

doj_book %>% 
  distinct() %>%
  add_count(cii) %>%
  filter(n > 1) %>%
  arrange(desc(n)) %>% 
  View()

doj_court %>% #Off by about 9,000
  distinct()

doj_court %>% 
  distinct(cii)

doj_court %>% 
  distinct() %>%
  add_count(cii) %>%
  filter(n > 1) %>%
  arrange(desc(n)) %>% 
  View()

#CIIs for DOJ
doj_cii <- bind_rows(doj_book %>% select(cii), doj_court %>% select(cii)) %>% distinct()

doj_cii <- doj_cii %>% 
  mutate(row = as.character(row_number() + 1e11)) %>%
  mutate(cii = paste(row, cii, sep = "|")) %>%
  select(cii)

#Create an excel workbook with all data table. Make sure to include the cii table first. 
write.xlsx(list(doj_cii, doj_book, doj_court), file = "CIIs for DOJ/Ventura CIIs and Demographics for DOJ.xlsx", sheetName = c("ciis", "booking", "court"))
```

Completion
```{r}
files <- list.files("G:/CrimJustice/PretrialAssessmentPilot/Code Books/Code Book Notes", pattern = "Ventura", full.names = T)

df <- lapply(files, read_excel)

df[[3]] <- full_join(df[[1]], df[[2]]) %>%
  mutate(factor_standard = "") %>%
  select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_standard, factor_count, factor_percent, table_count, "jw_notes" = Notes, "nl_notes" = notes, min, mean, max)

df <- list(df[[3]], df[[1]], df[[2]])

write.xlsx(df, file = "G:/CrimJustice/PretrialAssessmentPilot/Code Books/Variable Construction/Ventura Factor Construction.xlsx", asTable = T, tableStyle = "TableStyleMedium1", sheetName = c("Variable Construction", "jw_notes", "nl_notes"))
```

Factor Code Book
```{r}
factor_df <- lapply(ls()[!grepl("original|^df|hier", ls())], function(i){
  df <- get(i)
  if(sum(grepl("original", names(df))) == 0){
    return(NULL)
  }else{
    var_names <- names(df)[grepl("original", names(df))]
    var_names2 <- c(gsub("_original", "", var_names))
   
    df1 <- df %>%
     select(var_names) %>%
     gather(original_field, original_value)
   
    df2 <- df %>%
     select(var_names2) %>%
     gather(modified_field, modified_value)
   
   df <- bind_cols(df1, df2) %>%
     count(original_field, modified_field, original_value, modified_value) %>%
     arrange(modified_field, desc(n)) %>%
     group_by(modified_field) %>%
     mutate(row = row_number(),
            percent = round(n/sum(n)*100)) %>%
     ungroup() %>%
     filter(row <= 50) %>%
     select(-row) %>%
     rename("total" = n)
   }
  }) %>%
  bind_rows()

write.xlsx(factor_df, file = "G:/CrimJustice/PretrialAssessmentPilot/Code Books/Factor Code Book/Ventura Factor Code Book.xlsx", asTable = T, tableStyle = "TableStyleMedium1", colWidths = "auto")
```

New Program Special Factor Code Book
```{r}
df <- prob_df %>%
  filter(!is.na(risk_score)) %>%
  select_if(~ !all(is.na(.)))

var_names <- names(df)[grepl("original", names(df))]
var_names2 <- c(gsub("_original", "", var_names))
   
df1 <- df %>%
  select(var_names) %>%
  gather(original_field, original_value)

df2 <- df %>%
   select(var_names2) %>%
   gather(modified_field, modified_value)

df <- bind_cols(df1, df2) %>%
   count(original_field, modified_field, original_value, modified_value) %>%
   arrange(modified_field, desc(n)) %>%
   group_by(modified_field) %>%
   mutate(row = row_number(),
          percent = round(n/sum(n)*100)) %>%
   ungroup() %>%
   filter(row <= 50) %>%
   select(-row) %>%
   rename("total" = n)

write.xlsx(df, file = "G:/CrimJustice/PretrialAssessmentPilot/Code Books/Factor Code Book/Ventura Probation Only Factor Code Book.xlsx", asTable = T, tableStyle = "TableStyleMedium1", colWidths = "auto")
```

# Ventura (Redo)

Probation Data
```{r}
prob_df <- lapply(1:6, function(i) {
  read_xlsx("Historical Data Submissions/Ventura/P2 Submission-June 30/Pretrial 2020Q2 Data Report - VCPA.xlsx", sheet = i, col_types = "text")
})

prob_df1 <- prob_df[[1]] %>%
  select(-Exceptions)

names(prob_df1) <- prob_df1[1, ]

prob_df1 <- prob_df1 %>%
  slice(-c(1:2))
```