---
title: "County Data Loading"
author: "Noah Lehman"
date: "10/15/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Libraries
```{r}
library(data.table)
library(openxlsx)
library(readxl)
library(lubridate)
library(tidyverse)
library(fuzzyjoin)
```


# Nevada-Sierra

Jail Data Nevada
```{r eval=FALSE, include=FALSE}
#Jail Bookings Data Import--Nevada Jail Data
 ## book_df contains booking data that is arranged by booking number, there are multiple lines for each booking number one line for each charge
 ## Sierra county uses Nevada's jail, so there is a county name in the data for the origin of the arrest


#Jail Bookings Data Import--Nevada Jail Data book dates from 1/1/2015 to 1/3/2021
  ##this is a cumulative file with all data from 1/1/2015 to 1/3/2021
  ##they fixed it so it has the codes (PC, VC, HS)
  ##they also added a charge description. 
  ##Sierra does not have a jail so this includes Sierra bookings


#reading in new P3 data

book_df <- read_excel("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Nevada/P3 Submission-Jan 15/Pretrial Data Through December 2020.xlsx",
                      col_types = c("text", rep("guess", 10), "date", rep("guess", 8)), na = "NULL") %>%
  distinct()


# Variable name standardization--See pg. xxx for more details
names(book_df) <- c("cii", "name", "dob", "arrest_date_time", "book_num", "book_date_time", "book_type_original", "court_case_id", "arrest_charge_original", "charge_description", "arrest_charge_level_original", "release_date_time", "release_type_original", "fbi", "cdl_id", "sex_original", "race_original", "bail_amt", "employment_status", "county")


# Date Reformatting (as well as court_case_id)--See pg. xxx for more details.
 
book_df <- book_df %>%
  mutate(dob = as_date(dob),
         arrest_date = as_date(arrest_date_time),
         book_date = as_date(book_date_time),
         release_date = as_date(release_date_time),
         arrest_date_time = as_datetime(arrest_date_time),
         book_date_time = as_datetime(book_date_time),
         release_date_time = as_datetime(release_date_time)) %>%
  mutate(court_case_id = as.character(court_case_id))


# Standardize Factors
book_df <- book_df %>%
  mutate(sex = case_when(sex_original %in% c("M") ~ "Male",
                         sex_original %in% c("F") ~ "Female",
                         sex_original %in% c("U") |
                           is.na(sex_original) ~ "Other_Unknown"),
         
         race = case_when(race_original %in% c("B") ~ "Black",
                          race_original %in% c("H") ~ "Hispanic",
                          race_original %in% c("W") ~ "White",
                          T ~ "Other_Unknown"), 

         book_type = case_when(book_type_original %in% c("STANDARD NEW CHARGES", "STANDARD") ~ "On_View",
                               book_type_original %in% c("COURT COMMIT") ~ "Commitment",
                               book_type_original %in% c("COURTESY" ) ~ "Hold",
                               book_type_original %in% c("COURT BOOK AND RELEA", "CONTRACT" ) ~ "Other"),
         release_type = case_when(release_type_original %in% c("CITE") ~ "Cite_Release",
                                  release_type_original %in% c("CTS") ~ "Time_Served",
                                  release_type_original %in% c("BAIL BOND", "CASH BAIL") ~ "Bail_Bond",
                                  release_type_original %in% c("CASE DISMISSED", "849.5 PC", 
                                                               "48 HR", "825 PC") ~ "Dismissed_Dropped",
                                  release_type_original %in% c("OR") ~ "OR",
                                  release_type_original %in% c("COR", "CD", "JUDGE") ~ "Court_Order",
                                  release_type_original %in% c("SCOR") ~"Pretrial_Sup", 
                                  release_type_original %in% c("BK AND RELEASE") ~"Administrative",
                                  release_type_original %in% c("849 PC", "849(B) PC") ~"Detain_Only",
                                  release_type_original %in% c("TSP") ~ "Prison",
                                  release_type_original %in% c("ICE", "USMS") ~ "Fed",
                                  release_type_original %in% c("") ~ "Unknown",
                                  release_type_original %in% c("AG") ~ "Hold_Released", T ~ "Other"))

           

# Standardize Charges and join charge hierarchy--See pg. xxx for more details about this process. 
  ## also standardize names and CIIs
  ##this name fix is not perfect it misses last names that are spelled with a space in them  fix later
  
book_df <- book_df %>%
  mutate(arrest_charge_code = str_extract(arrest_charge_original, "([A-Z]){2}$"),
         arrest_charge_code = if_else(!arrest_charge_code %in% c("PC", "VC", "HS", "BP", "WI", "US"), "Other", arrest_charge_code))%>%
  mutate(arrest_charge = gsub(" ..", "", arrest_charge_original)) %>%
        
  mutate(name = toupper(name)) %>% 
  mutate(name = (gsub(" -| - |- ", "-", name))) %>%
  separate(name, c("first_name", "last_name", "middle_name", "suffix"),  sep = " ") %>%
  mutate_at(vars(first_name, last_name, middle_name), trimws) %>%
  mutate(attempt = if_else(grepl("^664\\/", arrest_charge_original), 1, 0)) %>%
  separate_rows(arrest_charge_original, sep = "\\\\|\\/") %>%
  mutate(arrest_charge_level = case_when(arrest_charge_level_original %in% c("M", "MI") ~ "M",
                                         arrest_charge_level_original %in% c("F", "FE") ~ "F",
                                         arrest_charge_level_original %in% c("I") ~ "I",
                                         T ~ "Other"),
         arrest_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}","", arrest_charge))) %>%
 unite(join_var, arrest_charge_level, arrest_charge_code, arrest_charge, remove = F) 




#Flag Construction
  ##not seeing any qualifier charges here  arrest_qualifier_flag=if_else()
book_df<- book_df %>%
    mutate(arrest_misd_flag=if_else(arrest_charge_level=="M", 1, 0),
           arrest_felony_flag =if_else(arrest_charge_level=="F", 1, 0),
           attempt_flag=if_else(attempt=="1", 1, 0)) 
           
# Code for Charge Hierarchy
  ## the new data corrects for the problem cited below
  ## county data has no charge code data, so we had to make join_var2 for the join with the hierarchy/this is corrected 
  ## ordering charge_code so that we join using join_var2 we select only one and get a PC or HS preferentially if there is 


load("G:/CrimJustice/PretrialAssessmentPilot/Complete Charge Code Hierarchy.RData")

# charge_hier<-charge_hier%>%
#     mutate(charge_code = ordered(charge_code, levels = c("Other", "BP", "HS", "PC", "US", "VC", "WI"))) %>%
#     arrange(desc(charge_code)) %>%
#     unite(join_var, charge_level, charge_code, charge, remove = F) %>%
#     distinct(join_var, .keep_all = T)


book_df <- left_join(book_df, charge_hier, by = "join_var")
```

Jail Collapse
```{r eval=FALSE, include=FALSE}
# Nevada Jail Collapse
  ## if court_case_id is NA when we collapse on court_case_id and book_num we keep both NA lines and actual court_case_id lines 
book_df <- book_df %>%
  mutate(time_first_release = release_date_time - book_date_time) %>%
  mutate(hierarchy = if_else(is.na(hierarchy), 1e6, as.numeric(hierarchy))) %>%
  group_by(book_num, court_case_id) %>%
  # this was redundant becasue we are selecting the highest charge by selecting the min heir
  # mutate(max_booktype = book_type[hierarchy == min(hierarchy)][1],
  #       max_arrest_charge = arrest_charge[hierarchy == min(hierarchy)][1],
  #        max_charge_description = master_charge_description[hierarchy == min(hierarchy)][1],
  #        max_hier = min(hierarchy)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, .))) %>%
  mutate_at(vars(contains("flag")), funs("count" = sum(.))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  mutate(join_var = paste(join_var, collapse = " ")) %>%
  filter(hierarchy == min(hierarchy)) %>%
  ungroup() %>%
  distinct(book_num, court_case_id, .keep_all = T) 

save(book_df, file = "G:/CrimJustice/PretrialAssessmentPilot/Agency Collapse CSV Files/Nevada Booking Collapse.RData")
```

Jail Diagnostics
```{r eval=FALSE, include=FALSE}
# Nevada Jail Diagnostics

 ##
lapply(book_df, function(i){
  if(is.character(i) == T) {
    sum(is.na(i)|i =="NULL")
  }
  else{
    sum(is.na(i))
  }
})

lapply(book_df, function(i){
  if(length(unique(i)) <= 50) 
   table(i,useNA = "always")
  })


 ## some codes section occur in both PC and VC or (other combo), so we may be getting wring section, but only happends with about 30 code sections
charge_hier %>%
  add_count(join_var2) %>%
  filter(n>1) %>%
  filter(charge_code != "Other") %>%
  select(-n) %>%
  add_count(join_var2) %>%
  filter(n>1) %>%
  arrange(join_var2)

book_df %>%
  distinct(book_num) %>%
  arrange(book_num) %>%
  group_by(book_num) %>%
  add_count() %>%
  filter(n>1)
 book_df %>%
  
  distinct(arrest_date) %>%
  arrange(desc(arrest_date))
  
 # diagnostics for charge Hierarchy 
 
   # 1 - 7,901/267,372 = 97% non-match rate
(1 - nrow(book_df %>% filter(is.na(hierarchy)))/nrow(book_df))*100

  #book_df %>%
  filter(is.na(hierarchy)) %>%
  count(join_var2) %>%
  arrange(desc(n))

  # book_df%>%
  #   filter(grepl("F_12032", join_var2))%>%
  #   group_by(join_var2)%>%
  #   count()
  # 
  # charge_hier%>%
  #   filter(grepl("PROB", master_charge_description))

   length(unique(book_df$book_num))

table(book_df$arrest_charge_original)[order(table(book_df$arrest_charge_original), decreasing = T)]


table(grep("\\/", book_df$arrest_charge_original, value = TRUE))

table(book_df$arrest_charge_level_original)

table(book_df$arrest_charge_original)[order(table(book_charge$arrest_charge_original), decreasing = T)]

book_df %>%
  count(arrest_charge_original, arrest_charge) %>%
  group_by(arrest_charge_original) %>%
  add_count() %>%
  filter(n > 1)

book_df$aco_count <- sapply(book_df$arrest_charge_original, function(x) length(which(book_df$arrest_charge_original == x)))
book_df$ac_count <- sapply(book_df$arrest_charge, function(x) length(which(book_df$arrest_charge == x)))
book_df$ac_counts_match <- book_df$aco_count == book_df$ac_count
table(book_df$ac_counts_match, useNA = "ifany")

book_df[!(book_df$ac_counts_match),
        c("book_num", "arrest_charge_level_original", "arrest_charge_original", "arrest_charge", "attempt",
          "aco_count", "ac_count")][order(book_df$arrest_charge[!(book_df$ac_counts_match)]), ]

####
```

Import Court Data Nevada
```{r eval=FALSE, include=FALSE}

# Nevada Court Case Data Import 1/2/2015-12/31/2020
  ##Court Status (renamed court_df contains dispostion type) file_date 1/2/2015-12/30/2020, dispo_date 1/2/2015-9/2/2027 (2027 date looks like and error, but data are there up to 1/27/21)
  ##Court Charges (also has plea type and dispo type contains plea_date range 9/8/2014-12/24/2019  and disposition_date range 1/22/1949-12/23/2019)
  ##Court hearings (hearing dates range from 1/2/2015-5/31/2019)
  ##Court Warrants (warrant date range 1/5/2015-12/30/2019)

####

#Court Status Nevada
  ##court_df has one row per case and has information on the case status as well as demographic information on the defendant
  ## Status of GC Services means that the case has been referred to a collections agency.  It is effectivly a closed case. They do     not use "inactive" any more, they used closed.  A and B suffixes appear to be codefendants on a case.
  ## running distinct () drops size from 13,687 to 13,675  
  ## file_date range 1/2/2015-12/31/2019  with latest data date range goes up to 6/30/2020
  ## status_date_time range 1/6/2015-12/24/2019 with latest data date range goes up to 7/23/2020
  ## disposition_date range 1/2/2015-9/2/2027 (two later than current date) with latest data date range goes up to 7/23/2020
  ## dob range 3/10/1924-6/3/2001 with latest data date range goes up to 2/20/2002

court_df <- lapply(c("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Nevada/PTRiskAss-Case+PtyData.csv",
                     "G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Nevada/Submitted 2-3/PTRiskAss-Case+PtyData.csv",
                     "G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Nevada/P2 Submission-June 30/PTRiskAss-Case+PtyData.csv", "G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Nevada/P3 Submission-Jan 15/PTRiskAss-Case+PtyData.csv"),
                   function(x) {
                     fread(x, colClasses = "character")
                   }) %>%
  bind_rows() %>%
  distinct()


# Variable name standardization--See pg. xxx for more details. 
names(court_df) <- c("court_docket_id", "court_case_id", "file_date", "status", "status_date_time", "court_charge_description", "disposition_type_original", "disposition_date", "local_id", "first_name", "middle_name", "last_name", "suffix", "party_code", "ssn", "dob", "cii", "fbi", "sex_original", "race_original")


# Date Reformatting--See pg. xxx for more details.  Also reformatting CII
court_df <- court_df %>%
  mutate(dob = mdy(dob),
         status_date_time = mdy_hms(status_date_time),
         file_date = mdy(file_date),
         disposition_date = mdy(disposition_date))


# Standardize Factors--See pg. xxx for more details.
court_df <- court_df %>%
  mutate(sex = case_when(sex_original %in% c("M") ~ "Male",
                         sex_original %in% c("F") ~ "Female", T ~ "Other_Unknown"),
         race = case_when(race_original %in% c("AA") ~ "Black",
                          race_original %in% c("HISP") ~ "Hispanic",
                          race_original %in% c("CAU") ~ "White",
                          T ~ "Other_Unknown"),
         disposition_type = case_when(disposition_type_original %in% c("DISMISSED", 
                                                                       "DISMISS AFTER APPEARANCE",
                                                                       "DISMISSED BEFORE TRIAL (W/O APPEARANCE)",
                                                                       "DISMISS/ACQUIT BEFORE EVIDENCE BY COURT",
                                                                       "DISMISS AFTER EVIDENCE BY JURY TRIAL",
                                                                       "DISMISS/ACQUIT AFTER EVIDENCE BY COURT",
                                                                       "DISMISSAL AFTER HEARING/PRELIM",
                                                                       "DISMISSAL BEFORE HEARING/PRELIM",
                                                                       "DISMISS/ACQUIT BEFORE EVIDENCE BY JURY TRIAL",
                                                                       "DISMISS W/O APPEARANCE") ~ "Dismissed",
                                      disposition_type_original %in% c("PLEA GUILTY/NOLO",
                                                                       "PLEA GUILTY/NOLO/MISD OTHER",
                                                                       "PLEA GUILTY/NOLO/MISD 17B",
                                                                       "CONVICT AFTER EVIDENCE BY COURT/FELONY",
                                                                       "CONVICT BEFORE EVIDENCE BY COURT",
                                                                       "CONVICT BEFORE EVIDENCE BY COURT/17B", 
                                                                       "PLEA GUILTY/NOLO/FELONY") ~ "Nolo_Contendere",
                                      disposition_type_original %in% c("CONVICTED",
                                                                       "CONVICT AFTER EVIDENCE BY JURY TRIAL",
                                                                       "CONVICT AFTER EVIDENCE BY JURY TRIAL/FELONY",
                                                                       "CONVICT AFTER EVIDENCE BY COURT",
                                                                       "CONVICT AFTER EVIDENCE BY JURY TRIAL/MISD OTHER",
                                                                       "CONVICT BEFORE EVIDENCE BY COURT/MISD OTHER",
                                                                       "CONVICT BEFORE EVIDENCE BY COURT/FELONY") ~ "Guilty",
                                      disposition_type_original %in% c("ACQUITTED/NOT GUILTY", 
                                                                       "NOT GUILTY/INSANE",
                                                                       "DO NOT USE - ACQUITTAL AFTER JURY TRIAL") ~ "Not_Guilty",
                                      disposition_type_original %in% c("CONSOLIDATED", 
                                                                       "EXTRADITED", 
                                                                       "CERTIFIED TO JUVENILE COURT", 
                                                                       "DO NOT USE THIS CODE!", 
                                                                       " ", 
                                                                       "UNDISPOSED",
                                                                       "PROBATION SUPERVISION - TRANSFER IN",
                                                                       "WAIVER OF EXTRADITION SIGNED",
                                                                       "CONSOLIDATED BEFORE HEARING/PRELIM/TRIAL",
                                                                       "COURT FINDING",
                                                                       "BAIL FORFEITURE",
                                                                       "UNKNOWN",
                                                                       "TRAFFIC SCHOOL - AFTER APPEARANCE/HEARING",
                                                                       "CONSOLIDATED AFTER HEARING/PRELIM/TRIAL",
                                                                       "TRAFFIC SCHOOL - BEFORE APPEARANCE/HEARING",
                                                                       "CHANGE OF VENUE - AFTER HEARING/PRELIM/TRIAL",
                                                                       "TRANSFER TO ANOTHER COURT") ~ "Other"))




####


# Court Filing Charges 
  ## court_charges contains one row per each charge associated with a court case and includes information on the charges and dispositions of each charge.
  ## court_charges contains a disposition_date, but there can be multiple disposition dates within a court case when VOP charges are dealt with after the main court case. It appears that the disposition_date in court_df would be a better source of disposition date
 ## after Jan-Dec2020 data submitted obs=38,084 dispo_date range 1/22/1949 to 1/27/2021, plea_date 9/8/2014 to 1/26/2021

court_charge <- lapply(c("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Nevada/PTRiskAss-Chg.csv",
                          "G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Nevada/Submitted 2-3/PTRiskAss-Chg.csv",
                           "G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Nevada/P2 Submission-June 30/PTRiskAss-ChargeData.csv", "G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Nevada/P3 Submission-Jan 15/PTRiskAss-ChargeData.csv"),
                        fread) %>%
  bind_rows() %>%
  distinct()




# Variable name standardization--See pg. xxx for more details. 
names(court_charge) <- c("court_docket_id", "court_case_id", "local_id", "court_charge_number", "court_charge_code_original", "court_charge_level_original", "court_charge_description", "plea_type_original", "plea_date", "disposition_type_original", "disposition_date")

# Date Reformatting--See pg. xxx for more details.
  ## plea_date range 9/8/2014-7/22/2020
  ## disposition_date range 1/22/1949-7/23/2020
  
  
court_charge <- court_charge %>%
  mutate(plea_date = mdy(plea_date),
         disposition_date = mdy(disposition_date))


# Court Filing Charges 
   ## the most frequent "other" charge level is "NOT CHARGED"
   ## seems like about 100 court charges are strung together"290012A290018" "290010290018B" "290013A29018B" "23152A23550A"  "23152A235505"                  "23152B235505"  "23152A23550"
   ## removing sentence date beacuse not needed


court_charge <- court_charge %>%
  mutate(attempt = if_else(grepl("\\(664\\)$|\\/664$|^664\\/", court_charge_code_original), 1, 0)) %>%
  mutate(court_charge_code = substr(court_charge_code_original, 1, 2),
         court_charge_code = ifelse(!(court_charge_code %in% c("PC", "VC", "HS", "BP", "WI","US")), "Other",
                                    court_charge_code),
         court_charge = ifelse(court_charge_code != "Other", substr(court_charge_code_original, 3,
                                                                    nchar(court_charge_code_original)), NA),
         court_charge = gsub("M$|F$|I$", "", court_charge), 
         court_charge = gsub("\\(664\\)$|\\/664$|^664\\)", "", court_charge),
         court_charge = gsub("\\(2ND\\)", "", court_charge),
         court_charge = gsub("\\-U18|\\-O21|\\-?18\\-21", "", court_charge),
         court_charge = gsub("\\+$|\\-", "", court_charge),
         court_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}","", court_charge)),
         court_charge_level = str_extract(court_charge_level_original, "[A-Z]{1}"),
         court_charge_level = if_else(court_charge_level  %in% c("F1"), "F" , court_charge_level),
         court_charge_level = if_else(!court_charge_level %in% c("F", "I", "M"), "Other", court_charge_level)) %>%
  unite(join_var, court_charge_level, court_charge_code, court_charge, remove = F) 

# Standardize Factors--See pg. xxx for more details.
court_charge <- court_charge %>%
  mutate(disposition_type = case_when(disposition_type_original %in% c("DISMISSED") ~ "Dismissed",
                         #disposition_type_original %in% c("") ~ "Dropped",
                         #disposition_type_original %in% c("") ~ "Nolo_Contendere",
                         disposition_type_original %in% c("CONVICTED") ~ "Guilty",
                         disposition_type_original %in% c("ACQUITTED/NOT GUILTY", "NOT GUILTY/INSANE") ~ "Not_Guilty",
                         disposition_type_original %in% c("CONSOLIDATED", "EXTRADITED", "CERTIFIED TO JUVENILE COURT", "DO NOT USE THIS CODE!", " ") ~ "Other"),
         plea_type = case_when(plea_type_original %in% c("NO CONTEST PLEA", "NO CONTEST ADMISSION") ~ "Nolo_Contendere",
                               plea_type_original %in% c("ADMIT", "GUILTY") ~ "Guilty",
                               plea_type_original %in% c("DENY", "NOT GUILTY", "NOT GUILTY BY REASON OF INSANITY PLEA") ~ "Not_Guilty",
                               plea_type_original %in% c("NO PLEA", "DIVERSION", " ") ~ "Other"))
                               
                               
  #sentence_date = if_else(disposition_type_original %in% c("CONVICTED"), disposition_date, as_date(NA)))


 
# Code for Charge Hierarchy and
#Make flags
load("G:/CrimJustice/PretrialAssessmentPilot/Complete Charge Code Hierarchy.RData")



court_charge <- left_join(court_charge, charge_hier, by = "join_var") %>%
  mutate(felony_flag = if_else(court_charge_level == "F", 1, 0),
         misd_flag = if_else(court_charge_level == "M", 1, 0)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, as.numeric(.)))) %>%
  mutate_at(vars(contains("flag")), funs("conviction" = if_else(. == 1 & disposition_type %in% c("Guilty", "Nolo_Contendere"), 1, 0))) %>%
  rename_at(vars(contains("flag"), -contains("conviction")), funs(paste0("court_", .))) %>%
  rename_at(vars(contains("conviction")), funs(paste0("conviction_", gsub("_conviction", "", .)))) 

####

# Court Hearings
  ## court_hearing contains one row per hearing event on each court case and includes information about each hearing. 
    ## court_hearing obs=81,932 as of 12/31/2020 end date submission hearing dates range from 1/2/2015-12/31/2020



court_hearing <-lapply(c("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Nevada/PTRiskAss-Evnt3.csv",
                         "G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Nevada/P2 Submission-June 30/PTRiskAss-EventData.csv", "G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Nevada/P3 Submission-Jan 15/PTRiskAss-EventData.csv"), 
                       fread)%>%
  bind_rows() %>%
  distinct()



# Variable name standardization--See pg. xxx for more details.
names(court_hearing) <-
  c( "court_docket_id","court_case_id", "local_id", "hearing_id", "hearing_date", "hearing_type_original", "hearing_result")

# Date Reformatting--See pg. xxx for more details.
court_hearing <- court_hearing %>%
  mutate(hearing_date = mdy(hearing_date))
 


# Standardize Factors--See pg. xxx for more details.
court_hearing <- court_hearing %>%
  mutate(
    hearing_type = case_when(
      hearing_type_original %in% c("ARRAIGNMENT","WARRANT ARRAIGNMENT", "ARRAIGNMENT ON VIOLATION OF PROBATION (VOP)",
                                   "CONTINUED ARRAIGNMENT", "ARRAIGNMENT ON VIOLATION OF PROBATION-FELONY",
                                   "ARRAIGNMENT ON INFORMATION", "ARR ON PETITION TO REVOKE/MODIFY PAROLE",
                                   "ARR ON PETITION TO REV/MOD MANDATORY SUPERVISION", "FELONY ARRAIGNMENT",
                                   "DUI ARRAIGNMENT") ~ "Arraignment",
      hearing_type_original %in% c(
        "SENTENCING", "FELONY SENTENCING",  "SENTENCING ON VIOLATION OF PROBATION", "SENTENCING ON VIOLATION OF PROBATION - FELONY",
        "SENTENCING ON PETITION TO REVOKE/MODIFY PAROLE", "SENTENCING ON PET TO REV/MOD MANDATORY SUPERVISION",
        "SENTENCING ON PETITION TO MODIFY/REVOKE PRCS" ) ~ "Sentencing",  T ~ "Other_Unknown"),
    court_fta_flag = if_else(grepl("FTA|FAILURE TO APPEAR", hearing_result), 1, 0))

####

# Court FTAs with Warrants date range 1/5/2015-12/31/2020
 # obs for file with end date 12/31/2020 = 10268
court_warrants <- lapply(c("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Nevada/PTRiskAss-BW.csv",
                           "G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Nevada/Submitted 2-3/PTRiskAss-BW.csv",
                           "G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Nevada/P2 Submission-June 30/PTRiskAss-BenchWarrantData.csv", "G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Nevada/P3 Submission-Jan 15/PTRiskAss-BenchWarrantData.csv"),
                         fread) %>%
  bind_rows() %>%
  distinct()



names(court_warrants) <- c("court_docket_id", "court_case_id", "hearing_id", "hearing_date", "fta_warrant", "fta_warrant_date")


court_warrants <- court_warrants %>%
  mutate(hearing_date = mdy(hearing_date),
         fta_warrant_date = mdy(fta_warrant_date),
         fta_flag = 1)


# left_join(court_charge, court_df, by = "court_case_id") %>%
#   arrange(court_case_id, disposition_date.x) %>%
#   select(court_case_id, disposition_date.x, disposition_date.y, court_charge_number, court_charge_level_original)
```

Nevada Court Collapse Nevada
```{r eval=FALSE, include=FALSE}
##disposition date in court charge is a charge disposition date rather than a case disposition date, It includes violations of probation, which means the latest date for each disposition_date is not correct when there is a VOP.
##court_df has the dispostion_date for the case, so we are using that for the case_dispostion date.  
##Nevada did not provide sentence date or sentence type
##

court_dispo <- court_charge %>%   
  mutate(disposition_type = ordered(disposition_type, levels = c("Other", "Dismissed", "Not_Guilty", "Nolo_Contendere", "Guilty"))) %>%
  group_by(court_case_id) %>%
  mutate(hierarchy = if_else(is.na(hierarchy), 1e6, as.numeric(hierarchy))) %>%
  group_by(court_case_id) %>%
  # mutate(disposition_date = max(disposition_date), disposition_type = max(disposition_type)) %>%
  select (-disposition_date) %>%
  # mutate(sentence_date=min(sentence_date, na.rm=TRUE)) %>%
  # mutate(max_court_charge_level = court_charge_level[hierarchy == min(hierarchy)][1],
  #        max_court_charge_code = court_charge_code[hierarchy == min(hierarchy)][1],
  #        max_court_charge = court_charge[hierarchy == min(hierarchy)][1],
  #        max_charge_description = master_charge_description[hierarchy == min(hierarchy)][1],
  #        max_hier = min(hierarchy)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, .))) %>%
  mutate_at(vars(contains("flag")), funs("count" = sum(.))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  mutate(join_var = paste(join_var, collapse = " ")) %>%
  filter(hierarchy == min(hierarchy)) %>%
  ungroup() %>%
  distinct(court_case_id, .keep_all = T)



#This code adds flags for FTAs this comes from court hearing data 
  ## court_warrants only contains lines with FTA flags no need to make fta_date or fta_flag 
court_fta_war <- court_warrants %>%
  arrange(fta_warrant_date) %>%
  group_by(court_case_id) %>%
  mutate(fta_flag_count = sum(fta_flag))%>%
  distinct(court_case_id, .keep_all = T) %>%  
 select(court_case_id,  fta_warrant_date, fta_flag, fta_flag_count)


#This code makes arraignment date
court_arraign <- court_hearing %>%
  filter(hearing_type == "Arraignment") %>%
  rename(arraignment_date = hearing_date) %>%
  arrange(arraignment_date) %>%
  distinct(court_case_id, .keep_all = T) %>%
  select(court_case_id, arraignment_date)


#This code makes a plea date
court_plea <- court_charge %>%
  arrange(disposition_date) %>%
  mutate(guilty_flag = if_else(disposition_type == "Guilty", 1, 0)) %>%
  group_by(court_case_id) %>%
  filter(guilty_flag == 1|sum(guilty_flag) == 0) %>%
  ungroup() %>%
  distinct(court_case_id, .keep_all = T) %>%
  select(court_case_id, plea_date , plea_type)



#this creates court sentence dates (I dont have a sentence date in Nevada it was created above so I dont think I need this code)
  ##not including this because it is making up fake data
court_sent <- court_hearing %>%
  mutate(sentence_date = if_else(hearing_type == "Sentencing", hearing_date, NA_Date_)) %>%
  arrange(sentence_date) %>%
  distinct(court_case_id, .keep_all = T) %>%
  select(court_case_id, sentence_date)

#this part does something not sure what
 ## leaving out mutate f final dispo date because we dont have sentence date in this dataset
 ## court_df  already came to us collapsed at level of case
court_df <- reduce(list(court_df, court_dispo, court_fta_war, court_arraign, court_plea, court_sent), left_join, by = "court_case_id") %>%
  select(-contains(".y")) %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x", "", .))) %>%
  mutate(pretrial_end_date = if_else(disposition_date <= sentence_date|is.na(sentence_date), disposition_date, sentence_date)) %>%
  mutate(conviction_flag = if_else(disposition_type %in% c("Guilty","Nolo_Contendere"), 1, 0))

save(court_df, file = "G:/CrimJustice/PretrialAssessmentPilot/Agency Collapse CSV Files/Nevada Court Collapse.RData")
```

Nevada Court Diagnostics
```{r eval=FALSE, include=FALSE}

  # not seeing any qualifier charges here  arrest_qualifier_flag=if_else()
            #sup_vio_post_flag=if_else(book_type=="Sup_Vio", 1, 0),

# P3 Diagnostics
##are any essential data elements missing

str(court_df)
str(court_charge)
str(court_hearing)
str(court_warrants)


## how well do tables match: court_df has 15372 distinct case_ids, 
## 15,371 matches found in court_charge 99.9 % match
## 9,767 matches found in court_hearings 63.5 % match

test <- court_df %>%
  distinct(court_case_id) %>%
  semi_join(court_hearing, by = "court_case_id")



#Are the contents mostly complete? 

lapply(court_warrants, function(i){
  if (is.character(i)==T){
    sum(is.na(i)|i=="NULL")
  }
  else{
    sum(is.na(i))
  }
})

lapply(court_warrants, function(i){
  if(length (unique(i)) <=50)
    table(i, useNA="always")})


# Do the date ranges make sense?

summary(court_df$file_date)
summary(court_df$disposition_date)
summary(court_df$dob)

summary(court_charge$disposition_date)
summary(court_charge$plea_date)

summary(court_hearing$hearing_date)

summary(court_warrants$hearing_date)


court_charge %>%
  arrange(desc(plea_date))

table(court_charges$court_charge_code_original[court_charges$court_charge_code == "Other"]), decreasing = TRUE)
unique(court_charges$court_charge[order(nchar(court_charges$court_charge), decreasing = TRUE)])
court_charges[grep("\\(F\\)$|\\(I\\)$", court_charges$court_charge_code_original), ]   

#court_charges%>%
 # table(court_charges$disposition_type, useNA="ifany")
#Court Charge Diagnositics  

lapply(court_df, function(i){
  if (is.character(i)==T){
    sum(is.na(i)|i=="NULL")
  }
  else{
    sum(is.na(i))
  }
})

lapply(court_df, function(i){
  if(length (unique(i)) <=50)
    table(i, useNA="always")})


court_df %>%
  distinct(court_case_id)%>%
  semi_join(court_charge, by="court_case_id")


court_df %>% 
    arrange (court_case_id, file_date) %>%
    add_count(court_case_id) %>%
    filter(n>1)  

table(court_charges[grep("attempt", court_charges$court_charge_description, ignore.case = T ), c("court_charge_description", "court_attempt_flag")])

court_charges[grep("attempt", court_charges$court_charge_description, ignore.case = T ), c("court_charge_description", "court_attempt_flag", "court_charge_code_original")]
# 

# "M_VC_231035A" this charge never used during arrest usually arrest is DUI then they plead down to receless driving"wet"
# "Other_PC_6665" special allegation prior auto theft

# Diagnostic Code for Charge Hierarchy
# 1 - 7,901/267,372 = 97% non-match rate
(1 - nrow(court_charge %>% filter(is.na(hierarchy)))/nrow(court_charge))*100

court_charge %>%
  filter(is.na(hierarchy)) %>%
  count(join_var) %>%
  arrange(desc(n))

court_charge%>%
  filter(grepl("Other_Other_NA", join_var))%>%
  group_by()%>%
  count() 


court_charge %>%
   filter(grepl("Other_Other_NA", join_var))%>%
  select(join_var, court_charge_level_original, court_charge_level, court_charge_code,court_charge_code_original, court_charge_level_original, disposition_type_original)

charge_hier%>%
  filter(grepl("12032", charge))

# some charges end with a "+" 
# some end with "M" or "F" or "I"
# some have "(664)" or "/664" at the end (attempt) or "664/" at the beginning
# some have "(2ND)"
# some have "-o21" or "-u18" or "-18-21" at end
# some have multiple statutes, but with either slash between or one in parentheses at end or neither

# court_charges[c("court_charge_code_original", "court_charge_level_original", "court_charge_code", "court_charge")]

# table(court_charges$court_charge_code)[order(table(court_charges$court_charge_code), decreasing = TRUE)]

# Code to check ones that don't start with two letters
# unique(court_charges$court_charge_code_original[!(grepl("^[A-Z]{2}", court_charges$court_charge_code_original)) | grepl("^[A-Z]{3}", court_charges$court_charge_code_original)])

# court_charges[substr(court_charges$court_charge_code_original, 1, 2) == "MC", ]

#Court hearing data
# court_hearing <- lapply(c("Historical Data Submissions/Nevada/PTRiskAss-Evnt3.csv",
#                           "Historical Data Submissions/Nevada/Submitted 2-3/PTRiskAss-Evnts.csv"),
#                         fread) %>%
#   bind_rows()
# new hearings file is actually duplicate of bench warrants data also sent separately. no q1 hearings data yet.
```

Import Court Data Sierra
```{r eval=FALSE, include=FALSE}

#These files are cumulative from historical period to 1/1/2021
  ##Court Demographics: contain court case id, first name, last name, DOB, race, sex
  ##court warrants: has FTA info and dates
  ##Court hearings: has arraignment dates 
  ##charges_dispositions; has dispos and dispo dates also has sentence type.  Sentence type didn't have any CDCR or Probation cases.  Will ask Diane Holman about that.


## Court Demographics


# Readin P3 data this data has 11 variables instead of 6, some fields were added erroneously read in only necessary columns
court_df_s3 <- read_excel("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Sierra/P3 Submission-Jan 15/Pretrial_4_Demographics-9-16-2019 thru 1-1-2021.xls", range = cell_cols("A:F"))

# Date Reformatting--See pg. xxx for more details.  
court_df_s3 <- court_df_s3 %>%  
  mutate_at(vars(contains("Date")), mdy) 


# Name Standardization--See pg. xxx for more details. 
names(court_df_s3) <- c("court_case_id", "first_name", "last_name","dob",  "race_original","sex_original")



# Standardize Factors--See pg. xxx for more details.
court_df_s3 <- court_df_s3 %>%
  mutate(sex = case_when(sex_original %in% c("Male") ~ "Male",
                         sex_original %in% c("Female") ~ "Female", T ~ "Other_Unknown"),
         race = case_when(race_original %in% c("Black") ~ "Black",
                          race_original %in% c("Hispanic") ~ "Hispanic",
                          race_original %in% c("White") ~ "White",
                          T ~ "Other_Unknown"))



####

## Court Warrants 

# read in updated data 9/16/2019-Dec 2020
# data contain erroneous data columns at the end read in only necessary columns
# warrant dates range from 12/10/2019 to 1/19/2021
court_warrant_s3 <- read_excel("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Sierra/P3 Submission-Jan 15/Pretrial_2_ScheduledEvents_Warrant 9-16-2019 thru 1-1-2021.xls" , range = cell_cols("A:G"))

# Date Reformatting--See pg. xxx for more details.  
court_warrant_s3 <- court_warrant_s3%>%  
  mutate_at(vars(contains("date")), mdy) 



# Name Standardization--See pg. xxx for more details. 
names(court_warrant_s3) <- c("court_case_id", "case_name", "hearing_type", "hearing_result_date", "hearing_result_type", "fta_warrant_date", "fta_warrant_type")

#Make FTA flag
court_warrant_s3 <- court_warrant_s3%>%  
  mutate(court_fta_flag = ifelse(hearing_result_type == "Fail to Appear: Bench Warrant Issued", 1, 0))
  # the data on event also have a code "Fail to Appear: Bench Warrant Held" these are not flagged


####

#Import Events Table, the P3 period file is cumulative from historical period hearing result date ranges from 9/24/2019 to 1/19/2021
court_hearings_s3<- read_excel("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Sierra/P3 Submission-Jan 15/Pretrial_5_ScheduledEvents 9-16-2019 thru 1-1-2021.xls", range = cell_cols("A:E")) 
 
# Variable name standardization--See pg. xxx for more details.
names(court_hearings_s3) <-
  c( "court_case_id", "case_name", "hearing_type_original", "hearing_result_date",  "hearing_result_original")

# Date Reformatting--See pg. xxx for more details.
court_hearings_s3 <- court_hearings_s3 %>%
  mutate(hearing_result_date = mdy(hearing_result_date))
 

# Standardize Factors--See pg. xxx for more details.
 
court_hearings_s3 <- court_hearings_s3  %>%
  mutate(
    hearing_type = case_when(
      hearing_type_original %in% c("Arraignment: Citation", "Arraignment: Complaint","Arraignment: Complaint-Amended", 
                                   "Arraignment: Information",
                                   "Arraignment: Warrant", "Further Arraignment: Complaint", "VOP: Arraignment") ~ "Arraignment",
      hearing_type_original %in% c("Sentencing Hearing") ~ "Sentencing",  
      T ~ "Other_Unknown")) 
     # Other_Unknown hearing types include (Agreement to Appear, change of Plea, Change of Plea or Setting, court trial, diversion hearing,Hearing: Doctor Report,Hearing: Other, Jury Trial, Jury Trial-Ongoing, Modification Hearing, Modification Hearing:Supervision, Motion Hearing, OSC Hearing, Pay or Appear, Plea Hearing, Pre-Plea Report, Pre-Trial & Setting of Jury Trial, Pre-Trial Conference, Pre Prelim, Prelim Setting, Preliminary Examination, Preliminary Hearing Confirmation, Proof or Appear, Readiness Conference, Review Hearing, Revocation Hearing, Trial Confirmation, Trail Management Conference,  Warrant Surrender	)
 


####

#Import Court Charges and Dispositions
  ## Date range for filing date is 9/16/2019 to 1/1/2021
# read in updated data Obs 248 file date range 9/16/2019-1/1/2021
# file dates range from 9/16/2019 to 12/29/2020
# sentence date range 5/11/2018 to 1/20/2021

court_dispos_s3 <- read_excel("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Sierra/P3 Submission-Jan 15/Pretrial_3_Charges-9-16-2019 thru 1-1-2021.xls", range = cell_cols("A:N"))

# Name Standardization--See pg. xxx for more details. 
names(court_dispos_s3) <- c("court_case_id", "case_name", "file_date", "charge_number", "court_charge_level_original", "court_charge_original", "disposition_date", "disposition_type_original", "disposition_manner", "sentence_date", "sentence_type_original", "sentence_amount", "sentence_length", "sentence_length_unit")


# Date Reformatting--See pg. xxx for more details.  
court_dispos_s3 <- court_dispos_s3%>%  
  mutate_at(vars(contains("date")), mdy) 



# Standardize Factors--See pg. xxx for more details.
court_dispos_s3 <- court_dispos_s3 %>%
  mutate(disposition_type = case_when(disposition_type_original %in% c("Dismissal", "Dismissal: Diversion Successful",
                                                                       "Dismissed with a Harvey Waiver") ~ 
                                        "Dismissed",
                                      disposition_type_original %in% c("Conviction: Court Finding of Guilt",
                                                                       "Conviction: Guilty Plea",	
                                                                       "Conviction: Nolo Plea", "Admitted") ~ 
                                        "Guilty",
                                      disposition_type_original %in% c("ACQUITTED/NOT GUILTY", 
                                                                       "NOT GUILTY/INSANE",
                                                                       "DO NOT USE - ACQUITTAL AFTER JURY TRIAL") ~
                                        "Not_Guilty",
                                      disposition_type_original %in% c("Amended Pleading Filed", "Diversion Referral",
                                                                       "Held to Answer", 
                                                                       "Not Filed on Amended Pleading", "Stricken") ~
                                        "Other"),
         # ask court if this really means jail or if Jail/CS should be "other"
         sentence_type = case_when(sentence_type_original %in% c("County Jail", "Fine-Converted to Jail/CS") ~ "Jail",
                                   T ~ "Other" )) %>%
  
  mutate(court_charge_code_original = str_extract(court_charge_original, "^[A-Z]*"),
         court_charge_original = gsub("^[A-Z]*", "", court_charge_original),
         court_charge = gsub("\\s.*", "", court_charge_original),
         charge_description = str_extract(court_charge_original, "\\s.*")) %>%
           

  mutate(attempt = if_else(grepl("\\(664\\)$|\\/664$|^664\\/", court_charge_code_original), 1, 0)) %>%
  mutate(court_charge_code = substr(court_charge_code_original, 1, 2),
         court_charge_code = ifelse(!(court_charge_code %in% c("PC", "VC", "HS", "BP", "WI","US")), "Other",
                                    court_charge_code),
         #court_charge = ifelse(court_charge_code != "Other", substr(court_charge_code_original, 3,
         #                                                            nchar(court_charge_code_original)), NA),
         # court_charge = gsub("M$|F$|I$", "", court_charge), 
         court_charge = gsub("\\-M", "", court_charge),
         court_charge = gsub("\\(664\\)$|\\/664$|^664\\)", "", court_charge),
         court_charge = gsub("\\(2ND\\)", "", court_charge),
         court_charge = gsub("\\-U18|\\-O21|\\-?18\\-21", "", court_charge),
         court_charge = gsub("\\+$|\\-", "", court_charge),
         court_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}","", court_charge)),
         court_charge_level = str_extract(court_charge_level_original, "[A-Z]{1}"),
         #court_charge_level = if_else(court_charge_level  %in% c("F1"), "F" , court_charge_level),
         court_charge_level = if_else(!court_charge_level %in% c("F", "I", "M"), "Other", court_charge_level)) %>%
  unite(join_var, court_charge_level, court_charge_code, court_charge, remove = F) 



# Code for Charge Hierarchy and
#Make flags
load("G:/CrimJustice/PretrialAssessmentPilot/Complete Charge Code Hierarchy.RData")


court_dispos_s3 <- left_join(court_dispos_s3, charge_hier, by = "join_var") %>%
  mutate(felony_flag = if_else(court_charge_level == "F", 1, 0),
         misd_flag = if_else(court_charge_level == "M", 1, 0)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, as.numeric(.)))) %>%
  mutate_at(vars(contains("flag")), funs("conviction" = if_else(. == 1 & disposition_type %in% c("Guilty", "Nolo_Contendere"), 1, 0))) %>%
  rename_at(vars(contains("flag"), -contains("conviction")), funs(paste0("court_", .))) %>%
  rename_at(vars(contains("conviction")), funs(paste0("conviction_", gsub("_conviction", "", .)))) 


####

court_dispos_s3 %>%
  count(sentence_type_original) %>%
  arrange(desc(n))

```
Sierra Court Diagnostics
```{r eval=FALSE, include=FALSE}

# Diagnostics
##are any essential data elements missing

str(court_df_s3)
str(court_dispos_s3)
str(court_hearings_s3)
str(court_warrant_s3)


## how well do tables match: court_df_s3 has 168 distinct case_ids, 
##165 matches found in court_dispos_s3 98% match
##150 matches found in court_hearings_s3 89% match

test <- court_df_s3 %>%
  distinct(court_case_id) %>%
  semi_join(court_hearings_s3, by = "court_case_id")




#Are the contents mostly complete? 

lapply(court_df_s3, function(i){
  if (is.character(i)==T){
    sum(is.na(i)|i=="NULL")
  }
  else{
    sum(is.na(i))
  }
})

lapply(court_df_s3, function(i){
  if(length (unique(i)) <=50)
    table(i, useNA="always")})


```

Court Collapse Sierra
```{r}
court_dispo_s <- court_dispos_s3 %>%   
  mutate(disposition_type = ordered(disposition_type, levels = c("Other", "Dismissed", "Not_Guilty", "Nolo_Contendere",
                                                                 "Guilty"))) %>%
  mutate(sentence_type = ordered(sentence_type, levels = c("Other", "Probation", "Jail", "Prison"))) %>%
  mutate(hierarchy = if_else(is.na(hierarchy), 1e6, as.numeric(hierarchy))) %>%
  group_by(court_case_id) %>%
  mutate(disposition_date = max(disposition_date), disposition_type = max(disposition_type),
         sentence_type = max(sentence_type), 
         sentence_date=min(sentence_date, na.rm=TRUE),
         disposition_date = if_else(sentence_date < disposition_date, sentence_date, disposition_date)) %>%

  
  # mutate(max_court_charge_level = court_charge_level[hierarchy == min(hierarchy)][1],
  #        max_court_charge_code = court_charge_code[hierarchy == min(hierarchy)][1],
  #        max_court_charge = court_charge[hierarchy == min(hierarchy)][1],
  #        max_charge_description = master_charge_description[hierarchy == min(hierarchy)][1],
  #        max_hier = min(hierarchy)) %>%
  
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, .))) %>%
  mutate_at(vars(contains("flag")), funs("count" = sum(.))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  mutate(join_var = paste(join_var, collapse = " ")) %>%
  filter(hierarchy == min(hierarchy)) %>%
  ungroup() %>%
  distinct(court_case_id, .keep_all = T)


#This code adds flags for FTAs this comes from court hearing data 
  ## court_warrants only contains lines with FTA flags no need to make fta_date or fta_flag 
  ## hearing result date works  because all hearing result in an FTA being issued and FTA warrant date is not always populated
  ## we need to ask Sierra what fta_warrant_date means becaue all of the hearing results indicate that an FTA warrant was issued.
court_fta_war <- court_warrant_s3 %>%
  arrange(hearing_result_date) %>%
  group_by(court_case_id) %>%
  mutate(fta_flag_count = sum(court_fta_flag))%>%
  distinct(court_case_id, .keep_all = T) %>%  
 select(court_case_id,  fta_warrant_date, hearing_result_date, court_fta_flag, fta_flag_count)


#This code makes arraignment date
# We ot the first hearings table in the P# submission
court_arraign <- court_hearings_s3 %>%
  filter(hearing_type == "Arraignment") %>%
  #sierra data contains hearing_result_date dont know if this is the same as hearing date in other counties
  rename(arraignment_date = hearing_result_date) %>%
  arrange(arraignment_date) %>%
  distinct(court_case_id, .keep_all = T) %>%
  select(court_case_id, arraignment_date)

#This code makes a plea date

# court_plea <- court_dispos_s %>%
#   arrange(disposition_date) %>%
#   mutate(guilty_flag = if_else(disposition_type == "Guilty", 1, 0)) %>%
#   group_by(court_case_id) %>%
 
#   filter(guilty_flag == 1|sum(guilty_flag) == 0) %>%
#   ungroup() %>%
#   distinct(court_case_id, .keep_all = T) %>%
#   select(court_case_id, plea_date , plea_type)




#this creates court sentence dates (this was taken care of in creation of court_dispo_s)
  ##not including this because it is making up fake data
#court_sent <- court_hearing %>%
  #arrange(sentence_date) %>%
  #distinct(court_case_id, .keep_all = T) %>%
  #select(court_case_id, sentence_date)

#this part does something not sure what
  ## court_df  already came to us collapsed at level of case
court_df <- reduce(list(court_df_s3, court_dispo_s, court_fta_war, court_arraign ), left_join, by = "court_case_id") %>%
  select(-contains(".y")) %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x", "", .))) %>%
  mutate(pretrial_end_date = if_else(disposition_date <= sentence_date|is.na(sentence_date), disposition_date, sentence_date)) %>%
  mutate(conviction_flag = if_else(disposition_type %in% c("Guilty","Nolo_Contendere"), 1, 0))

save(court_df, file = "G:/CrimJustice/PretrialAssessmentPilot/Agency Collapse CSV Files/Sierra Court Collapse.RData")
```

Probation Data New Nevada
```{r eval=FALSE, include=FALSE}
# Nevada Assessment Data Import--data are organized in one excel files with multiple worksheets
  ## Case Data: read in 2/10/2021 P3 data have 290 obs pretrial_release_dates range from 1/15/2019 to 12/19/2020, termination_dates from 5/5/2020 to 1/29/2021
  ## Demographics: has 263 obs no dates 
  ## Scores: has 1712 obs, assessment_date ranges from 5/1/2020 to 1/27/2021
  ## Terms and Conditions: has 687 observations no dates
  ## violations: obs 373 pretrial violation dates range from: 


 
## read in case data
# assess_df_old <- read_csv("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/San Mateo/P2 Submission-June 30/Pretrial Pilot eProb PROD data_10142020.csv", skip = 3) i this is old data read in that goes up to 10/15/2020.  The newest file contains all of the same data plus 3 more months

# assess_df_case_p2 <- read_excel("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Nevada/P2 Submission-June 30/pretrial_data.xlsx",  sheet = 1)


assess_df_case <- read_excel("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Nevada/P3 Submission-Jan 15/pretrial_data Jan 2021.xlsx",  sheet = 1)


# Format Names
assess_df_case <- assess_df_case %>%
  mutate (name = toupper(Name)) %>% 
  separate(name, c("last_name", "first_name", "suffix"),  sep = ",") %>%
  mutate_at(vars(first_name, last_name, suffix), trimws) %>%
  separate(first_name, c("first_name", "middle_name"), sep = " ") 


# Standardize Names
names(assess_df_case) <- c("pretrial_id", "name","zip_code",
                            "release_recommendation_original", "release_authorization", "pretrial_release_type_original",
                           "pretrial_release_date_time",
                            "court_date_reminder_original", "pretrial_termination_outcome_original", "pretrial_termination_date_time",
                            "last_name","first_name", "middle_name","suffix")

# these variables were in P2 but not P3 "pretrial_id1", "pretrial_id2", "arresting_agency",  and "release_authorization was added in P3


# Date Reformatting--See pg. xxx for more details.
assess_df_case <- assess_df_case %>%
  mutate(pretrial_release_date = as_date(pretrial_release_date_time),
         pretrial_termination_date = as_date(pretrial_termination_date_time))  




# Factor Standardization
assess_df_case <- assess_df_case %>%
  
    mutate (release_recommendation = case_when(release_recommendation_original %in% c("Release on Own
                                                                                      Recognizance") ~ "OR", 
                                             release_recommendation_original %in% c("Pre-Arraignment Release",
                                                                                    "Release at Arraignment") ~
                                               "Monitor",
                                             release_recommendation_original %in% c("Detain(PT denied)", "If
                                                                                    released, maximum conditions
                                                                                    apply") ~ "Detain",
                                             pretrial_termination_outcome_original %in% c("Bond Posted","Charges Dismissed", "No Charges Filed")~ "Ineligible",
                                            TRUE ~ "Other_Unknown"),
            
         
          release_decision = case_when(pretrial_release_type_original %in% c("Pre-Arraignment Release", "Release at Arraignment") ~ "Monitor",
                                       pretrial_release_type_original %in% c("Release on Own Recognizance") ~ "OR",
                                       pretrial_release_type_original %in% c("Detain(PT denied)") ~ "Detain",
                                       pretrial_termination_outcome_original %in% c("Bond Posted", "Charges Dismissed", "No Charges Filed")~ "Ineligible",
                                       TRUE ~ "Other_Unknown"),
          
          
          pretrial_ineligible_reason = case_when(pretrial_termination_outcome_original %in% c("Bond Posted") ~ "Bail_Bond",
                                                 pretrial_termination_outcome_original %in% c("Charges Dismissed", "No Charges Filed", "Sentenced") ~ "Case_Disposed",
                                                 TRUE ~ "Other_Unknown"),
          
        # pretrial_release_type will come from jail data
        # pretrial_release_type = case_when(pretrial_release_type_original %in% c("Release on Own Recognizance") ~ "OR",
        #                                   pretrial_release_type_original %in% c("Pre-Arraignment Release", "Release at Arraignment") ~	"Monitor",
        #                                   pretrial_termination_outcome_original %in% c("Bond Posted") ~	"Bail_Bond",
        #                                   pretrial_release_type_original %in% c("Detain(PT denied)") | pretrial_termination_outcome_original %in% c("Release Denied")~ "Detain",
        #                                   TRUE ~ "Other_Unknown"),
        ## there might also be info on pretrial termination outcomes in assess_df_violaiton 
       
        pretrial_termination_reason = case_when(pretrial_termination_outcome_original %in% c("Charges Dismissed", "No Charges Filed", "Sentenced") ~ "Case_Disposed",
                                                pretrial_termination_outcome_original %in% c("Failure to Appear") ~ "FTA",
                                                pretrial_termination_outcome_original %in% c("Felony Arrest") ~ "New_Crime",
                                                pretrial_termination_outcome_original %in% c("Technical Violation") ~ "Violation",
                                          
                                                pretrial_termination_outcome_original %in% c("Bond Posted")  ~ "Not_Tracked",
                                                 TRUE ~ "Other_Unknown"),
         pretrial_termination_outcome = case_when(pretrial_termination_reason %in% c("Case_Disposed") ~ "Successful",
                                                  pretrial_termination_reason %in% c("Abscond", "FTA", "New_Crime", "Violation") ~ "Unsuccessful",
                                                  pretrial_termination_reason %in% c("Not_Tracked") ~ "Not_Tracked",
                                                  T ~ "Other_Unknown"))



##flags 

assess_df_case <- assess_df_case %>%
 mutate(court_date_reminder_flag = case_when(court_date_reminder_original=="Yes" ~ 1,
                                              TRUE ~ 0),
        rec_release_flag = if_else(release_recommendation_original %in% c("Release on Own Recognizance",
                                                                               "Pre-Arraignment Release", 
                                                                               "Release at Arraignment"), 1, 0),
        decision_release_flag = if_else(pretrial_release_type_original %in% c("Release on Own Recognizance",
                                                                               "Pre-Arraignment Release", 
                                                                               "Release at Arraignment"), 1, 0),
        
        
        
         #This field needs to come from the jail data.
         # pretrial_release_flag = if_else(),
         release_override_flag = if_else(rec_release_flag != decision_release_flag & 
                                            !release_recommendation %in% c("Ineligible", "Other_Unknown") & 
                                            !release_decision %in% c("Ineligible", "Other_Unknown"), 1, 0),
        
         pretrial_violation_flag = if_else(pretrial_termination_outcome == "Unsuccessful", 1,0))


   
# add this to case data to make court date reminder flag 
##court_date_reminder_flag = if_else(court_date_reminder_original == "CourtAppearance"|
##pretrial_release_type_original %in% c("PTS with court reminders", "OR-with court reminders"), 1, 0),
         

# assess_df_case %>%
#   count(pretrial_termination_outcome_original, release_recommendation_original, release_recommendation, pretrial_release_type_original, release_decision) %>%
#   view
    

##Readin Demographic data

# old  assess_df_demo_p2 <- read_excel("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Nevada/P2 Submission-June 30/pretrial_data.xlsx", col_types= c("text" , "text" , "text" , "text" ,  "text" , "text" , "text" , "date" , "text" ,  "text" ) , sheet = 2)


assess_df_demo <- read_excel("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Nevada/P3 Submission-Jan 15/pretrial_data Jan 2021.xlsx", col_types= c("text" , "text" , "text" , "text" ,  "text" , "date" ,
                                                    "text" , "text" ) , sheet = 2)


# Standardize Names
names(assess_df_demo) <- c("pretrial_id",  "cii", "fbi", "cdl_id",
                            "name", "dob", "sex_original", "race_original")

assess_df_demo <- assess_df_demo %>%
  mutate (name = toupper(name)) %>% 
  separate(name, c("last_name", "first_name", "suffix"),  sep = ",") %>%
  mutate_at(vars(first_name, last_name, suffix), trimws) %>%
  separate(first_name, c("first_name", "middle_name"), sep = " ")

assess_df_demo <- assess_df_demo %>%
  mutate(dob = as_date(dob))

# "pretrial_id2", "arresting_agency", these two variables were in P2 but not in P3


#Standardize Factors
assess_df_demo <- assess_df_demo %>%
 mutate(sex = case_when(sex_original %in% c("Female") ~ "Female",
                         sex_original %in% c("Male") ~ "Male"),
         race = case_when(race_original %in% c("Hispanic") ~ "Hispanic",
                          race_original %in% c("Black") ~ "Black",
                          race_original %in% c("White") ~ "White",
                          race_original %in% c("NULL", "Pacific Islander", "Unknown") ~ "Other_Unknown"))


#Readin Scores

# old  assess_df_score_p2 <- read_excel("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Nevada/P2 Submission-June 30/pretrial_data.xlsx", sheet = 3, na = "NULL")


assess_df_score <- read_excel("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Nevada/P3 Submission-Jan 15/pretrial_data Jan 2021.xlsx", sheet = 3, na = "NULL")

# Standardize Names
assess_df_score <- assess_df_score %>%
  mutate (name = toupper(Name)) %>% 
  separate(name, c("last_name", "first_name", "suffix"),  sep = ",") %>%
  mutate_at(vars(first_name, last_name, suffix), trimws) %>%
  separate(first_name, c("first_name", "middle_name"), sep = " ") 



# Rearrange Scores from Long to Wide
assess_df_score <- assess_df_score %>%
  group_by (Id, Assessment_Date_Time) %>%
  pivot_wider(names_from = Tool_Question,  values_from = Tool_Response) %>%
  ungroup() %>%
  select(-`NA`)
  

# Standardize Names
names(assess_df_score) <- c("id", "pretrial_id",  "name","tool_name",
                            "assessment_date_time", "questions_id", "oras_risk_score", "last_name", "first_name",
                            "middle_name","suffix","oras_tool_response_1", "oral_tool_response_2",
                            "oras_tool_response_3",	"oras_tool_response_4","oras_tool_response_5",
                            "oras_tool_response_6", "oras_tool_response_7")

 # "pretrial_id2", "arresting_agency", these variables were in P@ but not P# extract


# Date Reformatting--See pg. xxx for more details.
assess_df_score <- assess_df_score %>%
  mutate(assessment_date = as_date(assessment_date_time),
         assess_flag = if_else(is.na(assessment_date), 0, 1),
         risk_level = case_when(oras_risk_score %in% c(0,1,2) ~"Low",
                                oras_risk_score %in% c(3, 4,5) ~ "Medium",
                                oras_risk_score %in% c(6, 7, 8, 9) ~ "High"),
         #I applied monitor level here, but it should only be applied to those who actually get released to pretrial not to everyone assessed.
         monitor_level = case_when(oras_risk_score %in% c(0,1,2) ~"Low",
                                oras_risk_score %in% c(3, 4,5) ~ "Medium",
                                oras_risk_score %in% c(6, 7, 8, 9) ~ "High"),
         # they call this CE check in It is remote or can be done from a kiosk
         condition_phone_flag = if_else(oras_risk_score %in% c(0,1,2), 1,0),
         condition_inperson_flag = if_else(oras_risk_score %in% c(3,4,5,6,7,8,9), 1, 0))

#Standardize Flags
assess_df_score <- assess_df_score %>%
  mutate(monitor_level = case_when(oras_risk_score %in% c(0,1,2) ~"Low",
                                oras_risk_score %in% c(3, 4,5) ~ "Medium",
                                oras_risk_score %in% c(6, 7, 8, 9) ~ "High"),
         # they call this CE check in It is remote or can be done from a kiosk
         condition_phone_flag = if_else(oras_risk_score %in% c(0,1,2), 1,0),
         condition_inperson_flag = if_else(oras_risk_score %in% c(3,4,5,6,7,8,9), 1, 0))




# Readin Terms and Conditions
  ## it looks like they record conditions the person got, rather than recommended conditions we find multiple lines for the same pretrial Id with different release dates, or release types.
  
# old assess_df_terms_p2 <- read_excel("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Nevada/P2 Submission-June 30/pretrial_data.xlsx", sheet = 4)

assess_df_terms <- read_excel("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Nevada/P3 Submission-Jan 15/pretrial_data Jan 2021.xlsx", sheet = 4)

#Standardize Names



names(assess_df_terms)<- c("pretrial_id",   "name",
                           "release_conditions_original")

 
# "pretrial_id2" , "arresting_agency",  these variables were not submitted in P3


assess_df_terms <- assess_df_terms %>%
         #rec_em_flag = if_else(grepl("SCRAM", toupper(release_recommendation_original)), 1, 0),
         # rec_phone_flag = if_else(),
         # rec_inperson_flag = if_else(),
         #rec_drug_test_flag = if_else(grepl("TEST", toupper(release_recommendation_original)), 1, 0),
         # rec_other_flag = if_else(),
  
  #this extract has no one on EM, but they do have it as a condition so we should make the flag.  Are we calling SCRM both EM and drug_test.
         mutate(condition_em_flag = if_else(grepl("ELECTRONIC MONITOR|GPS|SCRAM", toupper(release_conditions_original))|
                                             grepl("SCRAM", toupper(release_conditions_original)), 1, 0)) %>%
         
         mutate(condition_drug_test_flag = if_else(grepl("SCRAM|TEST|CONTROLLED SUBSTANCES|DRUG|ALCOHOL|CHEMICAL",
                                                  toupper(release_conditions_original)), 1, 0),
         condition_no_contact_flag = if_else(grepl("NO CONTACT|136|HARASS|CONTACT|STAY AWAY|STAY.*AWAY FROM|THREATEN|ANNOY",
                                                   toupper(release_conditions_original)), 1, 0))
          # condition_inperson_flag and condition_phone_flag are coded in the assess_df_score
         # the court_date_reminder flag is in assess_df_case
         # Transit is not captured in their data system,but they do give bus passes.  
         #transit_service_flag = if_else(court_date_reminder_original == "TRANSIT", 1, 0),
        


# old  assess_df_viol_p2 <- read_excel("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Nevada/P2 Submission-June 30/pretrial_data.xlsx", sheet = 5)

assess_df_viol <- read_excel("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Nevada/P3 Submission-Jan 15/pretrial_data Jan 2021.xlsx", sheet = 5)

#Standardize Names
names(assess_df_viol)<- c("pretrial_id", "name",
                           "pretrial_violation_original", "pretrial_violation_date")

# these varaibles have been removed "pretrial_id1", "pretrial_id2", "arresting_agency"

#the violations in this file are all violations, not just those that result in termiantion

#Standardize Dates
assess_df_viol <- assess_df_viol %>%
  mutate(pretrial_violation_date = convertToDate(pretrial_violation_date))


####


```

Nevada Probation Diagnostics
```{r}
# P3 Diagnostics
##are any essential data elements missing

str(assess_df_case)
str(assess_df_demo)
str(assess_df_score)
str(assess_df_terms)
str(assess_df_viol)

## how well do tables match: 
# assess_df_demo has 263 unique pretrial_ids
## 262 matches found in assess_df_case 99.6% match
## 263 matches found in assess_df_score 100% match
## 263 matches found in assess_df_terms 100% match
## 263 matches found in assess_df_viol 100% match

test2 <- assess_df_demo %>%
  distinct(pretrial_id) %>%
  semi_join(assess_df_viol, by = "pretrial_id")



#Are the contents mostly complete? 

lapply(assess_df_viol, function(i){
  if (is.character(i)==T){
    sum(is.na(i)|i=="NULL")
  }
  else{
    sum(is.na(i))
  }
})

lapply(assess_df_viol, function(i){
  if(length (unique(i)) <=50)
    table(i, useNA="always")})


# Do the date ranges make sense?

summary(assess_df_case$pretrial_release_date)
summary(assess_df_case$pretrial_termination_date)

summary(assess_df_score$assessment_date_time)

summary(assess_df_viol$pretrial_violation_date)


```

Assessment Collapse
```{r}

## The id that these files should be joined on is pretrial_id2 according to Brendon Brown email 10/6/2020
## why are people getting multiple assessments in short period of time?

assess_df_score <- assess_df_score %>%
  arrange(assessment_date) %>%
  distinct(pretrial_id, assessment_date, .keep_all = TRUE)
  
assess_df_case <- assess_df_case%>%
  group_by(pretrial_id) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, .))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  distinct(pretrial_id, .keep_all = TRUE)

# dont use for now until we figure out event ID
assess_df_viol <- assess_df_viol%>%
  distinct(pretrial_id, .keep_all = TRUE)

assess_df_demo <- assess_df_demo%>%
  distinct(pretrial_id , .keep_all = TRUE) 
 

assess_df_terms <- assess_df_terms%>%
  group_by(pretrial_id) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, .))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  distinct(pretrial_id, .keep_all = TRUE)

assess_df <- assess_df_score %>%
  left_join(assess_df_demo, by = "pretrial_id") %>%
  select(-contains(".y")) %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x", "", .))) %>%

  left_join(assess_df_case, by = "pretrial_id") %>%
  select(-contains(".y")) %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x", "", .))) %>%

  left_join(assess_df_terms, by = "pretrial_id") %>%
  select(-contains(".y")) %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x", "", .)))  

  #left_join(assess_df_viol, by = "pretrial_id2")
 


# now that all the assessment tables are joined I can apply the monitor level to only those who were released.
assess_df <- assess_df %>%
  mutate(monitor_level = ifelse(release_decision == "Monitor", monitor_level, NA  ))


save(assess_df, file = "G:/CrimJustice/PretrialAssessmentPilot/Agency Collapse CSV Files/Nevada Assessment Collapse.RData")
 

# assess_df_terms %>%
#   group_by(pretrial_id2) %>%
#   add_count() %>%
#   filter(n>1) %>%
#   arrange(pretrial_id2)

```

Assessment Tables
```{r}
assess_table <- assess_df %>%
  # Collapse to each assessment.
  distinct(pretrial_id, .keep_all = T) %>%
  # Filter for only those actually assessed
  filter(!is.na(assessment_date)) %>%
  # Create county name.
  mutate(county = "Nevada") 
  # Select relevants variables.

# No booking number in assessment data,  so removing charge_level
# no Monitoring Level still need to ask county, so removing monitor_level

 
# Save file  
save(assess_table, file = "G:/CrimJustice/PretrialAssessmentPilot/Assessment Output Tables/Nevada Assessment Output 02-2021.RData")


```

DOJ CII/Linking Extraction
```{r}
# Grab Tables with CII for P3
df <- sapply(ls()[which(sapply(ls(), function(i){
  sum(names(get(i)) %in% "cii")
}) == 1)], get)

# Pull CII and other identifiers
doj_assess <- df[[1]] %>%
  select(cii, fbi, first_name, middle_name, last_name, suffix, dob, cdl_id, race_original, sex_original) %>%
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) 

doj_book <- df[[2]] %>%
  select(cii, fbi, first_name, middle_name, last_name, suffix, dob, cdl_id, race_original, sex_original) %>%
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) 


doj_court <- df[[3]] %>%
  select(cii, fbi, dob, race_original, sex_original, first_name, middle_name, last_name, suffix, local_id) %>%
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) 



# Examine missing ciis and duplicates on cii. 

 doj_book %>%  
   distinct()

 doj_book %>%
   distinct(cii)

 doj_book %>%
   distinct() %>%
   add_count(cii) %>%
   filter(n > 1) %>%
   arrange(desc(n)) %>%
   View()

 doj_court %>%   
   distinct()

 doj_court %>%
   distinct(cii)

 doj_court %>%
   distinct() %>%
   add_count(cii) %>%
   filter(n > 1) %>%
   arrange(desc(n)) %>%
   View()


 doj_assess %>%    
   distinct()

 doj_assess %>%
   distinct(cii)

 doj_assess %>%
   distinct() %>%
   add_count(cii) %>%
   filter(n > 1) %>%
   arrange(desc(n)) %>%
   View()


#CIIs for DOJ
doj_cii <- bind_rows(doj_book %>% select(cii), doj_court %>% select(cii), doj_assess %>% select(cii)) %>% distinct()

doj_court <- doj_court %>%
  mutate_if(is.character, funs(trimws(gsub("[^[:alnum:]]", "", .)))) %>%
  mutate_if(is.character, funs(if_else(. == "", NA_character_, .))) 

#Create an excel workbook with all data table. Make sure to include the cii table first. 
write.xlsx(list(doj_cii, doj_book, doj_court, doj_assess), file = "G:/CrimJustice/PretrialAssessmentPilot/CIIs for DOJ/February 2021/Nevada P3 CIIs and Demographics for DOJ.xlsx", sheetName = c("ciis", "booking", "court", "assess"))


 
```


Jail Court Join Post-Collapse
```{r}
# Pull in Agency Collapsed Data made for Noah in December

assess_df <- fread("G:/CrimJustice/PretrialAssessmentPilot/Agency Collapse CSV Files/Nevada Assessment Collapse.csv") %>%
  mutate(across(contains("time"), as_datetime)) %>%
  mutate(across(c(contains("date"),"dob") & is.character, as_date))

book_df <- fread("G:/CrimJustice/PretrialAssessmentPilot/Agency Collapse CSV Files/Nevada Booking Collapse.csv")%>%
  mutate(across(contains("time"), as_datetime)) %>%
  mutate(across(c(contains("date"),"dob") & is.character, as_date)) %>%
  mutate(across(where(is.character), ~if_else(.x == "", NA_character_, .x)))

court_df <- fread("G:/CrimJustice/PretrialAssessmentPilot/Agency Collapse CSV Files/Nevada Court Collapse.csv")%>%
  mutate(across(contains("time"), as_datetime)) %>%
  mutate(across(c(contains("date"),"dob") & is.character, as_date)) %>%
  mutate(across(where(is.character), ~if_else(.x == "", NA_character_, .x)))
  

names(book_df)[names(book_df) %in% names(court_df)]


# look for share cases in book cases that match a court case (26.2%)
nrow(book_df %>%
    semi_join(court_df, by = c("court_case_id"), na_matches = "never"))/nrow(book_df) 

# Look share cases in court_df that match book_df (33.8%)
nrow(court_df %>%
    semi_join(book_df, by = c("court_case_id"), na_matches = "never"))/nrow(court_df) 


# Join by court_case_id
join_df <- book_df %>%
  #mutate(book_num= as.character(book_num)) %>%
  left_join(court_df, by = c("court_case_id"), na_matches = "never") %>%
  select(-contains(".y")) %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x", "", .)))

```

Post-collapse join of Assessment and joined Court/Jail
```{r}
#Join Assessment data to court/jail joined data match rate = 48.7
# 

names(join_df)[names(join_df) %in% names(assess_df)]

nrow(assess_df %>%
  left_join(join_df, by = c("first_name", "last_name", "dob"), na_matches = "never") %>%
  select(-contains(".y")) %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x", "", .))) %>%
  filter(assessment_date >= book_date) %>%
  filter(assessment_date <= book_date + 2) %>%
  distinct(pretrial_id2, .keep_all = T) )/nrow(assess_df %>% distinct(pretrial_id2, .keep_all = T))



join_df2 <- join_df %>%
  mutate(bookplus_date = book_date + 2) %>%
  fuzzy_left_join(assess_df, 
                by=c("first_name", "last_name", "dob", "book_date"="assessment_date",
                     "bookplus_date"="assessment_date"),
                match_fun=list(`==`, `==`, `==`, `<=`, `>=`))%>%
  select(-contains(".y")) %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x", "", .)))

  
```

Final Collapse
```{r}

# look into keeping the highest charge description
join_collapse <- join_df2 %>%
  mutate(across (c(contains("flag"), contains("_count")), ~if_else(is.na(.x), as.integer(0), as.integer(.x)))) %>%
  mutate(release_type = ordered(release_type, levels = c("Unknown", "Other", "Sentenced", "Time_Served",
                                                         "Detain_Only", "Dismissed_Dropped", "OR",
                                                         "Bail_Bond", "Cite_Release", "Hold_Release"))) %>%
 group_by(book_num) %>%
  mutate(release_type = max(release_type)) %>%
  mutate(across(c(contains("sup_vio"), -contains("_count")), max)) %>%
  mutate(across(c(contains("sup_vio_flag_count")), sum)) %>%
  ungroup() %>%
  # Nevada has no sentence dates, so final dispo date is just dispo date
  filter(disposition_date >= book_date, book_type %in% c("On_View", "Bench_Warrant", "Other_Warrant")) %>%
  group_by(book_num) %>%
  mutate(across(c(contains("flag"), -contains("_count")), max)) %>%
  mutate(across(c(contains("_count"), -contains("sup_vio_flag_count")), sum)) %>%
  ungroup() %>%
  distinct(book_num, .keep_all = T)
  

fwrite(join_collapse, "G:/CrimJustice/PretrialAssessmentPilot/Agency Collapse CSV Files/Nevada Join Collapse.csv")

join_df2 %>%
  select(contains("sup_vio"))

court_df %>%
  select(contains("sentence"))

summary(join_collapse$hierarchy)
```

# San Mateo
San Mateo Jail Data
```{r eval=FALSE, include=FALSE}
# Jail Bookings Data Import--- San Mateo, P3 cummulative book dates 2015-01-01 to 12-31-2020
  ## book_df contains one row per booking/charge and includes information on the person, the time of booking and release,contains charge      information, bail amount.
  ## book_num has suffix (.1, .2,...)
 
 
####

#Keeping the commented out lines below only for source file on original names of variables, this is old Booking Data but it has column headers. 
# initially San Mateo did not  filter on both bookings and releases in their historical data extract. Extract dates fixed in 8/7/2020        extract Jan 2015-June 30, 2020
# book_df <- fread("Historical Data Submissions/San Mateo/41-SO-01OF01-JAN2015-JUN2019.csv")

####

#ranfom test cahnge

#San Mateo Jail Data Import
  ## New data was submitted on 1/11/2021 and has IDs used by probation, they added local_id and added booking number 
  ## file did not include column names, I used the same names statement from the old files to check if the order was the same and it is
  ##  cdl_id_2 is actually a partially empty, partial duplicate of cdl_id.  
  ## book_date range 2015-01-01 to 12-31-2020
  ## release_date range 1/1/2015 to 1/4/2021
  ## arrest_date starts with 1/1/1900 but otherwise looks normal ends at 12/31/2021
  ##missing court_case_ids 45K/230K may not be a problem about 20% dont have court case id

#files are cumultive keeping P2 for reference only
# book_df_old <- read_csv("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/San Mateo/P2 Submission-June 30/41-SO-01OF01-JAN2015-SEP2020.csv", col_names = F, col_types = cols( X1= "c", .default="?"))

book_df <- read_csv("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/San Mateo/P3 Submission-Jan 15/41-SO-01OF01-JAN2015-DEC2020.csv", col_names = F, col_types = cols( X1= "c", .default="?"))

# Variable name standardization--See pg. xxx for more details. 
  
names(book_df) <- c("cii", "name", "dob", "fbi", "cdl_id_2", "cdl_id", "sex_original", "race_original", "arrest_date_time", "book_num", "book_date_time", "book_type_original", "court_case_id", "arrest_charge_original", "arrest_charge_level_original", "release_date_time", "release_type_original", "bail_amt", "conviction_date", "conviction_charge", "employment_status", "local_id", "book_num2")



# Date Reformatting (also name reformat)--See pg. xxx for more details.
  ## 8 rows arrest dates 1900-01-01 00:00
  ## 4 rows arrest dates 1919 when probably should be 2019
book_df <- book_df %>%
  select(-c(conviction_date, conviction_charge, employment_status, book_num2)) %>%
   mutate(arrest_date = as_date(arrest_date_time),
         book_date = as_date(book_date_time),
         release_date = as_date(release_date_time),
         dob = mdy(dob),
         name2 = str_sub(name, end=-2),
         first_name = gsub(".*, ", "", name2),
         last_name= gsub("(?=,).*$", "", name2, perl=TRUE),
         cdl_id = gsub("NONE|NONE ISSUED", "", cdl_id)) 

   
# Standardize Factors
  ## No employment data provided
book_df <- book_df %>%
  mutate(sex = case_when(sex_original %in% c("U", "") ~ "Other_Unknown",
                         sex_original %in% c("M") ~ "Male",
                         sex_original %in% c("F") ~ "Female"),

         race = case_when(race_original %in% c("B") ~ "Black",
                          race_original %in% c("H") ~ "Hispanic",
                          race_original %in% c("W") ~ "White",
                          T ~ "Other_Unknown"), 
         
         book_type = case_when(book_type_original %in% c("LOCAL WARRANT") ~ "Bench_Warrant",
                               book_type_original %in% c("COMMITMENT") ~ "Commitment",
                               book_type_original %in% c("FOREIGN HOLD - STATE SENTENCED", "FOREIGN HOLD - COMMITMENT",
                                                         "FOREIGN HOLD - DETAINER", "FOREIGN HOLD - OTHER", "FOREIGN HOLD - PAROLE", 
                                                         "FOREIGN HOLD - IMMIGRATION" ) ~ "Hold",
                               book_type_original %in% c("FOREIGN WARRANT") ~ "Other_Warrant",
                               book_type_original %in% c("") ~ "Unknown",
                               book_type_original %in% c("REMAND") ~ "Court_Order",
                               book_type_original %in% c("OPEN CHARGES") ~ "On_View",
                               book_type_original %in% c("PROBATION HOLD 1203.2", "PAROLE PC 3056", "PAROLE PC 3000.08",
                                                         "PRCS REVOCATION PC 3455(a)", 
                                                          "MANDATORY SUPERVISION REVOCATION PC 1170(H)(5)(B)", 
                                                         "FLASH INCARCERATION PC 3454(b)") ~ "Sup_Vio_Post",
                                                          T ~ "Other"),

         release_type = case_when(release_type_original %in% c("PROMISE TO APPEAR","LAW ENFORCEMENT RELEASE") ~ "Cite_Release",
                                  release_type_original %in% c("TIME SERVED") ~ "Time_Served",
                                  release_type_original %in% c("SURETY BOND POSTED", "CHECK BAIL", "CASH BAIL POSTED") ~ "Bail_Bond",
                                  release_type_original %in% c("CASE DISMISSED") ~ "Dismissed_Dropped",
                                  release_type_original %in% c("OWN-RECOGNIZANCE") ~ "OR",
                                  release_type_original %in% c("COURT ORDERED RELEASE") ~ "Court_Order",
                                  release_type_original %in% c("") ~ "Unknown",
                                  release_type_original %in% c("849(b)", "849(B)") ~ "Detain_Only",
                                  release_type_original %in% c("RELEASE TO OTHER AGENCY", "RELEASED TO OTHER AGENCY", 
                                                               "SENTENCED TO CDCR", "RELEASED ON DETAINER") ~ "Hold_Release", 
                                  release_type_original %in% c( "SENTENCED TO CDCR") ~ "Prison",
                                  release_type_original %in% c( "COMPULSORY - AFTER SENTENCING") ~ "Sent_Cap",
                                  release_type_original %in% c( "COMPULSORY - BEFORE SENTENCING") ~ "Unsent_Cap",
                                  
                                  T ~ "Other"))

  ##San Mateo has multiple release types that we dont capture: COVID-Early Release, COVID-pretrial court order, COVID-PTA        


# Standardize Charges, Join Hierarchy and flag construction
 ## some charges separated by slash /
 ## some charges end in "2ND" or "1ST"
 ## "30600  ENHANCEMENT " 8 rows
 ## most end in code: PC, VC, HS, BP, WI, CP, IC, MC, SC, 
book_df <- book_df %>%
  mutate(arrest_charge_code = gsub(".* ", "", arrest_charge_original),
         arrest_charge_code = if_else(arrest_charge_code=="USC", "US", arrest_charge_code),
         arrest_charge_code = if_else(!arrest_charge_code %in% c("PC", "VC", "HS", "BP", "WI", "US"), "Other", arrest_charge_code),
         arrest_charge_level = if_else(!arrest_charge_level_original %in% c("F", "I", "M"), "Other", arrest_charge_level_original),
         arrest_charge = gsub(">.*| .*|MISD|FEL|-FEL|INF" , "", arrest_charge_original),
         arrest_attempt_flag = if_else(grepl("664", arrest_charge_original), 1, 0),
         arrest_charge = gsub("664/", "", arrest_charge)) %>%
         separate_rows(arrest_charge, sep = "/") %>%
         mutate(arrest_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\-.*","", arrest_charge))) %>%
  unite(join_var, arrest_charge_level, arrest_charge_code, arrest_charge, remove = F)

  
# Code for Charge Hierarchy
load("G:/CrimJustice/PretrialAssessmentPilot/Complete Charge Code Hierarchy.RData")

#remove these flags because they are messing up the final join of court and jail data
charge_hier <- charge_hier %>%
  select (-c(fta_flag))


book_df <- left_join(book_df, charge_hier, by = "join_var")
  

# are we supposed to be adding all of these flags?  I am wondering most about the fta_flag
book_df<- book_df %>%
    mutate(arrest_misd_flag=if_else(arrest_charge_level=="M", 1, 0),
           arrest_felony_flag =if_else(arrest_charge_level=="F", 1, 0),
           arrest_attempt_flag=if_else(arrest_charge=="664", 1, arrest_attempt_flag),
           # not seeing any qualifier charges here  arrest_qualifier_flag=if_else()
           sup_vio_post_flag=if_else(book_type=="Sup_Vio_Post", 1, 0),
           fta_flag=if_else(arrest_charge%in% c("8537", "1320A", "1320B", "13205", "40508A"), 1, 0))  
```

Jail Collapse
```{r}
# Booking Collapse--See pg. xxx for more details about this process. 
 ## No join step needed because there is only 1 booking table
 ## Grouped by book_num rather than (book_num and book_date) otherwise some court case ID's would be lost
 ## ungroup not in Noah's code, what does it do, does it matter

book_df <- book_df %>%
  mutate(time_first_release = release_date_time - book_date_time) %>%
  mutate(hierarchy = if_else(is.na(hierarchy), 1e6, as.numeric(hierarchy))) %>%
  group_by(book_num, court_case_id) %>%
  # mutate(max_booktype = book_type[hierarchy == min(hierarchy)][1],
  #       max_arrest_charge = arrest_charge[hierarchy == min(hierarchy)][1],
  #        max_charge_description = master_charge_description[hierarchy == min(hierarchy)][1],
  #        max_hier = min(hierarchy)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, .))) %>%
  mutate_at(vars(contains("flag")), funs("count" = sum(.))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  mutate(join_var = paste(join_var, collapse = " ")) %>%
  filter(hierarchy == min(hierarchy)) %>%
  ungroup() %>%
  distinct(book_num, court_case_id, .keep_all = T)

save(book_df, file = "G:/CrimJustice/PretrialAssessmentPilot/Agency Collapse CSV Files/San Mateo Booking Collapse.RData")

```

San Mateo Jail Diagnostics
```{r eval=FALSE, include=FALSE}


# Jail Diagnostics

##Period 3 jail diagnostics
 # check dates (recorded at top of input code)
summary(book_df$book_date) 
summary(book_df$arrest_date)
summary(book_df$release_date)

 #completeness of data elements
str(book_df)


#Are the contents mostly complete? 

lapply(book_df, function(i){
  if (is.character(i)==T){
    sum(is.na(i)|i=="NULL")
  }
  else{
    sum(is.na(i))
  }
})

lapply(book_df, function(i){
  if(length (unique(i)) <=50)
    table(i, useNA="always")})


##Period 2 jail diagnostics
summary(book_df$book_date)     
str(book_df)
lapply(book_df, function(i){if(length(unique(i)) <= 50) table (i, useNA="always")})



book_df %>%
  distinct(book_num, court_case_id) %>%
  arrange(book_num) %>%
  group_by(book_num) %>%
  add_count() %>%
  filter(n>1)

book_df %>%
  distinct(book_num, book_date) 
book_df %>%
  filter(grepl("0771037", book_num))

book_df %>%
  distinct()%>%
  arrange (book_num)

book_df %>%  
 filter(grepl("0709937", book_num))

# book_num_gs distinct=84,681
test <- book_df %>%
  mutate(book_num_gs = gsub("\\.[0-9]*", "" , book_num )) 

# book_num, book_date  distinct=84,681
test %>%
  distinct(book_num, book_date) %>%
  arrange(book_num)



book_df %>%
  count(arrest_charge_level_original)

book_df %>%
  filter(grepl("/", arrest_charge_original)) %>%
  count(arrest_charge) %>%
  arrange(desc(n))

book_df %>%
  filter(grepl)
  count(arrest_charge_original) %>%
  arrange(desc(n))

 
  
  mutate(attempt = if_else(grepl("^664\\/", arrest_charge_original), 1, 0)) %>%
  separate_rows(arrest_charge_original, sep = "\\\\|\\/") %>%
  mutate(
    # arrest_charge_code_original = paste0(strapplyc(charge_original, "^([A-Z]{2}).*", simplify = T)),
         # code_type = ifelse(code_type == "character(0)", NA, code_type),
         # code_type = na.locf(code_type),
         arrest_charge_level = str_extract(arrest_charge_level_original, "^(.).*"),
         # #Collapsing charge in this way does not result in any mismatched charges
         arrest_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}","", arrest_charge_original)))
         # cii = as.numeric(gsub("[^0-9]", "", cii)),
         # conspire = if_else(grepl("^CONSPIRE", charge_description), 1, 0))
  
# No code section in these data
#book_df$arrest_charge_code <- NA

df <- tibble(x = 1:5, y = c("a,b,c", "F", "H, I, J", "L", "V"))

df %>%
  separate_rows(y, sep = ",")

# Diagnostic Code for Charge Hierarchy
# 1 - 7,901/267,372 = 97% non-match rate
(1 - nrow(book_df %>% filter(is.na(hierarchy)))/nrow(book_df))*100

book_df %>%
  filter(is.na(hierarchy)) %>%
  count(join_var) %>%
  arrange(desc(n))

# the most common unmatching code is Other_Other_  which is almost all foreign warrants, foreign_holds committments, and F_PC_13892 it is a #foregin hold detainer, F_PC_3454B is flash incarceration, F_PC_120221 allways has an enhancement in the orginal arrest charge.
# M_VC_23578 this code says if a person is convicted of a violation of Section 23152 or 23153 and refuses breathalyzer or has BAC >.15 it is #a special factor for imposting penalties

book_df%>%
  filter(grepl("0771037", book_num))%>%
  group_by(book_type_original)%>%
  count()


```

San Mateo Court Data
```{r eval=FALSE, include=FALSE}
# Court Case Data Import--- San Mateo, 1/4/2016  to 9/30/2020
  ## court_df contains multiple rows per court case, 1 for a complaint/indictment and another if there is an information. It also includes demographics on the person.
  ## the letters at the end of the case number indicate co-defendants (eg -A and -B for co-defendants)
  ## Only felonies have an associated HTA suffix. If at the prelim or before defendant admits or pleads NOLO the disposition            will show certified up but no HTA case is created.  The case num starts out in the form of 16-NF-000086-A. When the matter is held to answer the original case gets the HTA added and a new case is created when the information is filed with the same number as it started out minus the HTA. (st...I think this means we strip off HTA and sort by  date, cases start with complaints or indictments)
  ## court_sentence data  contains case type, case case status, charges, pleas and sentence information. 
  ## court_hearing data contains files date, case_type, hearing dates and types, hearing results and fta, and fta warrants
    

####

# Readin Earlier Periods for Court Cases
court_df1 <- fread("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/San Mateo/41-COURT-01OF03-JAN2016-SEP2019.csv", na.strings=c("NULL",""), colClasses = "character") 

court_df2<- fread("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/San Mateo/41-COURT-01OF03-OCT2019-DEC2019.csv", na.strings=c("NULL",""), colClasses = "character")
                    
court_df3<- fread("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/San Mateo/P2 Submission-June 30/41-COURT-01OF03-JAN2020-JUN2020.csv", na.strings=c("NULL",""), colClasses = "character")
                    
court_df4<- fread("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/San Mateo/P2 Submission-June 30/41-COURT-01OF03-JUL2020-SEP2020.csv", na.strings=c("NULL",""), colClasses = "character")
 
# Readin P3 Court Cases
court_df5 <- fread("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/San Mateo/P3 Submission-Jan 15/41-COURT-01OF03-OCT2020-DEC2020.csv", na.strings=c("NULL",""), colClasses = "character") 


#Removing duplicates between submission 1 2, 3, 4, 5
court_df1 <- court_df1 %>% 
  anti_join(court_df2, by = "CaseNbr") %>%
  anti_join(court_df3, by = "CaseNbr") %>%
  anti_join(court_df4, by = "CaseNbr") %>%
  anti_join(court_df5, by = "CaseNbr") 
  
court_df2 <- court_df2 %>% 
  anti_join(court_df3, by = "CaseNbr") %>%
  anti_join(court_df4, by = "CaseNbr") %>%
  anti_join(court_df5, by = "CaseNbr") 
 

court_df3 <- court_df3 %>% 
  anti_join(court_df4, by = "CaseNbr") %>%
  anti_join(court_df5, by = "CaseNbr") 
 

court_df4 <- court_df4 %>% 
  anti_join(court_df5, by = "CaseNbr") 
 

court_df <- bind_rows(court_df1, court_df2, court_df3, court_df4, court_df5) %>%
  distinct()

rm(court_df1, court_df2, court_df3, court_df4, court_df5)


# Variable name standardization--See pg. xxx for more details. 
names(court_df) <- c("court_docket_id", "court_case_id_original", "file_date", "court_case_type",
                     "court_party_id", "cii", "fbi","local_id", "cdl_id", "name", "dob",
                     "sex_original", "race_original")

# Date Reformatting--See pg. xxx for more details.
court_df <- court_df %>%
     mutate(dob = as_date(dob)) %>%
      mutate_at(vars(contains("date")), funs(if_else(grepl("/", .), mdy(.), as_date(.))))


# Standardize Factors, also standardize name formatting--See pg. xxx for more details.
court_df <- court_df %>%
     ## remove -HTA from court_case_id_original so that information and complaint will have the same court_case_id since they are the same case at different stages
   mutate(court_case_id = gsub("-HTA", "", court_case_id_original)) %>%
    mutate(cii = as.character(cii)) %>%
    mutate(sex = case_when(sex_original %in% c("M") ~ "Male",
                         sex_original %in% c("F") ~ "Female",
                         T~"Other_Unknown"),
         race = case_when(race_original %in% c("Black") ~ "Black",
                          race_original %in% c("Hispanic") ~ "Hispanic",
                          race_original %in% c("White") ~ "White",
                          T ~ "Other_Unknown"),
        name = toupper(name)) %>% 
        separate(name, c("last_name", "first_name", "suffix"),  sep = ",") %>%
        mutate_at(vars(first_name, last_name, suffix), trimws) %>%
        separate(first_name, c("first_name", "middle_name"), sep = " ") 
       


####

# Court Sentences and Court Filing Charges 
 ## court sentence contains all of the court charge data
 ## court_sentence contains one row per charge (charge_id) (with about 400 repeats, likely from when separate_rows was used to divide combined charges, for example PC484-490.1)
 ## dropping sentence location, it was in the first extract, but not in second extract, we don't need that variable for analysis
 ## historical data submitted had to be stripped of new line characters in the middle of lines that interfered with reading the data in
 ##All dates are correct in court_charge they all end as expected at the end of P3 (Dec 31/2020) or in Jan of 2021, and all have a min date of 1/4/16 or earlier.

court_charge <- read_file("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/San Mateo/41-COURT-02OF03-JAN2016-SEP2019.csv")

court_charge <- gsub("\n,", ",", court_charge)

court_charge <- read_csv(court_charge, col_types = "cccccccccccccccccccccccc_cccccccc", na = c("", "NULL")) 


# all arrest dates are missing from this file
court_charge_1 <- fread("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/San Mateo/41-COURT-02OF03-OCT2019-DEC2019.csv", na.strings=c("NULL",""), colClasses =
                          c(rep("character", 32))) 
  

court_charge_2 <- fread("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/San Mateo/P2 Submission-June 30/41-COURT-02OF03-JAN2020-JUN2020.csv", na.strings=c("NULL",""), colClasses = c(rep("character", 32))) 
  

court_charge_3 <- fread("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/San Mateo/P2 Submission-June 30/41-COURT-02OF03-JUL2020-SEP2020.csv", na.strings=c("NULL",""), colClasses = c(rep("character", 32))) 
 
                        

court_charge_4<- fread("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/San Mateo/P3 Submission-Jan 15/41-COURT-02OF03-OCT2020-DEC2020.csv", na.strings=c("NULL",""), colClasses = c(rep("character", 32)))  
  




#Removing duplicates between submission 1 2, 3, 4
court_charge <- court_charge %>% 
  anti_join(court_charge_1, by = "CaseNbr") %>%
  anti_join(court_charge_2, by = "CaseNbr") %>%
  anti_join(court_charge_3, by = "CaseNbr") %>%
  anti_join(court_charge_4, by = "CaseNbr")

court_charge_1 <- court_charge_1 %>% 
  anti_join(court_charge_2, by = "CaseNbr") %>%
  anti_join(court_charge_3, by = "CaseNbr") %>%
  anti_join(court_charge_4, by = "CaseNbr")

court_charge_2 <- court_charge_2 %>% 
  anti_join(court_charge_3, by = "CaseNbr") %>%
  anti_join(court_charge_4, by = "CaseNbr")

court_charge_3 <- court_charge_3 %>% 
  anti_join(court_charge_4, by = "CaseNbr")

court_charge <- bind_rows(court_charge, court_charge_1, court_charge_2, court_charge_3,
                          court_charge_4) %>%
  distinct()

rm(court_charge_1, court_charge_2, court_charge_3, court_charge_4)
                           


# Variable name standardization--See pg. xxx for more details.
names(court_charge) <- c("court_docket_id", "court_case_id_original", "file_date", "court_case_type", "court_case_status_original", "court_case_status_date", "book_num", "arrest_date", "arrest_control", "arrest_agency", "offense_id", "charge_id", "charge_num", "offense_date", "court_charge_original", "court_charge_level_original", "court_charge_description", "plea_type_original", "plea_date", "disposition_type_original", "disposition_date", "final_date", "sentence_type_original", "sentence_date",  "probation_type", "term_years_probation", "term_months_probation", "term_days_probation", "jail_type", "term_years_jail", "term_months_jail", "term_days_jail")


# Date Reformatting--See pg. xxx for more details.
##the dates in this file are acting strange, some dates return an NA when min and max requested
court_charge   <- court_charge  %>%
  mutate_at(vars(contains("date")), funs(if_else(grepl("/", .), mdy(.), as_date(.))))


# Standardize Factors--See pg. xxx for more details.
court_charge <- court_charge %>%
     ## remove -HTA from court_case_id_original so that information and complaint will have the same court_case_id since they are the same case at different stages
   mutate(court_case_id = gsub("-HTA", "", court_case_id_original)) %>%
  mutate(
    disposition_type = case_when(
      disposition_type_original %in% c(
        "Dismissal: Negotiated Plea",
        "Dismissal: Insufficient Evidence",
        "Dismissal: Interest of Justice",
        "Dismissal: Motion of the People",
        "Dismissal: Lack of Prosecution",
        "Dismissal",
        "No Finding",
        "Dismissal: Other Dismissal",
        "Dismissal: Insufficient Grounds to HTA",
        "Dismissal: After Drug Court",
        "Dismissal: Civil Compromise",
        "Dismissal: After Military Diversion",
        "Dismissal: No Reason Available",
        "Dismissal: PC1100 -Insufficient Evid. -Witness for Co-Defend",
        "Dismissal: PC995",
        "Dismissal: Prop 64",
        "Dismissal: PC1385 PC-Furtherance of Justice",
        "Dismissal: After Deferred Entry of Judgment",
        "Dismissal: Other Dismissal",
        "Dismissal: After Diversion",
        "Dismissal: PC1377/1378-Case Compromise/Rest of Satis. Made",
        "Dismissal: Post Sentence",
        "Dismissal: PC1381/1381.5/1382-Delay; Not Timely",
        "Dismissal: PC995-Accusation Set Aside",
        "Dismissal: PC871-Court Found Insufficient Cause",
        "Dismissal: 1203.4"
      ) ~ "Dismissed",
      
      disposition_type_original %in% c(
        "Pled Nolo Contendere",
        "Pled Nolo Contendere Lesser Included Offense"
      ) ~ "Nolo_Contendere",
      
      disposition_type_original %in% c(
        "Admitted",
        "Found True",
        "Pled Guilty",
        "Jury verdict of guilty",
        "Sentenced: Plea of Guilty/Nolo Contendere",
        "Court trial found guilty",
        "Found True",
        "Found Guilty",
        "Found Guilty Lesser Included Offense"
      ) ~ "Gulity",
      
      disposition_type_original %in% c(
        "DOJ - Found Not Guilty",
        "Denied",
        "Dismissal: Insufficient Grounds to HTA",
        "Jury verdict of not guilty",
        "Found Not True",
        "Court trial found not guilty"
      ) ~ "Not_Guilty",
      
      disposition_type_original %in% c(
        "Held to Answer",
        "Certified to Superior Court: PN859",
        "Stricken",
        "Held to Answer",
        "Certified to Superior Court",
        "Not Held to Answer",
        "No Finding",
        "Extradited",
        "Consolidated",
        "Veteran's Treatment/Military Diversion",
        "NULL",
        "Mistrial",
        "Certified to Juvenile Court",
        "Certified to Superior Court: PG859"
      ) ~ "Other"
    ),
    
    plea_type = case_when(
      plea_type_original %in% c("No Contest / Nolo Contendere") ~ "Nolo_Contendere",
      plea_type_original %in% c("Admit", "Guilty") ~ "Guilty",
      plea_type_original %in% c("Deny", "Not Guilty", "Not Guilty by Reason of Insanity") ~ "Not_Guilty",
      plea_type_original %in% c("NULL", "Once in Jeopardy", "Traffic School") ~ "Other"
    ),
    
    sentence_type = case_when(
      sentence_type_original %in% c("Prison Sentence") ~ "Prison",
      sentence_type_original %in% c(
        "Sentenced  PC1170(h) - Straight",
        "Mandatory Supervision Violation Sentence",
        "Probation Violation Sentence",
        "Sentenced PC1170(h) - Split"
      ) ~ "Jail",
      sentence_type_original %in% c("Probation Sentence", "Sentenced Prop 36") ~ "Probation",
      sentence_type_original %in% c(
        "Sentenced",
        "DIVERSION",
        "na_missing",
        "Sentence Modified",
        "Drug Court Sentence",
        "DUI Court Sentence"
      ) ~ "Other"
    ),
    
    court_case_status = case_when(
      court_case_status_original %in% c("Active") ~ "Active",
      court_case_status_original %in% c("Closed") ~ "Inactive"
    )
  )



# Charge Standardization can't add Flag her because flags are in court hearing table below--See pg. xxx for more details.
court_charge <- court_charge %>%
  mutate(court_charge_code = str_extract(court_charge_original, "^([A-Z]{2})"),
         court_charge_code = if_else(!court_charge_code %in% c("PC", "VC", "HS", "BP", "WI", "US"), "Other", court_charge_code),
         court_charge = gsub("^[A-Z]{2}|^[A-Z]{3}", "", court_charge_original ),
         court_charge_level = if_else(court_charge_level_original  %in% c("F1"), "F" , court_charge_level_original),
         court_charge_level = if_else(!court_charge_level %in% c("F", "I", "M"), "Other", court_charge_level),
         court_attempt_flag = if_else(grepl("664", court_charge_original), 1, 0),
         court_charge = gsub("664-|-[a-z]$", "", court_charge))%>%
         separate_rows(court_charge, sep = "-") %>%
         mutate(court_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\-.*","", court_charge)))%>%
  unite(join_var, court_charge_level, court_charge_code, court_charge, remove = F) 


         
# Code for Charge Hierarchy and
#Flag Construction

load("G:/CrimJustice/PretrialAssessmentPilot/Complete Charge Code Hierarchy.RData")

 court_charge <- left_join(court_charge, charge_hier, by = "join_var") %>%
  mutate(felony_flag = if_else(court_charge_level == "F", 1, 0),
         misd_flag = if_else(court_charge_level == "M", 1, 0)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, as.numeric(.)))) %>%
  mutate_at(vars(contains("flag")), funs("conviction" = if_else(. == 1 & disposition_type %in% c("Guilty", "Nolo_Contendere"), 1, 0))) %>%
  rename_at(vars(contains("flag"), -contains("conviction")), funs(paste0("court_", .))) %>%
  rename_at(vars(contains("conviction")), funs(paste0("conviction_", gsub("_conviction", "", .))))  

 
####
 
# Court Hearings
  ## court_hearing contains one row per setting_id (a unique hearing event on each court case) and includes information about each hearing. 
  ## still organized by court case type (complaint, indictment, information), which are given a different suffix on the court_case_id which will need to be stripped in order to collapse to the court case
  ## NOTE: between tables court_case_id is formatted differently, fix this (aka remove dashes) across all the san mateo tables so that they will match later
  ##when all files combined the dates are correct they go from file date of Jan 2016 to  Dec 31 2020
court_hearing <- fread("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/San Mateo/41-COURT-03OF03-JAN2016-SEP2019.csv", na.strings = c("NULL", ""),  colClasses =
                         c(rep("character", 14)))  
     
   
 court_hearing_1 <-
   fread("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/San Mateo/41-COURT-03OF03-OCT2019-DEC2019.csv",  na.strings = c("NULL", ""),  colClasses =
           c(rep("character", 14)))  
       
 
court_hearing_2 <- 
  fread("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/San Mateo/P2 Submission-June 30/41-COURT-03OF03-JAN2020-JUN2020.csv",  na.strings = c("NULL",""), colClasses = c(rep("character", 14)))   
        
court_hearing_3 <-
   fread("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/San Mateo/P2 Submission-June 30/41-COURT-03OF03-JUL2020-SEP2020.csv",  na.strings = c("NULL",""), colClasses = c(rep("character", 14)))   
        
court_hearing_4<- fread("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/San Mateo/P3 Submission-Jan 15/41-COURT-03OF03-OCT2020-DEC2020.csv", na.strings=c("NULL",""), colClasses = c(rep("character", 14)))   
   

 #Removing duplicates between submission 1 2, 3, 4
court_hearing <- court_hearing %>% 
  anti_join(court_hearing_1, by = "CaseNbr") %>%
  anti_join(court_hearing_2, by = "CaseNbr") %>%
  anti_join(court_hearing_3, by = "CaseNbr") %>%
  anti_join(court_hearing_4, by = "CaseNbr")  

court_hearing_1 <- court_hearing_1 %>% 
  anti_join(court_hearing_2, by = "CaseNbr") %>%
  anti_join(court_hearing_3, by = "CaseNbr") %>%
  anti_join(court_hearing_4, by = "CaseNbr")  

court_hearing_2 <- court_hearing_2 %>%
  anti_join(court_hearing_3, by = "CaseNbr") %>%
  anti_join(court_hearing_4, by = "CaseNbr") 

court_hearing_3 <- court_hearing_3 %>%
  anti_join(court_hearing_4, by = "CaseNbr") 
 

court_hearing <- bind_rows(court_hearing, court_hearing_1, court_hearing_2, court_hearing_3, court_hearing_4) %>%
  distinct()

rm(court_hearing_1, court_hearing_2, court_hearing_3, court_hearing_4)

 
 
 
 names(court_hearing) <-
   c( "court_docket_id", "court_case_id_original", "file_date", "court_case_type", "setting_id",  "hearing_date", "hearing_type_loc", "court_loc", "hearing_type_code", "hearing_type_original",
     "hearing_result",  "hearing_date_next",  "fta", "fta_warrant" )
 
 
 # Date Reformatting--See pg. xxx for more details.
##the dates in this file are acting strange, some dates return an NA when min and max requested
court_hearing   <- court_hearing  %>%
  mutate_at(vars(contains("date")), funs(if_else(grepl("/", .), mdy(.), as_date(.))))


 court_hearing <- court_hearing %>%
   ## remove -HTA from court_case_id_original so that information and complaint will have the same court_case_id since they are the same case at different stages
   mutate(court_case_id = gsub("-HTA", "", court_case_id_original)) %>%
   mutate(
     hearing_type = case_when(
       hearing_type_original %in% c(
         "Arraignment",
         "Arraignment on Information",
         "Warrant-Arraignment",
         "Domestic Violence Complaint Arraignment",
         "Further Arraignment",
         "Arraignment - Felony Fugitive",
         "Arraignment FTA",
         "Arraignment on Information after Preliminary Hearing",
         "Arraignment Parole Violation"
       ) ~ "Arraignment",
       hearing_type_original %in% c(
         "Sentencing",
         "Probation Report and Sentencing",
         "Sentence Hearing",
         "Prob Report and Sentencing - Proof of Firearm Relinquishment",
         "Proof of Firearm and Ammo Relinquishment and Sentencing",
         "Restitution Memo and Sentencing",
         "Sentencing on Violation of Probation",
         "Surrender for execution of sentence",
         "Probation Report and Sentencing (DUI)"
       ) ~ "Sentencing",
       hearing_type_original %in% c(
         "Jury Trial",
         "Pretrial Conference",
         "Warrant-Failed to Appear",
         "To Trail",
         "Jury Trail",
         "Preliminary Hearing",
         "To Set",
         "Warrant-Arraignment",
         "Warrant-Arraignment",
         "Warrant-Arraignment",
         "Warrant-Arraignment",
         "Attorney and Plea",
         "PC 1538.5 motion",
         "Domestic Violence Pretrial",
         "Further Proceedings",
         "Continued Jury Trial",
         "Motion to Continue Trial Date",
         "Motion hearings",
         "Motion to Continue",
         "Disposition and To Set",
         "Pathways Intake",
         "Further O.R. Report",
         "Disposition",
         "Bail Motion",
         "Drug Court Status Hearing - Predisposition",
         "Reset",
         "Order for Return of Prisoner",
         "Pretrial and To Set",
         "Penal Code section 995 motion",
         "Warrant - Failure to comply",
         "Diversion Violation Arraignment",
         "ID of Counsel",
         "Military Diversion Review",
         "Veteran Treatment Court Review",
         "Marsden motion",
         "Review",
         "Warrant-Probation Violation",
         "Civil Compromise",
         "Drug Court Decision on Suitability for Drug Court Diversion",
         "Diversion Violation Conference",
         "Probation Violation Conference",
         "Motion to Consolidate",
         "Proof of Drivers License",
         "Receipt of Doctors Report",
         "Bail Bond Motion",
         "Military Diversion Intake",
         "Modification of Sentence",
         "Motion to Dismiss",
         "AB208 Diversion Violation Arr-Reinstate Criminal Proceeding",
         "Continued Preliminary Hearing",
         "Subpoenaed Records Status and Further Proceedings",
         "Probation Violation To Trail",
         "Extradition Review",
         "AB 208 Diversion Violation Conference",
         "Pitchess Motion",
         "Superior Court Review and To Set",
         "Motion to Compel",
         "Bail Review hearing",
         "Status of:",
         "Hearing on Demurrer",
         "Entry of Plea",
         "Diversion Violation to Trail",
         "Court Trial",
         "Status of Appeal",
         "Humphreys Hearing",
         "Probation Violation Arraignment",
         "Receipt of Subpoenaed Records",
         "Substitution of Attorney",
         "Petition to Extend Commitment",
         "Status Hearing",
         "AB 208 Diversion Violation to Trail",
         "Veteran Treatment Court Intake",
         "Drug Court Treatment Plan",
         "Motion - PC1203.4",
         "Drug Court Status Hearing - Post Disposition",
         "Faretta Motion",
         "Restoration of Competency Certification - PC 1372",
         "DEJ Violation Arr and Reinstate Criminal Proceedings",
         "Status Conference",
         "Identification Hearing",
         "Plea Hearings",
         "AB 208 Diversion Violation Arraignment",
         "Bail Bond Surrender",
         "Failure to Comply",
         "Proof of Completion",
         "Restitution Memo",
         "Motion to Vacate",
         "Receipt of Placement Report",
         "PC 1170.95 Petitions for Resentencing",
         "AB 208 Diversion Violation Hearing",
         "MDUI Court Review",
         "Motion to Quash",
         "Other hearing",
         "Proof of Enrollment",
         "Serna Motion (Right to Speedy Trial)",
         "Diversion hearing",
         "Order to Show Cause Hearing",
         "Proof of Firearm and Ammunition Relinquishment",
         "Probation Violation Hearing",
         "Appointment of Doctor(s)",
         "Mental Health Diversion Eligibility",
         "Doctors Report Referral",
         "Domestic Violence Probation Violation Pretrial",
         "Bridges Review Intake",
         "Hearing Re: Outpatient Status Pursuant to PC 1606",
         "Military Diversion Determination",
         "DEJ Violation Arraignment",
         "O.R. Review",
         "Bridges Review",
         "Motion - 17(b) PC",
         "Motion to Strike Prior Conviction(s)",
         "Motion to Withdraw as Attorney",
         "Domestic Violence Progress Report",
         "To Set Probation Violation",
         "Further Court Trial",
         "In Camera Hearing",
         "Mental Competence Hearing",
         "Restitution Hearing",
         "Disposition or To Set Probation Violation",
         "Hearing Re: Cert of Restoration of Competency PC 1372",
         "Order to Show Cause - Attorney",
         "Pathways Review",
         "Conference",
         "Placement Report Referral",
         "Resentencing/modification hearing",
         "Court Trial on Prior Convictions",
         "Pre-Court Trial",
         "Mental Competency Progress Report PC1370(b)(1)",
         "Proof of Restitution",
         "DEJ Violation Hearing",
         "Mental Health Diversion Suitability Hearing",
         "Petition for or Status of Commitment Regarding Competency",
         "Receipt of Medical Records",
         "Certificate of Rehabilitation and Pardon",
         "Court Trial Pursuant to PC 1026-1027",
         "DEJ Violation Pretrial",
         "Ruling on Submitted Matter",
         "Order to Show Cause - Witness",
         "Restitution Court Status Review",
         "To Set Mental Health Diversion Suitability Hearing",
         "Evidentiary Hearing",
         "Examination of Source of Bail",
         "To Set Bail",
         "Jury Trial PC 1367-68",
         "Jury Trial Pursuant to PC 1026-1027",
         "Referral to courthouse clinic for mental health evaluation",
         "Mandatory Supervision to Trail",
         "Order to Show Cause Re: Contempt",
         "Petition for Release of Commitment - PC 1026.2",
         "Petition of Writ for Habeas Corpus",
         "PRCS To Trail",
         "Return on Appeal",
         "HIV Test Results",
         "Mandatory Supervision Violation Arraignment",
         "Mandatory Supervision Violation Conference",
         "Mandatory Supervision Violation Hearing",
         "Motion for a new trial",
         "Pretrial on Probation Violation",
         "Proof of Firearms Ammo Relinquishment and Restitution Report",
         "Return on Appeal - Remittitur Issued",
         "Veteran Treatment Court Probation Violation",
         "Jury Trial - Prior Convictions",
         "Lifting of no contact order",
         "Mental Health Diversion Review",
         "Motion for Modification",
         "OSC hearing - Predisposition hearing",
         "Resentencing Pursuant to PC 1170.18",
         "Return after PC 1203.03 90-day Diagnostic",
         "Status of DA case filing",
         "Warrant-Mandatory Supervision Violation",
         "Discovery hearing",
         "Franklin Hearing",
         "Further Proceedings on Probation Violation",
         "Motion to Sanction",
         "Motion to Strike",
         "Parole Revocation Conference",
         "Petition Hearing",
         "Proof of Correction",
         "Resentencing Pursuant to Prop 64",
         "Veterans Treatment Court Graduation",
         "Superior Court Review",
         "Dispo/Confirm",
         "Mental Competency Progress Report PC1370(b)(1)"
       ) ~ "Other"
     )
   )
 
 #Flag Construction
 court_hearing <- court_hearing %>%
   mutate(
     fta_flag = if_else(fta_warrant == "Warrant", 1, 0),
     fta_nowar_flag = if_else(fta == "FTA", 1, 0)
   )

 
 ####

```

San Mateo Court Collapse 
```{r eval=FALSE, include=FALSE}
  ## court_case_id is formatted differently across cases, sometimes with dashes, and sometimes with leading file date year. Unclear whether the same cases may be formatted differently across tables, have not found any evidence of such. 


#Court df collapse
  ## sometimes there are multiple lines when a case has both a complaint and an information. In these cases we should just keep the complaint, or whatever was filed first
  ## -HTA was already removed from court_case_id in the standardization process
court_df2 <- court_df %>%
  arrange(file_date) %>%
  distinct(court_case_id, .keep_all = T)


# Court Charge Collapse--See pg. xxx for more details about this process. 
  ## plea_type_original is not updated even if final disposition reflects a guilty or nolo plea pursuant to negotiation after an initial not guilty plea
  ## therefore, guilty_plea_flag will be incorrect when a defendant has changed their plea 
  ## there are 2707 cases where guilty_plea_flag is 0, but disposition_type is guilty or nolo, 2609 of which have "Plea" or "Pled" in the original dispo type
court_dispo <- court_charge %>%   
  mutate(disposition_type = ordered(disposition_type, levels = c("Other", "Dismissed", "Not_Guilty", "Nolo_Contendere", "Guilty"))) %>%
  ## remove the -HTA from court case ids because they are the same as the court case ids without it, just are labeled differently at different stages
  mutate(court_case_id_original = court_case_id,
         court_case_id = gsub("-HTA", "", court_case_id_original)) %>%
  select(-c(charge_id,  offense_id)) %>%
  arrange(sentence_date) %>%
  mutate(guilty_plea_flag = if_else(plea_type %in% c("Guilty", "Nolo_Contendere"), 1, 0)) %>%
  group_by(court_case_id) %>%
  mutate(guilty_plea_flag = max(guilty_plea_flag)) %>%
  mutate(hierarchy = if_else(is.na(hierarchy), 1e6, as.numeric(hierarchy))) %>%
  mutate(disposition_date = max(disposition_date), disposition_type = max(disposition_type)) %>%
  # mutate(max_court_charge_level = court_charge_level[hierarchy == min(hierarchy)][1],
  #        max_court_charge_code = court_charge_code[hierarchy == min(hierarchy)][1],
  #        max_court_charge = court_charge[hierarchy == min(hierarchy)][1],
  #        max_charge_description = master_charge_description[hierarchy == min(hierarchy)][1],
  #        max_hier = min(hierarchy)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, .))) %>%
  mutate_at(vars(contains("flag")), funs("count" = sum(.))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  mutate(join_var = paste(join_var, collapse = " ")) %>%
  filter(hierarchy == min(hierarchy)) %>%
  ungroup() %>%
  distinct(court_case_id, .keep_all = T)



# Court FTAs are collapsed to each case. 
court_fta_war <- court_hearing %>%
  ## remove the -HTA from court case ids because they are the same as the court case ids without it, just are labeled differently at different stages
  mutate(court_case_id_original = court_case_id,
         court_case_id = gsub("-HTA", "", court_case_id_original)) %>%
  arrange(hearing_date) %>%
  group_by(court_case_id) %>%
  mutate(fta_date = min(hearing_date, na.rm = T)[fta_flag == 1][1]) %>%
  mutate(fta_flag = max(fta_flag),
         fta_flag_count = sum(fta_flag))%>%
  distinct(court_case_id, .keep_all = T) %>%  
  select(court_case_id, file_date, fta_flag, fta_nowar_flag, fta_date, fta_flag_count)



# Court hearings are filtered for arraignment information and collapsed to court case id
court_arraign <- court_hearing %>%
  ## remove the -HTA from court case ids because they are the same as the court case ids without it, just are labeled differently at different stages
  mutate(court_case_id_original = court_case_id,
         court_case_id = gsub("-HTA", "", court_case_id_original)) %>%
  filter(hearing_type == "Arraignment") %>%
  arrange(hearing_date) %>%
  rename(arraignment_date = hearing_date) %>%
  arrange(arraignment_date) %>%
  distinct(court_case_id, .keep_all = T) %>%
  select(court_case_id, arraignment_date)



# All data is joined.
court_df <- reduce(list(court_df2, court_dispo, court_fta_war, court_arraign), left_join, by = "court_case_id") %>%
  select(-contains(".y")) %>%
  select(-c(file_date)) %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x", "", .))) %>%
  mutate(pretrial_end_date = if_else(disposition_date <= sentence_date|is.na(sentence_date), disposition_date, sentence_date),
         conviction_flag = if_else(disposition_type %in% c("Guilty","Nolo_Contendere"), 1, 0))
 

# assumes that if all charges dismissed then its over



save(court_df, file = "G:/CrimJustice/PretrialAssessmentPilot/Agency Collapse CSV Files/San Mateo Court Collapse.RData")
```

San Mateo Court Diagnostics
```{r eval=FALSE, include=FALSE}

# Diagnostics Period 3
##are any essential data elements missing

str(court_df)
str(court_charge)
str(court_hearing)



## how well do tables match: court_df has 72714 distinct case_ids, 
##72,714 matches found in court_charge 100% match
##64,271 matches found in court_hearings_s3 88% match

court_df %>%
  distinct(court_case_id) %>%
  semi_join(court_charge, by = "court_case_id")

#Are the contents mostly complete? 
 ##court_df hardly any CIIs or FBIs but they do have a local_id that is complete. Race missing
 ## in about 14% of observations. All else looks good


lapply(court_charge, function(i){
  if (is.character(i)==T){
    sum(is.na(i)|i=="NULL")
  }
  else{
    sum(is.na(i))
  }
})

lapply(court_charge, function(i){
  if(length (unique(i)) <=50)
    table(i, useNA="always")})


summary(court_df$file_date)

##Are all dates coming through
summary(court_charge$plea_date)  
summary(court_charge$file_date)
summary(court_charge$arrest_date)
summary(court_charge$court_case_status_date)
summary(court_charge$offense_date)
summary(court_charge$final_date)
summary(court_charge$sentence_date)
summary(court_charge$disposition_date)

summary(court_hearing$file_date)
summary(court_hearing$hearing_date)
summary(court_hearing$hearing_date_next)

summary(court_df$file_date)



ls(court_charge)



charge_hier %>%
  filter(grepl("30800", hierarchy))

ls(charge_hier)

arrange(charge_hier, hierarchy)

court_hearing%>%
    count(hearing_type, sort=TRUE)

court_hearing %>%
  filter(grepl("0097379", court_docket_id))

court_hearing%>%
  filter(fta=="FTA")

# original_df[[4]] <- tibble(table_name = "court_hearing", original_field = original_field, modified_field = names(court_hearing))
court_hearing %>%
  count(hearing_type_code_description) %>%
  arrange(desc(n)) %>%
  mutate(hearing_type_code_description = paste0('"', hearing_type_code_description, '",'))

# Diagnostics for court collapse


court_fta_war %>%
  count(fta_flag)

# need to ask
full_join(court_fta %>% filter(fta_flag == 1), court_fta_war %>% filter(fta_flag == 1) %>% rename(fta_date = fta_war_date), by = c("court_case_id", "fta_date")) %>%
  filter(fta_all_flag != fta_flag) %>%
  add_count(court_case_id) %>%
  filter(n > 1) %>%
  arrange(court_case_id, fta_date)

court_hearing %>%
  count(hearing_type_original) %>%
  arrange(desc(n))
  
court_charge %>%
  filter(stage %in% c("DISPOSITION EVENT")) %>%
  select(-c(disposition_num, charge_id, charge_history_id, offense_id, disposition_hist_id, disposition_id, disposition_type_code, amend_reason_id, amend_reason))
  # filter(stage %in% c("Sentence Event")) %>%
  count(dispos) %>%
  arrange(desc(n))
  
court_dispo %>%
  distinct(court_case_id, disposition_date, .keep_all = T) %>%
  add_count(court_case_id) %>%
  filter(n > 1) %>%
  arrange(desc(n))

court_charge %>%
  filter(stage %in% c("PLEA EVENT")) %>%
  count(disposition_type_original) %>%
  arrange(desc(n))
  distinct(court_case_id, disposition_date, .keep_all = T) %>%
  add_count(court_case_id) %>%
  filter(n > 1) %>%
  arrange(desc(n))
  # select(-c(disposition_num, charge_id, charge_history_id, offense_id, disposition_hist_id, disposition_id, disposition_type_code, amend_reason_id, amend_reason))
  # filter(stage %in% c("Sentence Event")) %>%
  count(dispos) %>%
  arrange(desc(n))

court_charge %>%
  # filter(stage %in% c("CASE FILING")) %>%
  # filter(stage %in% c("SENTENCE EVENT", "DISPOSITION EVENT")) %>%
  # distinct(court_case_id) 
  count(stage)
  filter(court_case_id == "921214") 
  #Alameda end example
  
 ##Period 2 court diagnostics 
summary(court_hearing$file_date)     
str(court_hearing)
lapply(court_hearing, function(i){if(length(unique(i)) <= 50) table (i, useNA="always")}) 
court_charge %>%
  distinct(court_case_id)%>%
  semi_join(court_df, by="court_case_id")
 


##Period 2 court diagnostics
summary(court_charge$file_date)     
str(court_charge)
lapply(court_charge, function(i){if(length(unique(i)) <= 50) table (i, useNA="always")}) 
 
 
 
court_charge %>%
  add_count(charge_id) %>%
  filter(n>1) %>%
  arrange(charge_id)


# move to diagnostics when ready
court_df %>% 
  arrange(court_case_id, file_date) %>%
  select (court_docket_id, court_case_id, file_date, court_case_type, court_party_id)
   
# court_df diagnostics
#court_df  %>%
#court_df[, grepl("id", names(court_df))]

#court_df %>%
#distinct(court_docket_id, court_case_id)
#court_df %>%
#filter(is.na(court_docket_id))
#court_df %>%
#count(court_docket_id)
  

#court_df <- court_df %>%
  #mutate_at(vars(dob, file_date), as_date) these dates semm fine now

#court_df[, grepl("id", names(court_df))]


 #court_charge %>%  
   #arrange (court_case_id)
 #filter(grepl("2341697", court_docket_id))  
 #ls(court_charge)  
 #court_charge %>%  
 
 
  #filter(grepl("2341697", court_docket_id))  

# "M_VC_231035A" this charge never used during arrest usually arrest is DUI then they plead down to receless driving"wet"
# "Other_PC_6665" special allegation prior auto theft
           #sup_vio_post_flag=if_else(book_type=="Sup_Vio", 1, 0))

 
# write.csv(court_sentence[court_sentence$court_qualifier_flag == 1, c("court_charge_code", "court_charge",
#                                                                      "court_charge_original", 
#                                                                      "court_charge_level", "court_charge_level_original", 
#                                                                      "court_charge_description")],
#           file = "G:/CrimJustice/PretrialAssessmentPilot/Charge Definitions and Hierarchy/San_Mateo_Qualifier_Flags_Court_charges.csv")
# 
# table(court_sentence$court_qualifier_flag, useNA = "ifany")


court_dispo %>%
  filter(guilty_plea_flag == 0, disposition_type %in% c("Guilty", "Nolo_Contendere")) %>%
  count(grepl("Plea|Pled", disposition_type_original))


Diagnostic Code for Charge Hierarchy


# 1 - 7,901/267,372 = 97% non-match rate
(1 - nrow(court_sentence %>% filter(is.na(hierarchy)))/nrow(court_sentence))*100

court_sentence %>%
  filter(is.na(hierarchy)) %>%
  count(join_var) %>%
  arrange(desc(n))



court_sentence%>%
  filter(grepl("Other_PC_460A", join_var))%>%
  group_by()%>%
  count()


court_sentence %>%
  filter(grepl("2341697", court_docket_id))%>%
  count()

court_df %>%
filter(is.na(court_docket_id))

court_charge %>%
  filter(is.na(disposition_date))%>%
  select(disposition_date, sentence_date)

```

San Mateo Assessment Lastest submission on Data Sent 1/13/2021 
```{r}
# San Mateo Assessment Data Import
  ## this is their new data that I read in on 1/27/2021
  ## it has data (2072 observations).
  ## The old data they sent us did not have a booking number, and there was no way of joining it with the  jail data.  The old data set has data from 1/23/2020 when they went live to 6/30/2020.  If we want to salvage the vprai score an come up with a new joining method we can incorporate the old data, but for now we are just going forward with the new data.  The new data has a different set of variables to describe monitoring that do not exist in the old data.

#arrest dates range from 9/10/2002 to 12/31/2020
#book_dates range from 1/27/2020 to 12/31/2020
#assessment dates range from 8/26/2020 to 12/16/2021 but most assessmetn data is in the range of 8/26/2020 and 11/12/2020
 

# assess_df_old <- read_csv("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/San Mateo/P2 Submission-June 30/Pretrial Pilot eProb PROD data_10142020.csv", skip = 3) i this is old data read in that goes up to 10/15/2020.  The newest file contains all of the same data plus 3 more months

assess_df<-read_csv("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/San Mateo/P3 Submission-Jan 15/41-PROBATION-01OF01-JAN2020-DEC2020.csv")

names_df <- tibble(original_field = names(assess_df))

# Variable name standardization--See pg. xxx for more details.
names(assess_df) <- c("client_id","local_id", "book_num", "arrest_date",  "last_name", "first_name", "middle_name", "dob", "sex_original", "cii", "fbi", "ipid", "cdl_id", "hispanic_original", "race_original",  "zip_code", "book_date_time","assessment_date_time",  "vprair_tool_response_1", "vprair_tool_response_2", "vprair_tool_response_3", "vprair_tool_response_4", "vprair_tool_response_5", "vprair_tool_response_6", "vprair_tool_response_7", "vprair_tool_response_8",   "vprair_risk_score", "pretrial_release_type_original",  "release_recommendation_original", "release_type_at_arraign", "condition_drug_test_original", "conditions_cam_monitoring_original", "condition_gps_original", "condition_home_detention_original", "condition_curfew_original", "condition_search_original", "condition_stay_away_original", "condition_other_original", "num_fta" , "num_new_arrests", "office_ftas", "scram_vio", "gps_vio", "total_tc_violations", "num_court_reminders", "pretrial_termination_date",  "pretrial_termination_outcome_original")


# these vars in old extraction but not new one "pretrial_signature_date_time",  "tool_name"

names_df$field <- names(assess_df)

# Date Reformatting--See pg. xxx for more details.
assess_df <- assess_df %>%
  # in this extract they forgot to put the tool name in so I am adding it here
  mutate(tool_name = "VPRAI-R") %>%
  #mutate(assessment_date_time = parse_date_time(assessment_date_time, c('%m/%d/%Y %H:%M'))) %>%
  mutate_at (vars(assessment_date_time, book_date_time),  mdy_hm) %>% 
  mutate_at(vars(dob, arrest_date, pretrial_termination_date), mdy) %>%
  mutate (assessment_date = as_date(assessment_date_time),
          # pretrial_signature_date = as_date(pretrial_signature_date_time), no longer in data set
          book_date = as_date(book_date_time))

# Risk Score Standardization--Tool Response values are changed to their numeric point value.
assess_df <- assess_df %>%
  mutate(vprair_tool_response_1 = if_else(vprair_tool_response_1 == "Yes", 2, 0),
         vprair_tool_response_2 = if_else(vprair_tool_response_2 == "Yes", 3, 0),
         vprair_tool_response_3 = if_else(vprair_tool_response_3 == "Yes", 2, 0),
         vprair_tool_response_4 = if_else(vprair_tool_response_4 == "Yes", 2, 0),
         vprair_tool_response_5 = if_else(vprair_tool_response_5 == "Yes", 1, 0),
         vprair_tool_response_6 = if_else(vprair_tool_response_6 == "Yes", 1, 0),
         vprair_tool_response_7 = if_else(vprair_tool_response_7 == "Yes", 1, 0),
         vprair_tool_response_8 = if_else(vprair_tool_response_8 == "Yes", 2, 0))

# Standardize Factors--See pg. xxx for more details.
## 



assess_df <- assess_df%>%
  mutate(sex = case_when(sex_original %in% c("Male") ~ "Male",
                         sex_original %in% c("Female") ~ "Female",
                         T ~ "Other_Unknown"),
         race_original = trimws(race_original),
         race = case_when(hispanic_original %in% c("Hispanic or Latino") ~ "Hispanic",
                          race_original %in% c("Black or African American") ~ "Black",
                          race_original %in% c("Hispanic, Latino, or Spanish origin") ~ "Hispanic",
                          race_original %in% c("White") ~ "White",
                          T ~ "Other_Unknown"),
         release_recommendation = case_when(release_recommendation_original %in% c("MOR Basic", "MOR BASIC", 
                                                                                   "Mor Enhanced", "MOR Enhanced", 
                                                                                   "MOR Regular") ~ "Monitor",
                                             release_recommendation_original %in% c("Own Recognizance", "Promise to Appear") ~ "OR",
                                             release_recommendation_original %in% c("Denied") ~ "Detain",
                                             T  ~ "Other_Unknown"),
         # for Noah's tables I accidentally ran this on release_recommendation_original, instead of pretrial_release_type_original, the Tables should be re-run
         monitor_level = case_when(pretrial_release_type_original %in% c("MOR Basic", "MOR BASIC") ~ "Low",
                                   pretrial_release_type_original %in% c("MOR Regular") ~ "Medium",
                                   pretrial_release_type_original %in% c("Mor Enhanced", "MOR Enhanced") ~ "High",
                                   T  ~ "Other_Unknown"),   
         
        # we assume that monitoring level corresponds with risk level.
        # we assume pretrial_referral_disposition is the original release type.
        
        release_decision = case_when(pretrial_release_type_original %in% c("Own Recognizance", "Promise to Appear") ~ "OR",
                                      pretrial_release_type_original %in% c("MOR Basic", "MOR BASIC", "Mor Enhanced", 
                                                                   "MOR Enhanced", "MOR Regular") ~ "Monitor",
                                      pretrial_release_type_original %in% c("Denied") ~ "Detain",
                                      pretrial_release_type_original %in% c("Bailed Out", "DA declined to file", 
                                                                   "Dismissed", "DA Rejected") ~ "Ineligible",
                                      T ~ "Other_Unknown"),
          risk_level = case_when(vprair_risk_score %in% c("0", "1", "2", "3", "4") ~ "Low",
                                  vprair_risk_score %in% c("5", "6", "7", "8") ~ "Medium",                        
                                  vprair_risk_score %in% c( "9", "10" , "11", 
                                                           "12", "13", "14") ~ "High"),
        
        
          pretrial_release_type = case_when(pretrial_release_type_original %in% c("OR", "Promise to Appear", "Own Recognizance") ~ "OR",
                                      pretrial_release_type_original %in% c("MOR Basic", "MOR BASIC", "Mor Enhanced", 
                                                                   "MOR Enhanced", "MOR Regular") ~ "Monitor",
                                      pretrial_release_type_original %in% c("Denied") ~ "Detain",
                                      pretrial_release_type_original %in% c("Bailed Out") ~ "Bail_Bond", 
                                      pretrial_release_type_original %in% c("DA declined to file", "DA Rejected",
                                                                   "Case dismissed", "N/A", "Pending", "Pending Court", "Dismissed") ~ "Other_Unknown" ),
        
         pretrial_ineligible_reason = case_when(pretrial_release_type_original %in% c("Bailed Out") ~ "Bail_Bond",
                                                pretrial_release_type_original %in% c("DA declined to file" , 
                                                                              "Dismissed", "DA Rejected") ~ "Case_Disposed",
                                                T ~ "Other_Unknown"), 
         
         pretrial_termination_outcome = case_when(pretrial_termination_outcome_original %in% c("Closed - Successful") ~
                                                    "Successful",
                                                  pretrial_termination_outcome_original %in% c("Revoked and Bench Warrant", 
                                                                                              "Closed - Unsuccessful") ~
                                                   "Unsuccessful",
                                                  pretrial_termination_outcome_original %in%
                                                    c("Closed - Other") ~ "Other_Unknown"),

        
        #how come we sometimes see people who were terminated unsuccessfully who have no FTA, or new arrest or technical violations.  We are trying to define reason for termination with the reasons being FTA, new Arrest, abscond, violation, case disposed, not tracked , other unknown.      
        # are the technical violations somethihg you plan to collect in the future those field are unpopulated
         
         pretrial_termination_reason = case_when(pretrial_ineligible_reason %in% c("Case_Disposed") ~
                                                     "Case_Disposed",
                                                   pretrial_ineligible_reason %in% c("Bail_Bond") ~
                                                   "Not_Tracked",
                                                  T ~ "Other_Unknown"))
                                                




# Flag Standardization---See pg. xxx for more details.
  ## Need to find out what NA means in the context of recommended for release--looks like someone bails out or A declines to file before recommendation can be made
  ## already asked SM what is difference between OR and Promise to Appear, they are the same
  ## clarify that denied means recommend for detention?
  ## why so many people recommended for MOR enhanced
  ## under release type what does denied mean? does it mean bail set? 
  ## under release type what does N/A mean? does it mean bail set? 
  ## all pretrial termination dates are missing
 
 assess_df <- assess_df %>%
    mutate(assess_flag = if_else(is.na(assessment_date), 0, 1),
         rec_release_flag = if_else(release_recommendation %in% c("OR", "Monitor"), 1, 0),
         decision_release_flag = if_else(release_decision %in% c("OR", "Monitor"), 1, 0),
         #This field needs to come from the jail data.
         # pretrial_release_flag = if_else(),
         pretrial_override_flag = if_else(rec_release_flag != decision_release_flag & 
                                            !release_recommendation %in% c("Ineligible", "Other_Unknown") & 
                                            !release_decision %in% c("Ineligible", "Other_Unknown"), 1, 0),
         #rec_em_flag = if_else(grepl("SCRAM", toupper( )), 1, 0),
         # rec_phone_flag = if_else(),
         #rec_inperson_flag = if_else(),
         #rec_drug_test_flag = if_else(grepl("TEST", toupper( )), 1, 0),
         # rec_other_flag = if_else(),
         condition_em_flag = if_else(conditions_cam_monitoring_original=="Yes"|condition_gps_original=="Yes", 1, 0),
         # Does enhanced monitoring involve a a phone in?         
         condition_phone_flag = if_else(grepl("REGULAR|BASIC", toupper(pretrial_release_type_original)), 1, 0),
         # enhanced might not belong here becasue they have in-person ceck ins not phone check ins
         condition_inperson_flag = if_else(grepl("ENHANCED|REGULAR", toupper(pretrial_release_type_original)), 1, 0),
         condition_drug_test_flag = if_else(condition_drug_test_original=="Yes", 1, 0),
         # is stay away the same as no contact order
         #condition_no_contact_flag = if_else(grepl("NO CONTACT|136", toupper(release_conditions_original)), 1, 0),
         
         # num_court_date_reminders is not populated, will you be collecting data in the future
         court_date_reminder_flag = if_else(num_court_reminders > 0 , 1, 0),  
         # Transit service doesn't actually exist here.  
         # transit_service_flag = if_else(court_date_reminder_original == "TRANSIT", 1, 0),
         
         
         pretrial_violation_flag= if_else(pretrial_termination_outcome %in% 
                                            c("Unsuccessful"), 1, 0))

# This is code for making the Assessment Tables for the first legislative report
# add a leading zero to book_num in the assessment data so that the join with the jail data would work
# assess_df_new <- assess_df_new %>%
#    mutate(book_num = str_c("0", book_num))
# 
# 
# # we joined a few variables from the booking data to the assessment data by book_num.
# #we collapsed to a person date in the assessment data using local_id and assessment date.
# assess_df_new_join <- assess_df_new %>%
#   left_join(book_df %>%
#               select(book_num, charge_level), by = "book_num") %>%
#   mutate (charge_level = ordered(charge_level, levels = c("I", "M", "F"))) %>%
#   group_by(local_id, assessment_date) %>%
#   mutate(charge_level = max(charge_level, na.rm = T)) %>%
#   ungroup() %>%
#   distinct(local_id, assessment_date, .keep_all = T)
#  
# 
# # this is a little diagnostic to see whether we get the expected reductions in M and F that we expect  
# assess_df %>%
#   count(charge_level)
# 
# assess_df_new %>%
#   left_join(book_df %>%
#               select(book_num, charge_level), by = "book_num") %>%
#   count(charge_level)

 
# assess_df_new %>%
#   count(pretrial_release_type_original, pretrial_ineligible_reason) %>%
#   view()
 

```

San Mateo Assessment Collapse
```{r}
# Each row is a person/book number, assessment date combo some people have two assessments for the same booking
# this is already collapsed to the right level

# 
# assess_df_new_join <- assess_df_new %>%
#   left_join(book_df %>%
#               select(book_num, charge_level), by = "book_num") %>%
#   mutate (charge_level = ordered(charge_level, levels = c("I", "M", "F"))) %>%
#   group_by(local_id, assessment_date) %>%
#   mutate(charge_level = max(charge_level, na.rm = T)) %>%
#   ungroup() %>%
#   distinct(local_id, assessment_date, .keep_all = T)
# assess_df_new %>%
#   add_count(book_num, local_id) %>%
#   filter(n>1)

save(assess_df, file = "G:/CrimJustice/PretrialAssessmentPilot/Agency Collapse CSV Files/San Mateo Assessment Collapse.RData")
```


Assessment Tables 
```{r}
assess_table <- assess_df %>%
  # Collapse to each assessment.
  distinct(local_id, assessment_date, .keep_all = T) %>%
  # Filter for only those actually assessed
  filter(!is.na(assessment_date)) %>%
  # Create county name.
  mutate(county = "San Mateo")
  # Select relevant variables.
  
# no Monitoring Level still need to ask county, so removing monitor_level
 
# Save file  
save(assess_table, file = "G:/CrimJustice/PretrialAssessmentPilot/Assessment Output Tables/San Mateo Assessment Output 10-2020v2.RData")


```

San Mateo Assessment Diagnostics
```{r}

# Diagnostics Period 3
##are any essential data elements missing

str(assess_df)


## NA only 1 table how well do tables match: court_df has 72714 distinct case_ids, 
##72,714 matches found in court_charge 100% match
##64,271 matches found in court_hearings_s3 88% match

court_df %>%
  distinct(court_case_id) %>%
  semi_join(court_charge, by = "court_case_id")

#Are the contents mostly complete? 
 ##court_df hardly any CIIs or FBIs but they do have a local_id that is complete. Race missing
 ## in about 14% of observations. All else looks good


lapply(assess_df, function(i){
  if (is.character(i)==T){
    sum(is.na(i)|i=="NULL")
  }
  else{
    sum(is.na(i))
  }
})

lapply(assess_df, function(i){
  if(length (unique(i)) <=50)
    table(i, useNA="always")})




##Are all dates coming through
summary(assess_df$arrest_date)  
summary(assess_df$book_date)  
summary(assess_df$assessment_date)  




summary(assess_df$Assessment_Date_Time)     
str(court_df)
lapply(prob_df, function(i){if(length(unique(i)) <= 50) table (i, useNA="always")}) 
assess_df %>%
  count(pretrial_termination_outcome_original)


#Matching on lacal ID only leads to 9 matches between court and assessment data,
#Below I created test to see what the match rate would be on last_name and dob it was 327 matches
#the local ID in the court data has 41,784 unique local_ids, they have between 6 to 9 digits some with two leading zeros
#in the assessment data there are 401 unique local ids and most have 7 digits

test <- assess_df %>%
        mutate (name = toupper(name)) %>% 
        separate(name, c("last_name", "first_name", "suffix"),  sep = ",") %>%
        mutate_at(vars(first_name, last_name, suffix), trimws) %>%
        separate(first_name, c("first_name", "middle_name"), sep = " ")  

test %>%
  
  semi_join(court_df, by = c("last_name",  "first_name", "dob"))


assess_df %>%
  distinct(local_id) %>%
  count(local_id)

court_df %>%
  arrange (file_date)

ls()

summary(as.numeric(court_df$local_id))

court_df %>%
  filter (last_name =="SAMAYOA", first_name == "IRVIN")

```



DOJ CII/Linking Extraction
```{r}

# Grab Tables with CII
df <- sapply(ls()[which(sapply(ls(), function(i){
  sum(names(get(i)) %in% "cii")
 }) == 1)], get)

# Pull CII and other identifiers
doj_book <- book_df %>%
  select(cii, fbi, name, dob, cdl_id, race_original, sex_original) %>%
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) %>%
  distinct()


# doj_court <- df[[2]] %>%
#   select(cii, fbi, dob, race_original, sex_original, name, local_id) %>%
#   mutate(cii = parse_number(cii),
#          cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
#                          nchar(cii) == 7 ~ paste0("000", cii),
#                          nchar(cii) == 8 ~ paste0("00", cii),
#                          nchar(cii) == 9 ~ paste0("0", cii)),
#                          T ~ as.character(cii)),
#          cii = if_else(nchar(cii) != 10, NA_character_, cii)) %>%
#   distinct()
# 
# court_df %>%
#   filter(!is.na(cii))

# Examine missing ciis and duplicates on cii. 
# doj_book %>% #Off by about 55,000
#   distinct()
# 
# doj_book %>% 
#   distinct(cii)
# 
# doj_book %>% 
#   distinct() %>%
#   add_count(cii) %>%
#   filter(n > 1) %>%
#   arrange(desc(n)) %>% 
#   View()
# 
# doj_court %>% #Off by about 45,000
#   distinct()
# 
# doj_court %>% 
#   distinct(cii)
# 
# doj_court %>% 
#   distinct() %>%
#   add_count(cii) %>%
#   filter(n > 1) %>%
#   arrange(desc(n)) %>% 
#   View()
# 
# 
# doj_book %>% # Off by about 7,000
#   distinct()
# 
# doj_book %>% 
#   distinct(cii)

# doj_book %>% 
#   distinct() %>%
#   add_count(cii) %>%
#   filter(n > 1) %>%
#   arrange(desc(n)) %>% 
#   View()
# 
# doj_court %>% #Off by about 9,000
#   distinct()
# 
# doj_court %>% 
#   distinct(cii)
# 
# doj_court %>% 
#   distinct() %>%
#   add_count(cii) %>%
#   filter(n > 1) %>%
#   arrange(desc(n)) %>% 
#   View()

#CIIs for DOJ
doj_cii <- (doj_book %>% select(cii)) %>% distinct()


#Create an excel workbook with all data table. Make sure to include the cii table first. 
write.xlsx(list(doj_cii, doj_book), file = "CIIs for DOJ/San Mateo CIIs and Demographics for DOJ.xlsx", sheetName = c("ciis", "booking"))


```


P3 pulling CII's 
```{r eval=FALSE, include=FALSE}
# Grab Tables with CII
df_list <- sapply(
  ls()[which(sapply(ls(), function(i){
    sum(names(get(i)) %in% "cii")
    }) == 1)],
  function(j){
    df <- get(j)
    df <- df %>%
      select(any_of(c("cii", "cdl_id", "fbi", "last_name", "first_name", "middle_name", "dob", "sex_original", "race_original"))) %>%
       mutate(
         cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) %>%
  distinct()
 
})

# CIIs from assessment tables--
doj_assess <- bind_rows(df_list[[1]]) %>%
  mutate_all(as.character)

# CIIs from booking tables
doj_book <- bind_rows(df_list[[2]]) %>%
   mutate_all(as.character)
  
# CIIs from court tables
doj_court <- bind_rows(df_list[[3]]) %>%
   mutate_all(as.character)

#CIIs for DOJ
doj_cii <- bind_rows(doj_book %>% select(cii), doj_court %>% select(cii), doj_assess %>% select(cii))  %>% 
  distinct() %>%
  filter(nchar(cii) == 10)



#Create an excel workbook with all data table. Make sure to include the cii table first.--Note there are no ciis in the assessment data
write.xlsx(list(doj_cii, doj_book, doj_court, doj_assess), file = "G:/CrimJustice/PretrialAssessmentPilot/CIIs for DOJ/February 2021/San Mateo P3 CIIs and Demographics for DOJ.xlsx", sheetName = c("ciis", "booking", "court", "assess"))



```


Court Join with Jail
```{r}
# Pull in Agency Collapsed Data made for Noah in December

assess_df <- fread("G:/CrimJustice/PretrialAssessmentPilot/Agency Collapse CSV Files/San Mateo Assessment Collapse.csv") %>%
  mutate(across(contains("time"), as_datetime)) %>%
  mutate(across(contains("date") & is.character, as_date))

book_df <- fread("G:/CrimJustice/PretrialAssessmentPilot/Agency Collapse CSV Files/San Mateo Booking Collapse.csv")%>%
  mutate(across(contains("time"), as_datetime)) %>%
  mutate(across(contains("date") & is.character, as_date))

court_df <- fread("G:/CrimJustice/PretrialAssessmentPilot/Agency Collapse CSV Files/San Mateo Court Collapse.csv")%>%
  mutate(across(contains("time"), as_datetime)) %>%
  mutate(across(contains("date") & is.character, as_date)) %>%
  mutate(book_num = as.numeric(book_num))



#joining court df to book df on court case id, match rate jail to court = 0.406459, match rate court to jail = 0.5532302
# joining on fbi and arrest_date


nrow(book_df %>%
semi_join(court_df, by = c("court_case_id"), na_matches = "never"))/nrow(book_df)

nrow(court_df %>%
semi_join(book_df, by = c("court_case_id"), na_matches = "never"))/nrow(court_df)

court_df %>%
anti_join(book_df, by = c("court_case_id"), na_matches = "never") %>%
select (book_num, arrest_date, file_date, local_id, court_case_id)


# # first stage join by court_case_id
# join_df <- book_df %>%
# left_join(court_df, by = c("court_case_id"), na_matches = "never") %>%
# select(-contains(".y")) %>%
# rename_at(vars(contains(".x")), funs(gsub("\\.x", "", .)))

#Two stage join

#Joining jail and court data 

join_df1 <- book_df %>%
inner_join(court_df, by = "court_case_id", na_matches = "never") %>%
select(-contains(".y")) %>%
rename_at(vars(contains(".x")), funs(gsub("\\.x", "", .)))

j1 <- anti_join(book_df, court_df, by = "court_case_id", na_matches = "never")
c1 <- anti_join(court_df, book_df, by = "court_case_id", na_matches = "never")


#Examine if set of common variables is distinct--yes
semi_join(book_df, court_df, by = "court_case_id", na_matches = "never") %>%
distinct()

#Joining on fbi and arrest date
join2 <- left_join(j1, c1, by = c("fbi", "arrest_date"), na_matches = "never") %>%
rename_at(vars(contains(".x")), funs(gsub("\\.x$", "", .))) %>%
select(-contains(".y")) %>%
#1 Duplicate with missing dispositions which will be dropped later.
distinct()


j2 <- anti_join(j1, c1, by = c("fbi", "arrest_date"), na_matches = "never")
c2 <- anti_join(c1, j1, by = c("fbi", "arrest_date"), na_matches = "never")

#Examine if set of common variables is distinct--yes
semi_join(j1, c1, by = c("fbi", "arrest_date"), na_matches = "never") %>%
distinct()

join_df <- bind_rows(join_df1, join2)

```
Joining Assessment to joined booking and court data
```{r}
#Join Assessment data
# match rate form joined booking and court data with assessment data have a 85% match rate.  It would be very close to or equal to 100% except that assessment data contain an extra month of data (Oct. 2020) Jail/court joined data end at (Sept 30, 2020)


names(join_df)[names(join_df) %in% names(assess_df)]


nrow(assess_df %>%
       mutate(book_num= as.numeric(book_num)) %>%
       semi_join(join_df, by = c("book_num"), na_matches = "never"))/nrow(assess_df) 


# Join by book_num
join_df2 <- join_df %>%
  mutate(book_num= as.character(book_num)) %>%
  left_join(assess_df, by = c("book_num"), na_matches = "never") %>%
  select(-contains(".y")) %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x", "", .)))


join_df2 %>%
  group_by(book_num) %>%
  add_count(unique(release_type)) %>%
  filter(n >1) %>%
  arrange(book_num) 
  
  
```

Joining All Data Post-Collapse and then collapsing to final joined dataset--1 row for each booking, if there are multi cases for a single booking then that will be indicated with flags so we will have 1 booking/case/defendant with flags
```{r}
join_collapse <- join_df2 %>%
  mutate(across(contains("flag"), ~if_else(is.na(.x), as.integer(0), .x))) %>%
  mutate(release_type = ordered(release_type, levels = c("Unknown", "Other", "Sentenced", "Time_Served", "Detain_Only",
                                                         "Dismissed_Dropped", "OR",
                                                         "Bail_Bond", "Cite_Release", "Hold_Release"))) %>%
 group_by(book_num) %>%
  mutate(release_type = max(release_type)) %>%
  mutate(across(contains("sup_vio"), max)) %>%
  ungroup() %>%
  filter(final_disposition_date >= book_date, book_type %in% c("On_View", "Bench_Warrant", "Other_Warrant")) %>%
  group_by(book_num) %>%
  mutate(across(contains("flag"), max)) %>%
  ungroup() %>%
  distinct(book_num, .keep_all = T)


fwrite(join_collapse, "G:/CrimJustice/PretrialAssessmentPilot/Agency Collapse CSV Files/San Mateo Join Collapse.csv")

#we are currently having trouble with the number of assessments that drop out of the final dataset, why are they assessinbg so many people who are in on probation violations, and  why are their crrespoknding book_type not sup vio instead of bench warrants.

join_collapse %>%
  count(assess_flag)
assess_df %>%
  count(assess_flag)

join_df2 %>%
  filter(book_date > as_date("2020-08-04")) %>%
  count(assess_flag)
 
court_df %>%
  arrange(court_party_id)

summary(join_df2$assessment_date)
```

```{r}
book_df %>%
  select(court_case_id, arrest_date) %>%
  arrange(desc(arrest_date))

court_df %>%
  select(court_case_id, file_date)%>%
  arrange(desc(file_date))

names(book_df)[names(book_df) %in% names(court_df)]

court_df %>%
  filter(is.na(fbi))

court_df %>%
  semi_join(book_df, by = c("fbi", "arrest_date"), na_matches = "never") %>%
  semi_join(book_df, by ="court_case_id", na_matches = "never")
  
  

# Remove extraneous objects in the environment
#rm(list = ls()[!ls() %in% ls(pattern = "df")])

#Check for common variables
#names(book_df)[names(book_df) %in% names(assess_df)] no assessment data yet

names(book_df)[names(book_df) %in% names(court_df)]



#Turning NULL to NA to ensure non matching and removing generic charge info from data frames
book_df <- book_df %>%
  mutate_if(is.character, list(~na_if(., "NULL"))) %>%
  select(-c(charge, charge_level, charge_code)) %>%
  mutate_at(vars(first_name, last_name), toupper)

#assess_df <- assess_df %>%
 # mutate_if(is.character, list(~na_if(., "(Missing)"))) %>%
  #select(-c(id, court))

court_df2 <- court_df2 %>%
  mutate_if(is.character, list(~na_if(., "NULL"))) %>%
  select(-c(charge, charge_level, charge_code)) %>%
  mutate_at(vars(first_name, last_name), toupper) %>%
  mutate(court_case_id = as.character(court_case_id))

#Joining Assessment to Jail Data
join1 <- inner_join(book_df, assess_df, by = "book_num", na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x$", "", .))) %>%
  select(-contains(".y")) %>%
  #1 Duplicate with missing dispositions which will be dropped later. 
  distinct()

j1 <- anti_join(book_df, assess_df, by = "book_num", na_matches = "never")
a1 <- anti_join(assess_df, book_df, by = "book_num", na_matches = "never")


  #Examine if set of common variables is distinct--yes
  semi_join(book_df, assess_df, by = "book_num", na_matches = "never") %>%
    distinct()

#Joining on Name and Court ID
join2 <- inner_join(j1, a1, by = c("first_name", "last_name", "book_date" = "interview_date"), 
                    na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x$", "", .))) %>%
  select(-contains(".y")) %>%
  #1 Duplicate with missing dispositions which will be dropped later. 
  distinct()

j2 <- anti_join(j1, a1, by = c("first_name", "last_name", "book_date" = "interview_date"), na_matches = "never")
a2 <- anti_join(a1, j1, by = c("first_name", "last_name", "interview_date" = "book_date"), na_matches = "never")

  #Examine if set of common variables is distinct--yes
  semi_join(j1, a1, by = c("first_name", "last_name", "book_date" = "interview_date"), 
            na_matches = "never") %>%
    distinct()
  
#Diagnostics
  #Jail and Assessment Matches by category
tibble(
  stage = 1:2,
  match = c(
    'c("book_num")',
    'c("first_name", "last_name", "book_date" = "interview_date")'
  ),
  # jail_match_rate = sapply(1:2, function(i) {
  #   (nrow(book_df) - nrow(get(paste0("j", i)))) / nrow(book_df) * 100
  # }),
  assess_match_rate = sapply(1:2, function(i) {
    (nrow(assess_df) - nrow(get(paste0("a", i)))) / nrow(assess_df) * 100
  })
)

#Recreating Booking--Should be same number of rows.
book_df <- bind_rows(join1, join2, j2)  

rm(list = ls()[!ls() %in% ls(pattern = "df")])

#scratch

court_df2 %>%
 ls()
   
book_df %>%
  ls()


 join1 %>%
  select(contains(".x")) %>%
  names() %>%
  sort()

join1 %>%
  select(contains("arrest_")) %>%
  names() %>%
  sort()

names(book_df)[names(book_df) %in% names(court_df2)]

names(join1)[grepl("\\.x", names(join1)) & paste0("arrest_", gsub("\\.x$", "", names(join1))) %in% names(join1)]


names(join1)[grepl("\\.y", names(join1)) & paste0("court_", gsub("\\.y$", "", names(join1))) %in% names(join1)]
#end of scratch


# Court Matching
#Joining on cdl_id
join1 <- inner_join(book_df, court_df2, by = c("cdl_id"), na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(paste0("arrest_", gsub("\\.x$", "", .)))) %>%
  rename_at(vars(contains(".y")), funs(paste0("court_", gsub("\\.y$", "", .)))) %>%
  # 8 Duplicates with missing dispositions which will be dropped later. 
  distinct()

j1 <- anti_join(book_df, court_df2, by = c("cdl_id"), na_matches = "never")
c1 <- anti_join(court_df2, book_df, by = c("cdl_id"), na_matches = "never")



  #Examine if set of common variables is distinct--yes except 8 spurious cases.
  join1 %>%
    select(-contains("flag")) %>%
    add_count("cdl_id") %>%
    filter(n > 1) %>%
    arrange(desc(n))

     

#Joining on Name and Court ID
join2 <- inner_join(j1, c1, by = c("last_name", "first_name", "dob"), na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(paste0("arrest_", gsub("\\.x$", "", .)))) %>%
  rename_at(vars(contains(".y")), funs(paste0("court_", gsub("\\.y$", "", .)))) %>%
  #1 Duplicate with missing dispositions which will be dropped later. 
  distinct()

j2 <- anti_join(j1, c1, by = c("last_name", "first_name", "dob"), na_matches = "never")
c2 <- anti_join(c1, j1, by = c("last_name", "first_name", "dob"), na_matches = "never")

  #Examine if set of common variables is distinct--yes except 8 spurious cases.
  join2 %>%
     select(-contains("flag")) %>%
    add_count("last_name", "first_name", "dob") %>%
    filter(n > 1) %>%
    arrange(desc(n))

#Joining on Court ID
join3 <- inner_join(j2, c2, by = c("fbi"), na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(paste0("arrest_", gsub("\\.x$", "", .)))) %>%
  rename_at(vars(contains(".y")), funs(paste0("court_", gsub("\\.y$", "", .)))) %>%
  #1 Duplicate with missing dispositions which will be dropped later. 
  distinct()

j3 <- anti_join(j2, c2, by = c("fbi"), na_matches = "never")
c3 <- anti_join(c2, j2, by = c("fbi"), na_matches = "never")

  #Examine if set of common variables is distinct--yes except 8 spurious cases.
  join3 %>%
    add_count ("fbi") %>%
    filter(n > 1) %>%
    arrange(desc(n))
  
#Diagnostics
  #Jail and Court Matches by category
tibble(
  stage = 1:3,
  match = c(
    'c("cdl_id")',
    'c("cdl_id", "first_name", "last_name", dob")',
    'c("cdl_id", "fbi")'
  ),
  jail_match_rate = sapply(1:3, function(i) {
    (nrow(book_df) - nrow(get(paste0("j", i)))) / nrow(book_df) * 100
  }),
  court_match_rate = sapply(1:3, function(i) {
    (nrow(court_df2) - nrow(get(paste0("c", i)))) / nrow(court_df2) * 100
  })
)

join_df <- bind_rows(join1, join2, join3)
```

