---
title: "County Data Loading"
author: "Noah Lehman"
date: "10/15/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

knitr::opts_knit$set(root.dir = "G:/Work/PretrialAssessmentPilot")
```

# Libraries
```{r include=FALSE}
library(data.table)
library(openxlsx)
library(readxl)
library(lubridate)
library(tidyverse)
library(XML)
library(xml2)
# library(xmltools)
library(gsubfn)
library(fuzzyjoin)
```

# Function Creation
```{r}

```


# Charge Hierarchy Creation

2020 DOJ Hieararchies
```{r, eval=FALSE, include=FALSE}
#DOJ Crime Severity Ratings 2008
doj_hierarchy_2020 <- fread("C:/Work/PretrialAssessmentPilot/Charge Definitions and Hierarchy/Master Charge Code Table 2020.csv")
doj_hierarchy_2020_jbsis <- read_excel("C:/Work/PretrialAssessmentPilot/Charge Definitions and Hierarchy/2020_March04_DOJ_Offense_Table_JBSIS.xlsx")


names(doj_hierarchy_2020) <- c("offense_id", "cjis_code", "hierarchy", "charge_level", "charge", "charge_code", "master_charge_description", "sentence")
names(doj_hierarchy_2020_jbsis) <- c("offense_id", "cjis_code", "hierarchy", "charge_level", "charge", "charge_code", "master_charge_description", "sentence", "jbsis_code")

doj_hierarchy_2020 <- left_join(doj_hierarchy_2020, doj_hierarchy_2020_jbsis)

doj_hierarchy_2020 <- doj_hierarchy_2020 %>%
  mutate(charge_level = toupper(charge_level),
         charge_level = if_else(!charge_level %in% c("F", "I", "M"), "Other", charge_level),
         charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}|EX|\\+|","", charge)),
         charge_code = if_else(!charge_code %in% c("PC", "VC", "HS", "BP", "WI", "US"), "Other", charge_code)) %>%
  distinct(charge, charge_code, charge_level, .keep_all = T) %>%
  unite(join_var, charge_level, charge_code, charge, remove = F) %>%
  select(join_var, master_charge_description, hierarchy, charge_level, charge_code, charge, jbsis_code)
```


2017 DOJ Hieararchies
```{r, eval=FALSE, include=FALSE}
#DOJ Crime Severity Ratings 2008
doj_hierarchy_2017 <- read_excel("C:/Work/PretrialAssessmentPilot/Charge Definitions and Hierarchy/dojoffenses.xls")

doj_hierarchy_2017 <- doj_hierarchy_2017 %>%
  mutate(STATUTE2 = gsub("\\/|\\(|\\)| |\\.|\\.*","", STATUTE2)) %>%
  unite("charge",STATUTE1,STATUTE2, sep = "") %>%
  mutate(charge = gsub("NA", "", charge)) %>%
  select(charge, master_charge_description = DESCRIPTION, hierarchy = HIERARCHY, charge_code = CODE_TYPE, charge_level = CHARGE_TYPE) %>%
  filter(!is.na(hierarchy)) %>%
  # mutate(charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}","", charge))) %>%
  mutate(charge_level = if_else(!charge_level %in% c("F", "I", "M"), "Other", charge_level),
         charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}|EX|\\+|","", charge)),
         charge_code = if_else(!charge_code %in% c("PC", "VC", "HS", "BP", "WI", "US"), "Other", charge_code)) %>%
  # mutate(charge_level = fct_collapse(charge_level, O = c("S", "X"))) %>% #Incorretly labeled, juvenile, and miscelanious 
  distinct(charge, charge_code, charge_level, .keep_all = T) %>%
  unite(join_var, charge_level, charge_code, charge, remove = F) %>%
  select(join_var, master_charge_description, hierarchy, charge_level, charge_code, charge)

```

 -Visualizes above chunk
```{r, eval=FALSE, include=FALSE} 
#--This visualizes the above chunk
table(doj_hierarchy_2017$charge_code, doj_hierarchy_2017$charge_level)

doj_hierarchy_2017 %>%
  # filter(HIERARCHY < 1.7e5) %>%
  ggplot() +
  aes(x = hierarchy, color = charge_level) +
  geom_density() +
  theme_few()
```


2008 DOJ Hierarchies
```{r}
#DOJ Crime Severity Ratings 2008
doj_hierarchy_2008 <- read_excel("C:/Work/PretrialAssessmentPilot/Charge Definitions and Hierarchy/DOJ Crime Severity Ratings May 2008.xls", col_names = FALSE, skip = 11)

#Recreating Variables
names(doj_hierarchy_2008) <- c("sum", "bcs", "hierarchy", "charge_level", "charge", "charge_code", "master_charge_description", "sentence")

#collapsed codes for merger with Fresno
doj_hierarchy_2008 <- doj_hierarchy_2008 %>% 
  # mutate(charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}","", charge))) %>%
  mutate(charge_level = strapplyc(charge_level, "^(.).*", simplify = T)) %>%
  mutate(charge_level = if_else(!charge_level %in% c("F", "I", "M"), "Other", charge_level),
         charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}|EX|\\+|","", charge)),
         charge_code = if_else(!charge_code %in% c("PC", "VC", "HS", "BP", "WI", "US"), "Other", charge_code)) %>%
  filter(!is.na(hierarchy)) %>%
  # mutate(charge_level = fct_recode(charge_level, "Other" = "S")) %>%
  distinct(charge_level, charge_code, charge, .keep_all = T)  %>%
  select(-c(sum, bcs, sentence)) %>%
  unite(join_var, charge_level, charge_code, charge, remove = F) %>%
  select(join_var, master_charge_description, hierarchy, charge_level, charge_code, charge)
 
```

 -Visualizes above chunk
```{r, eval=FALSE, include=FALSE} 
#--This visualizes the above chunk
table(doj_hierarchy_2008$charge_code, doj_hierarchy_2008$charge_level)

doj_hierarchy_2008 %>%
  filter(hierarchy < 1.7e5) %>%
  ggplot() +
  aes(x = hierarchy, color = charge_level) +
  geom_density() +
  theme_few()
```


 Charge Code Table 
```{r}
#--This chunk pulls the master charge code table and standardizes it. 
mcct_2016 <- read_excel("C:/Work/PretrialAssessmentPilot/Charge Definitions and Hierarchy/Master Charge Code Table 2016.xlsx", guess_max = Inf)

mcct_2016 <- mcct_2016 %>%
  filter(!is.na(`CalDOJ HIERARCHY Code Informational only`))

mcct_2016 <- mcct_2016 %>% 
  select(charge_code = CODE, 
         charge = `CODE SECTION (upper/lower case)`, 
         hierarchy = `CalDOJ HIERARCHY Code Informational only`,
         master_charge_description = `Offense Display (For AJIS and ISAB Departments)`,
         charge_level = LEVEL) %>%
  # mutate(charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}","", charge))) %>%
  mutate(charge_level = if_else(!charge_level %in% c("F", "I", "M"), "Other", charge_level),
         charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}|EX|\\+|","", charge)),
         charge_code = if_else(!charge_code %in% c("PC", "VC", "HS", "BP", "WI", "US"), "Other", charge_code)) %>%
  distinct(charge_level, charge_code, charge, .keep_all = T) %>%
  mutate(hierarchy = as.numeric(hierarchy)) %>%
  unite(join_var, charge_level, charge_code, charge, remove = F) %>%
  select(join_var, master_charge_description, hierarchy, charge_level, charge_code, charge)
```

 -Visualizes above chunk
```{r, eval=FALSE, include=FALSE} 
#--This visualizes the above chunk
table(mcct_2016$charge_code, mcct_2016$charge_level)

mcct_2016 %>%
  # filter(HIERARCHY < 3e5) %>%
  ggplot() +
  aes(x = hierarchy, color = charge_level) +
  geom_density() +
  theme_few()
```


JBSIS Hierarchies
```{r, eval=FALSE, include=FALSE}
#JBSIS matched Charges
charge_hier_jbsis <- read_excel("C:/Work/PretrialAssessmentPilot/Charge Definitions and Hierarchy/Copy of 2016_Nov21_DOJ_Offense_Table_JBSIS.xlsx") 

names(charge_hier_jbsis) <- toupper(names(charge_hier_jbsis))

charge_hier_jbsis <- charge_hier_jbsis %>% 
  select(charge = `CODE SECTION`,
         charge_code = `CODE TYPE`,
         master_charge_description = `OFFENSE DESCRIPTION`,
         charge_level = `OFF LEVEL`,
         hierarchy = HIERARCHY) %>%
  # mutate(charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*","", charge))) %>% 
  mutate(charge_level = if_else(!charge_level %in% c("F", "I", "M"), "Other", charge_level),
         charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}|EX|\\+|","", charge)),
         charge_code = if_else(!charge_code %in% c("PC", "VC", "HS", "BP", "WI", "US"), "Other", charge_code)) %>%
  distinct(charge, charge_code, charge_level, .keep_all = T) %>%
  unite(join_var, charge_level, charge_code, charge, remove = F) %>%
  select(join_var, master_charge_description, hierarchy, charge_level, charge_code, charge)
```

 -Visualizes above chunk
```{r, eval=FALSE, include=FALSE} 
#--This visualizes the above chunk
table(charge_hier_jbsis$charge_code, charge_hier_jbsis$charge_level)

charge_hier_jbsis %>%
 
   # filter(HIERARCHY < 1.7e5) %>%
  ggplot() +
  aes(x = as.numeric(hierarchy), color = charge_level) +
  geom_density() +
  theme_few()

```

Special Allegations--Hierarchies are Max
```{r}
charge_hier_special <- fread("C:/Work/PretrialAssessmentPilot/Charge Definitions and Hierarchy/San_Mateo_Qualifier_Flags_Court_charges.csv", header = T)
charge_hier_special2 <- fread("C:/Work/PretrialAssessmentPilot/Charge Definitions and Hierarchy/Yuba_Qualifier_Flags_Court_charges.csv", header = T)
charge_hier_special3 <- read_excel("C:/Work/PretrialAssessmentPilot/Charge Definitions and Hierarchy/qualifier_codes_for_Noah_Kings_Court.xlsx")
charge_hier_special4 <- read_excel("C:/Work/PretrialAssessmentPilot/Charge Definitions and Hierarchy/qualifier_codes_for_Noah_Napa_Court.xlsx")
charge_hier_special5 <- read_excel("C:/Work/PretrialAssessmentPilot/Charge Definitions and Hierarchy/qualifier_codes_for_Noah_Sonoma_Court.xlsx")

charge_hier_special6 <- tibble(join_var = c("M_VC_23578", "M_VC_231035", "F_PC_117012C1", "F_PC_120225A", "F_PC_1170H3", "F_PC_1170H", 
                                               "F_PC_120227A", "F_PC_120221", "F_PC_667A1", "F_PC_12022A1", "F_PC_12022B1", 
                                               "F_VC_23577", "F_PC_1202253C", "F_PC_290018BZ", "F_PC_1202253B", 
                                               "F_PC_6676D", "F_PC_1202253D", "F_PC_1203K", "F_HS_113702A", "F_PC_120307A11", 
                                               "F_HS_11370A", "F_PC_6675C21", "F_PC_667E1", "F_PC_6676C", "F_PC_120306A1", "F_PC_969F", 
                                               "F_PC_120306A1", "F_PC_1170H5B", "F_PC_1170H5A")) %>%
  separate(join_var, c("court_charge_level", "court_charge_code", "court_charge"))


charge_hier_special <- bind_rows(charge_hier_special, charge_hier_special2, charge_hier_special3, charge_hier_special4, charge_hier_special5, charge_hier_special6) 

rm(charge_hier_special2, charge_hier_special3, charge_hier_special4, charge_hier_special5, charge_hier_special6)

charge_hier_special <- charge_hier_special %>%
  select(charge_code = court_charge_code, charge_level = court_charge_level, charge = court_charge, master_charge_description = court_charge_description) %>%
  mutate(charge_level = if_else(!charge_level %in% c("F", "I", "M"), "Other", charge_level),
         charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}|EX|\\+|","", charge)),
         charge_code = if_else(!charge_code %in% c("PC", "VC", "HS", "BP", "WI", "US"), "Other", charge_code)) %>%
  mutate(master_charge_description = gsub("^.*-", "", toupper(master_charge_description))) %>%
  group_by(charge_code, charge) %>% 
  mutate(master_charge_description = if_else(is.na(master_charge_description), max(master_charge_description, na.rm = T), master_charge_description)) %>%
  ungroup() %>%
  distinct(charge, charge_code, charge_level, .keep_all = T) %>%
  unite(join_var, charge_level, charge_code, charge, remove = F) %>%
  mutate(hierarchy = 1e6) %>%
  select(join_var, master_charge_description, hierarchy, charge_level, charge_code, charge) %>%
  mutate(special_flag = 1) 

# charge_hier_special %>%
#   filter(grepl("23578", join_var)) %>%
#   group_by(charge_code, charge) %>%
#   mutate(master_charge_description = if_else(is.na(master_charge_description), max(master_charge_description, na.rm = T), master_charge_description))
```

  -New Special Allegations
```{r}  
  
charge_hier_check <- tibble(join_var = c("M_VC_23578", "M_VC_231035", "F_PC_117012C1", "F_PC_120225A", "F_PC_1170H3", "F_PC_1170H", 
                                               "F_PC_120227A", "F_PC_120221", "F_PC_667A1", "F_PC_667A1", "F_PC_12022A1", "F_PC_12022B1", 
                                               "F_VC_23577", "F_PC_1202253C", "F_PC_290018BZ", "F_PC_290018BZ", "F_PC_1202253B", 
                                               "F_PC_6676D", "F_PC_1202253D", "F_PC_1203K", "F_HS_113702A", "F_PC_120307A11", 
                                               "F_HS_11370A", "F_PC_6675C21"))
anti_join(charge_hier_check, charge_hier_special)
```

Missing Charges
```{r}
charge_hier_missing <- read_excel("C:/Work/PretrialAssessmentPilot/Charge Definitions and Hierarchy/Charges Missing from the Charge Code Tables original.xlsx", sheet = "Combined") 

charge_hier_missing <- charge_hier_missing %>% 
  mutate(charge_level = if_else(!charge_level %in% c("F", "I", "M"), "Other", charge_level),
         charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}|EX|\\+|","", charge)),
         charge_code = if_else(!charge_code %in% c("PC", "VC", "HS", "BP", "WI", "US"), "Other", charge_code)) %>%
  distinct(charge, charge_code, charge_level, .keep_all = T) %>%
  unite(join_var, charge_level, charge_code, charge, remove = F) %>%
  select(join_var, master_charge_description, hierarchy, charge_level, charge_code, charge) 
```

Merging hiearchies 
```{r}
charge_hier <- bind_rows(doj_hierarchy_2020, doj_hierarchy_2017, doj_hierarchy_2008, mcct_2016, charge_hier_jbsis, charge_hier_special, charge_hier_missing) %>%
  mutate(special_flag = if_else(is.na(special_flag), 0, special_flag)) %>%
  group_by(join_var) %>%
  mutate(special_flag = max(special_flag)) %>%
  ungroup() %>%
  distinct(join_var, .keep_all = T) %>%
  mutate(hierarchy = if_else(is.na(hierarchy|hierarchy >= 3e5|hierarchy < 1000), 1e6, hierarchy))

save(charge_hier, file = "Complete Charge Code Hierarchy.RData")
# shell.exec(getwd())
```

 -Visualizes above chunk
```{r, eval=FALSE, include=FALSE} 
#--This visualizes the above chunk
table(charge_hier_jbsis$code_type, charge_hier_jbsis$charge_type)

charge_hier %>%
  filter(hierarchy < 1.7e5) %>%
  ggplot() +
  aes(x = as.numeric(hierarchy), color = charge_level) +
  geom_density() +
  theme_few()

charge_hier %>%
  count(charge_level)

charge_hier %>%
  count(charge_code) %>%
  arrange(desc(n))

charge_hier %>%
  mutate(code_type = gsub(".* ", "", code_type))  %>%
  count(code_type) %>%
  arrange(desc(n))

load("Complete Charge Code Hierarchy.RData")

charge_hier %>%
  count(charge_code)
```


# Charge Hierarchy Flag Adds
```{r}
load("Complete Charge Code Hierarchy.RData")

#Serious and Violent Felonies
serious_violent_charges <- read_excel("C:/Work/PretrialAssessmentPilot/Charge Definitions and Hierarchy/Serious and Violent Charges.xlsx", 
    sheet = "Data") %>%
  # filter(Serious == T | Violent == T)
  select(charge, charge_level, serious_felony_flag = Serious, violent_felony_flag = Violent) %>%
  filter(serious_felony_flag == 1 | violent_felony_flag == 1, charge_level == "F") %>%
  mutate(charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|\\\\.*|\\{|\\}","", charge))) %>%
  mutate(charge = gsub("HSC", "HS_", charge),
         charge = gsub("PEN", "PC_", charge),
         charge = gsub("VEH", "VC_", charge)) %>%
  unite(join_var, charge_level, charge) %>%
  mutate(serious_violent_flag = if_else(serious_felony_flag == T|violent_felony_flag == T, 1, 0)) %>%
  # mutate(serious_felony_flag = if_else(serious_felony_flag == T, 1, 0),
  #        violent_felony_flag = if_else(violent_felony_flag == T, 1, 0)) %>%
  mutate_all(funs(ifelse(is.na(.), 0, .))) %>%
  distinct(join_var, .keep_all = T) %>%
  ungroup()

charge_hier <- charge_hier %>%
  left_join(serious_violent_charges) %>%
  mutate(serious_violent_flag = if_else(is.na(serious_violent_flag), 0, serious_violent_flag)) 
  # mutate_at(vars(serious_felony_flag, violent_felony_flag), funs(if_else(is.na(.), 0, .)))

rm(serious_violent_charges)

#Pretrial Violent Charges
pretrial_violent <- read_excel("C:/Work/PretrialAssessmentPilot/Charge Definitions and Hierarchy/Pretrial Pilot Consensus on Violent Offense List - FINAL 2-3-20.xlsx")

names(pretrial_violent) <- c("charge", "violent_description", "violent_psa_flag")

pretrial_violent <- pretrial_violent %>%
  mutate(violent_psa_flag = 1,
         charge_code = if_else(grepl("Veh Code", charge), "VC", "PC"),
         charge = gsub("\\/|\\(|\\)| |\\.|\\.*|\\\\.*|\\{|\\}|^[A-Z]* [A-Z]* ","", toupper(charge))) %>%
  select(-violent_description)

charge_hier <- left_join(charge_hier, pretrial_violent) %>%
  mutate(violent_psa_flag = if_else(is.na(violent_psa_flag), 0, violent_psa_flag))


# Charge Flags Added--Needs fixing
charge_hier <- charge_hier %>%
  mutate(capital_flag = if_else(charge_code == "PC" & charge %in% c("37", "128", "206", "2095", "218", "2361C2", "273AB"), 1, 0),
         dv_flag = if_else(grepl("DOMESTIC|SPOUSE|PARTNER|COHABITANT", master_charge_description) &
                             !grepl("MARRY|CRT ORD|COURT ORDER|FOREIGN|LAND|FAIL|SHELTER", master_charge_description), 1, 0),
         #Attach Flags DV and Sup Vio Flags #Sup Vio Based on Charge Descriptions--Including Flash Incarceration
         sup_vio_flag = if_else((grepl("^SUP| SUP |SUPERVISION|PROBATION|PAROLE", master_charge_description) &
                                  !grepl("^AGG ARSON|SUPV/ETC PROSTITUTION|MENTALY DISORDERD|^SEXUAL ACTIVITY|^SUPPLY|^ADL|SEX|TRANSFER|PROSTITUTION",
                                         master_charge_description))| charge %in% c("3454", "3455", "12032", "12032A"), 1, 0),
         fta_flag = if_else(grepl("APPEAR|FTA", master_charge_description) & !grepl("^DEMAND|WITNESS", master_charge_description), 1, 0),
         marijuana_flag = if_else(grepl("MARIJ|CANNA", master_charge_description), 1, 0),
         sex_flag = if_else(grepl("SEX|COPULATION|RAPE|ORAL|PENETRATION|MOLLEST|LASCIVIOUS|INCEST", 
                                  master_charge_description)|(charge_code == "PC" & charge %in% c("2434", "2641", "266H", "266I", "266J", "269", "272", "285", "286", "288",
                                                           "288a", "2882", "2884", "2885", "2887", "289", "3111", "31111", "314",
                                                           "6476", "653FC")), 1, 0),
         sb10_sex_flag = if_else(sex_flag == 1, 1, 0),
         dui_flag = if_else((charge_code == "VC" & charge %in% c("23546", "23153", "23578"))|(charge_code == "PC" & charge == "1915B"), 1, 0),
         sb10_dui_flag = if_else((charge_code == "VC" & charge %in% c("23546", "23153", "23578"))|(charge_code == "PC" & charge == "1915B"), 1, 0),
         restrain_flag = if_else(charge_code == "PC" & charge %in% c("166C4", "166D1", "27365A", "6499B"), 1, 0),
         sb10_witness_intim_flag = if_else(charge_code == "PC" & charge %in% c("1361", "1365"), 1, 0),
         sb10_onduty_inel_flag = if_else(charge_code == "PC" & charge %in% c("166", "18626", "18628", "18633", "240", "241", "2411", "2412", "2413",
                                                                             "2414", "2415", "2416", "2417", "2418", "242", "243", "2431", "2432",
                                                                             "24325", "2433", "24335", "2435", "2436", "24365", "2437", "2438",
                                                                             "24383", "2439", "24310", "24315", "2445", "245", "2456", "2463", "247",
                                                                             "2475","248", "120215", "12022A", "12022B", "12022C", "120222A",
                                                                             "120223B", "120225", "653M"), 1, 0),
         property_flag = if_else(jbsis_code %in% c("220", "70"), 1, 0),
         drug_flag = if_else(jbsis_code %in% c("230", "80"), 1, 0),
         minor_flag = if_else(charge %in% c("fix this"), 1, 0),
         pre_arr_inel_flag = if_else(charge %in% c("fix this"), 1, 0)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, as.numeric(.))))

save(charge_hier, file = "Complete Charge Code Hierarchy.RData")

# write.xlsx(charge_hier, file = "C:/Work/PretrialAssessmentPilot/Charge Definitions and Hierarchy/Complete Charge Hieararchy with Flags.xlsx", asTable = T, tableStyle = "TableStyleMedium1")
```

  Flag Excel for Legal
```{r}
load("Complete Charge Code Hierarchy.RData")

flag_list <- lapply(8:28, function(i) {
  df <- charge_hier %>%
    select(1:7, i) %>%
    filter_at(8, all_vars(. == 1)) %>%
    mutate(wrong_offense = 0, missing_offense = 0) %>%
    select(1:2, 4:6, 8:10, 3, 7)
}) 

write.xlsx(
  flag_list,
  "Offense Flags for Kara and Eve Sex Offenses.xlsx",
  asTable = T,
  tableStyle = "TableStyleMedium1",
  sheetName = c(
    "Special Allegations",
    "Serious Felonies",
    "Violent Felonies",
    "Serious and Violent Felonies",
    "PSA Violent",
    "Capital Offenses",
    "Domestic Violence",
    "Supervision Violations",
    "Failures to Appear",
    "Marijuana Offenses",
    "Sex Offenses",
    "SB 10 Sex Offenses",
    "DUIs",
    "SB10 DUIs",
    "Restrain Order Vios",
    "Witness Intimidation",
    "SB 10 Onduty Ineligibile",
    "JBSIS Property Offenses",
    "JBSIS Drug Offenses",
    "Minor Offenses",
    "SB 10 Pre Arraign Ineligible"
  ),
  colWidths = "auto",
  firstRow = T
)

flag_defs <- tibble(
  `Excel Tab Name` = c(
    "Special Allegations",
    "Serious Felonies",
    "Violent Felonies",
    "Serious and Violent Felonies",
    "PSA Violent",
    "Capital Offenses",
    "Domestic Violence",
    "Supervision Violations",
    "Failures to Appear",
    "Marijuana Offenses",
    "Sex Offenses",
    "SB 10 Sex Offenses",
    "DUIs",
    "SB10 DUIs",
    "Restrain Order Vios",
    "Witness Intimidation",
    "SB 10 Onduty Ineligibile",
    "JBSIS Property Offenses",
    "JBSIS Drug Offenses",
    "Minor Offenses",
    "SB 10 Pre Arraign Ineligible"
  ),
  `Flag Names` = names(charge_hier)[8:28],
  Definition = NA
)

write.xlsx(
  flag_defs,
  "Offense Flag Definitions for Kara and Eve.xlsx",
  asTable = T,
  tableStyle = "TableStyleMedium1",
  colWidths = "auto",
  firstRow = T
  )

serious_violent <- fread("C:/Work/PretrialAssessmentPilot/Charge Definitions and Hierarchy/Bail Deviation Exclusion List_for review by Pretrial Pilots - updated for research team 4-24-20.csv", header = T)

names(serious_violent) <- c("charge", "master_charge_description", "serious_flag", "violent_flag", "remove", "remove2", "remove3")

serious_violent <- serious_violent %>%
  filter(charge != "", !grepl("Conspiracy", master_charge_description)) %>%
  select(1:4) %>%
  separate_rows(charge, sep = "/") %>%
  mutate_at(vars(contains("flag")), funs(if_else(. == "", 0, 1))) %>%
  mutate(master_charge_description = gsub("\t", "", master_charge_description),
         charge_level = "F",
         charge_code = case_when(grepl("^Veh", charge) ~ "VC",
                                 grepl("^Health", charge) ~ "HS",
                                 grepl("^Military|^Election", charge) ~ "Other",
                                 grepl("^Welf", charge) ~ "WI",
                                 T ~ "PC"),
         charge = gsub("&| |\\.", "", charge),
         charge = gsub("\\/|\\(|\\)| |\\.|\\.*|\\\\.*|\\{|\\}|\\*|^[A-Z]*","", toupper(charge))) %>%
  unite(join_var, charge_level, charge_code, charge, remove = F) %>%
  mutate(master_charge_description = toupper(master_charge_description)) %>%
  select(join_var, master_charge_description, charge_level, charge_code, charge, serious_flag, violent_flag)

missing_df <- anti_join(serious_violent, charge_hier, by = "join_var") 

charge_hier %>%
  filter(grepl("F_PC_2095", join_var))

write.xlsx(missing_df, file = "C:/Work/PretrialAssessmentPilot/Charge Definitions and Hierarchy/Missing Serious and Violent Charges.xlsx")
```

  Flag Add Diagnostics
```{r eval=FALSE, include=FALSE}
charge_hier %>%
  summarise_at(vars(dv_flag:violent), sum)

charge_hier %>%
  filter(violent == 1)

# lapply(names(charge_hier)[grepl("flag", names(charge_hier))], function(i){
#   
#   charge_hier %>%
#     filter(get(i) == 1) %>%
#     select(charge_level, charge_code, charge, master_charge_description, i)
#     
# })

#PC 12032, 
#6675 B

charge_hier %>%
  filter(grepl("300008", join_var))

charge_hier %>%
  filter(dv_flag == 1)

charge_hier %>%
  mutate(dv_fake = if_else(grepl("DOMESTIC|SPOUSE|PARTNER|COHABITANT", master_charge_description), 1, 0)) %>%
  count(dv_flag, dv_fake)

flag_list <- lapply(8:28, function(i) {
  df <- charge_hier %>%
    select(1:7, i) %>%
    filter_at(8, all_vars(. == 1)) %>%
    mutate(wrong_offense = 0, missing_offense = 0) %>%
    select(1:2, 4:6, 8:10, 3, 7)
}) 

charge_hier %>%
  select(1:7)

charge_hier[charge_hier[,8] == 1,]

charge_hier 
```

# Alameda

Jail Data
```{r}
# Jail Bookings Data Import--- Alameda, 2015-01-01 to 2020-01-01
  ## book_df contains one row per booking and includes information on the person as well as the time of booking and release. It contains no charge information.
  ## book_charge contains one row per charge and includes the charge information on each of the bookings from book_df which are joined on the book_num. 

####

# Booking Data
  ## book_df contains one row per booking and includes information on the person as well as the time of booking and release. It contains no charge information.
book_df <- lapply(1:4, function(i){
  fread(paste0("Historical Data Submissions/Alameda/BOOK_", i, ".csv"), colClasses = "character")}) %>%
  bind_rows()


# Variable name standardization--See pg. xxx for more details. 
  ## Variables race_code and booking_seq are redundant and will be dropped. 
names(book_df) <- c("cii", "fbi", "local_id", "first_name", "last_name", "dob", "cdl_id", "cdl_state", "race_code", "race_original", "sex_original", "arrest_date", "arrest_time", "book_num", "booking_seq", "book_type_code", "book_type_original", "book_date", "book_time", "release_date", "release_time", "release_type_code", "release_type_original", "court_case_id", "court_docket_id")
  
  ## Quarter 1 data imported separately due to different initial date structure. 
book_df2 <- fread("Historical Data Submissions/Alameda/BOOK_2020-01-06.csv")

names(book_df2) <- names(book_df)


# Date Reformatting--See pg. xxx for more details.
  ## booking_sequence and courtcase_id are also fixed here as well. 
book_df <- book_df %>%
  mutate(arrest_date_time = mdy_hms(paste(arrest_date, arrest_time), tz = 'America/Los_Angeles'),
         book_date_time = mdy_hms(paste(book_date, book_time), tz = 'America/Los_Angeles'),
         release_date_time = mdy_hms(paste(release_date, release_time), tz = 'America/Los_Angeles')) %>%
  mutate_at(vars(dob, arrest_date, book_date, release_date), mdy) %>%
  mutate(booking_seq = as.integer(booking_seq))
  
  ## Different formatting needed for Quarter 1 data. 
book_df2 <- book_df2 %>%
  mutate(arrest_date_time = as_datetime(paste(arrest_date, arrest_time), tz = 'America/Los_Angeles'),
         book_date_time = as_datetime(paste(book_date, book_time), tz = 'America/Los_Angeles'),
         release_date_time = as_datetime(paste(release_date, release_time), tz = 'America/Los_Angeles')) %>%
  mutate_at(vars(dob, arrest_date, book_date, release_date), as_date) %>%
  mutate(court_case_id = as.character(court_case_id))

  ## Binding historical and quarter 1 data together after reformatting. 
book_df <- bind_rows(book_df, book_df2) %>% distinct()
  
  ## Removing separate and redundant quarter 1 data. 
rm(book_df2)


# Standardize Factors--See pg. xxx for more details.
book_df <- book_df %>%
  mutate(sex = case_when(sex_original %in% c("M") ~ "Male",
                         sex_original %in% c("F") ~ "Female"),
         
  ## Trimming white space on original race first
         race_original = trimws(race_original),
         race = case_when(race_original %in% c("BLACK") ~ "Black",
                          race_original %in% c("HISPANIC") ~ "Hispanic",
                          race_original %in% c("WHITE") ~ "White",
                          T ~ "Other_Unknown"),
         
         book_type_original = trimws(book_type_original),
         book_type = case_when(book_type_original %in% c("ONVIEW") ~ "On_View",
                               book_type_original %in% c("DA WARRANT") ~ "New_warrant",
                               book_type_original %in% c("WARRANT") ~ "Other_Warrant",
                               book_type_original %in% c("ENROUTE") ~ "Hold",
                               book_type_original %in% c("DA CITATION", "CITATION") ~ "Cite_Release",
                               book_type_original %in% c("COURT") ~ "Court_Order",
                               book_type_original %in% c("DRUNK") ~ "Detain_Only"),
         
         release_type_original = trimws(release_type_original),
         release_type = case_when(release_type_original %in% c("GROSS TIME SERVED", "PROBATION (FORMAL)", 
                                                               "WORK TIME SERVED", "PART TIME SERVED") ~ "Time_Served",
                                  release_type_original %in% c("RELEASED ENROUTE", "HOLD DROPPED", 
                                                               "PAST TIME TO PICK UP", "PICKED UP OUT OF AGENCY") ~ "Hold_Release",
                                  release_type_original %in% c("CITATION IN JAIL AFTER BOOKING") ~ "Cite_Release",
                                  release_type_original %in% c("BAIL", "BAIL BOND") ~ "Bail_Bond",
                                  release_type_original %in% c("DISMISSED", "NO COMPLAINT") ~ "Dismissed_Dropped",
                                  release_type_original %in% c("OWN RECOGNIZANCE") ~ "OR",
                                  release_type_original %in% c("ORDERED RELEASED") ~ "Court_Order",
                                  release_type_original %in% c("OWN RECOGNIZANCE TO PROGRAM") ~ "OR_Conditions",
                                  release_type_original %in% c("IDENTIFIED AND RELEASED") ~ "Administrative",
                                  release_type_original %in% c("STATE PRISON TERM PRESCRIBED") ~ "Prison",
                                  release_type_original %in% c("RELEASED (UNCODED REASON)") ~ "Unknown",
                                  T ~ "Other"),
         warrant_flag = if_else(grepl("Warrant", book_type), 1, 0),
         onview_flag = if_else(grepl("On_View", book_type), 1, 0))

####

# Jail Booking Charges Data Import.
  ## book_charge contains one row per charge and includes the charge information on each of the bookings from book_df which are joined on the book_num.  
book_charge <- lapply(c("1", "2", "2020-01-06"), function(i){
  fread(paste0("Historical Data Submissions/Alameda/ARRCHG_", i, ".csv"), colClasses = "character")}) %>%
  bind_rows() %>%
  distinct()


# Variable name standardization--See pg. xxx for more details. 
names(book_charge) <- c("book_num", "arrest_charge_count", "entry_code", "arrest_charge_code_original", "arrest_charge_original", "arrest_charge_level_original")


# Standardize Charges and join charge hierarchy--See pg. xxx for more details about this process. 
book_charge <- book_charge %>%
  mutate(attempt_flag = if_else(grepl("664", arrest_charge_original), 1, 0)) %>%
  separate_rows(arrest_charge_original, sep = "\\\\|\\-|\\/") %>%
  mutate(arrest_charge_code = if_else(!arrest_charge_code_original %in% c("PC", "VC", "HS", "BP", "WI", "US"), "Other", arrest_charge_code_original),
         arrest_charge_level = if_else(!arrest_charge_level_original %in% c("F", "I", "M"), "Other", arrest_charge_level_original),
         arrest_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}|EX|\\+|R$| [A-Z]*","", arrest_charge_original))) %>%
  filter(!arrest_charge %in% c("1", "2", "1St", "2ND", "664", "")) %>%
  mutate(arrest_charge_level = if_else(arrest_charge == "120221" & arrest_charge_level == "F" & arrest_charge_code == "PC", "Other", arrest_charge_level),
         arrest_charge_level = if_else(arrest_charge == "3455" & arrest_charge_level == "Other" & arrest_charge_code == "PC", "F", arrest_charge_level)) %>%
  unite(join_var, arrest_charge_level, arrest_charge_code, arrest_charge, remove = F)
  
load("Complete Charge Code Hierarchy.RData")
  
book_charge <- book_charge %>%
  left_join(charge_hier) %>%
  mutate(arrest_felony_flag = if_else(arrest_charge_level == "F", 1, 0),
         arrest_misd_flag = if_else(arrest_charge_level == "M", 1, 0)) %>%
  rename_at(vars(contains("flag")), funs(paste0("arrest_", .))) 

```

  Jail Collapse
```{r}
# Booking Join--All booking data frames are combined.
book_df <- left_join(book_df, book_charge)

# Booking Collapse--See pg. xxx for more details about this process. 
book_df <- book_df %>%
  mutate(time_first_release = release_date_time - book_date_time) %>%
  mutate(hierarchy = if_else(is.na(hierarchy), 1e6, as.numeric(hierarchy))) %>%
  group_by(book_num, book_date) %>%
  mutate(booktype = book_type[hierarchy == min(hierarchy)][1],
         max_join_var = join_var[hierarchy == min(hierarchy)][1],
         max_charge_description = master_charge_description[hierarchy == min(hierarchy)][1],
         max_hierarchy = min(hierarchy)) %>%
  select(-c("arrest_charge"))
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, .))) %>%
  mutate_at(vars(contains("flag")), funs("count" = sum(.))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  group_by(book_num, book_date, court_case_id) %>%
  filter(hierarchy == min(hierarchy)) %>%
  distinct(book_num, book_date, court_case_id, .keep_all = T) 
```

  Jail Diagnostics
```{r eval=FALSE, include=FALSE}
book_charge %>%
  count(arrest_charge) %>%
  arrange(desc(n))

court_charge %>%
  filter()

charge_hier %>%
  filter(charge == "273A")

str_extract()

# Diagnostic Code for Charge Hierarchy
# 1 - 60,401/1,178,423 = 95% match rate
(1 - nrow(book_charge %>% filter(is.na(hierarchy)))/nrow(book_charge))*100

book_charge %>%
  filter(is.na(hierarchy)) %>%
  count(join_var) %>%
  arrange(desc(n))

charge_hier %>%
  filter(grepl("11360A", join_var))

# Diagnostics
book_df %>%
  distinct(book_num, book_date) %>%
  arrange(book_num) %>%
  group_by(book_num) %>%
  add_count() %>%
  filter(n > 1)

book_df %>%
  distinct(book_num, book_date) 

```

Court Data
```{r}
# Court Case Data Import--- Alameda, 2015-01-01 to 2019-12-31
  ## court_df contains one row per court case and includes information on the person as well as case status and case type. 
  ## court_fta contains one row per charge and includes the charge information on each of the bookings from book_df which are joined on the book_num. 
  ## court_fta_war contains one row per fta event (with a bench warrant issued) as well as one NULL row for each case without an fta bench warrant issued event. 
  ## court_hearing contains one row per hearing event on each court case and includes informatioin about each hearing.
  ## court_charge contains one row per each charge associated with a court case and includes information on the charges and dispostions of the court case. 
  ## court_sent contains one row per sentence event component in which the sentence event is confinement and one NULL row for each court case without a sentence event.
  ## court_sent2 contains one row per sentence event component in which the sentence event is supervision (e.g. probation) and one NULL row for each court case without a sentence event. Sometimes terms for each sentence event are split across rows and are considered different sentence components. 

####

# Court Cases
  ## court_df contains one row per court case and includes information on the person as well as case status and case type. 
court_df <- lapply(c("", "_2", "_2020-01-06"), function(i){
  fread(paste0("Historical Data Submissions/Alameda/CASE", i, ".csv"), colClasses = "character")}) %>%
  bind_rows()

# Variable name standardization--See pg. xxx for more details. 
names(court_df) <- c("court_case_id", "court_docket_id", "book_num", "local_id", "case_type_code", "case_type", "file_date", "case_status_code", "case_status_original", "case_status_date", "cii", "fbi", "cdl_id", "cdl_state", "dob", "dob_loc", "race_code", "race_original", "sex_original", "first_name", "last_name")

# Date Reformatting--See pg. xxx for more details.
court_df <- court_df %>%
  mutate(file_date = if_else(grepl("-", file_date), as_date(file_date), mdy(file_date)))

# Standardize Factors--See pg. xxx for more details.
court_df <- court_df %>%
  mutate(sex = case_when(sex_original %in% c("M") ~ "Male",
                         sex_original %in% c("F") ~ "Female",
                         T ~ "Other_Unknown"),
         
         #Trimming white space on original race first
         race_original = trimws(race_original),
         race = case_when(race_original %in% c("BLACK") ~ "Black",
                          race_original %in% c("HISPANIC") ~ "Hispanic",
                          race_original %in% c("WHITE") ~ "White",
                          #All Other races/ethnicities collapsed into other
                          T ~ "Other_Unknown"),
         
         case_status = case_when(case_status_original %in% c("Active") ~ "Active",
                                 case_status_original %in% c("Inactive") ~ "Inactive",
                                 T ~ "Other"))

####

# Court FTAs
  ## court_fta contains one row per fta event (including those without a bench warrant issued) as well as one NULL row for each case without an fta event.  
court_fta <- lapply(c("", "_2", "_2020-01-06"), function(i){
  fread(paste0("Historical Data Submissions/Alameda/FTA", i, ".csv"), colClasses = "character")}) %>%
  bind_rows()

# Variable name standardization--See pg. xxx for more details.
names(court_fta) <- c("court_case_id", "fta_date", "fta_id", "fta_type_code", "fta_type")

# Date Reformatting--See pg. xxx for more details.
court_fta <- court_fta %>%
  mutate(fta_date = if_else(grepl("-", fta_date), as_date(fta_date), mdy(fta_date)))

# Flag Adds--See pg. xxx for more details.
court_fta <- court_fta %>%
  mutate(fta_all_flag = if_else(!is.na(fta_date), 1, 0))

####

# Court FTAs with Warrants
  ## court_fta_war contains one row per fta event (with a bench warrant issued) as well as one NULL row for each case without an fta bench warrant issued event.  
court_fta_war <- lapply(c("", "_2", "_2020-01-06"), function(i){
  fread(paste0("Historical Data Submissions/Alameda/WARR", i, ".csv"), colClasses = "character")}) %>%
  bind_rows()

# Variable name standardization--See pg. xxx for more details.
names(court_fta_war) <- c("court_case_id", "fta_warrant_date", "fta_id", "fta_type_code", "fta_type")

# Date Reformatting--See pg. xxx for more details.
court_fta_war <- court_fta_war %>%
  mutate(fta_warrant_date = if_else(grepl("-", fta_warrant_date), as_date(fta_warrant_date), mdy(fta_warrant_date)))

# Flag Adds--See pg. xxx for more details.
court_fta_war <- court_fta_war %>%
  mutate(fta_flag = if_else(!is.na(fta_warrant_date), 1, 0))

####

# Court Hearings
  ## court_hearing contains one row per hearing event on each court case and includes informatioin about each hearing. 
court_hearing <- lapply(1:7, function(i){
  fread(paste0("Historical Data Submissions/Alameda/HEA_", i, ".csv"), colClasses = "character")}) %>%
  bind_rows() %>%
  mutate(HEARING_DATE = mdy(HEARING_DATE))

  ## Q1 data included a different date format and is fixed separately. 
court_hearing2 <- lapply(c("8", "2020-01-06"), function(i){
  fread(paste0("Historical Data Submissions/Alameda/HEA_", i, ".csv"), colClasses = "character")}) %>%
  bind_rows() %>%
  mutate(HEARING_DATE = as_date(HEARING_DATE))

court_hearing <- bind_rows(court_hearing, court_hearing2) %>% distinct()

rm(court_hearing2)


# Variable name standardization--See pg. xxx for more details.
names(court_hearing) <- c("court_case_id", "court_docket_id", "event_num", "event_id", "hearing_type_code", "hearing_type_original", "hearing_date", "hearing_time")


# Date Reformatting--See pg. xxx for more details.
court_hearing <- court_hearing %>%
  mutate(hearing_date_time = as_datetime(paste(hearing_date, hearing_time), tz = "America/Los_Angeles")) %>% 
  select(-hearing_time)


# Standardize Factors--See pg. xxx for more details.
court_hearing <- court_hearing %>%
  mutate(hearing_type = case_when(grepl("Arraignment", hearing_type_original) ~ "Arraignment",
                                  grepl("Sentence", hearing_type_original) ~ "Sentencing",
                                  T ~ "Other"))

####

# Court Filing Charges 
  ## court_charge contains one row per each charge associated with a court case and includes information on the charges and dispostions of the court case. 
court_charge <- lapply(c(1:8, "2020-01-06"), function(i){
  fread(paste0("Historical Data Submissions/Alameda/CHG_", i, ".csv"), colClasses = "character")}) %>% 
  bind_rows()


# Variable name standardization--See pg. xxx for more details.
names(court_charge) <- c("court_case_id", "court_docket_id", "disposition_num", "charge_id", "charge_history_id", "charge_number", "allegation", "qualifier", "offense_id", "court_charge_original", "court_charge_level_original", "disposition_date", "disposition_hist_id", "stage", "disposition_id", "disposition_type_code", "disposition_type_original", "amend_reason_id", "amend_reason")


# Date Reformatting--See pg. xxx for more details.
court_charge <- court_charge %>%
  mutate(disposition_date = if_else(grepl("-", disposition_date), as_date(disposition_date), mdy(disposition_date))) %>%
  distinct() 


# Standardize Factors--See pg. xxx for more details.
court_charge <- court_charge %>%
  mutate(stage = toupper(stage),
         #Nolo is undiferentiated
         disposition_type = case_when(disposition_type_original %in% c("Convicted - No Contest", "Plea of Guilty/Nolo", 
                                                                       "Found True", "Certified Convicted No Contest", "Certified for Sentencing",
                                                                       "Court Finding of Guilt", "Convicted - Guilty Plea", "Jury Verdict of Guilty",
                                                                       "Court Finds Guilty - Lesser Included/Reasonably Related Off",
                                                                       "Certified Convicted Guilty", "No Contest",
                                                                       "No Contest Plea to Lesser/Reasonably Related Charge", "Admit", "Guilty",
                                                                       "Guilty Plea to Lesser/Reasonably Related Charge") ~ "Guilty",
                                      grepl("Dism|DISM", disposition_type_original) ~ "Dismissed",
                                      disposition_type_original %in% c("Jury Verdict of Not Guilty", "Found Not True", "Court Finding of Not Guilty,
                                                                       Jury Verdict Found Not True", "Acquittal", "Not Guilty By Reason of Insanity",
                                                                       "After jury trial - Acquittal")|grepl("Not Guilty", disposition_type_original) ~ "Not_Guilty",
                                      T ~ "Other"))


# Charge Standardization and Flag Adds--See pg. xxx for more details.
court_charge <- court_charge %>%
  mutate(court_charge_code = str_extract(trimws(court_charge_original), "^.." ),
         court_charge_code = if_else(!court_charge_code %in% c("PC", "VC", "HS", "BP", "WI", "US"), "Other", court_charge_code),
         court_charge_level = str_extract(trimws(court_charge_level_original), "^." ),
         court_charge_level = if_else(!court_charge_level %in% c("F", "I", "M"), "Other", court_charge_level),
         court_charge = gsub("^..", "", court_charge_original),
         court_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}|\\+|-.*","", court_charge))) %>%
  mutate(attempt_flag = if_else(grepl("-664", court_charge_original), 1, 0)) %>%
  separate_rows(court_charge, sep = "-") %>%
  filter(!court_charge %in% c("F", "M", "I", "664", "1", "2", "")) %>%
  unite(join_var, court_charge_level, court_charge_code, court_charge, remove = F) 

load("Complete Charge Code Hierarchy.RData")

court_charge <- left_join(court_charge, charge_hier, by = "join_var") %>%
  mutate(felony_flag = if_else(court_charge_level == "F", 1, 0),
         misd_flag = if_else(court_charge_level == "M", 1, 0)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, as.numeric(.)))) %>%
  mutate_at(vars(contains("flag")), funs("conviction" = if_else(. == 1 & disposition_type %in% c("Guilty", "Nolo_Contendere"), 1, 0))) %>%
  rename_at(vars(contains("flag"), -contains("conviction")), funs(paste0("court_", .))) %>%
  rename_at(vars(contains("conviction")), funs(paste0("conviction_", gsub("_conviction", "", .)))) 

####

# Court Sentences to Confinement 
  ## court_sent contains one row per sentence event component in which the sentence event is confinement and one NULL row for each court case without a sentence event. Sometimes terms for each sentence event are split across rows and are considered different sentence components.  
court_sent <- lapply(c("", "_2", "_2020-01-06"), function(i){
  fread(paste0("Historical Data Submissions/Alameda/JAIL", i, ".csv"), colClasses = "character")}) %>%
  bind_rows()


# Variable name standardization--See pg. xxx for more details.
names(court_sent) <- c("court_case_id", "court_docket_id", "event_num", "event_id", "sentence_date", "amend_reason_code", "amend_reason", "sentence_id", "component_instance_id", "start_date", "confinement_type_code", "sentence_type_original", "facilty_id", "facility", "term_type_code", "term_type", "term_years", "term_months", "term_days", "term_to_life", "life_flag", "death_flag")


# Date Reformatting--See pg. xxx for more details.
court_sent <- court_sent %>%
  mutate_at(vars(sentence_date, start_date), funs(if_else(grepl("-", .), as_date(.), mdy(.)))) %>%
  distinct()


# Standardize Factors--See pg. xxx for more details.
  ## Check if other is confinment 
court_sent <- court_sent %>%
  filter(sentence_type_original != "NULL") %>%
  mutate(sentence_type = case_when(grepl("Jail", sentence_type_original) ~ "Jail",
                                  grepl("Prison", sentence_type_original) ~ "Prison",
                                  T ~ "Unk/Other Confinement"))


####

# Court Sentences to Supervision
  ## court_sent2 contains one row per sentence event component in which the sentence event is supervision (e.g. probation) and one NULL row for each court case without a sentence event. Sometimes terms for each sentence event are split across rows and are considered different sentence components. 
court_sent2 <- lapply(c("", "_2", "_2020-01-06"), function(i){
  fread(paste0("Historical Data Submissions/Alameda/SUP", i, ".csv"), colClasses = "character")}) %>%
  bind_rows()


# Variable name standardization--See pg. xxx for more details.
names(court_sent2) <- c("court_case_id", "court_docket_id", "event_num", "event_id", "sentence_date", "amend_reason_code", "amend_reason", "sentence_id", "component_instance_id", "probation_type_code", "sentence_type_original", "start_date", "end_date", "term_years", "term_months", "term_days", "latest_status_code", "latest_status")


# Date Reformatting--See pg. xxx for more details.
court_sent2 <- court_sent2 %>%
  mutate_at(vars(sentence_date, start_date), funs(if_else(grepl("-", .), as_date(.), mdy(.)))) %>%
  distinct()


# Standardize Factors--See pg. xxx for more details.
court_sent2 <- court_sent2 %>%
  filter(sentence_type_original != "NULL") %>%
  mutate(sentence_type = case_when(grepl("Probation", sentence_type_original) ~ "Probation",
                                  T ~ "Other"))
```

  Court Collapse
```{r}
# Court Charge Collapse--See pg. xxx for more details about this process. 
court_dispo <- court_charge %>%
  mutate(disposition_type = ordered(disposition_type, levels = c("Other", "Dismissed", "Not_Guilty", "Nolo_Contendere", "Guilty")))
  group_by(court_case_id) %>%
  ## Charges that have not been disposed of are removed. We are only looking at disposed charges. Additionally, we may be overcounting the number of charges due to duplicates based on charge id and charge history id. This needs to be addressed further.  
  filter(stage %in% c("DISPOSITION EVENT")) %>%
  select(-c(disposition_num, charge_id, charge_history_id, offense_id, disposition_hist_id, disposition_id, disposition_type_code, amend_reason_id, amend_reason)) %>%
  group_by(court_case_id) %>%
  mutate(hierarchy = if_else(is.na(hierarchy), 1e6, as.numeric(hierarchy))) %>%
  mutate(disposition_date = max(disposition_date, na.rm = T),
         disposition_type = max(disposition_type),
         sentence_date = min(sentence_date, na.rm = T),
         max_court_charge_level = court_charge_level[hierarchy == min(hierarchy)][1],
         max_court_charge_code = court_charge_code[hierarchy == min(hierarchy)][1],
         max_court_charge = court_charge[hierarchy == min(hierarchy)][1],
         max_charge_description = master_charge_description[hierarchy == min(hierarchy)][1],
         max_hier = min(hierarchy)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, .))) %>%
  mutate_at(vars(contains("flag")), funs("count" = sum(.))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  filter(hierarchy == min(hierarchy)) %>%
  ungroup() %>%
  distinct(court_case_id, .keep_all = T)

court_dispo <- court_charge_disp %>%
  mutate(disposition_type = ordered(disposition_type, levels = c("Other", "Dismissed", "Not_Guilty", "Nolo_Contendere", "Guilty"))) %>%
  mutate(hierarchy = if_else(is.na(hierarchy), 1e6, as.numeric(hierarchy))) %>%
  group_by(court_case_id) %>%
  mutate(disposition_date = max(disposition_date),
         disposition_type = max(disposition_type),
         sentence_date = min(sentence_date, na.rm = T))


# Court FTAs are collapsed to each case. 
  ## Court FTA war is used due to the very small number of ftas that do not have a bench warrant issued along with it.  
court_fta_war <- court_fta_war %>%
  arrange(fta_warrant_date) %>%
  group_by(court_case_id) %>%
  mutate(fta_flag = max(fta_flag),
         fta_flag_count = sum(fta_flag)) %>%
  distinct(court_case_id, .keep_all = T) %>%
  select(-c(fta_id, fta_type_code, fta_type))


# Court hearings are filtered for arraignment information and collapsed to court case id. 
court_hearing <- court_hearing %>%
  filter(hearing_type == "Arraignment") %>%
  arrange(hearing_date) %>%
  rename(arraignment_date = hearing_date,
         arraignment_date_time = hearing_date_time) %>%
  arrange(arraignment_date) %>%
  distinct(court_case_id, .keep_all = T) %>%
  select(court_case_id, arraignment_date, arraignment_date_time)


# Court hearings are filtered for plea events  and collapsed to court case id. 
  ## The disposition prefix in this case is misleading because of Alameda's vertifcal data structure. It actually represents plea information when filtered for the the "Plea Event" stage.  
court_plea <- court_charge %>%
  filter(stage %in% c("PLEA EVENT")) %>%
  filter(!is.na(disposition_date)) %>%
  arrange(disposition_date) %>%
  mutate(guilty_plea_flag = if_else(plea_type %in% c("Guilty", "Nolo_Contendere"), 1, 0)) %>%
  group_by(court_case_id) %>%
  mutate(guilty_plea_flag = max(guilty_plea_flag)) %>%
  ungroup() %>%
  distinct(court_case_id, .keep_all = T) %>%
  select(court_case_id, plea_date = disposition_date, plea_type = disposition_type, guilty_plea_flag)


# Court sentences are combined and collapsed to court case id. 
  ## Currently whatever is in the top row of sentence type is filtered. E.g. if the first row is "Jail" and the second is "Prison", "Jail" will be the selected row. However, confinement is always given priority over any type of supervision because court_sent contains sentences to confinment and and court_sent2 contains sentences to supervision.  
court_sent <- bind_rows(court_sent, court_sent2) %>%
  arrange(sentence_date) %>%
  distinct(court_case_id, .keep_all = T) %>%
  select(court_case_id, sentence_date, sentence_type_original, sentence_type)


# All data is joined.
court_df <- reduce(list(court_dispo, court_df, court_fta_war, court_hearing, court_plea, court_sent), left_join, by = "court_case_id") %>%
  select(-contains(".y")) %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x", "", .))) %>%
  mutate(pretrial_end_date = if_else(disposition_date < sentence_date|is.na(sentence_date), disposition_date, sentence_date),
         conviction_flag = if_else(disposition_type %in% c("Nolo_Contendere", "Guilty"), 1, 0))

# I maybe should go back and include cases without dispostions to help with matching
```

  Court Diagnostics
```{r eval=FALSE, include=FALSE}
court_charge %>%
  count(court_charge) %>%
  arrange(desc(n))

court_charge %>%
  filter()

charge_hier %>%
  filter(charge == "273A")

str_extract()

# Diagnostic Code for Charge Hierarchy
# 1 - 60,401/1,178,423 = 95% match rate
(1 - nrow(court_charge %>% filter(is.na(hierarchy)))/nrow(court_charge))*100

court_charge %>%
  filter(is.na(hierarchy)) %>%
  count(join_var) %>%
  arrange(desc(n))

court_charge %>%
  mutate(stage = toupper(stage)) %>%
  filter(stage == "DISPOSITION EVENT") %>%
  filter(!grepl("Dism|DISM", disposition_type_original)) %>%
  count(disposition_type_original) %>%
  arrange(desc(n))
  # count(stage)

# Diagnostics
court_fta %>%
  count(fta_all_flag)

court_fta_war %>%
  count(fta_flag)

full_join(court_fta %>% filter(fta_all_flag == 1), court_fta_war %>% filter(fta_flag == 1) %>% rename(fta_date = fta_war_date), by = c("court_case_id", "fta_date")) %>%
  filter(fta_all_flag != fta_flag) %>%
  add_count(court_case_id) %>%
  filter(n > 1) %>%
  arrange(court_case_id, fta_date)

court_hearing %>%
  count(hearing_type_original) %>%
  arrange(desc(n))
  
court_charge %>%
  filter(stage %in% c("DISPOSITION EVENT")) %>%
  select(-c(disposition_num, charge_id, charge_history_id, offense_id, disposition_hist_id, disposition_id, disposition_type_code, amend_reason_id, amend_reason))
  # filter(stage %in% c("Sentence Event")) %>%
  count(dispos) %>%
  arrange(desc(n))
  
court_dispo %>%
  distinct(court_case_id, disposition_date, .keep_all = T) %>%
  add_count(court_case_id) %>%
  filter(n > 1) %>%
  arrange(desc(n))

court_charge %>%
  filter(stage %in% c("PLEA EVENT")) %>%
  count(disposition_type_original) %>%
  arrange(desc(n))
  distinct(court_case_id, disposition_date, .keep_all = T) %>%
  add_count(court_case_id) %>%
  filter(n > 1) %>%
  arrange(desc(n))
  # select(-c(disposition_num, charge_id, charge_history_id, offense_id, disposition_hist_id, disposition_id, disposition_type_code, amend_reason_id, amend_reason))
  # filter(stage %in% c("Sentence Event")) %>%
  count(dispos) %>%
  arrange(desc(n))

court_charge %>%
  # filter(stage %in% c("CASE FILING")) %>%
  # filter(stage %in% c("SENTENCE EVENT", "DISPOSITION EVENT")) %>%
  # distinct(court_case_id) 
  count(stage)
  filter(court_case_id == "921214")
```

Join
  Jail Court Join
```{r}
#Joining--Please see page xxx for more detials.
  ## In Alameda's case they have an itegrated data system so it is only combined on court_case_id. This acts as a completely sufficient join identifier. 

# Remove extraneous objects in the environment
rm(list = ls()[!ls() %in% ls(pattern = "df")])

#Check for common variables between Jail, Court, and Assessment if Assessment data exists. 
  ## Alameda has no assessment data. 
names(book_df)[names(book_df) %in% names(court_df)]


#Turning NULL to NA to ensure non matching and removing generic charge info from data frames
book_df <- book_df %>%
  mutate_if(is.character, list(~na_if(., "NULL"))) %>%
  select(-c(charge, charge_level, charge_code)) %>%
  mutate_at(vars(first_name, last_name), toupper) %>%
  mutate(court_case_id = as.character(court_case_id))

court_df <- court_df %>%
  mutate_if(is.character, list(~na_if(., "NULL"))) %>%
  select(-c(charge, charge_level, charge_code)) %>%
  mutate_at(vars(first_name, last_name), toupper) 

# Court Matching


#Joining on CII and Court ID
join1 <- inner_join(book_df, court_df, by = c("court_case_id"), na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(paste0("arrest_", gsub("\\.x$", "", .)))) %>%
  rename_at(vars(contains(".y")), funs(paste0("court_", gsub("\\.y$", "", .)))) %>%
  # 8 Duplicates with missing dispositions which will be dropped later. 
  distinct()

j1 <- anti_join(book_df, court_df, by = c("court_case_id"), na_matches = "never")
c1 <- anti_join(court_df, book_df, by = c("court_case_id"), na_matches = "never")

  #Examine if set of common variables is distinct--yes, court_case_id is distinct for court cases. 
  join1 %>%
    add_count(court_case_id) %>%
    filter(n > 1) %>%
    arrange(desc(n))
  
#Diagnostics
  #Jail and Court Matches by category--80% Jail and 93% Court. 
tibble(
  stage = 1,
  match = c(
    'c("court_case_id")'
  ),
  jail_match_rate = sapply(1, function(i) {
    (nrow(book_df) - nrow(get(paste0("j", i)))) / nrow(book_df) * 100
  }),
  court_match_rate = sapply(1, function(i) {
    (nrow(court_df) - nrow(get(paste0("c", i)))) / nrow(court_df) * 100
  })
)

#Combing all joined data frames together.
  ## In Alameda's case they have an itegrated data system so it is only combined on court_case_id. This acts as a completely sufficient join identifier. 
join_df <- join1
```
  
  Join Diagnostics
```{r}
anti_join(assess_df, book_df)

assess_df %>%
  mutate_if(is.character, list(~na_if(., "(Missing)"))) %>%
  filter(is.na(book_num))

tibble(Type = c("Jail", "Court"), c(nrow()))  
  

#Joining on Name--Don't use
join4 <- inner_join(j3, c3, by = c("first_name", "last_name", "dob"), na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(paste0("arrest_", gsub("\\.x$", "", .)))) %>%
  rename_at(vars(contains(".y")), funs(paste0("court_", gsub("\\.y$", "", .)))) %>%
  #1 Duplicate with missing dispositions which will be dropped later. 
  distinct()

j4 <- anti_join(j3, c3, by = c("first_name", "last_name", "dob"), na_matches = "never")
c4 <- anti_join(c3, j3, by = c("first_name", "last_name", "dob"), na_matches = "never")

  #Examine if set of common variables is distinct--yes except 8 spurious cases.
  join4 %>%
    add_count(book_num) %>%
    filter(n > 1) %>%
    arrange(desc(n))
  

#Diagnostics
join1 %>%
  distinct(.keep_all = T) %>%
  add_count(court_docket_id, cii, book_num, .keep_all = T) %>%
  filter(n > 1)
  distinct(court_docket_id, book_num, .keep_all = T)

nest %>%
  select(court_df) %>%
  filter(!is.null(court_df)) %>%
  select(num)

df <- tibble(a = c())

df %>%
  na_if("NULL")

nrow(NULL)

court_df %>%
  filter(!is.na(cii), !is.na(court_docket_id)) %>%
  filter(!is.na(court_charge)) %>%
  add_count(court_docket_id, cii) %>%
  filter(n > 1) %>%
  arrange(court_docket_id)

court_df %>%
  filter(is.na(court_charge))
emi_join(court_df, book_df, by = c("court_docket_id", "cii"))

court_df %>%
  filter(cii != "NULL")

court_df %>%
  arrange(court_case_id)

book_df %>%
  arrange(court_case_id)

book_df %>%
  filter(cii != "NULL")

book_df %>%
  sample_n(size = 100)

court_charge %>%
  distinct(court_case_id)

court_person %>%
  distinct(court_case_id, court_docket_id, .keep_all = T) %>%
  add_count(court_docket_id) %>%
  filter(n > 1) %>%
  arrange(desc(n))
c4 <- anti_join(c3, j3, by = c("court_id"), na_matches = "never")  

fresno_court_nm <- c4
save(fresno_court_nm, file = "Unmatched Fresno Court Data.RData")

# join <- bind_rows(join1, join2, join3, join4)
join <- bind_rows(join1, join2, join3, join4, .id = "join_group")

rm(list = ls()[!ls() %in% c("assess_df", "charge_hier", "release_df")])
# save(j9, file = "Jail Data Unmatched")
# save(c9, file = "Court Data Unmatched")
```

Code Book
  Creation
```{r eval=FALSE, include=FALSE}
rm(original_field)

original_df <- bind_rows(original_df)

Alameda_df <- lapply(ls()[!grepl("original", ls())], function(i){
  df <- get(i)
  
  if(sum(grepl("date", names(df))) > 0){
  df2 <- df %>%
  select(contains("date"), -contains("time")) %>%
  gather("modified_field", "value") %>%
  group_by(modified_field) %>%
  summarise_all(funs(min = as.character(min(., na.rm = T)), mean = as.character(mean(., na.rm = T)), max = as.character(max(., na.rm = T))))
  }else{
    df2 <- tibble(modified_field = NA_character_, min = NA_character_, mean = NA_character_, max = NA_character_)
  }
  
  df <- df %>%
    mutate_if(~length(unique(.)) > 50|is.Date(.)|is.POSIXct(.), ~(. = "not_factor")) %>%    
    mutate_all(~if_else(is.na(.), "na_missing", as.character(.))) %>%
    gather(modified_field, factor_value) %>%
    count(modified_field, factor_value) %>%
    mutate(table_name = i, county = "Alameda") %>%
    mutate(factor_flag = if_else(factor_value == "not_factor", 0, 1)) %>%
    group_by(table_name, modified_field) %>%
    mutate(table_count = sum(n)) %>%
    ungroup() %>%
    rename("factor_count" = "n") %>%
    mutate(factor_count = if_else(factor_value == "not_factor", NA_integer_, factor_count),
           factor_percent = round(factor_count/table_count*100, 1)) %>%
    arrange(desc(factor_flag), modified_field, desc(factor_count))
  
  df <- left_join(df, df2, by = "modified_field")
    }) %>% 
  bind_rows() %>%
  left_join(original_df) %>%
   select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_count,
           factor_percent, table_count, min, mean, max) 

write.xlsx(Alameda_df, file = "Code Books/Alameda Code Book.xlsx")
```

  Completion
```{r}
files <- list.files("C:/Work/PretrialAssessmentPilot/Code Books/Code Book Notes", pattern = "Alameda", full.names = T)

df <- lapply(files, read_excel)

df[[2]] <- df[[1]] %>%
  mutate(factor_standard = "") %>%
  select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_standard, factor_count, factor_percent, 
         table_count, "st_notes" = `Factor Description`, min, mean, max)

df <- list(df[[2]], df[[1]])

write.xlsx(df, file = "C:/Work/PretrialAssessmentPilot/Code Books/Variable Construction/Alameda Factor Construction.xlsx", asTable = T, tableStyle = "TableStyleMedium1", sheetName = c("Variable Construction", "jw_notes", "nl_notes"))
```
  
  Factors
```{r}
factor_df <- lapply(ls()[!grepl("original|^df|hier", ls())], function(i){
  df <- get(i)
  if(sum(grepl("original", names(df))) == 0){
    return(NULL)
  }else{
    var_names <- names(df)[grepl("original", names(df))]
    var_names2 <- gsub("_original", "", var_names)
   
    df1 <- df %>%
     select(var_names) %>%
     gather(original_field, original_value)
   
    df2 <- df %>%
     select(var_names2) %>%
     gather(modified_field, modified_value)
   
   df <- bind_cols(df1, df2) %>%
     count(original_field, modified_field, original_value, modified_value) %>%
     arrange(modified_field, desc(n)) %>%
     group_by(modified_field) %>%
     mutate(row = row_number(),
            percent = round(n/sum(n)*100)) %>%
     ungroup() %>%
     filter(row <= 50) %>%
     select(-row) %>%
     rename("total" = n)
   }
  }) %>%
  bind_rows()

write.xlsx(factor_df, file = "C:/Work/PretrialAssessmentPilot/Code Books/Factor Code Book/Alameda Factor Code Book.xlsx", asTable = T, tableStyle = "TableStyleMedium1", colWidths = "auto")
```
  

DOJ CII/Linking Extraction
```{r}
# Grab Tables with CII
df <- sapply(ls()[which(sapply(ls(), function(i){
  sum(names(get(i)) %in% "cii")
}) == 1)], get)

# Pull CII and other identifiers
doj_book <- df[[1]] %>%
  select(cii, fbi, local_id, first_name, last_name, dob, cdl_id, cdl_state, race_original, sex_original, local_id) %>%
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) %>%
  distinct()


doj_court <- df[[2]] %>%
  select(cii, fbi, cdl_id, cdl_state, dob, race_original, sex_original, first_name, last_name, local_id, local_id) %>%
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) %>%
  distinct()

# Examine missing ciis and duplicates on cii. 
doj_book %>% #Off by about 55,000
  distinct()

doj_book %>% 
  distinct(cii)

doj_book %>% 
  distinct() %>%
  add_count(cii) %>%
  filter(n > 1) %>%
  arrange(desc(n)) %>% 
  View()

doj_court %>% #Off by about 45,000
  distinct()

doj_court %>% 
  distinct(cii)

doj_court %>% 
  distinct() %>%
  add_count(cii) %>%
  filter(n > 1) %>%
  arrange(desc(n)) %>% 
  View()

#In this case, it is clear that the local ID is not a true person identifier but rather an event identifier and so should be removed.

doj_book <- doj_book %>% select(-local_id)
doj_court <- doj_court %>% select(-local_id)

doj_book %>% # Off by about 7,000
  distinct()

doj_book %>% 
  distinct(cii)

doj_book %>% 
  distinct() %>%
  add_count(cii) %>%
  filter(n > 1) %>%
  arrange(desc(n)) %>% 
  View()

doj_court %>% #Off by about 9,000
  distinct()

doj_court %>% 
  distinct(cii)o

doj_court %>% 
  distinct() %>%
  add_count(cii) %>%
  filter(n > 1) %>%
  arrange(desc(n)) %>% 
  View()

#CIIs for DOJ
doj_cii <- bind_rows(doj_book %>% select(cii), doj_court %>% select(cii)) %>% distinct()


#Create an excel workbook with all data table. Make sure to include the cii table first. 
write.xlsx(list(doj_cii, doj_book, doj_court), file = "CIIs for DOJ/Alameda CIIs and Demographics for DOJ.xlsx", sheetName = c("ciis", "booking", "court"))
```


Join
```{r eval=FALSE, include=FALSE}
#Alameda has an integrated criminal justice system. Information is joined across agencies on the jail_court_ID. It is contained in the book_df, court_df, and book_charge tables. 

#Jail Court ID is duplicated when split between cases
book_df <- book_df %>% distinct(jail_court_id, .keep_all = T)

#Jail Court ID is duplicated when split between cases
court_df <- court_df %>% distinct(jail_court_id, .keep_all = T)

book_no_court <- anti_join(book_df, court_df, by = c("jail_court_id"))
nrow(book_df)
nrow(book_no_court)
nrow(book_no_court)/nrow(book_df)

court_no_book <- anti_join(court_df, book_df, by = c("jail_court_id"))
nrow(court_df)
nrow(court_no_book)
nrow(court_no_book)/nrow(court_df)
```

# Los Angeles

Jail Data
```{r}
# Jail Bookings Data Import--- Los Angeles, 2015-01-01 to 2020-01-06
  ## book_df contains one row per booking/charge/courtcase combination and includes information on the person as well as the time of booking and release. Currently the charges are incorrectly duplicated across each court case. This is split apart after the names are standardized and the court cases have been separated out. 
  # book_charge is constructed from book_df and contains one row per booking/charge combination and contains other information on the booking. LA has no booking type information.  
  ## book_court is contrsucted from book_df contains one row per booking/courtcase combination. No other information is included.  


####

# Jail Bookings--Historical and Q1
  ## book_df contains one row per booking/charge/courtcase combination and includes information on the person as well as the time of booking and release. Currently the charges are incorrectly duplicated across each court case. This is split apart after the name standardization.  
book_df <- lapply(2015:2019, function(i){
  read_xlsx(paste0("Historical Data Submissions/Los Angeles/",i, "_data_fields_added.xlsx"))}) %>%
  bind_rows()

  ## Submission 2 data came in with slightly different names, but in the same order, so I changed the names to match the first submission before joining them.   
book_df2 <- read_xlsx("Historical Data Submissions/Los Angeles/LACounty_July_Dec2019.xlsx")
names(book_df2) <- names(book_df)

book_df <- bind_rows(book_df, book_df2) %>% distinct()
rm(book_df2)


# Variable name standardization--See pg. xxx for more details. 
names(book_df) <- c("last_name", "first_name", "dob", "race_original", "sex_original", "cdl_id", "cii", "arrest_date", "book_date", "book_num", "court_case_id", "arrest_charge_original", "arrest_charge_level_original", "release_date", "release_type_original", "bail")

####

# Booking charges
  ## book_charge is constructed from book_df and contains one row per booking/charge combination and contains other information on the booking. LA has no booking type information.  
book_charge <- book_df %>%
  select(-court_case_id) %>%
  distinct()


# Standardize Factors--See pg. xxx for more details.
book_charge <- book_charge %>%
  mutate(sex = case_when(sex_original %in% c("M") ~ "Male",
                         sex_original %in% c("F") ~ "Female"),
         
         race = case_when(race_original %in% c("B") ~ "Black",
                          race_original %in% c("H") ~ "Hispanic",
                          race_original %in% c("W") ~ "White",
                          #All Other races/ethnicities collapsed into other
                          T ~ "Other_Unknown"),
        
         book_type = case_when(release_type_original %in% c("DCLR") ~ "Sup_Vio_Post",
                               T ~ "Unknown"),
         
         release_type = case_when(release_type_original %in% c("CUST") ~ "Prison",
                                  release_type_original %in% c("EXP") ~ "Hold_Release",
                                  release_type_original %in% c("SHRT", "PROB", "TSER", "ERLY", "24HR", "SUSP") ~ "Time_Served",
                                  release_type_original %in% c("CITE") ~ "Cite_Release",
                                  release_type_original %in% c("BOND", "BAIL") ~ "Bail_Bond",
                                  release_type_original %in% c("DISM", "REJ", "49B1", "WDEF") ~ "Dismissed_Dropped",
                                  release_type_original %in% c("OR") ~ "OR",
                                  release_type_original %in% c("ORDS") ~ "Court_Order",
                                  release_type_original %in% c("PRCT") ~ "Unspec_Capacity",
                                  release_type_original %in% c("PRET") ~ "Pretrial_Sup",
                                  T ~ "Other"))

# Standardize Charges and join charge hierarchy--See pg. xxx for more details about this process. 
book_charge <- book_charge %>%
  # mutate(attempt = if_else(grepl("664", arrest_charge_original), 1, 0)) %>%
  # separate_rows(arrest_charge_original, sep = "\\\\|\\-|\\/") %>%
  mutate(arrest_charge_level = if_else(!arrest_charge_level_original %in% c("F", "M", "I"), "Other", arrest_charge_level_original),
         #|ALC|AUTO|PTT|GTA|ACC|BAT|RSD|PSN|RES|DD|COM|SHP|FDG
         arrest_charge = gsub("-F|-M", "", arrest_charge_original),
         arrest_charge = gsub("PC.*$", "PC", arrest_charge),
         arrest_charge = gsub("VC.*$", "VC", arrest_charge),
         arrest_charge = gsub("LA.*$", "LA", arrest_charge),
         arrest_charge_code = str_extract(arrest_charge, "..$")) %>%
  separate_rows(arrest_charge, sep = "-") %>%
  mutate(arrest_charge_code = if_else(!arrest_charge_code %in% c("PC", "VC", "HS", "BP", "WI", "US"), "Other", arrest_charge_code),
         arrest_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}|EX|\\+|[A-Z]{2}$","", arrest_charge))) %>%
  unite(join_var, arrest_charge_level, arrest_charge_code, arrest_charge, remove = F)

load("Complete Charge Code Hierarchy.RData")

book_charge <- left_join(book_charge, charge_hier, by = "join_var") %>%
  mutate(felony_flag = if_else(arrest_charge_level == "F", 1, 0),
         misd_flag = if_else(arrest_charge_level == "M", 1, 0)) %>%
  rename_at(vars(contains("flag")), funs(paste0("arrest_", .))) 

####

# Booking court case matches
    ## book_court is contrsucted from book_df contains one row per booking/courtcase combination. No other information is included.   
book_court <- book_df %>%
  select(book_num, court_case_id) %>%
  distinct() %>%
  filter(!is.na(court_case_id))
```

  Jail Collapse
```{r}
# Booking Collapse--See pg. xxx for more details about this process.
  ## LA's court case information was previously seperated due to innaccurate duplicates. After the charges are collapsed, the court case information is reattached. 
book_charge <- book_charge %>%
  mutate(time_first_release = release_date - book_date) %>%
  mutate(hierarchy = if_else(is.na(hierarchy), 1e6, as.numeric(hierarchy))) %>%
  group_by(book_num) %>%
  mutate(max_booktype = book_type[hierarchy == min(hierarchy)][1],
         max_arrest_charge = arrest_charge[hierarchy == min(hierarchy)][1],
         max_charge_description = master_charge_description[hierarchy == min(hierarchy)][1],
         max_hier = min(hierarchy)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, .))) %>%
  mutate_at(vars(contains("flag")), funs("count" = sum(.))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  filter(hierarchy == min(hierarchy)) %>%
  ungroup() %>%
  distinct(book_num, .keep_all = T) 

book_df <- left_join(book_charge, book_court)
```

  Jail Diagnostics
```{r eval=FALSE, include=FALSE}

book_df %>%
  filter(cii == "A32188627") %>%
  # count(court_case_id)
  arrange(court_case_id) %>%
  # count(charge)
  View()

  filter(book_num == "4065590")
  add_count(book_num, court_case_id, join_var)


# Diagnostics
book_df %>%
  distinct(book_num, court_case_id) %>%
  arrange(book_num) %>%
  group_by(book_num) %>%
  add_count() %>%
  filter(n > 1)

book_df %>%
  distinct(local_id, book_date)
  
court_df %>%
  filter(grepl("4CA1459901|4CA1667601|5CA0613601", court_docket_id)) %>%
  distinct(court_docket_id, count, .keep_all = T) %>%
  view()
  filter(cii == "A32842482")
  
court_df %>%
  filter(cii == "A32188627") %>%
  # filter(grepl("3WA0198101|4IG0134201|4IG0393001|C646594194", court_docket_id)) %>%
  distinct(court_docket_id, count, .keep_all = T) %>%
  slice(-1) %>%
  view()  

book_df %>%
  filter(first_name == "MINGO", last_name == "MONTGOMERY") %>%
  View()

court_df %>%
  filter(first_name == "MINGO", last_name == "MONTGOMERY") %>%
  View()
  # filter(grepl("BA37474301|MA06285901|5AV0462001|MA069731W1", court_docket_id)) 

book_df %>%
  filter(book_num == "4873206") 
  count(charge)

court_df %>%
  filter(first_name == "MINGO", last_name == "MONTGOMERY")

book_df %>%
  distinct(book_num)

book_df %>%
  count(arrest_charge_level_original) %>%
  arrange(desc(n))

book_df %>%
  # filter(arrest_charge_level_original == "SA") %>%
  count(arrest_charge_code_original) %>%
  arrange(desc(n))

book_df %>%
  count(arrest_charge_original) %>%
  arrange(desc(n))

book_df %>%
  count(arrest_charge_level)

book_df %>%
  count(arrest_charge_code) %>%
  arrange(desc(n))

book_df %>%
  count(arrest_charge) %>%
  arrange(desc(n))

#No Ambiguity
book_df %>%
  count(arrest_charge, arrest_charge_original) %>%
  group_by(arrest_charge) %>%
  add_count() %>%
  filter(n > 1) %>%
  arrange(desc(n))

#No combined charges
book_charge %>%
  filter(grepl("/", arrest_charge_original))

#Many Municipal Codes are caught up in the arrest charge 
book_df %>%
  # mutate(attempt = if_else(grepl("664", arrest_charge_original), 1, 0)) %>%
  # separate_rows(arrest_charge_original, sep = "\\\\|\\-|\\/") %>%
  mutate(arrest_charge_level = if_else(!arrest_charge_level_original %in% c("F", "M", "I"), "Other", arrest_charge_level_original),
         arrest_charge_code = str_extract(arrest_charge_original, "..$")) %>%
  filter(!grepl("[A-Z]{2}$", arrest_charge_original)) %>%
  count(arrest_charge_original) %>%
  arrange(desc(n))

#No Attempt codes
book_df %>%
  filter(grepl("664", arrest_charge_original))

#
book_df %>%
  filter(grepl("-", arrest_charge_original)) %>%
  count(arrest_charge_original) %>%
  arrange(desc(n))

# 1 - 7,901/267,372 = 97% non-match rate
(1 - nrow(book_df %>% filter(is.na(hierarchy)))/nrow(book_df))*100

book_df %>%
  filter(is.na(hierarchy)) %>%
  count(join_var) %>%
  arrange(desc(n))

book_df %>%
  filter(join_var == "F_Other_487DPCG")
```

Court Data
```{r}
# Court Information Historical and Q1
court_df <- fread("Historical Data Submissions/Los Angeles/JCC-historical-court-cases2.csv",
                  sep = "|")

# original_field <- names(court_df)

names(court_df) <- c("row_num", "court_case_id", "court_docket_id", "local_id", "cii", "first_name", "last_name", "dob", "sex_original", "race_original", "file_date", "charge_id", "count", "court_charge_code_original", "court_charge_original", "court_charge_level_original", "disposition_id", "disposition_type_original", "disposition_code", "disposition_date", "sentence_time", "fine_amt", "sentence_time_code", "sentence_location", "fine_or_jail_code", "probation_code", "probation_length", "probation_length_code", "probation_andor_code", "book_num")

# original_df[[2]] <- tibble(table_name = "court_df", original_field = original_field, modified_field = names(court_df))

#Court Charge Standardization
  ## LAs use of "/" doesn't actually appear to be separate charges. This should be checked with the lawyers. E.g. (242/243 B is only one charge)
court_df <- court_df %>%
  mutate(attempt = if_else(grepl("664/", court_charge_original), 1, 0),
         court_charge = gsub("664/", "", court_charge_original)) %>% 
  separate_rows(court_charge, sep = "/|&|\\\\") %>%
  mutate_at(vars(contains("date"), dob), as_date) %>%
  mutate(court_charge_level = if_else(!court_charge_level_original %in% c("F", "M", "I"), "Other", court_charge_level_original),
         court_charge_code = if_else(!court_charge_code_original %in% c("PC", "VC", "HS", "BP", "WI", "US"), "Other", court_charge_code_original),
         court_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}","", court_charge))) %>%
  mutate(court_charge_code = if_else(court_charge_code == "Other" & court_charge == "484A", "PC", court_charge_code)) %>%
  unite(join_var, court_charge_level, court_charge_code, court_charge, remove = F)  

load("Complete Charge Code Hierarchy.RData")

court_df <- left_join(court_df, charge_hier, by = "join_var")

court_df <- court_df %>%
  left_join(charge_hier) %>%
  mutate(felony_flag = if_else(court_charge_level == "F", 1, 0),
         misd_flag = if_else(court_charge_level == "M", 1, 0)) %>%
  mutate_at(vars(contains("flag")), funs("conviction" = if_else(. == 1 &  disposition_code %in% c("CON", "CNJ", "CNC"), 1, 0))) %>%
  rename_at(vars(contains("flag"), -contains("conviction")), funs(paste0("court_", .))) %>%
  rename_at(vars(contains("conviction")), funs(paste0("conviction_", gsub("_conviction", "", .))))
 


# Factor Standardization
court_df <- court_df %>%
  mutate(sex = case_when(sex_original %in% c("M") ~ "Male",
                         sex_original %in% c("F") ~ "Female",
                         T ~ "Other_Unknown"),
         
         race = case_when(race_original %in% c("B") ~ "Black",
                          race_original %in% c("H") ~ "Hispanic",
                          race_original %in% c("W") ~ "White",
                          #All Other races/ethnicities collapsed into other
                          T ~ "Other_Unknown"),
         
         disposition_type = case_when(disposition_code %in% c("CON", "CNJ", "CNC") ~ "Guilty",
                                 disposition_code %in% c("DIA", "DIN", "DID", "DIM", "DIP", "DIC", "DIS") ~ "Dismissed",
                                 disposition_code %in% c("AQJ", "ACQ") ~ "Not_Guilty",
                                 T ~ "Other"))


# Court FTA Data Historical and Q1
court_fta <- fread("Historical Data Submissions/Los Angeles/JCC-historical-bench-warrants2.csv", 
                   sep = "|")

# original_field <- names(court_fta)

names(court_fta) <- c("row_num", "court_case_id", "court_docket_id", "fta_warrant_id", "fta_warrant_date", "fta_warrant_disposition_date")

# original_df[[3]] <- tibble(table_name = "court_fta", original_field = original_field, modified_field = names(court_fta))

court_fta <- court_fta %>%
  mutate_at(vars(contains("date")), as_date) %>%
  mutate(fta_flag = 1)

```
 
  Court Collapse
```{r}
suppressWarnings(court_df <- court_df %>%
  arrange(file_date) %>%
  group_by(court_case_id) %>%
  mutate(disposition_date = max(disposition_date, na.rm = T),
         sentence_date = min(disposition_date[disposition_type == "Guilty"][1], na.rm = T)) %>%
  mutate(hierarchy = if_else(is.na(hierarchy), 1e6, as.numeric(hierarchy))) %>%
  mutate(max_court_charge_level = court_charge_level[hierarchy == min(hierarchy)][1],
         max_court_charge_code = court_charge_code[hierarchy == min(hierarchy)][1],
         max_court_charge = court_charge[hierarchy == min(hierarchy)][1],
         max_charge_description = master_charge_description[hierarchy == min(hierarchy)][1],
         max_hier = min(hierarchy)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, .))) %>%
  mutate_at(vars(contains("flag")), funs("count" = sum(.))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  filter(hierarchy == min(hierarchy)) %>%
  ungroup() %>%
  distinct(court_case_id, book_num, .keep_all = T) %>%
  mutate(final_disposition_date = if_else(disposition_date < sentence_date|is.na(sentence_date), disposition_date, sentence_date),
         conviction_flag = if_else(!is.na(sentence_date), 1, 0)))

court_fta <- court_fta %>%
  select(-row_num, -fta_warrant_id) %>%
  arrange(fta_warrant_date) %>%
  distinct(court_case_id, court_docket_id, .keep_all = T)

court_df <- court_df %>%
  left_join(court_fta, by = c("court_case_id", "court_docket_id"))
```
  
  Court Diagnostics
```{r eval=FALSE, include=FALSE}

court_df %>%
  count(court_charge_original) %>%
  arrange(desc(n))


court_df %>%
  count(court_charge_level_original) %>%
  arrange(desc(n))

court_df %>%
  # filter(court_charge_level_original == "SA") %>%
  count(court_charge_code_original) %>%
  arrange(desc(n))

court_df %>%
  count(court_charge_original) %>%
  arrange(desc(n))

court_df2 %>%
  count(court_charge_level)

court_df2 %>%
  count(court_charge_code)

#No Ambiguity
court_df2 %>%
  count(court_charge, court_charge_original) %>%
  group_by(court_charge) %>%
  add_count() %>%
  filter(n > 1) %>%
  arrange(desc(n))

#No combined charges
court_df %>%
  filter(grepl("664", court_charge_original)) %>%
  count(court_charge_original) %>%
  arrange(desc(n))

# Diagnostic Code for Charge Hierarchy
# 1 - 60,401/1,178,423 = 95% match rate
(1 - nrow(court_df %>% filter(is.na(hierarchy)))/nrow(court_df))*100

court_df %>%
  filter(is.na(hierarchy)) %>%
  count(join_var) %>%
  arrange(desc(n))

```

Probation (assessment) Data
```{r}
#OR Risk Assessment--Arraignment Favorable, Ineligible, and Unfavorable--Historical to Q1
assess_OR <- read_excel("Historical Data Submissions/Los Angeles/Los Angeles County JCC Data - Arraignment Favorable Recommendations (2015-01 to 2019-09).xlsx")

assess_OR2 <- read_excel("Historical Data Submissions/Los Angeles/Los Angeles County JCC Data - Arraignment Ineligible Applications (2015-01 to 2019-09).xlsx") %>% mutate(`Score(s)` = as.numeric(`Score(s)`), Termination_Date = as_datetime(Termination_Date))

assess_OR3 <- read_excel("Historical Data Submissions/Los Angeles/Los Angeles County JCC Data - Arraignment Unfavorable Recommendations (2015-01 to 2019-09).xlsx") %>% mutate(Termination_Date = as_datetime(Termination_Date))

assess_ORQ1 <- read_excel("C:/Work/PretrialAssessmentPilot/Historical Data Submissions/Los Angeles/Los Angeles County Pretrial Services Bureau - JCC Quarterly SB10 Data (2019-10-01 to 2019-12-31).xlsx", sheet = 2, col_types = "text") %>% 
  mutate_at(vars(Application_Date_Time, Termination_Date, DOB), convertToDateTime) %>%
  mutate_at(vars(contains("Postpoint")), as.numeric) %>%
  unite("Defendant_Name", c(Last_Name, First_Name), sep = ", ") %>%
  rename("Assessment_Date_Time" = Application_Date_Time,
         "Release_Date_Time" = Release_Date,
         "CDL" = CDL_ID,
         "Score(s)" = Risk_Score) %>%
  mutate(`Score(s)` = as.numeric(`Score(s)`))

names(assess_ORQ1) <- gsub("Postpoint", "Tool_Response", names(assess_ORQ1))

assess_OR <- bind_rows(assess_OR, assess_OR2, assess_OR3, assess_ORQ1)

rm(assess_OR2, assess_OR3, assess_ORQ1)

original_field <- names(assess_OR)

names(assess_OR) <- c("application_id", "application_type", "tool_name", "assessment_date_time", "zip_code", "tool_response1", "tool_response2", "tool_response3", "tool_response4", "tool_response5", "tool_response6", "tool_response7", "tool_response8", "tool_response9", "tool_response10", "tool_response11", "tool_response12", "tool_response13", "tool_response14", "risk_score", "release_recommendation_original", "release_date", "release_authorization", "release_decision_original", "release_conditions", "pretrial_violation", "pretrial_violation_date", "court_date_reminder", "other_pretrial_service_original", "termination_outcome", "termination_date", "cii", "fbi", "cdl_id", "local_id", "name", "dob", "sex_original", "race_original", "tool_not_administered")

# original_df[[4]] <- tibble(table_name = "assess_OR", original_field = original_field, modified_field = names(assess_OR))

assess_OR <- assess_OR %>%
  mutate(assessment_date = as_date(assessment_date_time),
         release_date = convertToDate(as.numeric(release_date))) %>%
  mutate_at(vars(termination_date, dob, pretrial_violation_date), as_date) %>%
  separate(name, c("last_name", "first_name"))


#BD Point Scale--Bail Increase, Bail Increae Denied, Not Qualified, Released OR, Bail Reduction Granted, and Bail Reduction Denied
assess_BD <- read_excel("Historical Data Submissions/Los Angeles/Los Angeles County JCC Data - Pre-arraignment Bail Increase and Ineligible Subjects (2015-01 to 2019-09).xlsx", 
                      sheet = 1) %>%  mutate(`Score(s)` = as.numeric(`Score(s)`))

assess_BD2 <- read_excel("Historical Data Submissions/Los Angeles/Los Angeles County JCC Data - Pre-arraignment Bail Increase and Ineligible Subjects (2015-01 to 2019-09).xlsx", 
                      sheet = 2) %>% mutate(Assessment_Date_Time = convertToDateTime(Assessment_Date_Time))

assess_BD3 <- read_excel("Historical Data Submissions/Los Angeles/Los Angeles County JCC Data - Pre-arraignment Bail Increase and Ineligible Subjects (2015-01 to 2019-09).xlsx", 
                      sheet = 3) %>% mutate(`Score(s)` = as.numeric(`Score(s)`))

assess_BD4 <- read_excel("Historical Data Submissions/Los Angeles/Los Angeles County JCC Data - Pre-arraignment OR Release and Bail Reductions Granted (2015-01 to 2019-09).xlsx", 
                      sheet = 1)

assess_BD5 <- read_excel("Historical Data Submissions/Los Angeles/Los Angeles County JCC Data - Pre-arraignment OR Release and Bail Reductions Granted (2015-01 to 2019-09).xlsx", 
                      sheet = 2)

assess_BD6 <- read_excel("Historical Data Submissions/Los Angeles/Los Angeles County JCC Data - Pre-arraignment OR Release Denied (2015-01 to 2019-09).xlsx")

assess_BDQ1 <- read_excel("C:/Work/PretrialAssessmentPilot/Historical Data Submissions/Los Angeles/Los Angeles County Pretrial Services Bureau - JCC Quarterly SB10 Data (2019-10-01 to 2019-12-31).xlsx", sheet = 1, col_types = "text")

assess_BDQ1 <- assess_BDQ1 %>%
  gather(key, value, 15:46) %>%
  mutate(value = as.numeric(value),
         time = tolower(gsub("[0-9]|\\-|_.*", "", key)),
         number = parse_number(key)) %>%
  select(-key) %>%
  spread(time, value) %>%
  mutate(postpoint = if_else(postpoint == 0, prepoint, postpoint)) %>%
  select(-prepoint) %>%
  mutate(number = paste0("Tool_Response", number)) %>%
  spread(number, postpoint) %>%
  rename("Score(s)" = Tool_ResponseNA) %>%
  mutate_at(vars(Application_Date_Time, DOB), convertToDateTime) %>%
  rename("Assessment_Date_Time" = Application_Date_Time,
         "Release_Date_Time" = Release_Date,
         "CDL" = CDL_ID) %>%
  unite("Defendant_Name", c(Last_Name, First_Name), sep = ", ")

assess_BD <- bind_rows(assess_BD2, assess_BD3, assess_BD4, assess_BD5, assess_BD6, assess_BD, assess_BDQ1)

rm(assess_BD2, assess_BD3, assess_BD4, assess_BD5, assess_BD6, assess_BDQ1)

original_field <- names(assess_BD)

names(assess_BD) <- c("application_id", "application_type", "tool_name", "assessment_date_time", "zip_code", "tool_response1", "tool_response2", "tool_response3", "tool_response4", "tool_response5", "tool_response6", "tool_response7", "tool_response8", "tool_response9", "tool_response10", "tool_response11", "tool_response12", "tool_response13", "tool_response14", "tool_response15", "risk_score", "release_recommendation_original", "release_date", "release_authorization", "release_decision_original", "release_conditions", "pretrial_violation", "pretrial_violation_date", "court_date_reminder", "other_pretrial_service_original", "termination_outcome", "termination_date", "cii", "fbi", "cdl_id", "local_id", "name", "dob", "sex_original", "race_original", "tool_not_administered")

# original_df[[5]] <- tibble(table_name = "assess_BD", original_field = original_field, modified_field = names(assess_BD))

assess_BD <- assess_BD %>%
  mutate(assessment_date = as_date(assessment_date_time),
         release_date = convertToDate(as.numeric(release_date)),
         termination_date = mdy(paste(termination_date, year(assessment_date), sep = "/")),
         dob = as_date(dob),
         pretrial_violation_date = convertToDate(pretrial_violation_date)) %>%
  separate(name, c("last_name", "first_name"))

# Probation EM Responses
assess_EM_response <- read_excel("Historical Data Submissions/Los Angeles/California JCC Historical EM Records (Revised 2019-11-25).xlsx", sheet = 2)

assess_EM_responseQ1 <- read_excel("C:/Work/PretrialAssessmentPilot/Historical Data Submissions/Los Angeles/Los Angeles County Pretrial Services Bureau - JCC Quarterly SB10 Data (2019-10-01 to 2019-12-31).xlsx", sheet = 4) %>%
  select(-2)

names(assess_EM_responseQ1) <- names(assess_EM_response)

original_field <- names(assess_EM_response)

assess_EM_response <- bind_rows(assess_EM_response, assess_EM_responseQ1) 

names(assess_EM_response) <- c("key", "tool_question", "tool_response", "score")

# original_df[[6]] <- tibble(table_name = "assess_EM_response", original_field = original_field, modified_field = names(assess_EM_response))

#Probation EM Total 
assess_EM <- read_excel("Historical Data Submissions/Los Angeles/California JCC Historical EM Records (Revised 2019-11-25).xlsx", 
                      sheet = 1) %>%
  select(-`Application ID`)

assess_EMQ1 <- read_excel("C:/Work/PretrialAssessmentPilot/Historical Data Submissions/Los Angeles/Los Angeles County Pretrial Services Bureau - JCC Quarterly SB10 Data (2019-10-01 to 2019-12-31).xlsx", sheet = 3) %>%
  rename("Release_Date_Time" = Release_Date,
         "Score(s)_1" = "Score(s)") %>%
  mutate_at(vars(Termination_Date, PTR_Violation_Date_Time), convertToDateTime)

assess_EM <- bind_rows(assess_EM, assess_EMQ1)

rm(assess_EMQ1)

names(assess_EM) <- c("key",  "cii", "fbi", "local_id", "cdl_id", "first_name", "last_name", "dob", "sex_original", "race_original", "application_id", "tool_name", "assessment_date_time", "zip_code", "tool_response", "risk_score","score_collapse", "release_recommendation_original", "release_authorization", "release_decision_original", "release_date_time","release_conditions","pretrial_violation", "pretrial_violation_date", "court_date_reminder", "other_pretrial_service_original", "termination_outcome", "termination_date")

# original_df[[7]] <- tibble(table_name = "assess_EM", original_field = original_field, modified_field = names(assess_EM))

assess_EM <- assess_EM %>%
  # select(-application_id_redundant) %>%
  mutate(assessment_date = as_date(assessment_date_time),
         release_date = as_date(release_date_time)) %>%
  mutate_at(vars(dob, pretrial_violation_date, termination_date), as_date)


# All Assessments
assess_df <- bind_rows(assess_BD, assess_EM, assess_OR)

# Factor Cleaning

assess_df <- assess_df %>%
  mutate(sex = case_when(sex_original %in% c("M", "Male") ~ "Male",
                         sex_original %in% c("F", "Female") ~ "Female",
                         T ~ "Other_Unknown"),
         
         race = case_when(race_original %in% c("B", "Black") ~ "Black",
                          race_original %in% c("H", "Hispanic") ~ "Hispanic",
                          race_original %in% c("W", "White") ~ "White",
                          #All Other races/ethnicities collapsed into other
                          T ~ "Other_Unknown"),
         release_recommendation = gsub(" .*", "", release_recommendation_original),
         release_recommendation = case_when(release_recommendation %in% c("Not", "INELIGIBLE/NO") ~ "Not_Assessed",
                                            release_recommendation %in% c("Unfavorable", "Denied") ~ "No_Program",
                                            release_recommendation %in% c("Favorable", "Suitable", "Found", "Granted") ~ "OR",
                                            T ~ "Other"),
         release_decision = case_when(release_decision_original %in% c("N/A", "Not Available")|is.na(release_decision_original) ~ "Unknown",
                                      release_decision_original %in% c("OR Release", "Own Recognizance Release") ~ "OR",
                                      release_decision_original %in% c("Electronic Monitoring") ~ "EM")) %>%
  #Release authorization and pretrial service don't contain meaningful data
  select(-release_authorization, -other_pretrial_service_original)

rm(assess_BD, assess_EM, assess_OR, assess_EM_response, assess_EM_responseQ1)

# Flag Creation
assess_df <- assess_df %>%
  mutate(assess_flag = if_else(release_recommendation == "Not_Assessed", 0, 1),
         rec_em_flag = if_else(tool_name == "Modified Wisconsin" & release_recommendation_original %in% c("Found Suitable", 
                                                                                                          "Favorable - Alcohol Monitoring", "Court-Ordered EM"), 1, 0),
         condition_em_flag = if_else(tool_name == "Modified Wisconsin" & release_recommendation_original %in% c("Electronic Monitoring"), 1, 0),
         rec_release_flag = if_else(release_recommendation %in% c("Favorable", "Suitable", "Found", "Granted"), 1, 0))
```

  Assessment Collapase
```{r}
assess_df <- assess_df %>%
  filter(tool_name == "OR Risk Assessment") %>%
  filter(!is.na(risk_score)) %>%
  distinct(application_id, assessment_date, .keep_all = T) %>%
  select(application_id, cii, fbi, cdl_id, local_id, last_name, first_name, dob, sex_original, race_original, sex, race, zip_code, tool_name, assessment_date, 
         assessment_date_time, risk_score, release_recommendation_original, release_decision_original, release_recommendation, release_decision, release_conditions,
         assess_flag, rec_release_flag, rec_em_flag, condition_em_flag)
```
  
  Assessment Diagnostics
```{r}
assess_df %>%
  mutate(release_recommendation_original = gsub(" .*", "", release_recommendation_original)) %>%
  count(release_recommendation_original) %>%
  arrange(desc(n))

assess_df %>%
  count(risk_score) %>%
  arrange(desc(n))

#Diagnostics
assess_df %>%
  filter(tool_name == "OR Risk Assessment") %>%
  # distinct() %>%
  arrange(application_id) %>%
  filter(!is.na(risk_score)) %>%
  add_count(application_id, assessment_date) %>%
  filter(n > 1)

assess_df %>%
  count(court_date_reminder)
```

Join
  Jail Court Join
```{r}
# Remove extraneous objects in the environment
rm(list = ls()[!ls() %in% ls(pattern = "df")])

#Check for common variables
names(book_df)[names(book_df) %in% names(court_df)]

names(book_df)[names(book_df) %in% names(assess_df)]

#Turning NULL to NA to ensure non matching and removing generic charge info from data frames
book_df <- book_df %>%
  mutate_if(is.character, list(~na_if(., "NULL"))) %>%
  select(-c(charge, charge_level, charge_code)) %>%
  mutate_at(vars(first_name, last_name), toupper) %>%
  mutate_at(vars(arrest_date, book_date, release_date), as_date) %>%
  mutate(cii = parse_number(cii))

assess_df <- assess_df %>%
  mutate_if(is.character, list(~na_if(., "NULL"))) %>%
  mutate(cii = parse_number(cii))

court_df <- court_df %>%
  mutate_if(is.character, list(~na_if(., "NULL"))) %>%
  select(-c(charge, charge_level, charge_code)) %>%
  mutate_at(vars(first_name, last_name), toupper) %>%
  mutate(book_num = parse_number(book_num))

#Joining Assessment to Jail Data
join1 <- inner_join(book_df, assess_df, by = c("first_name", "last_name", "book_date" = "assessment_date"), na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x$", "", .))) %>%
  select(-contains(".y")) %>%
  #1 Duplicate with missing dispositions which will be dropped later. 
  distinct()

j1 <- anti_join(book_df, assess_df, by = c("first_name", "last_name", "book_date" = "interview_date"), na_matches = "never")
a1 <- anti_join(assess_df, book_df, by = c("first_name", "last_name", "book_date" = "interview_date"), na_matches = "never")


  #Examine if set of common variables is distinct--yes
  semi_join(book_df, assess_df, by = "book_num", na_matches = "never")

#Joining on Name and Court ID
join2 <- inner_join(j1, a1, by = c("first_name", "last_name", "book_date" = "interview_date"), na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x$", "", .))) %>%
  select(-contains(".y")) %>%
  #1 Duplicate with missing dispositions which will be dropped later. 
  distinct()

j2 <- anti_join(j1, a1, by = c("first_name", "last_name", "book_date" = "interview_date"), na_matches = "never")
a2 <- anti_join(a1, j1, by = c("first_name", "last_name", "interview_date" = "book_date"), na_matches = "never")

  #Examine if set of common variables is distinct--yes
  semi_join(j1, a1, by = c("first_name", "last_name", "book_date" = "interview_date"), na_matches = "never")
  
#Diagnostics
  #Jail and Assessment Matches by category
tibble(
  stage = 1:2,
  match = c(
    'c("book_num")',
    'c("first_name", "last_name", "book_date" = "interview_date")'
  ),
  # jail_match_rate = sapply(1:2, function(i) {
  #   (nrow(book_df) - nrow(get(paste0("j", i)))) / nrow(book_df) * 100
  # }),
  assess_match_rate = sapply(1:2, function(i) {
    (nrow(assess_df) - nrow(get(paste0("a", i)))) / nrow(assess_df) * 100
  })
)
#Recreating Booking
book_df <- bind_rows(join1, join2, j2)  

rm(list = ls()[!ls() %in% ls(pattern = "df")])

#####Jump back here!

# Court Matching

#Joining on CII and Court ID
join1 <- inner_join(book_df, court_df, by = c("book_num"), na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(paste0("arrest_", gsub("\\.x$", "", .)))) %>%
  rename_at(vars(contains(".y")), funs(paste0("court_", gsub("\\.y$", "", .)))) %>%
  # 8 Duplicates with missing dispositions which will be dropped later. 
  distinct()

semi_join(book_df, court_df, by = c("book_num", "court_case_id" = "court_docket_id"))

j1 <- anti_join(book_df, court_df, by = c("court_docket_id", "cii", "dob"), na_matches = "never")
c1 <- anti_join(court_df, book_df, by = c("court_docket_id", "cii", "dob"), na_matches = "never")

  #Examine if set of common variables is distinct--yes except 8 spurious cases.
  join1 %>%
    add_count(cii, court_docket_id, book_num, dob) %>%
    filter(n > 1) %>%
    arrange(desc(n))

#Joining on Name and Court ID
join2 <- inner_join(j1, c1, by = c("court_docket_id", "first_name", "dob"), na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(paste0("arrest_", gsub("\\.x$", "", .)))) %>%
  rename_at(vars(contains(".y")), funs(paste0("court_", gsub("\\.y$", "", .)))) %>%
  #1 Duplicate with missing dispositions which will be dropped later. 
  distinct()

j2 <- anti_join(j1, c1, by = c("court_docket_id", "first_name", "dob"), na_matches = "never")
c2 <- anti_join(c1, j1, by = c("court_docket_id", "first_name", "dob"), na_matches = "never")

  #Examine if set of common variables is distinct--yes except 8 spurious cases.
  join2 %>%
    add_count(first_name, court_docket_id, book_num) %>%
    filter(n > 1) %>%
    arrange(desc(n))

#Joining on Court ID
join3 <- inner_join(j2, c2, by = c("court_docket_id", "first_name"), na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(paste0("arrest_", gsub("\\.x$", "", .)))) %>%
  rename_at(vars(contains(".y")), funs(paste0("court_", gsub("\\.y$", "", .)))) %>%
  #1 Duplicate with missing dispositions which will be dropped later. 
  distinct()

j3 <- anti_join(j2, c2, by = c("court_docket_id"), na_matches = "never")
c3 <- anti_join(c2, j2, by = c("court_docket_id"), na_matches = "never")

  #Examine if set of common variables is distinct--yes except 8 spurious cases.
  join3 %>%
    add_count(court_docket_id, book_num) %>%
    filter(n > 1) %>%
    arrange(desc(n))
  
#Diagnostics
  #Jail and Court Matches by category
tibble(
  stage = 1:3,
  match = c(
    'c("court_docket_id", "cii", "dob")',
    'c("court_docket_id", "first_name", "dob")',
    'c("court_docket_id", "dob")'
  ),
  jail_match_rate = sapply(1:3, function(i) {
    (nrow(book_df) - nrow(get(paste0("j", i)))) / nrow(book_df) * 100
  }),
  court_match_rate = sapply(1:3, function(i) {
    (nrow(court_df) - nrow(get(paste0("c", i)))) / nrow(court_df) * 100
  })
)

join_df <- bind_rows(join1, join2, join3)
```
  
  Join Diagnostics
```{r}
anti_join(assess_df, book_df)

assess_df %>%
  mutate_if(is.character, list(~na_if(., "(Missing)"))) %>%
  filter(is.na(book_num))

tibble(Type = c("Jail", "Court"), c(nrow()))  
  

#Joining on Name--Don't use
join4 <- inner_join(j3, c3, by = c("first_name", "last_name", "dob"), na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(paste0("arrest_", gsub("\\.x$", "", .)))) %>%
  rename_at(vars(contains(".y")), funs(paste0("court_", gsub("\\.y$", "", .)))) %>%
  #1 Duplicate with missing dispositions which will be dropped later. 
  distinct()

j4 <- anti_join(j3, c3, by = c("first_name", "last_name", "dob"), na_matches = "never")
c4 <- anti_join(c3, j3, by = c("first_name", "last_name", "dob"), na_matches = "never")

  #Examine if set of common variables is distinct--yes except 8 spurious cases.
  join4 %>%
    add_count(book_num) %>%
    filter(n > 1) %>%
    arrange(desc(n))
  

#Diagnostics
join1 %>%
  distinct(.keep_all = T) %>%
  add_count(court_docket_id, cii, book_num, .keep_all = T) %>%
  filter(n > 1)
  distinct(court_docket_id, book_num, .keep_all = T)

nest %>%
  select(court_df) %>%
  filter(!is.null(court_df)) %>%
  select(num)

df <- tibble(a = c())

df %>%
  na_if("NULL")

nrow(NULL)

court_df %>%
  filter(!is.na(cii), !is.na(court_docket_id)) %>%
  filter(!is.na(court_charge)) %>%
  add_count(court_docket_id, cii) %>%
  filter(n > 1) %>%
  arrange(court_docket_id)

court_df %>%
  filter(is.na(court_charge))
emi_join(court_df, book_df, by = c("court_docket_id", "cii"))

court_df %>%
  filter(cii != "NULL")

court_df %>%
  arrange(court_case_id)

book_df %>%
  arrange(court_case_id)

book_df %>%
  filter(cii != "NULL")

book_df %>%
  sample_n(size = 100)

court_charge %>%
  distinct(court_case_id)

court_person %>%
  distinct(court_case_id, court_docket_id, .keep_all = T) %>%
  add_count(court_docket_id) %>%
  filter(n > 1) %>%
  arrange(desc(n))
c4 <- anti_join(c3, j3, by = c("court_id"), na_matches = "never")  

fresno_court_nm <- c4
save(fresno_court_nm, file = "Unmatched Fresno Court Data.RData")

# join <- bind_rows(join1, join2, join3, join4)
join <- bind_rows(join1, join2, join3, join4, .id = "join_group")

rm(list = ls()[!ls() %in% c("assess_df", "charge_hier", "release_df")])
# save(j9, file = "Jail Data Unmatched")
# save(c9, file = "Court Data Unmatched")
```

Code Book
  Creation
```{r eval=FALSE, include=FALSE}
rm(original_field)

original_df <- bind_rows(original_df)

Los_Angeles_df <- lapply(ls()[!grepl("original", ls())], function(i){
  df <- get(i)
  
  if(sum(grepl("date", names(df))) > 0){
  df2 <- df %>%
  select(contains("date"), -contains("time"), -contains("reminder")) %>%
  gather("modified_field", "value") %>%
  group_by(modified_field) %>%
  summarise_all(funs(min = as.character(min(., na.rm = T)), mean = as.character(mean(., na.rm = T)), 
                     max = as.character(max(., na.rm = T))))
  }else{
    df2 <- tibble(modified_field = NA_character_, min = NA_character_, mean = NA_character_, max = NA_character_)
  }
  
  df <- df %>%
    mutate_if(~length(unique(.)) > 50|is.Date(.)|is.POSIXct(.), ~(. = "not_factor")) %>%    
    mutate_all(~if_else(is.na(.), "na_missing", as.character(.))) %>%
    gather(modified_field, factor_value) %>%
    count(modified_field, factor_value) %>%
    mutate(table_name = i, county = "Los Angeles") %>%
    mutate(factor_flag = if_else(factor_value == "not_factor", 0, 1)) %>%
    group_by(table_name, modified_field) %>%
    mutate(table_count = sum(n)) %>%
    ungroup() %>%
    rename("factor_count" = "n") %>%
    mutate(factor_count = if_else(factor_value == "not_factor", NA_integer_, factor_count),
           factor_percent = round(factor_count/table_count*100, 1)) %>%
    arrange(desc(factor_flag), modified_field, desc(factor_count))
  
  df <- left_join(df, df2, by = "modified_field")
    }) %>% 
  bind_rows() %>%
  left_join(original_df) %>%
   select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_count,
           factor_percent, table_count, min, mean, max) 

write.xlsx(Los_Angeles_df, file = "Code Books/Los Angeles Code Book.xlsx")
```

 Completion
```{r}
files <- list.files("C:/Work/PretrialAssessmentPilot/Code Books/Code Book Notes", pattern = "Alameda", full.names = T)

df <- lapply(files, read_excel)

df[[2]] <- df[[1]] %>%
  mutate(factor_standard = "") %>%
  select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_standard, factor_count, factor_percent, 
         table_count, "st_notes" = `Factor Description`, min, mean, max)

df <- list(df[[2]], df[[1]])

write.xlsx(df, file = "C:/Work/PretrialAssessmentPilot/Code Books/Variable Construction/Alameda Factor Construction.xlsx", asTable = T, tableStyle = "TableStyleMedium1", sheetName = c("Variable Construction", "jw_notes", "nl_notes"))
```
  
    Factors
```{r}
factor_df <- lapply(ls()[!grepl("original|^df|hier", ls())], function(i){
  df <- get(i)
  if(sum(grepl("original", names(df))) == 0){
    return(NULL)
  }else{
    var_names <- names(df)[grepl("original", names(df))]
    var_names2 <- gsub("_original", "", var_names)
   
    df1 <- df %>%
     select(var_names) %>%
     gather(original_field, original_value)
   
    df2 <- df %>%
     select(var_names2) %>%
     gather(modified_field, modified_value)
   
   df <- bind_cols(df1, df2) %>%
     count(original_field, modified_field, original_value, modified_value) %>%
     arrange(modified_field, desc(n)) %>%
     group_by(modified_field) %>%
     mutate(row = row_number(),
            percent = round(n/sum(n)*100)) %>%
     ungroup() %>%
     filter(row <= 50) %>%
     select(-row) %>%
     rename("total" = n)
   }
  }) %>%
  bind_rows()

write.xlsx(factor_df, file = "C:/Work/PretrialAssessmentPilot/Code Books/Factor Code Book/Los Angeles Factor Code Book.xlsx", asTable = T, tableStyle = "TableStyleMedium1", colWidths = "auto")
```
  

DOJ CII/Linking Extraction
```{r}
# Grab Tables with CIIo
df <- sapply(ls()[which(sapply(ls(), function(i){
  sum(names(get(i)) %in% "cii")
}) == 1)], get)

# Pull CII and other identifiers
doj_book <- df[[4]] %>%
  select(cii, cdl_id, first_name, last_name, race_original, sex_original) %>%
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) %>%
  ungroup() %>%
  distinct()

doj_court <- df[[5]] %>%
  select(cii, local_id, first_name, last_name, dob, sex_original, race_original) %>%
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) %o>%
  ungroup() %>%
  distinct()

doj_prob <- bind_rows(df[[2]], df[[1]], df[[3]]) %>%
  select(cii, fbi,local_id, cdl_id, first_name, last_name, dob, race_original, sex_original) %>%
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) %>%
  ungroup() %>%
  distinct()

# Examine missing ciis and duplicates on cii. 
doj_book %>% #Off by about 55,000
  distinct()

doj_book %>% 
  distinct(cii)

doj_book %>% 
  distinct() %>%
  add_count(cii) %>%
  filter(n > 1) %>%
  arrange(desc(n)) %>% 
  View()

doj_court %>% #Off by about 45,000
  distinct()

doj_court %>% 
  distinct(cii)

doj_court %>% 
  distinct() %>%
  add_count(cii) %>%
  filter(n > 1) %>%
  arrange(desc(n)) %>% 
  View()


#CIIs for DOJ
doj_cii <- bind_rows(doj_book %>% select(cii), doj_court %>% select(cii), doj_prob %>% select(cii)) %>% distinct()


#Create an excel workbook with all data table. Make sure to include the cii table first. 
write.xlsx(list(doj_cii, doj_book, doj_court, doj_prob), file = "CIIs for DOJ/Los Angeles CIIs and Demographics for DOJ.xlsx", sheetName = c("ciis", "booking", "court", "assessment"))
```


Join
```{r eval=FALSE, include=FALSE}
#Alameda has an integrated criminal justice system. Information is joined across agencies on the jail_court_ID. It is contained in the book_df, court_df, and book_charge tables. 

#Jail Court ID is duplicated when split between cases
book_df <- book_df %>% distinct(jail_court_id, .keep_all = T)

#Jail Court ID is duplicated when split between cases
court_df <- court_df %>% distinct(jail_court_id, .keep_all = T)

book_no_court <- anti_join(book_df, court_df, by = c("jail_court_id"))
nrow(book_df)
nrow(book_no_court)
nrow(book_no_court)/nrow(book_df)

court_no_book <- anti_join(court_df, book_df, by = c("jail_court_id"))
nrow(court_df)
nrow(court_no_book)
nrow(court_no_book)/nrow(court_df)
```
--Noah
# Santa Barbara

Jail Data
```{r}
# Jail Bookings--Historical and original
book_df <- read_excel("Historical Data Submissions/Santa Barbara/Jail.Data.12.5.xlsx", col_types = "text")

book_df2 <- read_excel("C:/Work/PretrialAssessmentPilot/Historical Data Submissions/Santa Barbara/PretrialJailData1.28.xlsx", col_types = "text") %>%
  select(-10)

names(book_df2) <- names(book_df)

book_df <- bind_rows(book_df, book_df2) %>% distinct()

rm(book_df2)

original_field <- names(book_df)

names(book_df) <- c("cii", "first_name", "last_name", "dob", "arrest_date_time", "book_num", "book_date_time", "book_type_original", "court_docket_id", "arrest_charge_code_original", "arrest_charge_original", "arrest_charge_level_original", "release_date_time", "release_type_original", "sex_original", "race_original")

# original_df[[1]] <- tibble(table_name = "book_df", original_field = original_field, modified_field = names(book_df))

book_df <- book_df %>%
  mutate_at(vars(arrest_date_time, book_date_time, release_date_time), convertToDateTime) %>%
  mutate(dob = convertToDate(dob)) %>%
  mutate(arrest_date = as_date(arrest_date_time),
         book_date = as_date(book_date_time),
         release_date = as_date(release_date_time))

#Charging standardization
book_df <- book_df %>%
  mutate(attempt = if_else(grepl("664", arrest_charge_original), 1, 0)) %>%
  separate_rows(arrest_charge_original, sep = "\\\\|\\-|\\/") %>%
  mutate(arrest_charge_code = if_else(!arrest_charge_code_original %in% c("PC", "VC", "HS", "BP", "WI", "US"), "Other", arrest_charge_code_original),
         arrest_charge_level = arrest_charge_level_original,
         arrest_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}|EX|\\+|\\-","", arrest_charge_original))) %>%
  # mutate(hierarchy = if_else(grepl("12032", join_var) & is.na(hierarchy), 178400, hierarchy))
  unite(join_var, arrest_charge_level, arrest_charge_code, arrest_charge, remove = F)

load("Complete Charge Code Hierarchy.RData")


book_df <- left_join(book_df, charge_hier, by = "join_var") %>%
  mutate(felony_flag = if_else(arrest_charge_level == "F", 1, 0),
         misd_flag = if_else(arrest_charge_level == "M", 1, 0)) %>%
  rename_at(vars(contains("flag")), funs(paste0("arrest_", .))) 


# Standardize Factors
book_df <- book_df %>%
  mutate(sex = case_when(sex_original %in% c("M") ~ "Male",
                         sex_original %in% c("F") ~ "Female",
                         T ~ "Other"),
         
         #Trimming white space on original race first
         race_original = trimws(race_original),
         race = case_when(race_original %in% c("B") ~ "Black",
                          race_original %in% c("H") ~ "Hispanic",
                          race_original %in% c("W") ~ "White",
                          #All Other races/ethnicities collapsed into other
                          T ~ "Other_Unknown"),
         
         book_type_original = trimws(book_type_original),
         book_type = case_when(book_type_original %in% c("ON VIEW", "CITIZEN ARREST") ~ "On_View",
                               book_type_original %in% c("WARRANT ARREST", "ORDER TO PRODUCE") ~ "New_warrant",
                               book_type_original %in% c("RAMEY WARRANT") ~ "Other_Warrant",
                               book_type_original %in% c("ENROUTE") ~ "Hold",
                               book_type_original %in% c("DA CITATION", "CITATION") ~ "Cite_Release",
                               book_type_original %in% c("REMAND TO CUSTODY", "BAIL SURRENDER") ~ "Court_Order",
                               book_type_original %in% c("DETAINER", "FLASH", "REV PAROLE", "REV PROB") ~ "Sup_Vio_Post",
                               book_type_original %in% c("EX PARTE") ~ "Administrative",
                               book_type_original %in% c("SENTENCED COUNTY JAIL", "COMMITMENT", "SENTENCED STATE") ~ "Commitment",
                               T ~ "Other"),
         
         
         release_type_original = trimws(release_type_original),
         release_type = case_when(release_type_original %in% c("TIME SERVED") ~ "Time_Served",
                                  release_type_original %in% c("RELEASE TO OTHER COUNTY", "TO OTHER AGENCY", "RELEASE TO OTHER STATE") ~ "Hold_Release",
                                  release_type_original %in% c("CITE RELEASED") ~ "Cite_Release",
                                  release_type_original %in% c("BAIL BOND", "CASH BAIL") ~ "Bail_Bond",
                                  release_type_original %in% c("ORDERED DISCHARGED", "NO COMPLAINT/849PC", "WARRANT RECALLED") ~ "Dismissed_Dropped",
                                  release_type_original %in% c("RELEASED O.R.") ~ "OR",
                                  release_type_original %in% c("COURT ORDERED/PHF 1370PC") ~ "Court_Order",
                                  release_type_original %in% c("STATE INSTITUTE/PRIS", "RELEASE TO C.D.C.R.") ~ "Prison",
                                  release_type_original %in% c("CAP/TIME SERVED") ~ "Sent_Cap",
                                  book_type_original %in% c("EX PARTE", "825PC ADMIN REL") ~ "Administrative",
                                  T ~ "Other")) %>%
  mutate(arrest_sup_vio_flag = if_else(book_type == "Sup_Vio_Post", 1, arrest_sup_vio_flag))
```

Jail Collapse
```{r}
book_df <- book_df %>%
  mutate(time_first_release = release_date - book_date) %>%
  mutate(hierarchy = if_else(is.na(hierarchy), 1e6, as.numeric(hierarchy))) %>%
  group_by(book_num, book_date) %>%
  mutate(max_booktype = book_type[hierarchy == min(hierarchy)][1],
         max_arrest_charge = arrest_charge[hierarchy == min(hierarchy)][1],
         max_charge_description = master_charge_description[hierarchy == min(hierarchy)][1],
         max_hier = min(hierarchy)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, .))) %>%
  mutate_at(vars(contains("flag")), funs("count" = sum(.))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  group_by(book_num, book_date, court_docket_id) %>%
  filter(hierarchy == min(hierarchy)) %>%
  ungroup() %>%
  distinct(book_num, book_date, court_docket_id, .keep_all = T) 

```

  Jail Diagnostics
```{r eval=FALSE, include=FALSE}
book_df %>%
  count(arrest_charge_level_original) %>%
  arrange(desc(n))

book_df %>%
  # filter(arrest_charge_level_original == "SA") %>%
  count(arrest_charge_code_original) %>%
  arrange(desc(n))

book_df %>%
  count(arrest_charge_original) %>%
  arrange(desc(n))

book_df %>%
  count(arrest_charge_level)

book_df %>%
  count(arrest_charge_code)

#No Ambiguity
book_df %>%
  count(arrest_charge, ) %>%
  group_by(arrest_charge) %>%
  add_count() %>%
  filter(n > 1) %>%
  arrange(desc(n))

#No combined charges
book_charge %>%
  filter(grepl("/", arrest_charge_original))

# 1 - 7,901/267,372 = 97% non-match rate
(1 - nrow(book_df %>% filter(is.na(hierarchy)))/nrow(book_df))*100

book_df %>%
  filter(is.na(hierarchy)) %>%
  count(join_var) %>%
  arrange(desc(n))

charge_hier %>%
  filter(grepl("1170", charge))

# Diagnostics
book_df %>%
  distinct(book_num, book_date) %>%
  arrange(book_num) %>%
  group_by(book_num) %>%
  add_count() %>%
  arrange(desc(n)) %>%
  filter(n > 1)

book_df %>%
  distinct(local_id, book_date)
```

Court Data
```{r}
#Q1 Court information replaces historical court information. 
#Court Status
court_status <- fread("Historical Data Submissions/Santa Barbara/CaseStatus.csv", header = F)

# original_field <- names(court_status)

names(court_status) <- c("court_case_id", "court_docket_id", "status_date", "case_status_original")

# original_df[[2]] <- tibble(table_name = "court_status", original_field = original_field, modified_field = names(court_status))

court_status <- court_status %>%
  mutate(status_date = mdy(status_date),
         case_status = if_else(case_status_original == "Active", "Active", "Inactive")) 


#Court Charges
court_charge <- fread("Historical Data Submissions/Santa Barbara/Charges.csv", header = F)

# original_field <- names(court_charge)

names(court_charge) <- c("court_case_id", "court_docket_id", "court_charge_count", "court_charge_original", "court_charge_level_original", "court_charge_description", "plea_date", "plea_type_original", "disposition_date", "disposition_type_original", "final_date")

# original_df[[3]] <- tibble(table_name = "court_charge", original_field = original_field, modified_field = names(court_charge))

court_charge <- court_charge %>%
  mutate_at(vars(contains("date")), as_date) %>%
  separate_rows(court_charge_original, sep = "\\/") %>%
  mutate(court_charge_level = case_when(grepl("^F", court_charge_level_original) ~ "F",
                                        grepl("^M", court_charge_level_original) ~ "M",
                                        grepl("^I", court_charge_level_original) ~ "I",
                                        T ~ "Other"),
         court_charge_code = str_extract(court_charge_description, "^.."),
         court_charge_code = if_else(!court_charge_code %in% c("PC", "VC", "HS", "BP", "WI", "US"), "Other", court_charge_code),
         court_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}|EX|\\+|\\-","", court_charge_original))) %>%
  unite(join_var, court_charge_level, court_charge_code, court_charge, remove = F) 

load("Complete Charge Code Hierarchy.RData")

court_charge <- left_join(court_charge, charge_hier, by = "join_var") %>%
  mutate(felony_flag = if_else(court_charge_level == "F", 1, 0),
         misd_flag = if_else(court_charge_level == "M", 1, 0)) %>%
  mutate_at(vars(contains("flag")), funs("conviction" = if_else(. == 1 & disposition_type_original %in% c("Sentenced: Plea of Nolo Contendere", 
                                                                                                          "Sentenced: Plea of Guilty",
                                                                                                          "Found Guilty: Jury", "Found Guilty: Court"), 1, 0))) %>%
  rename_at(vars(contains("flag"), -contains("conviction")), funs(paste0("court_", .))) %>%
  rename_at(vars(contains("conviction")), funs(paste0("conviction_", gsub("_conviction", "", .))))


# Factor Standardization
court_charge <- court_charge %>%
  mutate(plea_type = case_when(plea_type_original %in% c("Nolo Contendere") ~ "Nolo_Contendere",
                               plea_type_original %in% c("Not Guilty", "Deny", "Not Guilty & Not Guilty by Reason of Insanity", 
                                                         "Not Guilty by Reason of Insanity") ~ "Not_Guilty",
                               plea_type_original %in% c("Admit", "Guilty") ~ "Guilty",
                               T ~ "Other"),
         disposition_type_original = trimws(disposition_type_original),
         disposition_type = case_when(disposition_type_original %in% c("Sentenced: Plea of Nolo Contendere", "Sentenced: Plea of Guilty", 
                                                                       "Found Guilty: Jury", "Found Guilty: Court") ~ "Guilty",
                                      disposition_type_original %in% c("Dism: PC1385-Furtherance of Justice	", "Dism: Plea Negotiation",
                                                                       "Dism: Motion of the People", "Dismissal/Stricken Per PC 1210.1",
                                                                       "Dismissal Per PC 1203.4 (Probation)", "Dism: Other Dismissal",
                                                                       "Dism: After Deferred Entry of Judgment", 
                                                                       "Discharged")|grepl("Dism", disposition_type_original) ~ "Dismissed",
                                      disposition_type_original %in% c("Found Not Guilty: Jury") ~ "Not_Guilty",
                                      T ~ "Other"))


#Court hearing data
court_hearing <- fread("Historical Data Submissions/Santa Barbara/Hearings.csv", header = F)

# original_field <- names(court_hearing)

names(court_hearing) <- c("court_case_id", "court_docket_id", "hearing_date", "hearing_type_original", "hearing_result")

# original_df[[4]] <- tibble(table_name = "court_hearing", original_field = original_field, modified_field = names(court_hearing))

court_hearing <- court_hearing %>%
  mutate(hearing_date = mdy(hearing_date))

# Factor Standardization
court_hearing <- court_hearing %>%
  mutate(hearing_type = case_when(grepl("Arraignment", hearing_type_original) ~ "Arraignment",
                                  T ~ "Other"))


#The following is for confinement sentencing.
court_sent <- fread("Historical Data Submissions/Santa Barbara/SentConf.csv")

# original_field <- names(court_sent)

names(court_sent) <- c("court_case_id", "court_docket_id", "sentence_date", "sentence_type_original", "sentence_loc",
                              "sentence_term", "term_length")

# original_df[[5]] <- tibble(table_name = "court_sent", original_field = original_field, modified_field = names(court_sent))

court_sent <- court_sent %>%
  mutate(sentence_date = mdy(sentence_date))

# Factor Cleaning
court_sent <- court_sent %>%
  #They don't differentiate between jail and probation. All are confinement.
  filter(sentence_type_original != "NULL") %>%
  mutate(sentence_type = case_when(grepl("Jail", sentence_loc) ~ "Jail",
                                  grepl("Prison", sentence_loc) ~ "Prison",
                                  T ~ "Other"))



#The following is for probation sentencing.
court_sent2 <- fread("Historical Data Submissions/Santa Barbara/SentProb.csv", header = F)

original_field <- names(court_sent2)

names(court_sent2) <- c("court_case_id", "court_docket_id", "sentence_date", "sentence_type_original", "sentence_loc",
                              "term_length", "sentence_term")

# original_df[[6]] <- tibble(table_name = "court_sent2", original_field = original_field, modified_field = names(court_sent2))

court_sent2 <- court_sent2 %>%
  mutate(sentence_date = mdy(sentence_date))


# Factor Cleaning 
court_sent2 <- court_sent2 %>%
  filter(sentence_type_original != "NULL") %>%
  mutate(sentence_type = case_when(grepl("Probation", sentence_type_original) ~ "Probation",
                                  T ~ "Other"))


#Court Person IDs
court_person <- fread("Historical Data Submissions/Santa Barbara/TechElements.csv", header = F)

original_field <- names(court_person)

names(court_person) <- c("court_case_id", "court_docket_id", "last_name", "first_name", "middle_name", "file_date", "dob", "cii", "cdl_id", "fbi", "sex_original", "race_original", "cdl_state", "assessment_date")

# original_df[[7]] <- tibble(table_name = "court_person", original_field = original_field, modified_field = names(court_person))

court_person <- court_person %>%
  mutate_at(vars(contains("date"), dob), mdy)

#Factor Standardization
court_person <- court_person %>%
  mutate(sex = case_when(sex_original %in% c("Male") ~ "Male",
                         sex_original %in% c("Female") ~ "Female",
                         T ~ "Other_Unknown"),
         
         #Trimming white space on original race first
         race_original = trimws(race_original),
         race = case_when(race_original %in% c("Black") ~ "Black",
                          race_original %in% c("Hispanic") ~ "Hispanic",
                          race_original %in% c("White") ~ "White",
                          #All Other races/ethnicities collapsed into other
                          T ~ "Other_Unknown"))

#FTA Warrants
court_fta_war <- fread("Historical Data Submissions/Santa Barbara/Warrants.csv", header = F)

original_field <- names(court_fta_war)

names(court_fta_war) <- c("court_case_id", "court_docket_id", "fta_all_flag", "fta_date", "fta_flag", "fta_warrant_date", "fta_description")

# original_df[[8]] <- tibble(table_name = "court_fta_war", original_field = original_field, modified_field = names(court_fta_war))

court_fta_war <- court_fta_war %>%
  mutate_at(vars(contains("date")), mdy)
```

  Court Collapse
```{r}
court_dispo <- court_charge %>%
  mutate(disposition_type = ordered(disposition_type, levels = c("Other", "Dismissed", "Not_Guilty", "Nolo_Contendere", "Guilty"))) %>%
  mutate(hierarchy = if_else(is.na(hierarchy), 1e6, as.numeric(hierarchy))) %>%
  group_by(court_case_id, court_docket_id) %>%
  mutate(disposition_date = max(disposition_date)) %>%
  mutate(max_court_charge_level = court_charge_level[hierarchy == min(hierarchy)][1],
         max_court_charge_code = court_charge_code[hierarchy == min(hierarchy)][1],
         max_court_charge = court_charge[hierarchy == min(hierarchy)][1],
         max_charge_description = master_charge_description[hierarchy == min(hierarchy)][1],
         max_hier = min(hierarchy),
         disposition_type = max(disposition_type)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, .))) %>%
  mutate_at(vars(contains("flag")), funs("count" = sum(.))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  filter(hierarchy == min(hierarchy)) %>%
  ungroup() %>%
  distinct(court_case_id, court_docket_id, .keep_all = T) %>%
  select(-c(plea_date, plea_type_original, plea_type))

#Court Ftas are not separate from warrants
court_fta_war <- court_fta_war %>%
  arrange(fta_warrant_date) %>%
  group_by(court_case_id, court_docket_id) %>%
  mutate(fta_flag = max(fta_flag),
         fta_flag_count = sum(fta_flag)) %>%
  distinct(court_case_id, court_docket_id, .keep_all = T) %>%
  select(-c(fta_description))

court_hearing <- court_hearing %>%
  filter(hearing_type == "Arraignment") %>%
  arrange(hearing_date) %>%
  rename(arraignment_date = hearing_date) %>%
  distinct(court_case_id, court_docket_id, .keep_all = T) %>%
  select(court_case_id, court_docket_id, arraignment_date)

court_plea <- court_charge %>%
  arrange(plea_date) %>%
  mutate(guilty_flag = if_else(plea_type == "Guilty", 1, 0)) %>%
  group_by(court_case_id, court_docket_id) %>%
  filter(guilty_flag == 1|sum(guilty_flag) == 0) %>%
  ungroup() %>%
  distinct(court_case_id, court_docket_id, .keep_all = T) %>%
  select(court_case_id, court_docket_id, plea_date = disposition_date, plea_type = disposition_type)

court_sent <- bind_rows(court_sent, court_sent2) %>%
  arrange(sentence_date) %>%
  distinct(court_case_id, court_docket_id, .keep_all = T) %>%
  select(court_case_id, court_docket_id, sentence_date, sentence_type_original, sentence_type)

#SOmetimes mulitple assessment for the same court case 
court_person <- court_person %>%
  arrange(assessment_date) %>%
  distinct(court_case_id, court_docket_id, .keep_all = T)


#many missing dispos from court_person
court_df <- reduce(list(court_person, court_dispo, court_fta_war, court_hearing, court_plea, court_sent), left_join, by = c("court_case_id", "court_docket_id")) %>%
  select(-contains(".y")) %>% 
  rename_at(vars(contains(".x")), funs(gsub("\\.x", "", .))) %>%
  mutate(final_disposition_date = if_else(disposition_date <= sentence_date|is.na(sentence_date), disposition_date, sentence_date),
         conviction_flag = if_else(!is.na(sentence_date), 1, 0))

  
# Diagnostics
# court_fta %>%
#   count(fta_all_flag)
# 
# court_fta_war %>%
#   count(fta_flag)
# 
# full_join(court_fta %>% filter(fta_all_flag == 1), court_fta_war %>% filter(fta_flag == 1) %>% rename(fta_date = fta_war_date), by = c("court_case_id", "fta_date")) %>%
#   filter(fta_all_flag != fta_flag) %>%
#   add_count(court_case_id) %>%
#   filter(n > 1) %>%
#   arrange(court_case_id, fta_date)
# 
# court_hearing %>%
#   count(hearing_type_original) %>%
#   arrange(desc(n))
#   
# court_charge %>%
#   filter(stage %in% c("DISPOSITION EVENT")) %>%
#   select(-c(disposition_num, charge_id, charge_history_id, offense_id, disposition_hist_id, disposition_id, disposition_type_code, amend_reason_id, amend_reason))
#   # filter(stage %in% c("Sentence Event")) %>%
#   count(dispos) %>%
#   arrange(desc(n))
#   
# court_dispo %>%
#   distinct(court_case_id, disposition_date, .keep_all = T) %>%
#   add_count(court_case_id) %>%
#   filter(n > 1) %>%
#   arrange(desc(n))
# 
# court_charge %>%
#   filter(stage %in% c("PLEA EVENT")) %>%
#   count(disposition_type_original) %>%
#   arrange(desc(n))
#   distinct(court_case_id, disposition_date, .keep_all = T) %>%
#   add_count(court_case_id) %>%
#   filter(n > 1) %>%
#   arrange(desc(n))
#   # select(-c(disposition_num, charge_id, charge_history_id, offense_id, disposition_hist_id, disposition_id, disposition_type_code, amend_reason_id, amend_reason))
#   # filter(stage %in% c("Sentence Event")) %>%
#   count(dispos) %>%
#   arrange(desc(n))
# 
# court_charge %>%
#   # filter(stage %in% c("CASE FILING")) %>%
#   # filter(stage %in% c("SENTENCE EVENT", "DISPOSITION EVENT")) %>%
#   # distinct(court_case_id) 
#   count(stage)
#   filter(court_case_id == "921214")

# court_charge %>%
#   filter(court_docket_id == "18CR00071")
```

  Court Diagnostics
```{r eval=FALSE, include=FALSE}
court_charge %>%
  count(court_charge_level_original) %>%
  arrange(desc(n))

court_charge %>%
  # filter(court_charge_level_original == "SA") %>%
  count(court_charge_code_original) %>%
  arrange(desc(n))

court_charge %>%
  count(court_charge_original) %>%
  arrange(desc(n))

court_charge %>%
  count(court_charge_level)

court_charge %>%
  count(court_charge_code)

#No Ambiguity
court_charge %>%
  count(court_charge, court_charge_original) %>%
  group_by(court_charge) %>%
  add_count() %>%
  filter(n > 1) %>%
  arrange(desc(n))

#No combined charges
court_charge %>%
  filter(grepl("/", court_charge_original))

# Diagnostic Code for Charge Hierarchy
# 1 - 60,401/1,178,423 = 95% match rate
(1 - nrow(court_charge %>% filter(is.na(hierarchy)))/nrow(court_charge))*100

court_charge %>%
  filter(is.na(hierarchy)) %>%
  count(court_charge_level_original) %>%
  arrange(desc(n))
```

Assessment Data (Court)
```{r}
#Assessment Tracking
assess_tracking <- read_excel("Historical Data Submissions/Santa Barbara/1 CompletedInterviewData.xlsm", skip = 1, sheet = 3)

original_field <- names(assess_tracking)

names(assess_tracking) <- c("id", "name", "dob", "cid", "interview_date", "book_num", "referral_type", "court", "risk_score_original", "release_recommendation_original", "supervision_agency", "custody", "bail_before_court_flag", "release_decision_original", "bailed_after_court", "continue_tracking_flag")

# original_df[[10]] <- tibble(table_name = "assess_tracking", original_field = original_field, modified_field = names(assess_tracking))

assess_tracking <- assess_tracking %>%
  mutate_at(vars(dob, interview_date), convertToDate)

# Factor Standardization

assess_tracking <- assess_tracking %>%
  mutate(risk_score = as.numeric(risk_score_original),
         
         release_recommendation = case_when(release_recommendation_original %in% c("Deny OR - high risk score", "Deny OR - PTS discretion", 
                                                                                   "Deny OR - other reason") ~ "No_Program",
                                            release_recommendation_original %in% c("Elevated supervision", "Standard supervision", 
                                                                                   "Intensive supervision") ~ "Monitor",
                                            release_recommendation_original %in% c("OR release") ~ "OR",
                                            T ~ "Other"),
         
         monitor_level_recommended = case_when(release_recommendation_original %in% c("Deny OR - high risk score", "Deny OR - PTS discretion", 
                                                                                   "Deny OR - other reason") ~ "No_Program",
                                            release_recommendation_original %in% c("Standard supervision") ~ "Low",
                                            release_recommendation_original %in% c("Elevated supervision") ~ "Medium",
                                            release_recommendation_original %in% c("Intensive supervision") ~ "High",
                                            release_recommendation_original %in% c("OR release") ~ "None",
                                            T ~ "Other"),
         
         release_decision = case_when(release_decision_original %in% c("Release denied") ~ "No_Program",
                                            release_decision_original %in% c("Release with PTCO supervision", "Release with PTS supervision") ~ "Monitor",
                                            release_decision_original %in% c("Release to PTS (no supervision)", "849") ~ "OR",
                                            T ~ "Other"))

# Flag Adds
assess_tracking <- assess_tracking %>%
  mutate(assess_flag = 1,
         rec_release_flag = if_else(release_recommendation %in% c("No_Program", "Other"), 0, 1),
         condition_release_flag = if_else(release_decision %in% c("No_Program", "Other"), 0, 1))
  

# #Assessment with Full Interviews--Do not use for now
# assess_interview <- read_excel("Historical Data Submissions/Santa Barbara/1 CompletedInterviewData.xlsm", skip = 1)
# 
# original_field <- names(assess_interview)
# 
# names(assess_interview) <- c("name", "dob", "book_num", "arrest_date", "interview_type", "interviewer", "interview_date", "location", "refferal_type", "court_loc", "case", "cid", "alcohol_flag", "civic_flag", "drug_flag", "financial_flag", "personal_flag", "property_flag", "order_flag", "sex_flag", "traffic_flag", "violation_flag", "violent_flag", "other_flag", "other2_flag", "charge_level", "charge_score", "pending_flag", "pending_score", "residence_type", "residence_score", "employment_type", "employment_score", "crim_history", "crim_history_score", "drug_abuse_history", "drug_abuse_history_score", "fta_history", "fta_score", "vc_history", "vc_score", "risk_score", "release_recommendation_original", "sup_agency", "conern_risk", "concern_public_safety", "concern_poi", "concern_no_bail", "concern_fta_possibilty", "concern_ineligible", "concern_other", "concern2_other", "bail_recommend", "custody", "cond_call_in", "cond_ptco", "cond_avoid_place", "cond_avoid_contact", "cond_maths", "cond_passport", "cond_drugs", "cond_scram", "cond_gps", "cond_weapons", "cond_sands", "cond_other", "aoda_recommend", "reassess_change", "reassess_ref", "reassess_victim", "reassess_info", "reassess_charges", "comments", "pts_assessment", "sex", "race_ai", "race_asian", "race_black", "race_hispanic", "race_me", "race_pi", "race_white", "race_other", "race2_other", "language", "bw", "gang", "supervision", "sbc_partner", "sbc_family", "sbc_children", "sbc_work", "sbc_school", "sbc_none", "ca_partner", "ca_family", "ca_children", "ca_work", "ca_school", "ca_none", "outside_partner", "outside_family", "outside_children", "outside_work", "outside_schoool", "outside_none", "cellphone", "email", "alcohol_use", "narcotics_use", "employed", "in_school", "living_conditions", "information_quality", "references", "omissions", "deception", "no_refs", "other_issues", "other2_issues", "id", "data")
# 
# # original_df[[9]] <- tibble(table_name = "assess_interview", original_field = original_field, modified_field = names(assess_interview))
# 
# assess_interview <- assess_interview %>%
#   mutate(arrest_date = convertToDate(arrest_date))


# #Assessment Outcomes Do Not Use for Now
# assess_outcome <- read_excel("Historical Data Submissions/Santa Barbara/1 CompletedInterviewData.xlsm", skip = 1, sheet = 4)
# 
# original_field <- names(assess_outcome)
# 
# names(assess_outcome) <- c("id", "name", "cid", "interview_date", "referral_type", "release_decision_original", "case_num", "charge_level", "case_status", "cd1", "cd1_appeared", "cd2", "cd2_appeared", "cd3", "cd3_appeared", "cd4", "cd4_appeared", "cd5", "cd5_appeared", "cd6", "cd6_appeared", "cd7", "cd7_appeared", "cd8", "cd8_appeared", "cd9", "cd9_appeared", "pretrial_rearrest", "pretrial_rearrest_date", "remand_flag", "rearrest_remand_case", "phone_num", "contact_notes", "other")
# 
# # original_df[[11]] <- tibble(table_name = "assess_outcome", original_field = original_field, modified_field = names(assess_outcome))
# 
# assess_outcome %>%
#   select(id, name, cid, interview_date, referral_type, release_decision_original, case_num, charge_leve, case_status)
#   # mutate_at(vars(matches("cd[0-9]"), pretrial_rearrest_date), convertToDate) %>%
#   # mutate_at(vars(matches("cd[0-9]"), pretrial_rearrest_date), as.character) %>%
#   # pivot_longer(matches("[0-9]"), names_to = "key") %>%
#   # separate(col = key, into = c("call_occurence", "key2"), sep = "_") %>%
#   # mutate(key2 = if_else(is.na(key2), "call_date", "appeared")) %>%
#   # spread(key2, value) %>%
#   # select_if(~!all(is.na(.)))
#   
# 
# 
# # Factor Standardization
# 
# assess_outcome <- assess_outcome %>%
#   mutate(release_recommendation = case_when(release_recommendation_original %in% c("Deny OR - high risk score", "Deny OR - PTS discretion", 
#                                                                                    "Deny OR - other reason") ~ "No_Program",
#                                             release_recommendation_original %in% c("Elevated supervision	", "Standard supervision", 
#                                                                                    "Intensive supervision") ~ "Monitor",
#                                             release_recommendation_original %in% c("OR release") ~ "OR",
#                                             T ~ "Other"),
#          
#          release_decision = case_when(release_decision_original %in% c("Release denied") ~ "No_Program",
#                                             release_decision_original %in% c("Release with PTCO supervision", "Release with PTS supervision") ~ "Monitor",
#                                             release_decision_original %in% c("Release to PTS (no supervision)") ~ "OR",
#                                             T ~ "Other"))

# #Assessments without Interivew--Do not use for now
# assess_nointerview <- read_excel("Historical Data Submissions/Santa Barbara/1CompletedNoninterviewData.xlsm", skip = 1)
# 
# original_field <- names(assess_nointerview)
# 
# names(assess_nointerview) <- c("name", "dob", "book_num", "arrest_date", "reviewer", "review_date", "review_loc", "referral_type", "court", "cid", "case_num", "stage_none", "stage_preinterview", "stage_interview", "stage_references", "stage_victim", "stage_assess", "alcohol_flag", "civic_flag", "drug_flag", "financial_flag", "personal_flag", "property_flag", "order_flag", "sex_flag", "traffic_flag", "violation_flag", "violent_flag", "other_flag", "other2_flag", "non_unwilling", "non", "non_capital", "non_supervision", "non_other_agency", "non_sick", "non_849", "non_bail", "non_warrants", "non_other", "non_other_more", "release_recommendation_original", "reassess_cricumstance", "reassess_willing", "reassess_info", "reassess_holds", "reassess_charge", "sex", "race_ai", "race_asian", "race_black", "race_hispanic", "race_me", "race_pi", "race_white", "race_other", "race2_other", "language", "id", "filename")
# 
# # original_df[[12]] <- tibble(table_name = "assess_nointerview", original_field = original_field, modified_field = names(assess_nointerview))
```

  Assessment Collapse
```{r}
#No Collapse Needed
assess_df <- assess_tracking %>%
  arrange(interview_date) %>%
  distinct(book_num, .keep_all = T) %>%
  separate(name, c("last_name", "first_name", "middle_name"), sep = ", | ") %>%
  mutate_at(vars(first_name, last_name, middle_name), toupper) 
```

Join
  Jail Court Join
```{r}
# Remove extraneous objects in the environment
rm(list = ls()[!ls() %in% ls(pattern = "df")])

#Check for common variables
names(book_df)[names(book_df) %in% names(court_df)]

names(book_df)[names(book_df) %in% names(assess_df)]

#Turning NULL to NA to ensure non matching and removing generic charge info from data frames
book_df <- book_df %>%
  mutate_if(is.character, list(~na_if(., "NULL"))) %>%
  select(-c(charge, charge_level, charge_code)) %>%
  mutate_at(vars(first_name, last_name), toupper)

assess_df <- assess_df %>%
  mutate_if(is.character, list(~na_if(., "(Missing)"))) %>%
  select(-c(id, court))

court_df <- court_df %>%
  mutate_if(is.character, list(~na_if(., "NULL"))) %>%
  select(-c(charge, charge_level, charge_code)) %>%
  mutate_at(vars(first_name, last_name), toupper) %>%
  mutate(court_case_id = as.character(court_case_id))

#Joining Assessment to Jail Data
join1 <- inner_join(book_df, assess_df, by = "book_num", na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x$", "", .))) %>%
  select(-contains(".y")) %>%
  #1 Duplicate with missing dispositions which will be dropped later. 
  distinct()

j1 <- anti_join(book_df, assess_df, by = "book_num", na_matches = "never")
a1 <- anti_join(assess_df, book_df, by = "book_num", na_matches = "never")


  #Examine if set of common variables is distinct--yes
  semi_join(book_df, assess_df, by = "book_num", na_matches = "never")

#Joining on Name and Court ID
join2 <- inner_join(j1, a1, by = c("first_name", "last_name", "book_date" = "interview_date"), na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x$", "", .))) %>%
  select(-contains(".y")) %>%
  #1 Duplicate with missing dispositions which will be dropped later. 
  distinct()

j2 <- anti_join(j1, a1, by = c("first_name", "last_name", "book_date" = "interview_date"), na_matches = "never")
a2 <- anti_join(a1, j1, by = c("first_name", "last_name", "interview_date" = "book_date"), na_matches = "never")

  #Examine if set of common variables is distinct--yes
  semi_join(j1, a1, by = c("first_name", "last_name", "book_date" = "interview_date"), na_matches = "never")
  
#Diagnostics
  #Jail and Assessment Matches by category
tibble(
  stage = 1:2,
  match = c(
    'c("book_num")',
    'c("first_name", "last_name", "book_date" = "interview_date")'
  ),
  # jail_match_rate = sapply(1:2, function(i) {
  #   (nrow(book_df) - nrow(get(paste0("j", i)))) / nrow(book_df) * 100
  # }),
  assess_match_rate = sapply(1:2, function(i) {
    (nrow(assess_df) - nrow(get(paste0("a", i)))) / nrow(assess_df) * 100
  })
)
#Recreating Booking
book_df <- bind_rows(join1, join2, j2)  

rm(list = ls()[!ls() %in% ls(pattern = "df")])

# Court Matching

#Joining on CII and Court ID
join1 <- inner_join(book_df, court_df, by = c("court_docket_id", "cii", "dob"), na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(paste0("arrest_", gsub("\\.x$", "", .)))) %>%
  rename_at(vars(contains(".y")), funs(paste0("court_", gsub("\\.y$", "", .)))) %>%
  # 8 Duplicates with missing dispositions which will be dropped later. 
  distinct()

j1 <- anti_join(book_df, court_df, by = c("court_docket_id", "cii", "dob"), na_matches = "never")
c1 <- anti_join(court_df, book_df, by = c("court_docket_id", "cii", "dob"), na_matches = "never")

  #Examine if set of common variables is distinct--yes except 8 spurious cases.
  join1 %>%
    add_count(cii, court_docket_id, book_num, dob) %>%
    filter(n > 1) %>%
    arrange(desc(n))

#Joining on Name and Court ID
join2 <- inner_join(j1, c1, by = c("court_docket_id", "first_name", "dob"), na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(paste0("arrest_", gsub("\\.x$", "", .)))) %>%
  rename_at(vars(contains(".y")), funs(paste0("court_", gsub("\\.y$", "", .)))) %>%
  #1 Duplicate with missing dispositions which will be dropped later. 
  distinct()

j2 <- anti_join(j1, c1, by = c("court_docket_id", "first_name", "dob"), na_matches = "never")
c2 <- anti_join(c1, j1, by = c("court_docket_id", "first_name", "dob"), na_matches = "never")

  #Examine if set of common variables is distinct--yes except 8 spurious cases.
  join2 %>%
    add_count(first_name, court_docket_id, book_num) %>%
    filter(n > 1) %>%
    arrange(desc(n))

#Joining on Court ID
join3 <- inner_join(j2, c2, by = c("court_docket_id", "first_name"), na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(paste0("arrest_", gsub("\\.x$", "", .)))) %>%
  rename_at(vars(contains(".y")), funs(paste0("court_", gsub("\\.y$", "", .)))) %>%
  #1 Duplicate with missing dispositions which will be dropped later. 
  distinct()

j3 <- anti_join(j2, c2, by = c("court_docket_id"), na_matches = "never")
c3 <- anti_join(c2, j2, by = c("court_docket_id"), na_matches = "never")

  #Examine if set of common variables is distinct--yes except 8 spurious cases.
  join3 %>%
    add_count(court_docket_id, book_num) %>%
    filter(n > 1) %>%
    arrange(desc(n))
  
#Diagnostics
  #Jail and Court Matches by category
tibble(
  stage = 1:3,
  match = c(
    'c("court_docket_id", "cii", "dob")',
    'c("court_docket_id", "first_name", "dob")',
    'c("court_docket_id", "dob")'
  ),
  jail_match_rate = sapply(1:3, function(i) {
    (nrow(book_df) - nrow(get(paste0("j", i)))) / nrow(book_df) * 100
  }),
  court_match_rate = sapply(1:3, function(i) {
    (nrow(court_df) - nrow(get(paste0("c", i)))) / nrow(court_df) * 100
  })
)

join_df <- bind_rows(join1, join2, join3)
```
  Join Diagnostics
```{r}
anti_join(assess_df, book_df)

assess_df %>%
  mutate_if(is.character, list(~na_if(., "(Missing)"))) %>%
  filter(is.na(book_num))

tibble(Type = c("Jail", "Court"), c(nrow()))  
  

#Joining on Name--Don't use
join4 <- inner_join(j3, c3, by = c("first_name", "last_name", "dob"), na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(paste0("arrest_", gsub("\\.x$", "", .)))) %>%
  rename_at(vars(contains(".y")), funs(paste0("court_", gsub("\\.y$", "", .)))) %>%
  #1 Duplicate with missing dispositions which will be dropped later. 
  distinct()

j4 <- anti_join(j3, c3, by = c("first_name", "last_name", "dob"), na_matches = "never")
c4 <- anti_join(c3, j3, by = c("first_name", "last_name", "dob"), na_matches = "never")

  #Examine if set of common variables is distinct--yes except 8 spurious cases.
  join4 %>%
    add_count(book_num) %>%
    filter(n > 1) %>%
    arrange(desc(n))
  

#Diagnostics
join1 %>%
  distinct(.keep_all = T) %>%
  add_count(court_docket_id, cii, book_num, .keep_all = T) %>%
  filter(n > 1)
  distinct(court_docket_id, book_num, .keep_all = T)

nest %>%
  select(court_df) %>%
  filter(!is.null(court_df)) %>%
  select(num)

df <- tibble(a = c())

df %>%
  na_if("NULL")

nrow(NULL)

court_df %>%
  filter(!is.na(cii), !is.na(court_docket_id)) %>%
  filter(!is.na(court_charge)) %>%
  add_count(court_docket_id, cii) %>%
  filter(n > 1) %>%
  arrange(court_docket_id)

court_df %>%
  filter(is.na(court_charge))
emi_join(court_df, book_df, by = c("court_docket_id", "cii"))

court_df %>%
  filter(cii != "NULL")

court_df %>%
  arrange(court_case_id)

book_df %>%
  arrange(court_case_id)

book_df %>%
  filter(cii != "NULL")

book_df %>%
  sample_n(size = 100)

court_charge %>%
  distinct(court_case_id)

court_person %>%
  distinct(court_case_id, court_docket_id, .keep_all = T) %>%
  add_count(court_docket_id) %>%
  filter(n > 1) %>%
  arrange(desc(n))
c4 <- anti_join(c3, j3, by = c("court_id"), na_matches = "never")  

fresno_court_nm <- c4
save(fresno_court_nm, file = "Unmatched Fresno Court Data.RData")

# join <- bind_rows(join1, join2, join3, join4)
join <- bind_rows(join1, join2, join3, join4, .id = "join_group")

rm(list = ls()[!ls() %in% c("assess_df", "charge_hier", "release_df")])
# save(j9, file = "Jail Data Unmatched")
# save(c9, file = "Court Data Unmatched")
```

Code Book
  Creation
```{r eval=FALSE, include=FALSE}
rm(original_field)

original_df <- bind_rows(original_df)

Santa_Barbara_df <- lapply(ls()[!grepl("original", ls())], function(i){
  df <- get(i)
  
  if(sum(grepl("date", names(df))) > 0){
  df2 <- df %>%
  select(contains("date"), -contains("time")) %>%
  gather("modified_field", "value") %>%
  group_by(modified_field) %>%
  summarise_all(funs(min = as.character(min(., na.rm = T)), mean = as.character(mean(., na.rm = T)), max = as.character(max(., na.rm = T))))
  }else{
    df2 <- tibble(modified_field = NA_character_, min = NA_character_, mean = NA_character_, max = NA_character_)
  }
  
  df <- df %>%
    mutate_if(~length(unique(.)) > 50|is.Date(.)|is.POSIXct(.), ~(. = "not_factor")) %>%    
    mutate_all(~if_else(is.na(.), "na_missing", as.character(.))) %>%
    gather(modified_field, factor_value) %>%
    count(modified_field, factor_value) %>%
    mutate(table_name = i, county = "Santa Barbara") %>%
    mutate(factor_flag = if_else(factor_value == "not_factor", 0, 1)) %>%
    group_by(table_name, modified_field) %>%
    mutate(table_count = sum(n)) %>%
    ungroup() %>%
    rename("factor_count" = "n") %>%
    mutate(factor_count = if_else(factor_value == "not_factor", NA_integer_, factor_count),
           factor_percent = round(factor_count/table_count*100, 1)) %>%
    arrange(desc(factor_flag), modified_field, desc(factor_count))
  
  df <- left_join(df, df2, by = "modified_field")
    }) %>% 
  bind_rows() %>%
  left_join(original_df) %>%
   select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_count,
           factor_percent, table_count, min, mean, max) 

write.xlsx(Santa_Barbara_df, file = "Code Books/Santa Barbara Code Book.xlsx")

?write.xlsx()
```
 
 Completion
```{r}
files <- list.files("C:/Work/PretrialAssessmentPilot/Code Books/Code Book Notes", pattern = "Alameda", full.names = T)

df <- lapply(files, read_excel)

df[[2]] <- df[[1]] %>%
  mutate(factor_standard = "") %>%
  select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_standard, factor_count, factor_percent, 
         table_count, "st_notes" = `Factor Description`, min, mean, max)

df <- list(df[[2]], df[[1]])

write.xlsx(df, file = "C:/Work/PretrialAssessmentPilot/Code Books/Variable Construction/Alameda Factor Construction.xlsx", asTable = T, tableStyle = "TableStyleMedium1", sheetName = c("Variable Construction", "jw_notes", "nl_notes"))
```
  
  
  Factors
```{r}
factor_df <- lapply(ls()[!grepl("original|^df|hier", ls())], function(i){
  df <- get(i)
  if(sum(grepl("original", names(df))) == 0){
    return(NULL)
  }else{
    var_names <- names(df)[grepl("original", names(df))]
    var_names2 <- gsub("_original", "", var_names)
   
    df1 <- df %>%
     select(var_names) %>%
     gather(original_field, original_value)
   
    df2 <- df %>%
     select(var_names2) %>%
     gather(modified_field, modified_value)
   
   df <- bind_cols(df1, df2) %>%
     count(original_field, modified_field, original_value, modified_value) %>%
     arrange(modified_field, desc(n)) %>%
     group_by(modified_field) %>%
     mutate(row = row_number(),
            percent = round(n/sum(n)*100)) %>%
     ungroup() %>%
     filter(row <= 50) %>%
     select(-row) %>%
     rename("total" = n)
   }
  }) %>%
  bind_rows()

write.xlsx(factor_df, file = "C:/Work/PretrialAssessmentPilot/Code Books/Factor Code Book/Santa Barbara Factor Code Book.xlsx", asTable = T, tableStyle = "TableStyleMedium1", colWidths = "auto")
```
  


DOJ CII/Linking Extraction
```{r}
# Grab Tables with CII
df <- sapply(ls()[which(sapply(ls(), function(i){
  sum(names(get(i)) %in% "cii")
}) == 1)], get)

doj_book <- df[[1]] %>%
  select(cii, dob, race_original, sex_original, first_name, last_name) %>%
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) %>%
  distinct()

doj_court <- df[[2]] %>%
  select(cii, cdl_id, fbi, last_name, first_name, middle_name, dob, sex_original, race_original) %>%
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                        nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) %>%
  distinct()


# Examine missing ciis and duplicates on cii. 
doj_book %>% #Off by about 3,000-2633 due to missing cii
  distinct()

doj_book %>% 
  distinct(cii)

doj_book %>% 
  distinct() %>%
  add_count(cii) %>%
  filter(n > 1) %>%
  arrange(desc(n)) %>% 
  View()

doj_court %>% #Off by about 12,000, 13,069/25,642
  distinct()

doj_court %>% 
  distinct(cii)

doj_court %>% #11,510 due to missing cii
  distinct() %>%
  add_count(cii) %>%
  filter(n > 1) %>%o
  arrange(desc(n)) %>% 
  View()

#CIIs for DOJ
doj_cii <- bind_rows(doj_book %>% select(cii), doj_court %>% select(cii)) %>% distinct()


#Create an excel workbook with all data table. Make sure to include the cii table first. 
write.xlsx(list(doj_cii, doj_book, doj_court), file = "CIIs for DOJ/Santa Barbara CIIs and Demographics for DOJ.xlsx", sheetName = c("ciis", "booking", "court"))
```


# Tulare 

Jail Data
```{r}
book_df <- fread("Historical Data Submissions/Tulare/Tulare Jail xml to csv.csv", colClasses = "character")

book_df <- book_df %>%
  mutate(x = gsub(", ,", ",NA,", x),
         x = gsub(", ", " ", x),
         x = gsub("[A-Z](,,,,)[A-Z]", ",,,", x)) %>%
  separate(x, c("cii", "fbi", "ref", "cdl_id", "name", "dob", "ref2", "race_original", "bail_amt", "date",
                "charge_original", "ref3", "ref4", "name2", "dob2", "arrest_date_time", "book_num", "book_date_time", "ref5", 
                "ref6", "charge2", "date4", "release_date_time", "numeric"),
           sep = ",") %>%
  select(-contains("ref"), -contains("2"), -starts_with("date"))

book_df2 <- fread("Historical Data Submissions/Tulare/")

book_df <- book_df %>%
  mutate_at(vars(dob), funs(mdy(if_else(nchar(.) == 7, paste0("0", .), .)))) %>%
  mutate_at(vars(contains("date")), ymd_hms) %>%
  mutate(book_date = as_date(book_date_time),
         arrest_date = as_date(arrest_date_time),
         release_date = as_date(release_date_time)) 

#Fixing Tulare Charges

  

# shell.exec(paste(getwd(),"Historical Data Submissions/Tulare", sep = "/"))

list.files("Historical Data Submissions/Tulare/PreTrialProject_DataElementInventory DRAFT 20200130 0944.xlsx")
```

  Jail Diagnostics
```{r eval=FALSE, include=FALSE}
table(book_charge$arrest_charge_code_original)[order(table(book_charge$arrest_charge_code_original), decreasing = T)]

table(book_charge$arrest_charge_original)[order(table(book_charge$arrest_charge_original), decreasing = T)]

book_charge %>%
  count(arrest_charge_original, arrest_charge) %>%
  group_by(arrest_charge_original) %>%
  add_count() %>%
  filter(n > 1)

str_extract("ADF", "^.")

table(book_charge$arrest_charge_level_original)

book_charge %>%
  count(arrest_charge) %>%
  arrange(desc(n)) 
  filter(grepl("664", arrest_charge))
  
book_charge %>%
  filter(grepl("484A666", arrest_charge))
```

Court Data
```{r}
# original_df <- list()

court_df <- lapply(c("15-16", "16-17", "17-18", "18-19", "18-19End"), function(i){
  fread(paste0("Historical Data Submissions/Tulare/PretrialStatsFY", i, ".csv"), 
        colClasses = "character", header = F)}) %>%
  bind_rows()

original_field <- names(court_df)

names(court_df) <- c("case_id", "filing_date", "disposition_date", "case_type", "name", "dob", "sex_original", "race_original", "fbi", "cii", "cdl_id", "arrest_date", "arrest_agency", "report_id", "court_charge_level_original", "court_charge_original", "charge_filing_date", "court_charge_type_original", "court_charge_code_original", "court_charge_description", "charge_disposition_date", "disposition_type_original", "sentence_date", "sentence_charge", "sentence_type_original", "sentence_amt", "sentence_term_type", "sentence_term", "sentence_status", "hearing_date", "hearing_type_original", "hearing_result", "warrant_date", "warrant_type", "total")

# original_df[[1]] <- tibble(table_name = "court_df", original_field = original_field, modified_field = names(court_df))

#Fixing Court Charges
court_df <- court_df %>%
  mutate(court_attempt_flag = if_else(grepl("664\\/", court_charge_original), 1, 0)) %>%
  mutate_at(vars(contains("date"), dob), mdy) %>%
  mutate(court_charge_level = str_extract(court_charge_level_original, "^."),
         court_charge_level = if_else(is.na(court_charge_level), "Other", court_charge_level),
         court_charge_code = str_extract(court_charge_original, "^.."),
         court_charge_code = if_else(!court_charge_code %in% c("PC", "VC", "HS", "BP", "WI", "US"), "Other", court_charge_code),
         court_charge_code = if_else(court_charge_code == "Other", str_extract(court_charge_code_original, "^.."), court_charge_code),
         court_charge_code = if_else(!court_charge_code %in% c("PC", "VC", "HS", "BP", "WI", "US"), "Other", court_charge_code),
         court_charge = toupper(gsub("^[A-Z]*|664\\/","", court_charge_original))) %>%
  separate_rows(court_charge, sep = "/") %>%
  mutate(court_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}|EX|\\+|","", court_charge_original)),
         #Fixing mislabeled charges, codes, and levels. 
         court_charge = if_else(court_charge == "11364A1", "11364A", court_charge),
         court_charge_code = if_else(court_charge == "10851A", "VC", court_charge_code),
         court_charge_code = if_else(court_charge %in% c("148A1", "484A", "273AB"), "PC", court_charge_code),
         court_charge_code = if_else(grepl("23152", court_charge), "VC", court_charge_code)) %>%
  unite(join_var, court_charge_level, court_charge_code, court_charge, remove = F) 

load("Complete Charge Code Hierarchy.RData")

court_df <- left_join(court_df, charge_hier, by = "join_var") %>%
  mutate(felony_flag = if_else(court_charge_level == "F", 1, 0),
         misd_flag = if_else(court_charge_level == "M", 1, 0)) %>%
  mutate_at(vars(contains("flag")), funs("conviction" = if_else(. == 1 & (disposition_type_original %in% c("Conviction: Nolo Plea", 
                                                                       "Conviction: Guilty Plea", "Found True")|grepl("^Conviction|^Guilty",
                                                                                                        disposition_type_original)), 1, 0))) %>%
  rename_at(vars(contains("flag"), -contains("conviction")), funs(paste0("court_", .))) %>%
  rename_at(vars(contains("conviction")), funs(paste0("conviction_", gsub("_conviction", "", .))))
  

# Standardize Factors
court_df <- court_df %>%
  mutate(sex = case_when(sex_original %in% c("M") ~ "Male",
                         sex_original %in% c("F") ~ "Female",
                         T ~ "Other_Unknown"),
         
         #Trimming white space on original race first
         race = case_when(race_original %in% c("B") ~ "Black",
                          race_original %in% c("H") ~ "Hispanic",
                          race_original %in% c("W") ~ "White",
                          #All Other races/ethnicities collapsed into other
                          T ~ "Other_Unknown"),
         
         disposition_type = case_when(disposition_type_original %in% c("Conviction: Nolo Plea", 
                                                                       "Conviction: Guilty Plea", "Found True")|grepl("^Conviction|^Guilty",
                                                                                                        disposition_type_original) ~ "Guilty",
                                      disposition_type_original %in% c("Dismissal", "Discharged")|grepl("^Dismissal", 
                                                                                                        disposition_type_original) ~ "Dismissed",
                                      disposition_type_original %in% c("Acquittal") ~ "Not_Guilty",
                                      T ~ "Other"),
         
         hearing_type = case_when(grepl("Arraignment", hearing_type_original) ~ "Arraignment",
                                  grepl("Sentencing", hearing_type_original) ~ "Sentencing",
                                  T ~ "Other"),
         
         sentence_type = case_when(grepl("Jail", sentence_type_original) ~ "Jail",
                                   grepl("Probation", sentence_type_original) ~ "Probation",
                                   grepl("Prison|Life", sentence_type_original) ~ "Prison",
                                   T ~ "Other"))

court_df <- court_df %>%
  mutate(fta_all_flag = if_else(grepl("Fail to Appear", hearing_result), 1, 0),
         fta_flag = if_else(grepl("Fail to Appear", hearing_result) & !grepl("Held", hearing_result), 1, 0))
```

 Court Diagnostics
```{r eval=FALSE, include=FALSE}
court_df %>%
  count(court_charge_original) %>%
  arrange(desc(n))

court_df %>%
  count(court_charge_level_original) %>%
  arrange(desc(n))

court_df %>%
  count(court_charge_code) %>%
  arrange(desc(n))

court_df %>%
  count(court_charge_level)

court_df %>%
  count(court_charge) %>%
  arrange(desc(n))

#No Ambiguity
court_df %>%
  mutate(court_charge_original = gsub("^[A-Z]*", "", court_charge_original)) %>%
  count(court_charge, court_charge_original) %>%
  group_by(court_charge) %>%
  add_count() %>%
  filter(n > 1)

court_df %>%
  filter(grepl("/", court_charge_original)) %>%
  count(court_charge_original) %>%
  arrange(desc(n))

court_df %>%
  filter(grepl("/", court_charge_original)) %>%
  count(court_charge) %>%
  arrange(desc(n))
```

Probation (assessment)
```{r}
prob_df <- fread("Historical Data Submissions/Tulare/Extremely Rough DRAFT Pretrial Project data 20191008 1722.csv", colClasses = "character") %>%
  mutate_at(vars(Termination_Date, DOB), mdy) %>%
  mutate_at(vars(PTR_Violation_Date_Time, Release_Date_Time, Assessment_Date_Time), mdy_hms)

prob_df2 <- read_excel("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Tulare/Copy of PreTrialProject_DataElementInventory DRAFT 20200130 0944.xlsx", col_types = "text") %>%
  mutate_at(vars(Termination_Date, DOB), convertToDate) %>%
  mutate_at(vars(PTR_Violation_Date_Time, Release_Date_Time, Assessment_Date_Time), convertToDateTime)

names(prob_df2) <- names(prob_df)

original_field <- names(prob_df)

#May not be turly distinct due to different formats
prob_df <- bind_rows(prob_df, prob_df2) %>% distinct()

rm(prob_df2)

names(prob_df) <- c("event_id", "tool_name", "ra_date_time", "zip_code", "tool_response", "risk_score_original", "release_recommendation_original", "release_authorization_original", "release_decision_original", "release_date_time", "pretrial_conditions_original", "pretrial_violation", "pretrial_violation_date_time", "court_date_reminder", "termination_outcome", "termination_date", "cii", "fbi", "local_id", "cdl_id", "name", "dob", "sex_original", "race_original")


# original_df[[2]] <- tibble(table_name = "prob_df", original_field = original_field, modified_field = names(prob_df))

prob_df <- prob_df %>%
  mutate(ra_date = as_date(ra_date_time),
         release_date = mdy_hms(release_date_time),
         pretrial_violation_date = as_date(pretrial_violation_date_time)) 

# Factor Standardization

prob_df <- prob_df %>%
  mutate(sex = case_when(sex_original %in% c("Male") ~ "Male",
                         sex_original %in% c("Female") ~ "Female",
                         T ~ "Other_Unknown"),
         
         #Trimming white space on original race first
         race = case_when(race_original %in% c("Black") ~ "Black",
                          race_original %in% c("Hispanic") ~ "Hispanic",
                          race_original %in% c("White") ~ "White",
                          #All Other races/ethnicities collapsed into other
                          T ~ "Other_Unknown"),
         
         tool_name = "psa",
         
         risk_score = parse_number(risk_score_original),
         
         release_recommendation = case_when(release_recommendation_original %in% c("PML 1 - Low", "PML 2 - Medium", "PML 3 - High") ~ "Monitor",
                                            release_recommendation_original %in% c("Detain/If released, max reporting") ~ "Detain",
                                            release_recommendation_original %in% c("Release Own Recognizance") ~ "OR",
                                            T ~ "Other"),
         
         release_decision = case_when(release_decision_original %in% c("PML 1 - Low", "PML 2 - Medium", "PML 3 - High") ~ "Monitor",
                                      release_decision_original %in% c("Detain/If released, max reporting", "Detain") ~ "No_Program",
                                      release_decision_original %in% c("Release Own Recognizance") ~ "OR",
                                      T ~ "Other"),
         
         pretrial_level = case_when(release_decision_original %in% c("Release Own Recognizance") ~ "None",
                                    release_decision_original %in% c("PML 1 - Low") ~ "Low",
                                    release_decision_original %in% c("PML 2 - Medium") ~ "Medium",
                                    release_decision_original %in% c("PML 3 - High") ~ "High",
                                    T ~ "Other"),
         
         pretrial_conditions = case_when(is.na(pretrial_conditions_original) ~ "None",
                                         T ~ "Other"))
```

Code Book
```{r eval=FALSE, include=FALSE}
rm(original_field)

original_df <- bind_rows(original_df)

Tulare_df <- lapply(ls()[!grepl("original", ls())], function(i){
  df <- get(i)
  
  if(sum(grepl("date", names(df))) > 0){
  df2 <- df %>%
  select(contains("date"), -contains("time")) %>%
  gather("modified_field", "value") %>%
  group_by(modified_field) %>%
  summarise_all(funs(min = as.character(min(., na.rm = T)), mean = as.character(mean(., na.rm = T)), max = as.character(max(., na.rm = T))))
  }else{
    df2 <- tibble(modified_field = NA_character_, min = NA_character_, mean = NA_character_, max = NA_character_)
  }
  
  df <- df %>%
    mutate_if(~length(unique(.)) > 50|is.Date(.)|is.POSIXct(.), ~(. = "not_factor")) %>%    
    mutate_all(~if_else(is.na(.), "na_missing", as.character(.))) %>%
    gather(modified_field, factor_value) %>%
    count(modified_field, factor_value) %>%
    mutate(table_name = i, county = "Tulare") %>%
    mutate(factor_flag = if_else(factor_value == "not_factor", 0, 1)) %>%
    group_by(table_name, modified_field) %>%
    mutate(table_count = sum(n)) %>%
    ungroup() %>%
    rename("factor_count" = "n") %>%
    mutate(factor_count = if_else(factor_value == "not_factor", NA_integer_, factor_count),
           factor_percent = round(factor_count/table_count*100, 1)) %>%
    arrange(desc(factor_flag), modified_field, desc(factor_count))
  
  df <- left_join(df, df2, by = "modified_field")
    }) %>% 
  bind_rows() %>%
  left_join(original_df) %>%
   select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_count,
           factor_percent, table_count, min, mean, max) 

write.xlsx(Tulare_df, file = "Code Books/Tulare Code Book.xlsx")
```

 Completion
```{r}
files <- list.files("G:/CrimJustice/PretrialAssessmentPilot/Code Books/Code Book Notes", pattern = "Alameda", full.names = T)

df <- lapply(files, read_excel)

df[[2]] <- df[[1]] %>%
  mutate(factor_standard = "") %>%
  select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_standard, factor_count, factor_percent, 
         table_count, "st_notes" = `Factor Description`, min, mean, max)

df <- list(df[[2]], df[[1]])

write.xlsx(df, file = "G:/CrimJustice/PretrialAssessmentPilot/Code Books/Variable Construction/Alameda Factor Construction.xlsx", asTable = T, tableStyle = "TableStyleMedium1", sheetName = c("Variable Construction", "jw_notes", "nl_notes"))
```
  
  Factors
```{r}
factor_df <- lapply(ls()[!grepl("original|^df|hier", ls())], function(i){
  df <- get(i)
  if(sum(grepl("original", names(df))) == 0){
    return(NULL)
  }else{
    var_names <- names(df)[grepl("original", names(df))]
    var_names2 <- gsub("_original", "", var_names)
   
    df1 <- df %>%
     select(var_names) %>%
     gather(original_field, original_value)
   
    df2 <- df %>%
     select(var_names2) %>%
     gather(modified_field, modified_value)
   
   df <- bind_cols(df1, df2) %>%
     count(original_field, modified_field, original_value, modified_value) %>%
     arrange(modified_field, desc(n)) %>%
     group_by(modified_field) %>%
     mutate(row = row_number(),
            percent = round(n/sum(n)*100)) %>%
     ungroup() %>%
     filter(row <= 50) %>%
     select(-row) %>%
     rename("total" = n)
   }
  }) %>%
  bind_rows()

write.xlsx(factor_df, file = "G:/CrimJustice/PretrialAssessmentPilot/Code Books/Factor Code Book/Alameda Factor Code Book.xlsx", asTable = T, tableStyle = "TableStyleMedium1", colWidths = "auto")
```
  
DOJ CII/Linking Extraction
```{r}
# Grab Tables with CIIo
df <- sapply(ls()[which(sapply(ls(), function(i){
  sum(names(get(i)) %in% "cii")
}) == 1)], get)

# Pull CII and other identifiers
doj_book <- book_df %>%
  select(cii, fbi, cdl_id, name, dob, race_original) %>%
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) %>%
  distinct()

doj_court <- court_df %>%
  select(cii, fbi, cdl_id, name, dob, sex_original, race_original) %>%
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) %>%
  distinct()

doj_prob <- prob_df %>%
  select(cii, fbi, name, dob, race_original, sex_original) %>%
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) %>%
  distinct()

# Examine missing ciis and duplicates on cii. 
doj_book %>% #Off by about 55,000
  distinct()

doj_book %>% 
  distinct(cii)

doj_book %>% 
  distinct() %>%
  add_count(cii) %>%
  filter(n > 1) %>%
  arrange(desc(n)) %>% 
  View()

doj_court %>% #Off by about 45,000
  distinct()

doj_court %>% 
  distinct(cii)

doj_court %>% 
  distinct() %>%o
  add_count(cii) %>%
  filter(n > 1) %>%
  arrange(desc(n)) %>% 
  View()


#CIIs for DOJ
doj_cii <- bind_rows(doj_book %>% select(cii), doj_court %>% select(cii), doj_prob %>% select(cii)) %>% distinct()


#Create an excel workbook with all data table. Make sure to include the cii table first. 
write.xlsx(list(doj_cii, doj_book, doj_court, doj_prob), file = "CIIs for DOJ/Tulare CIIs and Demographics for DOJ.xlsx", sheetName = c("ciis", "booking", "court", "assessment"))
```


Join
```{r eval=FALSE, include=FALSE}
#Alameda has an integrated criminal justice system. Information is joined across agencies on the jail_court_ID. It is contained in the book_df, court_df, and book_charge tables. 

#Jail Court ID is duplicated when split between cases
book_df <- book_df %>% distinct(jail_court_id, .keep_all = T)

#Jail Court ID is duplicated when split between cases
court_df <- court_df %>% distinct(jail_court_id, .keep_all = T)

book_no_court <- anti_join(book_df, court_df, by = c("jail_court_id"))
nrow(book_df)
nrow(book_no_court)
nrow(book_no_court)/nrow(book_df)

court_no_book <- anti_join(court_df, book_df, by = c("jail_court_id"))
nrow(court_df)
nrow(court_no_book)
nrow(court_no_book)/nrow(court_df)
```


# Tuolumne

Jail Data
```{r}
#Jail Data
# doc <- read_xml("Historical Data Submissions/Tuolumne/Inmates-202001115.XML")
# 
# jail_list <- as_list(doc) 
# 
# jail_df <- tibble(inmate = jail_list)
# 
# jail_df <- jail_df %>%
#   unnest(inmate) %>%
#   unnest_wider(inmate)
# 
# jail_df <- jail_df %>%
#   unnest_auto(Name) %>%
#   unnest_auto(DOB) %>%
#   unnest_auto(CII) %>%
#   unnest_auto(FBI) %>%
#   unnest_auto(Occupation) %>%
#   unnest_auto(Employer) %>%
#   unnest_auto(Gender) %>%
#   unnest_auto(Race) %>%
#   unnest_auto(Last) %>%
#   unnest_auto(First) %>%
#   unnest_auto(Middle) %>%
#   unnest_auto(Suffix) 
#   
# jail_df <- jail_df %>%
#   unnest_longer(CDL) %>%
#   unnest_longer(CDL) %>%
#   mutate(CDL_id = if_else(is.na(CDL_id), "Number", CDL_id)) %>%
#   pivot_wider(names_from = CDL_id, values_from = CDL) 
#   
# 
# jail_df <- jail_df %>%
#   unnest(Bookings)  %>%
#   unnest_wider(Bookings) 
# 
# jail_df <- jail_df %>%
#   unnest_longer(ArrestDateTime) %>%
#   unnest_longer(BookingType) %>%
#   unnest_longer(BookingNumber) %>%
#   unnest_longer(BookingDateTime) %>%
#   unnest_longer(CourtDocket) %>%
#   unnest_longer(ReleaseDate) %>%
#   unnest_longer(ConvictionDate) 
#   
# jail_df <- jail_df %>%
#   unnest(Charges) %>%
#   unnest_wider(Charges)
# 
# jail_df <- jail_df %>%
#   unnest_longer(ChargeLevel) %>%
#   unnest_longer(ChargeSection) %>%
#   unnest_longer(ChargeStatute) %>%
#   unnest_longer(WN) 
# 
# fwrite(jail_df, file = "C:/Work/PretrialAssessmentPilot/Historical Data Submissions/Tuolumne/Tuolumne Jail xml to csv.csv")

#Jail Data Loaded from fixed XML bullshit
book_df <- fread("C:/Work/PretrialAssessmentPilot/Historical Data Submissions/Tuolumne/Tuolumne Jail xml to csv.csv")

# original_field <- names(book_df)

names(book_df) <- c("last_name", "first_name", "middle_name", "name_suffix","dob", "cii", "fbi", "occupation", "employer", "arrest_date_time", "book_type_original", "book_num", "book_date_time", "court_docket_id", "release_date_time", "arrest_charge_level_original", "arrest_charge_original", "arrest_charge_code_original", "court_case_id", "conviction_date", "sex_original", "race_original", "cdl_state", "cdl_id")

book_df <- book_df %>%
  mutate_at(vars(dob, conviction_date), as_date) %>%
  mutate_at(vars(arrest_date_time, book_date_time, release_date_time), ymd_hm) %>%
  mutate(arrest_date = as_date(arrest_date_time),
         book_date = as_date(book_date_time),
         release_date = as_date(release_date_time))

# Cleaning Up Charges
book_df <- book_df %>%
  mutate(attempt = if_else(grepl("664", arrest_charge_original), 1, 0)) %>%
  separate_rows(arrest_charge_original, sep = "\\\\|\\-|\\/") %>%
  mutate(arrest_charge_code = if_else(!arrest_charge_code_original %in% c("PC", "VC", "HS", "BP", "WI", "US"), "Other", arrest_charge_code_original),
         arrest_charge_level = if_else(!arrest_charge_level_original %in% c("F", "M", "I"), "Other", arrest_charge_level_original),
         arrest_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}|EX|\\+|\\-","", arrest_charge_original)),
         arrest_charge = if_else(arrest_charge %in% c("23152", "23152AB") & arrest_charge_level == "M", "23152A", arrest_charge),
         arrest_charge_code = if_else(arrest_charge %in% c("5305A", "13205", "3455", "2735", "273AA"), "PC", arrest_charge_code),
         arrest_charge = if_else(arrest_charge == "3454", "3454C", arrest_charge)) %>%
  unite(join_var, arrest_charge_level, arrest_charge_code, arrest_charge, remove = F)

load("Complete Charge Code Hierarchy.RData")


book_df <- left_join(book_df, charge_hier, by = "join_var") %>%
  mutate(felony_flag = if_else(arrest_charge_level == "F", 1, 0),
         misd_flag = if_else(arrest_charge_level == "M", 1, 0)) %>%
  rename_at(vars(contains("flag")), funs(paste0("arrest_", .))) 

book_df<- book_df %>%
  mutate(hierarchy = if_else(is.na(hierarchy) & arrest_charge_level_original == "DETAIN", 1e6, hierarchy),
         hierarchy = if_else(is.na(hierarchy) & arrest_charge_level_original == "I", 1e6, hierarchy))

# original_df[[13]] <- tibble(table_name = "book_df", original_field = original_field, modified_field = names(book_df))


book_df <- book_df %>%
  mutate(sex = case_when(sex_original %in% c("M") ~ "Male",
                         sex_original %in% c("F") ~ "Female",
                         T ~ "Other"),
         
         #Trimming white space on original race first
         race_original = trimws(race_original),
         race = case_when(race_original %in% c("B") ~ "Black",
                          race_original %in% c("H") ~ "Hispanic",
                          race_original %in% c("W") ~ "White",
                          #All Other races/ethnicities collapsed into other
                          T ~ "Other_Unknown"),
         
         book_type = case_when(book_type_original %in% c("FRESH", "1170(H) VIOL") ~ "On_View",
                               book_type_original %in% c("WARRANT") ~ "Warrant",
                               book_type_original %in% c("OUT OF COUNTY HOLD", "PROBATION HOLD", "PAROLE HOLD", "OUT OF STATE HOLD", "ENROUTE") ~ "Hold",
                               book_type_original %in% c("BOOK AND RELEASE") ~ "Cite_Release",
                               book_type_original %in% c("REMAND") ~ "Court_Order",
                               book_type_original %in% c("COMMITMENT") ~ "Commitment",
                               T ~ "Other"))
```

  Jail Collapse
```{r}
#Book numbers are completely distinct for date and court case id. Except one instance.
book_df <- book_df %>%
  mutate(time_first_release = release_date - book_date) %>%
  mutate(hierarchy = if_else(is.na(hierarchy), 1e6, as.numeric(hierarchy))) %>%
  group_by(book_num) %>%
  mutate(max_booktype = book_type[hierarchy == min(hierarchy)][1],
         max_arrest_charge = arrest_charge[hierarchy == min(hierarchy)][1],
         max_charge_description = master_charge_description[hierarchy == min(hierarchy)][1],
         max_hier = min(hierarchy)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, .))) %>%
  mutate_at(vars(contains("flag")), funs("count" = sum(.))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  group_by(book_num) %>%
  filter(hierarchy == min(hierarchy)) %>%
  ungroup() %>%
  distinct(book_num, .keep_all = T) 

# # Diagnostics
# book_df %>%
#   distinct(book_num, book_date) %>%
#   arrange(book_num) %>%
#   group_by(book_num) %>%
#   add_count() %>%
#   arrange(desc(n)) %>%
#   filter(n > 1)
# 
# book_df %>%
#   distinct(book_num, court_case_id)
```
  Jail Diagnostics
```{r}
book_df %>%
  count(arrest_charge_original) %>%
  arrange(desc(n))

book_df %>%
  filter(grepl("/", arrest_charge_original))

book_df %>%
  count(arrest_charge_level_original)

# 1 - 7,901/267,372 = 97% non-match rate
(1 - nrow(book_df %>% filter(is.na(hierarchy)))/nrow(book_df))*100

book_df %>%
  filter(is.na(hierarchy)) %>%
  count(join_var) %>%
  arrange(desc(n))

charge_hier %>%
  filter(grepl("3454", join_var))
```

Court Data
```{r}
# original_df <- list()

# setwd("C:/Work/PretrialAssessmentPilot")

#court_df
court_df <- read_excel("Historical Data Submissions/Tuolumne/Tuolumne Pretrial Assessment Information.xls", sheet = 1)

# original_field <- names(court_df)

names(court_df) <- c("court_case_id", "name", "disposition_type_original", "disposition_date", "file_date", "court_charge_level_drop")

# original_df[[1]] <- tibble(table_name = "court_df", original_field = original_field, modified_field = names(court_df))

court_df <- court_df %>%
  mutate_at(vars(disposition_date, file_date), as_date) %>%
  separate(name, c("last_name", "first_name"), sep = ", ") %>%
  separate(first_name, c("first_name", "middle_name"), sep = " ") 

# Factor Standardization
court_df <- court_df %>%
  mutate(disposition_type = case_when(disposition_type_original %in% c("Conviction: Nolo Plea", 
                                                                       "Conviction: Guilty Plea", "Found True")|grepl("^Conviction|^Guilty",
                                                                                                        disposition_type_original) ~ "Guilty",
                                      disposition_type_original %in% c("Dismissal", "Discharged")|grepl("^Dismissal", 
                                                                                                        disposition_type_original) ~ "Dismissed",
                                      disposition_type_original %in% c("Acquittal") ~ "Not_Guilty",
                                      T ~ "Other"))
# court_charges
court_charge <- read_excel("Historical Data Submissions/Tuolumne/Tuolumne Pretrial Assessment Information.xls", sheet = 2)

original_field <- names(court_charge)

names(court_charge) <- c("court_case_id", "count", "court_charge_original", "court_charge_level_original", "court_charge_description", "disposition_type_original", "disposition_date", "plea_type_original", "plea_date")

# original_df[[2]] <- tibble(table_name = "court_charge", original_field = original_field, modified_field = names(court_charge))

court_charge <- court_charge %>%
  mutate_at(vars(disposition_date, plea_date), as_date)

court_charge <- court_charge %>%
  mutate(court_charge_code = str_extract(court_charge_original, "[A-Z]{3}|[A-Z]{2}"),
         court_charge_code = if_else(!court_charge_code %in% c("PC", "VC", "HS", "BP", "WI", "US"), "Other", court_charge_code),
         court_charge_level_original = trimws(court_charge_level_original),
         court_charge_level = case_when(grepl("Felony", court_charge_level_original) ~ "F",
                                        grepl("Misdemeanor", court_charge_level_original) ~ "M",
                                        grepl("Infraction", court_charge_level_original) ~ "I",
                                        T ~ "Other"),
         court_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}|-|M$|I$|Y$","", court_charge_original))) %>% 
      unite(join_var, court_charge_level, court_charge_code, court_charge, remove = F) 

load("Complete Charge Code Hierarchy.RData")

court_charge <- left_join(court_charge, charge_hier, by = "join_var") %>%
  mutate(felony_flag = if_else(court_charge_level == "F", 1, 0),
         misd_flag = if_else(court_charge_level == "M", 1, 0)) %>%
  mutate_at(vars(contains("flag")), funs("conviction" = if_else(. == 1 & (disposition_type_original %in% c("Conviction: Nolo Plea", 
                                                                       "Conviction: Guilty Plea", "Found True")|grepl("^Conviction|^Guilty",
                                                                                                        disposition_type_original)), 1, 0))) %>%
  rename_at(vars(contains("flag"), -contains("conviction")), funs(paste0("court_", .))) %>%
  rename_at(vars(contains("conviction")), funs(paste0("conviction_", gsub("_conviction", "", .))))

# Factor Standardization
court_charge <- court_charge %>%
  mutate(disposition_type = case_when(disposition_type_original %in% c("Conviction: Nolo Plea", 
                                                                       "Conviction: Guilty Plea", "Found True")|grepl("^Conviction|^Guilty",
                                                                                                        disposition_type_original) ~ "Guilty",
                                      disposition_type_original %in% c("Dismissal", "Discharged")|grepl("^Dismissal", 
                                                                                                        disposition_type_original) ~ "Dismissed",
                                      disposition_type_original %in% c("Acquittal", "Found Not True") ~ "Not_Guilty",
                                      T ~ "Other"),
         plea_type = "unknown")


#court_sentence
court_sentence <- read_excel("Historical Data Submissions/Tuolumne/Tuolumne Pretrial Assessment Information.xls", sheet = 3)

# original_field <- names(court_sentence)

names(court_sentence) <- c("court_case_id", "sentence_date", "sentence_type_original", "sentence_term", "suspended_length", "facility_type", "status",
                           "count", "charge")


# original_df[[3]] <- tibble(table_name = "court_sentence", original_field = original_field, modified_field = names(court_sentence))

court_sentence <- court_sentence %>%
  mutate_at(vars(sentence_date), as_date)

# Factor Standardization
court_sentence <- court_sentence %>%
  mutate(sentence_type = case_when(grepl("Jail", sentence_type_original) ~ "Jail",
                                   grepl("Probation", sentence_type_original) ~ "Probation",
                                   grepl("Prison|Life", sentence_type_original) ~ "Prison",
                                   T ~ "Other"))

#court_hearings
court_hearing <- read_excel("Historical Data Submissions/Tuolumne/Tuolumne Pretrial Assessment Information.xls", sheet = 4)
court_hearing2 <- read_excel("Historical Data Submissions/Tuolumne/Tuolumne Pretrial Assessment Information.xls", sheet = 5)

court_hearing <- bind_rows(court_hearing, court_hearing2)
rm(court_hearing2)

original_field <- names(court_hearing)

names(court_hearing) <- c("court_case_id", "hearing_type_original", "hearing_date", "hearing_time", "hearing_outcome")

# original_df[[4]] <- tibble(table_name = "court_hearing", original_field = original_field, modified_field = names(court_hearing))

court_hearing <- court_hearing %>%
  mutate(hearing_date_time = as_datetime(paste(hearing_date, gsub("1899-12-31", "", hearing_time))))  %>%
  mutate_at(vars(hearing_date), as_date) %>%
  select(-hearing_time)

# Factor Standardization
court_hearing <- court_hearing %>%
  mutate(hearing_type = case_when(grepl("Arraignment", hearing_type_original) ~ "Arraignment",
                                  grepl("Sentencing", hearing_type_original) ~ "Sentencing",
                                  T ~ "Other"))

#court_lawyer
court_lawyer <- read_excel("Historical Data Submissions/Tuolumne/Tuolumne Pretrial Assessment Information.xls", sheet = 6)

original_field <- names(court_lawyer)

names(court_lawyer) <- c("court_case_id", "lawyer_type", "lawyer_date", "lawyer_status", "lawyer_end_date") 

# original_df[[5]] <- tibble(table_name = "court_lawyer", original_field = original_field, modified_field = names(court_lawyer))

court_lawyer <- court_lawyer %>%
  mutate_at(vars(lawyer_date, lawyer_end_date), as_date) 


#court_demo
court_person <- read_excel("Historical Data Submissions/Tuolumne/Tuolumne Pretrial Assessment Information.xls", sheet = 7)

original_field <- names(court_person)

names(court_person) <- c("court_case_id", "first_name", "last_name", "dob", "sex_original", "race_original") 

# original_df[[6]] <- tibble(table_name = "court_person", original_field = original_field, modified_field = names(court_person))

court_person <- court_person %>%
  mutate_at(vars(dob), as_date) 

# Demographic Factor Standardization
court_person <- court_person %>%
  mutate(sex = case_when(sex_original %in% c("Male") ~ "Male",
                         sex_original %in% c("Female") ~ "Female",
                         T ~ "Other_Unknown"),
         
         #Trimming white space on original race first
         race_original = trimws(race_original),
         race = case_when(race_original %in% c("Black") ~ "Black",
                          race_original %in% c("Hispanic") ~ "Hispanic",
                          race_original %in% c("White") ~ "White",
                          #All Other races/ethnicities collapsed into other
                          T ~ "Other_Unknown"))

#court_id
court_demo2 <- read_excel("Historical Data Submissions/Tuolumne/Tuolumne Pretrial Assessment Information.xls", sheet = 8)

original_field <- names(court_demo2)

names(court_demo2) <- c("court_case_id", "id_type", "id_number") 

# original_df[[7]] <- tibble(table_name = "court_demo2", original_field = original_field, modified_field = names(court_demo2))


#court_booking

court_demo3 <- read_excel("Historical Data Submissions/Tuolumne/Tuolumne Pretrial Assessment Information.xls", sheet = 9)

original_field <- names(court_demo3)

names(court_demo3) <- c("court_case_id", "arrest_num", "booking_num") 

# original_df[[8]] <- tibble(table_name = "court_demo3", original_field = original_field, modified_field = names(court_demo3))

#court_bail_release
court_bail_release <- read_excel("Historical Data Submissions/Tuolumne/Tuolumne Pretrial Assessment Information.xls", sheet = 10)

original_field <- names(court_bail_release)

names(court_bail_release) <- c("court_case_id", "release_type", "bail_date", "bail_status", "bail_status_date") 

# original_df[[9]] <- tibble(table_name = "court_bail_release", original_field = original_field, modified_field = names(court_bail_release))

court_bail_release <- court_bail_release %>%
  mutate_at(vars(bail_date, bail_status_date), as_date)

#court_fta_hearing

court_fta_hearing <- read_excel("Historical Data Submissions/Tuolumne/Tuolumne Pretrial Assessment Information.xls", sheet = 11)

# original_field <- names(court_fta_hearing)

names(court_fta_hearing) <- c("court_case_id", "fta_hearing_date", "fta_hearing_outcome") 

# original_df[[10]] <- tibble(table_name = "court_fta_hearing", original_field = original_field, modified_field = names(court_fta_hearing))

court_fta_hearing <- court_fta_hearing %>%
  mutate_at(vars(fta_hearing_date), as_date) %>%
  mutate(fta_all_flag = 1)

#court_fta_warrant
court_fta_warrant <- read_excel("Historical Data Submissions/Tuolumne/Tuolumne Pretrial Assessment Information.xls", sheet = 12)

original_field <- names(court_fta_warrant)

names(court_fta_warrant) <- c("court_case_id", "fta_warrant_date", "fta_warrant_type")

# original_df[[11]] <- tibble(table_name = "court_fta_warrant", original_field = original_field, modified_field = names(court_fta_warrant))

court_fta_warrant <- court_fta_warrant %>%
  mutate_at(vars(fta_warrant_date), as_date) %>%
  mutate(fta_flag = 1)
```

Court Collapse
```{r}
court_dispo <- court_charge %>%
  group_by(court_case_id) %>%
  # Charges that have not been disposed of are removed
  # filter(stage %in% c("DISPOSITION EVENT")) %>%
  select(-c(plea_date, plea_type_original, plea_type)) %>%
  mutate(hierarchy = if_else(is.na(hierarchy), 1e6, as.numeric(hierarchy))) %>%
  group_by(court_case_id) %>%
  mutate(disposition_date = max(disposition_date)) %>%
  mutate(max_court_charge_level = court_charge_level[hierarchy == min(hierarchy)][1],
         max_court_charge_code = court_charge_code[hierarchy == min(hierarchy)][1],
         max_court_charge = court_charge[hierarchy == min(hierarchy)][1],
         max_charge_description = master_charge_description[hierarchy == min(hierarchy)][1],
         max_hier = min(hierarchy)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, .))) %>%
  mutate_at(vars(contains("flag")), funs("count" = sum(.))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  filter(hierarchy == min(hierarchy)) %>%
  ungroup() %>%
  distinct(court_case_id, .keep_all = T) 

court_demo2 <- court_demo2 %>%
  #Fixing an incorrect label. 
  mutate(id_type = if_else(id_number == "A11676853", "CII", id_type)) %>%
  distinct() %>%
  spread(id_type, id_number) %>%
  rename_all(tolower)

#Do we need bail release?
# court_bail_release

#FTAs fta_warrant is redundant
court_fta_hearing <- court_fta_hearing %>%
  mutate(fta_flag = if_else(fta_hearing_outcome == "Fail to Appear:Bench Wrrnt Issued", 1, 0)) %>%
rename(fta_warrant_date = fta_hearing_date) %>%
  arrange(fta_warrant_date) %>%
  group_by(court_case_id) %>%
  mutate(fta_flag = max(fta_flag),
         fta_flag_count = sum(fta_flag),
         fta_all_flag = max(fta_all_flag),
         fta__all_flag_count = sum(fta_all_flag)) %>%
  distinct(court_case_id, .keep_all = T) %>%
  select(-c(fta_hearing_outcome))

court_hearing <- court_hearing %>%
  filter(hearing_type == "Arraignment") %>%
  arrange(hearing_date) %>%
  rename(arraignment_date = hearing_date) %>%
  distinct(court_case_id, .keep_all = T) %>%
  select(court_case_id, arraignment_date)

court_sentence <- court_sentence %>%
  arrange(sentence_date) %>%
  distinct(court_case_id, .keep_all = T) %>%
  select(court_case_id, sentence_date, sentence_type_original, sentence_type)

# Unused--court_person, court_bail, court_lawyer

court_df <- reduce(list(court_df, court_demo2, court_demo3, court_dispo, court_fta_hearing, court_hearing, court_sentence), left_join, by = "court_case_id") %>%
  select(-contains(".y")) %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x", "", .))) %>%
  mutate(final_disposition_date = if_else(disposition_date <= sentence_date|is.na(sentence_date), disposition_date, sentence_date),
         conviction_flag = if_else(!is.na(sentence_date), 1, 0))

  
# Diagnostics
# court_fta %>%
#   count(fta_all_flag)
# 
# court_fta_war %>%
#   count(fta_flag)
# 
# full_join(court_fta %>% filter(fta_all_flag == 1), court_fta_war %>% filter(fta_flag == 1) %>% rename(fta_date = fta_war_date), by = c("court_case_id", "fta_date")) %>%
#   filter(fta_all_flag != fta_flag) %>%
#   add_count(court_case_id) %>%
#   filter(n > 1) %>%
#   arrange(court_case_id, fta_date)
# 
# court_hearing %>%
#   count(hearing_type_original) %>%
#   arrange(desc(n))
#   
# court_charge %>%
#   filter(stage %in% c("DISPOSITION EVENT")) %>%
#   select(-c(disposition_num, charge_id, charge_history_id, offense_id, disposition_hist_id, disposition_id, disposition_type_code, amend_reason_id, amend_reason))
#   # filter(stage %in% c("Sentence Event")) %>%
#   count(dispos) %>%
#   arrange(desc(n))
#   
# court_dispo %>%
#   distinct(court_case_id, disposition_date, .keep_all = T) %>%
#   add_count(court_case_id) %>%
#   filter(n > 1) %>%
#   arrange(desc(n))
# 
# court_charge %>%
#   filter(stage %in% c("PLEA EVENT")) %>%
#   count(disposition_type_original) %>%
#   arrange(desc(n))
#   distinct(court_case_id, disposition_date, .keep_all = T) %>%
#   add_count(court_case_id) %>%
#   filter(n > 1) %>%
#   arrange(desc(n))
#   # select(-c(disposition_num, charge_id, charge_history_id, offense_id, disposition_hist_id, disposition_id, disposition_type_code, amend_reason_id, amend_reason))
#   # filter(stage %in% c("Sentence Event")) %>%
#   count(dispos) %>%
#   arrange(desc(n))
# 
# court_charge %>%
#   # filter(stage %in% c("CASE FILING")) %>%
#   # filter(stage %in% c("SENTENCE EVENT", "DISPOSITION EVENT")) %>%
#   # distinct(court_case_id) 
#   count(stage)
#   filter(court_case_id == "921214")
```


 Court Diagnostics
```{r}
book_df %>%
  count(arrest_charge_original) %>%
  arrange(desc(n))

# Diagnostic Code for Charge Hierarchy
# 1 - 60,401/1,178,423 = 95% match rate

court_charge %>%
  count(court_charge_level_original)

(1 - nrow(court_charge %>% filter(is.na(hierarchy)))/nrow(court_charge))*100

court_charge %>%
  filter(is.na(hierarchy)) %>%
  count(join_var) %>%
  arrange(desc(n))

charge_hier %>%
  filter(grepl("12500", join_var))
```

Probation Assessment Data
```{r}
assess_df <- lapply(2018:2019, function(i){
  lapply(getSheetNames(paste0("C:/Work/PretrialAssessmentPilot/Historical Data Submissions/Tuolumne/Tuolumne County Probation Pre-Trial Data ", i, ".xlsx")),
         function(j){
    df <- read_excel(paste0("C:/Work/PretrialAssessmentPilot/Historical Data Submissions/Tuolumne/Tuolumne County Probation Pre-Trial Data ", i, ".xlsx"),
                     sheet = j, col_types = "text")
    df$risk_score <- j
    names(df) <- gsub("sucesful|succesful", "successful", tolower(names(df)))
    names(df)[7] <- "emp_unsuccessful"
    names(df) <- gsub("\\:|\\/", "", names(df))
    names(df) <- gsub(" +", "_", names(df))
    names(df) <- gsub("not_successful.*", "not_successful", names(df))
    names(df)[12] <- "next_hearing_date" 
    return(df)
}) %>% bind_rows()
}) %>% bind_rows()

assess_df <- assess_df[1:13]

assess_df <- assess_df %>%
  mutate_at(vars(contains("date")), convertToDate)

original_field <- names(assess_df)

names(assess_df) <- c("name", "book_num", "court_case_id", "referral_date", "rec_em_flag", "condition_em_flag", "emp_unsuccessful", "fta_flag", "successful_sentenced_by_court", "not_successful", "successful_bailed_da_not_filing_dismissed", "next_hearing_date", "risk_level_original")

# original_df[[12]] <- tibble(table_name = "prob_df", original_field = original_field, modified_field = names(prob_df))

# Factor Standardization

assess_df <- assess_df %>%
  mutate(risk_level = case_when(risk_level_original %in% c("High", "Mod-High") ~ "High",
                                risk_level_original %in% c("Mod", "Low-Mod") ~ "Medium",
                                risk_level_original %in% c("Low") ~ "Low",
                                T ~ "Other"))

#Flags
assess_df <- assess_df %>%
  mutate_at(vars(contains("flag")), funs(if_else(. >= 1, 1, 0)))
```

  Assessment Collapse
```{r}
#Fix thru to contain actual numbers.E.g. B0106489, B0108790, B0108793 thru B0108797 = B0106489, B0108790, B0108793 B0108794 B0108795 B0108796  B0108797 
assess_df <- assess_df %>%
  separate_rows(book_num, sep = " ") %>%
  mutate(book_num = gsub(",", "", book_num)) %>%
  filter(book_num != "thru") %>%
  arrange(referral_date) %>%
  distinct(book_num, last_name, .keep_all = T) %>%
  separate(name, c("last_name", "first_name"), sep = ",") %>%
  arrange(referral_date) %>%
  distinct()

#Diagnostics
assess_df %>%
  arrange(referral_date) %>%
  add_count(book_num) %>%
  filter(n > 1)
```
Join
  Jail Court Join
```{r}
# Remove extraneous objects in the environment
rm(list = ls()[!ls() %in% ls(pattern = "df")])

#Check for common variables
names(book_df)[names(book_df) %in% names(court_df)]

names(book_df)[names(book_df) %in% names(assess_df)]

#Turning NULL to NA to ensure non matching and removing generic charge info from data frames
book_df <- book_df %>%
  mutate_if(is.character, list(~na_if(., "NULL"))) %>%
  select(-c(charge, charge_level, charge_code)) %>%
  mutate_at(vars(first_name, last_name), toupper)

assess_df <- assess_df %>%
  mutate_at(vars(first_name, last_name), toupper) %>%
  separate_rows(court_case_id, sep = " |, ")

court_df <- court_df %>%
  mutate_if(is.character, list(~na_if(., "NULL"))) %>%
  select(-c(charge, charge_level, charge_code)) %>%
  mutate_at(vars(first_name, last_name), toupper) %>%
  mutate(court_case_id = as.character(court_case_id))

#Assessment data will be joined after court data because of presence of Court Case IDs

# Court Matching

#Joining on CII and Court ID
join1 <- inner_join(book_df, court_df, by = c("court_docket_id" = "court_case_id"), na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(paste0("arrest_", gsub("\\.x$", "", .)))) %>%
  rename_at(vars(contains(".y")), funs(paste0("court_", gsub("\\.y$", "", .)))) %>%
  # 8 Duplicates with missing dispositions which will be dropped later. 
  distinct()

j1 <- anti_join(book_df, court_df, by = c("court_docket_id" = "court_case_id"), na_matches = "never")
c1 <- anti_join(court_df, book_df, by = c("court_case_id" = "court_docket_id"), na_matches = "never")

  #No Possible duplicates--distinct court cases in court data,
  # join1 %>%
  #   add_count(cii, court_docket_id, book_num, dob) %>%
  #   filter(n > 1) %>%
  #   arrange(desc(n))

#Joining on Name and Court ID
join2 <- inner_join(j1, court_df, c("court_case_id"), na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(paste0("arrest_", gsub("\\.x$", "", .)))) %>%
  rename_at(vars(contains(".y")), funs(paste0("court_", gsub("\\.y$", "", .)))) %>%
  #1 Duplicate with missing dispositions which will be dropped later. 
  distinct()

j2 <- anti_join(j1, c1, by = c("court_case_id"), na_matches = "never")
c2 <- anti_join(c1, j1, by = c("court_case_id"), na_matches = "never")

  #No Possible duplicates--distinct court cases in court data.
  # join1 %>%
  #   add_count(cii, court_docket_id, book_num, dob) %>%
  #   filter(n > 1) %>%
  #   arrange(desc(n))

court_df %>%
  filter(court_case_id == "CRM52436")
  
#Diagnostics
  #Jail and Court Matches by category
tibble(
  stage = 1:2,
  match = c(
    'c("court_docket_id" = "court_case_id")',
    'c("court_case_id")'
  ),
  jail_match_rate = sapply(1:2, function(i) {
    (nrow(book_df) - nrow(get(paste0("j", i)))) / nrow(book_df) * 100
  }),
  court_match_rate = sapply(1:2, function(i) {
    (nrow(court_df) - nrow(get(paste0("c", i)))) / nrow(court_df) * 100
  })
)

join_df <- bind_rows(join1, join2, j2)

#Joining Assessment to Joined Data
join1 <- inner_join(join_df, assess_df, by = c("book_num"), na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x$", "", .))) %>%
  select(-contains(".y")) %>%
  #1 Duplicate with missing dispositions which will be dropped later. 
  distinct()

j1 <- anti_join(join_df, assess_df, by = "book_num", na_matches = "never")
a1 <- anti_join(assess_df, join_df, by = "book_num", na_matches = "never")


  #Examine if set of common variables is distinct--yes
  semi_join(join_df, assess_df, by = c("book_num"), na_matches = "never")

#Joining on Name and Court ID
join2 <- inner_join(j1, a1, by = c("court_docket_id" = "court_case_id"), na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x$", "", .))) %>%
  select(-contains(".y")) %>%
  #1 Duplicate with missing dispositions which will be dropped later. 
  distinct()

sort(names(join1))

j2 <- anti_join(j1, a1, by = c("court_docket_id" = "court_case_id"), na_matches = "never")
a2 <- anti_join(a1, j1, by = c("court_case_id" = "court_docket_id"), na_matches = "never")

  #Examine if set of common variables is distinct--yes
  semi_join(j1, a1, by = c("court_docket_id" = "court_case_id"), na_matches = "never")
  
#Joining on Name and Court ID
join3 <- inner_join(j1, a1, by = c("first_name", "last_name", "book_date" = "interview_date"), na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x$", "", .))) %>%
  select(-contains(".y")) %>%
  #1 Duplicate with missing dispositions which will be dropped later. 
  distinct()

j3 <- anti_join(j2, a2, by = c("first_name", "last_name", "book_date" = "interview_date"), na_matches = "never")
a3 <- anti_join(a2, j2, by = c("first_name", "last_name", "interview_date" = "book_date"), na_matches = "never")

  #Examine if set of common variables is distinct--yes
  semi_join(j2, a2, by = c("first_name", "last_name", "book_date" = "interview_date"), na_matches = "never")
  
#Diagnostics
  #Jail and Assessment Matches by category
tibble(
  stage = 1:2,
  match = c(
    'c("book_num")',
    'c("first_name", "last_name", "book_date" = "interview_date")'
  ),
  # jail_match_rate = sapply(1:2, function(i) {
  #   (nrow(book_df) - nrow(get(paste0("j", i)))) / nrow(book_df) * 100
  # }),
  assess_match_rate = sapply(1:2, function(i) {
    (nrow(assess_df) - nrow(get(paste0("a", i)))) / nrow(assess_df) * 100
  })
)
#Recreating Booking
book_df <- bind_rows(join1, join2, j2)  

rm(list = ls()[!ls() %in% ls(pattern = "df")])


```
  Join Diagnostics
```{r}
anti_join(assess_df, book_df)

assess_df %>%
  mutate_if(is.character, list(~na_if(., "(Missing)"))) %>%
  filter(is.na(book_num))

tibble(Type = c("Jail", "Court"), c(nrow()))  
  

#Joining on Name--Don't use
join4 <- inner_join(j3, c3, by = c("first_name", "last_name", "dob"), na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(paste0("arrest_", gsub("\\.x$", "", .)))) %>%
  rename_at(vars(contains(".y")), funs(paste0("court_", gsub("\\.y$", "", .)))) %>%
  #1 Duplicate with missing dispositions which will be dropped later. 
  distinct()

j4 <- anti_join(j3, c3, by = c("first_name", "last_name", "dob"), na_matches = "never")
c4 <- anti_join(c3, j3, by = c("first_name", "last_name", "dob"), na_matches = "never")

  #Examine if set of common variables is distinct--yes except 8 spurious cases.
  join4 %>%
    add_count(book_num) %>%
    filter(n > 1) %>%
    arrange(desc(n))
  

#Diagnostics
join1 %>%
  distinct(.keep_all = T) %>%
  add_count(court_docket_id, cii, book_num, .keep_all = T) %>%
  filter(n > 1)
  distinct(court_docket_id, book_num, .keep_all = T)

nest %>%
  select(court_df) %>%
  filter(!is.null(court_df)) %>%
  select(num)

df <- tibble(a = c())

df %>%
  na_if("NULL")

nrow(NULL)

court_df %>%
  filter(!is.na(cii), !is.na(court_docket_id)) %>%
  filter(!is.na(court_charge)) %>%
  add_count(court_docket_id, cii) %>%
  filter(n > 1) %>%
  arrange(court_docket_id)

court_df %>%
  filter(is.na(court_charge))
emi_join(court_df, book_df, by = c("court_docket_id", "cii"))

court_df %>%
  filter(cii != "NULL")

court_df %>%
  arrange(court_case_id)

book_df %>%
  arrange(court_case_id)

book_df %>%
  filter(cii != "NULL")

book_df %>%
  sample_n(size = 100)

court_charge %>%
  distinct(court_case_id)

court_person %>%
  distinct(court_case_id, court_docket_id, .keep_all = T) %>%
  add_count(court_docket_id) %>%
  filter(n > 1) %>%
  arrange(desc(n))
c4 <- anti_join(c3, j3, by = c("court_id"), na_matches = "never")  

fresno_court_nm <- c4
save(fresno_court_nm, file = "Unmatched Fresno Court Data.RData")

# join <- bind_rows(join1, join2, join3, join4)
join <- bind_rows(join1, join2, join3, join4, .id = "join_group")

rm(list = ls()[!ls() %in% c("assess_df", "charge_hier", "release_df")])
# save(j9, file = "Jail Data Unmatched")
# save(c9, file = "Court Data Unmatched")
```

Code Book
```{r eval=FALSE, include=FALSE}
rm(original_field)

original_df <- bind_rows(original_df)

Tuolumne_df <- lapply(ls()[!grepl("original", ls())], function(i){
  df <- get(i)
  
  if(sum(grepl("date", names(df))) > 0){
  df2 <- df %>%
  select(contains("date"), -contains("time")) %>%
  gather("modified_field", "value") %>%
  group_by(modified_field) %>%
  summarise_all(funs(min = as.character(min(., na.rm = T)), mean = as.character(mean(., na.rm = T)), max = as.character(max(., na.rm = T))))
  }else{
    df2 <- tibble(modified_field = NA_character_, min = NA_character_, mean = NA_character_, max = NA_character_)
  }
  
  df <- df %>%
    mutate_if(~length(unique(.)) > 50|is.Date(.)|is.POSIXct(.), ~(. = "not_factor")) %>%    
    mutate_all(~if_else(is.na(.), "na_missing", as.character(.))) %>%
    gather(modified_field, factor_value) %>%
    count(modified_field, factor_value) %>%
    mutate(table_name = i, county = "Tuolumne") %>%
    mutate(factor_flag = if_else(factor_value == "not_factor", 0, 1)) %>%
    group_by(table_name, modified_field) %>%
    mutate(table_count = sum(n)) %>%
    ungroup() %>%
    rename("factor_count" = "n") %>%
    mutate(factor_count = if_else(factor_value == "not_factor", NA_integer_, factor_count),
           factor_percent = round(factor_count/table_count*100, 1)) %>%
    arrange(desc(factor_flag), modified_field, desc(factor_count))
  
  df <- left_join(df, df2, by = "modified_field")
    }) %>% 
  bind_rows() %>%
  left_join(original_df) %>%
   select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_count,
           factor_percent, table_count, min, mean, max) 

write.xlsx(Tuolumne_df, file = "Code Books/Tuolumne Code Book3.xlsx")
```

 Completion
```{r}
files <- list.files("C:/Work/PretrialAssessmentPilot/Code Books/Code Book Notes", pattern = "Alameda", full.names = T)

df <- lapply(files, read_excel)

df[[2]] <- df[[1]] %>%
  mutate(factor_standard = "") %>%
  select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_standard, factor_count, factor_percent, 
         table_count, "st_notes" = `Factor Description`, min, mean, max)

df <- list(df[[2]], df[[1]])

write.xlsx(df, file = "C:/Work/PretrialAssessmentPilot/Code Books/Variable Construction/Alameda Factor Construction.xlsx", asTable = T, tableStyle = "TableStyleMedium1", sheetName = c("Variable Construction", "jw_notes", "nl_notes"))
```
  
  Factors
```{r}
factor_df <- lapply(ls()[!grepl("original|^df|hier", ls())], function(i){
  df <- get(i)
  if(sum(grepl("original", names(df))) == 0){
    return(NULL)
  }else{
    var_names <- names(df)[grepl("original", names(df))]
    var_names2 <- gsub("_original", "", var_names)
   
    df1 <- df %>%
     select(var_names) %>%
     gather(original_field, original_value)
   
    df2 <- df %>%
     select(var_names2) %>%
     gather(modified_field, modified_value)
   
   df <- bind_cols(df1, df2) %>%
     count(original_field, modified_field, original_value, modified_value) %>%
     arrange(modified_field, desc(n)) %>%
     group_by(modified_field) %>%
     mutate(row = row_number(),
            percent = round(n/sum(n)*100)) %>%
     ungroup() %>%
     filter(row <= 50) %>%
     select(-row) %>%
     rename("total" = n)
   }
  }) %>%
  bind_rows()

write.xlsx(factor_df, file = "C:/Work/PretrialAssessmentPilot/Code Books/Factor Code Book/Tuolumne Factor Code Book.xlsx", asTable = T, tableStyle = "TableStyleMedium1", colWidths = "auto")
```
  

DOJ CII/Linking Extraction
```{r}

# Hi Sal! Sonya and Rob here messing with your code while you are out sick. We had to re-import your booking data for Tuolumne so we could create the CIIs list for Noah to submit to DOJ. You can probably get rid of some of the inital part of this chunk if/when you have to re-run it. Much of it represents a workaround to compensate for the fact we're both missing the package to read xml files you and Noah used above and couldn't get it to install properly. Also, we updated some of the names in the book_df dataframe according to what we used for the other counties (see below).

# Grab Tables with CII
# df <- sapply(ls()[which(sapply(ls(), function(i){
#   sum(names(get(i)) %in% "cii")
# }) == 1)], get)

# Pull CII and other identifiers

book_df <- read.csv("Historical Data Submissions/Tuolumne/Tuolumne Booking Data.csv", as.is = TRUE)

names(book_df) <- c("dob", "cii", "fbi", "occupation", "employer", "sex_original", "race_original", "name_last", "name_first", "name_middle", "name_suffix", "cdl_state", "cdl_id", "book_num", "arrest_date_time", "book_type_original", "book_date_time", "court_case_id", "release_date_time", "arrest_charge_level_original", "arrest_charge_original", "arrest_charge_code_original", "court_docket_id", "conviction_date", "arrest_date", "book_date", "release_date")

doj_book <- book_df %>%
  select(cii, fbi, dob, name_last, name_first, name_middle, name_suffix, cdl_id, cdl_state, race_original, sex_original) %>%
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) %>%
  distinct()


# doj_court <- df[[2]] %>%
#   select(cii, fbi, dob, race_original, sex_original, name, local_id) %>%
#   mutate(cii = parse_number(cii),
#          cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
#                          nchar(cii) == 7 ~ paste0("000", cii),
#                          nchar(cii) == 8 ~ paste0("00", cii),
#                          nchar(cii) == 9 ~ paste0("0", cii)),
#                          T ~ as.character(cii)),
#          cii = if_else(nchar(cii) != 10, NA_character_, cii)) %>%
#   distinct()
# 
# court_df %>%
#   filter(!is.na(cii))

# Examine missing ciis and duplicates on cii. 
# doj_book %>% #Off by about 55,000
#   distinct()
# 
# doj_book %>% 
#   distinct(cii)
# 
# doj_book %>% 
#   distinct() %>%
#   add_count(cii) %>%
#   filter(n > 1) %>%
#   arrange(desc(n)) %>% 
#   View()
# 
# doj_court %>% #Off by about 45,000
#   distinct()
# 
# doj_court %>% 
#   distinct(cii)
# 
# doj_court %>% 
#   distinct() %>%
#   add_count(cii) %>%
#   filter(n > 1) %>%
#   arrange(desc(n)) %>% 
#   View()
# 
# 
# doj_book %>% # Off by about 7,000
#   distinct()
# 
# doj_book %>% 
#   distinct(cii)

# doj_book %>% 
#   distinct() %>%
#   add_count(cii) %>%
#   filter(n > 1) %>%
#   arrange(desc(n)) %>% 
#   View()
# 
# doj_court %>% #Off by about 9,000
#   distinct()
# 
# doj_court %>% 
#   distinct(cii)
# 
# doj_court %>% 
#   distinct() %>%
#   add_count(cii) %>%
#   filter(n > 1) %>%
#   arrange(desc(n)) %>% 
#   View()

#CIIs for DOJ
doj_cii <- (doj_book %>% select(cii)) %>% distinct()


#Create an excel workbook with all data table. Make sure to include the cii table first. 
write.xlsx(list(doj_cii, doj_book), file = "CIIs for DOJ/Tuolumne CIIs and Demographics for DOJ.xlsx", sheetName = c("ciis", "booking"))


```


