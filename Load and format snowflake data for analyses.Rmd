---
title: "Untitled"
output:
  pdf_document: default
  html_document: default
date: '2023-01-30'
---


# Settup and Library
```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
knitr::opts_knit$set(root.dir = "C:/PretrialPilot/Pretrial-Pilot-County-Analysis")

# library(rlang)
library(tidyverse)
library(data.table)
library(openxlsx)
#library(readxl)
library(lubridate)
library(gsubfn)
library(fuzzyjoin)
library(dplyr)
# library(multidplyr)
library(pROC)
library(broom)
library(kableExtra)
library(stargazer)
library(DBI)
library(dbplyr)
library(odbc)
library(tinytex)
library(gt)
library(askpass)

# shell.exec(getwd())
```

Connection
```{r include=FALSE}

con <- dbConnect(odbc::odbc(), "snowflake_pretrial", uid ="Sal.Lempert@jud.ca.gov", pwd = rstudioapi::askForPassword("Password"))

```

Pull live snowflake data -- join_df
```{sql echo=TRUE, connection=con, output.var='join_df'}
SELECT *
FROM "DWH_PROD"."DATA_SCIENCE"."JOIN_DF_STD"
;
```

Format data - join df 
```{r warning=FALSE, include=FALSE}
#snow_df <- join_df
#join_df <- snow_df
names(join_df) <- tolower(names(join_df))

join_df <- join_df %>%
  mutate(book_date = booking_date,
         race_orig = race,
         race = if_else(race_standard %in% c("White", "Black", "Hispanic"), race_standard, "Other/Unknown"),
         age = individual_age,
         charge_level_orig = charge_level,
         charge_level = charge_level_standard,
         pretrial_period_end_count = pretrial_period_end_count_standard,
         fta_flag = fta_county_or_doj,
         recid_arrested_flag = recid_county_or_doj,
         tool_name = case_when(county == "Kings" ~ "VPRAI-O", 
                               county == "Santa Barbara" & assessment_date < as.Date("2020-4-29") ~ "VPRAI",
                               county == "Santa Barbara" & assessment_date >= as.Date("2020-4-29") ~ "VPRAI-R",
                               tool_name == "VPRAIR" ~ "VPRAI-R",
                               T ~ tool_name),
         oras_risk_score = if_else(tool_name == "ORAS", risk_score_raw, NULL),
         vprai_risk_score = if_else(tool_name == "VPRAI", risk_score_raw, NULL),
         vprair_risk_score = if_else(tool_name == "VPRAI-R", risk_score_raw, NULL),
         vpraio_risk_score = if_else(tool_name == "VPRAI-O", generic_tool_total_score_raw, NULL),
         psa_fta_risk_score = score_failure_to_appear,
         psa_nca_risk_score = score_new_criminal_activity,
         psa_nvca_risk_score = score_new_criminal_violent_activity,
         scored_assessment = if_else(tool_name %in% c("ORAS", "VPRAI", "VPRAI-R") & !is.na(risk_score_raw) |
                                       tool_name == "PSA" & !is.na(score_new_criminal_activity) |
                                       tool_name == "VPRAI-O" & !is.na(generic_tool_total_score_raw), 1, 0),
         pretrial_period_end_date = if_else(is.na(pretrial_period_end_date), as.Date(pretrial_period_end_date_doj), as.Date(pretrial_period_end_date)))%>%
  mutate(recid_filed_flag = recid_filed_flag_doj, 
         recid_convicted_flag = recid_convicted_flag_doj, 
         recid_arrest_violent_psa_flag = recid_arrest_violent_psa_flag_doj,
         any_pretrial_failure_flag = if_else(recid_arrested_flag == 1 | fta_flag == 1, 1, 0)) %>% ## update this when we get county data on these
  mutate(across(contains("_flag"), ~if_else(is.na(.x) | .x == "No" | .x == "Unknown" | .x == "0" | .x == 0, 0, as.numeric(1))))  

full_df <- join_df %>%
  filter(booking_date < as.Date("2022-01-01"))

eval_df <- join_df %>%
  filter(booking_assessed_count == 1,
         scored_assessment == 1,
         release_eligible_count ==1,
         released_pretrial_count == 1,
         pretrial_period_end_count == 1,
         booking_date < as.Date("2022-01-01"),
         tool_name %in% c("ORAS", "PSA", "VPRAI", "VPRAI-R", "VPRAI-O")
         ) %>%
  mutate(release_to_pretrial_end = pretrial_period_end_date - release_date)

#create zero bail dummy for period of April 6 2020 through June 20 2020
eval_df <- eval_df %>%
  mutate(zero_bail_dummy = if_else(arrest_date >= as.Date("2020-04-06") & arrest_date <= as.Date("2020-06-20"), 1, 0)) 

# create sup_or_none dummy for supervision
eval_df <- eval_df %>%
  mutate(monitoring_level_grouped = if_else(grepl("Own Recognizance", monitoring_level_grouped), "Own Recognizance", monitoring_level_grouped)) %>%
  mutate(monitoring_level_grouped = if_else(monitoring_level_grouped %in% c("Lowest Levels", "Medium Levels", "Highest Levels", "Own Recognizance"), monitoring_level_grouped, NA_character_)) %>%
  mutate(bail_or_sup = case_when(release_type %in% c("Bail Bond") ~ "Bail Bond",
                                 !is.na(monitoring_level_grouped) ~ monitoring_level_grouped,
                                 release_type %in% c("Own Recognizance") ~ "Own Recognizance",
                                 release_type %in% c("Cite Release", "CiteR elease") ~ "Cite Release")) 
```


Change Raw Risk Scores to Risk Levels for eval_df -- toggle off to go back to raw scores
```{r}
eval_df <- eval_df %>%
  mutate(vprai_risk_score_raw = vprai_risk_score,
         vprair_risk_score_raw = vprair_risk_score,
         oras_risk_score_raw = oras_risk_score) %>%
  mutate(vprai_risk_score = case_when(vprai_risk_score_raw %in% 0:1 ~ 1,
                                      vprai_risk_score_raw %in% 2 ~ 2,
                                      vprai_risk_score_raw %in% 3 ~ 3,
                                      vprai_risk_score_raw %in% 4 ~ 4,
                                      vprai_risk_score_raw %in% 5:9 ~ 5,
                                      T ~ vprai_risk_score_raw),
         vprair_risk_score = case_when(vprair_risk_score_raw %in% 0:2 ~ 1,
                                       vprair_risk_score_raw %in% 3:4 ~ 2,
                                       vprair_risk_score_raw %in% 5:6 ~ 3,
                                       vprair_risk_score_raw %in% 7:8 ~ 4,
                                       vprair_risk_score_raw %in% 9:10 ~ 5,
                                       vprair_risk_score_raw %in% 11:14 ~ 6,
                                       T ~ vprair_risk_score_raw),
         oras_risk_score = case_when(oras_risk_score_raw %in% 0:2 ~ 1,
                                     oras_risk_score_raw %in% 3:5 ~ 2,
                                     oras_risk_score_raw %in% 6:9 ~ 3,
                                     T ~ oras_risk_score_raw))

# eval_df %>%
#   count(vprai_risk_score, vprai_risk_score_raw)
# 
# eval_df %>%
#   count(vprair_risk_score, vprair_risk_score_raw)
# 
# eval_df %>%
#   count(oras_risk_score, oras_risk_score_raw)
```
```{r}
rm(join_df)
```

# Create PROG_DATE and join to full_df
Add golive dates by county to full_df
```{r}
countylist <- full_df %>% distinct(county) %>% pull(county)

prog_date <- data.frame(county = countylist) %>%
  mutate(golive_date = case_when(county == "Alameda" ~ as.Date("2020-5-12"),
                                 county == "Calaveras" ~ as.Date("2019-10-15"),
                                 county == "Kings" ~ as.Date("2020-3-16"),
                                 county == "Los Angeles" ~ as.Date("2020-3-23"),
                                 county == "Modoc" ~ as.Date("2020-4-1"),
                                 county == "Napa" ~ as.Date("2019-11-1"),
                                 county == "Nevada" ~ as.Date("2020-6-30"),
                                 county == "Sacramento" ~ as.Date("2020-2-15"),
                                 county == "San Joaquin" ~ as.Date("2020-6-30"),
                                 county == "San Mateo" ~ as.Date("2020-1-23"),
                                 county == "Santa Barbara" ~ as.Date("2019-8-1"),
                                 county == "Sierra" ~ as.Date("2020-6-30"),
                                 county == "Sonoma" ~ as.Date("2019-8-1"), 
                                 county == "Tulare" ~ as.Date("2020-3-1"),
                                 county == "Tuolumne" ~ as.Date("2020-6-15"),
                                 county == "Ventura" ~ as.Date("2020-6-30"),
                                 county == "Yuba" ~ as.Date("2019-8-9"))) %>%
  mutate(eb_start_date = case_when(county == "Alameda" ~ as.Date("2020-4-3"),
                                 county == "Calaveras" ~ as.Date("2020-4-13"),
                                 county == "Kings" ~ as.Date("2020-4-13"),
                                 county == "Los Angeles" ~ as.Date("2020-3-26"),
                                 county == "Modoc" ~ as.Date("2020-4-13"),
                                 county == "Napa" ~ as.Date("2020-4-13"),
                                 county == "Nevada" ~ as.Date("2020-4-13"),
                                 county == "Sacramento" ~ as.Date("2020-4-13"),
                                 county == "San Joaquin" ~ as.Date("2020-4-13"),
                                 county == "San Mateo" ~ as.Date("2020-4-13"),
                                 county == "Santa Barbara" ~ as.Date("2020-4-13"),
                                 county == "Sierra" ~ as.Date("2020-4-13"),
                                 county == "Sonoma" ~ as.Date("2020-4-13"), 
                                 county == "Tulare" ~ as.Date("2020-4-13"),
                                 county == "Tuolumne" ~ as.Date("2020-4-13"),
                                 county == "Ventura" ~ as.Date("2020-4-13"),
                                 county == "Yuba" ~ as.Date("2020-4-13"))) %>%
   mutate(eb_end_date = case_when(county == "Alameda" ~ as.Date("2021-12-31"),
                                 county == "Calaveras" ~ as.Date("2020-6-20"),
                                 county == "Kings" ~ as.Date("2020-6-20"),
                                 county == "Los Angeles" ~ as.Date("2021-12-31"),
                                 county == "Modoc" ~ as.Date("2020-6-20"),
                                 county == "Napa" ~ as.Date("2021-12-31"),
                                 county == "Nevada" ~ as.Date("2020-6-20"),
                                 county == "Sacramento" ~ as.Date("2021-12-31"),
                                 county == "San Joaquin" ~ as.Date("2020-6-20"),
                                 county == "San Mateo" ~ as.Date("2021-12-31"),
                                 county == "Santa Barbara" ~ as.Date("2021-12-31"),
                                 county == "Sierra" ~ as.Date("2020-6-20"),
                                 county == "Sonoma" ~ as.Date("2021-12-31"), 
                                 county == "Tulare" ~ as.Date("2021-5-4"),
                                 county == "Tuolumne" ~ as.Date("2020-6-20"),
                                 county == "Ventura" ~ as.Date("2020-6-20"),
                                 county == "Yuba" ~ as.Date("2020-6-20")))


prog_date


full_df <- full_df %>%
  left_join(prog_date, by = "county") %>%
  mutate(golive_flag = if_else(booking_date >= golive_date, 1, 0),
         eb_flag = if_else(booking_date >= eb_start_date & booking_date <= eb_end_date, 1, 0))

```

Add covid flag
```{r}
full_df <- full_df %>%
  mutate(covid_flag = if_else(booking_date >= as.Date("2020-3-1"), 1, 0))

#flag for time period of statewide zero bail
full_df <- full_df %>%
  mutate(emerg_flag = if_else(booking_date >= as.Date("2020-4-6") & booking_date <= as.Date("2020-6-20"), 1, 0))
```

# Run everything above this line to load and format join_df and eval_df


# Exploratory

Look at Tulare trends over time

```{r}
# bookings and releases by month
full_df %>%
  filter(county == "Tulare") %>%
  group_by(year = year(booking_date), month = month(booking_date)) %>%
  summarise(bookings = n(),
            release_eligible = sum(release_eligible_count),
            pretrial_releases = sum(released_pretrial_count)) %>%
  mutate(book_date = as.Date(str_c(year, "-", month, "-1"))) %>%
  ungroup() %>%
  select(book_date, bookings, release_eligible, pretrial_releases) %>%
  pivot_longer(cols = c(bookings, release_eligible, pretrial_releases)) %>%
  ggplot() +
    geom_line(aes(x = book_date, y = value, color = name))

# booking charge level by month
full_df %>%
  filter(county == "Tulare") %>%
  group_by(year = year(booking_date), month = month(booking_date)) %>%
  summarise(bookings = n(),
            misdos = sum(if_else(charge_level == "M", 1, 0)),
            fels = sum(if_else(charge_level == "F", 1, 0)),
            unknown = sum(if_else(charge_level == "Other/Unknown", 1, 0))) %>%
  mutate(book_date = as.Date(str_c(year, "-", month, "-1"))) %>%
  ungroup() %>%
  select(-year) %>%
  select(-month) %>%
  pivot_longer(cols = c(misdos, fels, unknown)) %>%
  ggplot() +
    geom_line(aes(x = book_date, y = value, color = name))

# average days in jail by month
full_df %>%
  filter(county == "Tulare") %>%
  filter(released_pretrial_count == 1) %>%
  group_by(year = year(booking_date), month = month(booking_date)) %>%
  summarise(avg_jail_days = mean(as.numeric(release_date - booking_date), na.rm = T)) %>%
  mutate(book_date = as.Date(str_c(year, "-", month, "-1"))) %>%
  ungroup() %>%
  select(-year) %>%
  select(-month) %>%
  ggplot() +
    geom_line(aes(x = book_date, y = avg_jail_days))

full_df %>%
  filter(county == "Tulare") %>%
  filter(released_pretrial_count == 1) %>%
  filter(booking_date > "2021-01-01") %>%
  mutate(jail_days = as.numeric(release_date - booking_date)) %>%
  count(jail_days, is_released_pretrial)
  
```
Tulare
Pretrial releases: Pretrial releases drop precipitously towards the end of 2020 (around July or August) while release eligible bookings are staying the same or going up. Pretrial releases go sharply down from July/August 2020 to around March 2022 when they reach a very low rate and then stay low until the end of the data (June 2022). Release eligible bookings take a Covid hit briefly around March-June 2020 but then go back up and remain pretty steady.

Booking charge level: All booking charge levels are unknown until around March 2020.

Time in jail: The average days in jail for people released pretrial declines from the start of the data (July 2018) until late 2020 (August/Sept) and then remains at 0 days until the end of the data period



Look at San Joaquin trends over time

```{r}
# bookings and releases by month
full_df %>%
  filter(county == "San Joaquin") %>%
  group_by(year = year(booking_date), month = month(booking_date)) %>%
  summarise(bookings = n(),
            release_eligible = sum(release_eligible_count),
            pretrial_releases = sum(released_pretrial_count)) %>%
  mutate(book_date = as.Date(str_c(year, "-", month, "-1"))) %>%
  ungroup() %>%
  select(book_date, bookings, release_eligible, pretrial_releases) %>%
  pivot_longer(cols = c(bookings, release_eligible, pretrial_releases)) %>%
  ggplot() +
    geom_line(aes(x = book_date, y = value, color = name))

# booking charge level by month
full_df %>%
  filter(county == "San Joaquin") %>%
  group_by(year = year(booking_date), month = month(booking_date)) %>%
  summarise(bookings = n(),
            misdos = sum(if_else(charge_level == "M", 1, 0)),
            fels = sum(if_else(charge_level == "F", 1, 0)),
            unknown = sum(if_else(charge_level == "Other/Unknown", 1, 0))) %>%
  mutate(book_date = as.Date(str_c(year, "-", month, "-1"))) %>%
  ungroup() %>%
  select(-year) %>%
  select(-month) %>%
  pivot_longer(cols = c(misdos, fels, unknown)) %>%
  ggplot() +
    geom_line(aes(x = book_date, y = value, color = name))

# average days in jail by month
full_df %>%
  filter(county == "San Joaquin") %>%
  filter(released_pretrial_count == 1) %>%
  group_by(year = year(booking_date), month = month(booking_date)) %>%
  summarise(mean_jail_days = mean(as.numeric(release_date - booking_date), na.rm = T),
            median_jail_days = median(as.numeric(release_date - booking_date), na.rm = T)) %>%
  mutate(book_date = as.Date(str_c(year, "-", month, "-1"))) %>%
  ungroup() %>%
  select(-year) %>%
  select(-month) %>%
  pivot_longer(cols = c(mean_jail_days, median_jail_days)) %>%
  ggplot() +
    geom_line(aes(x = book_date, y = value, color = name))

# full_df %>%
#   filter(county == "San Joaquin") %>%
#   filter(released_pretrial_count == 1) %>%
#   filter(booking_date > "2021-01-01") %>%
#   mutate(jail_days = as.numeric(release_date - booking_date)) %>%
#   count(jail_days, is_released_pretrial)

```
San Joaquin
Pretrial releases: data start looking normal around January 2018 (bookings exist prior to that but not pretrial releases). Bookings take an initial sharp drop in March 2020 around covid and then recover though not quite to before levels. Pretrial releases decline gradually starting around the pandemic and continuing until the end of the data.

Booking charge level: Most bookings have unknown charge level starting around March 2018. Number of Misdos vs Felonies is relatively even until the pandemic, when felonies remain constant and misdemeanors drop and stay lower. 

Time in jail: The mean jail days declines from 2020 through 2022, median jail days remains mostly constant. 


Look at Alameda trends over time

```{r}
# bookings and releases by month
full_df %>%
  filter(county == "Alameda") %>%
  group_by(year = year(booking_date), month = month(booking_date)) %>%
  summarise(bookings = n(),
            release_eligible = sum(release_eligible_count),
            pretrial_releases = sum(released_pretrial_count)) %>%
  mutate(book_date = as.Date(str_c(year, "-", month, "-1"))) %>%
  ungroup() %>%
  select(book_date, bookings, release_eligible, pretrial_releases) %>%
  pivot_longer(cols = c(bookings, release_eligible, pretrial_releases)) %>%
  ggplot() +
    geom_line(aes(x = book_date, y = value, color = name))

# booking charge level by month
full_df %>%
  filter(county == "Alameda") %>%
  group_by(year = year(booking_date), month = month(booking_date)) %>%
  summarise(bookings = n(),
            misdos = sum(if_else(charge_level == "M", 1, 0)),
            fels = sum(if_else(charge_level == "F", 1, 0)),
            unknown = sum(if_else(charge_level == "Other/Unknown", 1, 0))) %>%
  mutate(book_date = as.Date(str_c(year, "-", month, "-1"))) %>%
  ungroup() %>%
  select(-year) %>%
  select(-month) %>%
  pivot_longer(cols = c(misdos, fels, unknown)) %>%
  ggplot() +
    geom_line(aes(x = book_date, y = value, color = name))

# average days in jail by month
full_df %>%
  filter(county == "Alameda") %>%
  filter(released_pretrial_count == 1) %>%
  filter(booking_date > as.Date("2018-06-30")) %>%
  group_by(year = year(booking_date), month = month(booking_date)) %>%
  summarise(mean_jail_days = mean(as.numeric(release_date - booking_date), na.rm = T),
            median_jail_days = median(as.numeric(release_date - booking_date), na.rm = T)) %>%
  mutate(book_date = as.Date(str_c(year, "-", month, "-1"))) %>%
  ungroup() %>%
  select(-year) %>%
  select(-month) %>%
  pivot_longer(cols = c(mean_jail_days, median_jail_days)) %>%
  ggplot() +
    geom_line(aes(x = book_date, y = value, color = name))

# full_df %>%
#   filter(county == "Alameda") %>%
#   filter(released_pretrial_count == 1) %>%
#   filter(booking_date > "2021-01-01") %>%
#   mutate(jail_days = as.numeric(release_date - booking_date)) %>%
#   count(jail_days, is_released_pretrial)

```



Alameda

Pretrial releases: Release eligible bookings start around March 2018, then shoot up in January 2020, drop in March 2020 and slowly go back up until March 2022 then spike sharply down and back up. Pretrial releases are very low March 2018 until the end of 2019, then go up in January 2020, dip in March 2020, and gradually go back up until mid-2021 then go gradually down until sharp drop mid-2022.

Booking charge level: Entirely unknown until 2020. More misdos than felonies Jan-march 2020, then pandemic drops misdos to below felonies from march 2020 through the end of 2020, then misdos slightly above felonie 20201 until weird booking drop early 2022.

Time in jail: Mean days in jail fluctuates from July 2018 until January 2020, then remains fairly constant and lower.



# Look at county by county trends over time

Bookings and releases by month & county
```{r}
countylist <- eval_df %>% distinct(county) %>% pull(county)

lapply(countylist,
       function(i){
         # bookings and releases by month
        full_df %>%
          filter(county == i) %>%
           filter(booking_date > as.Date("2018-06-30")) %>%
          group_by(year = year(booking_date), month = month(booking_date)) %>%
          summarise(bookings = n(),
                    release_eligible = sum(release_eligible_count),
                    pretrial_releases = sum(released_pretrial_count)) %>%
          mutate(book_date = as.Date(str_c(year, "-", month, "-1"))) %>%
          ungroup() %>%
          select(book_date, bookings, release_eligible, pretrial_releases) %>%
          pivot_longer(cols = c(bookings, release_eligible, pretrial_releases)) %>%
          ggplot() +
            geom_line(aes(x = book_date, y = value, color = name)) +
            ggtitle(i)
        
       })
```

Booking charge level by month & county
```{r}
lapply(countylist,
       function(i){
        # booking charge level by month
        full_df %>%
          filter(county == i) %>%
           filter(booking_date > as.Date("2018-06-30")) %>%
          group_by(year = year(booking_date), month = month(booking_date)) %>%
          summarise(bookings = n(),
                    misdos = sum(if_else(charge_level == "M", 1, 0)),
                    fels = sum(if_else(charge_level == "F", 1, 0)),
                    unknown = sum(if_else(charge_level == "Other/Unknown", 1, 0))) %>%
          mutate(book_date = as.Date(str_c(year, "-", month, "-1"))) %>%
          ungroup() %>%
          select(-year) %>%
          select(-month) %>%
          pivot_longer(cols = c(misdos, fels, unknown)) %>%
          ggplot() +
            geom_line(aes(x = book_date, y = value, color = name))+
            ggtitle(i)
       })
```

Average pretrial jail days by month and county
```{r}
lapply(countylist,
       function(i){
        # average days in jail by month
        full_df %>%
          filter(county == i) %>%
           filter(booking_date > as.Date("2018-06-30")) %>%
          filter(released_pretrial_count == 1) %>%
          filter(booking_date > as.Date("2018-06-30")) %>%
          group_by(year = year(booking_date), month = month(booking_date)) %>%
          summarise(mean_jail_days = mean(as.numeric(release_date - booking_date), na.rm = T),
                    median_jail_days = median(as.numeric(release_date - booking_date), na.rm = T)) %>%
          mutate(book_date = as.Date(str_c(year, "-", month, "-1"))) %>%
          ungroup() %>%
          select(-year) %>%
          select(-month) %>%
          pivot_longer(cols = c(mean_jail_days, median_jail_days)) %>%
          ggplot() +
            geom_line(aes(x = book_date, y = value, color = name))+
            ggtitle(i)
        })


```


# Regressions of program implementation on FTA and NCA
Run regression of program implementation on FTA, controlling for covid flag and emergency bail flag
```{r}
summary(lm(data = full_df %>% filter(released_pretrial_count ==1), fta_flag ~ booking_date + golive_flag + covid_flag + emerg_flag))
```
Booking date negative and significant
Go-live flag is positive (0.0008) and not significant (p = 0.82), covid flag is positive (0.01) and significant (p < .001), emergency flag is positive (0.04) and significant (p < .0001)

```{r}
summary(lm(data = full_df %>% filter(released_pretrial_count ==1), recid_county_or_doj ~ booking_date + golive_flag + covid_flag + emerg_flag))
```
Booking date negative and significant
Golive flag negative (-0.05) and significant (p < .0001)
Covid flag positive and significant
Emergency flag positive and significant

Looking at only people with a pretrial period end, FTA controlling for days released and golive flag, covid flag, emergency flag
```{r}
summary(lm(data = full_df %>% 
             filter(released_pretrial_count ==1, pretrial_period_end_count == 1) %>%
             mutate(days_released = pretrial_period_end_date - release_date), fta_flag ~ days_released + golive_flag + covid_flag + emerg_flag))

```
Days released is significant and positive
Golive flag is significant and negative
Covid flag is significant and negative
Emergency flag is significant and positive


With booking date - Looking at only people with a pretrial period end, FTA controlling for days released and golive flag, covid flag, emergency flag
```{r}
summary(lm(data = full_df %>% 
             filter(released_pretrial_count ==1, pretrial_period_end_count == 1) %>%
             mutate(days_released = pretrial_period_end_date - release_date), fta_flag ~ booking_date + days_released + golive_flag + covid_flag + emerg_flag))

```
Booking date is significant and negative
Days released is significant and positive
Golive flag is not significant and negative
Covid flag is not significant and positive
Emergency flag is significant and positive

Using county-level emergency bail flag - Looking at only people with a pretrial period end, FTA controlling for days released and golive flag, covid flag, emergency flag
```{r}
summary(lm(data = full_df %>% 
             filter(released_pretrial_count ==1, pretrial_period_end_count == 1) %>%
             mutate(days_released = pretrial_period_end_date - release_date), fta_flag ~ booking_date + days_released + golive_flag + covid_flag + eb_flag + emerg_flag))

```
booking date negative significant
days released positive significant
golive positive significant
covid positive significant
county emergency bail negative significant
statewide emergency bail positive significant



Looking at only people with a pretrial period end, recid controlling for days released and golive flag, covid flag, emergency flag
```{r}
summary(lm(data = full_df %>% 
             filter(released_pretrial_count ==1, pretrial_period_end_count == 1) %>%
             mutate(days_released = pretrial_period_end_date - release_date), recid_county_or_doj ~ days_released + golive_flag + covid_flag + emerg_flag))

```
Days released significant and positive
Golive flag significant and negative
Covid flag significant and positive
Emergency flag significant and positive

With booking date - Looking at only people with a pretrial period end, recid controlling for days released and golive flag, covid flag, emergency flag
```{r}
summary(lm(data = full_df %>% 
             filter(released_pretrial_count ==1, pretrial_period_end_count == 1) %>%
             mutate(days_released = pretrial_period_end_date - release_date), recid_county_or_doj ~ booking_date + days_released + golive_flag + covid_flag + emerg_flag))

```
BOoking date significant and negative
Days released significant and positive
Golive flag significant and negative
Covid flag significant and positive
Emergency flag significant and positive

With county level emergency bail - Looking at only people with a pretrial period end, recid controlling for days released and golive flag, covid flag, emergency flag
```{r}
summary(lm(data = full_df %>% 
             filter(released_pretrial_count ==1, pretrial_period_end_count == 1) %>%
             mutate(days_released = pretrial_period_end_date - release_date), recid_county_or_doj ~ booking_date + days_released + golive_flag + covid_flag + eb_flag + emerg_flag))

```
booking date negative significant
days released positive significant
golive negative (-0.043) significant
covid positive significant
local emergency bail negative significant
statewide emergency bail positive significant

# Look at changes in charge hierarchy -- NEED TO WAIT ON SNOWFLAKE FIX

```{r}
summary(lm(data = full_df %>%
             mutate(charge_hier = as.numeric(booking_charge_hierarchy)), charge_hier ~ golive_flag + covid_flag + emerg_flag))

```

```{r}
summary(lm(data = full_df %>%
             mutate(charge_hier = as.numeric(booking_charge_hierarchy)) %>%
             filter(released_pretrial_count == 1), charge_hier ~ golive_flag + covid_flag + emerg_flag))

```
Scale the charge hierarchy values
```{r}

summary(lm(data = full_df %>%
             mutate(charge_hier = scale(as.numeric(booking_charge_hierarchy))), charge_hier ~ golive_flag + covid_flag + emerg_flag))


summary(lm(data = full_df %>%
             mutate(charge_hier = scale(as.numeric(booking_charge_hierarchy))) %>%
             filter(released_pretrial_count == 1), charge_hier ~ golive_flag + covid_flag + emerg_flag))

```

# Look at go-live, covid, and STATEWIDE emergency bail dates by county with bookings
```{r eval=FALSE, include=FALSE}
full_df %>%
  filter(booking_date >= as.Date("2018-7-1"),
         booking_date < as.Date("2023-1-1")) %>%
  group_by(county, month = month(book_date), year = year(book_date)) %>%
  summarise(bookings = n(), releases = sum(released_pretrial_count),
            golive_date = mean(golive_date)) %>%
  mutate(book_date = as.Date(str_c(year, "-", month, "-1"))) %>%
  ggplot() +
    geom_line(aes(x = book_date, y = bookings)) +
    geom_vline(data = prog_date, aes(xintercept = golive_date), color = "green") +
    geom_vline(xintercept = as.Date("2020-3-1"), color = "orange") +
    annotate("rect", xmin=as.Date("2020-4-6"), xmax=as.Date("2020-6-20"), ymin=0, ymax=Inf, alpha=0.2, fill="red") +
    facet_grid(rows = vars(county), scales = "free")

ggsave("bookings with key dates by county.png", width = 7, height = 16)

```

separate misdo/fel bookings
```{r eval=FALSE, include=FALSE}
full_df %>%
  filter(booking_date >= as.Date("2018-7-1"),
         booking_date < as.Date("2023-1-1")) %>%
  filter(!charge_level_standard %in% c("I")) %>%
  group_by(county, month = month(book_date), year = year(book_date), charge_level_standard) %>%
  summarise(bookings = n(), releases = sum(released_pretrial_count),
            golive_date = mean(golive_date)) %>%
  mutate(book_date = as.Date(str_c(year, "-", month, "-1"))) %>%
  ggplot() +
    geom_line(aes(x = book_date, y = bookings, color = charge_level_standard)) +
    geom_vline(data = prog_date, aes(xintercept = golive_date), color = "green") +
    geom_vline(xintercept = as.Date("2020-3-1"), color = "orange") +
    annotate("rect", xmin=as.Date("2020-4-6"), xmax=as.Date("2020-6-20"), ymin=0, ymax=Inf, alpha=0.2, fill="red") +
    facet_grid(rows = vars(county), scales = "free")

ggsave("misdo fel bookings with key dates by county.png", width = 7, height = 16)

```

Bookings by race with key dates
```{r eval=FALSE, include=FALSE}
full_df %>%
  filter(booking_date >= as.Date("2018-7-1"),
         booking_date < as.Date("2023-1-1")) %>%
  mutate(race_standard = if_else(race_standard %in% c("Black", "White", "Hispanic"), race_standard, "Other/Unknown")) %>%
  group_by(county, month = month(book_date), year = year(book_date), race_standard) %>%
  summarise(bookings = n(), releases = sum(released_pretrial_count),
            golive_date = mean(golive_date)) %>%
  mutate(book_date = as.Date(str_c(year, "-", month, "-1"))) %>%
  ggplot() +
    geom_line(aes(x = book_date, y = bookings, color = race_standard)) +
    geom_vline(data = prog_date, aes(xintercept = golive_date), color = "green") +
    geom_vline(xintercept = as.Date("2020-3-1"), color = "orange") +
    annotate("rect", xmin=as.Date("2020-4-6"), xmax=as.Date("2020-6-20"), ymin=0, ymax=Inf, alpha=0.2, fill="red") +
    facet_grid(rows = vars(county), scales = "free")

ggsave("bookings by race with key dates by county.png", width = 7, height = 16)

```

Bookings percent by race with key dates
```{r eval=FALSE, include=FALSE}
full_df %>%
  filter(booking_date >= as.Date("2018-7-1"),
         booking_date < as.Date("2023-1-1")) %>%
  mutate(race_standard = if_else(race_standard %in% c("Black", "White", "Hispanic"), race_standard, "Other/Unknown")) %>%
  group_by(county, month = month(book_date), year = year(book_date), race_standard) %>%
  summarise(bookings = n(), releases = sum(released_pretrial_count),
            golive_date = mean(golive_date)) %>%
  mutate(book_date = as.Date(str_c(year, "-", month, "-1"))) %>%
  group_by(county, book_date) %>%
  mutate(book_perc = bookings/sum(bookings)) %>%
  ggplot() +
    geom_line(aes(x = book_date, y = book_perc, color = race_standard)) +
    geom_vline(data = prog_date, aes(xintercept = golive_date), color = "green") +
    geom_vline(xintercept = as.Date("2020-3-1"), color = "orange") +
    annotate("rect", xmin=as.Date("2020-4-6"), xmax=as.Date("2020-6-20"), ymin=0, ymax=Inf, alpha=0.2, fill="red") +
    facet_grid(rows = vars(county), scales = "free") +
    scale_y_continuous(labels = scales::percent)

ggsave("bookings share by race with key dates by county.png", width = 7, height = 16)

```


Bookings by offense type with key dates
```{r eval=FALSE, include=FALSE}
full_df %>%
  filter(booking_date >= as.Date("2018-7-1"),
         booking_date < as.Date("2023-1-1")) %>%
  mutate(offense_cat = case_when(arrest_violent_psa_flag == 1 ~ "Violent",
                                 arrest_dv_flag == 1 ~ "DV",
                                 arrest_dui_flag == 1 ~ "DUI",
                                 arrest_drug_flag == 1 ~ "Drug",
                                 arrest_property_flag == 1 ~ "Property",
                                 T ~ "Other/Unknown")) %>%
  group_by(county, month = month(book_date), year = year(book_date), offense_cat) %>%
  summarise(bookings = n(), releases = sum(released_pretrial_count),
            golive_date = mean(golive_date)) %>%
  mutate(book_date = as.Date(str_c(year, "-", month, "-1"))) %>%
  ggplot() +
    geom_line(aes(x = book_date, y = bookings, color = offense_cat)) +
    geom_vline(data = prog_date, aes(xintercept = golive_date), color = "green") +
    geom_vline(xintercept = as.Date("2020-3-1"), color = "orange") +
    annotate("rect", xmin=as.Date("2020-4-6"), xmax=as.Date("2020-6-20"), ymin=0, ymax=Inf, alpha=0.2, fill="red") +
    facet_grid(rows = vars(county), scales = "free")

ggsave("bookings by offense category with key dates by county.png", width = 7, height = 16)
```


# Look at go-live, covid, and LOCAL emergency bail dates by county with bookings
```{r eval=FALSE, include=FALSE}
full_df %>%
  filter(booking_date >= as.Date("2018-7-1"),
         booking_date < as.Date("2023-1-1")) %>%
  group_by(county, month = month(book_date), year = year(book_date)) %>%
  summarise(bookings = n(), releases = sum(released_pretrial_count),
            golive_date = mean(golive_date),
            eb_start_date = mean(eb_start_date),
            eb_end_date = mean(eb_end_date)) %>%
  ungroup() %>%
  mutate(book_date = as.Date(str_c(year, "-", month, "-1"))) %>%
  ggplot() +
    geom_line(aes(x = book_date, y = bookings)) +
    geom_vline(data = prog_date, aes(xintercept = golive_date), color = "green") +
    geom_vline(xintercept = as.Date("2020-3-1"), color = "orange") +
    geom_rect(data = prog_date, aes(xmin = eb_start_date, xmax = eb_end_date, ymin = 0, ymax = Inf), fill = "red", alpha = 0.2) +
    annotate("rect", xmin=as.Date("2020-4-13"), xmax=as.Date("2020-6-20"), ymin=0, ymax=Inf, alpha=0.2, fill="red") +
    facet_grid(rows = vars(county), scales = "free")

ggsave("bookings with key local dates by county.png", width = 7, height = 16)

```

look at released bookings by release date instead of booking date
```{r eval=FALSE, include=FALSE}
full_df %>%
  filter(!is.na(release_date)) %>%
  filter(release_date >= as.Date("2018-7-1"),
         release_date < as.Date("2023-1-1")) %>%
  group_by(county, month = month(release_date), year = year(release_date)) %>%
  summarise(bookings = n(), releases = sum(released_pretrial_count),
            golive_date = mean(golive_date),
            eb_start_date = mean(eb_start_date),
            eb_end_date = mean(eb_end_date)) %>%
  ungroup() %>%
  mutate(release_date = as.Date(str_c(year, "-", month, "-1"))) %>%
  ggplot() +
    geom_line(aes(x = release_date, y = bookings)) +
    geom_vline(data = prog_date, aes(xintercept = golive_date), color = "green") +
    geom_vline(xintercept = as.Date("2020-3-1"), color = "orange") +
    geom_rect(data = prog_date, aes(xmin = eb_start_date, xmax = eb_end_date, ymin = 0, ymax = Inf), fill = "red", alpha = 0.2) +
    annotate("rect", xmin=as.Date("2020-4-13"), xmax=as.Date("2020-6-20"), ymin=0, ymax=Inf, alpha=0.2, fill="red") +
    facet_grid(rows = vars(county), scales = "free")

ggsave("bookings with key local dates by county and release date.png", width = 7, height = 16)

```

separate misdo/fel bookings
```{r eval=FALSE, include=FALSE}
full_df %>%
  filter(booking_date >= as.Date("2018-7-1"),
         booking_date < as.Date("2023-1-1")) %>%
  filter(!charge_level_standard %in% c("I")) %>%
  group_by(county, month = month(book_date), year = year(book_date), charge_level_standard) %>%
  summarise(bookings = n(), releases = sum(released_pretrial_count),
            golive_date = mean(golive_date)) %>%
  mutate(book_date = as.Date(str_c(year, "-", month, "-1"))) %>%
  ggplot() +
    geom_line(aes(x = book_date, y = bookings, color = charge_level_standard)) +
    geom_vline(data = prog_date, aes(xintercept = golive_date), color = "green") +
    geom_vline(xintercept = as.Date("2020-3-1"), color = "orange") +
    geom_rect(data = prog_date, aes(xmin = eb_start_date, xmax = eb_end_date, ymin = 0, ymax = Inf), fill = "red", alpha = 0.2) +
    annotate("rect", xmin=as.Date("2020-4-13"), xmax=as.Date("2020-6-20"), ymin=0, ymax=Inf, alpha=0.2, fill="red") +
    facet_grid(rows = vars(county), scales = "free")

ggsave("misdo fel bookings with key local dates by county.png", width = 7, height = 16)

```

Bookings by race with key dates
```{r eval=FALSE, include=FALSE}
full_df %>%
  filter(booking_date >= as.Date("2018-7-1"),
         booking_date < as.Date("2023-1-1")) %>%
  mutate(race_standard = if_else(race_standard %in% c("Black", "White", "Hispanic"), race_standard, "Other/Unknown")) %>%
  group_by(county, month = month(book_date), year = year(book_date), race_standard) %>%
  summarise(bookings = n(), releases = sum(released_pretrial_count),
            golive_date = mean(golive_date)) %>%
  mutate(book_date = as.Date(str_c(year, "-", month, "-1"))) %>%
  ggplot() +
    geom_line(aes(x = book_date, y = bookings, color = race_standard)) +
    geom_vline(data = prog_date, aes(xintercept = golive_date), color = "green") +
    geom_vline(xintercept = as.Date("2020-3-1"), color = "orange") +
    geom_rect(data = prog_date, aes(xmin = eb_start_date, xmax = eb_end_date, ymin = 0, ymax = Inf), fill = "red", alpha = 0.2) +
    annotate("rect", xmin=as.Date("2020-4-13"), xmax=as.Date("2020-6-20"), ymin=0, ymax=Inf, alpha=0.2, fill="red") +
    facet_grid(rows = vars(county), scales = "free")

ggsave("bookings by race with key local dates by county.png", width = 7, height = 16)

```

Bookings percent by race with key dates
```{r eval=FALSE, include=FALSE}
full_df %>%
  filter(booking_date >= as.Date("2018-7-1"),
         booking_date < as.Date("2023-1-1")) %>%
  mutate(race_standard = if_else(race_standard %in% c("Black", "White", "Hispanic"), race_standard, "Other/Unknown")) %>%
  group_by(county, month = month(book_date), year = year(book_date), race_standard) %>%
  summarise(bookings = n(), releases = sum(released_pretrial_count),
            golive_date = mean(golive_date)) %>%
  mutate(book_date = as.Date(str_c(year, "-", month, "-1"))) %>%
  group_by(county, book_date) %>%
  mutate(book_perc = bookings/sum(bookings)) %>%
  ggplot() +
    geom_line(aes(x = book_date, y = book_perc, color = race_standard)) +
    geom_vline(data = prog_date, aes(xintercept = golive_date), color = "green") +
    geom_vline(xintercept = as.Date("2020-3-1"), color = "orange") +
    geom_rect(data = prog_date, aes(xmin = eb_start_date, xmax = eb_end_date, ymin = 0, ymax = Inf), fill = "red", alpha = 0.2) +
    annotate("rect", xmin=as.Date("2020-4-13"), xmax=as.Date("2020-6-20"), ymin=0, ymax=Inf, alpha=0.2, fill="red") +
    facet_grid(rows = vars(county), scales = "free") +
    scale_y_continuous(labels = scales::percent)

ggsave("bookings share by race with key local dates by county.png", width = 7, height = 16)

```


Bookings by offense type with key dates
```{r eval=FALSE, include=FALSE}
full_df %>%
  filter(booking_date >= as.Date("2018-7-1"),
         booking_date < as.Date("2023-1-1")) %>%
  mutate(offense_cat = case_when(arrest_violent_psa_flag == 1 ~ "Violent",
                                 arrest_dv_flag == 1 ~ "DV",
                                 arrest_dui_flag == 1 ~ "DUI",
                                 arrest_drug_flag == 1 ~ "Drug",
                                 arrest_property_flag == 1 ~ "Property",
                                 T ~ "Other/Unknown")) %>%
  group_by(county, month = month(book_date), year = year(book_date), offense_cat) %>%
  summarise(bookings = n(), releases = sum(released_pretrial_count),
            golive_date = mean(golive_date)) %>%
  mutate(book_date = as.Date(str_c(year, "-", month, "-1"))) %>%
  ggplot() +
    geom_line(aes(x = book_date, y = bookings, color = offense_cat)) +
    geom_vline(data = prog_date, aes(xintercept = golive_date), color = "green") +
    geom_vline(xintercept = as.Date("2020-3-1"), color = "orange") +
    geom_rect(data = prog_date, aes(xmin = eb_start_date, xmax = eb_end_date, ymin = 0, ymax = Inf), fill = "red", alpha = 0.2) +
    annotate("rect", xmin=as.Date("2020-4-13"), xmax=as.Date("2020-6-20"), ymin=0, ymax=Inf, alpha=0.2, fill="red") +
    facet_grid(rows = vars(county), scales = "free")

ggsave("bookings by offense category with key local dates by county.png", width = 7, height = 16)
```


Bookings by offense type share with key dates
```{r eval=FALSE, include=FALSE}
full_df %>%
  filter(booking_date >= as.Date("2018-7-1"),
         booking_date < as.Date("2023-1-1")) %>%
  mutate(offense_cat = case_when(arrest_violent_psa_flag == 1 ~ "Violent",
                                 arrest_dv_flag == 1 ~ "DV",
                                 arrest_dui_flag == 1 ~ "DUI",
                                 arrest_drug_flag == 1 ~ "Drug",
                                 arrest_property_flag == 1 ~ "Property",
                                 T ~ "Other/Unknown")) %>%
  group_by(county, month = month(book_date), year = year(book_date), offense_cat) %>%
  summarise(bookings = n(), releases = sum(released_pretrial_count),
            golive_date = mean(golive_date)) %>%
  mutate(book_date = as.Date(str_c(year, "-", month, "-1"))) %>%
  group_by(county, book_date) %>%
  mutate(book_perc = bookings/sum(bookings)) %>%
  ggplot() +
    geom_line(aes(x = book_date, y = book_perc, color = offense_cat)) +
    geom_vline(data = prog_date, aes(xintercept = golive_date), color = "green") +
    geom_vline(xintercept = as.Date("2020-3-1"), color = "orange") +
    geom_rect(data = prog_date, aes(xmin = eb_start_date, xmax = eb_end_date, ymin = 0, ymax = Inf), fill = "red", alpha = 0.2) +
    annotate("rect", xmin=as.Date("2020-4-13"), xmax=as.Date("2020-6-20"), ymin=0, ymax=Inf, alpha=0.2, fill="red") +
    facet_grid(rows = vars(county), scales = "free")+
    scale_y_continuous(labels = scales::percent)

ggsave("bookings share by offense category with key local dates by county.png", width = 7, height = 16)
```

# Other things
Look at arrest charge flags
```{r eval=FALSE, include=FALSE}
full_df %>%
  filter(booking_date >= as.Date("2018-7-1"),
         booking_date < as.Date("2023-1-1")) %>%
  filter(charge_level_standard %in% c("M", "F")) %>%
  select(arrest_special_flag:arrest_dv_possible_flag) %>%
  count(!!!rlang::syms(names(.)[1:15])) %>%
  arrange(desc(n)) %>%
  mutate(perc = round(100*n/sum(n),1))


```
37.2% of all bookings have no arrest offense flags
26.7% of misdo or fel bookings have no arrest offense flags
WHY?
Some vehicle codes (eg 14601.1A - driving with a suspended license- don't seem to fall into any of the flag categories, or VC 	12500 (A) driving without a license which are the two most prevalent charges with no flags) (other common examples include PC 29800(A)(1) Felon in posession of a firearm)
On the other hand, there are 8,130 charges of PC 459.5 that got a hierarchy value so must have matched but do not have any flags, which is odd because it is clearly a property crime, also because it has a jbsis code of 220 which is coded to generate a property flag of 1 so what went wrong there??
Some bookings have unknown charges (199,941 in full_df, though that is only the "most severe" charges according to current broken collapse algorithm, but even though it is broken, "Unknown" is the hierarchy value for unknown charges, which should be larger than most numbers, so I think possibly these are only showing up when all charges are unknown? )
Some bookings were entered incorrectly, such as 11,122 rows with booking charge code "LC" and booking charge "647(F)PCA" which will not match to charge hierarchy and ended up with an unknown booking charge hierarchy.

```{r eval=FALSE, include=FALSE}
full_df %>%
  mutate(flag_sum = rowSums(.[79:93])) %>%
  filter(flag_sum == 0) %>%
  count(booking_charge_code, booking_charge, booking_charge_level, booking_charge_hierarchy) %>%
  arrange(desc(n))
```
693,289 rows with no arrest charge flags

Look at common charges
```{r eval=FALSE, include=FALSE}
full_df %>%
  filter(grepl("14601", booking_charge)) %>%
  count(booking_charge, booking_charge_hierarchy) %>%
  arrange(desc(n))

#load("G:/CrimJustice/PretrialAssessmentPilot/Complete Charge Code Hierarchy_SL.Rdata")

# charge_hier %>%
#   filter(charge == "4595")
```
Ok, so in some instances it makes sense there are no flags because the flags do not cover all categories, such as missing certain vehicle code violations. But in some instances like PC 459.5 the charge hierarchy does not have the correct flags (why no property flag??) when it should. That sucks. Could try looking at the JBSIS code for categories instead, but that would only work for the most serious charge since the flags are used for the collapse. 

```{r}
full_df %>%
  count(recid_county_or_doj)

# ggplot(full_df,aes(booking_date, recid_county_or_doj)) +
#  # stat_summary(fun.data=mean_cl_normal) + 
#   geom_smooth(method='lm', formula= recid_county_or_doj ~ booking_date + golive_flag + covid_flag + emerg_flag)
```

Look at counties where we have some data before they went live
```{r}
prepost_countylist <- full_df %>%
  filter(golive_flag == 0) %>%
  count(county) %>%
  filter(n>100) %>%
  pull(county)

prepost_countylist

```

```{r}
full_df %>%
  filter(released_pretrial_count == 1) %>%
  filter(booking_date >= as.Date("2018-7-1")) %>%
  filter(!is.na(golive_flag)) %>%
  mutate(golive_flag = as.factor(golive_flag)) %>%
  group_by(year = year(booking_date), month = month(booking_date), golive_flag) %>%
  summarise(recid_rate = sum(recid_arrested_flag_doj, na.rm = T)/n()) %>%
  ungroup() %>%
  mutate(book_month = as.Date(str_c(year, "-", month, "-1"))) %>%
  ggplot(aes(x = book_month, y = recid_rate)) +
    geom_bar(aes(fill = golive_flag), position="dodge", stat="identity")
    #geom_line(aes(x = book_month, y = recid_rate, color = golive_flag))





```


```{r}
full_df %>%
  filter(released_pretrial_count == 1) %>%
  filter(booking_date >= as.Date("2018-7-1")) %>%
  filter(booking_date < as.Date("2022-1-1")) %>%
  filter(!is.na(golive_flag)) %>%
  filter(county %in% prepost_countylist) %>%
  mutate(golive_flag = as.factor(golive_flag)) %>%
  group_by(year = year(booking_date), month = month(booking_date)) %>%
  summarise(recid_rate = sum(recid_county_or_doj, na.rm = T)/n()) %>%
  ungroup() %>%
  mutate(book_month = as.Date(str_c(year, "-", month, "-1"))) %>%
  ggplot(aes(x = book_month, y = recid_rate)) +
    geom_bar(position="dodge", stat="identity") +
    geom_vline(xintercept = as.Date("2020-3-1"), color = "red")
    #geom_line(aes(x = book_month, y = recid_rate, color = golive_flag))
```


```{r}
early_golive <- prog_date %>%
  filter(golive_date < as.Date("2020-1-1")) %>%
  pull(county)
```


```{r}
full_df %>%
  filter(released_pretrial_count == 1) %>%
  filter(booking_date >= as.Date("2018-7-1")) %>%
  filter(booking_date < as.Date("2022-1-1")) %>%
  filter(!is.na(golive_flag)) %>%
  filter(county %in% early_golive) %>%
  mutate(golive_flag = as.factor(golive_flag)) %>%
  group_by(year = year(booking_date), month = month(booking_date)) %>%
  summarise(recid_rate = sum(recid_county_or_doj, na.rm = T)/n()) %>%
  ungroup() %>%
  mutate(book_month = as.Date(str_c(year, "-", month, "-1"))) %>%
  ggplot(aes(x = book_month, y = recid_rate)) +
    geom_bar(position="dodge", stat="identity") +
    geom_vline(xintercept = as.Date("2020-3-1"), color = "red")
```

```{r}
# lapply(early_golive,
#        function(i){
#          full_df %>%
#   filter(released_pretrial_count == 1) %>%
#   filter(booking_date >= as.Date("2018-7-1")) %>%
#   filter(booking_date < as.Date("2020-3-1")) %>%
#   filter(!is.na(golive_flag)) %>%
#   filter(county ==i) %>%
#   mutate(golive_flag = as.factor(golive_flag)) %>%
#   group_by(year = year(booking_date), month = month(booking_date)) %>%
#   summarise(recid_rate = sum(recid_county_or_doj, na.rm = T)/n()) %>%
#   ungroup() %>%
#   mutate(book_month = as.Date(str_c(year, "-", month, "-1"))) %>%
#   ggplot(aes(x = book_month, y = recid_rate)) +
#     geom_bar(position="dodge", stat="identity") +
#     geom_vline(xintercept = as.Date("2020-3-1"), color = "red")+
#     geom_vline(xintercept = prog_date %>% filter(county ==i) %>% pull(golive_date), color = "green") +
#     ggtitle(i)
#          
#        })
```


Santa Barbara-- FTA graph only by court_date_reminder_flag
\newline
```{r eval=FALSE, fig.height=6, fig.width=10, dpi=1200, include=FALSE}
risk_df <- eval_df %>%
  filter(county == "Santa Barbara") %>%
  filter(booking_date < as.Date("2020-3-1")) %>%
  mutate(court_date_reminder_flag = factor(court_date_reminder_flag)) %>%
  filter(tool_name == "VPRAI", !is.na(vprai_risk_score)) %>%
  group_by(vprai_risk_score, court_date_reminder_flag) %>%
  select(vprai_risk_score, court_date_reminder_flag, fta_flag) %>%
  pivot_longer(fta_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA"),
         name = factor(name, levels = c("FTA"))) 

ggplot(risk_df) +
  aes(x = vprai_risk_score, y = value, color = court_date_reminder_flag) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent",
       title = "Comparison of Court Date Reminder Differences in Logistic Regression Curves--VPRAI, Santa Barbara pre-pandemic")# +
  #scale_x_continuous(breaks = 0:14)

eval_df %>%
  filter(county == "Santa Barbara") %>%
  filter(booking_date < as.Date("2020-3-1")) %>%
  count(tool_name, court_date_reminder_flag)
```
\newpage

```{r eval=FALSE, include=FALSE}
eval_df %>%
  filter(county == "Santa Barbara") %>%
  count(arrest_violent_psa_flag, charge_level) %>%
  mutate(perc = round(100*n/sum(n),1))
  
eval_df %>%
  filter(county == "Santa Barbara") %>%
  summarise(min(booking_date), max(booking_date))


full_df %>%
  filter(booking_date >= as.Date("2019-12-2")) %>%
  filter(booking_date<= as.Date("2021-12-31")) %>%
  filter(county == "Santa Barbara") %>%
  count(arrest_violent_psa_flag, charge_level) %>%
  mutate(perc = round(100*n/sum(n),1))


  eval_df %>%
  mutate(fel_flag = if_else(charge_level == "F", 1, 0),
         misdo_flag = if_else(charge_level %in% c("M", "I"), 1, 0)) %>%
  group_by(county) %>%
  summarise_at(vars(fel_flag, misdo_flag, arrest_violent_psa_flag, arrest_property_flag, arrest_drug_flag,
                    arrest_dui_flag, arrest_dv_flag), funs(round(mean(.)*100)))

```

# Pull in Mobility data from AppleMaps (given to me by Deepak from PPIC)
```{r}
mob <- fread("C:/Users/slempert/Judicial Council of California/CJS Research - Documents/SB 36 Validation Reports/COVID data/applemobilitytrends-2022-04-06.csv", header = T)

mob <- mob %>%
  filter(country == "United States") %>%
  filter(`sub-region` == "California") %>%
  filter(geo_type == "county")

mob <- mob %>%
  select(-c(alternative_name, `sub-region`, country, geo_type))

mob <- mob %>%
  pivot_longer(cols = 3:817, names_to = "date")

mob <- mob %>%
  mutate(date = as.Date(date))

mob %>%
  ggplot() +
  geom_line(aes(x = date, y = value, color = transportation_type)) +
  facet_wrap(~region, scales = "free")

mob <- mob %>%
  mutate(region = gsub(" County", "", region)) 

mob <- mob %>%
  rename(county = region)

mob_wide <- mob %>%
  pivot_wider(names_from = transportation_type, names_prefix = "mob_")
```
Join mobility data to full_df
```{r}
full_df <- full_df %>%
  left_join(mob_wide, by = c("county", "booking_date" = "date"))

```

Join average mobility over pretrial period to complete pretrial periods with pretrial release
```{r}
test_df <- full_df %>%
  filter(released_pretrial_count == 1,
         pretrial_period_end_count == 1) %>%
  select(release_date, pretrial_period_end_date) %>%
  distinct()

test_df <- test_df %>%
  rename(start = release_date) %>%
  rename(end = pretrial_period_end_date)

test_df
```

Create function for driving mobility mean value
```{r}
get_drive_mob_mean <- function(loc_county, start, end){
  mob_wide %>%
    filter(county == loc_county, 
           date >=start,
           date <= end) %>%
    summarise(mmd = mean(mob_driving)) %>%
    pull(mmd)
}
```


```{r}
test_c <- full_df %>%
  filter(released_pretrial_count == 1,
         pretrial_period_end_count == 1) %>%
  mutate(avg_drive_mob = get_drive_mob_mean(county, release_date, pretrial_period_end_date))

test_c <- full_df %>%
  filter(released_pretrial_count == 1,
         pretrial_period_end_count == 1) %>%
  mutate(test_col = 0)

test_f <- for (row in 1:nrow(test_c)){
  test_c$test_col[row] <- get_drive_mob_mean(test_c$county[row], test_c$release_date[row], test_c$pretrial_period_end_date[row])
}

get_drive_mob_mean("Alameda", as.Date("2020-1-13"), as.Date("2020-1-14"))


```




```{r}
#vectorized funcition
get_drive_mob_mean_V <- Vectorize(get_drive_mob_mean)

test_m <- full_df %>%
  filter(released_pretrial_count == 1,
         pretrial_period_end_count == 1) %>%
  mutate(avg_drive_mob = get_drive_mob_mean_V(county, release_date, pretrial_period_end_date))

test_m %>%
  count(avg_drive_mob)
```


```{r}
mob_means <- test_m %>%
  select(release_date, pretrial_period_end_date, avg_drive_mob) %>%
  distinct()

#save(mob_means, file = "C:/Users/slempert/Judicial Council of California/CJS Research - Documents/SB 36 Validation Reports/COVID data/mob_means.Rdata")
```




# Try regressions with mobility data
```{r}
#Looking at only people with a pretrial period end, FTA controlling for days released and golive flag, covid flag, emergency flag, and driving mobility data
summary(lm(data = full_df %>% 
             filter(released_pretrial_count ==1, pretrial_period_end_count == 1) %>%
             mutate(days_released = pretrial_period_end_date - release_date), fta_flag ~ days_released + golive_flag + covid_flag + eb_flag + emerg_flag + mob_driving))
```
golive_flag is significant (p<.0001) and negative (-0.039)


```{r}
#Looking at only people with a pretrial period end, FTA controlling for days released and golive flag, covid flag, emergency flag, and driving mobility data, and booking date
summary(lm(data = full_df %>% 
             filter(released_pretrial_count ==1, pretrial_period_end_count == 1) %>%
             mutate(days_released = pretrial_period_end_date - release_date), fta_flag ~ days_released + golive_flag + covid_flag + eb_flag + emerg_flag + mob_driving + booking_date + county))
```


```{r}
#Looking at only people with a pretrial period end, FTA controlling for days released and golive flag, covid flag, emergency flag, and driving mobility data, and booking date
summary(lm(data = full_df %>% 
             filter(released_pretrial_count ==1, pretrial_period_end_count == 1) %>%
             mutate(days_released = pretrial_period_end_date - release_date), fta_flag ~ days_released + golive_flag + covid_flag + eb_flag + emerg_flag + mob_driving + booking_date))
```
golive_flag is no longer significant if we control for booking date

```{r}
summary(lm(data = full_df %>% 
             filter(released_pretrial_count ==1, pretrial_period_end_count == 1) %>%
             mutate(days_released = pretrial_period_end_date - release_date), 
           recid_county_or_doj ~ days_released + golive_flag + covid_flag + eb_flag + emerg_flag + mob_walking + mob_driving + mob_transit))
```
golive_flag is not significant

```{r}
summary(lm(data = full_df %>% 
             filter(released_pretrial_count ==1, pretrial_period_end_count == 1) %>%
             mutate(days_released = pretrial_period_end_date - release_date), recid_county_or_doj ~ booking_date + days_released + golive_flag + covid_flag + eb_flag + emerg_flag + mob_walking + mob_driving + mob_transit))
```
golive_flag is significant (p = 0.0017) and positive (0.018)

```{r}
summary(lm(data = full_df %>% 
             filter(released_pretrial_count ==1, pretrial_period_end_count == 1) %>%
             mutate(days_released = pretrial_period_end_date - release_date), 
           recid_county_or_doj ~ days_released*mob_driving + golive_flag + covid_flag + eb_flag + emerg_flag  ))
```
```{r}
summary(lm(data = full_df %>% 
             filter(released_pretrial_count ==1, pretrial_period_end_count == 1,
                    booking_date >= as.Date("2020-1-1"), booking_date <=as.Date("2022-4-1")) %>%
             mutate(days_released = pretrial_period_end_date - release_date), 
           recid_county_or_doj ~ days_released*mob_driving + golive_flag + covid_flag + eb_flag + emerg_flag + county + mob_walking + mob_transit ))
```

# Try regressions with mean mobility data over pretrial period
```{r}
#Looking at only people with a pretrial period end, FTA controlling for days released and golive flag, covid flag, emergency flag, and driving mobility data
summary(lm(data = test_m %>%
             mutate(days_released = pretrial_period_end_date - release_date), 
           fta_flag ~ days_released + golive_flag + covid_flag + eb_flag + emerg_flag + avg_drive_mob + county))
```
golive_flag is not significant


```{r}
#Looking at only people with a pretrial period end, FTA controlling for days released and golive flag, covid flag, emergency flag, and driving mobility data, and booking date
summary(lm(data = test_m %>%
             mutate(days_released = pretrial_period_end_date - release_date), 
           fta_flag ~ days_released*avg_drive_mob + golive_flag + covid_flag + eb_flag + emerg_flag + booking_date + county))
```
go_live is not significant

# Recidivism regressions
```{r}
test_m %>%
  summarise(min(booking_date), max(booking_date))

```

```{r}
summary(lm(data = test_m %>%
             filter(booking_date >= as.Date("2020-01-13")) %>%
             mutate(days_released = pretrial_period_end_date - release_date), 
           recid_county_or_doj ~ days_released*avg_drive_mob + golive_flag + covid_flag + eb_flag + emerg_flag + county))


prog_date
```


```{r}
summary(lm(data = test_m %>%
             mutate(days_released = pretrial_period_end_date - release_date), recid_county_or_doj ~ booking_date + days_released + golive_flag + covid_flag + eb_flag + emerg_flag + avg_drive_mob + county + booking_date))
```
golive_flag is marginal (p = 0.09) and negative (-0.017)

```{r}
summary(lm(data = test_m %>%
             mutate(days_released = pretrial_period_end_date - release_date), 
           recid_county_or_doj ~ days_released*avg_drive_mob + golive_flag + covid_flag + eb_flag + emerg_flag +  county ))
```
go_live is significant (p <0.001) and negative (-0.035)

```{r}
summary(lm(data = test_m %>%
             mutate(days_released = pretrial_period_end_date - release_date), 
           recid_county_or_doj ~ days_released*avg_drive_mob + golive_flag + covid_flag + eb_flag + emerg_flag + county + booking_date ))
```
with booking date, golive is marginal (p=0.08) and negative (-0.017)

#Look at individual counties
```{r}
summary(lm(data = test_m %>%
             filter(county == "Los Angeles") %>%
             mutate(days_released = pretrial_period_end_date - release_date), 
           recid_county_or_doj ~ days_released*avg_drive_mob + golive_flag + covid_flag + eb_flag + emerg_flag))
```
```{r}
summary(lm(data = test_m %>%
             filter(county == "Alameda") %>%
             mutate(days_released = pretrial_period_end_date - release_date), 
           recid_county_or_doj ~ days_released*avg_drive_mob + golive_flag + covid_flag + eb_flag + emerg_flag))
```
```{r}
summary(lm(data = test_m %>%
             filter(county == "Sacramento") %>%
             mutate(days_released = pretrial_period_end_date - release_date), 
           recid_county_or_doj ~ days_released*avg_drive_mob + golive_flag + covid_flag + eb_flag + emerg_flag))
```
```{r}
summary(lm(data = test_m %>%
             filter(county == "Tulare") %>%
             mutate(days_released = pretrial_period_end_date - release_date), 
           recid_county_or_doj ~ days_released*avg_drive_mob + golive_flag + covid_flag + eb_flag + emerg_flag))
```
```{r}
summary(lm(data = test_m %>%
             filter(county %in% c("Los Angeles", "Alameda", "Sacramento", "San Mateo", "Ventura", "Tulare")) %>%
             mutate(days_released = pretrial_period_end_date - release_date), 
           recid_county_or_doj ~ days_released*avg_drive_mob + golive_flag + covid_flag + eb_flag + emerg_flag + county))
```

```{r}
countylist <- prog_date %>%
  filter(golive_date > as.Date("2020-1-13")) %>%
  pull(county)

summary(lm(data = test_m %>%
             filter(county %in% countylist) %>%
             mutate(days_released = pretrial_period_end_date - release_date), 
           recid_county_or_doj ~ days_released*avg_drive_mob + golive_flag + covid_flag + eb_flag + emerg_flag + county + booking_date))


```
```{r}
countylist <- prog_date %>%
  filter(golive_date > as.Date("2020-1-13")) %>%
  pull(county)

summary(lm(data = test_m %>%
             filter(!is.na(avg_drive_mob)) %>%
             #filter(county %in% countylist) %>%
             filter(booking_date >= as.Date("2020-1-13")) %>%
             mutate(days_released = pretrial_period_end_date - release_date), 
           recid_county_or_doj ~ days_released*avg_drive_mob + golive_flag + covid_flag + eb_flag + emerg_flag + county))


```

```{r}
prog_date
```
# Upload BTS data
https://data.bts.gov/Research-and-Statistics/Trips-by-Distance/w96p-f2qv
```{r}
bts <- fread("C:/Users/slempert/Judicial Council of California/CJS Research - Documents/SB 36 Validation Reports/COVID data/Trips_by_Distance.csv", header = T)

# fips <- read_excel("C:/Users/slempert/Judicial Council of California/CJS Research - Documents/SB 36 Validation Reports/COVID data/US_FIPS_Codes.xls", skip = 1)
# 
# fips <- fips %>%
#   filter(State == "California") %>%
#   mutate(county_fips = str_c("6", `FIPS County`))

bts <- bts %>%
  filter(`State FIPS` == 6) %>%
  filter(Level == "County")

bts <- bts %>%
  mutate(total_pop = `Population Staying at Home` + `Population Not Staying at Home`) %>%
  mutate(mob_pop = `Population Not Staying at Home`/total_pop) %>%
  mutate(Date = ymd(Date))

bts %>%
  ggplot() +
  geom_line(aes(x = Date, y = mob_pop, color = `County Name`))

mob_bts <- bts %>%
  select(date = Date, county = `County Name`, mob_pop)

mob_bts <- mob_bts %>%
  mutate(county = gsub(" County", "", county))

mob_bts <- mob_bts %>%
  filter(!is.na(mob_pop))

mob_bts %>%
  summarise(min(date), max(date))

mob_bts %>%
  filter(is.na(mob_pop))

mob_bts %>%
  count(county)

mob_bts %>%
  filter(is.na(date))

mob_bts <- as_tibble(mob_bts)
```


Create function to calculate average bts mobility
```{r}
get_bts_mob_mean <- function(loc_county, start, end){
  mob_bts %>%
    filter(county == loc_county, 
           date >=start,
           date <= end) %>%
    summarise(mmp = mean(mob_pop)) %>%
    pull(mmp)
}

get_bts_mob_mean_V <- Vectorize(get_bts_mob_mean)

```
Apply function
```{r eval=FALSE, include=FALSE}
test_b_alameda <- full_df %>%
  filter(released_pretrial_count == 1,
         pretrial_period_end_count == 1) %>%
  filter(pretrial_period_end_date >= release_date) %>%
  filter(county == "Alameda") %>%
  mutate(avg_bts_mob = 0) %>%
  mutate(avg_bts_mob = get_bts_mob_mean_V(county, release_date, pretrial_period_end_date))

test_b_calaveras <- full_df %>%
  filter(released_pretrial_count == 1,
         pretrial_period_end_count == 1) %>%
  filter(pretrial_period_end_date >= release_date) %>%
  filter(county == "Calaveras") %>%
  mutate(avg_bts_mob = 0) %>%
  mutate(avg_bts_mob = get_bts_mob_mean_V(county, release_date, pretrial_period_end_date))

test_b_kings <- full_df %>%
  filter(released_pretrial_count == 1,
         pretrial_period_end_count == 1) %>%
  filter(pretrial_period_end_date >= release_date) %>%
  filter(county == "Kings") %>%
  mutate(avg_bts_mob = 0) %>%
  mutate(avg_bts_mob = get_bts_mob_mean_V(county, release_date, pretrial_period_end_date))

test_b_la <- full_df %>%
  filter(released_pretrial_count == 1,
         pretrial_period_end_count == 1) %>%
  filter(pretrial_period_end_date >= release_date) %>%
  filter(county == "Los Angeles") %>%
  mutate(avg_bts_mob = 0) %>%
  mutate(avg_bts_mob = get_bts_mob_mean_V(county, release_date, pretrial_period_end_date))

test_b_modoc <- full_df %>%
  filter(released_pretrial_count == 1,
         pretrial_period_end_count == 1) %>%
  filter(pretrial_period_end_date >= release_date) %>%
  filter(county == "Modoc") %>%
  mutate(avg_bts_mob = 0) %>%
  mutate(avg_bts_mob = get_bts_mob_mean_V(county, release_date, pretrial_period_end_date))

test_b_napa <- full_df %>%
  filter(released_pretrial_count == 1,
         pretrial_period_end_count == 1) %>%
  filter(pretrial_period_end_date >= release_date) %>%
  filter(county == "Napa") %>%
  mutate(avg_bts_mob = 0) %>%
  mutate(avg_bts_mob = get_bts_mob_mean_V(county, release_date, pretrial_period_end_date))

test_b_nevada <- full_df %>%
  filter(released_pretrial_count == 1,
         pretrial_period_end_count == 1) %>%
  filter(pretrial_period_end_date >= release_date) %>%
  filter(county == "Nevada") %>%
  mutate(avg_bts_mob = 0) %>%
  mutate(avg_bts_mob = get_bts_mob_mean_V(county, release_date, pretrial_period_end_date))

test_b_sac <- full_df %>%
  filter(released_pretrial_count == 1,
         pretrial_period_end_count == 1) %>%
  filter(pretrial_period_end_date >= release_date) %>%
  filter(county == "Sacramento") %>%
  mutate(avg_bts_mob = 0) %>%
  mutate(avg_bts_mob = get_bts_mob_mean_V(county, release_date, pretrial_period_end_date))

test_b_sj <- full_df %>%
  filter(released_pretrial_count == 1,
         pretrial_period_end_count == 1) %>%
  filter(pretrial_period_end_date >= release_date) %>%
  filter(county == "San Joaquin") %>%
  mutate(avg_bts_mob = 0) %>%
  mutate(avg_bts_mob = get_bts_mob_mean_V(county, release_date, pretrial_period_end_date))

test_b_sm <- full_df %>%
  filter(released_pretrial_count == 1,
         pretrial_period_end_count == 1) %>%
  filter(pretrial_period_end_date >= release_date) %>%
  filter(county == "San Mateo") %>%
  mutate(avg_bts_mob = 0) %>%
  mutate(avg_bts_mob = get_bts_mob_mean_V(county, release_date, pretrial_period_end_date))

test_b_sb <- full_df %>%
  filter(released_pretrial_count == 1,
         pretrial_period_end_count == 1) %>%
  filter(pretrial_period_end_date >= release_date) %>%
  filter(county == "Santa Barbara") %>%
  mutate(avg_bts_mob = 0) %>%
  mutate(avg_bts_mob = get_bts_mob_mean_V(county, release_date, pretrial_period_end_date))

test_b_sierra <- full_df %>%
  filter(released_pretrial_count == 1,
         pretrial_period_end_count == 1) %>%
  filter(pretrial_period_end_date >= release_date) %>%
  filter(county == "Sierra") %>%
  mutate(avg_bts_mob = 0) %>%
  mutate(avg_bts_mob = get_bts_mob_mean_V(county, release_date, pretrial_period_end_date))

test_b_sonoma <- full_df %>%
  filter(released_pretrial_count == 1,
         pretrial_period_end_count == 1) %>%
  filter(pretrial_period_end_date >= release_date) %>%
  filter(county == "Sonoma") %>%
  mutate(avg_bts_mob = 0) %>%
  mutate(avg_bts_mob = get_bts_mob_mean_V(county, release_date, pretrial_period_end_date))

test_b_tulare <- full_df %>%
  filter(released_pretrial_count == 1,
         pretrial_period_end_count == 1) %>%
  filter(pretrial_period_end_date >= release_date) %>%
  filter(county == "Tulare") %>%
  mutate(avg_bts_mob = 0) %>%
  mutate(avg_bts_mob = get_bts_mob_mean_V(county, release_date, pretrial_period_end_date))

test_b_tuolumne <- full_df %>%
  filter(released_pretrial_count == 1,
         pretrial_period_end_count == 1) %>%
  filter(pretrial_period_end_date >= release_date) %>%
  filter(county == "Tuolumne") %>%
  mutate(avg_bts_mob = 0) %>%
  mutate(avg_bts_mob = get_bts_mob_mean_V(county, release_date, pretrial_period_end_date))

test_b_ventura <- full_df %>%
  filter(released_pretrial_count == 1,
         pretrial_period_end_count == 1) %>%
  filter(pretrial_period_end_date >= release_date) %>%
  filter(county == "Ventura") %>%
  mutate(avg_bts_mob = 0) %>%
  mutate(avg_bts_mob = get_bts_mob_mean_V(county, release_date, pretrial_period_end_date))

test_b_yuba <- full_df %>%
  filter(released_pretrial_count == 1,
         pretrial_period_end_count == 1) %>%
  filter(pretrial_period_end_date >= release_date) %>%
  filter(county == "Yuba") %>%
  mutate(avg_bts_mob = 0) %>%
  mutate(avg_bts_mob = get_bts_mob_mean_V(county, release_date, pretrial_period_end_date))

full_bts <- test_b_alameda %>%
  bind_rows(test_b_calaveras) %>%
  bind_rows(test_b_kings) %>%
  bind_rows(test_b_la) %>%
  bind_rows(test_b_modoc) %>%
  bind_rows(test_b_napa) %>%
  bind_rows(test_b_nevada) %>%
  bind_rows(test_b_sac) %>%
  bind_rows(test_b_sj) %>%
  bind_rows(test_b_sm) %>%
  bind_rows(test_b_sb) %>%
  bind_rows(test_b_sierra) %>%
  bind_rows(test_b_sonoma) %>%
  bind_rows(test_b_tulare) %>%
  bind_rows(test_b_tuolumne) %>%
  bind_rows(test_b_ventura) %>%
  bind_rows(test_b_yuba)


bts_means <- full_bts %>%
  select(county, release_date, pretrial_period_end_date, avg_bts_mob) %>%
  distinct()

# save(bts_means, file = "C:/Users/slempert/Judicial Council of California/CJS Research - Documents/SB 36 Validation Reports/COVID data/bts_means.Rdata")
# 
# full_df %>%
#   filter(released_pretrial_count == 1,
#          pretrial_period_end_count == 1) %>%
#   count(is.na(release_date), is.na(pretrial_period_end_date), is.na(county))
#   filter(!is.na(release_date),
#          !is.na(pretrial_period_end_date)) %>%
#   head(10) %>%
#   mutate(avg_bts_mob = 0) %>%
#   mutate(avg_bts_mob = get_bts_mob_mean_V(county, release_date, pretrial_period_end_date)) %>%
#   select(county, release_date, pretrial_period_end_date, avg_bts_mob)

test_b_la %>%
  select(release_date, pretrial_period_end_date, avg_bts_mob)

full_df %>%
  count(county)
```

Load and join saved mobility means to dataset
```{r}
load("C:/Users/slempert/Judicial Council of California/CJS Research - Documents/SB 36 Validation Reports/COVID data/bts_means.Rdata")
full_bts <- full_df %>%
  left_join(bts_means)
```
Join daily mobility data to dataset
```{r}

full_bts <- full_bts %>%
  left_join(mob_bts, by = c("booking_date" = "date", "county")) 
```
# Regressions old
FTA
```{r}
#Looking at only people with a pretrial period end, FTA controlling for days released and golive flag, covid flag, emergency flag, and driving mobility data, and booking date
summary(lm(data = full_bts %>%
             mutate(days_released = pretrial_period_end_date - release_date), 
           fta_flag ~ days_released*avg_bts_mob + golive_flag + covid_flag + eb_flag + emerg_flag + county))
```
golive is significant (p = 0.0002) and negative (-0.0139)


Rearrest
```{r}
#Looking at only people with a pretrial period end, new arrest controlling for days released and golive flag, covid flag, emergency flag, and driving mobility data, and booking date
summary(lm(data = full_bts %>%
             mutate(days_released = pretrial_period_end_date - release_date), 
           recid_county_or_doj ~ days_released*avg_bts_mob + golive_flag + covid_flag + eb_flag + emerg_flag + county))

full_bts %>%
  summarise(min(booking_date), max(booking_date))
```
golive is significant (p < 0.0001) and negative (-0.0414)

FTA - filtered timeline
```{r}
#Looking at only people with a pretrial period end, FTA controlling for days released and golive flag, covid flag, emergency flag, and driving mobility data, and booking date
summary(lm(data = full_bts %>%
             filter(release_date >= as.Date("2019-01-01"),
                    pretrial_period_end_date <= as.Date("2022-04-30")) %>%
             mutate(days_released = pretrial_period_end_date - release_date), 
           fta_flag ~ days_released*avg_bts_mob + golive_flag + covid_flag + eb_flag + emerg_flag + county))
```
golive is not significant and positive (0.0019)



Rearrest - filtered timeline
```{r}
#Looking at only people with a pretrial period end, new arrest controlling for days released and golive flag, covid flag, emergency flag, and driving mobility data, and booking date
summary(lm(data = full_bts %>%
             filter(release_date >= as.Date("2019-01-01"),
                    pretrial_period_end_date <= as.Date("2022-04-30")) %>%
             mutate(days_released = pretrial_period_end_date - release_date), 
           recid_county_or_doj ~ days_released*avg_bts_mob + golive_flag + covid_flag + eb_flag + emerg_flag + county))
```
golive still significant (p < 0.0001) and negative (-0.0217), but effect is smaller

```{r}
mob_bts %>%
  summarise(min(date), max(date))
```
# Regressions with charge hierarchy
Add control for charge hierarchy value - new arrest, full timeline
```{r}
#Looking at only people with a pretrial period end and released pretrial, new arrest controlling for days released and golive flag, covid flag, emergency flag, and driving mobility data, and booking date
summary(lm(data = full_bts %>%
             filter(released_pretrial_count == 1,
                    pretrial_period_end_count ==1) %>%
             mutate(days_released = pretrial_period_end_date - release_date,
                    charge_hier = scale(as.numeric(if_else(booking_charge_hierarchy %in% c("1000000", "999999"), "Undefined", booking_charge_hierarchy)))), 
           recid_county_or_doj ~ days_released*avg_bts_mob + golive_flag + covid_flag + eb_flag + emerg_flag + charge_hier + county))

```
Golive is significant (p<.0001) and negative (-0.031)

Add control for charge hierarchy value - new arrest, filtered timeline
```{r}
#Looking at only people with a pretrial period end and released pretrial, new arrest controlling for days released and golive flag, covid flag, emergency flag, and driving mobility data, and booking date
summary(lm(data = full_bts %>%
             filter(released_pretrial_count == 1,
                    pretrial_period_end_count ==1) %>%
             filter(release_date >= as.Date("2019-01-01"),
                    pretrial_period_end_date <= as.Date("2022-04-30")) %>%
             mutate(days_released = pretrial_period_end_date - release_date,
                    charge_hier = scale(as.numeric(if_else(booking_charge_hierarchy %in% c("1000000", "999999"), "Undefined", booking_charge_hierarchy)))), 
           recid_county_or_doj ~ days_released*avg_bts_mob + golive_flag + covid_flag + eb_flag + emerg_flag + charge_hier + county))

```
Golive significant (p < .0001) and negative (-0.027) smaller effect than full timeline

Add control for charge hierarchy value - FTA, full timeline
```{r}
#Looking at only people with a pretrial period end and released pretrial, fta controlling for days released and golive flag, covid flag, emergency flag, and driving mobility data, and booking date
summary(lm(data = full_bts %>%
             filter(released_pretrial_count == 1,
                    pretrial_period_end_count ==1) %>%
             mutate(days_released = pretrial_period_end_date - release_date,
                    charge_hier = scale(as.numeric(if_else(booking_charge_hierarchy %in% c("1000000", "999999"), "Undefined", booking_charge_hierarchy)))), 
           fta_flag ~ days_released*avg_bts_mob + golive_flag + covid_flag + eb_flag + emerg_flag + charge_hier + county))
```
Golive is not significant (p = 0.56) and positive (0.0023)

Add control for charge hierarchy value - FTA, filtered timeline
```{r}
#Looking at only people with a pretrial period end, fta controlling for days released and golive flag, covid flag, emergency flag, and driving mobility data, and booking date
summary(lm(data = full_bts %>%
             filter(released_pretrial_count == 1,
                    pretrial_period_end_count ==1) %>%
             filter(release_date >= as.Date("2019-01-01"),
                    pretrial_period_end_date <= as.Date("2022-04-30")) %>%
             mutate(days_released = pretrial_period_end_date - release_date,
                    charge_hier = scale(as.numeric(if_else(booking_charge_hierarchy %in% c("1000000", "999999"), "Undefined", booking_charge_hierarchy)))), 
           fta_flag ~ days_released*avg_bts_mob + golive_flag + covid_flag + eb_flag + emerg_flag + charge_hier + county))
```
Golive not significant (p = 0.62) and negative (-0.002)
# Regression on release rate - MONTHLY
Create bpr with monthly release rate
```{r}
full_df %>%
             group_by(year(booking_date), month(booking_date), county) %>%
             mutate(elg_book_count = sum(release_eligible_count)) %>%
             group_by(year(release_date), month(release_date), county) %>%
             mutate(pret_release_count = sum(released_pretrial_count)) %>%
             pivot_longer(cols = c("booking_date", "release_date"), names_to = "date_type", values_to = "date") %>%
             group_by(year = year(date), month = month(date), county) %>%
             summarise(elg_book_count = max(elg_book_count, na.rm = T), pret_release_count = max(pret_release_count, na.rm = T))

bookings <- full_df %>%
              mutate(er4_flag = if_else(booking_date >= as.Date("2020-4-13") & booking_date <= as.Date("2020-6-20"), 1, 0),
                     covid_flag = if_else(booking_date >= as.Date("2020-3-1"), 1, 0)) %>%
              group_by(year = year(booking_date), month = month(booking_date), county) %>%
              summarise(elg_book_count = sum(release_eligible_count),
                        avg_mob = mean(mob_pop, na.rm = T),
                        eb_flag = mean(eb_flag),
                        golive_flag = mean(golive_flag),
                        er4_flag = mean(er4_flag),
                        covid_flag = mean(covid_flag))


pret_releases <- full_df %>%
                    group_by(year = year(release_date), month = month(release_date), county) %>%
                    summarise(pret_release_count = sum(released_pretrial_count))

bpr <- bookings %>%
  left_join(pret_releases) %>%
  mutate(date = as.Date(str_c(year, "-", month, "-1")))

bpr <- bpr %>%
  filter(date >= as.Date("2018-7-1")) %>%
  ungroup() %>%
  select(-year, -month)


bpr <- bpr %>%
  filter(date >= as.Date("2019-1-1"),
         date < as.Date("2022-1-1"))

bpr <- bpr %>%
  mutate(rel_rate = pret_release_count/elg_book_count)

bpr_long <- bpr %>%
  pivot_longer(cols = c("elg_book_count", "pret_release_count"), names_to = "measure", values_to = "count") 


bpr_long %>%
  ggplot() +
    geom_line(aes(x = date, y = count, color = measure)) +
    facet_wrap("county", scales = "free")


```


```{r}
lapply(countylist,
       function(i){
         # bookings and releases by month
        bpr_long %>%
          filter(county == i) %>%
          ggplot() +
            geom_line(aes(x = date, y = count, color = measure)) +
            geom_vline(data = prog_date  %>% filter(county == i), aes(xintercept = golive_date), color = "green") +
            geom_vline(xintercept = as.Date("2020-3-1"), color = "orange") +
            geom_rect(data = prog_date %>% filter(county == i), aes(xmin = eb_start_date, xmax = eb_end_date, ymin = 0, ymax = Inf), fill = "red", alpha = 0.2) +
            annotate("rect", xmin=as.Date("2020-4-13"), xmax=as.Date("2020-6-20"), ymin=0, ymax=Inf, alpha=0.2, fill="red") +
            ggtitle(i)
        
       })

```

```{r}
lapply(countylist,
       function(i){
         # bookings and releases by month
        bpr %>%
          filter(county == i) %>%
          ggplot() +
            geom_line(aes(x = date, y = rel_rate)) +
            geom_vline(data = prog_date  %>% filter(county == i), aes(xintercept = golive_date), color = "green") +
            geom_vline(xintercept = as.Date("2020-3-1"), color = "orange") +
            geom_rect(data = prog_date %>% filter(county == i), aes(xmin = eb_start_date, xmax = eb_end_date, ymin = 0, ymax = Inf), fill = "red", alpha = 0.2) +
            annotate("rect", xmin=as.Date("2020-4-13"), xmax=as.Date("2020-6-20"), ymin=0, ymax=Inf, alpha=0.2, fill="red") +
            ggtitle(i)
        
       })
```




```{r}
summary(lm(data = bpr %>%
                    filter(rel_rate != Inf), 
           rel_rate ~ avg_mob + golive_flag + covid_flag + eb_flag + er4_flag + county)) 

```
```{r}
test_date = as.Date("2023-9-2")

month(test_date)
week(test_date)
```
# Regression on release rate - WEEKLY

Create bpr with weekly release rate
```{r}

bookings_w <- full_bts %>%
              mutate(er4_flag = if_else(booking_date >= as.Date("2020-4-13") & booking_date <= as.Date("2020-6-20"), 1, 0),
                     covid_flag = if_else(booking_date >= as.Date("2020-3-1"), 1, 0),
                     charge_hier = scale(as.numeric(if_else(booking_charge_hierarchy %in% c("1000000", "999999"), "Undefined", booking_charge_hierarchy)))) %>%
              mutate(datew = floor_date(booking_date, unit = "week")) %>%
              group_by(datew, county) %>%
              summarise(elg_book_count = sum(release_eligible_count),
                        avg_mob = mean(mob_pop, na.rm = T),
                        eb_flag = mean(eb_flag),
                        golive_flag = mean(golive_flag),
                        er4_flag = mean(er4_flag),
                        covid_flag = mean(covid_flag),
                        charge_hier = mean(charge_hier, na.rm = T))


pret_releases_w <- full_df %>%
                    mutate(datew = floor_date(release_date, unit = "week")) %>%
                    group_by(datew, county) %>%
                    summarise(pret_release_count = sum(released_pretrial_count))

bprw <- bookings_w %>%
  left_join(pret_releases_w) 


bprw <- bprw %>%
  ungroup() %>%
  filter(datew >= as.Date("2019-1-1"),
         datew < as.Date("2022-1-1"))

bprw <- bprw %>%
  mutate(rel_rate = pret_release_count/elg_book_count)


```

Create bpr with weekly release rate - Felony only
```{r}

bookings_wf <- full_bts %>%
              filter(charge_level == "F") %>%
              mutate(er4_flag = if_else(booking_date >= as.Date("2020-4-13") & booking_date <= as.Date("2020-6-20"), 1, 0),
                     covid_flag = if_else(booking_date >= as.Date("2020-3-1"), 1, 0),
                     charge_hier = scale(as.numeric(if_else(booking_charge_hierarchy %in% c("1000000", "999999"), "Undefined", booking_charge_hierarchy)))) %>%
              mutate(datew = floor_date(booking_date, unit = "week")) %>%
              group_by(datew, county) %>%
              summarise(elg_book_count = sum(release_eligible_count),
                        avg_mob = mean(mob_pop, na.rm = T),
                        eb_flag = mean(eb_flag),
                        golive_flag = mean(golive_flag),
                        er4_flag = mean(er4_flag),
                        covid_flag = mean(covid_flag),
                        charge_hier = mean(charge_hier, na.rm = T))


pret_releases_wf <- full_df %>%
                    filter(charge_level == "F") %>%
                    mutate(datew = floor_date(release_date, unit = "week")) %>%
                    group_by(datew, county) %>%
                    summarise(pret_release_count = sum(released_pretrial_count))

bprwf <- bookings_wf %>%
  left_join(pret_releases_wf) 


bprwf <- bprwf %>%
  ungroup() %>%
  filter(datew >= as.Date("2019-1-1"),
         datew < as.Date("2022-1-1"))

bprwf <- bprwf %>%
  mutate(rel_rate = pret_release_count/elg_book_count)


```

Create bpr with weekly release rate - Misdos only
```{r}

bookings_wm <- full_bts %>%
              filter(charge_level == "M") %>%
              mutate(er4_flag = if_else(booking_date >= as.Date("2020-4-13") & booking_date <= as.Date("2020-6-20"), 1, 0),
                     covid_flag = if_else(booking_date >= as.Date("2020-3-1"), 1, 0),
                     charge_hier = scale(as.numeric(if_else(booking_charge_hierarchy %in% c("1000000", "999999"), "Undefined", booking_charge_hierarchy)))) %>%
              mutate(datew = floor_date(booking_date, unit = "week")) %>%
              group_by(datew, county) %>%
              summarise(elg_book_count = sum(release_eligible_count),
                        avg_mob = mean(mob_pop, na.rm = T),
                        eb_flag = mean(eb_flag),
                        golive_flag = mean(golive_flag),
                        er4_flag = mean(er4_flag),
                        covid_flag = mean(covid_flag),
                        charge_hier = mean(charge_hier, na.rm = T))


pret_releases_wm <- full_df %>%
                    filter(charge_level == "M") %>%
                    mutate(datew = floor_date(release_date, unit = "week")) %>%
                    group_by(datew, county) %>%
                    summarise(pret_release_count = sum(released_pretrial_count))

bprwm <- bookings_wm %>%
  left_join(pret_releases_wm) 


bprwm <- bprwm %>%
  ungroup() %>%
  filter(datew >= as.Date("2019-1-1"),
         datew < as.Date("2022-1-1"))

bprwm <- bprwm %>%
  mutate(rel_rate = pret_release_count/elg_book_count)


```
Weekly
```{r}
summary(lm(data = bprw %>%
                    filter(rel_rate != Inf) , 
           rel_rate ~ avg_mob + golive_flag + covid_flag + eb_flag + er4_flag + charge_hier + county)) 


```
Golive not significant


Weekly - Felonies
```{r}
summary(lm(data = bprwf %>%
                    filter(rel_rate != Inf) , 
           rel_rate ~ avg_mob + golive_flag + covid_flag + eb_flag + er4_flag + charge_hier + county)) 

```
Golive not significant


Weekly - Misdos
```{r}
summary(lm(data = bprwm %>%
                    filter(rel_rate != Inf) , 
           rel_rate ~ avg_mob + golive_flag + covid_flag + eb_flag + er4_flag + charge_hier + county)) 

```
Golive marginal (p = 0.092) and negative (-0.017)


```{r}
full_df %>%
  count(booking_charge_hierarchy) %>%
  arrange(desc(as.numeric(booking_charge_hierarchy)))
  select(contains("hier"))
  
full_df %>%
  filter(booking_charge_hierarchy == "1000000")
```

```{r}
summary(lm(data = bprw %>%
                    filter(county %in% c("Alameda", "Los Angeles", "Napa", "Sacramento", "San Joaquin", "San Mateo", "Santa Barbara", "Sonoma", "Tulare", "Ventura")) %>%
                    filter(rel_rate != Inf), 
           rel_rate ~ avg_mob + golive_flag + covid_flag + eb_flag + er4_flag + charge_hier + county)) 
```
Golive not significant 
# Regression on release/not-released at individual level (would need more controls)
```{r}
summary(lm(data = full_bts %>%
             filter(pretrial_period_end_count ==1) %>%
             # filter(release_date >= as.Date("2019-01-01"),
             #        pretrial_period_end_date <= as.Date("2022-04-30")) %>%
             mutate(days_released = pretrial_period_end_date - release_date,
                    charge_hier = scale(as.numeric(if_else(booking_charge_hierarchy %in% c("1000000", "999999"), "Undefined", booking_charge_hierarchy)))), 
           released_pretrial_count ~ days_released*avg_bts_mob + golive_flag + covid_flag + eb_flag + emerg_flag + charge_hier + county))
```

# Graphs with BTS data
```{r}
full_df <- full_df %>%
  left_join(mob_bts, by = c("booking_date" = "date", "county")) 


countylist <- full_df %>% distinct(county) %>% pull(county)
```

Timeline with bookings, release eligible, pretrial releases, mobility, and key dates
```{r}
lapply(countylist,
       function(i){
         # bookings and releases by month
        full_df %>%
          filter(county == i) %>%
           filter(booking_date >= as.Date("2019-1-1"),
                  booking_date < as.Date("2023-1-1")) %>%
          group_by(year = year(booking_date), month = month(booking_date)) %>%
          summarise(bookings = n(),
                    release_eligible = sum(release_eligible_count),
                    pretrial_releases = sum(released_pretrial_count),
                    mobility = 100*mean(mob_pop),
                    golive_date = mean(golive_date),
                    eb_start_date = mean(eb_start_date),
                    eb_end_date = mean(eb_end_date)) %>%
          mutate(book_date = as.Date(str_c(year, "-", month, "-1")),
                 bookings = bookings/first(bookings),
                 release_eligible = release_eligible/first(release_eligible),
                 pretrial_releases = pretrial_releases/first(pretrial_releases),
                 mobility = mobility/first(mobility)) %>%
          ungroup() %>%
          select(book_date, bookings, release_eligible, pretrial_releases, 
                 mobility, golive_date, eb_start_date, eb_end_date) %>%
          pivot_longer(cols = c(bookings, release_eligible, pretrial_releases, mobility)) %>%
          ggplot() +
            geom_line(aes(x = book_date, y = value, color = name)) +
            geom_vline(data = prog_date  %>% filter(county == i), aes(xintercept = golive_date), color = "green") +
            geom_vline(xintercept = as.Date("2020-3-1"), color = "orange") +
            geom_rect(data = prog_date %>% filter(county == i), aes(xmin = eb_start_date, xmax = eb_end_date, ymin = 0, ymax = Inf), fill = "red", alpha = 0.2) +
            annotate("rect", xmin=as.Date("2020-4-13"), xmax=as.Date("2020-6-20"), ymin=0, ymax=Inf, alpha=0.2, fill="red") +
            ggtitle(i)
        
       })

```

```{r}
lapply(countylist,
       function(i){
         # bookings and releases by month
        full_bts %>%
          filter(county == i) %>%
           mutate(charge_hier = scale(as.numeric(if_else(booking_charge_hierarchy %in% c("1000000", "999999"), "Undefined", booking_charge_hierarchy)))) %>%
           filter(booking_date >= as.Date("2019-1-1"),
                  booking_date < as.Date("2023-1-1")) %>%
          group_by(year = year(booking_date), month = month(booking_date)) %>%
          summarise(bookings = n(),
                    release_eligible = sum(release_eligible_count),
                    pretrial_releases = sum(released_pretrial_count),
                    mobility = 100*mean(mob_pop),
                    golive_date = mean(golive_date),
                    eb_start_date = mean(eb_start_date),
                    eb_end_date = mean(eb_end_date),
                    charge_hier = mean(charge_hier, na.rm = T)) %>%
          mutate(rel_rate = pretrial_releases/release_eligible) %>%
          mutate(book_date = as.Date(str_c(year, "-", month, "-1")),
                 bookings = bookings/first(bookings),
                 release_eligible = release_eligible/first(release_eligible),
                 pretrial_releases = pretrial_releases/first(pretrial_releases),
                 rel_rate = rel_rate/first(rel_rate),
                 mobility = mobility/first(mobility),
                 charge_hier = charge_hier/first(charge_hier)) %>%
          ungroup() %>%
          select(book_date, bookings, rel_rate, 
                 mobility, charge_hier, golive_date, eb_start_date, eb_end_date) %>%
          pivot_longer(cols = c(bookings, rel_rate, mobility, charge_hier)) %>%
          ggplot() +
            geom_line(aes(x = book_date, y = value, color = name)) +
            geom_vline(data = prog_date  %>% filter(county == i), aes(xintercept = golive_date), color = "green") +
            geom_vline(xintercept = as.Date("2020-3-1"), color = "orange") +
            geom_rect(data = prog_date %>% filter(county == i), aes(xmin = eb_start_date, xmax = eb_end_date, ymin = 0, ymax = Inf), fill = "red", alpha = 0.2) +
            annotate("rect", xmin=as.Date("2020-4-13"), xmax=as.Date("2020-6-20"), ymin=0, ymax=Inf, alpha=0.2, fill="red") +
            ggtitle(i)
        
       })

```
Felonies only
```{r}
lapply(countylist,
       function(i){
         # bookings and releases by month
        full_df %>%
          filter(county == i,
                 charge_level == "F") %>%
           filter(booking_date >= as.Date("2019-1-1"),
                  booking_date < as.Date("2023-1-1")) %>%
          group_by(book_date = floor_date(booking_date, unit = "month")) %>%
          summarise(bookings = n(),
                    release_eligible = sum(release_eligible_count),
                    pretrial_releases = sum(released_pretrial_count),
                    mobility = 100*mean(mob_pop),
                    golive_date = mean(golive_date),
                    eb_start_date = mean(eb_start_date),
                    eb_end_date = mean(eb_end_date)) %>%
          mutate(rel_rate = pretrial_releases/release_eligible) %>%
          mutate(bookings = bookings/first(bookings),
                 release_eligible = release_eligible/first(release_eligible),
                 pretrial_releases = pretrial_releases/first(pretrial_releases),
                 rel_rate = rel_rate/first(rel_rate),
                 mobility = mobility/first(mobility)) %>%
          ungroup() %>%
          select(book_date, bookings, rel_rate, 
                 mobility, golive_date, eb_start_date, eb_end_date) %>%
          pivot_longer(cols = c(bookings, rel_rate, mobility)) %>%
          ggplot() +
            geom_line(aes(x = book_date, y = value, color = name)) +
            geom_vline(data = prog_date  %>% filter(county == i), aes(xintercept = golive_date), color = "green") +
            geom_vline(xintercept = as.Date("2020-3-1"), color = "orange") +
            geom_rect(data = prog_date %>% filter(county == i), aes(xmin = eb_start_date, xmax = eb_end_date, ymin = 0, ymax = Inf), fill = "red", alpha = 0.2) +
            annotate("rect", xmin=as.Date("2020-4-13"), xmax=as.Date("2020-6-20"), ymin=0, ymax=Inf, alpha=0.2, fill="red") +
            ggtitle(str_c(i, " - Felonies"))
        
       })

```
Misdos only
```{r}
lapply(countylist,
       function(i){
         # bookings and releases by month
        full_df %>%
          filter(county == i,
                 charge_level == "M") %>%
           filter(booking_date >= as.Date("2019-1-1"),
                  booking_date < as.Date("2023-1-1")) %>%
          group_by(book_date = floor_date(booking_date, unit = "month")) %>%
          summarise(bookings = n(),
                    release_eligible = sum(release_eligible_count),
                    pretrial_releases = sum(released_pretrial_count),
                    mobility = 100*mean(mob_pop),
                    golive_date = mean(golive_date),
                    eb_start_date = mean(eb_start_date),
                    eb_end_date = mean(eb_end_date)) %>%
          mutate(rel_rate = pretrial_releases/release_eligible) %>%
          mutate(bookings = bookings/first(bookings),
                 release_eligible = release_eligible/first(release_eligible),
                 pretrial_releases = pretrial_releases/first(pretrial_releases),
                 rel_rate = rel_rate/first(rel_rate),
                 mobility = mobility/first(mobility)) %>%
          ungroup() %>%
          select(book_date, bookings, rel_rate, 
                 mobility, golive_date, eb_start_date, eb_end_date) %>%
          pivot_longer(cols = c(bookings, rel_rate, mobility)) %>%
          ggplot() +
            geom_line(aes(x = book_date, y = value, color = name)) +
            geom_vline(data = prog_date  %>% filter(county == i), aes(xintercept = golive_date), color = "green") +
            geom_vline(xintercept = as.Date("2020-3-1"), color = "orange") +
            geom_rect(data = prog_date %>% filter(county == i), aes(xmin = eb_start_date, xmax = eb_end_date, ymin = 0, ymax = Inf), fill = "red", alpha = 0.2) +
            annotate("rect", xmin=as.Date("2020-4-13"), xmax=as.Date("2020-6-20"), ymin=0, ymax=Inf, alpha=0.2, fill="red") +
            ggtitle(str_c(i, " - Misdemeanors"))
        
       })

```


```{r}
# full_df %>%
#   filter(booking_date >= as.Date("2018-7-1"),
#          booking_date < as.Date("2023-1-1")) %>%
#   group_by(county, month = month(book_date), year = year(book_date)) %>%
#   summarise(bookings = n(), releases = sum(released_pretrial_count),
#             golive_date = mean(golive_date),
#             eb_start_date = mean(eb_start_date),
#             eb_end_date = mean(eb_end_date)) %>%
#   ungroup() %>%
#   mutate(book_date = as.Date(str_c(year, "-", month, "-1"))) %>%
#   ggplot() +
#     geom_line(aes(x = book_date, y = bookings)) +
#     geom_vline(data = prog_date, aes(xintercept = golive_date), color = "green") +
#     geom_vline(xintercept = as.Date("2020-3-1"), color = "orange") +
#     geom_rect(data = prog_date, aes(xmin = eb_start_date, xmax = eb_end_date, ymin = 0, ymax = Inf), fill = "red", alpha = 0.2) +
#     annotate("rect", xmin=as.Date("2020-4-13"), xmax=as.Date("2020-6-20"), ymin=0, ymax=Inf, alpha=0.2, fill="red") +
#     facet_grid(rows = vars(county), scales = "free")

#ggsave("bookings with key local dates by county.png", width = 7, height = 16)
```

Statewide mobility over time
```{r}
full_df %>%
  filter(booking_date >= as.Date("2019-1-1"),
         booking_date < as.Date("2022-1-1")) %>%
  group_by(book_date = floor_date(booking_date, unit = "week")) %>%
  summarise(bookings = n(), releases = sum(released_pretrial_count),
            avg_mob = mean(mob_pop, na.rm = T)) %>%
  ungroup() %>%
  ggplot() +
    geom_line(aes(x = book_date, y = avg_mob)) +
    geom_vline(xintercept = as.Date("2020-3-1"), color = "orange") +
    annotate("rect", xmin=as.Date("2020-4-13"), xmax=as.Date("2020-6-20"), ymin=0, ymax=Inf, alpha=0.2, fill="red")
```

Statewide bookings and pretrial releases over time
```{r}
full_df %>%
  filter(booking_date >= as.Date("2018-7-1"),
         booking_date < as.Date("2022-1-1")) %>%
  group_by(book_date = floor_date(booking_date, unit = "week")) %>%
  summarise(bookings = n(), releases = sum(released_pretrial_count),
            avg_mob = mean(mob_pop, na.rm = T)) %>%
  ungroup() %>%
  pivot_longer(cols = c("bookings", "releases")) %>%
  ggplot() +
    geom_line(aes(x = book_date, y = value, color = name)) +
    geom_vline(xintercept = as.Date("2020-3-1"), color = "orange") +
    annotate("rect", xmin=as.Date("2020-4-13"), xmax=as.Date("2020-6-20"), ymin=0, ymax=Inf, alpha=0.2, fill="red")
```

Statewide charge severity by misdo/fel over time
```{r}
#misdo only
full_df %>%
    mutate(charge_hier = scale(as.numeric(if_else(booking_charge_hierarchy %in% c("1000000", "999999"), "Undefined", booking_charge_hierarchy))),
         charge_hier2 = as.numeric(if_else(booking_charge_hierarchy %in% c("1000000", "999999"), "Undefined", booking_charge_hierarchy))) %>%
  filter(booking_date >= as.Date("2018-7-1"),
         booking_date < as.Date("2022-1-1"),
         charge_level %in% c("M")) %>%
  group_by(book_date = floor_date(booking_date, unit = "week"), charge_level) %>%
  summarise(avg_hier = mean(charge_hier2, na.rm = T)) %>%
  ungroup() %>%
  ggplot() +
    geom_line(aes(x = book_date, y = avg_hier, color = charge_level)) +
    geom_vline(xintercept = as.Date("2020-3-1"), color = "orange") +
    annotate("rect", xmin=as.Date("2020-4-13"), xmax=as.Date("2020-6-20"), ymin=-Inf, ymax=Inf, alpha=0.2, fill="red")

#fel only
full_df %>%
    mutate(charge_hier = scale(as.numeric(if_else(booking_charge_hierarchy %in% c("1000000", "999999"), "Undefined", booking_charge_hierarchy))),
         charge_hier2 = as.numeric(if_else(booking_charge_hierarchy %in% c("1000000", "999999"), "Undefined", booking_charge_hierarchy))) %>%
  filter(booking_date >= as.Date("2018-7-1"),
         booking_date < as.Date("2022-1-1"),
         charge_level %in% c("F")) %>%
  group_by(book_date = floor_date(booking_date, unit = "week"), charge_level) %>%
  summarise(avg_hier = mean(charge_hier2, na.rm = T)) %>%
  ungroup() %>%
  ggplot() +
    geom_line(aes(x = book_date, y = avg_hier, color = charge_level)) +
    geom_vline(xintercept = as.Date("2020-3-1"), color = "orange") +
    annotate("rect", xmin=as.Date("2020-4-13"), xmax=as.Date("2020-6-20"), ymin=-Inf, ymax=Inf, alpha=0.2, fill="red")

#both, unscaled
full_df %>%
  filter(booking_date >= as.Date("2018-7-1"),
         booking_date < as.Date("2022-1-1"),
         charge_level %in% c("M", "F")) %>%
  mutate(charge_hier = scale(as.numeric(if_else(booking_charge_hierarchy %in% c("1000000", "999999"), "Undefined", booking_charge_hierarchy))),
         charge_hier2 = as.numeric(if_else(booking_charge_hierarchy %in% c("1000000", "999999"), "Undefined", booking_charge_hierarchy))) %>%
  group_by(book_date = floor_date(booking_date, unit = "week"), charge_level) %>%
  summarise(avg_hier = mean(charge_hier2, na.rm = T)) %>%
  ungroup() %>%
  ggplot() +
    geom_line(aes(x = book_date, y = avg_hier, color = charge_level)) +
    geom_vline(xintercept = as.Date("2020-3-1"), color = "orange") +
    annotate("rect", xmin=as.Date("2020-4-13"), xmax=as.Date("2020-6-20"), ymin=-Inf, ymax=Inf, alpha=0.2, fill="red")

```

Statewide relative bookings, releases, mobility by week - Felonies
```{r}
 full_df %>%
           filter(charge_level == "F") %>%
           filter(booking_date >= as.Date("2019-1-1"),
                  booking_date < as.Date("2023-1-1")) %>%
          group_by(book_date = floor_date(booking_date, unit = "week")) %>%
          summarise(bookings = n(),
                    release_eligible = sum(release_eligible_count),
                    pretrial_releases = sum(released_pretrial_count),
                    mobility = 100*mean(mob_pop, na.rm = T)) %>%
          mutate(rel_rate = pretrial_releases/release_eligible) %>%
          mutate(bookings = bookings/first(bookings),
                 release_eligible = release_eligible/first(release_eligible),
                 pretrial_releases = pretrial_releases/first(pretrial_releases),
                 rel_rate = rel_rate/first(rel_rate),
                 mobility = mobility/first(mobility)) %>%
          ungroup() %>%
          select(book_date, bookings, rel_rate, mobility) %>%
          pivot_longer(cols = c(bookings, rel_rate, mobility)) %>%
          ggplot() +
            geom_line(aes(x = book_date, y = value, color = name)) +
            geom_vline(xintercept = as.Date("2020-3-1"), color = "orange") +
            annotate("rect", xmin=as.Date("2020-4-13"), xmax=as.Date("2020-6-20"), ymin=0, ymax=Inf, alpha=0.2, fill="red") +
            ggtitle("Statewide - Felonies")
```


Statewide relative bookings, releases, mobility by week - Misdos
```{r}
 full_df %>%
           filter(charge_level == "M") %>%
           filter(booking_date >= as.Date("2019-1-1"),
                  booking_date < as.Date("2023-1-1")) %>%
          group_by(book_date = floor_date(booking_date, unit = "week")) %>%
          summarise(bookings = n(),
                    release_eligible = sum(release_eligible_count),
                    pretrial_releases = sum(released_pretrial_count),
                    mobility = 100*mean(mob_pop, na.rm = T)) %>%
          mutate(rel_rate = pretrial_releases/release_eligible) %>%
          mutate(bookings = bookings/first(bookings),
                 release_eligible = release_eligible/first(release_eligible),
                 pretrial_releases = pretrial_releases/first(pretrial_releases),
                 rel_rate = rel_rate/first(rel_rate),
                 mobility = mobility/first(mobility)) %>%
          ungroup() %>%
          select(book_date, bookings, rel_rate, mobility) %>%
          pivot_longer(cols = c(bookings, rel_rate, mobility)) %>%
          ggplot() +
            geom_line(aes(x = book_date, y = value, color = name)) +
            geom_vline(xintercept = as.Date("2020-3-1"), color = "orange") +
            annotate("rect", xmin=as.Date("2020-4-13"), xmax=as.Date("2020-6-20"), ymin=0, ymax=Inf, alpha=0.2, fill="red") +
            ggtitle("Statewide - Misdemeanors")


```

# Court date reminders
```{r}
full_df %>%
  group_by(county) %>%
  count(court_date_reminder_flag) %>%
  mutate(perc = round(100*n/sum(n), 1), N = sum(n)) %>%
  filter(court_date_reminder_flag == 1 | perc == 100) %>%
  mutate(perc = if_else(court_date_reminder_flag == 0 & perc == 100, 0, perc)) %>%
  select(county, perc, N) %>%
    distinct()
```
By quarter
```{r}
quarter(
  as.Date("2020-12-1"),
  type = "date_first",
  fiscal_start = 7
)

qdf <- full_df %>%
  mutate(qdate = quarter(booking_date, type = "date_first", fiscal_start = 7)) %>%
  group_by(county, qdate) %>%
  count(court_date_reminder_flag) %>%
  mutate(perc = round(100*n/sum(n), 1), N = sum(n)) %>%
  filter(court_date_reminder_flag == 1 & n > 10) %>%
  mutate(perc = if_else(court_date_reminder_flag == 0 & perc == 100, 0, perc)) %>%
  select(county, perc, N) %>%
    distinct()

#write.csv(qdf, file = "quarterly court date reminder percent of all bookings by county.csv")
```

Only matched bookings
```{r}
full_df %>%
  filter(is_unmatched_booking == "No") %>%
  group_by(county) %>%
  count(court_date_reminder_flag) %>%
  mutate(perc = round(100*n/sum(n), 1), N = sum(n)) %>%
  filter(court_date_reminder_flag == 1 | perc == 100) %>%
  mutate(perc = if_else(court_date_reminder_flag == 0 & perc == 100, 0, perc)) %>%
  select(county, perc, N) %>%
    distinct()
```
Quarterly, matched bookings
```{r}
qdf <- full_df %>%
  filter(is_unmatched_booking == "No") %>%
  mutate(qdate = quarter(booking_date, type = "date_first", fiscal_start = 7)) %>%
  group_by(county, qdate) %>%
  count(court_date_reminder_flag) %>%
  mutate(perc = round(100*n/sum(n), 1), N = sum(n)) %>%
  filter(court_date_reminder_flag == 1 & n > 10) %>%
  mutate(perc = if_else(court_date_reminder_flag == 0 & perc == 100, 0, perc)) %>%
  select(county, perc, N) %>%
    distinct()

#write.csv(qdf, file = "quarterly court date reminder percent of bookings with case by county.csv")
```

Only matched booking with filing after booking
```{r}
full_df %>%
  filter(is_unmatched_booking == "No",
         case_filed_date >= booking_date) %>%
  group_by(county) %>%
  count(court_date_reminder_flag) %>%
  mutate(perc = round(100*n/sum(n), 1), N = sum(n)) %>%
  filter(court_date_reminder_flag == 1 | perc == 100) %>%
  mutate(perc = if_else(court_date_reminder_flag == 0 & perc == 100, 0, perc)) %>%
  select(county, perc, N) %>%
    distinct()

# all counties, filing on or after booking
full_df %>%
  filter(is_unmatched_booking == "No",
         case_filed_date >= booking_date) %>%
  count(court_date_reminder_flag) %>%
  mutate(perc = round(100*n/sum(n), 1), N = sum(n))
```


```{r}
# all counties, all bookings with cases, diminished timeline
full_df %>%
  filter(is_unmatched_booking == "No",
         golive_flag == 1) %>%
  count(court_date_reminder_flag) %>%
  mutate(perc = round(100*n/sum(n), 1), N = m(n))

full_df %>%
  select(golive_flag)

full_df %>%
  group_by(county) %>%
  summarise(max(booking_date))
```


```{r}
full_df %>%
  filter(is_unmatched_booking == "No") %>%
  group_by(county) %>%
  count(court_date_reminder_flag) %>%
  mutate(perc = round(100*n/sum(n), 1), N = sum(n)) %>%
  filter(court_date_reminder_flag == 1 | perc == 100) %>%
  mutate(perc = if_else(court_date_reminder_flag == 0 & perc == 100, 0, perc)) %>%
  select(county, perc, N) %>%
    distinct() %>%
  ungroup() %>%
  summarise(tot = sum(N), reminders = sum(N*perc/100))

```

# Look at release types (LA removed temporarily until release type OR fixed)


Pretrial released or not
```{r}
#Stacked
full_df %>%
  filter(booking_date >= as.Date("2018-7-1")) %>%
  filter(is_release_eligible == "Yes") %>%
  filter(county != "Los Angeles") %>%
  filter(charge_level %in% c("M", "F")) %>%
  mutate(rel_cat = case_when(is_released_pretrial == "No" ~ "Not released pretrial", 
                             is_released_pretrial == "Yes" ~ "Released pretrial",
                             T ~ "Other")) %>%
  mutate(rel_cat = factor(rel_cat, ordered = T, level = c("Not released pretrial", "Released pretrial", "Other"))) %>%
  group_by(book_month = floor_date(booking_date, unit = "month"), rel_cat, charge_level) %>%
  summarise(n = n()) %>%
  group_by(book_month, charge_level) %>%
  mutate(tot = sum(n), perc = n/tot) %>%
  ggplot(aes(fill = fct_rev(rel_cat), y = perc, x = book_month)) +
  geom_bar(position = "stack", stat = "identity") +
  scale_fill_manual(values=c("#68023F", "#008169", "#EF0096", "#00DCB5", "#FFCFE2", "#003C86", "#9400E6", "#009FFA",
                             "#FF71FD", "#7CFFFA", "#3D3C04", "#008607", "#F60239", "#00E307", "#FFDC3D"))+
  facet_grid(cols = vars(charge_level))

#Faceted
full_df %>%
  filter(booking_date >= as.Date("2018-7-1")) %>%
  filter(is_release_eligible == "Yes") %>%
  filter(county != "Los Angeles") %>%
  filter(charge_level %in% c("M", "F")) %>%
  mutate(rel_cat = case_when(is_released_pretrial == "No" ~ "Not released pretrial", 
                             is_released_pretrial == "Yes" ~ "Released pretrial",
                             T ~ "Other")) %>%
  mutate(rel_cat = factor(rel_cat, ordered = T, level = c("Not released pretrial", "Released pretrial", "Other"))) %>%
  group_by(book_month = floor_date(booking_date, unit = "month"), rel_cat, charge_level) %>%
  summarise(n = n()) %>%
  group_by(book_month, charge_level) %>%
  mutate(tot = sum(n), perc = n/tot) %>%
  ggplot(aes(y = perc, x = book_month)) +
  geom_bar(position = "stack", stat = "identity") +
  ylim(0,1) +
  facet_grid(cols = vars(rel_cat), rows = vars(charge_level))
  
```
Release types out of people pretrial released
```{r}
#Stacked
full_df %>%
  filter(booking_date >= as.Date("2018-7-1")) %>%
  filter(is_release_eligible == "Yes") %>%
  filter(county != "Los Angeles") %>%
  filter(charge_level %in% c("M", "F")) %>%
  filter(is_released_pretrial == "Yes") %>%
  mutate(rel_cat = case_when(release_type == "Bail Bond" ~ "Bail",
                             release_type %in% c("Cite Release", "CiteR elease") ~ "Cite Release",
                             release_type %in% c("Own Recognizance") ~ "OR",
                             release_type %in% c("Pretrial Monitor") ~ "Monitor",
                             release_type %in% c("Zero Bail") ~ "Zero Bail",
                             T ~ "Other")) %>%
   mutate(rel_cat = factor(rel_cat, ordered = T, level = c("Cite Release", "Zero Bail",
                                                             "Bail", "OR", "Monitor", "Other"))) %>%
  group_by(book_month = floor_date(booking_date, unit = "month"), rel_cat, charge_level) %>%
  summarise(n = n()) %>%
  group_by(book_month, charge_level) %>%
  mutate(tot = sum(n), perc = n/tot) %>%
  ggplot(aes(fill = fct_rev(rel_cat), y = perc, x = book_month)) +
  geom_bar(position = "stack", stat = "identity") +
  scale_fill_manual(values=c("#68023F", "#008169", "#EF0096", "#00DCB5", "#FFCFE2", "#003C86", "#9400E6", "#009FFA",
                             "#FF71FD", "#7CFFFA", "#3D3C04", "#008607", "#F60239", "#00E307", "#FFDC3D")) +
  facet_grid(cols = vars(charge_level))

#Faceted
full_df %>%
  filter(booking_date >= as.Date("2018-7-1")) %>%
  filter(is_release_eligible == "Yes") %>%
  filter(county != "Los Angeles") %>%
  filter(charge_level %in% c("M", "F")) %>%
  filter(is_released_pretrial == "Yes") %>%
  mutate(rel_cat = case_when(release_type == "Bail Bond" ~ "Bail",
                             release_type %in% c("Cite Release", "CiteR elease") ~ "Cite Release",
                             release_type %in% c("Own Recognizance") ~ "OR",
                             release_type %in% c("Pretrial Monitor") ~ "Monitor",
                             release_type %in% c("Zero Bail") ~ "Zero Bail",
                             T ~ "Other")) %>%
   mutate(rel_cat = factor(rel_cat, ordered = T, level = c("Cite Release", "Zero Bail",
                                                             "Bail", "OR", "Monitor", "Other"))) %>%
  group_by(book_month = floor_date(booking_date, unit = "month"), rel_cat, charge_level) %>%
  summarise(n = n()) %>%
  group_by(book_month, charge_level) %>%
  mutate(tot = sum(n), perc = n/tot) %>%
  ggplot(aes(y = perc, x = book_month)) +
  geom_bar(position = "stack", stat = "identity") +
  ylim(0,1)+
  facet_grid(cols = vars(rel_cat), rows = vars(charge_level))
```

Time to dispo for people with disposed cases who were not released pretrial
```{r}
#Stacked
full_df %>%
  filter(booking_date >= as.Date("2018-7-1")) %>%
  filter(pretrial_period_end_count == 1) %>%
  filter(is_release_eligible == "Yes") %>%
  filter(charge_level %in% c("M", "F")) %>%
  filter(pretrial_period_end_date >= booking_date) %>%
  filter(is_released_pretrial == "No") %>%
  filter(county != "Los Angeles") %>%
  mutate(rel_cat = case_when(pretrial_period_end_date - booking_date <=2 ~ "Disposed within 2 days",
                             pretrial_period_end_date - booking_date <=30 ~ "Disposed 3-30 days",
                             pretrial_period_end_date - booking_date <=120 ~ "Disposed 31-120 days",
                             pretrial_period_end_date - booking_date <=365 ~ "Disposed 121-365 days",
                             T ~ "Disposed > 365 days")) %>%
  mutate(rel_cat = factor(rel_cat, ordered = T, level = c("Disposed within 2 days", "Disposed 3-30 days", 
                                                          "Disposed 31-120 days", 
                                                          "Disposed 121-365 days",
                                                          "Disposed > 365 days"))) %>%
  #filter(rel_cat != "Other") %>%
  group_by(book_month = floor_date(booking_date, unit = "month"), rel_cat, charge_level) %>%
  summarise(n = n()) %>%
  group_by(book_month, charge_level) %>%
  mutate(tot = sum(n), perc = n/tot) %>%
  ggplot(aes(fill = fct_rev(rel_cat), y = perc, x = book_month)) +
  geom_bar(position = "stack", stat = "identity") +
  facet_grid(cols = vars(charge_level)) +
  scale_fill_manual(values=c("#68023F", "#008169", "#EF0096", "#00DCB5", "#FFCFE2", "#003C86", "#9400E6", "#009FFA",
                             "#FF71FD", "#7CFFFA", "#3D3C04", "#008607", "#F60239", "#00E307", "#FFDC3D"))

# Faceted
full_df %>%
  filter(booking_date >= as.Date("2018-7-1")) %>%
  filter(pretrial_period_end_count == 1) %>%
  filter(is_release_eligible == "Yes") %>%
  filter(charge_level %in% c("M", "F")) %>%
  filter(pretrial_period_end_date >= booking_date) %>%
  filter(is_released_pretrial == "No") %>%
  filter(county != "Los Angeles") %>%
  mutate(rel_cat = case_when(pretrial_period_end_date - booking_date <=2 ~ "Disposed within 2 days",
                             pretrial_period_end_date - booking_date <=30 ~ "Disposed 3-30 days",
                             pretrial_period_end_date - booking_date <=120 ~ "Disposed 31-120 days",
                             pretrial_period_end_date - booking_date <=365 ~ "Disposed 121-365 days",
                             T ~ "Disposed > 365 days")) %>%
  mutate(rel_cat = factor(rel_cat, ordered = T, level = c("Disposed within 2 days", "Disposed 3-30 days", 
                                                          "Disposed 31-120 days", 
                                                          "Disposed 121-365 days",
                                                          "Disposed > 365 days"))) %>%
  #filter(rel_cat != "Other") %>%
  group_by(book_month = floor_date(booking_date, unit = "month"), rel_cat, charge_level) %>%
  summarise(n = n()) %>%
  group_by(book_month, charge_level) %>%
  mutate(tot = sum(n), perc = n/tot) %>%
  ggplot(aes(y = perc, x = book_month)) +
  geom_bar(position = "dodge", stat = "identity") +
  facet_grid(rows = vars(charge_level), cols = vars(rel_cat)) +
  scale_fill_manual(values=c("#68023F", "#008169", "#EF0096", "#00DCB5", "#FFCFE2", "#003C86", "#9400E6", "#009FFA",
                             "#FF71FD", "#7CFFFA", "#3D3C04", "#008607", "#F60239", "#00E307", "#FFDC3D"))
```
# Older graphs of release types
Release types including not-released
```{r}
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

# raw numbers
full_df %>%
  filter(booking_date >= as.Date("2018-7-1")) %>%
  filter(is_release_eligible == "Yes") %>%
  filter(county != "Los Angeles") %>%
  mutate(rel_cat = case_when(is_released_pretrial == "No" ~ "Not released pretrial", 
                             release_type == "Bail Bond" ~ "Bail",
                             release_type %in% c("Cite Release", "CiteR elease") ~ "Cite Release",
                             release_type %in% c("Own Recognizance") ~ "OR",
                             release_type %in% c("Pretrial Monitor") ~ "Monitor",
                             release_type %in% c("Zero Bail") ~ "Zero Bail",
                             T ~ "Other")) %>%
  mutate(rel_cat = factor(rel_cat, ordered = T, level = c("Not released pretrial", "Cite Release", "Zero Bail",
                                                             "Bail", "OR", "Monitor", "Other"))) %>%
  #filter(rel_cat != "Other") %>%
  group_by(book_month = floor_date(booking_date, unit = "month"), rel_cat) %>%
  summarise(n = n()) %>%
  group_by(book_month) %>%
  mutate(tot = sum(n), perc = n/tot) %>%
  ggplot(aes(fill = fct_rev(rel_cat), y = n, x = book_month)) +
  geom_bar(position = "stack", stat = "identity")+
  scale_fill_manual(values=cbPalette)
```


```{r}
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
# percents
full_df %>%
  filter(booking_date >= as.Date("2018-7-1")) %>%
  filter(is_release_eligible == "Yes") %>%
  filter(county != "Los Angeles") %>%
  mutate(rel_cat = case_when(is_released_pretrial == "No" ~ "Not released pretrial", 
                             release_type == "Bail Bond" ~ "Bail",
                             release_type %in% c("Cite Release", "CiteR elease") ~ "Cite Release",
                             release_type %in% c("Own Recognizance") ~ "OR",
                             release_type %in% c("Pretrial Monitor") ~ "Monitor",
                             release_type %in% c("Zero Bail") ~ "Zero Bail",
                             T ~ "Other")) %>%
  mutate(rel_cat = factor(rel_cat, ordered = T, level = c("Not released pretrial", "Cite Release", "Zero Bail",
                                                             "Bail", "OR", "Monitor", "Other"))) %>%
  #filter(rel_cat != "Other") %>%
  group_by(book_month = floor_date(booking_date, unit = "month"), rel_cat) %>%
  summarise(n = n()) %>%
  group_by(book_month) %>%
  mutate(tot = sum(n), perc = n/tot) %>%
  ggplot(aes(fill = fct_rev(rel_cat), y = perc, x = book_month)) +
  geom_bar(position = "stack", stat = "identity") +
  scale_fill_manual(values=cbPalette)
```


Divide unreleased into multiple categories to clarify what is going on [BROKEN]
```{r eval=FALSE, include=FALSE}
full_df %>%
  filter(booking_date >= as.Date("2018-7-1")) %>%
  filter(is_release_eligible == "Yes") %>%
  filter(pretrial_period_end_count == 1) %>%
  filter(county != "Los Angeles") %>%
  mutate(rel_cat = case_when(is_released_pretrial == "No" & pretrial_period_end_count ==0 ~ "Not released pretrial, undisposed",
                             is_released_pretrial == "No" & pretrial_period_end_date < booking_date ~ "error",
                             is_released_pretrial == "No" & (pretrial_period_end_date - booking_date) <=2 ~ "Disposed within 2 days",
                             is_released_pretrial == "No" ~ "Not released pretrial, more than 2 days", 
                             release_type == "Bail Bond" ~ "Bail",
                             release_type %in% c("Cite Release", "CiteR elease") ~ "Cite Release",
                             release_type %in% c("Own Recognizance") ~ "OR",
                             release_type %in% c("Pretrial Monitor") ~ "Monitor",
                             release_type %in% c("Zero Bail") ~ "Zero Bail",
                             T ~ "Other")) %>%
  mutate(rel_cat = factor(rel_cat, ordered = T, level = c("Not released pretrial, undisposed", "error", "Disposed within 2 days", 
                                                          "Not released pretrial, other", "Cite Release", "Zero Bail",
                                                             "Bail", "OR", "Monitor", "Other"))) %>%
  #filter(rel_cat != "Other") %>%
  group_by(book_month = floor_date(booking_date, unit = "month"), rel_cat) %>%
  summarise(n = n()) %>%
  group_by(book_month) %>%
  mutate(tot = sum(n), perc = n/tot) %>%
  ggplot(aes(fill = fct_rev(rel_cat), y = perc, x = book_month)) +
  geom_bar(position = "stack", stat = "identity") +
  scale_fill_manual(values=c("#68023F", "#008169", "#EF0096", "#00DCB5", "#FFCFE2", "#003C86", "#9400E6", "#009FFA",
                             "#FF71FD", "#7CFFFA", "#3D3C04", "#008607", "#F60239", "#00E307", "#FFDC3D"))
  

```

```{r}
full_df %>%
  filter(booking_date >= as.Date("2018-7-1")) %>%
  filter(is_release_eligible == "Yes") %>%
  filter(pretrial_period_end_count == 1) %>%
  filter(charge_level %in% c("M", "F")) %>%
  filter(pretrial_period_end_date >= booking_date) %>%
  filter(county != "Los Angeles") %>%
  mutate(rel_cat = case_when(is_released_pretrial == "No" & pretrial_period_end_count ==0 ~ "Not released pretrial, undisposed",
                             #is_released_pretrial == "No" & pretrial_period_end_date < booking_date ~ "error",
                             is_released_pretrial == "No" & pretrial_period_end_date - booking_date <=2 ~ "Disposed within 2 days",
                             is_released_pretrial == "No" & pretrial_period_end_date - booking_date <=30 ~ "Disposed within 30 days",
                             is_released_pretrial == "No" & pretrial_period_end_date - booking_date <=120 ~ "Disposed within 120 days",
                             is_released_pretrial == "No" ~ "Not released pretrial, more than 120 days", 
                             release_type == "Bail Bond" ~ "Bail",
                             release_type %in% c("Cite Release", "CiteR elease") ~ "Cite Release",
                             release_type %in% c("Own Recognizance") ~ "OR",
                             release_type %in% c("Pretrial Monitor") ~ "Monitor",
                             release_type %in% c("Zero Bail") ~ "Zero Bail",
                             T ~ "Other pretrial release")) %>%
  mutate(rel_cat = factor(rel_cat, ordered = T, level = c("Not released pretrial, undisposed", "Disposed within 2 days", "Disposed within 30 days", "Disposed within 120 days", 
                                                          "Not released pretrial, more than 120 days", "Cite Release", "Zero Bail",
                                                             "Bail", "OR", "Monitor", "Other pretrial release"))) %>%
  #filter(rel_cat != "Other") %>%
  group_by(book_month = floor_date(booking_date, unit = "month"), rel_cat, charge_level) %>%
  summarise(n = n()) %>%
  group_by(book_month, charge_level) %>%
  mutate(tot = sum(n), perc = n/tot) %>%
  mutate(rel_cat = fct_rev(rel_cat)) %>%
  ggplot(aes(fill = rel_cat, y = perc, x = book_month)) +
  geom_bar(position = "stack", stat = "identity") +
  facet_grid(cols = vars(charge_level)) +
  scale_fill_manual(values=c("#68023F", "#008169", "#EF0096", "#00DCB5", "#FFCFE2", "#003C86", "#9400E6", "#009FFA",
                             "#FF71FD", "#7CFFFA", "#3D3C04", "#008607", "#F60239", "#00E307", "#FFDC3D"))

#ggsave("release categories.png", width = 14, height = 7)
```

```{r}
#faceted out - released categories only
# percents
full_df %>%
  filter(booking_date >= as.Date("2018-7-1")) %>%
  filter(pretrial_period_end_count == 1) %>%
  filter(charge_level %in% c("M", "F")) %>%
  filter(pretrial_period_end_date >= booking_date) %>%
  filter(county != "Los Angeles") %>%
  mutate(rel_cat = case_when(is_released_pretrial == "No" & pretrial_period_end_count ==0 ~ "Not released pretrial, undisposed",
                             #is_released_pretrial == "No" & pretrial_period_end_date < booking_date ~ "error",
                             is_released_pretrial == "No" & pretrial_period_end_date - booking_date <=2 ~ "Disposed within 2 days",
                             is_released_pretrial == "No" & pretrial_period_end_date - booking_date <=30 ~ "Disposed within 30 days",
                             is_released_pretrial == "No" & pretrial_period_end_date - booking_date <=120 ~ "Disposed within 120 days",
                             is_released_pretrial == "No" ~ "Not released pretrial, more than 120 days", 
                             release_type == "Bail Bond" ~ "Bail",
                             release_type %in% c("Cite Release", "CiteR elease") ~ "Cite Release",
                             release_type %in% c("Own Recognizance") ~ "OR",
                             release_type %in% c("Pretrial Monitor") ~ "Monitor",
                             release_type %in% c("Zero Bail") ~ "Zero Bail",
                             T ~ "Other pretrial release")) %>%
  mutate(rel_cat = factor(rel_cat, ordered = T, level = c("Not released pretrial, undisposed", 
                                                          "Disposed within 2 days", "Disposed within 30 days", 
                                                          "Disposed within 120 days", 
                                                          "Not released pretrial, more than 120 days", 
                                                          "Cite Release", "Zero Bail",
                                                           "Bail", "OR", "Monitor", "Other pretrial release"))) %>%
  #filter(rel_cat != "Other") %>%
  group_by(book_month = floor_date(booking_date, unit = "month"), rel_cat, charge_level) %>%
  summarise(n = n()) %>%
  group_by(book_month, charge_level) %>%
  mutate(tot = sum(n), perc = n/tot) %>%
  filter(!rel_cat %in% c("Not released pretrial, undisposed", "Disposed within 2 days", 
                         "Disposed within 30 days", "Disposed within 120 days", 
                         "Not released pretrial, more than 120 days")) %>%
  ggplot(aes(y = perc, x = book_month)) +
  geom_bar(position = "dodge", stat = "identity") +
  facet_grid(rows = vars(charge_level), cols = vars(rel_cat)) +
  scale_fill_manual(values=c("#68023F", "#008169", "#EF0096", "#00DCB5", "#FFCFE2", "#003C86", "#9400E6", "#009FFA",
                             "#FF71FD", "#7CFFFA", "#3D3C04", "#008607", "#F60239", "#00E307", "#FFDC3D"))

#unreleased categories only
# percents
full_df %>%
  filter(booking_date >= as.Date("2018-7-1")) %>%
  filter(pretrial_period_end_count == 1) %>%
  filter(charge_level %in% c("M", "F")) %>%
  filter(pretrial_period_end_date >= booking_date) %>%
  filter(county != "Los Angeles") %>%
  mutate(rel_cat = case_when(is_released_pretrial == "No" & pretrial_period_end_count ==0 ~ "Not released pretrial, undisposed",
                             #is_released_pretrial == "No" & pretrial_period_end_date < booking_date ~ "error",
                             is_released_pretrial == "No" & pretrial_period_end_date - booking_date <=2 ~ "Disposed within 2 days",
                             is_released_pretrial == "No" & pretrial_period_end_date - booking_date <=30 ~ "Disposed within 30 days",
                             is_released_pretrial == "No" & pretrial_period_end_date - booking_date <=120 ~ "Disposed within 120 days",
                             is_released_pretrial == "No" ~ "Not released pretrial, more than 120 days", 
                             release_type == "Bail Bond" ~ "Bail",
                             release_type %in% c("Cite Release", "CiteR elease") ~ "Cite Release",
                             release_type %in% c("Own Recognizance") ~ "OR",
                             release_type %in% c("Pretrial Monitor") ~ "Monitor",
                             release_type %in% c("Zero Bail") ~ "Zero Bail",
                             T ~ "Other pretrial release")) %>%
  mutate(rel_cat = factor(rel_cat, ordered = T, level = c("Not released pretrial, undisposed", 
                                                          "Disposed within 2 days", "Disposed within 30 days", 
                                                          "Disposed within 120 days", 
                                                          "Not released pretrial, more than 120 days", 
                                                          "Cite Release", "Zero Bail",
                                                           "Bail", "OR", "Monitor", "Other pretrial release"))) %>%
  #filter(rel_cat != "Other") %>%
  group_by(book_month = floor_date(booking_date, unit = "month"), rel_cat, charge_level) %>%
  summarise(n = n()) %>%
  group_by(book_month, charge_level) %>%
  mutate(tot = sum(n), perc = n/tot) %>%
  filter(rel_cat %in% c("Not released pretrial, undisposed", "Disposed within 2 days", 
                         "Disposed within 30 days", "Disposed within 120 days", 
                         "Not released pretrial, more than 120 days")) %>%
  ggplot(aes(y = perc, x = book_month)) +
  geom_bar(position = "dodge", stat = "identity") +
  facet_grid(rows = vars(charge_level), cols = vars(rel_cat)) +
  scale_fill_manual(values=c("#68023F", "#008169", "#EF0096", "#00DCB5", "#FFCFE2", "#003C86", "#9400E6", "#009FFA",
                             "#FF71FD", "#7CFFFA", "#3D3C04", "#008607", "#F60239", "#00E307", "#FFDC3D"))
```



# Zero bail analyses
```{r}

```

# Race/ethnicity impact analyses
# Space saver

