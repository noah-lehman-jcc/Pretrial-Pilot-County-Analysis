---
title: "Sal random stuff for Shelley"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(janitor)
library(tidyverse)
library(lubridate)
library(scales)
library(pROC)
library(kableExtra)
library(stargazer)
library(data.table)
library(ggthemes)
library(openxlsx)

```

Load and format full_df
```{r}
load("G:/CrimJustice/PretrialAssessmentPilot/Jail, RRF, Court, DOJ Joined.RData")

full_df <- full_df %>% 
  mutate(arrest_charge_level = case_when(is.na(arrest_charge_level)|arrest_charge_level %in% c("Other", "I") ~"Other_Unknown",
                                         arrest_charge_level == "F" ~ "Felony",
                                         arrest_charge_level == "M" ~ "Misdemeanor")) %>%
  # filter(!is.na(assessment_date)) %>%
  # filter(book_date <= as_date("2021-03-31"),
  #        book_date >= as_date("2019-10-01")) %>%
  mutate(dob = as_date(dob)) %>%
  mutate(sex = case_when(sex == "F" ~ "Female",
                         sex == "M" ~ "Male",
                         T ~ sex)) %>%
         # tool_name = gsub("-", "", tool_name),
         # tool_name = if_else(county == "Alameda", "vprair", tool_name),
         # tool_name = if_else(tool_name == "ORASPAT", "oras", tolower(tool_name))) %>%
  mutate_at(vars(race, sex), funs(if_else(is.na(.), "Other_Unknown", .))) %>%
  mutate(age = year(assessment_date) - year(dob),
         age = if_else(month(assessment_date) < month(dob), age - 1L, age),
         age = if_else(month(assessment_date) == month(dob) & day(assessment_date) < day(dob), age - 1L, age),
         age = case_when(age <= 25 & age >= 18 ~ "18-25",
                         age <= 35 & age >= 26 ~ "26-35",
                         age <= 45 & age >= 36 ~ "36-45",
                         age <= 55 & age >= 46 ~ "46-55",
                         age >= 56 & age <= 120 ~ "56+",
                         T ~ "Other_Unknown"),
         tool_name = tolower(gsub("-", "", tool_name))) %>%
  mutate(across(contains("score"), ~if_else(.x < 0, NA_real_, .x))) 

full_df <- full_df %>%
  mutate(county = tools::toTitleCase(gsub("_", " ", county))) %>%
  mutate(release_type = case_when(
    county %in% c("San Joaquin", "Ventura", "Alameda", "Tuolumne", "Nevada", "San Mateo", "Kings") &
      release_type_original %in% c("EMERGENCY ZERIO BAIL", "Zero Bail", "TEMPORARY EMERGENCY BAIL",
                                   "TEMPORARY EMERGENCY CITATION", "Covid 19", "Emergency Bail Schedule",
                                   "ZERO DOLLAR BAIL", "COVID-Pretrial Court-Order", "Pandemic Citation Release", 
                                   "Pandemic Sentence Release", "Emergency Bail Schedule-Cite", "Emergency Bail Schedule-Court") ~ "Zero_Bail",
    county %in% c("San Joaquin", "Ventura", "Alameda", "Tuolumne", "Nevada", "San Mateo", "Kings") & release_type == "Bail_Bond" ~ "Non_Zero_Bail",
    (!county %in% c("San Joaquin", "Ventura", "Alameda", "Tuolumne", "Nevada", "San Mateo", "Kings")) & 
      release_type == "Bail_Bond" ~ "Unknown_Bail",
    T ~ release_type)) %>%
  #rename(County = county) %>%
  mutate_if(is.character, funs(if_else(. == "Other_Unknown", "Other", .))) %>%
  mutate(la_flag = if_else(county == "Los Angeles", 1, 0)) %>%
  mutate(County = case_when(
    # County %in% c("Sacramento", "Alameda", "Los Angeles") ~ "Large",
    # County %in% c("Sonoma", "San Joaquin", "San Mateo", "Tulare", "Santa Barbara", "Ventura") ~ "Medium",
    county %in% c("Yuba", "Nevada", "Napa", "Kings") ~ "Small/Medium Counties",
    county %in% c("Sierra", "Modoc", "Calaveras", "Tuolumne") ~ "Small Counties",
    T ~ county))%>% 
  mutate(County = ordered(County),
         County = fct_relevel(County, levels = c("Small Counties", "Small/Medium Counties"))) %>%
  arrange(County)

# Fix incorrect coding of release types

full_df <- full_df %>%
  mutate(release_type = case_when(trimws(release_type_original) %in% c("OR", "PRETRIAL SERVICES RELEASE", "PRETRIAL PROBATION OR", "RELEASE W/COURT CONDITIONS", "PRE-ARRAIGNMENT RELEASE", "O/R- PRETRIAL PROG", "OREM", "OWN RECOGNIZANCE TO PROGRAM", "OWN RECOGNIZANCE", "Pretrial O/R with Terms", "Pre-Trial Monitoring", "Court Ordered Pretrial Release", "Pretrial Release-2", "Pretrial Release-3", "PRET") ~ "OR",
                                  trimws(release_type_original) %in% c("PROMISE TO APPEAR",  "Book & Release", "BK AND RELEASE", "IDENTIFIED AND RELEASED", "CITE") ~ "Cite_Release",
                                  trimws(release_type_original) %in% c("NO COMPLAINT", "CASE DISMISSED", "Statute of Limitations", "DISM", "REJ", "49B1", "WDEF") ~ "Dismissed_Dropped",
                                  trimws(release_type_original) %in% c("49B2", "849B (2) PC") ~ "Detain_Only",
                                  trimws(release_type_original) %in% c("EMERGENCY ZERO BAIL", "CITE RELEASED/EMERGENCY RULE 4", "EMERGENCY BAIL SCHEDULE", "ER4 CITE RELEASE - INTAKE") ~ "Zero_Bail",
                                  trimws(release_type_original) %in% c("RELEASE ON BOND") ~ "Unknown_Bail",
                                  trimws(release_type_original) %in% c("SENTENCED/ STR", "SENTENCED TO CDCR", "STATE PRISON", "STATE INSTITUTE/PRIS", "Sentenced to State Prison", "PROB", "PROBATION", "PROBATION (FORMAL)", "Probation", "Pandemic Sentence Release", "Sentenced", "Work Release", "PROBATION/COND SENTENCE", "CUST") ~ "Sentenced",
                                  trimws(release_type_original) %in% c("TIME SERVED â€“ SC43450", "TIME SERVED - OVERCROWDING", "TIME SERVED", "CAP/TIME SERVED", "TIME SERVED", "GROSS TIME SERVED", "SHRT", "PROB", "TSER", "ERLY", "24HR", "SUSP") ~ "Time_Served",
                                  T ~ release_type))

# Use pretrial end date from either court or DOJ
full_df <- full_df %>%
  mutate(pretrial_end_date = if_else(is.na(pretrial_end_date), pretrial_end_date_doj, pretrial_end_date))

# Fix missing new_arrest_flag for Santa Barbara and Ventura
full_df <- full_df %>%
  mutate(new_arrest_flag = case_when(book_type == "New_warrant" ~ 1,
                                     book_type == "Warrant" ~ 1,
                                     T ~ new_arrest_flag))

# "LAW ENFORCEMENT RELEASE" currently categorized as Cite_Release, but this could be an 849B Detain_Only? San Mateo
# "IDENTIFIED AND RELEASED" -- is this cite and release? or detain only. Alameda
# "PROB" is this a sentenced release? Probation in various spellings has shown up will every sort of release type code. "PROB", "PROBATION", "PROBATION (FORMAL)"
# "Statute of Limitations" release.....??? Ventura
# "Work Release" ....??? is this a sort of sentence? Ventura
# "Court Ordered Release" Small/Medium counties.


# full_df %>%
#   count(release_type, release_type_original) %>%
#   arrange(desc(n))
# 
# full_df %>%
#   filter(release_type_original == "IDENTIFIED AND RELEASED") %>%
#   count(release_type)
```
SB 262 Amends stuff for Shelley
```{r}
#Filter out counties with bad match court/jail match rates

full_df %>%
  filter(!county %in% c("Calaveras", "Kings", "Modoc", "Nevada", "San Mateo", "Santa Barbara", "Sierra", "Tuolumne", "Yuba")) %>%
  filter(!is.na(court_case_id)) %>%
  group_by(county) %>%
  count(missing_file_date = is.na(file_date)) %>%
  mutate(perc = round(n/sum(n)*100)) %>%
  mutate(n = sum(n)) %>%
  pivot_wider(names_from = missing_file_date, values_from = perc) 

#only LA and Napa had both good court/jail match rates and low missingness of filing date among court cases
good_counties <- full_df %>%
  filter(county %in% c("Los Angeles", "Napa")) %>%
  mutate(fta_flag = if_else(county == "Napa", court_fta_all_flag, fta_flag))


good_counties %>%
  filter(!year(book_date) %in% c('2020', "2021")) %>%
  filter(release_type == "Unknown_Bail") %>%
  mutate(no_file = if_else(is.na(file_date), 1, 0),
         late_file = if_else(file_date - book_date >= 60, 1, 0),
         dism = if_else(disposition_type == "Dismissed", 1, 0),
         no_fta = if_else(!is.na(pretrial_end_date) & fta_flag == 0, 1, 0)) %>%
  mutate(across(c(no_file, late_file, dism, no_fta), ~if_else(is.na(.x), 0, .x))) %>%
  mutate(all_eligible = if_else(no_file == 1 | late_file == 1 | dism == 1 | no_fta == 1, 1, 0)) %>%
  group_by(county) %>%
  count(all_eligible) %>%
  mutate(perc = n/sum(n)*100) %>%
  mutate(nn = sum(n))


good_counties %>%
  count(year(book_date), county)

good_counties %>%
  count(is.na(file_date), county)

#using all counties with good match rates, most of these have a lot of missing filing dates
moderate_counties <- full_df %>%
  filter(!county %in% c("Calaveras", "Kings", "Modoc", "Nevada", "San Mateo", "Santa Barbara", "Sierra", "Tuolumne", "Yuba"))

moderate_counties %>%
  mutate(fta_flag = if_else(county == "Napa", court_fta_all_flag, fta_flag)) %>%
  filter(!year(book_date) %in% c("2020", "2021")) %>%
  filter(release_type %in% c("Non_Zero_Bail", "Unknown_Bail")) %>%
  mutate(no_file = if_else(is.na(court_case_id), 1, 0),
         late_file = if_else(file_date - book_date >= 60, 1, 0),
         dism = if_else(disposition_type == "Dismissed", 1, 0),
         no_fta = if_else(!is.na(pretrial_end_date) & fta_flag == 0, 1, 0)) %>%
  mutate(across(c(no_file, late_file, dism, no_fta), ~if_else(is.na(.x), 0, .x))) %>%
  mutate(all_eligible = if_else(no_file == 1 | late_file == 1 | dism == 1 | no_fta == 1, 1, 0)) %>%
  group_by(county) %>%
  count(all_eligible) %>%
  mutate(perc = n/sum(n)*100) %>%
  mutate(total = sum(n)) %>%
  filter(all_eligible == 1)

moderate_counties %>%
  filter(!is.na(court_case_id)) %>%
  count(county, na_file = is.na(file_date)) %>%
  group_by(county) %>%
  mutate(perc = round(n/sum(n)*100)) %>%
  ungroup() %>%
  filter(na_file == TRUE)
```


```{r}
moderate_counties %>%
  filter(!year(book_date) %in% c("2020", "2021")) %>%
  filter(release_type %in% c("Non_Zero_Bail", "Unknown_Bail")) %>%
  group_by(county) %>%
  summarise(earliest_book = min(book_date), latest_book = max(book_date))

moderate_counties %>%
  filter(!year(book_date) %in% c("2020", "2021")) %>%
  filter(release_type %in% c("Non_Zero_Bail", "Unknown_Bail")) %>%
  group_by(county, year(book_date), month(book_date)) %>%
  summarise(n = n())
```

```{r}
full_df %>%
  #filter(release_type == "Zero_Bail") %>%
  count(County, county, release_type) %>%
  filter(release_type %in% c("Zero_Bail", "Non_Zero_Bail", "Unknown_Bail")) %>%
  pivot_wider(names_from = release_type, values_from = n) %>%
  arrange(desc(n))

full_df %>%
  filter(county == "Santa Barbara") %>%
  count(release_type, release_type_original)

full_df %>%
  filter(is.na(release_type)) %>%
  count(is.na(release_date))
  count(is.na(release_type), is.na(release_date))
  
sonoma_collapse %>%
  filter(grepl("psa", assessment_id)) %>%
  count(assessment_id)

test <- names(eval_df)[259:ncol(eval_df)]
write.csv(test, file = "doj variable names.csv")

shell.exec("doj variable names.csv")
shell.exec(getwd())
```

Load and format eval_df
```{r}
load("G:/CrimJustice/PretrialAssessmentPilot/Final Failure Evaluation2.RData")
# load("Final Failure Evaluation.RData")

eval_df <- eval_df %>%
  filter(new_arrest_flag == 1) %>%
  mutate(arrest_charge_level = case_when(is.na(arrest_charge_level)|arrest_charge_level %in% c("Other", "I") ~"Other_Unknown",
                                         arrest_charge_level == "F" ~ "Felony",
                                         arrest_charge_level == "M" ~ "Misdemeanor")) %>%
  filter(book_date <= as_date("2021-03-31"),
         book_date >= as_date("2019-10-01")) %>%
  filter(!is.na(cii)) %>%
  mutate(monitor_level = case_when(
    monitor_level %in% c("Level I - Pretrial Release Supervision",
                                     "Pretrial Supervision Level I", "1", "Low") ~ "Low",
    monitor_level %in% c("Level II - Pretrial Release Supervision",
                                     "Pretrial Supervision Level II", "2", "Medium") ~ "Medium",
    monitor_level %in% c("Level III - Pretrial Release Supervision",
                                     "Pretrial Supervision Level III", "3:4", "High") ~ "High",
                              T ~ monitor_level)) %>%
  mutate(fta_flag = if_else(fta_flag == 1|arrest_fta_flag == 1|court_fta_flag == 1|court_fta_flag_doj == 1, 1, 0),
         revoked_flag = if_else(pretrial_termination_outcome == "Unsuccessful", 1, 0),
         oras_risk_score = if_else(oras_risk_score == -Inf, NA_real_, oras_risk_score)) %>%
  mutate(monitor_level = factor(monitor_level, levels = c("Low", "Medium", "High", "Other_Unknown")))

eval_df <- eval_df %>%
  mutate(county = tools::toTitleCase(gsub("_", " ", county))) %>%
  mutate(sex = case_when(sex == "F" ~ "Female",
                         sex == "M" ~ "Male",
                         T ~ sex),
         tool_name = gsub("-", "", tool_name),
         tool_name = if_else(county == "Alameda", "vprair", tool_name),
         tool_name = if_else(county == "Yuba", "oras", tool_name),
         tool_name = if_else(tool_name == "ORASPAT", "oras", tolower(tool_name))) %>%
  mutate(release_type = case_when(
    county %in% c("San Joaquin", "Ventura", "Alameda", "Tuolumne", "Nevada", "San Mateo", "Kings") &
      release_type_original %in% c("EMERGENCY ZERO BAIL", "Zero Bail", "TEMPORARY EMERGENCY BAIL",
                                   "TEMPORARY EMERGENCY CITATION", "Covid 19", "Emergency Bail Schedule",
                                   "ZERO DOLLAR BAIL", "COVID-Pretrial Court-Order", "Pandemic Citation Release", 
                                   "Pandemic Sentence Release", "Emergency Bail Schedule-Cite", "Emergency Bail Schedule-Court") ~ "Zero_Bail",
    county %in% c("San Joaquin", "Ventura", "Alameda", "Tuolumne", "Nevada", "San Mateo", "Kings") & release_type == "Bail_Bond" ~ "Non_Zero_Bail",
    (!county %in% c("San Joaquin", "Ventura", "Alameda", "Tuolumne", "Nevada", "San Mateo", "Kings")) & 
      release_type == "Bail_Bond" ~ "Unknown_Bail",
    T ~ release_type)) %>%
  mutate(County = county) %>%
  mutate_if(is.character, funs(if_else(. == "Other_Unknown", "Other", .))) %>%
  mutate(la_flag = if_else(County == "Los Angeles", 1, 0)) %>%
  mutate(County = case_when(
    # County %in% c("Sacramento", "Alameda", "Los Angeles") ~ "Large",
    # County %in% c("Sonoma", "San Joaquin", "San Mateo", "Tulare", "Santa Barbara", "Ventura") ~ "Medium",
    County %in% c("Yuba", "Nevada", "Napa", "Kings") ~ "Small/Medium Counties",
    County %in% c("Sierra", "Modoc", "Calaveras", "Tuolumne") ~ "Small Counties",
    T ~ County))%>% 
  mutate(County = ordered(County),
         County = fct_relevel(County, levels = c("Small Counties", "Small/Medium Counties"))) %>%
  arrange(County)
```

Look at release type
```{r}
eval_df %>%
  count(release_type) %>%
  mutate(percent = round(n/sum(n)*100))

full_df %>%
  filter(pretrial_release_type == "Bail_Bond") %>%
  count(release_type, pretrial_release_type) %>%
  mutate(percent = round(n/sum(n)*100)) %>%
  arrange(desc(n))

```


```{r}
full_df %>%
  count(disposition_type)

full_df %>%
  count(disp_descr) %>%
  arrange(desc(n))

full_df %>%
  filter(!is.na(pretrial_end_date_doj)) %>%
  count(disp_descr, is.na(sentence_date_doj), is.na(disposition_date), is.na(disp_date))

full_df %>%
  select(contains("conviction"))

full_df %>%
  filter(!is.na(court_charge_original), 
         !is.na(pretrial_end_date),
          new_arrest_flag == 1) %>%
  mutate(conviction = if_else(conviction_felony_flag == 1 | conviction_misd_flag == 1, 1, 0)) %>%
  count(conviction) %>%
  mutate(perc = round(n/sum(n)*100))

full_df %>%
  filter(year(book_date) == 2020) %>%
  count(arrest_charge_level)

join_df %>%
  filter(year(book_date) == 2020) %>%
  filter(new_arrest_flag == 1) %>%
  count(arrest_charge_level)
```

```{r}
full_df %>%
  filter(new_arrest_flag == 1,
         year(book_date) == 2020,
         arrest_charge_level %in% c("Felony", "Misdemeanor")) %>%
  count(county, arrest_charge_level) %>%
  pivot_wider(names_from = arrest_charge_level, values_from = n)
```


```{r}
arrest_charge_level_df <- full_df %>%
  filter(!is.na(pretrial_end_date),
         new_arrest_flag == 1) %>%
  mutate(pre_trial_release_flag = if_else(release_date >= pretrial_end_date|is.na(release_date), 0, 1)) %>%
  mutate(two_day_release = case_when(
    weekdays(book_date) == "Thursday" & release_date - book_date <= 4 ~ 1,
    weekdays(book_date) == "Friday" & release_date - book_date <= 4 ~ 1,
    weekdays(book_date) == "Saturday" & release_date - book_date <= 3 ~ 1,
    !weekdays(book_date) %in% c("Thursday", "Friday", "Saturday") & release_date - book_date <= 2 ~ 1,
    is.na(release_date) ~ 0,
    T ~ 0)) %>%
  mutate(pre_arraignment_flag = if_else(two_day_release == 1 & pre_trial_release_flag == 1, 1, 0),
         closed_convicted_flag = if_else(two_day_release == 1 & pre_trial_release_flag == 0 & conviction_flag == 1, 1, 0),
         closed_not_convicted_flag = if_else(two_day_release == 1 & pre_trial_release_flag == 0 & conviction_flag == 0, 1, 0)) %>%
  group_by(County, arrest_charge_level) %>%
  summarise(Total = n(),
            `Two Day Release Rate` = paste(round(mean(two_day_release)*100), "%"), 
            `Two Day Pretrial Release` = paste(round(mean(pre_arraignment_flag)*100), "%"),
            `Two Day Case Closed, Convicted Release Rate` = paste(round(mean(closed_convicted_flag)*100), "%"),
            `Two Day Case Closed, Not Convicted Release Rate` = paste(round(mean(closed_not_convicted_flag)*100), "%"),
            `Total Pretrial Release Rate` = paste(round(mean(pre_trial_release_flag)*100), "%")) %>%
    rename(arrest_charge_level = arrest_charge_level) 


full_df %>%
  filter(!is.na(pretrial_end_date),
         new_arrest_flag == 1) %>%
  mutate(pre_trial_release_flag = if_else(release_date >= pretrial_end_date|is.na(release_date), 0, 1)) %>%
  mutate(release_type_cat = if_else( release_type %in% c("Cite_Release", "OR", "Unknown_Bail", "Non_Zero_Bail", "Zero_Bail"), release_type, "Other/Unknown"),
         release_type_cat = if_else(release_type %in% c("Unknown_Bail", "Non_Zero_Bail", "Zero_Bail"), "Bail", release_type_cat)) %>%
  count(pre_trial_release_flag, release_type_cat) %>%
  filter(pre_trial_release_flag == 1) %>%
  arrange(desc(n)) %>%
  mutate(total = sum(n),
         percent = round(n/total*100))

full_df %>%
  select(contains("release"))

full_df %>%
  filter(new_arrest_flag == 1,
         County == "Small/Medium Counties") %>%
  count(county)
```

```{r}
full_df %>%
  filter(!is.na(pretrial_end_date),
         new_arrest_flag == 1) %>%
  count(release_type_original, release_type) %>%
  arrange(desc(n))
```

```{r}
#look at ppl who do not have completed pretrial periods
#this may falsely represent pretrial releases for counties that have poor court data matching, because they may be released due to a disposition that we do not have a record of
# Counties with good court matching: Alameda, Napa, Sacramento, Sonoma, Ventura. 
# Napa is rolled into Small/Medium counties though, so will just make a table with the big ones where the data is reliable

arrest_charge_level_df <- full_df %>%
  filter(County %in% c("Alameda", "Sacramento", "Sonoma", "Ventura")) %>%
  filter(new_arrest_flag == 1) %>%
  mutate(pre_trial_release_flag = case_when(is.na(release_date) ~ 0,
                                            is.na(pretrial_end_date) & !is.na(release_date) ~ 1,
                                            release_date >= pretrial_end_date ~ 0,
                                            release_date < pretrial_end_date ~ 1,
                                            T ~ NA_real_)) %>%
  mutate(two_day_release = case_when(
    weekdays(book_date) == "Thursday" & release_date - book_date <= 4 ~ 1,
    weekdays(book_date) == "Friday" & release_date - book_date <= 4 ~ 1,
    weekdays(book_date) == "Saturday" & release_date - book_date <= 3 ~ 1,
    !weekdays(book_date) %in% c("Thursday", "Friday", "Saturday") & release_date - book_date <= 2 ~ 1,
    is.na(release_date) ~ 0,
    T ~ 0)) %>%
  mutate(pre_arraignment_flag = if_else(two_day_release == 1 & pre_trial_release_flag == 1, 1, 0),
         convicted_flag = if_else(is.na(convicted_flag), 0, convicted_flag),
         conviction = if_else(conviction_felony_flag == 1 | conviction_misd_flag == 1 | conviction_flag == 1 | convicted_flag == 1, 1, 0),
         closed_convicted_flag = if_else(two_day_release == 1 & pre_trial_release_flag == 0 & conviction == 1, 1, 0),
         closed_not_convicted_flag = if_else(two_day_release == 1 & pre_trial_release_flag == 0 & conviction == 0, 1, 0)) %>%
  group_by(County, arrest_charge_level) %>%
  summarise(Total = n(),
            `Released - (A)Charges dropped or case dismissed within 2 court days` = mean(closed_not_convicted_flag),
            `Released - (B)Convicted within 2 court days` = mean(closed_convicted_flag),
            `Released - (C)Pretrial release (OR or bail) within 2 court days` = mean(pre_arraignment_flag),
            `TOTAL: Released within 2 court days` = mean(two_day_release), 
            `Released - (D)Pretrial release (OR or bail) after 2 court days` = mean(pre_trial_release_flag) - mean(pre_arraignment_flag)) %>%
  filter(arrest_charge_level %in% c("Felony", "Misdemeanor")) %>%
  rename(`Arrest Charge Level` = arrest_charge_level) %>%
  arrange(desc(`Arrest Charge Level`))

write.xlsx(arrest_charge_level_df, file = "I:/Random for Shelley/2021.06.03 pretrial stuff/2A offense type good court match counties.xlsx", asTable = F)

full_df %>%
  count(conviction_flag, conviction_felony_flag, conviction_misd_flag, conviction_felon)

full_df %>%
  select(contains("convict"))

full_df %>%
  count(convicted_flag, conviction_flag, conviction_felony_flag, conviction_misd_flag)

#convicted_flag is from DOJ
#conviction_flag is based on dispo type
```
Two and Ten day release rates
```{r}
#look at ppl who do not have completed pretrial periods
#this may falsely represent pretrial releases for counties that have poor court data matching, because they may be released due to a disposition that we do not have a record of
#so for this table just look at 2 day release rates, since we can't reliably say much else.
arrest_charge_level_df <- full_df %>%
  filter(new_arrest_flag == 1) %>%
  mutate(pre_trial_release_flag = case_when(is.na(release_date) ~ 0,
                                            is.na(pretrial_end_date) & !is.na(release_date) ~ 1,
                                            release_date >= pretrial_end_date ~ 0,
                                            release_date < pretrial_end_date ~ 1,
                                            T ~ NA_real_)) %>%
  mutate(two_day_release = case_when(
    weekdays(book_date) == "Thursday" & release_date - book_date <= 4 ~ 1,
    weekdays(book_date) == "Friday" & release_date - book_date <= 4 ~ 1,
    weekdays(book_date) == "Saturday" & release_date - book_date <= 3 ~ 1,
    !weekdays(book_date) %in% c("Thursday", "Friday", "Saturday") & release_date - book_date <= 2 ~ 1,
    is.na(release_date) ~ 0,
    T ~ 0)) %>%
  mutate(ten_day_release = case_when(
    weekdays(book_date) == "Thursday" & release_date - book_date <= 10 ~ 1,
    weekdays(book_date) == "Friday" & release_date - book_date <= 10 ~ 1,
    weekdays(book_date) == "Saturday" & release_date - book_date <= 10 ~ 1,
    !weekdays(book_date) %in% c("Thursday", "Friday", "Saturday") & release_date - book_date <= 10 ~ 1,
    is.na(release_date) ~ 0,
    T ~ 0)) %>%
  mutate(pre_arraignment_flag = if_else(two_day_release == 1 & pre_trial_release_flag == 1 & !is.na(pretrial_end_date), 1, 0),
         unknown_quick_flag = if_else(two_day_release == 1 & pre_trial_release_flag == 1 & is.na(pretrial_end_date), 1, 0),
         convicted_flag = if_else(is.na(convicted_flag), 0, convicted_flag),
         conviction = if_else(conviction_felony_flag == 1 | conviction_misd_flag == 1 | conviction_flag == 1 | convicted_flag == 1, 1, 0),
         closed_convicted_flag = if_else(two_day_release == 1 & pre_trial_release_flag == 0 & conviction == 1, 1, 0),
         closed_not_convicted_flag = if_else(two_day_release == 1 & pre_trial_release_flag == 0 & conviction == 0, 1, 0)) %>%
  group_by(County, arrest_charge_level) %>%
  summarise(Total = n(),
            `Released - (A) Charges dropped or case dismissed within 2 court days` = mean(closed_not_convicted_flag),
            `Released - (B) Convicted within 2 court days` = mean(closed_convicted_flag),
            `Released - (C) Pretrial release (OR or bail) within 2 court days` = mean(pre_arraignment_flag),
            `Released - Unknown type within 2 court days` = mean(unknown_quick_flag),
            `TOTAL: Released within 2 court days` = mean(two_day_release), 
            `Released - Release of any type within 10 days` = mean(ten_day_release)) %>%
  filter(arrest_charge_level %in% c("Felony", "Misdemeanor")) %>%
  rename(`Arrest Charge Level` = arrest_charge_level) %>%
  arrange(desc(`Arrest Charge Level`))

write.xlsx(arrest_charge_level_df, file = "I:/Random for Shelley/2021.06.03 pretrial stuff/2A offense type - tot 2 and 10 day releases.xlsx", asTable = F)


```

Try to add release type
```{r}
#look at ppl who do not have completed pretrial periods
#this may falsely represent pretrial releases for counties that have poor court data matching, because they may be released due to a disposition that we do not have a record of
# Counties with good court matching: Alameda, Napa, Sacramento, Sonoma, Ventura. 
# Napa is rolled into Small/Medium counties though, so will just make a table with the big ones where the data is reliable

arrest_charge_level_df <- full_df %>%
  filter(County %in% c("Alameda", "Sacramento", "Sonoma", "Ventura")) %>%
  filter(new_arrest_flag == 1) %>%
  mutate(pretrial_release_cat = case_when(release_type %in% c("Non_Zero_Bail", "Zero_Bail", "Unknown_Bail") ~ "Bail",
                               release_type %in% c("OR", "Cite_Release") ~ "OR/Cite_Release",
                               T ~ "Other/Unknown")) %>%
  mutate(pre_trial_release_flag = case_when(is.na(release_date) ~ 0,
                                            is.na(pretrial_end_date) & !is.na(release_date) ~ 1,
                                            release_date >= pretrial_end_date ~ 0,
                                            release_date < pretrial_end_date ~ 1,
                                            T ~ NA_real_)) %>%
  mutate(two_day_release = case_when(
    weekdays(book_date) == "Thursday" & release_date - book_date <= 4 ~ 1,
    weekdays(book_date) == "Friday" & release_date - book_date <= 4 ~ 1,
    weekdays(book_date) == "Saturday" & release_date - book_date <= 3 ~ 1,
    !weekdays(book_date) %in% c("Thursday", "Friday", "Saturday") & release_date - book_date <= 2 ~ 1,
    is.na(release_date) ~ 0,
    T ~ 0)) %>%
  mutate(pre_arraignment_flag = if_else(two_day_release == 1 & pre_trial_release_flag == 1, 1, 0),
         two_day_bail_flag = if_else(pre_arraignment_flag == 1 & pretrial_release_cat == "Bail", 1, 0),
         two_day_or_flag = if_else(pre_arraignment_flag == 1 & pretrial_release_cat == "OR/Cite_Release", 1, 0),
         two_day_other_pre_flag = if_else(pre_arraignment_flag == 1 & pretrial_release_cat == "Other/Unknown", 1, 0),
         convicted_flag = if_else(is.na(convicted_flag), 0, convicted_flag),
         conviction = if_else(conviction_felony_flag == 1 | conviction_misd_flag == 1 | conviction_flag == 1 | convicted_flag == 1, 1, 0),
         closed_convicted_flag = if_else(two_day_release == 1 & pre_trial_release_flag == 0 & conviction == 1, 1, 0),
         closed_not_convicted_flag = if_else(two_day_release == 1 & pre_trial_release_flag == 0 & conviction == 0, 1, 0)) %>%
  group_by(County, arrest_charge_level) %>%
  summarise(Total = n(),
            `Released - (A)Charges dropped or case dismissed within 2 court days` = mean(closed_not_convicted_flag),
            `Released - (B)Convicted within 2 court days` = mean(closed_convicted_flag),
            `Released - Bail release ($0 or non-zero) within 2 court days` = mean(two_day_bail_flag),
            `Released - Pretrial release (OR or Cite and Release) within 2 court days` = mean(two_day_or_flag),
            `Released - Pretrial release (unknown type) within 2 court days` = mean(two_day_other_pre_flag),
            `TOTAL: Released within 2 court days` = mean(two_day_release), 
            `Released - (D)Pretrial release (OR or bail) after 2 court days` = mean(pre_trial_release_flag) - mean(pre_arraignment_flag)) %>%
  filter(arrest_charge_level %in% c("Felony", "Misdemeanor")) %>%
  rename(`Arrest Charge Level` = arrest_charge_level) %>%
  arrange(desc(`Arrest Charge Level`))

write.xlsx(arrest_charge_level_df, file = "I:/Random for Shelley/2021.06.03 pretrial stuff/2A offense type good court match counties with release cat.xlsx", asTable = F)


#convicted_flag is from DOJ
#conviction_flag is based on dispo type

full_df %>%
  count(release_type)


```


Try to add release type v2: break out cite/release from OR
```{r}
#look at ppl who do not have completed pretrial periods
#this may falsely represent pretrial releases for counties that have poor court data matching, because they may be released due to a disposition that we do not have a record of
# Counties with good court matching: Alameda, Napa, Sacramento, Sonoma, Ventura. 
# Napa is rolled into Small/Medium counties though, so will just make a table with the big ones where the data is reliable

arrest_charge_level_df <- full_df %>%
  filter(County %in% c("Alameda", "Sacramento", "Sonoma", "Ventura")) %>%
  filter(new_arrest_flag == 1) %>%
  mutate(pretrial_release_cat = case_when(release_type %in% c("Non_Zero_Bail", "Zero_Bail", "Unknown_Bail") ~ "Bail",
                               release_type %in% c("OR", "Cite_Release") ~ release_type,
                               T ~ "Other/Unknown")) %>%
  mutate(pre_trial_release_flag = case_when(is.na(release_date) ~ 0,
                                            is.na(pretrial_end_date) & !is.na(release_date) ~ 1,
                                            release_date >= pretrial_end_date ~ 0,
                                            release_date < pretrial_end_date ~ 1,
                                            T ~ NA_real_)) %>%
  mutate(two_day_release = case_when(
    weekdays(book_date) == "Thursday" & release_date - book_date <= 4 ~ 1,
    weekdays(book_date) == "Friday" & release_date - book_date <= 4 ~ 1,
    weekdays(book_date) == "Saturday" & release_date - book_date <= 3 ~ 1,
    !weekdays(book_date) %in% c("Thursday", "Friday", "Saturday") & release_date - book_date <= 2 ~ 1,
    is.na(release_date) ~ 0,
    T ~ 0)) %>%
  mutate(pre_arraignment_flag = if_else(two_day_release == 1 & pre_trial_release_flag == 1, 1, 0),
         two_day_bail_flag = if_else(pre_arraignment_flag == 1 & pretrial_release_cat == "Bail", 1, 0),
         two_day_or_flag = if_else(pre_arraignment_flag == 1 & pretrial_release_cat == "OR", 1, 0),
         two_day_cite_flag = if_else(pre_arraignment_flag == 1 & pretrial_release_cat == "Cite_Release", 1, 0),
         two_day_other_pre_flag = if_else(pre_arraignment_flag == 1 & pretrial_release_cat == "Other/Unknown", 1, 0),
         convicted_flag = if_else(is.na(convicted_flag), 0, convicted_flag),
         conviction = if_else(conviction_felony_flag == 1 | conviction_misd_flag == 1 | conviction_flag == 1 | convicted_flag == 1, 1, 0),
         closed_convicted_flag = if_else(two_day_release == 1 & pre_trial_release_flag == 0 & conviction == 1, 1, 0),
         closed_not_convicted_flag = if_else(two_day_release == 1 & pre_trial_release_flag == 0 & conviction == 0, 1, 0)) %>%
  group_by(County, arrest_charge_level) %>%
  summarise(Total = n(),
            `Released - (A)Charges dropped or case dismissed within 2 court days` = mean(closed_not_convicted_flag),
            `Released - (B)Convicted within 2 court days` = mean(closed_convicted_flag),
            `Released - Bail release ($0 or non-zero) within 2 court days` = mean(two_day_bail_flag),
            `Released - Pretrial release (Cite and Release) within 2 court days` = mean(two_day_cite_flag),
            `Released - Pretrial release (OR) within 2 court days` = mean(two_day_or_flag),
            `Released - Pretrial release (unknown type) within 2 court days` = mean(two_day_other_pre_flag),
            `TOTAL: Released within 2 court days` = mean(two_day_release), 
            `Released - (D)Pretrial release (OR or bail) after 2 court days` = mean(pre_trial_release_flag) - mean(pre_arraignment_flag)) %>%
  filter(arrest_charge_level %in% c("Felony", "Misdemeanor")) %>%
  rename(`Arrest Charge Level` = arrest_charge_level) %>%
  arrange(desc(`Arrest Charge Level`))

write.xlsx(arrest_charge_level_df, file = "I:/Random for Shelley/2021.06.03 pretrial stuff/2A offense type good court match counties with release cat and cite.xlsx", asTable = F)


#convicted_flag is from DOJ
#conviction_flag is based on dispo type

full_df %>%
  count(release_type)


```

Date ranges
```{r}
date_range <- full_df %>%
  #filter(County %in% c("Alameda", "Sacramento", "Sonoma", "Ventura")) %>%
  filter(new_arrest_flag == 1) %>%
  group_by(County) %>%
  summarise(Total = n(),
            `Earliest book date` = min(book_date),
            `Latest book date` = max(book_date))

write.xlsx(date_range, file = "I:/Random for Shelley/2021.06.03 pretrial stuff/All bookings date ranges by county v2.xlsx", asTable = F)
```


All counties using release types to determine whether release was pretrial or not
```{r}
#look at ppl who do not have completed pretrial periods
#this may falsely represent pretrial releases for counties that have poor court data matching, because they may be released due to a disposition that we do not have a record of

# release_type variable may not be a reliable indicator of pretrial release, but going to try to use it here anyway just to see

arrest_charge_level_df <- full_df %>%
  mutate(release_cat = case_when(release_type %in% c("Cite_Release", "Non_Zero_Bail", "OR", "Unknown_Bail", "Zero_Bail") ~ "Pretrial release type",
                                 release_type %in% c("Detain_Only", "Dismissed_Dropped", "Sentenced", "Time_Served") ~ "Post-resolution release type",
                                 release_type %in% c("Hold_Release", "Other", "Unknown") ~ "Unclear release type",
                                 T ~ "Unclear release type")) %>%
  filter(new_arrest_flag == 1) %>%
  mutate(pre_trial_release_flag = if_else(release_cat == "Pretrial release type", 1, 0)) %>%
  mutate(two_day_release = case_when(
    weekdays(book_date) == "Thursday" & release_date - book_date <= 4 ~ 1,
    weekdays(book_date) == "Friday" & release_date - book_date <= 4 ~ 1,
    weekdays(book_date) == "Saturday" & release_date - book_date <= 3 ~ 1,
    !weekdays(book_date) %in% c("Thursday", "Friday", "Saturday") & release_date - book_date <= 2 ~ 1,
    is.na(release_date) ~ 0,
    T ~ 0)) %>%
  mutate(quick_pretrial_type_flag = if_else(two_day_release == 1 & release_cat == "Pretrial release type", 1, 0),
         #quick_postres_type_flag = if_else(two_day_release == 1 & release_cat == "Post-resolution release type", 1, 0),
         quick_bail_type_flag = if_else(two_day_release == 1 & release_type %in% c("Non_Zero_Bail", "Zero_Bail", "Unknown_Bail"), 1, 0),
         quick_cite_type_flag = if_else(two_day_release == 1 & release_type %in% c("Cite_Release"), 1, 0),
         quick_or_type_flag = if_else(two_day_release == 1 & release_type %in% c("OR"), 1, 0),
         quick_unknown_type_flag = if_else(two_day_release == 1 & release_cat == "Unclear release type", 1, 0),
         convicted_flag = if_else(is.na(convicted_flag), 0, convicted_flag),
         #conviction = if_else(conviction_felony_flag == 1 | conviction_misd_flag == 1 | conviction_flag == 1 | convicted_flag == 1, 1, 0),
         closed_convicted_flag = if_else(two_day_release == 1 & release_type %in% c("Sentenced", "Time_Served"), 1, 0),
         closed_not_convicted_flag = if_else(two_day_release == 1 & release_type %in% c("Detain_Only", "Dismissed_Dropped"), 1, 0),
         later_pretrial_type_flag = if_else(two_day_release == 0 & release_cat == "Pretrial release type", 1, 0),
         later_bail_type_flag = if_else(two_day_release == 0 & release_type %in% c("Non_Zero_Bail", "Zero_Bail", "Unknown_Bail"), 1, 0),
         later_cite_type_flag = if_else(two_day_release == 0 & release_type %in% c("Cite_Release"), 1, 0),
         later_or_type_flag = if_else(two_day_release == 0 & release_type %in% c("OR"), 1, 0)) %>%
  group_by(County, arrest_charge_level) %>%
  summarise(Total = n(),
            `Charges dropped or case dismissed within 2 court days` = mean(closed_not_convicted_flag),
            `Convicted within 2 court days` = mean(closed_convicted_flag),
            #`Released - (C) Pretrial release (OR or bail) within 2 court days` = mean(pre_arraignment_flag),
            `Bail release type within 2 court days` = mean(quick_bail_type_flag),
            `Cite & Release release type within 2 court days` = mean(quick_cite_type_flag),
            `OR release type within 2 court days` = mean(quick_or_type_flag),
            #`Released - Post-resolution release type` = mean(quick_postres_type_flag),
            `Unclear release type (post-resolution or pretrial) within 2 court days` = mean(quick_unknown_type_flag),
            `TOTAL: Released within 2 court days` = mean(two_day_release), 
            `Bail release type after 2 days` = mean(later_bail_type_flag),
            `Cite & Release release type after 2 days` = mean(later_cite_type_flag),
            `OR release type after 2 days` = mean(later_or_type_flag)) %>%
  filter(arrest_charge_level %in% c("Felony", "Misdemeanor")) %>%
  rename(`Arrest Charge Level` = arrest_charge_level) %>%
  arrange(desc(`Arrest Charge Level`))

write.xlsx(arrest_charge_level_df, file = "I:/Random for Shelley/2021.06.03 pretrial stuff/2A offense type - ALL BOOKINGS using release type draft5.xlsx", asTable = F)
```

Separating misdo and felony - All counties using release types to determine whether release was pretrial or not
```{r}
#look at ppl who do not have completed pretrial periods
#this may falsely represent pretrial releases for counties that have poor court data matching, because they may be released due to a disposition that we do not have a record of

# release_type variable may not be a reliable indicator of pretrial release, but going to try to use it here anyway just to see

arrest_charge_level_df <- full_df %>%
  mutate(release_cat = case_when(release_type %in% c("Cite_Release", "Non_Zero_Bail", "OR", "Unknown_Bail", "Zero_Bail") ~ "Pretrial release type",
                                 release_type %in% c("Detain_Only", "Dismissed_Dropped", "Sentenced", "Time_Served") ~ "Post-resolution release type",
                                 release_type %in% c("Hold_Release", "Other", "Unknown") ~ "Unclear release type",
                                 T ~ "Unclear release type")) %>%
  filter(new_arrest_flag == 1,
         arrest_charge_level == "Misdemeanor") %>%
  mutate(pre_trial_release_flag = if_else(release_cat == "Pretrial release type", 1, 0)) %>%
  mutate(two_day_release = case_when(
    weekdays(book_date) == "Thursday" & release_date - book_date <= 4 ~ 1,
    weekdays(book_date) == "Friday" & release_date - book_date <= 4 ~ 1,
    weekdays(book_date) == "Saturday" & release_date - book_date <= 3 ~ 1,
    !weekdays(book_date) %in% c("Thursday", "Friday", "Saturday") & release_date - book_date <= 2 ~ 1,
    is.na(release_date) ~ 0,
    T ~ 0)) %>%
  mutate(quick_pretrial_type_flag = if_else(two_day_release == 1 & release_cat == "Pretrial release type", 1, 0),
         #quick_postres_type_flag = if_else(two_day_release == 1 & release_cat == "Post-resolution release type", 1, 0),
         quick_bail_type_flag = if_else(two_day_release == 1 & release_type %in% c("Non_Zero_Bail", "Zero_Bail", "Unknown_Bail"), 1, 0),
         quick_cite_type_flag = if_else(two_day_release == 1 & release_type %in% c("Cite_Release"), 1, 0),
         quick_or_type_flag = if_else(two_day_release == 1 & release_type %in% c("OR"), 1, 0),
         quick_unknown_type_flag = if_else(two_day_release == 1 & release_cat == "Unclear release type", 1, 0),
         convicted_flag = if_else(is.na(convicted_flag), 0, convicted_flag),
         #conviction = if_else(conviction_felony_flag == 1 | conviction_misd_flag == 1 | conviction_flag == 1 | convicted_flag == 1, 1, 0),
         closed_convicted_flag = if_else(two_day_release == 1 & release_type %in% c("Sentenced", "Time_Served"), 1, 0),
         closed_not_convicted_flag = if_else(two_day_release == 1 & release_type %in% c("Detain_Only", "Dismissed_Dropped"), 1, 0),
         later_pretrial_type_flag = if_else(two_day_release == 0 & release_cat == "Pretrial release type", 1, 0),
         later_bail_type_flag = if_else(two_day_release == 0 & release_type %in% c("Non_Zero_Bail", "Zero_Bail", "Unknown_Bail"), 1, 0),
         later_cite_type_flag = if_else(two_day_release == 0 & release_type %in% c("Cite_Release"), 1, 0),
         later_or_type_flag = if_else(two_day_release == 0 & release_type %in% c("OR"), 1, 0)) %>%
  group_by(County) %>%
  summarise(Total = n(),
            `No charges filed, charges dropped, or case dismissed within 2 court days` = mean(closed_not_convicted_flag),
            `Convicted within 2 court days` = mean(closed_convicted_flag),
            #`Released - (C) Pretrial release (OR or bail) within 2 court days` = mean(pre_arraignment_flag),
            `Bail release type within 2 court days` = mean(quick_bail_type_flag),
            `Cite & Release release type within 2 court days` = mean(quick_cite_type_flag),
            `OR release type within 2 court days` = mean(quick_or_type_flag),
            #`Released - Post-resolution release type` = mean(quick_postres_type_flag),
            `Unclear release type (post-resolution or pretrial) within 2 court days` = mean(quick_unknown_type_flag),
            `TOTAL: Released within 2 court days` = mean(two_day_release), 
            `Bail release type after 2 days` = mean(later_bail_type_flag),
            `Cite & Release release type after 2 days` = mean(later_cite_type_flag),
            `OR release type after 2 days` = mean(later_or_type_flag)) 

write.xlsx(arrest_charge_level_df, file = "I:/Random for Shelley/2021.06.03 pretrial stuff/2A offense type - ALL MISDO BOOKINGS using release type.xlsx", asTable = F)

arrest_charge_level_df <- full_df %>%
  mutate(release_cat = case_when(release_type %in% c("Cite_Release", "Non_Zero_Bail", "OR", "Unknown_Bail", "Zero_Bail") ~ "Pretrial release type",
                                 release_type %in% c("Detain_Only", "Dismissed_Dropped", "Sentenced", "Time_Served") ~ "Post-resolution release type",
                                 release_type %in% c("Hold_Release", "Other", "Unknown") ~ "Unclear release type",
                                 T ~ "Unclear release type")) %>%
  filter(new_arrest_flag == 1,
         arrest_charge_level == "Felony") %>%
  mutate(pre_trial_release_flag = if_else(release_cat == "Pretrial release type", 1, 0)) %>%
  mutate(two_day_release = case_when(
    weekdays(book_date) == "Thursday" & release_date - book_date <= 4 ~ 1,
    weekdays(book_date) == "Friday" & release_date - book_date <= 4 ~ 1,
    weekdays(book_date) == "Saturday" & release_date - book_date <= 3 ~ 1,
    !weekdays(book_date) %in% c("Thursday", "Friday", "Saturday") & release_date - book_date <= 2 ~ 1,
    is.na(release_date) ~ 0,
    T ~ 0)) %>%
  mutate(quick_pretrial_type_flag = if_else(two_day_release == 1 & release_cat == "Pretrial release type", 1, 0),
         #quick_postres_type_flag = if_else(two_day_release == 1 & release_cat == "Post-resolution release type", 1, 0),
         quick_bail_type_flag = if_else(two_day_release == 1 & release_type %in% c("Non_Zero_Bail", "Zero_Bail", "Unknown_Bail"), 1, 0),
         quick_cite_type_flag = if_else(two_day_release == 1 & release_type %in% c("Cite_Release"), 1, 0),
         quick_or_type_flag = if_else(two_day_release == 1 & release_type %in% c("OR"), 1, 0),
         quick_unknown_type_flag = if_else(two_day_release == 1 & release_cat == "Unclear release type", 1, 0),
         convicted_flag = if_else(is.na(convicted_flag), 0, convicted_flag),
         #conviction = if_else(conviction_felony_flag == 1 | conviction_misd_flag == 1 | conviction_flag == 1 | convicted_flag == 1, 1, 0),
         closed_convicted_flag = if_else(two_day_release == 1 & release_type %in% c("Sentenced", "Time_Served"), 1, 0),
         closed_not_convicted_flag = if_else(two_day_release == 1 & release_type %in% c("Detain_Only", "Dismissed_Dropped"), 1, 0),
         later_pretrial_type_flag = if_else(two_day_release == 0 & release_cat == "Pretrial release type", 1, 0),
         later_bail_type_flag = if_else(two_day_release == 0 & release_type %in% c("Non_Zero_Bail", "Zero_Bail", "Unknown_Bail"), 1, 0),
         later_cite_type_flag = if_else(two_day_release == 0 & release_type %in% c("Cite_Release"), 1, 0),
         later_or_type_flag = if_else(two_day_release == 0 & release_type %in% c("OR"), 1, 0)) %>%
  group_by(County) %>%
  summarise(Total = n(),
            `No charges filed, charges dropped, or case dismissed within 2 court days` = mean(closed_not_convicted_flag),
            `Convicted within 2 court days` = mean(closed_convicted_flag),
            #`Released - (C) Pretrial release (OR or bail) within 2 court days` = mean(pre_arraignment_flag),
            `Bail release type within 2 court days` = mean(quick_bail_type_flag),
            `Cite & Release release type within 2 court days` = mean(quick_cite_type_flag),
            `OR release type within 2 court days` = mean(quick_or_type_flag),
            #`Released - Post-resolution release type` = mean(quick_postres_type_flag),
            `Unclear release type (post-resolution or pretrial) within 2 court days` = mean(quick_unknown_type_flag),
            `TOTAL: Released within 2 court days` = mean(two_day_release), 
            `Bail release type after 2 days` = mean(later_bail_type_flag),
            `Cite & Release release type after 2 days` = mean(later_cite_type_flag),
            `OR release type after 2 days` = mean(later_or_type_flag)) 

write.xlsx(arrest_charge_level_df, file = "I:/Random for Shelley/2021.06.03 pretrial stuff/2A offense type - ALL FELONY BOOKINGS using release type.xlsx", asTable = F)
```

OLD *** FILTERED TO RESOLVED BOOKINGS using pretrial release date only: Look at counties with bad matching and use their release types to determine whether release was pretrial or not
```{r}
#look at ppl who do not have completed pretrial periods
#this may falsely represent pretrial releases for counties that have poor court data matching, because they may be released due to a disposition that we do not have a record of

# release_type variable may not be a reliable indicator of pretrial release, but going to try to use it here anyway just to see

arrest_charge_level_df <- full_df %>%
  mutate(release_cat = case_when(release_type %in% c("Cite_Release", "Non_Zero_Bail", "OR", "Unknown_Bail", "Zero_Bail") ~ "Pretrial release type",
                                 release_type %in% c("Detain_Only", "Dismissed_Dropped", "Sentenced", "Time_Served") ~ "Post-resolution release type",
                                 release_type %in% c("Hold_Release", "Other", "Unknown") ~ "Unclear release type",
                                 T ~ "Unclear release type")) %>%
  filter(!is.na(pretrial_end_date),
         new_arrest_flag == 1) %>%
  mutate(pre_trial_release_flag = if_else(release_cat == "Pretrial release type", 1, 0)) %>%
  mutate(two_day_release = case_when(
    weekdays(book_date) == "Thursday" & release_date - book_date <= 4 ~ 1,
    weekdays(book_date) == "Friday" & release_date - book_date <= 4 ~ 1,
    weekdays(book_date) == "Saturday" & release_date - book_date <= 3 ~ 1,
    !weekdays(book_date) %in% c("Thursday", "Friday", "Saturday") & release_date - book_date <= 2 ~ 1,
    is.na(release_date) ~ 0,
    T ~ 0)) %>%
  mutate(quick_pretrial_type_flag = if_else(two_day_release == 1 & release_cat == "Pretrial release type", 1, 0),
         #quick_postres_type_flag = if_else(two_day_release == 1 & release_cat == "Post-resolution release type", 1, 0),
         quick_bail_type_flag = if_else(two_day_release == 1 & release_type %in% c("Non_Zero_Bail", "Zero_Bail", "Unknown_Bail"), 1, 0),
         quick_cite_type_flag = if_else(two_day_release == 1 & release_type %in% c("Cite_Release"), 1, 0),
         quick_or_type_flag = if_else(two_day_release == 1 & release_type %in% c("OR"), 1, 0),
         quick_unknown_type_flag = if_else(two_day_release == 1 & release_cat == "Unclear release type", 1, 0),
         convicted_flag = if_else(is.na(convicted_flag), 0, convicted_flag),
         #conviction = if_else(conviction_felony_flag == 1 | conviction_misd_flag == 1 | conviction_flag == 1 | convicted_flag == 1, 1, 0),
         closed_convicted_flag = if_else(two_day_release == 1 & release_type %in% c("Sentenced", "Time_Served"), 1, 0),
         closed_not_convicted_flag = if_else(two_day_release == 1 & release_type %in% c("Detain_Only", "Dismissed_Dropped"), 1, 0),
         later_pretrial_type_flag = if_else(two_day_release == 0 & release_cat == "Pretrial release type", 1, 0),
         later_bail_type_flag = if_else(two_day_release == 0 & release_type %in% c("Non_Zero_Bail", "Zero_Bail", "Unknown_Bail"), 1, 0),
         later_cite_type_flag = if_else(two_day_release == 0 & release_type %in% c("Cite_Release"), 1, 0),
         later_or_type_flag = if_else(two_day_release == 0 & release_type %in% c("OR"), 1, 0)) %>%
  group_by(County, arrest_charge_level) %>%
  summarise(Total = n(),
            `Charges dropped or case dismissed within 2 court days` = mean(closed_not_convicted_flag),
            `Convicted within 2 court days` = mean(closed_convicted_flag),
            #`Released - (C) Pretrial release (OR or bail) within 2 court days` = mean(pre_arraignment_flag),
            `Bail release type within 2 court days` = mean(quick_bail_type_flag),
            `Cite & Release release type within 2 court days` = mean(quick_cite_type_flag),
            `OR release type within 2 court days` = mean(quick_or_type_flag),
            #`Released - Post-resolution release type` = mean(quick_postres_type_flag),
            `Unclear release type (post-resolution or pretrial) within 2 court days` = mean(quick_unknown_type_flag),
            `TOTAL: Released within 2 court days` = mean(two_day_release), 
            `Bail release type after 2 days` = mean(later_bail_type_flag),
            `Cite & Release release type after 2 days` = mean(later_cite_type_flag),
            `OR release type after 2 days` = mean(later_or_type_flag)) %>%
  filter(arrest_charge_level %in% c("Felony", "Misdemeanor")) %>%
  rename(`Arrest Charge Level` = arrest_charge_level) %>%
  arrange(desc(`Arrest Charge Level`))

write.xlsx(arrest_charge_level_df, file = "I:/Random for Shelley/2021.06.03 pretrial stuff/2A offense type - RESOLVED CASES ONLY using release type draft2.xlsx", asTable = F)
```

FILTERED TO RESOLVED BOOKINGS using pretrial release date and also post-resolution release types: Look at counties with bad matching and use their release types to determine whether release was pretrial or not
```{r}
#look at ppl who do not have completed pretrial periods
#this may falsely represent pretrial releases for counties that have poor court data matching, because they may be released due to a disposition that we do not have a record of

# release_type variable may not be a reliable indicator of pretrial release, but going to try to use it here anyway just to see

arrest_charge_level_df <- full_df %>%
  mutate(release_cat = case_when(release_type %in% c("Cite_Release", "Non_Zero_Bail", "OR", "Unknown_Bail", "Zero_Bail") ~ "Pretrial release type",
                                 release_type %in% c("Detain_Only", "Dismissed_Dropped", "Sentenced", "Time_Served") ~ "Post-resolution release type",
                                 release_type %in% c("Hold_Release", "Other", "Unknown") ~ "Unclear release type",
                                 T ~ "Unclear release type")) %>%
  mutate(has_end_flag = if_else(is.na(pretrial_end_date), 0, 1)) %>%
  mutate(has_end_flag = if_else(release_cat == "Post-resolution release type", 1, has_end_flag)) %>%
  filter(has_end_flag == 1,
         new_arrest_flag == 1) %>%
  mutate(pre_trial_release_flag = if_else(release_cat == "Pretrial release type", 1, 0)) %>%
  mutate(two_day_release = case_when(
    weekdays(book_date) == "Thursday" & release_date - book_date <= 4 ~ 1,
    weekdays(book_date) == "Friday" & release_date - book_date <= 4 ~ 1,
    weekdays(book_date) == "Saturday" & release_date - book_date <= 3 ~ 1,
    !weekdays(book_date) %in% c("Thursday", "Friday", "Saturday") & release_date - book_date <= 2 ~ 1,
    is.na(release_date) ~ 0,
    T ~ 0)) %>%
  mutate(quick_pretrial_type_flag = if_else(two_day_release == 1 & release_cat == "Pretrial release type", 1, 0),
         #quick_postres_type_flag = if_else(two_day_release == 1 & release_cat == "Post-resolution release type", 1, 0),
         quick_bail_type_flag = if_else(two_day_release == 1 & release_type %in% c("Non_Zero_Bail", "Zero_Bail", "Unknown_Bail"), 1, 0),
         quick_cite_type_flag = if_else(two_day_release == 1 & release_type %in% c("Cite_Release"), 1, 0),
         quick_or_type_flag = if_else(two_day_release == 1 & release_type %in% c("OR"), 1, 0),
         quick_unknown_type_flag = if_else(two_day_release == 1 & release_cat == "Unclear release type", 1, 0),
         convicted_flag = if_else(is.na(convicted_flag), 0, convicted_flag),
         #conviction = if_else(conviction_felony_flag == 1 | conviction_misd_flag == 1 | conviction_flag == 1 | convicted_flag == 1, 1, 0),
         closed_convicted_flag = if_else(two_day_release == 1 & release_type %in% c("Sentenced", "Time_Served"), 1, 0),
         closed_not_convicted_flag = if_else(two_day_release == 1 & release_type %in% c("Detain_Only", "Dismissed_Dropped"), 1, 0),
         later_pretrial_type_flag = if_else(two_day_release == 0 & release_cat == "Pretrial release type", 1, 0),
         later_bail_type_flag = if_else(two_day_release == 0 & release_type %in% c("Non_Zero_Bail", "Zero_Bail", "Unknown_Bail"), 1, 0),
         later_cite_type_flag = if_else(two_day_release == 0 & release_type %in% c("Cite_Release"), 1, 0),
         later_or_type_flag = if_else(two_day_release == 0 & release_type %in% c("OR"), 1, 0)) %>%
  group_by(County, arrest_charge_level) %>%
  summarise(Total = n(),
            `Charges dropped or case dismissed within 2 court days` = mean(closed_not_convicted_flag),
            `Convicted within 2 court days` = mean(closed_convicted_flag),
            #`Released - (C) Pretrial release (OR or bail) within 2 court days` = mean(pre_arraignment_flag),
            `Bail release type within 2 court days` = mean(quick_bail_type_flag),
            `Cite & Release release type within 2 court days` = mean(quick_cite_type_flag),
            `OR release type within 2 court days` = mean(quick_or_type_flag),
            #`Released - Post-resolution release type` = mean(quick_postres_type_flag),
            `Unclear release type (post-resolution or pretrial) within 2 court days` = mean(quick_unknown_type_flag),
            `TOTAL: Released within 2 court days` = mean(two_day_release), 
            `Bail release type after 2 days` = mean(later_bail_type_flag),
            `Cite & Release release type after 2 days` = mean(later_cite_type_flag),
            `OR release type after 2 days` = mean(later_or_type_flag)) %>%
  filter(arrest_charge_level %in% c("Felony", "Misdemeanor")) %>%
  rename(`Arrest Charge Level` = arrest_charge_level) %>%
  arrange(desc(`Arrest Charge Level`))

write.xlsx(arrest_charge_level_df, file = "I:/Random for Shelley/2021.06.03 pretrial stuff/2A offense type - RESOLVED CASES ONLY using release type draft5 changed filter.xlsx", asTable = F)
```
Combined side by side all vs resolved only
```{r}
arrest_charge_level_df <- full_df %>%
  mutate(release_cat = case_when(release_type %in% c("Cite_Release", "Non_Zero_Bail", "OR", "Unknown_Bail", "Zero_Bail") ~ "Pretrial release type",
                                 release_type %in% c("Detain_Only", "Dismissed_Dropped", "Sentenced", "Time_Served") ~ "Post-resolution release type",
                                 release_type %in% c("Hold_Release", "Other", "Unknown") ~ "Unclear release type",
                                 T ~ "Unclear release type")) %>%
  filter(new_arrest_flag == 1) %>%
  mutate(pre_trial_release_flag = if_else(release_cat == "Pretrial release type", 1, 0)) %>%
  mutate(two_day_release = case_when(
    weekdays(book_date) == "Thursday" & release_date - book_date <= 4 ~ 1,
    weekdays(book_date) == "Friday" & release_date - book_date <= 4 ~ 1,
    weekdays(book_date) == "Saturday" & release_date - book_date <= 3 ~ 1,
    !weekdays(book_date) %in% c("Thursday", "Friday", "Saturday") & release_date - book_date <= 2 ~ 1,
    is.na(release_date) ~ 0,
    T ~ 0)) %>%
  mutate(quick_pretrial_type_flag = if_else(two_day_release == 1 & release_cat == "Pretrial release type", 1, 0),
         #quick_postres_type_flag = if_else(two_day_release == 1 & release_cat == "Post-resolution release type", 1, 0),
         quick_bail_type_flag = if_else(two_day_release == 1 & release_type %in% c("Non_Zero_Bail", "Zero_Bail", "Unknown_Bail"), 1, 0),
         quick_cite_type_flag = if_else(two_day_release == 1 & release_type %in% c("Cite_Release"), 1, 0),
         quick_or_type_flag = if_else(two_day_release == 1 & release_type %in% c("OR"), 1, 0),
         quick_unknown_type_flag = if_else(two_day_release == 1 & release_cat == "Unclear release type", 1, 0),
         convicted_flag = if_else(is.na(convicted_flag), 0, convicted_flag),
         #conviction = if_else(conviction_felony_flag == 1 | conviction_misd_flag == 1 | conviction_flag == 1 | convicted_flag == 1, 1, 0),
         closed_convicted_flag = if_else(two_day_release == 1 & release_type %in% c("Sentenced", "Time_Served"), 1, 0),
         closed_not_convicted_flag = if_else(two_day_release == 1 & release_type %in% c("Detain_Only", "Dismissed_Dropped"), 1, 0),
         later_pretrial_type_flag = if_else(two_day_release == 0 & release_cat == "Pretrial release type", 1, 0),
         later_bail_type_flag = if_else(two_day_release == 0 & release_type %in% c("Non_Zero_Bail", "Zero_Bail", "Unknown_Bail"), 1, 0),
         later_cite_type_flag = if_else(two_day_release == 0 & release_type %in% c("Cite_Release"), 1, 0),
         later_or_type_flag = if_else(two_day_release == 0 & release_type %in% c("OR"), 1, 0)) %>%
  group_by(County, arrest_charge_level) %>%
  summarise(Total = n(),
            `Charges dropped or case dismissed within 2 court days` = mean(closed_not_convicted_flag),
            `Convicted within 2 court days` = mean(closed_convicted_flag),
            #`Released - (C) Pretrial release (OR or bail) within 2 court days` = mean(pre_arraignment_flag),
            `Bail release type within 2 court days` = mean(quick_bail_type_flag),
            `Cite & Release release type within 2 court days` = mean(quick_cite_type_flag),
            `OR release type within 2 court days` = mean(quick_or_type_flag),
            #`Released - Post-resolution release type` = mean(quick_postres_type_flag),
            `Unclear release type (post-resolution or pretrial) within 2 court days` = mean(quick_unknown_type_flag),
            `TOTAL: Released within 2 court days` = mean(two_day_release), 
            `Bail release type after 2 days` = mean(later_bail_type_flag),
            `Cite & Release release type after 2 days` = mean(later_cite_type_flag),
            `OR release type after 2 days` = mean(later_or_type_flag)) %>%
  filter(arrest_charge_level %in% c("Felony", "Misdemeanor")) %>%
  rename(`Arrest Charge Level` = arrest_charge_level) %>%
  arrange(desc(`Arrest Charge Level`))

arrest_charge_level_df_filtered <- full_df %>%
  mutate(release_cat = case_when(release_type %in% c("Cite_Release", "Non_Zero_Bail", "OR", "Unknown_Bail", "Zero_Bail") ~ "Pretrial release type",
                                 release_type %in% c("Detain_Only", "Dismissed_Dropped", "Sentenced", "Time_Served") ~ "Post-resolution release type",
                                 release_type %in% c("Hold_Release", "Other", "Unknown") ~ "Unclear release type",
                                 T ~ "Unclear release type")) %>%
  mutate(has_end_flag = if_else(is.na(pretrial_end_date), 0, 1)) %>%
  mutate(has_end_flag = if_else(release_cat == "Post-resolution release type", 1, has_end_flag)) %>%
  filter(has_end_flag == 1,
         new_arrest_flag == 1) %>%
  mutate(pre_trial_release_flag = if_else(release_cat == "Pretrial release type", 1, 0)) %>%
  mutate(two_day_release = case_when(
    weekdays(book_date) == "Thursday" & release_date - book_date <= 4 ~ 1,
    weekdays(book_date) == "Friday" & release_date - book_date <= 4 ~ 1,
    weekdays(book_date) == "Saturday" & release_date - book_date <= 3 ~ 1,
    !weekdays(book_date) %in% c("Thursday", "Friday", "Saturday") & release_date - book_date <= 2 ~ 1,
    is.na(release_date) ~ 0,
    T ~ 0)) %>%
  mutate(quick_pretrial_type_flag = if_else(two_day_release == 1 & release_cat == "Pretrial release type", 1, 0),
         #quick_postres_type_flag = if_else(two_day_release == 1 & release_cat == "Post-resolution release type", 1, 0),
         quick_bail_type_flag = if_else(two_day_release == 1 & release_type %in% c("Non_Zero_Bail", "Zero_Bail", "Unknown_Bail"), 1, 0),
         quick_cite_type_flag = if_else(two_day_release == 1 & release_type %in% c("Cite_Release"), 1, 0),
         quick_or_type_flag = if_else(two_day_release == 1 & release_type %in% c("OR"), 1, 0),
         quick_unknown_type_flag = if_else(two_day_release == 1 & release_cat == "Unclear release type", 1, 0),
         convicted_flag = if_else(is.na(convicted_flag), 0, convicted_flag),
         #conviction = if_else(conviction_felony_flag == 1 | conviction_misd_flag == 1 | conviction_flag == 1 | convicted_flag == 1, 1, 0),
         closed_convicted_flag = if_else(two_day_release == 1 & release_type %in% c("Sentenced", "Time_Served"), 1, 0),
         closed_not_convicted_flag = if_else(two_day_release == 1 & release_type %in% c("Detain_Only", "Dismissed_Dropped"), 1, 0),
         later_pretrial_type_flag = if_else(two_day_release == 0 & release_cat == "Pretrial release type", 1, 0),
         later_bail_type_flag = if_else(two_day_release == 0 & release_type %in% c("Non_Zero_Bail", "Zero_Bail", "Unknown_Bail"), 1, 0),
         later_cite_type_flag = if_else(two_day_release == 0 & release_type %in% c("Cite_Release"), 1, 0),
         later_or_type_flag = if_else(two_day_release == 0 & release_type %in% c("OR"), 1, 0)) %>%
  group_by(County, arrest_charge_level) %>%
  summarise(Total = n(),
            `Charges dropped or case dismissed within 2 court days` = mean(closed_not_convicted_flag),
            `Convicted within 2 court days` = mean(closed_convicted_flag),
            #`Released - (C) Pretrial release (OR or bail) within 2 court days` = mean(pre_arraignment_flag),
            `Bail release type within 2 court days` = mean(quick_bail_type_flag),
            `Cite & Release release type within 2 court days` = mean(quick_cite_type_flag),
            `OR release type within 2 court days` = mean(quick_or_type_flag),
            #`Released - Post-resolution release type` = mean(quick_postres_type_flag),
            `Unclear release type (post-resolution or pretrial) within 2 court days` = mean(quick_unknown_type_flag),
            `TOTAL: Released within 2 court days` = mean(two_day_release), 
            `Bail release type after 2 days` = mean(later_bail_type_flag),
            `Cite & Release release type after 2 days` = mean(later_cite_type_flag),
            `OR release type after 2 days` = mean(later_or_type_flag)) %>%
  filter(arrest_charge_level %in% c("Felony", "Misdemeanor")) %>%
  rename(`Arrest Charge Level` = arrest_charge_level) %>%
  arrange(desc(`Arrest Charge Level`))

arrest_charge_level_df <- arrest_charge_level_df %>%
  left_join(arrest_charge_level_df_filtered, by = c("County", "Arrest Charge Level"))

arrest_charge_level_df <- arrest_charge_level_df %>%
  select(County, `Arrest Charge Level`, Total.x, Total.y, 
         `Charges dropped or case dismissed within 2 court days.x`, `Charges dropped or case dismissed within 2 court days.y`,
         `Convicted within 2 court days.x`, `Convicted within 2 court days.y`,
         `Bail release type within 2 court days.x`, `Bail release type within 2 court days.y`,
         `Cite & Release release type within 2 court days.x`, `Cite & Release release type within 2 court days.y`,
         `OR release type within 2 court days.x`, `OR release type within 2 court days.y`,
         `Unclear release type (post-resolution or pretrial) within 2 court days.x`, `Unclear release type (post-resolution or pretrial) within 2 court days.y`,
         `TOTAL: Released within 2 court days.x`, `TOTAL: Released within 2 court days.y`,
         `Bail release type after 2 days.x`, `Bail release type after 2 days.y`,
         `Cite & Release release type after 2 days.x`, `Cite & Release release type after 2 days.y`,
         `OR release type after 2 days.x`, `OR release type after 2 days.y`)

arrest_charge_level_df <- arrest_charge_level_df %>%
  mutate(across(Total.x:Total.y, ~formatC(.x, big.mark = ","))) %>%
  #mutate(across(`Charges dropped or case dismissed within 2 court days.x`:`OR release type after 2 days.y`, ~round(.x*100))) %>%
  mutate(across(`Charges dropped or case dismissed within 2 court days.x`:`OR release type after 2 days.y`, ~percent(.x, accuracy = 1))) %>%
  unite("Total ALL/RESOLVED", c(Total.x, Total.y), sep = "/") %>%
  unite(`No charges filed, charges dropped, or case dismissed within 2 court days`, c(`Charges dropped or case dismissed within 2 court days.x`, `Charges dropped or case dismissed within 2 court days.y`), sep = "/") %>%
  unite(`Convicted within 2 court days`, c(`Convicted within 2 court days.x`, `Convicted within 2 court days.y`), sep = "/") %>%
  unite(`Bail release type within 2 court days`, c(`Bail release type within 2 court days.x`, `Bail release type within 2 court days.y`), sep = "/") %>%
  unite(`Cite & Release release type within 2 court days`, c(`Cite & Release release type within 2 court days.x`, `Cite & Release release type within 2 court days.y`), sep = "/") %>%
  unite(`OR release type within 2 court days`, c(`OR release type within 2 court days.x`, `OR release type within 2 court days.y`), sep = "/") %>%
  unite(`Unclear release type (post-resolution or pretrial) within 2 court days`, c(`Unclear release type (post-resolution or pretrial) within 2 court days.x`, `Unclear release type (post-resolution or pretrial) within 2 court days.y`), sep = "/") %>%
  unite(`TOTAL: Released within 2 court days`, c(`TOTAL: Released within 2 court days.x`, `TOTAL: Released within 2 court days.y`), sep = "/") %>%
  unite(`Bail release type after 2 days`, c(`Bail release type after 2 days.x`, `Bail release type after 2 days.y`), sep = "/") %>%
  unite(`Cite & Release release type after 2 days`, c(`Cite & Release release type after 2 days.x`, `Cite & Release release type after 2 days.y`), sep = "/") %>%
  unite(`OR release type after 2 days`, c(`OR release type after 2 days.x`, `OR release type after 2 days.y`), sep = "/")

write.xlsx(arrest_charge_level_df, file = "I:/Random for Shelley/2021.06.03 pretrial stuff/2A offense type - ALL vs RESOLVED CASES ONLY using release type.xlsx", asTable = F)
```

DIFFERENCES
```{r}
#look at ppl who do not have completed pretrial periods vs all bookings
#this may falsely represent pretrial releases for counties that have poor court data matching, because they may be released due to a disposition that we do not have a record of

# release_type variable may not be a reliable indicator of pretrial release, but going to try to use it here anyway just to see

arrest_charge_level_df_filtered <- full_df %>%
  mutate(release_cat = case_when(release_type %in% c("Cite_Release", "Non_Zero_Bail", "OR", "Unknown_Bail", "Zero_Bail") ~ "Pretrial release type",
                                 release_type %in% c("Detain_Only", "Dismissed_Dropped", "Sentenced", "Time_Served") ~ "Post-resolution release type",
                                 release_type %in% c("Hold_Release", "Other", "Unknown") ~ "Unclear release type",
                                 T ~ "Unclear release type")) %>%
  mutate(has_end_flag = if_else(is.na(pretrial_end_date), 0, 1)) %>%
  mutate(has_end_flag = if_else(release_cat == "Post-resolution release type", 1, has_end_flag)) %>%
  filter(has_end_flag == 1,
         new_arrest_flag == 1) %>%
  mutate(pre_trial_release_flag = if_else(release_cat == "Pretrial release type", 1, 0)) %>%
  mutate(two_day_release = case_when(
    weekdays(book_date) == "Thursday" & release_date - book_date <= 4 ~ 1,
    weekdays(book_date) == "Friday" & release_date - book_date <= 4 ~ 1,
    weekdays(book_date) == "Saturday" & release_date - book_date <= 3 ~ 1,
    !weekdays(book_date) %in% c("Thursday", "Friday", "Saturday") & release_date - book_date <= 2 ~ 1,
    is.na(release_date) ~ 0,
    T ~ 0)) %>%
  mutate(quick_pretrial_type_flag = if_else(two_day_release == 1 & release_cat == "Pretrial release type", 1, 0),
         #quick_postres_type_flag = if_else(two_day_release == 1 & release_cat == "Post-resolution release type", 1, 0),
         quick_bail_type_flag = if_else(two_day_release == 1 & release_type %in% c("Non_Zero_Bail", "Zero_Bail", "Unknown_Bail"), 1, 0),
         quick_cite_type_flag = if_else(two_day_release == 1 & release_type %in% c("Cite_Release"), 1, 0),
         quick_or_type_flag = if_else(two_day_release == 1 & release_type %in% c("OR"), 1, 0),
         quick_unknown_type_flag = if_else(two_day_release == 1 & release_cat == "Unclear release type", 1, 0),
         convicted_flag = if_else(is.na(convicted_flag), 0, convicted_flag),
         #conviction = if_else(conviction_felony_flag == 1 | conviction_misd_flag == 1 | conviction_flag == 1 | convicted_flag == 1, 1, 0),
         closed_convicted_flag = if_else(two_day_release == 1 & release_type %in% c("Sentenced", "Time_Served"), 1, 0),
         closed_not_convicted_flag = if_else(two_day_release == 1 & release_type %in% c("Detain_Only", "Dismissed_Dropped"), 1, 0),
         later_pretrial_type_flag = if_else(two_day_release == 0 & release_cat == "Pretrial release type", 1, 0),
         later_bail_type_flag = if_else(two_day_release == 0 & release_type %in% c("Non_Zero_Bail", "Zero_Bail", "Unknown_Bail"), 1, 0),
         later_cite_type_flag = if_else(two_day_release == 0 & release_type %in% c("Cite_Release"), 1, 0),
         later_or_type_flag = if_else(two_day_release == 0 & release_type %in% c("OR"), 1, 0)) %>%
  group_by(County, arrest_charge_level) %>%
  summarise(`Total filtered` = n(),
            #`Charges dropped or case dismissed within 2 court days` = mean(closed_not_convicted_flag),
            #`Convicted within 2 court days` = mean(closed_convicted_flag),
            #`Released - (C) Pretrial release (OR or bail) within 2 court days` = mean(pre_arraignment_flag),
            #`Bail release type within 2 court days` = mean(quick_bail_type_flag),
            #`Cite & Release release type within 2 court days` = mean(quick_cite_type_flag),
            #`OR release type within 2 court days` = mean(quick_or_type_flag),
            #`Released - Post-resolution release type` = mean(quick_postres_type_flag),
            #`Unclear release type (post-resolution or pretrial) within 2 court days` = mean(quick_unknown_type_flag),
            `FILTERED to resolved bookings: Total Released within 2 court days` = mean(two_day_release), 
            #`Bail release type after 2 days` = mean(later_bail_type_flag),
            #`Cite & Release release type after 2 days` = mean(later_cite_type_flag),
            #`OR release type after 2 days` = mean(later_or_type_flag)
            ) %>%
  filter(arrest_charge_level %in% c("Felony", "Misdemeanor")) %>%
  rename(`Arrest Charge Level` = arrest_charge_level) %>%
  arrange(desc(`Arrest Charge Level`))
  
arrest_charge_level_df <- full_df %>%
  mutate(release_cat = case_when(release_type %in% c("Cite_Release", "Non_Zero_Bail", "OR", "Unknown_Bail", "Zero_Bail") ~ "Pretrial release type",
                                 release_type %in% c("Detain_Only", "Dismissed_Dropped", "Sentenced", "Time_Served") ~ "Post-resolution release type",
                                 release_type %in% c("Hold_Release", "Other", "Unknown") ~ "Unclear release type",
                                 T ~ "Unclear release type")) %>%
  filter(new_arrest_flag == 1) %>%
  mutate(pre_trial_release_flag = if_else(release_cat == "Pretrial release type", 1, 0)) %>%
  mutate(two_day_release = case_when(
    weekdays(book_date) == "Thursday" & release_date - book_date <= 4 ~ 1,
    weekdays(book_date) == "Friday" & release_date - book_date <= 4 ~ 1,
    weekdays(book_date) == "Saturday" & release_date - book_date <= 3 ~ 1,
    !weekdays(book_date) %in% c("Thursday", "Friday", "Saturday") & release_date - book_date <= 2 ~ 1,
    is.na(release_date) ~ 0,
    T ~ 0)) %>%
  mutate(quick_pretrial_type_flag = if_else(two_day_release == 1 & release_cat == "Pretrial release type", 1, 0),
         #quick_postres_type_flag = if_else(two_day_release == 1 & release_cat == "Post-resolution release type", 1, 0),
         quick_bail_type_flag = if_else(two_day_release == 1 & release_type %in% c("Non_Zero_Bail", "Zero_Bail", "Unknown_Bail"), 1, 0),
         quick_cite_type_flag = if_else(two_day_release == 1 & release_type %in% c("Cite_Release"), 1, 0),
         quick_or_type_flag = if_else(two_day_release == 1 & release_type %in% c("OR"), 1, 0),
         quick_unknown_type_flag = if_else(two_day_release == 1 & release_cat == "Unclear release type", 1, 0),
         convicted_flag = if_else(is.na(convicted_flag), 0, convicted_flag),
         #conviction = if_else(conviction_felony_flag == 1 | conviction_misd_flag == 1 | conviction_flag == 1 | convicted_flag == 1, 1, 0),
         closed_convicted_flag = if_else(two_day_release == 1 & release_type %in% c("Sentenced", "Time_Served"), 1, 0),
         closed_not_convicted_flag = if_else(two_day_release == 1 & release_type %in% c("Detain_Only", "Dismissed_Dropped"), 1, 0),
         later_pretrial_type_flag = if_else(two_day_release == 0 & release_cat == "Pretrial release type", 1, 0),
         later_bail_type_flag = if_else(two_day_release == 0 & release_type %in% c("Non_Zero_Bail", "Zero_Bail", "Unknown_Bail"), 1, 0),
         later_cite_type_flag = if_else(two_day_release == 0 & release_type %in% c("Cite_Release"), 1, 0),
         later_or_type_flag = if_else(two_day_release == 0 & release_type %in% c("OR"), 1, 0)) %>%
  group_by(County, arrest_charge_level) %>%
  summarise(`Total unfiltered` = n(),
            #`Charges dropped or case dismissed within 2 court days` = mean(closed_not_convicted_flag),
            #`Convicted within 2 court days` = mean(closed_convicted_flag),
            #`Released - (C) Pretrial release (OR or bail) within 2 court days` = mean(pre_arraignment_flag),
            #`Bail release type within 2 court days` = mean(quick_bail_type_flag),
            #`Cite & Release release type within 2 court days` = mean(quick_cite_type_flag),
            #`OR release type within 2 court days` = mean(quick_or_type_flag),
            #`Released - Post-resolution release type` = mean(quick_postres_type_flag),
            #`Unclear release type (post-resolution or pretrial) within 2 court days` = mean(quick_unknown_type_flag),
            `ALL bookings: Total Released within 2 court days` = mean(two_day_release), 
            #`Bail release type after 2 days` = mean(later_bail_type_flag),
            #`Cite & Release release type after 2 days` = mean(later_cite_type_flag),
            #`OR release type after 2 days` = mean(later_or_type_flag)
            ) %>%
  filter(arrest_charge_level %in% c("Felony", "Misdemeanor")) %>%
  rename(`Arrest Charge Level` = arrest_charge_level) %>%
  arrange(desc(`Arrest Charge Level`))
  
arrest_charge_level_df <- left_join(arrest_charge_level_df, arrest_charge_level_df_filtered)

arrest_charge_level_df <- arrest_charge_level_df %>%
  mutate(`FILTERED total/ALL total` = `Total filtered`/`Total unfiltered`) %>%
  mutate(Difference = `ALL bookings: Total Released within 2 court days` - `FILTERED to resolved bookings: Total Released within 2 court days`) %>%
  arrange(desc(Difference))

write.xlsx(arrest_charge_level_df, file = "I:/Random for Shelley/2021.06.03 pretrial stuff/2A offense type - resolved vs all 2 day releases using release type v4.xlsx", asTable = F)
```

Look at conflict between release_type and date-calculated pretrial release flag, for people released
```{r}
full_df %>%
  mutate(release_cat = case_when(release_type %in% c("Cite_Release", "Non_Zero_Bail", "OR", "Unknown_Bail", "Zero_Bail") ~ "Pretrial release type",
                                 release_type %in% c("Detain_Only", "Dismissed_Dropped", "Sentenced", "Time_Served") ~ "Post-resolution release type",
                                 release_type %in% c("Hold_Release", "Other", "Unknown") ~ "Unclear release type",
                                 T ~ "Unclear release type")) %>%
  filter(new_arrest_flag == 1,
         !is.na(release_date),
         release_cat != "Unclear release type") %>%
  mutate(pre_trial_release_flag = case_when(is.na(release_date) ~ 0,
                                            is.na(pretrial_end_date) & !is.na(release_date) ~ 1,
                                            release_date >= pretrial_end_date ~ 0,
                                            release_date < pretrial_end_date ~ 1,
                                            T ~ NA_real_)) %>%
  count(pre_trial_release_flag, release_cat) %>%
  mutate(percent = round(n/sum(n)*100))

# Look at conflict between release_type and whether there is a pretrial_end_date (for post-resolution release types)
full_df %>%
  mutate(release_cat = case_when(release_type %in% c("Cite_Release", "Non_Zero_Bail", "OR", "Unknown_Bail", "Zero_Bail") ~ "Pretrial release type",
                                 release_type %in% c("Detain_Only", "Dismissed_Dropped", "Sentenced", "Time_Served") ~ "Post-resolution release type",
                                 release_type %in% c("Hold_Release", "Other", "Unknown") ~ "Unclear release type",
                                 T ~ "Unclear release type")) %>%
  filter(new_arrest_flag == 1,
         !is.na(release_date),
         release_cat == "Post-resolution release type") %>%
  mutate(pre_trial_enddate_flag = if_else(is.na(pretrial_end_date), 0, 1)) %>%
  count(County, pre_trial_enddate_flag) %>%
  group_by(County) %>%
  mutate(percent = round(n/sum(n)*100)) %>%
  filter(pre_trial_enddate_flag == 0) %>%
  arrange(desc(percent))


full_df %>%
  #filter(County == "Los Angeles") %>%
  count(release_type, release_type_original) %>%
  arrange(desc(n))

full_df %>%
  filter(release_type_original == "CUST") %>%
  count(County)

full_df %>%
  filter(release_type == "Zero_Bail") %>%
  count(release_type_original)

full_df %>%
  count(is.na(pretrial_end_date), is.na(pretrial_end_date_doj))

full_df %>%
  filter(release_type_original == "TEMPORARY EMERGENCY CITATION") %>%
  count(county)

full_df %>%
  #filter(book_type == "Unknown") %>%
  count(county, book_type)

full_df %>%
  filter(county == "San Joaquin") %>%
  count(new_arrest_flag, book_type)

new_arrest_flag_table <- full_df %>%
  count(new_arrest_flag, book_type, county) %>%
  pivot_wider(names_from = new_arrest_flag, values_from = n) %>%
  arrange(book_type) %>%
  rename("New arrest flag" = `1`) %>%
  rename("No new arrest flag" = `0`)

write.xlsx(new_arrest_flag_table, file = "I:/Random for Shelley/2021.06.03 pretrial stuff/New arrest flag and book type table.xlsx", asTable = F)
```
Random for Preston and Nathan
```{r}
full_df %>%
  filter(County == "Sacramento",
         book_type == "On_View",
         year(book_date) == 2020) %>%
  select(book_num, book_type, book_date, release_date, pretrial_end_date, fta_flag, fta_date)

full_df %>%
  filter(County == "Sacramento",
         book_type == "On_View",
         book_date == "2020-01-01",
         cii == "0011492071")%>%
  select(book_num, book_type, book_date, release_date, assessment_date, pretrial_end_date, fta_flag, fta_date)


full_df %>%
  filter(County == "Sacramento",
         !is.na(assessment_date),
         assessment_date == "2020-01-01")

book_charge %>%
  filter(grepl("2020", OTD)) %>%
  filter(RegistryNumber == "9852483")
```

Fitted values from validation regressions for PJPI - PSA
```{r}
#PSA
m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score + release_to_pretrial_end , data = eval_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score, data = eval_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score + release_to_pretrial_end , data = eval_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score + release_to_pretrial_end , data = eval_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score + release_to_pretrial_end , data = eval_df)

fitted(m1)

ggplot(eval_df, aes(x=psa_nca_risk_score, y=recid_arrested_flag)) + 
  #geom_point(alpha=.5) +
  stat_smooth(method="glm", se=FALSE, method.args = list(family=binomial))

testplot <- data.frame(psa_nca_risk_score = seq(1, 6, by = 0.1))

#use fitted model to predict values of vs
testplot$new_arrest = predict(m2, testplot, type="response")

#plot logistic regression curve
plot(recid_arrested_flag ~ psa_nca_risk_score, data=eval_df, col="steelblue")
lines(new_arrest ~ psa_nca_risk_score, testplot, lwd=2)

testplot
```
Additional plots for PJPI - PSA gender New Arrest
```{r}
#PSA - gender
risk_df <- eval_df %>%
  filter(tool_name == "psa") %>%
  group_by(psa_nca_risk_score, sex, county) %>%
  select(recid_arrested_flag, recid_filed_flag, recid_convicted_flag) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

risk_df <- risk_df %>%
  mutate(sex = factor(sex, levels = c("Male", "Female"))) %>%
  filter(sex %in% c("Male", "Female")) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) %>%
  filter(county %in% c("Los Angeles", "Sacramento"))

risk_df <- risk_df %>%
  filter(name == "New Arrest")

ggplot(risk_df) +
  aes(x = psa_nca_risk_score, y = value, color = sex) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  theme_bw() +
  coord_cartesian(ylim=c(0,1)) + #ylim(0,1) +
  labs(x = "Risk Category", y = "Percent", color = "Gender") +
  scale_x_continuous(breaks = 1:6) +
  scale_y_continuous(labels = function(x) paste0(round(x*100,1), "%"), breaks = seq(0, 1, .1))


ggsave(filename = "I:/PJPI validation/psa_gender_nca_graph.png", width = 11, height = 7)
```
Additional plots for PJPI - PSA gender New Filing
```{r}
#PSA - gender
risk_df <- eval_df %>%
  filter(tool_name == "psa") %>%
  group_by(psa_nca_risk_score, sex, county) %>%
  select(recid_arrested_flag, recid_filed_flag, recid_convicted_flag) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

risk_df <- risk_df %>%
  mutate(sex = factor(sex, levels = c("Male", "Female"))) %>%
  filter(sex %in% c("Male", "Female")) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) %>%
  filter(county %in% c("Los Angeles", "Sacramento"))

risk_df <- risk_df %>%
  filter(name == "New Filing")

ggplot(risk_df) +
  aes(x = psa_nca_risk_score, y = value, color = sex) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  theme_bw() +
  coord_cartesian(ylim=c(0,1)) + #ylim(0,1) +
  labs(x = "Risk Category", y = "Percent", color = "Gender") +
  scale_x_continuous(breaks = 1:6) +
  scale_y_continuous(labels = function(x) paste0(round(x*100,1), "%"), breaks = seq(0, 1, .1))


ggsave(filename = "I:/PJPI validation/psa_gender_newfiling_graph.png", width = 11, height = 7)
```

Additional plots for PJPI - PSA race
```{r}
#PSA - race
risk_df <- eval_df %>%
  filter(tool_name == "psa") %>%
  group_by(psa_nca_risk_score, race, county) %>%
  select(recid_arrested_flag, recid_filed_flag, recid_convicted_flag) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

risk_df <- risk_df %>%
  #mutate(sex = factor(sex, levels = c("Male", "Female"))) %>%
  filter(race %in% c("Black", "Hispanic", "White")) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) %>%
  filter(county %in% c("Los Angeles", "Sacramento"))

risk_df <- risk_df %>%
  filter(name == "New Arrest")

ggplot(risk_df) +
  aes(x = psa_nca_risk_score, y = value, color = race) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  theme_bw() +
  coord_cartesian(ylim=c(0,1)) + #ylim(0,1) +
  labs(x = "Risk Category", y = "Percent", color = "Race") +
  scale_x_continuous(breaks = 1:6) +
  scale_y_continuous(labels = function(x) paste0(round(x*100,1), "%"), breaks = seq(0, 1, .1))


ggsave(filename = "I:/PJPI validation/psa_race_nca_graph.png", width = 11, height = 7)
```

Additional plots for PJPI - VPRAI gender
```{r}
#VPRAI - gender
risk_df <- eval_df %>%
  filter(tool_name == "vprai") %>%
  group_by(vprai_risk_score, sex, county) %>%
  select(recid_arrested_flag, recid_filed_flag, recid_convicted_flag) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

risk_df <- risk_df %>%
  mutate(sex = factor(sex, levels = c("Male", "Female"))) %>%
  filter(sex %in% c("Male", "Female")) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

risk_df <- risk_df %>%
  filter(name == "New Arrest")

ggplot(risk_df) +
  aes(x = vprai_risk_score, y = value, color = sex) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  theme_bw() +
  coord_cartesian(ylim=c(0,1)) + #ylim(0,1) +
  labs(x = "Risk Category", y = "Percent", color = "Gender") +
  scale_x_continuous(breaks = 1:5) +
  scale_y_continuous(labels = function(x) paste0(round(x*100,1), "%"), breaks = seq(0, 1, .1))


ggsave(filename = "I:/PJPI validation/vprai_gender_nca_graph.png", width = 11, height = 7)


```
Additional plots for PJPI - VPRAI race
```{r}
#VPRAI - race
risk_df <- eval_df %>%
  filter(tool_name == "vprai") %>%
  group_by(vprai_risk_score, race, county) %>%
  select(recid_arrested_flag, recid_filed_flag, recid_convicted_flag) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

risk_df <- risk_df %>%
  filter(race %in% c("Black", "Hispanic", "White")) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

risk_df <- risk_df %>%
  filter(name == "New Arrest")

ggplot(risk_df) +
  aes(x = vprai_risk_score, y = value, color = race) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  theme_bw() +
  coord_cartesian(ylim=c(0,1)) + #ylim(0,1) +
  labs(x = "Risk Category", y = "Percent", color = "Race") +
  scale_x_continuous(breaks = 1:6) +
  scale_y_continuous(labels = function(x) paste0(round(x*100,1), "%"), breaks = seq(0, 1, .1))


ggsave(filename = "I:/PJPI validation/vprai_race_nca_graph.png", width = 11, height = 7)
```

