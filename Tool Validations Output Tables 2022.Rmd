---
title: "Tool Validations Output Table"
author: "Sal Lempert"
date: "Run date: `r format(Sys.Date(), '%d. %B %Y')`"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

# Settup and Library
```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
knitr::opts_knit$set(root.dir = "C:/PretrialPilot/Pretrial-Pilot-County-Analysis")

# library(rlang)
library(tidyverse)
library(data.table)
library(openxlsx)
#library(readxl)
library(lubridate)
library(gsubfn)
library(fuzzyjoin)
library(dplyr)
# library(multidplyr)
library(pROC)
library(broom)
library(kableExtra)
library(stargazer)
library(DBI)
library(dbplyr)
library(odbc)
library(tinytex)
library(gt)
library(askpass)

# shell.exec(getwd())
```

Connection
```{r include=FALSE}

con <- dbConnect(odbc::odbc(), "snowflake_pretrial", uid ="Sal.Lempert@jud.ca.gov", pwd = rstudioapi::askForPassword("Password"))

```

XXXX Pull snowflake data -- cjs_outcome_std -- removed
```{sql eval=FALSE, connection=con, include=FALSE, output.var='full_df'}
SELECT *
FROM "DWH_PROD"."DATA_SCIENCE"."CJS_OUTCOME_STD"
;
```

Pull live snowflake data -- cjs_df_std 
```{sql echo=TRUE, connection=con, output.var='df'}
SELECT *
FROM "DWH_PROD"."DATA_SCIENCE"."CJS_DF_STD"
;
```

Pull 6.20.22 snowflake data -- cjs_df_std 
```{sql eval=FALSE, connection=con, include=FALSE, output.var='df'}
SELECT *
FROM "DWH_PROD"."DATA_SCIENCE"."CJS_STD_20220624"
;
```

Pull 8.18.22 snowflake data -- cjs_df_std 
```{sql eval=FALSE, connection=con, include=FALSE, output.var='df'}
SELECT *
FROM "DWH_PROD"."DATA_SCIENCE"."CJS_STD_20220818"
;
```

Pull live snowflake data -- join_df
```{sql echo=TRUE, connection=con, output.var='join_df'}
SELECT *
FROM "DWH_PROD"."DATA_SCIENCE"."JOIN_DF_STD"
;
```

Pull 6.20.22 snowflake data -- join_df
```{sql eval=FALSE, connection=con, include=FALSE, output.var='join_df'}
SELECT *
FROM "DWH_PROD"."DATA_SCIENCE"."JOIN_STD_20220624"
;
```

Pull 8.18.22 snowflake data -- join_df
```{sql eval=FALSE, connection=con, include=FALSE, output.var='join_df'}
SELECT *
FROM "DWH_PROD"."DATA_SCIENCE"."JOIN_STD_20220818"
;
```

Pull additional recid flags
```{sql eval=FALSE, connection=con, include=FALSE,  output.var='addon_df'}
SELECT COUNTY, BOOKING_KEY, RECID_ARREST_VIOLENT_PSA_FLAG_DOJ, RECID_ARREST_DV_FLAG_DOJ, RECID_ARREST_DUI_FLAG_DOJ, RECID_ARREST_PROPERTY_FLAG_DOJ, RECID_ARREST_DRUG_FLAG_DOJ
FROM "DWH_PROD"."REPORTING"."AGG_PRETRIAL_KPI_DOJ_ENHANCED";

```
Format additional recid flags
```{r eval=FALSE, include=FALSE}
names(addon_df) <- tolower(names(addon_df))

addon_df <- addon_df %>%
  mutate(across(contains("_flag"), ~if_else(is.na(.x) | .x == "No" | .x == "Unknown" | .x == "0" | .x == 0, 0, as.numeric(1))))  
```


XXXXXX Format data - full df and eval df -- removed
```{r eval=FALSE, warning=FALSE, include=FALSE}
names(full_df) <- tolower(names(full_df))

full_df <- full_df %>%
  mutate(book_date = booking_date,
         race_orig = race,
         race = if_else(race_standard %in% c("White", "Black", "Hispanic"), race_standard, "Other/Unknown"),
         charge_level_orig = charge_level,
         charge_level = charge_level_standard,
         pretrial_period_end_count = pretrial_period_end_count_standard,
         fta_flag = fta_county_or_doj,
         recid_arrested_flag = recid_county_or_doj,
         age = indiv_age,
         tool_name = case_when(county == "Kings" ~ "VPRAI-O", 
                               county == "Santa Barbara" & assessment_date < as.Date("2020-4-29") ~ "VPRAI",
                               county == "Santa Barbara" & assessment_date >= as.Date("2020-4-29") ~ "VPRAI-R",
                               tool_name == "VPRAIR" ~ "VPRAI-R",
                               T ~ tool_name),
         oras_risk_score = if_else(tool_name == "ORAS", risk_score_raw, NULL),
         vprai_risk_score = if_else(tool_name == "VPRAI", risk_score_raw, NULL),
         vprair_risk_score = if_else(tool_name == "VPRAI-R", risk_score_raw, NULL),
         vpraio_risk_score = if_else(tool_name == "VPRAI-O", generic_tool_total_score_raw, NULL),
         psa_fta_risk_score = score_failure_to_appear,
         psa_nca_risk_score = score_new_criminal_activity,
         psa_nvca_risk_score = score_new_criminal_violent_activity,
         scored_assessment = if_else(tool_name %in% c("ORAS", "VPRAI", "VPRAI-R") & !is.na(risk_score_raw) |
                                       tool_name == "PSA" & !is.na(score_new_criminal_activity) |
                                       tool_name == "VPRAI-O" & !is.na(generic_tool_total_score_raw), 1, 0),
         pretrial_period_end_date = if_else(is.na(pretrial_period_end_date), as.Date(pretrial_period_end_date_doj), as.Date(pretrial_period_end_date)))%>%
  mutate(recid_filed_flag = recid_filed_flag_doj, 
         recid_convicted_flag = recid_convicted_flag_doj, 
         recid_arrest_violent_psa_flag = recid_arrest_violent_psa_flag_doj,
         any_pretrial_failure_flag = if_else(recid_arrested_flag == 1 | fta_flag == 1, 1, 0)) %>% ## update this when we get county data on these
  mutate(across(contains("_flag"), ~if_else(is.na(.x), 0, as.numeric(.x))))  

eval_df <- full_df %>%
  filter(booking_assessed_count == 1,
         scored_assessment == 1,
         release_eligible_count ==1,
         released_pretrial_count == 1,
         pretrial_period_end_count == 1,
         booking_date < as.Date("2022-01-01"),
         tool_name %in% c("ORAS", "PSA", "VPRAI", "VPRAI-R", "VPRAI-O")
         ) %>%
  mutate(release_to_pretrial_end = pretrial_period_end_date - release_date)


```

Format data - join df 
```{r warning=FALSE, include=FALSE}
#snow_df <- join_df
#join_df <- snow_df
names(join_df) <- tolower(names(join_df))

join_df <- join_df %>%
  mutate(book_date = booking_date,
         race_orig = race,
         race = if_else(race_standard %in% c("White", "Black", "Hispanic"), race_standard, "Other/Unknown"),
         age = individual_age,
         charge_level_orig = charge_level,
         charge_level = charge_level_standard,
         pretrial_period_end_count = pretrial_period_end_count_standard,
         fta_flag = fta_county_or_doj,
         recid_arrested_flag = recid_county_or_doj,
         tool_name = case_when(county == "Kings" ~ "VPRAI-O", 
                               county == "Santa Barbara" & assessment_date < as.Date("2020-4-29") ~ "VPRAI",
                               county == "Santa Barbara" & assessment_date >= as.Date("2020-4-29") ~ "VPRAI-R",
                               tool_name == "VPRAIR" ~ "VPRAI-R",
                               T ~ tool_name),
         oras_risk_score = if_else(tool_name == "ORAS", risk_score_raw, NULL),
         vprai_risk_score = if_else(tool_name == "VPRAI", risk_score_raw, NULL),
         vprair_risk_score = if_else(tool_name == "VPRAI-R", risk_score_raw, NULL),
         vpraio_risk_score = if_else(tool_name == "VPRAI-O", generic_tool_total_score_raw, NULL),
         psa_fta_risk_score = score_failure_to_appear,
         psa_nca_risk_score = score_new_criminal_activity,
         psa_nvca_risk_score = score_new_criminal_violent_activity,
         scored_assessment = if_else(tool_name %in% c("ORAS", "VPRAI", "VPRAI-R") & !is.na(risk_score_raw) |
                                       tool_name == "PSA" & !is.na(score_new_criminal_activity) |
                                       tool_name == "VPRAI-O" & !is.na(generic_tool_total_score_raw), 1, 0),
         pretrial_period_end_date = if_else(is.na(pretrial_period_end_date), as.Date(pretrial_period_end_date_doj), as.Date(pretrial_period_end_date)))%>%
  mutate(recid_filed_flag = recid_filed_flag_doj, 
         recid_convicted_flag = recid_convicted_flag_doj, 
         recid_arrest_violent_psa_flag = recid_arrest_violent_psa_flag_doj,
         any_pretrial_failure_flag = if_else(recid_arrested_flag == 1 | fta_flag == 1, 1, 0)) %>% ## update this when we get county data on these
  mutate(across(contains("_flag"), ~if_else(is.na(.x) | .x == "No" | .x == "Unknown" | .x == "0" | .x == 0, 0, as.numeric(1))))  

full_df <- join_df %>%
  filter(booking_date < as.Date("2022-01-01"))

eval_df <- join_df %>%
  filter(booking_assessed_count == 1,
         scored_assessment == 1,
         release_eligible_count ==1,
         released_pretrial_count == 1,
         pretrial_period_end_count == 1,
         booking_date < as.Date("2022-01-01"),
         tool_name %in% c("ORAS", "PSA", "VPRAI", "VPRAI-R", "VPRAI-O")
         ) %>%
  mutate(release_to_pretrial_end = pretrial_period_end_date - release_date)

#create zero bail dummy for period of April 6 2020 through June 20 2020
eval_df <- eval_df %>%
  mutate(zero_bail_dummy = if_else(arrest_date >= as.Date("2020-04-06") & arrest_date <= as.Date("2020-06-20"), 1, 0)) 

# create sup_or_none dummy for supervision
eval_df <- eval_df %>%
  mutate(monitoring_level_grouped = if_else(grepl("Own Recognizance", monitoring_level_grouped), "Own Recognizance", monitoring_level_grouped)) %>%
  mutate(monitoring_level_grouped = if_else(monitoring_level_grouped %in% c("Lowest Levels", "Medium Levels", "Highest Levels", "Own Recognizance"), monitoring_level_grouped, NA_character_)) %>%
  mutate(bail_or_sup = case_when(release_type %in% c("Bail Bond") ~ "Bail Bond",
                                 !is.na(monitoring_level_grouped) ~ monitoring_level_grouped,
                                 release_type %in% c("Own Recognizance") ~ "Own Recognizance",
                                 release_type %in% c("Cite Release", "CiteR elease") ~ "Cite Release")) 
```


Change Raw Risk Scores to Risk Levels for eval_df -- toggle off to go back to raw scores
```{r}
eval_df <- eval_df %>%
  mutate(vprai_risk_score_raw = vprai_risk_score,
         vprair_risk_score_raw = vprair_risk_score,
         oras_risk_score_raw = oras_risk_score) %>%
  mutate(vprai_risk_score = case_when(vprai_risk_score_raw %in% 0:1 ~ 1,
                                      vprai_risk_score_raw %in% 2 ~ 2,
                                      vprai_risk_score_raw %in% 3 ~ 3,
                                      vprai_risk_score_raw %in% 4 ~ 4,
                                      vprai_risk_score_raw %in% 5:9 ~ 5,
                                      T ~ vprai_risk_score_raw),
         vprair_risk_score = case_when(vprair_risk_score_raw %in% 0:2 ~ 1,
                                       vprair_risk_score_raw %in% 3:4 ~ 2,
                                       vprair_risk_score_raw %in% 5:6 ~ 3,
                                       vprair_risk_score_raw %in% 7:8 ~ 4,
                                       vprair_risk_score_raw %in% 9:10 ~ 5,
                                       vprair_risk_score_raw %in% 11:14 ~ 6,
                                       T ~ vprair_risk_score_raw),
         oras_risk_score = case_when(oras_risk_score_raw %in% 0:2 ~ 1,
                                     oras_risk_score_raw %in% 3:5 ~ 2,
                                     oras_risk_score_raw %in% 6:9 ~ 3,
                                     T ~ oras_risk_score_raw))

eval_df %>%
  count(vprai_risk_score, vprai_risk_score_raw)

eval_df %>%
  count(vprair_risk_score, vprair_risk_score_raw)

eval_df %>%
  count(oras_risk_score, oras_risk_score_raw)
```


Format df
```{r}
names(df) <- tolower(names(df))

df <- df %>%
  mutate(tool_name_orig = tool_name,
         tool_name = case_when(county_name == "Modoc" ~ "ORAS",
                               county_name == "Yuba" ~ "ORAS",
                               county_name == "San Joaquin" ~ "VPRAI",
                               county_name == "San Mateo" ~ "VPRAI-R",
                               county_name == "Alameda" ~ "VPRAI-R",
                               T ~ tool_name_standard),
         county = county_name,
         County = case_when(county %in% c("Calaveras", "Modoc", "Tuolumne", "Yuba") ~ "Small Counties",
                            county %in% c("Kings", "Napa", "Nevada", "Sierra") ~ "Small/Medium Counties",
                            T ~ county),
         County = ordered(County),
         County = fct_relevel(County, levels = c("Small Counties", "Small/Medium Counties")),
         charge_level_orig = charge_level,
         charge_level = charge_level_standard,
         arrest_charge_level = charge_level,
         age = individual_age,
         sex_orig = sex,
         sex = if_else(sex %in% c("Male", "Female"), sex, "Other/Unknown"),
         race_orig = race,
         race = if_else(race_standard == "American Indian", "Other/Unknown", race_standard),
         oras_risk_score = if_else(tool_name == "ORAS", risk_score_raw, NULL),
         vprai_risk_score = if_else(tool_name == "VPRAI", risk_score_raw, NULL),
         vprair_risk_score = if_else(tool_name == "VPRAI-R", risk_score_raw, NULL),
         vpraio_risk_score = if_else(tool_name == "VPRAI-O", generic_tool_total_score_raw, NULL),
         psa_fta_risk_score = score_failure_to_appear,
         psa_nca_risk_score = score_new_criminal_activity,
         psa_nvca_risk_score = score_new_criminal_violent_activity,
         scored_assessment = if_else(tool_name %in% c("ORAS", "VPRAI", "VPRAI-R") & !is.na(risk_score_raw) |
                                       tool_name == "PSA" & !is.na(score_new_criminal_activity) |
                                       tool_name == "VPRAI-O" & !is.na(generic_tool_total_score_raw), 1, 0),
         monitor_level = if_else(monitoring_level_grouped %in% c("Lowest Levels", "Medium Levels", "Highest Levels"), monitoring_level_grouped, "Other/Unknown")) %>%
  arrange(County) %>%
  filter(assessment_date < as.Date("2022-01-01")) %>%
  filter(scored_assessment == 1)

```

Change Raw Risk Scores to Risk Levels for df -- toggle off to go back to raw scores
```{r}
df <- df %>%
  mutate(vprai_risk_score_raw = vprai_risk_score,
         vprair_risk_score_raw = vprair_risk_score,
         oras_risk_score_raw = oras_risk_score) %>%
  mutate(vprai_risk_score = case_when(vprai_risk_score_raw %in% 0:1 ~ 1,
                                      vprai_risk_score_raw %in% 2 ~ 2,
                                      vprai_risk_score_raw %in% 3 ~ 3,
                                      vprai_risk_score_raw %in% 4 ~ 4,
                                      vprai_risk_score_raw %in% 5:9 ~ 5,
                                      T ~ vprai_risk_score_raw),
         vprair_risk_score = case_when(vprair_risk_score_raw %in% 0:2 ~ 1,
                                       vprair_risk_score_raw %in% 3:4 ~ 2,
                                       vprair_risk_score_raw %in% 5:6 ~ 3,
                                       vprair_risk_score_raw %in% 7:8 ~ 4,
                                       vprair_risk_score_raw %in% 9:10 ~ 5,
                                       vprair_risk_score_raw %in% 11:14 ~ 6,
                                       T ~ vprair_risk_score_raw),
         oras_risk_score = case_when(oras_risk_score_raw %in% 0:2 ~ 1,
                                     oras_risk_score_raw %in% 3:5 ~ 2,
                                     oras_risk_score_raw %in% 6:9 ~ 3,
                                     T ~ oras_risk_score_raw))

df %>%
  count(vprai_risk_score, vprai_risk_score_raw)

df %>%
  count(vprair_risk_score, vprair_risk_score_raw)

df %>%
  count(oras_risk_score, oras_risk_score_raw)

df %>%
  count(county)

```

TEMPORARY - Remove Santa Barbara until data are fixed
```{r}
df <- df %>%
  filter(county != "Santa Barbara")

full_df <- full_df %>%
  filter(county != "Santa Barbara")

eval_df <- eval_df %>%
  filter(county != "Santa Barbara")
```

Remove erroneous Yuba release dates
```{r}
eval_df <- eval_df %>%
  filter(!release_date < "2015-01-01")
```



MyKable function
```{r warning=FALSE, include=FALSE}
my_kable <- function(x){
  kable(x, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 14, latex_options = "hold_position") %>%
    row_spec(nrow(x), bold = T)
    # column_spec(2, bold = T)
  # footnote(general_title = "", general = "Source: Judicial Council of California, Recidivism Reduction Fund Quarterly Reports (July 1, 2015-March 31, 2018).")  %>%
    
}

```

# Make AUC table

Make AUC table --- MAKE SURE THIS IS ON WHEN THERE IS NEW DATA
```{r echo=TRUE}
race_df <- eval_df %>%
  mutate(race = "All")

race_df <- eval_df %>%
  bind_rows(race_df) %>%
  mutate(race = factor(race, levels = c("All", "White", "Black", "Hispanic", "Other_Unknown")))

race_df2 <- race_df %>%
  mutate(county = "All")

race_df <- bind_rows(race_df2,race_df)

race_df2 <- race_df %>%
  mutate(sex = "All")

race_df <- bind_rows(race_df, race_df2)

rm(race_df2)


roc_df <- lapply(c("All", "White", "Black", "Hispanic"), 
                 function(i){
  
  lapply(c("fta_flag", "recid_arrested_flag", "recid_filed_flag", 
         "recid_convicted_flag", "recid_arrest_violent_psa_flag", 
         "any_pretrial_failure_flag"),
        
          function(j){
           
            lapply(c("vprair_risk_score", "vprai_risk_score", "oras_risk_score", 
                    "psa_fta_risk_score", "psa_nca_risk_score", "psa_nvca_risk_score"),
                  function(k){
                    
                    lapply(unique(race_df$county), 
                           function(l){
                             
                             lapply(c("All", "Male", "Female"),
                             function(m){
                               race_df <- race_df %>%
                                filter(race == i, county == l, sex == m)
                              
                              list_roc <- try(roc(get(j) ~ get(k), data = race_df, ci = T), silent = T)
                              
                              if("try-error" %in% class(list_roc)) return(NULL)
                              
                              else list_roc <- roc(get(j) ~ get(k), data = race_df, ci = T)
                              
                              df_roc <- tibble(AUC = round(list_roc$auc, 3),
                                               CI = paste(c(round(list_roc$ci[[1]], 3), 
                                                            round(list_roc$ci[[3]], 3)),
                                                          collapse = "-"),
                                               risk_score = k,
                                               outcome = j,
                                               race = i,
                                               sex = m,
                                               county = l,
                                               tool_name = gsub("_.*", "", k),
                                               controls = length(list_roc$controls),
                                               cases = length(list_roc$cases),
                                               n = controls + cases)
                              
                               
                             }) %>% bind_rows()
                      
                        
                    }) %>% bind_rows()
                    
                  }) %>% bind_rows()
           
         }) %>% bind_rows()
  
})  %>% bind_rows()

roc_df <- roc_df %>%
  filter(tool_name != "psa"|(outcome == "fta_flag" & risk_score == "psa_fta_risk_score")|
           (risk_score == "psa_nca_risk_score" & outcome %in% c("recid_arrested_flag", "recid_filed_flag", "recid_convicted_flag"))|
           (risk_score == "psa_nvca_risk_score" & outcome == "recid_arrest_violent_psa_flag"))


roc_df <- roc_df %>%
  mutate(tool_name = if_else(tool_name == "vprair", "vprai-r", tool_name))

write.xlsx(roc_df, file = "C:/PretrialPilot/Pretrial-Pilot-County-Analysis/AUCs by Demographic Category.xlsx", asTable = T)
save(roc_df, file= "C:/PretrialPilot/Pretrial-Pilot-County-Analysis/AUCs.RData")


```

```{r}
#auc_df <- read.xlsx("C:/PretrialPilot/Pretrial-Pilot-County-Analysis/AUCs by Demographic Category.xlsx")
#load("C:/PretrialPilot/Pretrial-Pilot-County-Analysis/AUCs.RData")

auc_df <- roc_df %>%
  mutate(tool_name = toupper(tool_name))

```

Diagnostic
```{r eval=FALSE, include=FALSE}
# #VPRAI  
# (roc(fta_flag ~ vprai_risk_score, data = race_df, ci = T))
# (roc(recid_arrested_flag ~ vprai_risk_score , data = race_df, ci = T))
# (roc(recid_filed_flag ~ vprai_risk_score , data = race_df, ci = T))
# (roc(recid_convicted_flag ~ vprai_risk_score , data = race_df, ci = T))
# (roc(recid_arrest_violent_psa_flag ~ vprai_risk_score , data = race_df, ci = T))
# 
# #VPRAI-R
# (roc(fta_flag ~ vprair_risk_score , data = race_df, ci = T))
# (roc(recid_arrested_flag ~ vprair_risk_score , data = race_df, ci = T))
# (roc(recid_filed_flag ~ vprair_risk_score , data = race_df, ci = T))
# (roc(recid_convicted_flag ~ vprair_risk_score , data = race_df, ci = T))
# (roc(recid_arrest_violent_psa_flag ~ vprair_risk_score , data = race_df, ci = T))
# 
# #PSA
# (roc(fta_flag ~ psa_fta_risk_score , data = race_df, ci = T))
# (roc(recid_arrested_flag ~ psa_nca_risk_score , data = race_df, ci = T))
# (roc(recid_filed_flag ~ psa_nca_risk_score , data = race_df, ci = T))
# (roc(recid_convicted_flag ~ psa_nca_risk_score , data = race_df, ci = T))
# (roc(recid_arrest_violent_psa_flag ~ psa_nvca_risk_score , data = race_df, ci = T))
# 
# #ORAS
# (roc(fta_flag ~ oras_risk_score , data = race_df, ci = T))
# (roc(recid_arrested_flag ~ oras_risk_score , data = race_df, ci = T))
# (roc(recid_filed_flag ~ oras_risk_score , data = race_df, ci = T))
# (roc(recid_convicted_flag ~ oras_risk_score , data = race_df, ci = T))
# (roc(recid_arrest_violent_psa_flag ~ oras_risk_score , data = race_df, ci = T))
```

\newpage

# Date Range
```{r}
date_df <- eval_df %>%
  group_by(tool_name) %>%
  summarise(min_date = min(assessment_date), max_date = max(assessment_date)) %>%
  mutate(tool_name = toupper(tool_name))

names(date_df) <- c("Tool Name", "Earliest Assessment Date", "Latest Assessment Date")

kable(date_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 14, latex_options = "hold_position")# %>%
 # save_kable(file = "C:/PretrialPilot/Pretrial-Pilot-County-Analysis/date_range.tex")

#tinytex::pdflatex('C:/PretrialPilot/Pretrial-Pilot-County-Analysis/date_range.tex')

#latexmk('C:/PretrialPilot/Pretrial-Pilot-County-Analysis/date_range.tex')

#date by county
date_dfc <- eval_df %>%
  group_by(county) %>%
  summarise(min_date = min(assessment_date), max_date = max(assessment_date)) 

names(date_dfc) <- c("County", "Earliest Assessment Date", "Latest Assessment Date")

kable(date_dfc, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 14, latex_options = "hold_position")# %>%

date_dfc
```
# Drop-Off
```{r}

drop_df1 <- df %>%
  filter(scored_assessment == 1,
         tool_name != "Local") %>%
  mutate(county = if_else(county %in% c("Sierra", "Nevada"), "Nevada/Sierra", county)) %>%
  count(tool_name, county)

drop_df2 <- full_df %>%
  filter(!is.na(tool_name)) %>%
  mutate(county = if_else(county %in% c("Sierra", "Nevada"), "Nevada/Sierra", county)) %>%
  group_by(tool_name, county) %>%
  summarise('Assessed Bookings' = sum(booking_assessed_count*scored_assessment), 
            'Pretrial Complete' = sum(booking_assessed_count*scored_assessment*pretrial_period_end_count),
            'Validation Dataset' = sum(booking_assessed_count*scored_assessment*release_eligible_count*pretrial_period_end_count*released_pretrial_count))


drop_df <- drop_df1 %>%
  left_join(drop_df2) %>%
  rename('Assessments' = n,
         'Tool Name' = tool_name,
         'County' = county)

drop_df_out <- drop_df %>%
  mutate(`Validation Type` = case_when(`Validation Dataset` >= 1000 ~ "General + Bias",
                                       `Validation Dataset` >= 200 ~ "General Only",
                                       `Validation Dataset` < 200 ~ "Sample Too Small")) %>%
  arrange(`Validation Type`) %>%
  ungroup()

kable(drop_df_out , booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    column_spec(3:6, width = "1.5cm") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 10, 
                  latex_options = "hold_position") 

# gt(drop_df_out) %>%
#   gtsave(filename = "drop off by county.html")

# gt(drop_df_out %>% filter(County == "Los Angeles")) %>%
#   gtsave(filename = "drop off LA.html")

drop_df1
drop_df2

df %>%
  count(county, tool_name)

full_df %>%
  count(county, tool_name)

```

Tool dropoff
```{r}

drop_df1 <- df %>%
  filter(scored_assessment == 1,
         tool_name != "Local") %>%
  count(tool_name)

drop_df2 <- full_df %>%
  filter(!is.na(tool_name)) %>%
  group_by(tool_name) %>%
  summarise('Assessed Bookings' = sum(booking_assessed_count*scored_assessment), 
            'Pretrial Complete' = sum(booking_assessed_count*scored_assessment*pretrial_period_end_count),
            'Validation Dataset' = sum(booking_assessed_count*scored_assessment*release_eligible_count*pretrial_period_end_count*released_pretrial_count))


drop_df <- drop_df1 %>%
  left_join(drop_df2) %>%
  rename('Assessments' = n,
         'Tool Name' = tool_name)

drop_df_out_tool <- drop_df %>%
  mutate(`Validation Type` = case_when(`Validation Dataset` >= 1000 ~ "General + Bias",
                                       `Validation Dataset` >= 200 ~ "General Only",
                                       `Validation Dataset` < 200 ~ "Sample Too Small")) %>%
  arrange(`Validation Type`) %>%
  ungroup()

kable(drop_df_out_tool , booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    column_spec(3:6, width = "1.5cm") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 10, 
                  latex_options = "hold_position") 

# gt(drop_df_out) %>%
#   gtsave(filename = "drop off by county.html")

# gt(drop_df_out %>% filter(County == "Los Angeles")) %>%
#   gtsave(filename = "drop off LA.html")


```

TEMPORARY - Remove Kings for tool validation
```{r}
eval_df <- eval_df %>%
  filter(county != "Kings")

df <- df %>%
  filter(county != "Kings")

full_df <- full_df %>%
  filter(county != "Kings")

```


# The Percent of Assessments by Demographic
```{r}
race_df <- eval_df %>%
  count(county, race) %>%
  group_by(county) %>%
  mutate(Total = sum(n)) %>%
  pivot_wider(names_from =  race, values_from =  n, values_fill = 0) %>%
  select(county, Black, White, Hispanic, "Other" = 'Other/Unknown', Total) %>%
  bind_rows(eval_df %>%
              count(race) %>%
              mutate(Total = sum(n)) %>%
              pivot_wider(names_from =  race, values_from =  n, values_fill = 0) %>%
              mutate(county = "Total") %>%
              select(county, Black, White, Hispanic, "Other" = 'Other/Unknown', Total)) %>%
  mutate_at(vars("Black", "White", "Hispanic", "Other"), funs(round(./Total*100)))

gender_df <- eval_df %>%
  count(county, sex) %>%
  group_by(county) %>%
  mutate(Total = sum(n)) %>%
  pivot_wider(names_from =  sex, values_from =  n, values_fill = 0) %>%
  select(county, Male, Female, Total) %>%
  bind_rows(eval_df %>%
              count(sex) %>%
              mutate(Total = sum(n)) %>%
              pivot_wider(names_from =  sex, values_from =  n, values_fill = 0) %>%
              mutate(county = "Total") %>%
              select(county, Male, Female, Total)) %>%
  mutate_at(vars("Male", "Female"), funs(round(./Total*100)))

age_df <- eval_df %>%
  group_by(county) %>%
  summarise(age = median(age, na.rm = T)) %>%
  bind_rows(eval_df %>%
              summarise(age = median(age, na.rm = T)) %>%
              mutate(county = "Total"))


demo_df <- left_join(race_df, gender_df) %>%
  left_join(age_df) %>%
  select("County" = county, Total, everything(), "Median Age" = age)

my_kable(demo_df) %>%
  add_header_above(c(" " = 2, "Race/Ethnicity (%)" = 4, "Gender (%)" = 2, " " = 1))

# gt(demo_df) %>%
#   gtsave(filename = "demographics by county.html")
```

#Demographics by tool
```{r}
race_df <- eval_df %>%
  count(tool_name, race) %>%
  group_by(tool_name) %>%
  mutate(Total = sum(n)) %>%
  pivot_wider(names_from =  race, values_from =  n, values_fill = 0) %>%
  select(tool_name, Black, White, Hispanic, "Other" = 'Other/Unknown', Total) %>%
  bind_rows(eval_df %>%
              count(race) %>%
              mutate(Total = sum(n)) %>%
              pivot_wider(names_from =  race, values_from =  n, values_fill = 0) %>%
              mutate(tool_name = "Total") %>%
              select(tool_name, Black, White, Hispanic, "Other" = 'Other/Unknown', Total)) %>%
  mutate_at(vars("Black", "White", "Hispanic", "Other"), funs(round(./Total*100)))

gender_df <- eval_df %>%
  count(tool_name, sex) %>%
  group_by(tool_name) %>%
  mutate(Total = sum(n)) %>%
  pivot_wider(names_from =  sex, values_from =  n, values_fill = 0) %>%
  select(tool_name, Male, Female, Total) %>%
  bind_rows(eval_df %>%
              count(sex) %>%
              mutate(Total = sum(n)) %>%
              pivot_wider(names_from =  sex, values_from =  n, values_fill = 0) %>%
              mutate(tool_name = "Total") %>%
              select(tool_name, Male, Female, Total)) %>%
  mutate_at(vars("Male", "Female"), funs(round(./Total*100)))

age_df <- eval_df %>%
  group_by(tool_name) %>%
  summarise(age = median(age, na.rm = T)) %>%
  bind_rows(eval_df %>%
              summarise(age = median(age, na.rm = T)) %>%
              mutate(tool_name = "Total"))


demo_df_tool <- left_join(race_df, gender_df) %>%
  left_join(age_df) %>%
  select("Tool Name" = tool_name, Total, everything(), "Median Age" = age)

my_kable(demo_df_tool) %>%
  add_header_above(c(" " = 2, "Race/Ethnicity (%)" = 4, "Gender (%)" = 2, " " = 1))

# gt(demo_df_tool) %>%
#   gtsave(filename = "demographics by tool.html")
```
Source: Pretrial Pilot Multi-Agency Linked Data. Data are limited to bookings with a defendant released pretrial and a completed pretrial period.
\newpage

# Arrest Offenses
```{r echo=FALSE}
arrest_df <- eval_df %>%
  mutate(fel_flag = if_else(charge_level == "F", 1, 0),
         misdo_flag = if_else(charge_level %in% c("M", "I"), 1, 0)) %>%
  group_by(county) %>%
  summarise_at(vars(fel_flag, misdo_flag, arrest_violent_psa_flag, arrest_property_flag, arrest_drug_flag,
                    arrest_dui_flag, arrest_dv_flag), funs(round(mean(.)*100)))

names(arrest_df) <- c("County", "Felony", "Misdemeanor", "Violent", "Property", "Drug", "DUI", "DV")

kable(arrest_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 14, latex_options = "hold_position")


```


# Adverse Outcomes by county
```{r}
outcome_df <- eval_df %>%
  group_by(county) %>%
  summarise_at(vars(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    recid_arrest_violent_psa_flag), 
                    # any_pretrial_failure_flag),
               funs(round(mean(.)*100, 1)))

names(outcome_df) <- c("County", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest") 
                       # "FTA or New Arrest")

kable(outcome_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 14, latex_options = "hold_position")

# gt(outcome_df) %>%
#   gtsave(filename = "outcome rates by county.html")
```


# Adverse Outcomes by tool
```{r}
outcome_df_tool <- eval_df %>%
  group_by(tool_name) %>%
  summarise_at(vars(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    recid_arrest_violent_psa_flag), 
                    # any_pretrial_failure_flag),
               funs(round(mean(.)*100, 1)))

names(outcome_df_tool) <- c("Tool Name", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest") 
                       # "FTA or New Arrest")

kable(outcome_df_tool, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 14, latex_options = "hold_position")

# gt(outcome_df_tool) %>%
#   gtsave(filename = "outcome rates by tool.html")
```



# Indiv intro tables for reports - TEMPORARILY REMOVED SANTA BARBARA
```{r}

county_list = eval_df %>% distinct(county) %>% pull(county)
tool_list = eval_df %>% distinct(tool_name) %>% pull(tool_name)

lapply(c("Los Angeles", "Sacramento", "Ventura", "Sonoma", "Tulare", "San Joaquin", "Modoc", "Napa", "Calaveras", "Alameda", "San Mateo"),
  function(x){
    
    
fname = str_c(x, " dropoff table ", ".html")
kable(drop_df_out %>% filter(County == x) , booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "html") %>%
    column_spec(3:6, width = "1.5cm") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 14, 
                  latex_options = "hold_position") %>%
      save_kable(fname)
    


fname = str_c(x, " demographics table ", ".html")
kable(demo_df %>% filter(County == x), booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "html")  %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 14, 
                  latex_options = "hold_position") %>%
  add_header_above(c(" " = 2, "Race/Ethnicity (%)" = 4, "Gender (%)" = 2, " " = 1)) %>%
  save_kable(fname)



fname = str_c(x, " outcome table", ".html")
kable(outcome_df %>% filter(County == x), booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "html") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 14, latex_options = "hold_position") %>%
  save_kable(fname)



})     

lapply(c("Los Angeles", "Sacramento", "Ventura", "Sonoma", "Tulare", "San Joaquin", "Modoc", "Napa", "Calaveras", "Alameda", "San Mateo"),
  function(x){
    
fname = str_c(x, " arrest offense table ", ".html")
kable(arrest_df %>% filter(County == x) , booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "html") %>%
    column_spec(2:8, width = "1.5cm") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 14, 
                  latex_options = "hold_position") %>%
      save_kable(fname)

})     

lapply(c(tool_list),
  function(x){
    

kable(drop_df_out %>% filter('Tool Name' == x) , booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    column_spec(3:6, width = "1.5cm") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 10, 
                  latex_options = "hold_position") 


kable(demo_df_tool %>% filter('Tool Name' == x), booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex")  %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 10, 
                  latex_options = "hold_position") %>%
  add_header_above(c(" " = 2, "Race/Ethnicity (%)" = 4, "Gender (%)" = 2, " " = 1))


kable(outcome_df_tool %>% filter('Tool Name' == x), booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 14, latex_options = "hold_position")        }) 


```


# Total Assessments by Tool 
```{r echo=FALSE}
suppressMessages(
county_df <- eval_df %>%
  count(county, tool_name) %>%
  group_by(tool_name) %>%
  summarise(county = paste(county, collapse = ", "), Total = sum(n)) %>%
  ungroup() %>%
  mutate(tool_name = toupper(tool_name)) %>%
  bind_rows(eval_df %>%
              summarise(Total = n()) %>%
              mutate(tool_name = "All", county = "All"))
)

names(county_df) <- c("Tool Name", "County", "Pretrial Observations")

kable(county_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") %>%
  row_spec(nrow(county_df), bold = T)

```

\newpage

The Percent of Assessments by Demographic
```{r}
race_df <- eval_df %>%
  mutate(race = if_else(race %in% c("Black", "White", "Hispanic"), race, "Other_Unknown")) %>%
  count(tool_name, race) %>%
  group_by(tool_name) %>%
  mutate(Total = sum(n)) %>%
  pivot_wider(names_from =  race, values_from =  n, values_fill = 0) %>%
  select(tool_name, Black, White, Hispanic, "Other" = Other_Unknown, Total) %>%
  bind_rows(eval_df %>%
              mutate(race = if_else(race %in% c("Black", "White", "Hispanic"), race, "Other_Unknown")) %>%
              count(race) %>%
              mutate(Total = sum(n)) %>%
              pivot_wider(names_from =  race, values_from =  n, values_fill = 0) %>%
              mutate(tool_name = "Total") %>%
              select(tool_name, Black, White, Hispanic, "Other" = Other_Unknown, Total)) %>%
  mutate_at(vars("Black", "White", "Hispanic", "Other"), funs(round(./Total*100)))

gender_df <- eval_df %>%
  count(tool_name, sex) %>%
  group_by(tool_name) %>%
  mutate(Total = sum(n)) %>%
  pivot_wider(names_from =  sex, values_from =  n, values_fill = 0) %>%
  select(tool_name, Male, Female, Total) %>%
  bind_rows(eval_df %>%
              count(sex) %>%
              mutate(Total = sum(n)) %>%
              pivot_wider(names_from =  sex, values_from =  n, values_fill = 0) %>%
              mutate(tool_name = "Total") %>%
              select(tool_name, Male, Female, Total)) %>%
  mutate_at(vars("Male", "Female"), funs(round(./Total*100)))

age_df <- eval_df %>%
  group_by(tool_name) %>%
  summarise(age = median(age, na.rm = T)) %>%
  bind_rows(eval_df %>%
              summarise(age = median(age, na.rm = T)) %>%
              mutate(tool_name = "Total"))


demo_df <- left_join(race_df, gender_df) %>%
  left_join(age_df) %>%
  mutate(tool_name = toupper(tool_name)) %>%
  select("Tool Name" = tool_name, Total, everything(), "Median Age" = age)

my_kable(demo_df) %>%
  add_header_above(c(" " = 2, "Race/Ethnicity (%)" = 4, "Gender (%)" = 2, " " = 1))

```

Source: Pretrial Pilot Multi-Agency Linked Data. Data are limited to bookings with a defendant released pretrial and a completed pretrial period.

\newpage

# Arrest Offenses -- need a fuller view for this
```{r eval=FALSE, include=FALSE}
arrest_df <- eval_df %>%
  group_by(tool_name) %>%
  summarise_at(vars(arrest_felony_flag, arrest_misd_flag, arrest_violent_psa_flag, arrest_property_flag, arrest_drug_flag,
                    arrest_dui_flag, arrest_dv_flag), funs(round(mean(.)*100))) %>%
  mutate(arrest_misd_flag = 100 - arrest_felony_flag) %>%
  mutate(tool_name = toupper(tool_name))

names(arrest_df) <- c("Tool Name", "Felony", "Misdemeanor", "Violent", "Property", "Drug", "DUI", "DV")

kable(arrest_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 14, latex_options = "hold_position")

```
# Adverse Outcomes
```{r}
outcome_df <- eval_df %>%
  group_by(tool_name) %>%
  summarise_at(vars(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    recid_arrest_violent_psa_flag), 
                    # any_pretrial_failure_flag),
               funs(round(mean(.)*100, 1))) %>%
  mutate(tool_name = toupper(tool_name))

names(outcome_df) <- c("Tool Name", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest") 
                       # "FTA or New Arrest")

kable(outcome_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 14, latex_options = "hold_position")


```


Source: Pretrial Pilot Program Probation Data (10-01-2019 through 03-31-2021).
\newline
Note: See report text for definitions of small, small/medium, medium and large.
\newpage

```{r eval=FALSE, include=FALSE}
full_df %>%
  group_by(year(book_date), month(book_date)) %>%
  summarise(arrest_violent_psa_flag = round(mean(arrest_violent_psa_flag)*100, 1)) %>%
  View()  

full_df %>%
  filter(year(book_date) > 2015, year(book_date) <= 2020) %>%
  group_by(year(book_date), month(book_date)) %>%
  # mutate(book_date = min(book_date)) %>%
  summarise(arrest_violent_psa_flag = sum(arrest_violent_psa_flag), book_date = min(book_date)) %>%
  ungroup() %>% 
  ggplot() +
  aes(x = book_date, y = arrest_violent_psa_flag) +
  geom_line()
```

## Basic Validation
# Adverse Outcome by Score
ORAS
\newline
```{r}
risk_df <- eval_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "ORAS", !is.na(oras_risk_score)) %>%
  group_by(oras_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing",
                                        "New Conviction", "New Violent Arrest")))
  
ggplot(risk_df %>% distinct(oras_risk_score, Total) %>% mutate(percent = Total/sum(Total))) +
  aes(x = as.factor(oras_risk_score), y = percent) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3, aes(label = str_c(round(percent*100), "%")), size = 2.6) +
  theme_bw() +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  # ylim(0,100) +
  # facet_wrap(~name) +
  labs(x = "Risk Category", y = "Percent", title = "Distribution of Assessments by ORAS Risk Category") 


ggplot(risk_df) +
  aes(x = oras_risk_score, y = value) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3,aes(label = paste0(value, "%")), size = 3) +
  theme_bw() +
  ylim(0,100) +
  facet_wrap(~name) +
  labs(x = "Risk Category", y = "Percent", title = "ORAS Outcomes by Risk Category")


risk_df <- risk_df %>%
  distinct(oras_risk_score, Total)

names(risk_df) <- c("ORAS Risk Level", "Total")

kable(risk_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

```
\newpage

VPRAI
\newline
```{r}
risk_df <- eval_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "VPRAI", !is.na(vprai_risk_score)) %>%
  group_by(vprai_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

ggplot(risk_df %>% distinct(vprai_risk_score, Total) %>% mutate(percent = Total/sum(Total))) +
  aes(x = as.factor(vprai_risk_score), y = percent) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3, aes(label = str_c(round(percent*100), "%")), size = 2.6) +
  theme_bw() +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  # ylim(0,100) +
  # facet_wrap(~name) +
  labs(x = "Risk Category", y = "Percent", title = "Distribution of Assessments by VPRAI Risk Category")    

ggplot(risk_df) +
  aes(x = vprai_risk_score, y = value) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3, aes(label = paste0(value, "%")), size = 3) +
  theme_bw() +
  ylim(0,100) +
  facet_wrap(~name) +
  labs(x = "Risk Category", y = "Percent", title = "VPRAI Outcomes by Risk Category")

risk_df <- risk_df %>%
  distinct(vprai_risk_score, Total)

names(risk_df) <- c("VPRAI Risk Level", "Total")

kable(risk_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

```
\newpage

VPRAI-R
\newline
```{r}
risk_df <- eval_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "VPRAI-R", !is.na(vprair_risk_score)) %>%
  group_by(vprair_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))
  
ggplot(risk_df %>% distinct(vprair_risk_score, Total)%>% mutate(percent = Total/sum(Total))) +
  aes(x = as.factor(vprair_risk_score), y = percent) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3, aes(label = str_c(round(percent*100), "%")), size = 2.6) +
  theme_bw() +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  # ylim(0,100) +
  # facet_wrap(~name) +
  labs(x = "Risk Category", y = "Percent", title = "Distribution of Assessments by VPRAIR Risk Category")  

ggplot(risk_df) +
  aes(x = as.factor(vprair_risk_score), y = value) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3, aes(label = paste0(value, "%")), size = 2.6) +
  theme_bw() +
  ylim(0,100) +
  facet_wrap(~name) +
  labs(x = "Risk Category", y = "Percent", title = "VPRAIR Outcomes by Risk Category")

risk_df <- risk_df %>%
  distinct(vprair_risk_score, Total)

names(risk_df) <- c("VPRAIR Risk Level", "Total")

kable(risk_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

```
\newpage

PSA
\newline
```{r}
risk_df <- eval_df %>%
  filter(tool_name == "PSA",
         !is.na(psa_fta_risk_score)) %>%
  group_by(psa_fta_risk_score) %>%
  summarise(across(c(fta_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag) 

names(risk_df)[1] <- "psa_risk_score"

risk_df2 <- eval_df %>%
  filter(tool_name == "PSA",
         !is.na(psa_nca_risk_score)) %>%
  group_by(psa_nca_risk_score) %>%
  summarise(across(c(recid_arrested_flag, recid_filed_flag, recid_convicted_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[1] <- "psa_risk_score"

risk_df3 <- eval_df %>%
  filter(tool_name == "PSA", !is.na(psa_nvca_risk_score)) %>%
  group_by(psa_nvca_risk_score) %>%
  summarise(across(c(recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[1] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

risk_df <- risk_df %>%
  mutate(psa_risk_score = case_when(name == "New Violent Arrest" & psa_risk_score == 0 ~ "No flag",
                   name == "New Violent Arrest" & psa_risk_score == 1 ~ "Flag",
                   T ~ as.character(psa_risk_score))) %>%
  mutate(psa_risk_score = ordered(psa_risk_score, c("1", "2", "3", "4", "5", "6", "No flag", "Flag")))

ggplot(risk_df %>%
         filter(!name %in% c("New Filing", "New Conviction")) %>%
         mutate(name = case_when(name == "FTA" ~ "PSA FTA Risk Score",
                                 name == "New Arrest" ~ "PSA NCA Risk Score",
                                 name == "New Violent Arrest" ~ "PSA NVCA Risk Score")) %>%
         group_by(name) %>%
         mutate(percent = Total/sum(Total)) %>%
         ungroup()) +
  aes(x = as.factor(psa_risk_score), y = percent) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3, aes(label = str_c(round(percent*100), "%")), size = 2.6) +
  theme_bw() +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent", title = "Distribution of Assessments by PSA Risk Category")  
  
ggplot(risk_df) +
  aes(x = as.factor(psa_risk_score), y = value) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3, aes(label = paste0(value, "%")), size = 2.6) +
  theme_bw() +
  ylim(0,100) +
  # scale_x_discrete(limits = 1:6) +
  facet_wrap(~name, scales = "free_x") +
  labs(x = "Risk Category", y = "Percent", title = "PSA Outcomes by Risk Category")

# risk_df %>%
#   distinct(psa_risk_score, Total)

fta_df <- risk_df %>%
  filter(name == "FTA") %>%
  select(-value, -name) %>%
  rename("PSA FTA Risk Score" = psa_risk_score)

nca_df <- risk_df %>%
  filter(name == "New Arrest") %>%
  select(-value, -name) %>%
  rename("PSA NCA Risk Score" = psa_risk_score)

nvca_df <- risk_df %>%
  filter(name == "New Violent Arrest") %>%
  select(-value, -name) %>%
  rename("PSA NVCA Risk Score" = psa_risk_score)


kable(fta_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

kable(nca_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

kable(nvca_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position")


```
\newpage




Alameda
\newline
```{r}
risk_df <- eval_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "VPRAI-R", !is.na(vprair_risk_score), county == "Alameda") %>%
  group_by(vprair_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

ggplot(risk_df %>% distinct(vprair_risk_score, Total)%>% mutate(percent = Total/sum(Total))) +
  aes(x = as.factor(vprair_risk_score), y = percent) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3, aes(label = str_c(round(percent*100), "%")), size = 2.6) +
  theme_bw() +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  # ylim(0,100) +
  # facet_wrap(~name) +
  labs(x = "Risk Category", y = "Percent", title = "Alameda Distribution of Assessments by VPRAI-R Risk Category")  

ggplot(risk_df) +
  aes(x = as.factor(vprair_risk_score), y = value) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3, aes(label = paste0(value, "%")), size = 2.6) +
  theme_bw() +
  ylim(0,100) +
  facet_wrap(~name) +
  labs(x = "Risk Category", y = "Percent", title = "Alameda VPRAI-R Outcomes by Risk Category")


# ggsave(filename = "Alameda outcomes by risk category.jpeg", device = "jpeg", width = 14, height = 7)


risk_df <- risk_df %>%
  distinct(vprair_risk_score, Total)

names(risk_df) <- c("VPRAI-R Risk Level", "Total")

kable(risk_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

```
\newpage

Los Angeles
\newline
```{r}
risk_df <- eval_df %>%
  filter(tool_name == "PSA", county == "Los Angeles", !is.na(psa_fta_risk_score)) %>%
  group_by(psa_fta_risk_score) %>%
  summarise(across(c(fta_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag) 

names(risk_df)[1] <- "psa_risk_score"

risk_df2 <- eval_df %>%
  filter(tool_name == "PSA", county == "Los Angeles", !is.na(psa_nca_risk_score)) %>%
  group_by(psa_nca_risk_score) %>%
  summarise(across(c(recid_arrested_flag, recid_filed_flag, recid_convicted_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[1] <- "psa_risk_score"

risk_df3 <- eval_df %>%
  filter(tool_name == "PSA", !is.na(psa_nvca_risk_score), county == "Los Angeles") %>%
  group_by(psa_nvca_risk_score) %>%
  summarise(across(c(recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[1] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

risk_df <- risk_df %>%
  mutate(psa_risk_score = case_when(name == "New Violent Arrest" & psa_risk_score == 0 ~ "No flag",
                   name == "New Violent Arrest" & psa_risk_score == 1 ~ "Flag",
                   T ~ as.character(psa_risk_score))) %>%
  mutate(psa_risk_score = ordered(psa_risk_score, c("1", "2", "3", "4", "5", "6", "No flag", "Flag")))

ggplot(risk_df %>%
         filter(!name %in% c("New Filing", "New Conviction")) %>%
         mutate(name = case_when(name == "FTA" ~ "PSA FTA Risk Score",
                                 name == "New Arrest" ~ "PSA NCA Risk Score",
                                 name == "New Violent Arrest" ~ "PSA NVCA Risk Score")) %>%
         group_by(name) %>%
         mutate(percent = Total/sum(Total)) %>%
         ungroup()) +
  aes(x = as.factor(psa_risk_score), y = percent) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3, aes(label = str_c(round(percent*100), "%")), size = 2.6) +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent", title = "Los Angeles Distribution of Assessments by PSA Risk Category")  +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1))
  
ggplot(risk_df) +
  aes(x = as.factor(psa_risk_score), y = value) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3, aes(label = paste0(value, "%")), size = 2.6) +
  theme_bw() +
  ylim(0,100) +
  # scale_x_discrete(limits = 1:6) +
  facet_wrap(~name, scales = "free_x") +
  labs(x = "Risk Category", y = "Percent", title = "Los Angeles PSA Outcomes by Risk Category")

fta_df <- risk_df %>%
  filter(name == "FTA") %>%
  select(-value, -name) %>%
  rename("PSA FTA Risk Score" = psa_risk_score)

nca_df <- risk_df %>%
  filter(name == "New Arrest") %>%
  select(-value, -name) %>%
  rename("PSA NCA Risk Score" = psa_risk_score)

nvca_df <- risk_df %>%
  filter(name == "New Violent Arrest") %>%
  select(-value, -name) %>%
  rename("PSA NVCA Risk Score" = psa_risk_score)


kable(fta_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

kable(nca_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

kable(nvca_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position")

# risk_df %>%
#   distinct(psa_risk_score, Total)
```
\newpage

San Mateo
\newline
```{r}
risk_df <- eval_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "VPRAI-R", !is.na(vprair_risk_score), county == "San Mateo") %>%
  group_by(vprair_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

ggplot(risk_df %>% distinct(vprair_risk_score, Total)%>% mutate(percent = Total/sum(Total))) +
  aes(x = as.factor(vprair_risk_score), y = percent) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3, aes(label = str_c(round(percent*100), "%")), size = 2.6) +
  theme_bw() +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  # ylim(0,100) +
  # facet_wrap(~name) +
  labs(x = "Risk Category", y = "Percent", title = "San Mateo Distribution of Assessments by VPRAI-R Risk Category")  

ggplot(risk_df) +
  aes(x = as.factor(vprair_risk_score), y = value) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3, aes(label = paste0(value, "%")), size = 2.6) +
  theme_bw() +
  ylim(0,100) +
  facet_wrap(~name) +
  labs(x = "Risk Category", y = "Percent", title = "San Mateo VPRAI-R Outcomes by Risk Category")

risk_df <- risk_df %>%
  distinct(vprair_risk_score, Total)

names(risk_df) <- c("VPRAI-R Risk Level", "Total")

kable(risk_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

```
\newpage

Sacramento
\newline
```{r}
risk_df <- eval_df %>%
  filter(tool_name == "PSA", county == "Sacramento") %>%
  group_by(psa_fta_risk_score) %>%
  summarise(across(c(fta_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag) 

names(risk_df)[1] <- "psa_risk_score"

risk_df2 <- eval_df %>%
  filter(tool_name == "PSA", county == "Sacramento") %>%
  group_by(psa_nca_risk_score) %>%
  summarise(across(c(recid_arrested_flag, recid_filed_flag, recid_convicted_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[1] <- "psa_risk_score"

risk_df3 <- eval_df %>%
  filter(tool_name == "PSA", !is.na(psa_nvca_risk_score), county == "Sacramento") %>%
  group_by(psa_nvca_risk_score) %>%
  summarise(across(c(recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[1] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

risk_df <- risk_df %>%
  mutate(psa_risk_score = case_when(name == "New Violent Arrest" & psa_risk_score == 0 ~ "No flag",
                   name == "New Violent Arrest" & psa_risk_score == 1 ~ "Flag",
                   T ~ as.character(psa_risk_score))) %>%
  mutate(psa_risk_score = ordered(psa_risk_score, c("1", "2", "3", "4", "5", "6", "No flag", "Flag")))

ggplot(risk_df %>%
         filter(!name %in% c("New Filing", "New Conviction")) %>%
         mutate(name = case_when(name == "FTA" ~ "PSA FTA Risk Score",
                                 name == "New Arrest" ~ "PSA NCA Risk Score",
                                 name == "New Violent Arrest" ~ "PSA NVCA Risk Score")) %>%
         group_by(name) %>%
         mutate(percent = Total/sum(Total)) %>%
         ungroup()) +
  aes(x = as.factor(psa_risk_score), y = percent) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3, aes(label = str_c(round(percent*100), "%")), size = 2.6) +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent", title = "Sacramento Distribution of Assessments by PSA Risk Category")  +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1))
  
ggplot(risk_df) +
  aes(x = as.factor(psa_risk_score), y = value) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3, aes(label = paste0(value, "%")), size = 2.6) +
  theme_bw() +
  ylim(0,100) +
  # scale_x_discrete(limits = 1:6) +
  facet_wrap(~name, scales = "free_x") +
  labs(x = "Risk Category", y = "Percent", title = "Sacramento PSA Outcomes by Risk Category")

# risk_df %>%
#   distinct(psa_risk_score, Total)

fta_df <- risk_df %>%
  filter(name == "FTA") %>%
  select(-value, -name) %>%
  rename("PSA FTA Risk Score" = psa_risk_score)

nca_df <- risk_df %>%
  filter(name == "New Arrest") %>%
  select(-value, -name) %>%
  rename("PSA NCA Risk Score" = psa_risk_score)

nvca_df <- risk_df %>%
  filter(name == "New Violent Arrest") %>%
  select(-value, -name) %>%
  rename("PSA NVCA Risk Score" = psa_risk_score)


kable(fta_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

kable(nca_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

kable(nvca_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position")
```
\newpage

San Joaquin 
\newline
```{r}
risk_df <- eval_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "VPRAI", !is.na(vprai_risk_score), county == "San Joaquin") %>%
  group_by(vprai_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

ggplot(risk_df %>% distinct(vprai_risk_score, Total)%>% mutate(percent = Total/sum(Total))) +
  aes(x = as.factor(vprai_risk_score), y = percent) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3, aes(label = str_c(round(percent*100), "%")), size = 2.6) +
  theme_bw() +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  # ylim(0,100) +
  # facet_wrap(~name) +
  labs(x = "Risk Category", y = "Percent", title = "San Joaquin Distribution of Assessments by VPRAI Risk Category")    

ggplot(risk_df) +
  aes(x = vprai_risk_score, y = value) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3, aes(label = paste0(value, "%")), size = 3) +
  theme_bw() +
  ylim(0,100) +
  facet_wrap(~name) +
  labs(x = "Risk Category", y = "Percent", title = "San Joaquin VPRAI Outcomes by Risk Category")

risk_df <- risk_df %>%
  distinct(vprai_risk_score, Total)

names(risk_df) <- c("VPRAI Risk Level", "Total")

kable(risk_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position")


```
\newpage

Santa Barbara - TEMPORARILY REMOVED
\newline
```{r eval=FALSE, include=FALSE}
risk_df <- eval_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "VPRAI-R", !is.na(vprair_risk_score), county == "Santa Barbara") %>%
  group_by(vprair_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

ggplot(risk_df %>% distinct(vprair_risk_score, Total)%>% mutate(percent = Total/sum(Total))) +
  aes(x = as.factor(vprair_risk_score), y = percent) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3, aes(label = str_c(round(percent*100), "%")), size = 2.6) +
  theme_bw() +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  # ylim(0,100) +
  # facet_wrap(~name) +
  labs(x = "Risk Category", y = "Percent", title = "Santa Barbara Distribution of Assessments by VPRAIR Risk Category")  

ggplot(risk_df) +
  aes(x = as.factor(vprair_risk_score), y = value) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3, aes(label = paste0(value, "%")), size = 2.6) +
  theme_bw() +
  ylim(0,100) +
  facet_wrap(~name) +
  labs(x = "Risk Category", y = "Percent", title = "Santa Barbara VPRAIR Outcomes by Risk Category")

#ggsave(filename = "Santa Barbara outcomes by risk category.jpeg", device = "jpeg", width = 14, height = 7)


risk_df <- risk_df %>%
  distinct(vprair_risk_score, Total)

names(risk_df) <- c("VPRAIR Risk Level", "Total")

kable(risk_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position")
```
\newpage

Sonoma
\newline
```{r}
risk_df <- eval_df %>%
  filter(tool_name == "PSA", county == "Sonoma") %>%
  group_by(psa_fta_risk_score) %>%
  summarise(across(c(fta_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag) 

names(risk_df)[1] <- "psa_risk_score"

risk_df2 <- eval_df %>%
  filter(tool_name == "PSA", county == "Sonoma") %>%
  group_by(psa_nca_risk_score) %>%
  summarise(across(c(recid_arrested_flag, recid_filed_flag, recid_convicted_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[1] <- "psa_risk_score"

risk_df3 <- eval_df %>%
  filter(tool_name == "PSA", !is.na(psa_nvca_risk_score), county == "Sonoma") %>%
  group_by(psa_nvca_risk_score) %>%
  summarise(across(c(recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[1] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

risk_df <- risk_df %>%
  mutate(psa_risk_score = case_when(name == "New Violent Arrest" & psa_risk_score == 0 ~ "No flag",
                   name == "New Violent Arrest" & psa_risk_score == 1 ~ "Flag",
                   T ~ as.character(psa_risk_score))) %>%
  mutate(psa_risk_score = ordered(psa_risk_score, c("1", "2", "3", "4", "5", "6", "No flag", "Flag")))

ggplot(risk_df %>%
         filter(!name %in% c("New Filing", "New Conviction")) %>%
         mutate(name = case_when(name == "FTA" ~ "PSA FTA Risk Score",
                                 name == "New Arrest" ~ "PSA NCA Risk Score",
                                 name == "New Violent Arrest" ~ "PSA NVCA Risk Score")) %>%
         group_by(name) %>%
         mutate(percent = Total/sum(Total)) %>%
         ungroup()) +
  aes(x = as.factor(psa_risk_score), y = percent) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3, aes(label = str_c(round(percent*100), "%")), size = 2.6) +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent", title = "Sonoma Distribution of Assessments by PSA Risk Category")  +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) 
  
ggplot(risk_df %>%
         mutate(psa_risk_score = case_when(name == "New Violent Arrest" & psa_risk_score == 0 ~ "No flag",
                   name == "New Violent Arrest" & psa_risk_score == 1 ~ "Flag",
                   T ~ as.character(psa_risk_score))) %>%
         mutate(psa_risk_score = ordered(psa_risk_score, c("1", "2", "3", "4", "5", "6", "No flag", "Flag")))) +
  aes(x = as.factor(psa_risk_score), y = value) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3, aes(label = paste0(value, "%")), size = 2.6) +
  theme_bw() +
  ylim(0,100) +
  # scale_x_discrete(limits = 1:6) +
  facet_wrap(~name, scales = "free_x") +
  labs(x = "Risk Category", y = "Percent", title = "Sonoma PSA Outcomes by Risk Category")

# risk_df %>%
#   distinct(psa_risk_score, Total)

fta_df <- risk_df %>%
  filter(name == "FTA") %>%
  select(-value, -name) %>%
  rename("PSA FTA Risk Score" = psa_risk_score)

nca_df <- risk_df %>%
  filter(name == "New Arrest") %>%
  select(-value, -name) %>%
  rename("PSA NCA Risk Score" = psa_risk_score)

nvca_df <- risk_df %>%
  filter(name == "New Violent Arrest") %>%
  select(-value, -name) %>%
  rename("PSA NVCA Risk Score" = psa_risk_score)


kable(fta_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

kable(nca_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

kable(nvca_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position")
```
\newpage

Ventura
\newline
```{r}
risk_df <- eval_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "ORAS", !is.na(oras_risk_score), county == "Ventura") %>%
  group_by(oras_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing",
                                        "New Conviction", "New Violent Arrest")))
  
ggplot(risk_df %>% distinct(oras_risk_score, Total)%>% mutate(percent = Total/sum(Total))) +
  aes(x = as.factor(oras_risk_score), y = percent) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3, aes(label = str_c(round(percent*100), "%")), size = 2.6) +
  theme_bw() +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  # ylim(0,100) +
  # facet_wrap(~name) +
  labs(x = "Risk Category", y = "Percent", title = "Ventura Distribution of Assessments by ORAS Risk Category") 

ggplot(risk_df) +
  aes(x = oras_risk_score, y = value) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3,aes(label = paste0(value, "%")), size = 3) +
  theme_bw() +
  ylim(0,100) +
  facet_wrap(~name) +
  labs(x = "Risk Category", y = "Percent", title = "Ventura ORAS Outcomes by Risk Category")

risk_df <- risk_df %>%
  distinct(oras_risk_score, Total)

names(risk_df) <- c("ORAS Risk Level", "Total")

kable(risk_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

```
\newpage

Modoc
\newline
```{r}
risk_df <- eval_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "ORAS", !is.na(oras_risk_score), county == "Modoc") %>%
  group_by(oras_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing",
                                        "New Conviction", "New Violent Arrest")))
  
ggplot(risk_df %>% distinct(oras_risk_score, Total)%>% mutate(percent = Total/sum(Total))) +
  aes(x = as.factor(oras_risk_score), y = percent) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3, aes(label = str_c(round(percent*100), "%")), size = 2.6) +
  theme_bw() +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  # ylim(0,100) +
  # facet_wrap(~name) +
  labs(x = "Risk Category", y = "Percent", title = "Modoc Distribution of Assessments by ORAS Risk Category") 

ggplot(risk_df) +
  aes(x = oras_risk_score, y = value) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3,aes(label = paste0(value, "%")), size = 3) +
  theme_bw() +
  ylim(0,100) +
  facet_wrap(~name) +
  labs(x = "Risk Category", y = "Percent", title = "Modoc ORAS Outcomes by Risk Category")

risk_df <- risk_df %>%
  distinct(oras_risk_score, Total)

names(risk_df) <- c("ORAS Risk Level", "Total")

kable(risk_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

```
\newpage

Napa
\newline
```{r}
risk_df <- eval_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "ORAS", !is.na(oras_risk_score), county == "Napa") %>%
  group_by(oras_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing",
                                        "New Conviction", "New Violent Arrest")))
  
ggplot(risk_df %>% distinct(oras_risk_score, Total)%>% mutate(percent = Total/sum(Total))) +
  aes(x = as.factor(oras_risk_score), y = percent) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3, aes(label = str_c(round(percent*100), "%")), size = 2.6) +
  theme_bw() +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  # ylim(0,100) +
  # facet_wrap(~name) +
  labs(x = "Risk Category", y = "Percent", title = "Napa Distribution of Assessments by ORAS Risk Category") 

ggplot(risk_df) +
  aes(x = oras_risk_score, y = value) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3,aes(label = paste0(value, "%")), size = 3) +
  theme_bw() +
  ylim(0,100) +
  facet_wrap(~name) +
  labs(x = "Risk Category", y = "Percent", title = "Napa ORAS Outcomes by Risk Category")

risk_df <- risk_df %>%
  distinct(oras_risk_score, Total)

names(risk_df) <- c("ORAS Risk Level", "Total")

kable(risk_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

```
\newpage

Tulare
\newline
```{r}
risk_df <- eval_df %>%
  filter(tool_name == "PSA", county == "Tulare") %>%
  group_by(psa_fta_risk_score) %>%
  summarise(across(c(fta_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag) 

names(risk_df)[1] <- "psa_risk_score"

risk_df2 <- eval_df %>%
  filter(tool_name == "PSA", county == "Tulare") %>%
  group_by(psa_nca_risk_score) %>%
  summarise(across(c(recid_arrested_flag, recid_filed_flag, recid_convicted_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[1] <- "psa_risk_score"

risk_df3 <- eval_df %>%
  filter(tool_name == "PSA", !is.na(psa_nvca_risk_score), county == "Tulare") %>%
  group_by(psa_nvca_risk_score) %>%
  summarise(across(c(recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[1] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

risk_df <- risk_df %>%
  mutate(psa_risk_score = case_when(name == "New Violent Arrest" & psa_risk_score == 0 ~ "No flag",
                   name == "New Violent Arrest" & psa_risk_score == 1 ~ "Flag",
                   T ~ as.character(psa_risk_score))) %>%
  mutate(psa_risk_score = ordered(psa_risk_score, c("1", "2", "3", "4", "5", "6", "No flag", "Flag")))

ggplot(risk_df %>%
         filter(!name %in% c("New Filing", "New Conviction")) %>%
         mutate(name = case_when(name == "FTA" ~ "PSA FTA Risk Score",
                                 name == "New Arrest" ~ "PSA NCA Risk Score",
                                 name == "New Violent Arrest" ~ "PSA NVCA Risk Score")) %>%
         group_by(name) %>%
         mutate(percent = Total/sum(Total)) %>%
         ungroup()) +
  aes(x = as.factor(psa_risk_score), y = percent) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3, aes(label = str_c(round(percent*100), "%")), size = 2.6) +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent", title = "Tulare Distribution of Assessments by PSA Risk Category")  +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) 
  
ggplot(risk_df %>%
         mutate(psa_risk_score = case_when(name == "New Violent Arrest" & psa_risk_score == 0 ~ "No flag",
                   name == "New Violent Arrest" & psa_risk_score == 1 ~ "Flag",
                   T ~ as.character(psa_risk_score))) %>%
         mutate(psa_risk_score = ordered(psa_risk_score, c("1", "2", "3", "4", "5", "6", "No flag", "Flag")))) +
  aes(x = as.factor(psa_risk_score), y = value) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3, aes(label = paste0(value, "%")), size = 2.6) +
  theme_bw() +
  ylim(0,100) +
  # scale_x_discrete(limits = 1:6) +
  facet_wrap(~name, scales = "free_x") +
  labs(x = "Risk Category", y = "Percent", title = "Tulare PSA Outcomes by Risk Category")

# risk_df %>%
#   distinct(psa_risk_score, Total)

fta_df <- risk_df %>%
  filter(name == "FTA") %>%
  select(-value, -name) %>%
  rename("PSA FTA Risk Score" = psa_risk_score)

nca_df <- risk_df %>%
  filter(name == "New Arrest") %>%
  select(-value, -name) %>%
  rename("PSA NCA Risk Score" = psa_risk_score)

nvca_df <- risk_df %>%
  filter(name == "New Violent Arrest") %>%
  select(-value, -name) %>%
  rename("PSA NVCA Risk Score" = psa_risk_score)


kable(fta_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

kable(nca_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

kable(nvca_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position")
```
\newpage

Calaveras
\newline
```{r}
risk_df <- eval_df %>%
  filter(tool_name == "PSA", county == "Calaveras") %>%
  group_by(psa_fta_risk_score) %>%
  summarise(across(c(fta_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag) 

names(risk_df)[1] <- "psa_risk_score"

risk_df2 <- eval_df %>%
  filter(tool_name == "PSA", county == "Calaveras") %>%
  group_by(psa_nca_risk_score) %>%
  summarise(across(c(recid_arrested_flag, recid_filed_flag, recid_convicted_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[1] <- "psa_risk_score"

risk_df3 <- eval_df %>%
  filter(tool_name == "PSA", !is.na(psa_nvca_risk_score), county == "Calaveras") %>%
  group_by(psa_nvca_risk_score) %>%
  summarise(across(c(recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[1] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

risk_df <- risk_df %>%
  mutate(psa_risk_score = case_when(name == "New Violent Arrest" & psa_risk_score == 0 ~ "No flag",
                   name == "New Violent Arrest" & psa_risk_score == 1 ~ "Flag",
                   T ~ as.character(psa_risk_score))) %>%
  mutate(psa_risk_score = ordered(psa_risk_score, c("1", "2", "3", "4", "5", "6", "No flag", "Flag")))

ggplot(risk_df %>%
         filter(!name %in% c("New Filing", "New Conviction")) %>%
         mutate(name = case_when(name == "FTA" ~ "PSA FTA Risk Score",
                                 name == "New Arrest" ~ "PSA NCA Risk Score",
                                 name == "New Violent Arrest" ~ "PSA NVCA Risk Score")) %>%
         group_by(name) %>%
         mutate(percent = Total/sum(Total)) %>%
         ungroup()) +
  aes(x = as.factor(psa_risk_score), y = percent) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3, aes(label = str_c(round(percent*100), "%")), size = 2.6) +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent", title = "Calaveras Distribution of Assessments by PSA Risk Category")  +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) 
  
ggplot(risk_df %>%
         mutate(psa_risk_score = case_when(name == "New Violent Arrest" & psa_risk_score == 0 ~ "No flag",
                   name == "New Violent Arrest" & psa_risk_score == 1 ~ "Flag",
                   T ~ as.character(psa_risk_score))) %>%
         mutate(psa_risk_score = ordered(psa_risk_score, c("1", "2", "3", "4", "5", "6", "No flag", "Flag")))) +
  aes(x = as.factor(psa_risk_score), y = value) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3, aes(label = paste0(value, "%")), size = 2.6) +
  theme_bw() +
  ylim(0,100) +
  # scale_x_discrete(limits = 1:6) +
  facet_wrap(~name, scales = "free_x") +
  labs(x = "Risk Category", y = "Percent", title = "Calaveras PSA Outcomes by Risk Category")

# risk_df %>%
#   distinct(psa_risk_score, Total)

fta_df <- risk_df %>%
  filter(name == "FTA") %>%
  select(-value, -name) %>%
  rename("PSA FTA Risk Score" = psa_risk_score)

nca_df <- risk_df %>%
  filter(name == "New Arrest") %>%
  select(-value, -name) %>%
  rename("PSA NCA Risk Score" = psa_risk_score)

nvca_df <- risk_df %>%
  filter(name == "New Violent Arrest") %>%
  select(-value, -name) %>%
  rename("PSA NVCA Risk Score" = psa_risk_score)


kable(fta_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

kable(nca_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

kable(nvca_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position")
```
\newpage

# Logistic Regression

VPRAI
\newline
```{r, results='asis'}
m1 <- glm(family = binomial(),fta_flag ~ vprai_risk_score + release_to_pretrial_end , data = eval_df %>% filter(tool_name == "VPRAI"))
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprai_risk_score + release_to_pretrial_end , data = eval_df %>% filter(tool_name == "VPRAI"))
m3 <- glm(family = binomial(),recid_filed_flag ~ vprai_risk_score + release_to_pretrial_end , data = eval_df %>% filter(tool_name == "VPRAI"))
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprai_risk_score + release_to_pretrial_end , data = eval_df %>% filter(tool_name == "VPRAI"))
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprai_risk_score + release_to_pretrial_end , data = eval_df %>% filter(tool_name == "VPRAI"))
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprai_risk_score + release_to_pretrial_end , data = eval_df %>% filter(tool_name == "VPRAI"))

stargazer(list(m1,m2,m3,m4,m5,m6),
          # type = "text", 
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("VPRAI Risk Score", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

VPRAI-R
\newline
```{r, results='asis'}
m1 <- glm(family = binomial(),fta_flag ~ vprair_risk_score + release_to_pretrial_end , data = eval_df %>% filter(tool_name == "VPRAI-R"))
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprair_risk_score + release_to_pretrial_end , data = eval_df %>% filter(tool_name == "VPRAI-R"))
m3 <- glm(family = binomial(),recid_filed_flag ~ vprair_risk_score + release_to_pretrial_end , data = eval_df %>% filter(tool_name == "VPRAI-R"))
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprair_risk_score + release_to_pretrial_end , data = eval_df %>% filter(tool_name == "VPRAI-R"))
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprair_risk_score + release_to_pretrial_end , data = eval_df %>% filter(tool_name == "VPRAI-R"))
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprair_risk_score + release_to_pretrial_end , data = eval_df %>% filter(tool_name == "VPRAI-R"))

stargazer(list(m1,m2,m3,m4,m5,m6),
          # type = "text", 
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("VPRAIR Risk Score", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")

```
\newpage

ORAS
\newline
```{r, results='asis'}
m1 <- glm(family = binomial(),fta_flag ~ oras_risk_score + release_to_pretrial_end , data = eval_df %>% filter(tool_name == "ORAS"))
m2 <- glm(family = binomial(),recid_arrested_flag ~ oras_risk_score + release_to_pretrial_end , data = eval_df %>% filter(tool_name == "ORAS"))
m3 <- glm(family = binomial(),recid_filed_flag ~ oras_risk_score + release_to_pretrial_end , data = eval_df %>% filter(tool_name == "ORAS"))
m4 <- glm(family = binomial(),recid_convicted_flag ~ oras_risk_score + release_to_pretrial_end , data = eval_df %>% filter(tool_name == "ORAS"))
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ oras_risk_score + release_to_pretrial_end , data = eval_df %>% filter(tool_name == "ORAS"))
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ oras_risk_score + release_to_pretrial_end , data = eval_df %>% filter(tool_name == "ORAS"))

stargazer(list(m1,m2,m3,m4,m5,m6),
          # type = "text", 
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("ORAS Risk Score", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

PSA
\newline
```{r, results='asis'}
m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score + release_to_pretrial_end , data = eval_df %>% filter(tool_name == "PSA"))
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score + release_to_pretrial_end , data = eval_df %>% filter(tool_name == "PSA"))
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score + release_to_pretrial_end , data = eval_df %>% filter(tool_name == "PSA"))
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score + release_to_pretrial_end , data = eval_df %>% filter(tool_name == "PSA"))
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score + release_to_pretrial_end , data = eval_df %>% filter(tool_name == "PSA"))

stargazer(list(m1,m2,m3,m4,m5),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", "PSA NVCA Risk Score", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

Alameda
\newline
```{r, results='asis'}
county_df <- eval_df %>%
  filter(county == "Alameda")

m1 <- glm(family = binomial(),fta_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)

stargazer(list(m1,m2,m3,m4,m5,m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("VPRAI-R Risk Score", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

Alameda with zero bail dummy
\newline
```{r, results='asis'}
county_df <- eval_df %>%
  filter(county == "Alameda")

m1 <- glm(family = binomial(),fta_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)

summary(m1)
summary(m2)
summary(m3)
summary(m4)
summary(m5)
summary(m6)

# main effect of zero bail dummy
m1 <- glm(family = binomial(),fta_flag ~ vprair_risk_score + zero_bail_dummy + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprair_risk_score + zero_bail_dummy + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprair_risk_score + zero_bail_dummy + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprair_risk_score + zero_bail_dummy + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprair_risk_score + zero_bail_dummy + release_to_pretrial_end , data = county_df)
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprair_risk_score + zero_bail_dummy + release_to_pretrial_end , data = county_df)

summary(m1)
summary(m2)
summary(m3)
summary(m4)
summary(m5)
summary(m6)

# main effect of zero bail dummy
m1 <- glm(family = binomial(),fta_flag ~ vprair_risk_score*zero_bail_dummy + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprair_risk_score*zero_bail_dummy + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprair_risk_score*zero_bail_dummy + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprair_risk_score*zero_bail_dummy + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprair_risk_score*zero_bail_dummy + release_to_pretrial_end , data = county_df)
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprair_risk_score*zero_bail_dummy + release_to_pretrial_end , data = county_df)

summary(m1)
summary(m2)
summary(m3)
summary(m4)
summary(m5)
summary(m6)
```
\newpage

Los Angeles
\newline
```{r, results='asis'}
county_df <- eval_df %>%
  filter(county == "Los Angeles", tool_name == "PSA")

m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score + release_to_pretrial_end , data = county_df %>% filter(!is.na(psa_fta_risk_score)))
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score + release_to_pretrial_end , data = county_df %>% filter(!is.na(psa_nca_risk_score)))
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score + release_to_pretrial_end , data = county_df %>% filter(!is.na(psa_nca_risk_score)))
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score + release_to_pretrial_end , data = county_df %>% filter(!is.na(psa_nca_risk_score)))
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score + release_to_pretrial_end , data = county_df %>% filter(!is.na(psa_nvca_risk_score)))

stargazer(list(m1,m2,m3,m4,m5),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", "PSA NVCA Risk Score", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

Los Angeles with zero bail dummy
```{r}
county_df <- eval_df %>%
  filter(county == "Los Angeles", tool_name == "PSA")

# main effect of zero bail dummy
m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score + release_to_pretrial_end + zero_bail_dummy, data = county_df %>% filter(!is.na(psa_fta_risk_score)))
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score + release_to_pretrial_end + zero_bail_dummy, data = county_df %>% filter(!is.na(psa_nca_risk_score)))
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score + release_to_pretrial_end + zero_bail_dummy, data = county_df %>% filter(!is.na(psa_nca_risk_score)))
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score + release_to_pretrial_end + zero_bail_dummy, data = county_df %>% filter(!is.na(psa_nca_risk_score)))
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score + release_to_pretrial_end + zero_bail_dummy, data = county_df %>% filter(!is.na(psa_nvca_risk_score)))

stargazer(list(m1,m2,m3,m4,m5),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", "PSA NVCA Risk Score", "Days Released", "Mandatory Zero Bail Timeframe"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")

summary(m1)
summary(m2)
summary(m3)
summary(m4)
summary(m5)

# interaction of zero bail dummy with risk score
m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score*zero_bail_dummy + release_to_pretrial_end, data = county_df %>% filter(!is.na(psa_fta_risk_score)))
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score*zero_bail_dummy + release_to_pretrial_end, data = county_df %>% filter(!is.na(psa_nca_risk_score)))
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score*zero_bail_dummy + release_to_pretrial_end, data = county_df %>% filter(!is.na(psa_nca_risk_score)))
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score*zero_bail_dummy + release_to_pretrial_end, data = county_df %>% filter(!is.na(psa_nca_risk_score)))
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score*zero_bail_dummy + release_to_pretrial_end, data = county_df %>% filter(!is.na(psa_nvca_risk_score)))

stargazer(list(m1,m2,m3,m4,m5),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", "PSA NVCA Risk Score", "Days Released", "Mandatory Zero Bail Timeframe"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")

summary(m1)
summary(m2)
summary(m3)
summary(m4)
summary(m5)

# look at when zero_bail_dummy is 1
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score*(zero_bail_dummy-1) + release_to_pretrial_end, data = county_df %>% filter(!is.na(psa_nca_risk_score)))

summary(m2)
```
Los Angeles graphs with zero bail dummy
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  filter(county == "Los Angeles") %>%
  filter(tool_name == "PSA", !is.na(psa_fta_risk_score)) %>%
  group_by(psa_fta_risk_score, zero_bail_dummy, county) %>%
  select(fta_flag) %>%
  pivot_longer(fta_flag) 

names(risk_df)[1] <- "psa_risk_score"

risk_df2 <- eval_df %>%
  filter(county == "Los Angeles") %>%
  filter(tool_name == "PSA", !is.na(psa_nca_risk_score)) %>%
  group_by(psa_nca_risk_score, zero_bail_dummy, county) %>%
  select(recid_arrested_flag, recid_filed_flag, recid_convicted_flag) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[1] <- "psa_risk_score"

risk_df3 <- eval_df %>%
  filter(county == "Los Angeles") %>%
  filter(tool_name == "PSA", !is.na(psa_nvca_risk_score)) %>%
  group_by(psa_nvca_risk_score, zero_bail_dummy, county) %>%
  select(recid_arrest_violent_psa_flag) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[1] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(zero_bail_dummy = factor(zero_bail_dummy)) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) 

ggplot(risk_df) +
  aes(x = psa_risk_score, y = value, color = zero_bail_dummy) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent",
       title = "Comparison of  Logistic Regression Curves during and outside of the mandatory zero bail period--PSA, Los Angeles") +
  scale_x_continuous(breaks = 1:6)

# eval_df %>%
#   filter(tool_name == "PSA") %>%
#   count(county)


```
\newpage
Sacramento
\newline
```{r, results='asis'}
county_df <- eval_df %>%
  filter(county == "Sacramento")

m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score + release_to_pretrial_end , data = county_df)

stargazer(list(m1,m2,m3,m4,m5),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", "PSA NVCA Risk Score", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

San Mateo
\newline
```{r, results='asis'}
county_df <- eval_df %>%
  filter(county == "San Mateo")

m1 <- glm(family = binomial(),fta_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)

stargazer(list(m1,m2,m3,m4,m5,m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("VPRAI-R Risk Score", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

San Mateo with zero bail dummy
\newline
```{r, results='asis'}
county_df <- eval_df %>%
  filter(county == "San Mateo")

m1 <- glm(family = binomial(),fta_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)

summary(m1)
summary(m2)
summary(m3)
summary(m4)
summary(m5)
summary(m6)

stargazer(list(m1,m2,m3,m4,m5,m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("VPRAI-R Risk Score", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")

# main effect of zero bail dummy
m1 <- glm(family = binomial(),fta_flag ~ vprair_risk_score + zero_bail_dummy + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprair_risk_score + zero_bail_dummy + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprair_risk_score + zero_bail_dummy + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprair_risk_score + zero_bail_dummy + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprair_risk_score + zero_bail_dummy + release_to_pretrial_end , data = county_df)
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprair_risk_score + zero_bail_dummy + release_to_pretrial_end , data = county_df)

summary(m1)
summary(m2)
summary(m3)
summary(m4)
summary(m5)
summary(m6)

# risk score interacted with zero bail dummy
m1 <- glm(family = binomial(),fta_flag ~ vprair_risk_score*zero_bail_dummy + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprair_risk_score*zero_bail_dummy + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprair_risk_score*zero_bail_dummy + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprair_risk_score*zero_bail_dummy + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprair_risk_score*zero_bail_dummy + release_to_pretrial_end , data = county_df)
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprair_risk_score*zero_bail_dummy + release_to_pretrial_end , data = county_df)

summary(m1)
summary(m2)
summary(m3)
summary(m4)
summary(m5)
summary(m6)
```
\newpage

San Joaquin 
\newline
```{r results='asis'}
county_df <- eval_df %>%
  filter(county == "San Joaquin")

m1 <- glm(family = binomial(),fta_flag ~ vprai_risk_score + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprai_risk_score + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprai_risk_score + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprai_risk_score + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprai_risk_score + release_to_pretrial_end , data = county_df)
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprai_risk_score + release_to_pretrial_end , data = county_df)

stargazer(list(m1,m2,m3,m4,m5,m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("VPRAI Risk Score", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

San Joaquin with zero bail dummy
\newline
```{r results='asis'}
county_df <- eval_df %>%
  filter(county == "San Joaquin")

m1 <- glm(family = binomial(),fta_flag ~ vprai_risk_score + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprai_risk_score + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprai_risk_score + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprai_risk_score + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprai_risk_score + release_to_pretrial_end , data = county_df)
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprai_risk_score + release_to_pretrial_end , data = county_df)

summary(m1)
summary(m2)
summary(m3)
summary(m4)
summary(m5)
summary(m6)

# main effect of zero bail dummy
m1 <- glm(family = binomial(),fta_flag ~ vprai_risk_score + zero_bail_dummy + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprai_risk_score + zero_bail_dummy + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprai_risk_score + zero_bail_dummy + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprai_risk_score + zero_bail_dummy + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprai_risk_score + zero_bail_dummy + release_to_pretrial_end , data = county_df)
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprai_risk_score + zero_bail_dummy + release_to_pretrial_end , data = county_df)

summary(m1)
summary(m2)
summary(m3)
summary(m4)
summary(m5)
summary(m6)

#interaction of zero bail dummy
m1 <- glm(family = binomial(),fta_flag ~ vprai_risk_score*zero_bail_dummy + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprai_risk_score*zero_bail_dummy + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprai_risk_score*zero_bail_dummy + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprai_risk_score*zero_bail_dummy + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprai_risk_score*zero_bail_dummy + release_to_pretrial_end , data = county_df)
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprai_risk_score*zero_bail_dummy + release_to_pretrial_end , data = county_df)

summary(m1)
summary(m2)
summary(m3)
summary(m4)
summary(m5)
summary(m6)

```
\newpage


Santa Barbara  - TEMPORARILY REMOVED
\newline
```{r eval=FALSE, include=FALSE, results='asis'}
county_df <- eval_df %>%
  filter(county == "Santa Barbara")

m1 <- glm(family = binomial(),fta_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)

stargazer(list(m1,m2,m3,m4,m5,m6),
          # type = "text", 
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("VPRAIR Risk Score", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

Sonoma
\newline
```{r, results='asis'}
county_df <- eval_df %>%
  filter(county == "Sonoma")

m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score + release_to_pretrial_end , data = county_df)

stargazer(list(m1,m2,m3,m4,m5),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", "PSA NVCA Risk Score", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

Ventura
\newline
```{r, results='asis'}
county_df <- eval_df %>%
  filter(county == "Ventura")

m1 <- glm(family = binomial(),fta_flag ~ oras_risk_score + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ oras_risk_score + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ oras_risk_score + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ oras_risk_score + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ oras_risk_score + release_to_pretrial_end , data = county_df)
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ oras_risk_score + release_to_pretrial_end , data = county_df)

stargazer(list(m1,m2,m3,m4,m5,m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("ORAS Risk Score", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

Modoc
\newline
```{r, results='asis'}
county_df <- eval_df %>%
  filter(county == "Modoc")

m1 <- glm(family = binomial(),fta_flag ~ oras_risk_score + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ oras_risk_score + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ oras_risk_score + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ oras_risk_score + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ oras_risk_score + release_to_pretrial_end , data = county_df)
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ oras_risk_score + release_to_pretrial_end , data = county_df)

stargazer(list(m1,m2,m3,m4,m5,m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("ORAS Risk Score", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

Napa
\newline
```{r, results='asis'}
county_df <- eval_df %>%
  filter(county == "Napa")

m1 <- glm(family = binomial(),fta_flag ~ oras_risk_score + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ oras_risk_score + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ oras_risk_score + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ oras_risk_score + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ oras_risk_score + release_to_pretrial_end , data = county_df)
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ oras_risk_score + release_to_pretrial_end , data = county_df)

stargazer(list(m1,m2,m3,m4,m5,m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("ORAS Risk Score", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

Tulare
\newline
```{r, results='asis'}
county_df <- eval_df %>%
  filter(county == "Tulare")

m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score + release_to_pretrial_end , data = county_df)

stargazer(list(m1,m2,m3,m4,m5),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", "PSA NVCA Risk Score", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

Calaveras
\newline
```{r, results='asis'}
county_df <- eval_df %>%
  filter(county == "Calaveras")

m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score + release_to_pretrial_end , data = county_df)

stargazer(list(m1,m2,m3,m4,m5),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", "PSA NVCA Risk Score", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage


# Pull AUCs from table
VPRAI
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "VPRAI", race == "All", sex == "All", county == "All") %>%
  select(outcome, AUC, CI, n) %>%
 mutate(outcome = case_when(outcome == "fta_flag" ~ "FTA",                              
                            outcome == "recid_arrested_flag" ~ "New Arrest",                              
                            outcome == "recid_filed_flag" ~ "New Filing",                              
                            outcome == "recid_convicted_flag" ~ "New Conviction",                              
                            outcome == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest",                              
                            outcome == "any_pretrial_failure_flag" ~ "FTA or New Arrest"))

names(tool_df) <- c("Outcome", "AUC", "CI (95%)", "N")

kable(tool_df %>% select(-starts_with("N")), booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12,
                  latex_options = "hold_position") %>%
  footnote(paste("N =", tool_df$N[1]))
  
```
\newpage

VPRAI-R
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "VPRAI-R", race == "All", sex == "All", county == "All") %>%
  select(outcome, AUC, CI, n) %>%
 mutate(outcome = case_when(outcome == "fta_flag" ~ "FTA",                              
                            outcome == "recid_arrested_flag" ~ "New Arrest",                              
                            outcome == "recid_filed_flag" ~ "New Filing",                              
                            outcome == "recid_convicted_flag" ~ "New Conviction",                              
                            outcome == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest",                              
                            outcome == "any_pretrial_failure_flag" ~ "FTA or New Arrest"))

names(tool_df) <- c("Outcome", "AUC", "CI (95%)", "N")

kable(tool_df %>% select(-starts_with("N")), booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, 
                  latex_options = "hold_position") %>%
  footnote(paste("N =", tool_df$N[1]))
```
\newpage

ORAS
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "ORAS", race == "All", sex == "All", county == "All") %>%
  select(outcome, AUC, CI, n) %>%
 mutate(outcome = case_when(outcome == "fta_flag" ~ "FTA",                              
                            outcome == "recid_arrested_flag" ~ "New Arrest",                              
                            outcome == "recid_filed_flag" ~ "New Filing",                              
                            outcome == "recid_convicted_flag" ~ "New Conviction",                              
                            outcome == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest",                              
                            outcome == "any_pretrial_failure_flag" ~ "FTA or New Arrest"))

names(tool_df) <- c("Outcome", "AUC", "CI (95%)", "N")

kable(tool_df %>% select(-starts_with("N")), booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, 
                  latex_options = "hold_position") %>%
  footnote(paste("N =", tool_df$N[1]))
```
\newpage

PSA
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "PSA", race == "All", sex == "All", county == "All") %>%
  select(risk_score, outcome, AUC, CI, n) %>%
  mutate(risk_score = case_when(risk_score == "psa_fta_risk_score" ~ "PSA FTA",
                                risk_score == "psa_nca_risk_score" ~ "PSA NCA",
                                risk_score == "psa_nvca_risk_score" ~ "PSA NVCA")) %>%
  mutate(outcome = case_when(outcome == "fta_flag" ~ "FTA",
                             outcome == "recid_arrested_flag" ~ "New Arrest",
                             outcome == "recid_filed_flag" ~ "New Filing",
                             outcome == "recid_convicted_flag" ~ "New Conviction",
                             outcome == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest",
                             outcome == "any_pretrial_failure_flag" ~ "FTA or New Arrest"))

names(tool_df) <- c("Risk Score", "Outcome", "AUC", "CI (95%)", "N")

kable(tool_df %>% select(-starts_with("N")), booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, 
                  latex_options = "hold_position") %>%
  footnote(paste("N =", tool_df$N[1]))
```
\newpage

Alameda 
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "VPRAI-R", race == "All", sex == "All", county == "Alameda") %>%
  select(outcome, AUC, CI, n) %>%
  mutate(outcome = case_when(outcome == "fta_flag" ~ "FTA",
                             outcome == "recid_arrested_flag" ~ "New Arrest",
                             outcome == "recid_filed_flag" ~ "New Filing",
                             outcome == "recid_convicted_flag" ~ "New Conviction",
                             outcome == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest",
                             outcome == "any_pretrial_failure_flag" ~ "FTA or New Arrest"))

names(tool_df) <- c("Outcome", "AUC", "CI (95%)", "N")

kable(tool_df %>% select(-starts_with("N")), booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12,
                  latex_options = "hold_position") %>%
  footnote(paste("N =", tool_df$N[1]))


```
\newpage

Los Angeles
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "PSA", race == "All", sex == "All", county == "Los Angeles") %>%
  select(risk_score, outcome, AUC, CI, n) %>%
  mutate(risk_score = case_when(risk_score == "psa_fta_risk_score" ~ "PSA FTA",                                 
                                risk_score == "psa_nca_risk_score" ~ "PSA NCA",                                 
                                risk_score == "psa_nvca_risk_score" ~ "PSA NVCA")) %>%
  mutate(outcome = case_when(outcome == "fta_flag" ~ "FTA",
                             outcome == "recid_arrested_flag" ~ "New Arrest",
                             outcome == "recid_filed_flag" ~ "New Filing",
                             outcome == "recid_convicted_flag" ~ "New Conviction",
                             outcome == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest",
                             outcome == "any_pretrial_failure_flag" ~ "FTA or New Arrest"))

names(tool_df) <- c("Risk Score", "Outcome", "AUC", "CI (95%)", "N")

kable(tool_df %>% select(-starts_with("N")), booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12,
                  latex_options = "hold_position") %>%
  footnote(paste("N =", tool_df$N[1]))
```
\newpage

San Mateo 
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "VPRAI-R", race == "All", sex == "All", county == "San Mateo") %>%
  select(outcome, AUC, CI, n) %>%
  mutate(outcome = case_when(outcome == "fta_flag" ~ "FTA",
                             outcome == "recid_arrested_flag" ~ "New Arrest",
                             outcome == "recid_filed_flag" ~ "New Filing",
                             outcome == "recid_convicted_flag" ~ "New Conviction",
                             outcome == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest",
                             outcome == "any_pretrial_failure_flag" ~ "FTA or New Arrest"))

names(tool_df) <- c("Outcome", "AUC", "CI (95%)", "N")

kable(tool_df %>% select(-starts_with("N")), booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12,
                  latex_options = "hold_position") %>%
  footnote(paste("N =", tool_df$N[1]))


```
\newpage


Sacramento
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "PSA", race == "All", sex == "All", county == "Sacramento") %>%
  select(risk_score, outcome, AUC, CI, n) %>%
  mutate(risk_score = case_when(risk_score == "psa_fta_risk_score" ~ "PSA FTA",                                 
                                risk_score == "psa_nca_risk_score" ~ "PSA NCA",                                 
                                risk_score == "psa_nvca_risk_score" ~ "PSA NVCA")) %>%
  mutate(outcome = case_when(outcome == "fta_flag" ~ "FTA",
                             outcome == "recid_arrested_flag" ~ "New Arrest",
                             outcome == "recid_filed_flag" ~ "New Filing",
                             outcome == "recid_convicted_flag" ~ "New Conviction",
                             outcome == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest",
                             outcome == "any_pretrial_failure_flag" ~ "FTA or New Arrest"))

names(tool_df) <- c("Risk Score", "Outcome", "AUC", "CI (95%)", "N")

kable(tool_df %>% select(-starts_with("N")), booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, 
                  latex_options = "hold_position") %>%
  footnote(paste("N =", tool_df$N[1]))
```
\newpage

San Joaquin  
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "VPRAI", race == "All", sex == "All", county == "San Joaquin") %>%
  select(outcome, AUC, CI, n) %>%
  mutate(outcome = case_when(outcome == "fta_flag" ~ "FTA",
                             outcome == "recid_arrested_flag" ~ "New Arrest",
                             outcome == "recid_filed_flag" ~ "New Filing",
                             outcome == "recid_convicted_flag" ~ "New Conviction",
                             outcome == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest",
                             outcome == "any_pretrial_failure_flag" ~ "FTA or New Arrest"))

names(tool_df) <- c("Outcome", "AUC", "CI (95%)", "N")

kable(tool_df %>% select(-starts_with("N")), booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, 
                  latex_options = "hold_position") %>%
  footnote(paste("N =", tool_df$N[1]))
```
\newpage

Santa Barbara - TEMPORARILY REMOVED
\newline
```{r eval=FALSE, include=FALSE}
tool_df <- auc_df %>%
  filter(tool_name == "VPRAI-R", race == "All", sex == "All", county == "Santa Barbara") %>%
  select(outcome, AUC, CI, n) %>%
 mutate(outcome = case_when(outcome == "fta_flag" ~ "FTA",                              
                            outcome == "recid_arrested_flag" ~ "New Arrest",                              
                            outcome == "recid_filed_flag" ~ "New Filing",                              
                            outcome == "recid_convicted_flag" ~ "New Conviction",                              
                            outcome == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest",                              
                            outcome == "any_pretrial_failure_flag" ~ "FTA or New Arrest"))

names(tool_df) <- c("Outcome", "AUC", "CI (95%)", "N")

kable(tool_df %>% select(-starts_with("N")), booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, 
                  latex_options = "hold_position") %>%
  footnote(paste("N =", tool_df$N[1]))

```
\newpage

Sonoma
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "PSA", race == "All", sex == "All", county == "Sonoma") %>%
  select(risk_score, outcome, AUC, CI, n) %>%
  mutate(risk_score = case_when(risk_score == "psa_fta_risk_score" ~ "PSA FTA",                                 
                                risk_score == "psa_nca_risk_score" ~ "PSA NCA",                                 
                                risk_score == "psa_nvca_risk_score" ~ "PSA NVCA")) %>%
  mutate(outcome = case_when(outcome == "fta_flag" ~ "FTA",
                             outcome == "recid_arrested_flag" ~ "New Arrest",
                             outcome == "recid_filed_flag" ~ "New Filing",
                             outcome == "recid_convicted_flag" ~ "New Conviction",
                             outcome == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest",
                             outcome == "any_pretrial_failure_flag" ~ "FTA or New Arrest"))

names(tool_df) <- c("Risk Score", "Outcome", "AUC", "CI (95%)", "N")

kable(tool_df %>% select(-starts_with("N")), booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, 
                  latex_options = "hold_position") %>%
  footnote(paste("N =", tool_df$N[1]))
```
\newpage

Ventura
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "ORAS", race == "All", sex == "All", county == "Ventura") %>%
  select(outcome, AUC, CI, n) %>%
 mutate(outcome = case_when(outcome == "fta_flag" ~ "FTA",                              
                            outcome == "recid_arrested_flag" ~ "New Arrest",                             
                            outcome == "recid_filed_flag" ~ "New Filing",                              
                            outcome == "recid_convicted_flag" ~ "New Conviction",                              
                            outcome == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest",                            
                            outcome == "any_pretrial_failure_flag" ~ "FTA or New Arrest"))

names(tool_df) <- c("Outcome", "AUC", "CI (95%)", "N")

kable(tool_df %>% select(-starts_with("N")), booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, 
                  latex_options = "hold_position") %>%
  footnote(paste("N =", tool_df$N[1]))
```
\newpage

Modoc
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "ORAS", race == "All", sex == "All", county == "Modoc") %>%
  select(outcome, AUC, CI, n) %>%
 mutate(outcome = case_when(outcome == "fta_flag" ~ "FTA",                              
                            outcome == "recid_arrested_flag" ~ "New Arrest",                             
                            outcome == "recid_filed_flag" ~ "New Filing",                              
                            outcome == "recid_convicted_flag" ~ "New Conviction",                              
                            outcome == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest",                            
                            outcome == "any_pretrial_failure_flag" ~ "FTA or New Arrest"))

names(tool_df) <- c("Outcome", "AUC", "CI (95%)", "N")

kable(tool_df %>% select(-starts_with("N")), booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, 
                  latex_options = "hold_position") %>%
  footnote(paste("N =", tool_df$N[1]))
```
\newpage

Napa
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "ORAS", race == "All", sex == "All", county == "Napa") %>%
  select(outcome, AUC, CI, n) %>%
 mutate(outcome = case_when(outcome == "fta_flag" ~ "FTA",                              
                            outcome == "recid_arrested_flag" ~ "New Arrest",                             
                            outcome == "recid_filed_flag" ~ "New Filing",                              
                            outcome == "recid_convicted_flag" ~ "New Conviction",                              
                            outcome == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest",                            
                            outcome == "any_pretrial_failure_flag" ~ "FTA or New Arrest"))

names(tool_df) <- c("Outcome", "AUC", "CI (95%)", "N")

kable(tool_df %>% select(-starts_with("N")), booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, 
                  latex_options = "hold_position") %>%
  footnote(paste("N =", tool_df$N[1]))
```
\newpage

Tulare
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "PSA", race == "All", sex == "All", county == "Tulare") %>%
  select(risk_score, outcome, AUC, CI, n) %>%
  mutate(risk_score = case_when(risk_score == "psa_fta_risk_score" ~ "PSA FTA",                                 
                                risk_score == "psa_nca_risk_score" ~ "PSA NCA",                                 
                                risk_score == "psa_nvca_risk_score" ~ "PSA NVCA")) %>%
  mutate(outcome = case_when(outcome == "fta_flag" ~ "FTA",
                             outcome == "recid_arrested_flag" ~ "New Arrest",
                             outcome == "recid_filed_flag" ~ "New Filing",
                             outcome == "recid_convicted_flag" ~ "New Conviction",
                             outcome == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest",
                             outcome == "any_pretrial_failure_flag" ~ "FTA or New Arrest"))

names(tool_df) <- c("Risk Score", "Outcome", "AUC", "CI (95%)", "N")

kable(tool_df %>% select(-starts_with("N")), booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, 
                  latex_options = "hold_position") %>%
  footnote(paste("N =", tool_df$N[1]))
```
\newpage

Calaveras
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "PSA", race == "All", sex == "All", county == "Calaveras") %>%
  select(risk_score, outcome, AUC, CI, n) %>%
  mutate(risk_score = case_when(risk_score == "psa_fta_risk_score" ~ "PSA FTA",                                 
                                risk_score == "psa_nca_risk_score" ~ "PSA NCA",                                 
                                risk_score == "psa_nvca_risk_score" ~ "PSA NVCA")) %>%
  mutate(outcome = case_when(outcome == "fta_flag" ~ "FTA",
                             outcome == "recid_arrested_flag" ~ "New Arrest",
                             outcome == "recid_filed_flag" ~ "New Filing",
                             outcome == "recid_convicted_flag" ~ "New Conviction",
                             outcome == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest",
                             outcome == "any_pretrial_failure_flag" ~ "FTA or New Arrest"))

names(tool_df) <- c("Risk Score", "Outcome", "AUC", "CI (95%)", "N")

kable(tool_df %>% select(-starts_with("N")), booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, 
                  latex_options = "hold_position") %>%
  footnote(paste("N =", tool_df$N[1]))
```
\newpage

# Race Table
```{r include=FALSE}
race_df <- eval_df %>%
  mutate(race = factor(race, levels = c("White", "Black", "Hispanic", "Other_Unknown"))) %>%
  filter(race != "Other_Unknown")
```

# Race Risk Distributions
ORAS
\newline
```{r}
risk_df <- race_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "ORAS", !is.na(oras_risk_score)) %>%
  group_by(race, oras_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing",
                                        "New Conviction", "New Violent Arrest")))
  
ggplot(risk_df %>% distinct(oras_risk_score, Total, race) %>% 
         group_by(race) %>% 
         mutate(percent = Total/sum(Total)) %>% ungroup()) +
  aes(x = as.factor(oras_risk_score), y = percent, fill = race) +
  geom_col(position = "dodge") +
  geom_text(vjust = -.2, aes(label = str_c(round(percent*100), "%")), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(x = "Risk Category", y = "Percent", title = "Distribution of Assessments by ORAS Risk Category", fill = "Race")

risk_df <- risk_df %>%
  distinct(race, oras_risk_score, Total) %>%
  pivot_wider(names_from = race, values_from = Total) %>%
  rename(`ORAS Risk Score` = oras_risk_score)

kable(risk_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 
```
\newpage

VPRAI
\newline
```{r}
risk_df <- race_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "VPRAI", !is.na(vprai_risk_score)) %>%
  group_by(race, vprai_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

ggplot(risk_df %>% distinct(vprai_risk_score, Total) %>% 
         group_by(race) %>% 
         mutate(percent = Total/sum(Total)) %>% ungroup()) +
  aes(x = as.factor(vprai_risk_score), y = percent, fill = race) +
  geom_col(position = "dodge") +
  geom_text(vjust = -0.2, aes(label = str_c(round(percent*100), "%")), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +   scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(x = "Risk Category", y = "Percent", title = "Distribution of Assessments by VPRAI Risk Category", fill = "Race")    

risk_df <- risk_df %>%
  distinct(race, vprai_risk_score, Total) %>%
  pivot_wider(names_from = race, values_from = Total) %>%
  rename(`VPRAI Risk Score` = vprai_risk_score)

kable(risk_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 
```
\newpage

VPRAI-R
\newline
```{r}
risk_df <- race_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "VPRAI-R", !is.na(vprair_risk_score)) %>%
  group_by(race, vprair_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))
  
ggplot(risk_df %>% distinct(vprair_risk_score, Total) %>% 
         group_by(race) %>% 
         mutate(percent = Total/sum(Total)) %>% ungroup()) +
  aes(x = as.factor(vprair_risk_score), y = percent, fill = race) +
  geom_col(position = "dodge") +
  theme_bw() +   scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  geom_text(vjust = -0.2, aes(label = str_c(round(percent*100), "%")), size = 2.6, position = position_dodge(width = .9)) +
  labs(x = "Risk Category", y = "Percent", title = "Distribution of Assessments by VPRAIR Risk Category", fill = "Race")  

risk_df <- risk_df %>%
  distinct(race, vprair_risk_score, Total) %>%
  pivot_wider(names_from = race, values_from = Total) %>%
  rename(`VPRAIR Risk Score` = vprair_risk_score)

kable(risk_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 
```
\newpage

PSA
\newline
```{r, fig.height = 7, fig.widith = 3}
risk_df <- race_df %>%
  filter(tool_name == "PSA") %>%
  group_by(race, psa_fta_risk_score) %>%
  summarise(across(c(fta_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag) 

names(risk_df)[2] <- "psa_risk_score"

risk_df2 <- race_df %>%
  filter(tool_name == "PSA") %>%
  group_by(race, psa_nca_risk_score) %>%
  summarise(across(c(recid_arrested_flag, recid_filed_flag, recid_convicted_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[2] <- "psa_risk_score"

risk_df3 <- race_df %>%
  filter(tool_name == "PSA", !is.na(psa_nvca_risk_score)) %>%
  group_by(race, psa_nvca_risk_score) %>%
  summarise(across(c(recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[2] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

risk_df <- risk_df %>%
  mutate(psa_risk_score = case_when(name == "New Violent Arrest" & psa_risk_score == 0 ~ "No flag",
                   name == "New Violent Arrest" & psa_risk_score == 1 ~ "Flag",
                   T ~ as.character(psa_risk_score))) %>%
  mutate(psa_risk_score = ordered(psa_risk_score, c("1", "2", "3", "4", "5", "6", "No flag", "Flag")))

ggplot(risk_df %>%
         filter(!name %in% c("New Filing", "New Conviction")) %>%
         mutate(name = case_when(name == "FTA" ~ "PSA FTA Risk Score",
                                 name == "New Arrest" ~ "PSA NCA Risk Score",
                                 name == "New Violent Arrest" ~ "PSA NVCA Risk Score")) %>% 
         group_by(race, name) %>% 
         mutate(percent = Total/sum(Total)) %>% ungroup()) +
  aes(x = as.factor(psa_risk_score), y = percent, fill = race) +
  geom_col(position = "dodge") +
  geom_text(vjust = -0.2, aes(label = str_c(round(percent*100), "%")), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +   
  #scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  facet_wrap(~name, scales = "free", ncol = 1) +
  labs(x = "Risk Category", y = "Percent", title = "Distribution of Assessments by PSA Risk Category", fill = "Race") +
  scale_y_continuous(expand = expansion(mult = c(.1, .15)), labels = scales::percent_format(accuracy = 1))

fta_df <- risk_df %>%
  filter(name == "FTA") %>%
  distinct(race, psa_risk_score, Total) %>%
  pivot_wider(names_from = race, values_from = Total) %>%
  rename(`PSA FTA Risk Score` = psa_risk_score)

kable(fta_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

nca_df <- risk_df %>%
  filter(name == "New Arrest") %>%
  distinct(race, psa_risk_score, Total) %>%
  pivot_wider(names_from = race, values_from = Total) %>%
  rename(`PSA NCA Risk Score` = psa_risk_score)

kable(nca_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

nvca_df <- risk_df %>%
  filter(name == "New Violent Arrest") %>%
  distinct(race, psa_risk_score, Total) %>%
  pivot_wider(names_from = race, values_from = Total) %>%
  rename(`PSA NVCA Risk Score` = psa_risk_score)

kable(nvca_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 


```
\newpage

Alameda
\newline
```{r}
risk_df <- race_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "VPRAI-R", !is.na(vprair_risk_score), county == "Alameda") %>%
  group_by(race, vprair_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

ggplot(risk_df %>% distinct(vprair_risk_score, Total) %>% 
         group_by(race) %>% 
         mutate(percent = Total/sum(Total))) +
  aes(x = as.factor(vprair_risk_score), y = percent, fill = race) +
  geom_col(position = "dodge") +
  geom_text(vjust = -0.2, aes(label = str_c(round(percent*100), "%")), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +   scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(x = "Risk Category", y = "Percent", title = "Alameda Distribution of Assessments by VPRAIR Risk Category", fill = "Race")  

risk_df <- risk_df %>%
  distinct(race, vprair_risk_score, Total) %>%
  pivot_wider(names_from = race, values_from = Total) %>%
  rename(`VPRAIR Risk Score` = vprair_risk_score)

kable(risk_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 
```
\newpage

Los Angeles
\newline
```{r, fig.height = 7, fig.widith = 3}
risk_df <- race_df %>%
  filter(tool_name == "PSA", county == "Los Angeles", !is.na(psa_fta_risk_score)) %>%
  group_by(race, psa_fta_risk_score) %>%
  summarise(across(c(fta_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag) 

names(risk_df)[2] <- "psa_risk_score"

risk_df2 <- race_df %>%
  filter(tool_name == "PSA", county == "Los Angeles", !is.na(psa_nca_risk_score)) %>%
  group_by(race, psa_nca_risk_score) %>%
  summarise(across(c(recid_arrested_flag, recid_filed_flag, recid_convicted_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[2] <- "psa_risk_score"

risk_df3 <- race_df %>%
  filter(tool_name == "PSA", !is.na(psa_nvca_risk_score), county == "Los Angeles") %>%
  group_by(race, psa_nvca_risk_score) %>%
  summarise(across(c(recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[2] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

risk_df <- risk_df %>%
  mutate(psa_risk_score = case_when(name == "New Violent Arrest" & psa_risk_score == 0 ~ "No flag",
                   name == "New Violent Arrest" & psa_risk_score == 1 ~ "Flag",
                   T ~ as.character(psa_risk_score))) %>%
  mutate(psa_risk_score = ordered(psa_risk_score, c("1", "2", "3", "4", "5", "6", "No flag", "Flag")))

ggplot(risk_df %>%
         filter(!name %in% c("New Filing", "New Conviction")) %>%
         mutate(name = case_when(name == "FTA" ~ "PSA FTA Risk Score",
                                 name == "New Arrest" ~ "PSA NCA Risk Score",
                                 name == "New Violent Arrest" ~ "PSA NVCA Risk Score"))%>% 
         group_by(race, name) %>% 
         mutate(percent = Total/sum(Total)) %>% ungroup()) +
  aes(x = as.factor(psa_risk_score), y = percent, fill = race) +
  geom_col(position = "dodge") +
  geom_text(vjust = -0.2, aes(label = str_c(round(percent*100), "%")), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +   
  # ylim(0,100) +
  facet_wrap(~name, scales = "free", ncol = 1) +
  labs(x = "Risk Category", y = "Percent", title = "Los Angeles Distribution of Assessments by PSA Risk Category", fill = "Race") +
  scale_y_continuous(expand = expansion(mult = c(.1, .15)), labels = scales::percent_format(accuracy = 1))

fta_df <- risk_df %>%
  filter(name == "FTA") %>%
  distinct(race, psa_risk_score, Total) %>%
  pivot_wider(names_from = race, values_from = Total) %>%
  rename(`PSA FTA Risk Score` = psa_risk_score)

kable(fta_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

nca_df <- risk_df %>%
  filter(name == "New Arrest") %>%
  distinct(race, psa_risk_score, Total) %>%
  pivot_wider(names_from = race, values_from = Total) %>%
  rename(`PSA NCA Risk Score` = psa_risk_score)

kable(nca_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

nvca_df <- risk_df %>%
  filter(name == "New Violent Arrest") %>%
  distinct(race, psa_risk_score, Total) %>%
  pivot_wider(names_from = race, values_from = Total) %>%
  rename(`PSA NVCA Risk Score` = psa_risk_score)

kable(nvca_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 
```
\newpage

San Mateo
\newline
```{r}
risk_df <- race_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "VPRAI-R", !is.na(vprair_risk_score), county == "San Mateo") %>%
  group_by(race, vprair_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

ggplot(risk_df %>% distinct(vprair_risk_score, Total) %>% 
         group_by(race) %>% 
         mutate(percent = Total/sum(Total))) +
  aes(x = as.factor(vprair_risk_score), y = percent, fill = race) +
  geom_col(position = "dodge") +
  geom_text(vjust = -0.2, aes(label = str_c(round(percent*100), "%")), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +   scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(x = "Risk Category", y = "Percent", title = "San Mateo Distribution of Assessments by VPRAIR Risk Category", fill = "Race")  

risk_df <- risk_df %>%
  distinct(race, vprair_risk_score, Total) %>%
  pivot_wider(names_from = race, values_from = Total) %>%
  rename(`VPRAIR Risk Score` = vprair_risk_score)

kable(risk_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 
```
\newpage


Sacramento
\newline
```{r, fig.height = 7, fig.widith = 3}
risk_df <- race_df %>%
  filter(tool_name == "PSA", county == "Sacramento") %>%
  group_by(race, psa_fta_risk_score) %>%
  summarise(across(c(fta_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag) 

names(risk_df)[2] <- "psa_risk_score"

risk_df2 <- race_df %>%
  filter(tool_name == "PSA", county == "Sacramento") %>%
  group_by(race, psa_nca_risk_score) %>%
  summarise(across(c(recid_arrested_flag, recid_filed_flag, recid_convicted_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[2] <- "psa_risk_score"

risk_df3 <- race_df %>%
  filter(tool_name == "PSA", !is.na(psa_nvca_risk_score), county == "Sacramento") %>%
  group_by(race, psa_nvca_risk_score) %>%
  summarise(across(c(recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[2] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

risk_df <- risk_df %>%
  mutate(psa_risk_score = case_when(name == "New Violent Arrest" & psa_risk_score == 0 ~ "No flag",
                   name == "New Violent Arrest" & psa_risk_score == 1 ~ "Flag",
                   T ~ as.character(psa_risk_score))) %>%
  mutate(psa_risk_score = ordered(psa_risk_score, c("1", "2", "3", "4", "5", "6", "No flag", "Flag")))

ggplot(risk_df %>%
         filter(!name %in% c("New Filing", "New Conviction")) %>%
         mutate(name = case_when(name == "FTA" ~ "PSA FTA Risk Score",
                                 name == "New Arrest" ~ "PSA NCA Risk Score",
                                 name == "New Violent Arrest" ~ "PSA NVCA Risk Score")) %>% 
         group_by(race, name) %>% 
         mutate(percent = Total/sum(Total)) %>% ungroup()) +
  aes(x = as.factor(psa_risk_score), y = percent, fill = race) +
  geom_col(position = "dodge") +
  geom_text(vjust = -0.2, aes(label = str_c(round(percent*100), "%")), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +   
  facet_wrap(~name, scales = "free", ncol = 1) +
  labs(x = "Risk Category", y = "Percent", title = "Sacramento Distribution of Assessments by PSA Risk Category", fill = "Race") +
  scale_y_continuous(expand = expansion(mult = c(.1, .15)), labels = scales::percent_format(accuracy = 1)) 

fta_df <- risk_df %>%
  filter(name == "FTA") %>%
  distinct(race, psa_risk_score, Total) %>%
  pivot_wider(names_from = race, values_from = Total) %>%
  rename(`PSA FTA Risk Score` = psa_risk_score)

kable(fta_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

nca_df <- risk_df %>%
  filter(name == "New Arrest") %>%
  distinct(race, psa_risk_score, Total) %>%
  pivot_wider(names_from = race, values_from = Total) %>%
  rename(`PSA NCA Risk Score` = psa_risk_score)

kable(nca_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

nvca_df <- risk_df %>%
  filter(name == "New Violent Arrest") %>%
  distinct(race, psa_risk_score, Total) %>%
  pivot_wider(names_from = race, values_from = Total) %>%
  rename(`PSA NVCA Risk Score` = psa_risk_score)

kable(nvca_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 
```
\newpage

San Joaquin 
\newline
```{r}
risk_df <- race_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "VPRAI", !is.na(vprai_risk_score), county == "San Joaquin") %>%
  group_by(race, vprai_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

ggplot(risk_df %>% distinct(vprai_risk_score, Total) %>% 
         group_by(race) %>% 
         mutate(percent = Total/sum(Total)) %>% ungroup()) +
  aes(x = as.factor(vprai_risk_score), y = percent, fill = race) +
  geom_col(position = "dodge") +
  geom_text(vjust = -0.2, aes(label = str_c(round(percent*100), "%")), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +   scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(x = "Risk Category", y = "Percent", title = "San Joaquin Distribution of Assessments by VPRAI Risk Category", fill = "Race")   

risk_df <- risk_df %>%
  distinct(race, vprai_risk_score, Total) %>%
  pivot_wider(names_from = race, values_from = Total) %>%
  rename(`VPRAI Risk Score` = vprai_risk_score)

kable(risk_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 
```
\newpage

Santa Barbara - TEMPORARILY REMOVED
\newline
```{r eval=FALSE, include=FALSE}
risk_df <- race_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "VPRAI-R", !is.na(vprair_risk_score), county == "Santa Barbara") %>%
  group_by(race, vprair_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

ggplot(risk_df %>% distinct(vprair_risk_score, Total) %>% 
         group_by(race) %>% 
         mutate(percent = Total/sum(Total)) %>% ungroup()) +
  aes(x = as.factor(vprair_risk_score), y = percent, fill = race) +
  geom_col(position = "dodge") +
  geom_text(vjust = -0.2, aes(label = str_c(round(percent*100), "%")), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +   scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(x = "Risk Category", y = "Percent", title = "Santa Barbara Distribution of Assessments by VPRAIR Risk Category", fill = "Race")  

risk_df <- risk_df %>%
  distinct(race, vprair_risk_score, Total) %>%
  pivot_wider(names_from = race, values_from = Total) %>%
  rename(`VPRAIR Risk Score` = vprair_risk_score)

kable(risk_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 
```
\newpage

Sonoma
\newline
```{r, fig.height = 7, fig.widith = 3}
risk_df <- race_df %>%
  filter(tool_name == "PSA", county == "Sonoma") %>%
  group_by(race, psa_fta_risk_score) %>%
  summarise(across(c(fta_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag) 

names(risk_df)[2] <- "psa_risk_score"

risk_df2 <- race_df %>%
  filter(tool_name == "PSA", county == "Sonoma") %>%
  group_by(race, psa_nca_risk_score) %>%
  summarise(across(c(recid_arrested_flag, recid_filed_flag, recid_convicted_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[2] <- "psa_risk_score"

risk_df3 <- race_df %>%
  filter(tool_name == "PSA", !is.na(psa_nvca_risk_score), county == "Sonoma") %>%
  group_by(race, psa_nvca_risk_score) %>%
  summarise(across(c(recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[2] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

risk_df <- risk_df %>%
  mutate(psa_risk_score = case_when(name == "New Violent Arrest" & psa_risk_score == 0 ~ "No flag",
                   name == "New Violent Arrest" & psa_risk_score == 1 ~ "Flag",
                   T ~ as.character(psa_risk_score))) %>%
  mutate(psa_risk_score = ordered(psa_risk_score, c("1", "2", "3", "4", "5", "6", "No flag", "Flag")))

ggplot(risk_df %>%
         filter(!name %in% c("New Filing", "New Conviction")) %>%
         mutate(name = case_when(name == "FTA" ~ "PSA FTA Risk Score",
                                 name == "New Arrest" ~ "PSA NCA Risk Score",
                                 name == "New Violent Arrest" ~ "PSA NVCA Risk Score")) %>% 
         group_by(race, name) %>% 
         mutate(percent = Total/sum(Total)) %>% ungroup()) +
  aes(x = as.factor(psa_risk_score), y = percent, fill = race) +
  geom_col(position = "dodge") +
  geom_text(vjust = -0.2, aes(label = str_c(round(percent*100), "%")), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +  
  # ylim(0,100) +
  facet_wrap(~name, scales = "free", ncol = 1) +
  labs(x = "Risk Category", y = "Percent", title = "Sonoma Distribution of Assessments by PSA Risk Category", fill = "Race") +
  scale_y_continuous(expand = expansion(mult = c(.1, .15)), labels = scales::percent_format(accuracy = 1))

fta_df <- risk_df %>%
  filter(name == "FTA") %>%
  distinct(race, psa_risk_score, Total) %>%
  pivot_wider(names_from = race, values_from = Total) %>%
  rename(`PSA FTA Risk Score` = psa_risk_score)

kable(fta_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

nca_df <- risk_df %>%
  filter(name == "New Arrest") %>%
  distinct(race, psa_risk_score, Total) %>%
  pivot_wider(names_from = race, values_from = Total) %>%
  rename(`PSA NCA Risk Score` = psa_risk_score)

kable(nca_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

nvca_df <- risk_df %>%
  filter(name == "New Violent Arrest") %>%
  distinct(race, psa_risk_score, Total) %>%
  pivot_wider(names_from = race, values_from = Total) %>%
  rename(`PSA NVCA Risk Score` = psa_risk_score)

kable(nvca_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 
```
\newpage

Sonoma - White and Hispanic only
\newline
```{r, fig.height = 7, fig.widith = 3}
risk_df <- race_df %>%
  filter(tool_name == "PSA", county == "Sonoma") %>%
  group_by(race, psa_fta_risk_score) %>%
  summarise(across(c(fta_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag) 

names(risk_df)[2] <- "psa_risk_score"

risk_df2 <- race_df %>%
  filter(tool_name == "PSA", county == "Sonoma") %>%
  group_by(race, psa_nca_risk_score) %>%
  summarise(across(c(recid_arrested_flag, recid_filed_flag, recid_convicted_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[2] <- "psa_risk_score"

risk_df3 <- race_df %>%
  filter(tool_name == "PSA", !is.na(psa_nvca_risk_score), county == "Sonoma") %>%
  group_by(race, psa_nvca_risk_score) %>%
  summarise(across(c(recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[2] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

risk_df <- risk_df %>%
  filter(race %in% c("White", "Hispanic")) %>%
  mutate(psa_risk_score = case_when(name == "New Violent Arrest" & psa_risk_score == 0 ~ "No flag",
                   name == "New Violent Arrest" & psa_risk_score == 1 ~ "Flag",
                   T ~ as.character(psa_risk_score))) %>%
  mutate(psa_risk_score = ordered(psa_risk_score, c("1", "2", "3", "4", "5", "6", "No flag", "Flag")))

ggplot(risk_df %>%
         filter(!name %in% c("New Filing", "New Conviction")) %>%
         mutate(name = case_when(name == "FTA" ~ "PSA FTA Risk Score",
                                 name == "New Arrest" ~ "PSA NCA Risk Score",
                                 name == "New Violent Arrest" ~ "PSA NVCA Risk Score")) %>% 
         group_by(race, name) %>% 
         mutate(percent = Total/sum(Total)) %>% ungroup()) +
  aes(x = as.factor(psa_risk_score), y = percent, fill = race) +
  geom_col(position = "dodge") +
  geom_text(vjust = -0.2, aes(label = str_c(round(percent*100), "%")), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +  
  # ylim(0,100) +
  facet_wrap(~name, scales = "free", ncol = 1) +
  labs(x = "Risk Category", y = "Percent", title = "Sonoma Distribution of Assessments by PSA Risk Category", fill = "Race") +
  scale_y_continuous(expand = expansion(mult = c(.1, .15)), labels = scales::percent_format(accuracy = 1))

fta_df <- risk_df %>%
  filter(name == "FTA") %>%
  distinct(race, psa_risk_score, Total) %>%
  pivot_wider(names_from = race, values_from = Total) %>%
  rename(`PSA FTA Risk Score` = psa_risk_score)

kable(fta_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

nca_df <- risk_df %>%
  filter(name == "New Arrest") %>%
  distinct(race, psa_risk_score, Total) %>%
  pivot_wider(names_from = race, values_from = Total) %>%
  rename(`PSA NCA Risk Score` = psa_risk_score)

kable(nca_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

nvca_df <- risk_df %>%
  filter(name == "New Violent Arrest") %>%
  distinct(race, psa_risk_score, Total) %>%
  pivot_wider(names_from = race, values_from = Total) %>%
  rename(`PSA NVCA Risk Score` = psa_risk_score)

kable(nvca_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 
```
\newpage

Ventura
\newline
```{r}
risk_df <- race_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "ORAS", !is.na(oras_risk_score), county == "Ventura") %>%
  group_by(race, oras_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing",
                                        "New Conviction", "New Violent Arrest")))
  
ggplot(risk_df %>% distinct(oras_risk_score, Total) %>% 
         group_by(race) %>% 
         mutate(percent = Total/sum(Total)) %>% ungroup()) +
  aes(x = as.factor(oras_risk_score), y = percent, fill = race) +
  geom_col(position = "dodge") +
  geom_text(vjust = -0.2, aes(label = str_c(round(percent*100), "%")), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +   scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(x = "Risk Category", y = "Percent", title = "Ventura Distribution of Assessments by ORAS Risk Category", fill = "Race") 

risk_df <- risk_df %>%
  distinct(race, oras_risk_score, Total) %>%
  pivot_wider(names_from = race, values_from = Total) %>%
  rename(`ORAS Risk Score` = oras_risk_score)

kable(risk_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 
```
\newpage

Modoc
\newline
```{r}
risk_df <- race_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "ORAS", !is.na(oras_risk_score), county == "Modoc") %>%
  group_by(race, oras_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing",
                                        "New Conviction", "New Violent Arrest")))
  
ggplot(risk_df %>% distinct(oras_risk_score, Total) %>% 
         group_by(race) %>% 
         mutate(percent = Total/sum(Total)) %>% ungroup()) +
  aes(x = as.factor(oras_risk_score), y = percent, fill = race) +
  geom_col(position = "dodge") +
  geom_text(vjust = -0.2, aes(label = str_c(round(percent*100), "%")), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +   scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(x = "Risk Category", y = "Percent", title = "Modoc Distribution of Assessments by ORAS Risk Category", fill = "Race") 

risk_df <- risk_df %>%
  distinct(race, oras_risk_score, Total) %>%
  pivot_wider(names_from = race, values_from = Total) %>%
  rename(`ORAS Risk Score` = oras_risk_score)

kable(risk_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 
```
\newpage

Napa
\newline
```{r}
risk_df <- race_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "ORAS", !is.na(oras_risk_score), county == "Napa") %>%
  group_by(race, oras_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing",
                                        "New Conviction", "New Violent Arrest")))
  
ggplot(risk_df %>% distinct(oras_risk_score, Total) %>% 
         group_by(race) %>% 
         mutate(percent = Total/sum(Total)) %>% ungroup()) +
  aes(x = as.factor(oras_risk_score), y = percent, fill = race) +
  geom_col(position = "dodge") +
  geom_text(vjust = -0.2, aes(label = str_c(round(percent*100), "%")), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +   scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(x = "Risk Category", y = "Percent", title = "Napa Distribution of Assessments by ORAS Risk Category", fill = "Race") 

risk_df <- risk_df %>%
  distinct(race, oras_risk_score, Total) %>%
  pivot_wider(names_from = race, values_from = Total) %>%
  rename(`ORAS Risk Score` = oras_risk_score)

kable(risk_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 
```
\newpage

Tulare
\newline
```{r, fig.height = 7, fig.widith = 3}
risk_df <- race_df %>%
  filter(tool_name == "PSA", county == "Tulare") %>%
  group_by(race, psa_fta_risk_score) %>%
  summarise(across(c(fta_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag) 

names(risk_df)[2] <- "psa_risk_score"

risk_df2 <- race_df %>%
  filter(tool_name == "PSA", county == "Tulare") %>%
  group_by(race, psa_nca_risk_score) %>%
  summarise(across(c(recid_arrested_flag, recid_filed_flag, recid_convicted_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[2] <- "psa_risk_score"

risk_df3 <- race_df %>%
  filter(tool_name == "PSA", !is.na(psa_nvca_risk_score), county == "Tulare") %>%
  group_by(race, psa_nvca_risk_score) %>%
  summarise(across(c(recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[2] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

risk_df <- risk_df %>%
  mutate(psa_risk_score = case_when(name == "New Violent Arrest" & psa_risk_score == 0 ~ "No flag",
                   name == "New Violent Arrest" & psa_risk_score == 1 ~ "Flag",
                   T ~ as.character(psa_risk_score))) %>%
  mutate(psa_risk_score = ordered(psa_risk_score, c("1", "2", "3", "4", "5", "6", "No flag", "Flag")))

ggplot(risk_df %>%
         filter(!name %in% c("New Filing", "New Conviction")) %>%
         mutate(name = case_when(name == "FTA" ~ "PSA FTA Risk Score",
                                 name == "New Arrest" ~ "PSA NCA Risk Score",
                                 name == "New Violent Arrest" ~ "PSA NVCA Risk Score")) %>% 
         group_by(race, name) %>% 
         mutate(percent = Total/sum(Total)) %>% ungroup()) +
  aes(x = as.factor(psa_risk_score), y = percent, fill = race) +
  geom_col(position = "dodge") +
  geom_text(vjust = -0.2, aes(label = str_c(round(percent*100), "%")), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +  
  # ylim(0,100) +
  facet_wrap(~name, scales = "free", ncol = 1) +
  labs(x = "Risk Category", y = "Percent", title = "Tulare Distribution of Assessments by PSA Risk Category", fill = "Race") +
  scale_y_continuous(expand = expansion(mult = c(.1, .15)), labels = scales::percent_format(accuracy = 1))

fta_df <- risk_df %>%
  filter(name == "FTA") %>%
  distinct(race, psa_risk_score, Total) %>%
  pivot_wider(names_from = race, values_from = Total) %>%
  rename(`PSA FTA Risk Score` = psa_risk_score)

kable(fta_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

nca_df <- risk_df %>%
  filter(name == "New Arrest") %>%
  distinct(race, psa_risk_score, Total) %>%
  pivot_wider(names_from = race, values_from = Total) %>%
  rename(`PSA NCA Risk Score` = psa_risk_score)

kable(nca_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

nvca_df <- risk_df %>%
  filter(name == "New Violent Arrest") %>%
  distinct(race, psa_risk_score, Total) %>%
  pivot_wider(names_from = race, values_from = Total) %>%
  rename(`PSA NVCA Risk Score` = psa_risk_score)

kable(nvca_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 
```
\newpage

Calaveras
\newline
```{r, fig.height = 7, fig.widith = 3}
risk_df <- race_df %>%
  filter(tool_name == "PSA", county == "Calaveras") %>%
  group_by(race, psa_fta_risk_score) %>%
  summarise(across(c(fta_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag) 

names(risk_df)[2] <- "psa_risk_score"

risk_df2 <- race_df %>%
  filter(tool_name == "PSA", county == "Calaveras") %>%
  group_by(race, psa_nca_risk_score) %>%
  summarise(across(c(recid_arrested_flag, recid_filed_flag, recid_convicted_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[2] <- "psa_risk_score"

risk_df3 <- race_df %>%
  filter(tool_name == "PSA", !is.na(psa_nvca_risk_score), county == "Calaveras") %>%
  group_by(race, psa_nvca_risk_score) %>%
  summarise(across(c(recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[2] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

risk_df <- risk_df %>%
  mutate(psa_risk_score = case_when(name == "New Violent Arrest" & psa_risk_score == 0 ~ "No flag",
                   name == "New Violent Arrest" & psa_risk_score == 1 ~ "Flag",
                   T ~ as.character(psa_risk_score))) %>%
  mutate(psa_risk_score = ordered(psa_risk_score, c("1", "2", "3", "4", "5", "6", "No flag", "Flag")))

ggplot(risk_df %>%
         filter(!name %in% c("New Filing", "New Conviction")) %>%
         mutate(name = case_when(name == "FTA" ~ "PSA FTA Risk Score",
                                 name == "New Arrest" ~ "PSA NCA Risk Score",
                                 name == "New Violent Arrest" ~ "PSA NVCA Risk Score")) %>% 
         group_by(race, name) %>% 
         mutate(percent = Total/sum(Total)) %>% ungroup()) +
  aes(x = as.factor(psa_risk_score), y = percent, fill = race) +
  geom_col(position = "dodge") +
  geom_text(vjust = -0.2, aes(label = str_c(round(percent*100), "%")), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +  
  # ylim(0,100) +
  facet_wrap(~name, scales = "free", ncol = 1) +
  labs(x = "Risk Category", y = "Percent", title = "Calaveras Distribution of Assessments by PSA Risk Category", fill = "Race") +
  scale_y_continuous(expand = expansion(mult = c(.1, .15)), labels = scales::percent_format(accuracy = 1))

fta_df <- risk_df %>%
  filter(name == "FTA") %>%
  distinct(race, psa_risk_score, Total) %>%
  pivot_wider(names_from = race, values_from = Total) %>%
  rename(`PSA FTA Risk Score` = psa_risk_score)

kable(fta_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

nca_df <- risk_df %>%
  filter(name == "New Arrest") %>%
  distinct(race, psa_risk_score, Total) %>%
  pivot_wider(names_from = race, values_from = Total) %>%
  rename(`PSA NCA Risk Score` = psa_risk_score)

kable(nca_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

nvca_df <- risk_df %>%
  filter(name == "New Violent Arrest") %>%
  distinct(race, psa_risk_score, Total) %>%
  pivot_wider(names_from = race, values_from = Total) %>%
  rename(`PSA NVCA Risk Score` = psa_risk_score)

kable(nvca_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 
```
\newpage

# Race Logistic Regression Graphs


VPRAI
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  mutate(race = factor(race, levels = c("White", "Black", "Hispanic", "Other_Unknown"))) %>%
  filter(tool_name == "VPRAI", !is.na(vprai_risk_score)) %>%
  group_by(vprai_risk_score, race) %>%
  select(vprai_risk_score, race, fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag,
         any_pretrial_failure_flag, recid_arrest_violent_psa_flag) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) %>%
  filter(race %in% c("White", "Black", "Hispanic")) 
  # filter(county %in% c("Los Angeles", "Sacramento"))

ggplot(risk_df) +
  aes(x = vprai_risk_score, y = value, color = race) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent", title = "Comparison of Racial Differences in Logistic Regression Curves--VPRAI") +
  scale_x_continuous(breaks = 1:5)
```
\newpage

VPRAI-R
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  mutate(race = factor(race, levels = c("White", "Black", "Hispanic", "Other_Unknown"))) %>%
  filter(tool_name == "VPRAI-R", !is.na(vprair_risk_score)) %>%
  group_by(vprair_risk_score, race) %>%
  select(vprair_risk_score, race, fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag,
         any_pretrial_failure_flag, recid_arrest_violent_psa_flag) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) %>%
  filter(race %in% c("White", "Black", "Hispanic")) 
  # filter(county %in% c("Los Angeles", "Sacramento"))

ggplot(risk_df) +
  aes(x = vprair_risk_score, y = value, color = race) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent", title = "Comparison of Racial Differences in Logistic Regression Curves--VPRAI-R") +
  scale_x_continuous(breaks = 1:5)
```
\newpage

ORAS
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  mutate(race = factor(race, levels = c("White", "Black", "Hispanic", "Other_Unknown"))) %>%
  filter(tool_name == "ORAS", !is.na(oras_risk_score)) %>%
  group_by(oras_risk_score, race) %>%
  select(oras_risk_score, race, fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag,
         any_pretrial_failure_flag, recid_arrest_violent_psa_flag) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) %>%
  filter(race %in% c("White", "Black", "Hispanic")) 
  # filter(county %in% c("Los Angeles", "Sacramento"))

ggplot(risk_df) +
  aes(x = oras_risk_score, y = value, color = race) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent", title = "Comparison of Racial Differences in Logistic Regression Curves--ORAS") +
  scale_x_continuous(breaks = 0:9)


```
\newpage


PSA
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  filter(tool_name == "PSA") %>%
  group_by(psa_fta_risk_score, race, county) %>%
  select(fta_flag) %>%
  pivot_longer(fta_flag) 

names(risk_df)[1] <- "psa_risk_score"

risk_df2 <- eval_df %>%
  filter(tool_name == "PSA") %>%
  group_by(psa_nca_risk_score, race, county) %>%
  select(recid_arrested_flag, recid_filed_flag, recid_convicted_flag) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[1] <- "psa_risk_score"

risk_df3 <- eval_df %>%
  filter(tool_name == "PSA", !is.na(psa_nvca_risk_score)) %>%
  group_by(psa_nvca_risk_score, race, county) %>%
  select(recid_arrest_violent_psa_flag) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[1] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(race = factor(race, levels = c("White", "Black", "Hispanic", "Other_Unknown"))) %>%
  filter(race %in% c("White", "Black", "Hispanic")) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) %>%
  filter(county %in% c("Los Angeles", "Sacramento"))

ggplot(risk_df) +
  aes(x = psa_risk_score, y = value, color = race) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  # facet_grid(county~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent", title = "Comparison of Racial Differences in Logistic Regression Curves--PSA") +
  scale_x_continuous(breaks = 1:6)

# eval_df %>%
#   filter(tool_name == "PSA") %>%
#   count(county)
```
\newpage

San Joaquin 
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  filter(county == "San Joaquin") %>%
  mutate(race = factor(race, levels = c("White", "Black", "Hispanic", "Other_Unknown"))) %>%
  filter(tool_name == "VPRAI", !is.na(vprai_risk_score)) %>%
  group_by(vprai_risk_score, race) %>%
  select(vprai_risk_score, race, fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag,
         any_pretrial_failure_flag, recid_arrest_violent_psa_flag) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) %>%
  filter(race %in% c("White", "Black", "Hispanic")) 

ggplot(risk_df) +
  aes(x = vprai_risk_score, y = value, color = race) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent",
       title = "Comparison of Racial Differences in Logistic Regression Curves--VPRAI, San Joaquin") +
  scale_x_continuous(breaks = 1:5)

# eval_df %>%
#   filter(tool_name == "VPRAI") %>%
#   count(county)
```
\newpage

Los Angeles
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  filter(county == "Los Angeles") %>%
  filter(tool_name == "PSA", !is.na(psa_fta_risk_score)) %>%
  group_by(psa_fta_risk_score, race, county) %>%
  select(fta_flag) %>%
  pivot_longer(fta_flag) 

names(risk_df)[1] <- "psa_risk_score"

risk_df2 <- eval_df %>%
  filter(county == "Los Angeles") %>%
  filter(tool_name == "PSA", !is.na(psa_nca_risk_score)) %>%
  group_by(psa_nca_risk_score, race, county) %>%
  select(recid_arrested_flag, recid_filed_flag, recid_convicted_flag) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[1] <- "psa_risk_score"

risk_df3 <- eval_df %>%
  filter(county == "Los Angeles") %>%
  filter(tool_name == "PSA", !is.na(psa_nvca_risk_score)) %>%
  group_by(psa_nvca_risk_score, race, county) %>%
  select(recid_arrest_violent_psa_flag) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[1] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(race = factor(race, levels = c("White", "Black", "Hispanic", "Other_Unknown"))) %>%
  filter(race %in% c("White", "Black", "Hispanic")) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) %>%
  filter(county %in% c("Los Angeles", "Sacramento"))

ggplot(risk_df) +
  aes(x = psa_risk_score, y = value, color = race) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent",
       title = "Comparison of Racial Differences in Logistic Regression Curves--PSA, Los Angeles") +
  scale_x_continuous(breaks = 1:6)

# eval_df %>%
#   filter(tool_name == "PSA") %>%
#   count(county)
```
\newpage

Sacramento
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  filter(county == "Sacramento") %>%
  filter(tool_name == "PSA") %>%
  group_by(psa_fta_risk_score, race, county) %>%
  select(fta_flag) %>%
  pivot_longer(fta_flag) 

names(risk_df)[1] <- "psa_risk_score"

risk_df2 <- eval_df %>%
  filter(county == "Sacramento") %>%
  filter(tool_name == "PSA") %>%
  group_by(psa_nca_risk_score, race, county) %>%
  select(recid_arrested_flag, recid_filed_flag, recid_convicted_flag) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[1] <- "psa_risk_score"

risk_df3 <- eval_df %>%
  filter(county == "Sacramento") %>%
  filter(tool_name == "PSA", !is.na(psa_nvca_risk_score)) %>%
  group_by(psa_nvca_risk_score, race, county) %>%
  select(recid_arrest_violent_psa_flag) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[1] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(race = factor(race, levels = c("White", "Black", "Hispanic", "Other_Unknown"))) %>%
  filter(race %in% c("White", "Black", "Hispanic")) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) %>%
  filter(county %in% c("Los Angeles", "Sacramento"))

ggplot(risk_df) +
  aes(x = psa_risk_score, y = value, color = race) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent", title = "Comparison of Racial Differences in Logistic Regression Curves--PSA, Sacramento") +
  scale_x_continuous(breaks = 1:6)

# eval_df %>%
#   filter(tool_name == "PSA") %>%
#   count(county)


```
\newpage

Ventura
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  mutate(race = factor(race, levels = c("White", "Black", "Hispanic", "Other_Unknown"))) %>%
  filter(tool_name == "ORAS", !is.na(oras_risk_score), county == "Ventura") %>%
  group_by(oras_risk_score, race) %>%
  select(oras_risk_score, race, fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag,
         any_pretrial_failure_flag, recid_arrest_violent_psa_flag) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) %>%
  filter(race %in% c("White", "Black", "Hispanic")) 
  # filter(county %in% c("Los Angeles", "Sacramento"))

ggplot(risk_df) +
  aes(x = oras_risk_score, y = value, color = race) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent", title = "Comparison of Racial Differences in Logistic Regression Curves--ORAS, Ventura") +
  scale_x_continuous(breaks = 0:9)


```
\newpage

Ventura -- White and Hispanic only
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  mutate(race = factor(race, levels = c("White", "Black", "Hispanic", "Other_Unknown"))) %>%
  filter(tool_name == "ORAS", !is.na(oras_risk_score), county == "Ventura") %>%
  group_by(oras_risk_score, race) %>%
  select(oras_risk_score, race, fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag,
         any_pretrial_failure_flag, recid_arrest_violent_psa_flag) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) %>%
  filter(race %in% c("White", "Hispanic")) 
  # filter(county %in% c("Los Angeles", "Sacramento"))

ggplot(risk_df) +
  aes(x = oras_risk_score, y = value, color = race) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent", title = "Comparison of Racial Differences in Logistic Regression Curves--ORAS, Ventura") +
  scale_x_continuous(breaks = 0:9)


```
\newpage

Sonoma
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  filter(county == "Sonoma") %>%
  filter(tool_name == "PSA") %>%
  group_by(psa_fta_risk_score, race, county) %>%
  select(fta_flag) %>%
  pivot_longer(fta_flag) 

names(risk_df)[1] <- "psa_risk_score"

risk_df2 <- eval_df %>%
  filter(county == "Sonoma") %>%
  filter(tool_name == "PSA") %>%
  group_by(psa_nca_risk_score, race, county) %>%
  select(recid_arrested_flag, recid_filed_flag, recid_convicted_flag) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[1] <- "psa_risk_score"

risk_df3 <- eval_df %>%
  filter(county == "Sonoma") %>%
  filter(tool_name == "PSA", !is.na(psa_nvca_risk_score)) %>%
  group_by(psa_nvca_risk_score, race, county) %>%
  select(recid_arrest_violent_psa_flag) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[1] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(race = factor(race, levels = c("White", "Black", "Hispanic", "Other_Unknown"))) %>%
  filter(race %in% c("White", "Black", "Hispanic")) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) 

ggplot(risk_df) +
  aes(x = psa_risk_score, y = value, color = race) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent", title = "Comparison of Racial Differences in Logistic Regression Curves--PSA, Sonoma") +
  scale_x_continuous(breaks = 1:6)

# eval_df %>%
#   filter(tool_name == "PSA") %>%
#   count(county)


```
\newpage

Sonoma - White and Hispanic only
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  filter(county == "Sonoma") %>%
  filter(tool_name == "PSA") %>%
  group_by(psa_fta_risk_score, race, county) %>%
  select(fta_flag) %>%
  pivot_longer(fta_flag) 

names(risk_df)[1] <- "psa_risk_score"

risk_df2 <- eval_df %>%
  filter(county == "Sonoma") %>%
  filter(tool_name == "PSA") %>%
  group_by(psa_nca_risk_score, race, county) %>%
  select(recid_arrested_flag, recid_filed_flag, recid_convicted_flag) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[1] <- "psa_risk_score"

risk_df3 <- eval_df %>%
  filter(county == "Sonoma") %>%
  filter(tool_name == "PSA", !is.na(psa_nvca_risk_score)) %>%
  group_by(psa_nvca_risk_score, race, county) %>%
  select(recid_arrest_violent_psa_flag) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[1] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(race = factor(race, levels = c("White", "Black", "Hispanic", "Other_Unknown"))) %>%
  filter(race %in% c("White", "Hispanic")) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) 

ggplot(risk_df) +
  aes(x = psa_risk_score, y = value, color = race) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent", title = "Comparison of Racial Differences in Logistic Regression Curves--PSA, Sonoma") +
  scale_x_continuous(breaks = 1:6)

# eval_df %>%
#   filter(tool_name == "PSA") %>%
#   count(county)


```
\newpage

Tulare
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  filter(county == "Tulare") %>%
  filter(tool_name == "PSA") %>%
  group_by(psa_fta_risk_score, race, county) %>%
  select(fta_flag) %>%
  pivot_longer(fta_flag) 

names(risk_df)[1] <- "psa_risk_score"

risk_df2 <- eval_df %>%
  filter(county == "Tulare") %>%
  filter(tool_name == "PSA") %>%
  group_by(psa_nca_risk_score, race, county) %>%
  select(recid_arrested_flag, recid_filed_flag, recid_convicted_flag) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[1] <- "psa_risk_score"

risk_df3 <- eval_df %>%
  filter(county == "Tulare") %>%
  filter(tool_name == "PSA", !is.na(psa_nvca_risk_score)) %>%
  group_by(psa_nvca_risk_score, race, county) %>%
  select(recid_arrest_violent_psa_flag) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[1] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(race = factor(race, levels = c("White", "Black", "Hispanic", "Other_Unknown"))) %>%
  filter(race %in% c("White", "Black", "Hispanic")) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) 

ggplot(risk_df) +
  aes(x = psa_risk_score, y = value, color = race) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent", title = "Comparison of Racial Differences in Logistic Regression Curves--PSA, Tulare") +
  scale_x_continuous(breaks = 1:6)

# eval_df %>%
#   filter(tool_name == "PSA") %>%
#   count(county)


```
\newpage

Tulare -- White and Hispanic only
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  filter(county == "Tulare") %>%
  filter(tool_name == "PSA") %>%
  group_by(psa_fta_risk_score, race, county) %>%
  select(fta_flag) %>%
  pivot_longer(fta_flag) 

names(risk_df)[1] <- "psa_risk_score"

risk_df2 <- eval_df %>%
  filter(county == "Tulare") %>%
  filter(tool_name == "PSA") %>%
  group_by(psa_nca_risk_score, race, county) %>%
  select(recid_arrested_flag, recid_filed_flag, recid_convicted_flag) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[1] <- "psa_risk_score"

risk_df3 <- eval_df %>%
  filter(county == "Tulare") %>%
  filter(tool_name == "PSA", !is.na(psa_nvca_risk_score)) %>%
  group_by(psa_nvca_risk_score, race, county) %>%
  select(recid_arrest_violent_psa_flag) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[1] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(race = factor(race, levels = c("White", "Black", "Hispanic", "Other_Unknown"))) %>%
  filter(race %in% c("White", "Hispanic")) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) 

ggplot(risk_df) +
  aes(x = psa_risk_score, y = value, color = race) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent", title = "Comparison of Racial Differences in Logistic Regression Curves--PSA, Tulare") +
  scale_x_continuous(breaks = 1:6)

# eval_df %>%
#   filter(tool_name == "PSA") %>%
#   count(county)


```
\newpage

Alameda 
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  filter(county == "Alameda") %>%
  mutate(race = factor(race, levels = c("White", "Black", "Hispanic", "Other_Unknown"))) %>%
  filter(tool_name == "VPRAI-R", !is.na(vprair_risk_score)) %>%
  group_by(vprair_risk_score, race) %>%
  select(vprair_risk_score, race, fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag,
         any_pretrial_failure_flag, recid_arrest_violent_psa_flag) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) %>%
  filter(race %in% c("White", "Black", "Hispanic")) 

ggplot(risk_df) +
  aes(x = vprair_risk_score, y = value, color = race) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent",
       title = "Comparison of Racial Differences in Logistic Regression Curves--VPRAI-R, Alameda") +
  scale_x_continuous(breaks = 0:14)


```
\newpage

Santa Barbara  - TEMPORARILY REMOVED
\newline
```{r eval=FALSE, fig.height=6, fig.width=10, dpi=1200, include=FALSE}
risk_df <- eval_df %>%
  filter(county == "Santa Barbara") %>%
  mutate(race = factor(race, levels = c("White", "Black", "Hispanic", "Other_Unknown"))) %>%
  filter(tool_name == "VPRAI-R", !is.na(vprair_risk_score)) %>%
  group_by(vprair_risk_score, race) %>%
  select(vprair_risk_score, race, fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag,
         any_pretrial_failure_flag, recid_arrest_violent_psa_flag) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) %>%
  filter(race %in% c("White", "Black", "Hispanic")) 

ggplot(risk_df) +
  aes(x = vprair_risk_score, y = value, color = race) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent",
       title = "Comparison of Racial Differences in Logistic Regression Curves--VPRAI-R, Santa Barbara") +
  scale_x_continuous(breaks = 0:14)


```
\newpage

San Mateo 
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  filter(county == "San Mateo") %>%
  mutate(race = factor(race, levels = c("White", "Black", "Hispanic", "Other_Unknown"))) %>%
  filter(tool_name == "VPRAI-R", !is.na(vprair_risk_score)) %>%
  group_by(vprair_risk_score, race) %>%
  select(vprair_risk_score, race, fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag,
         any_pretrial_failure_flag, recid_arrest_violent_psa_flag) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) %>%
  filter(race %in% c("White", "Black", "Hispanic")) 

ggplot(risk_df) +
  aes(x = vprair_risk_score, y = value, color = race) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent",
       title = "Comparison of Racial Differences in Logistic Regression Curves--VPRAI-R, San Mateo") +
  scale_x_continuous(breaks = 0:14)


```
\newpage


# Race Logistic Regression Tables

VPRAI--Without Interactions
\newline
```{r results='asis'}
m1 <- glm(family = binomial(),fta_flag ~ vprai_risk_score + race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "VPRAI"))
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprai_risk_score + race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "VPRAI"))
m3 <- glm(family = binomial(),recid_filed_flag ~ vprai_risk_score + race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "VPRAI"))
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprai_risk_score + race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "VPRAI"))
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprai_risk_score + race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "VPRAI"))
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprai_risk_score + race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "VPRAI"))

stargazer(list(m1,m2,m3,m4,m5, m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("VPRAI Risk Score", "Race:Black", "Race:Hispanic", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

VPRAI--With Interactions at lowest score
\newline
```{r results='asis'}
m1 <- glm(family = binomial(),fta_flag ~ vprai_risk_score * race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "VPRAI") %>% mutate(across(contains("score"), ~.x-1)))
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprai_risk_score * race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "VPRAI") %>% mutate(across(contains("score"), ~.x-1)))
m3 <- glm(family = binomial(),recid_filed_flag ~ vprai_risk_score * race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "VPRAI") %>% mutate(across(contains("score"), ~.x-1)))
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprai_risk_score * race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "VPRAI") %>% mutate(across(contains("score"), ~.x-1)))
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprai_risk_score * race + release_to_pretrial_end, data =
            race_df %>% filter(tool_name == "VPRAI") %>% mutate(across(contains("score"), ~.x-1)))
m6 <- glm(family = binomial(), any_pretrial_failure_flag ~ vprai_risk_score * race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "VPRAI") %>% mutate(across(contains("score"), ~.x-1)))

stargazer(list(m1,m2,m3,m4,m5,m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("VPRAI Risk Score", "Race:Black", "Race:Hispanic",
                               "Days Released", "VPRAI*Black", "VPRAI*Hispanic"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

VPRAI--With Interactions at score 5
\newline
```{r results='asis'}
m1 <- glm(family = binomial(),fta_flag ~ vprai_risk_score * race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "VPRAI") %>% mutate(across(contains("score"), ~.x-5)))
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprai_risk_score * race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "VPRAI") %>% mutate(across(contains("score"), ~.x-5)))
m3 <- glm(family = binomial(),recid_filed_flag ~ vprai_risk_score * race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "VPRAI") %>% mutate(across(contains("score"), ~.x-5)))
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprai_risk_score * race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "VPRAI") %>% mutate(across(contains("score"), ~.x-5)))
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprai_risk_score * race + release_to_pretrial_end, data =
            race_df %>% filter(tool_name == "VPRAI") %>% mutate(across(contains("score"), ~.x-5)))
m6 <- glm(family = binomial(), any_pretrial_failure_flag ~ vprai_risk_score * race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "VPRAI") %>% mutate(across(contains("score"), ~.x-5)))

stargazer(list(m1,m2,m3,m4,m5,m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("VPRAI Risk Score", "Race:Black", "Race:Hispanic",
                               "Days Released", "VPRAI*Black", "VPRAI*Hispanic"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")

```
\newpage


VPRAI-R--Without Interactions
\newline
```{r results='asis'}
m1 <- glm(family = binomial(),fta_flag ~ vprair_risk_score + race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "VPRAI-R"))
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprair_risk_score + race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "VPRAI-R"))
m3 <- glm(family = binomial(),recid_filed_flag ~ vprair_risk_score + race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "VPRAI-R"))
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprair_risk_score + race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "VPRAI-R"))
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprair_risk_score + race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "VPRAI-R"))
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprair_risk_score + race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "VPRAI-R"))

stargazer(list(m1,m2,m3,m4,m5, m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("VPRAI-R Risk Score", "Race:Black", "Race:Hispanic", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

VPRAI-R--With Interactions at lowest score
\newline
```{r results='asis'}
m1 <- glm(family = binomial(),fta_flag ~ vprair_risk_score * race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "VPRAI-R") %>% mutate(across(contains("score"), ~.x-1)))
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprair_risk_score * race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "VPRAI-R") %>% mutate(across(contains("score"), ~.x-1)))
m3 <- glm(family = binomial(),recid_filed_flag ~ vprair_risk_score * race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "VPRAI-R") %>% mutate(across(contains("score"), ~.x-1)))
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprair_risk_score * race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "VPRAI-R") %>% mutate(across(contains("score"), ~.x-1)))
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprair_risk_score * race + release_to_pretrial_end, data =
            race_df %>% filter(tool_name == "VPRAI-R") %>% mutate(across(contains("score"), ~.x-1)))
m6 <- glm(family = binomial(), any_pretrial_failure_flag ~ vprair_risk_score * race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "VPRAI-R") %>% mutate(across(contains("score"), ~.x-1)))

stargazer(list(m1,m2,m3,m4,m5,m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("VPRAI-R Risk Score", "Race:Black", "Race:Hispanic",
                               "Days Released", "VPRAI-R*Black", "VPRAI-R*Hispanic"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

VPRAI-R--With Interactions at score 6
\newline
```{r results='asis'}
m1 <- glm(family = binomial(),fta_flag ~ vprair_risk_score * race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "VPRAI-R") %>% mutate(across(contains("score"), ~.x-6)))
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprair_risk_score * race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "VPRAI-R") %>% mutate(across(contains("score"), ~.x-6)))
m3 <- glm(family = binomial(),recid_filed_flag ~ vprair_risk_score * race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "VPRAI-R") %>% mutate(across(contains("score"), ~.x-6)))
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprair_risk_score * race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "VPRAI-R") %>% mutate(across(contains("score"), ~.x-6)))
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprair_risk_score * race + release_to_pretrial_end, data =
            race_df %>% filter(tool_name == "VPRAI-R") %>% mutate(across(contains("score"), ~.x-6)))
m6 <- glm(family = binomial(), any_pretrial_failure_flag ~ vprair_risk_score * race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "VPRAI-R") %>% mutate(across(contains("score"), ~.x-6)))

stargazer(list(m1,m2,m3,m4,m5,m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("VPRAI-R Risk Score", "Race:Black", "Race:Hispanic",
                               "Days Released", "VPRAI-R*Black", "VPRAI-R*Hispanic"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")

```
\newpage



ORAS--Without Interactions
\newline
```{r results='asis'}
m1 <- glm(family = binomial(),fta_flag ~ oras_risk_score + race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "ORAS"))
m2 <- glm(family = binomial(),recid_arrested_flag ~ oras_risk_score + race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "ORAS"))
m3 <- glm(family = binomial(),recid_filed_flag ~ oras_risk_score + race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "ORAS"))
m4 <- glm(family = binomial(),recid_convicted_flag ~ oras_risk_score + race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "ORAS"))
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ oras_risk_score + race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "ORAS"))
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ oras_risk_score + race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "ORAS"))

stargazer(list(m1,m2,m3,m4,m5, m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("ORAS Risk Score", "Race:Black", "Race:Hispanic", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

ORAS--With Interactions at lowest score 1
\newline
```{r results='asis'}
m1 <- glm(family = binomial(),fta_flag ~ oras_risk_score * race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "ORAS") %>% mutate(across(contains("score"), ~.x-1)))
m2 <- glm(family = binomial(),recid_arrested_flag ~ oras_risk_score * race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "ORAS") %>% mutate(across(contains("score"), ~.x-1)))
m3 <- glm(family = binomial(),recid_filed_flag ~ oras_risk_score * race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "ORAS") %>% mutate(across(contains("score"), ~.x-1)))
m4 <- glm(family = binomial(),recid_convicted_flag ~ oras_risk_score * race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "ORAS") %>% mutate(across(contains("score"), ~.x-1)))
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ oras_risk_score * race + release_to_pretrial_end, data =
            race_df %>% filter(tool_name == "ORAS") %>% mutate(across(contains("score"), ~.x-1)))
m6 <- glm(family = binomial(), any_pretrial_failure_flag ~ oras_risk_score * race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "ORAS") %>% mutate(across(contains("score"), ~.x-1)))

stargazer(list(m1,m2,m3,m4,m5,m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("ORAS Risk Score", "Race:Black", "Race:Hispanic",
                               "Days Released", "ORAS*Black", "ORAS*Hispanic"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

ORAS--With Interactions at score 3
\newline
```{r results='asis'}
m1 <- glm(family = binomial(),fta_flag ~ oras_risk_score * race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "ORAS") %>% mutate(across(contains("score"), ~.x-3)))
m2 <- glm(family = binomial(),recid_arrested_flag ~ oras_risk_score * race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "ORAS") %>% mutate(across(contains("score"), ~.x-3)))
m3 <- glm(family = binomial(),recid_filed_flag ~ oras_risk_score * race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "ORAS") %>% mutate(across(contains("score"), ~.x-3)))
m4 <- glm(family = binomial(),recid_convicted_flag ~ oras_risk_score * race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "ORAS") %>% mutate(across(contains("score"), ~.x-3)))
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ oras_risk_score * race + release_to_pretrial_end, data =
            race_df %>% filter(tool_name == "ORAS") %>% mutate(across(contains("score"), ~.x-3)))
m6 <- glm(family = binomial(), any_pretrial_failure_flag ~ oras_risk_score * race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "ORAS") %>% mutate(across(contains("score"), ~.x-3)))

stargazer(list(m1,m2,m3,m4,m5,m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("ORAS Risk Score", "Race:Black", "Race:Hispanic",
                               "Days Released", "ORAS*Black", "ORAS*Hispanic"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")

```
\newpage


PSA--Without Interactions
\newline
```{r, results='asis'}
m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score + race + release_to_pretrial_end , data = race_df %>% filter(tool_name == "PSA"))
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score + race + release_to_pretrial_end , data = race_df %>% filter(tool_name == "PSA"))
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score + race + release_to_pretrial_end , data = race_df %>% filter(tool_name == "PSA"))
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score + race + release_to_pretrial_end , data = race_df %>% filter(tool_name == "PSA"))
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score + race + release_to_pretrial_end , data = race_df %>% filter(tool_name == "PSA"))

stargazer(list(m1,m2,m3,m4,m5),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", 
                               "PSA NVCA Risk Score", "Race:Black", "Race:Hispanic", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

PSA--With Interactions at lowest score
\newline
```{r, results='asis'}
m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score * race + release_to_pretrial_end , data = race_df %>% filter(tool_name == "PSA") %>% mutate(across(contains("score"), ~.x-1)))
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score * race + release_to_pretrial_end , data = race_df %>% filter(tool_name == "PSA") %>% mutate(across(contains("score"), ~.x-1)))
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score * race + release_to_pretrial_end , data = race_df %>% filter(tool_name == "PSA") %>% mutate(across(contains("score"), ~.x-1)))
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score * race + release_to_pretrial_end , data = race_df %>% filter(tool_name == "PSA") %>% mutate(across(contains("score"), ~.x-1)))
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score * race + release_to_pretrial_end , data = race_df %>% filter(tool_name == "PSA"))

stargazer(list(m1,m2,m3,m4,m5),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", "PSA NVCA Risk Score", 
                               "Race:Black", "Race:Hispanic", "Days Released", "FTA*Black", "FTA*Hispanic",
                               "NCA*Black", "NCA*Hispanic", "NVCA*Black", "NVCA*Hispanic"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

PSA--With Interactions at risk score 6
\newline
```{r, results='asis'}
m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score * race + release_to_pretrial_end , data = race_df %>% filter(tool_name == "PSA") %>% mutate(across(contains("score"), ~.x-6)))
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score * race + release_to_pretrial_end , data = race_df %>% filter(tool_name == "PSA") %>% mutate(across(contains("score"), ~.x-6)))
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score * race + release_to_pretrial_end , data = race_df %>% filter(tool_name == "PSA") %>% mutate(across(contains("score"), ~.x-6)))
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score * race + release_to_pretrial_end , data = race_df %>% filter(tool_name == "PSA") %>% mutate(across(contains("score"), ~.x-6)))
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score * race + release_to_pretrial_end , data = race_df %>% filter(tool_name == "PSA")%>% mutate(across(contains("score"), ~.x-1)))

stargazer(list(m1,m2,m3,m4,m5),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", "PSA NVCA Risk Score", 
                               "Race:Black", "Race:Hispanic", "Days Released", "FTA*Black", "FTA*Hispanic",
                               "NCA*Black", "NCA*Hispanic", "NVCA*Black", "NVCA*Hispanic"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")

```
\newpage

San Joaquin--Without Interactions
\newline
```{r results='asis'}
county_df <- race_df %>%
  filter(county == "San Joaquin") %>%
  filter(tool_name == "VPRAI")

m1 <- glm(family = binomial(),fta_flag ~ vprai_risk_score + race + release_to_pretrial_end, data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprai_risk_score + race + release_to_pretrial_end, data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprai_risk_score + race + release_to_pretrial_end, data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprai_risk_score + race + release_to_pretrial_end, data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprai_risk_score + race + release_to_pretrial_end, data = county_df)
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprai_risk_score + race + release_to_pretrial_end, data = county_df)

stargazer(list(m1,m2,m3,m4,m5, m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("VPRAI Risk Score", "Race:Black", "Race:Hispanic", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

San Joaquin--With Interactions at risk score 1
\newline
```{r results='asis'}
county_df <- race_df %>%
  filter(county == "San Joaquin") %>%
  filter(tool_name == "VPRAI")%>%
  mutate(across(contains("score"), ~.x-1))

m1 <- glm(family = binomial(),fta_flag ~ vprai_risk_score * race + release_to_pretrial_end, data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprai_risk_score * race + release_to_pretrial_end, data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprai_risk_score * race + release_to_pretrial_end, data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprai_risk_score * race + release_to_pretrial_end, data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprai_risk_score * race + release_to_pretrial_end, data = county_df)
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprai_risk_score * race + release_to_pretrial_end, data = county_df)


stargazer(list(m1,m2,m3,m4,m5, m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("VPRAI Risk Score", "Race:Black", "Race:Hispanic",
                               "Days Released", "VPRAI*Black", "VPRAI*Hispanic"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

San Joaquin--With Interactions at risk level 5
\newline
```{r results='asis'}
county_df <- race_df %>%
  filter(county == "San Joaquin") %>%
  filter(tool_name == "VPRAI")%>%
  mutate(across(contains("score"), ~.x-5))

m1 <- glm(family = binomial(),fta_flag ~ vprai_risk_score * race + release_to_pretrial_end, data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprai_risk_score * race + release_to_pretrial_end, data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprai_risk_score * race + release_to_pretrial_end, data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprai_risk_score * race + release_to_pretrial_end, data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprai_risk_score * race + release_to_pretrial_end, data = county_df)
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprai_risk_score * race + release_to_pretrial_end, data = county_df)


stargazer(list(m1,m2,m3,m4,m5, m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("VPRAI Risk Score", "Race:Black", "Race:Hispanic",
                               "Days Released", "VPRAI*Black", "VPRAI*Hispanic"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
```{r}
county_df %>%
  count(vprai_risk_score)
# 0:4

summary(m1)
summary(m2)
summary(m6)
```

\newpage

Los Angeles--Without Interactions
\newline
```{r, results='asis'}
county_df <- race_df %>%
  filter(county == "Los Angeles") %>%
  filter(tool_name == "PSA")

m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score + race + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score + race + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score + race + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score + race + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score + race + release_to_pretrial_end , data = county_df)

stargazer(list(m1,m2,m3,m4,m5),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", 
                               "PSA NVCA Risk Score", "Race:Black", "Race:Hispanic", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

Los Angeles--With Interactions
\newline
```{r, results='asis'}
county_df <- race_df %>%
  filter(county == "Los Angeles") %>%
  filter(tool_name == "PSA") %>%
  mutate(across(contains("score"), ~.x-1)) %>%
  mutate(psa_nvca_risk_score = psa_nvca_risk_score + 1)

m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score * race + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score * race + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score * race + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score * race + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score * race + release_to_pretrial_end , data = county_df)

stargazer(list(m1,m2,m3,m4,m5),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", "PSA NVCA Risk Score",
                               "Race:Black", "Race:Hispanic", "Days Released", "FTA*Black", "FTA*Hispanic",
                               "NCA*Black", "NCA*Hispanic", "NVCA*Black", "NVCA*Hispanic"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

Sacramento--Without Interactions
\newline
```{r, results='asis'}
county_df <- race_df %>%
  filter(county == "Sacramento") %>%
  filter(tool_name == "PSA")

m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score + race + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score + race + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score + race + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score + race + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score + race + release_to_pretrial_end , data = county_df)

stargazer(list(m1,m2,m3,m4,m5),
        # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", 
                               "PSA NVCA Risk Score", "Race:Black", "Race:Hispanic", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

Sacramento--With Interactions at lowest score
\newline
```{r, results='asis'}
county_df <- race_df %>%
  filter(county == "Sacramento") %>%
  filter(tool_name == "PSA") %>%
  mutate(across(contains("score"), ~.x-1)) %>%
  mutate(psa_nvca_risk_score = psa_nvca_risk_score + 1)

m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score * race + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score * race + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score * race + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score * race + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score * race + release_to_pretrial_end , data = county_df)

stargazer(list(m1,m2,m3,m4,m5),
        # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", "PSA NVCA Risk Score", 
                               "Race:Black", "Race:Hispanic", "Days Released", "FTA*Black", "FTA*Hispanic",
                               "NCA*Black", "NCA*Hispanic", "NVCA*Black", "NVCA*Hispanic"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

Sacramento--With Interactions at highest score
\newline
```{r, results='asis'}
county_df <- race_df %>%
  filter(county == "Sacramento") %>%
  filter(tool_name == "PSA") %>%
  mutate(across(contains("score"), ~.x-6)) %>%
  mutate(psa_nvca_risk_score = psa_nvca_risk_score + 5)

m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score * race + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score * race + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score * race + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score * race + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score * race + release_to_pretrial_end , data = county_df)

stargazer(list(m1,m2,m3,m4,m5),
        # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", "PSA NVCA Risk Score", 
                               "Race:Black", "Race:Hispanic", "Days Released", "FTA*Black", "FTA*Hispanic",
                               "NCA*Black", "NCA*Hispanic", "NVCA*Black", "NVCA*Hispanic"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```

```{r}
summary(m1)
```

\newpage


Ventura--Without Interactions
\newline
```{r results='asis'}
m1 <- glm(family = binomial(),fta_flag ~ oras_risk_score + race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "ORAS", county == "Ventura"))
m2 <- glm(family = binomial(),recid_arrested_flag ~ oras_risk_score + race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "ORAS", county == "Ventura"))
m3 <- glm(family = binomial(),recid_filed_flag ~ oras_risk_score + race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "ORAS", county == "Ventura"))
m4 <- glm(family = binomial(),recid_convicted_flag ~ oras_risk_score + race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "ORAS", county == "Ventura"))
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ oras_risk_score + race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "ORAS", county == "Ventura"))
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ oras_risk_score + race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "ORAS", county == "Ventura"))

stargazer(list(m1,m2,m3,m4,m5, m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("ORAS Risk Score", "Race:Black", "Race:Hispanic", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

Ventura--With Interactions at lowest score 0
\newline
```{r results='asis'}
m1 <- glm(family = binomial(),fta_flag ~ oras_risk_score * race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "ORAS", county == "Ventura") %>% mutate(across(contains("score"), ~.x)))
m2 <- glm(family = binomial(),recid_arrested_flag ~ oras_risk_score * race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "ORAS", county == "Ventura") %>% mutate(across(contains("score"), ~.x)))
m3 <- glm(family = binomial(),recid_filed_flag ~ oras_risk_score * race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "ORAS", county == "Ventura") %>% mutate(across(contains("score"), ~.x)))
m4 <- glm(family = binomial(),recid_convicted_flag ~ oras_risk_score * race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "ORAS", county == "Ventura") %>% mutate(across(contains("score"), ~.x)))
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ oras_risk_score * race + release_to_pretrial_end, data =
            race_df %>% filter(tool_name == "ORAS", county == "Ventura") %>% mutate(across(contains("score"), ~.x)))
m6 <- glm(family = binomial(), any_pretrial_failure_flag ~ oras_risk_score * race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "ORAS", county == "Ventura") %>% mutate(across(contains("score"), ~.x)))

stargazer(list(m1,m2,m3,m4,m5,m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("ORAS Risk Score", "Race:Black", "Race:Hispanic",
                               "Days Released", "ORAS*Black", "ORAS*Hispanic"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

Ventura--With Interactions at score 9
\newline
```{r results='asis'}
m1 <- glm(family = binomial(),fta_flag ~ oras_risk_score * race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "ORAS", county == "Ventura") %>% mutate(across(contains("score"), ~.x-9)))
m2 <- glm(family = binomial(),recid_arrested_flag ~ oras_risk_score * race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "ORAS", county == "Ventura") %>% mutate(across(contains("score"), ~.x-9)))
m3 <- glm(family = binomial(),recid_filed_flag ~ oras_risk_score * race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "ORAS", county == "Ventura") %>% mutate(across(contains("score"), ~.x-9)))
m4 <- glm(family = binomial(),recid_convicted_flag ~ oras_risk_score * race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "ORAS", county == "Ventura") %>% mutate(across(contains("score"), ~.x-9)))
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ oras_risk_score * race + release_to_pretrial_end, data =
            race_df %>% filter(tool_name == "ORAS", county == "Ventura") %>% mutate(across(contains("score"), ~.x-9)))
m6 <- glm(family = binomial(), any_pretrial_failure_flag ~ oras_risk_score * race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "ORAS", county == "Ventura") %>% mutate(across(contains("score"), ~.x-9)))

stargazer(list(m1,m2,m3,m4,m5,m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("ORAS Risk Score", "Race:Black", "Race:Hispanic",
                               "Days Released", "ORAS*Black", "ORAS*Hispanic"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")

```
\newpage

Ventura--Without Interactions  -- White and Hispanic only
\newline
```{r results='asis'}
m1 <- glm(family = binomial(),fta_flag ~ oras_risk_score + race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "ORAS", county == "Ventura", race != "Black"))
m2 <- glm(family = binomial(),recid_arrested_flag ~ oras_risk_score + race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "ORAS", county == "Ventura", race != "Black"))
m3 <- glm(family = binomial(),recid_filed_flag ~ oras_risk_score + race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "ORAS", county == "Ventura", race != "Black"))
m4 <- glm(family = binomial(),recid_convicted_flag ~ oras_risk_score + race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "ORAS", county == "Ventura", race != "Black"))
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ oras_risk_score + race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "ORAS", county == "Ventura", race != "Black"))
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ oras_risk_score + race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "ORAS", county == "Ventura", race != "Black"))

stargazer(list(m1,m2,m3,m4,m5, m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("ORAS Risk Score", "Race:Hispanic", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

Ventura--With Interactions at lowest score 0 -- White and Hispanic only
\newline
```{r results='asis'}
m1 <- glm(family = binomial(),fta_flag ~ oras_risk_score * race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "ORAS", county == "Ventura", race != "Black") %>% mutate(across(contains("score"), ~.x)))
m2 <- glm(family = binomial(),recid_arrested_flag ~ oras_risk_score * race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "ORAS", county == "Ventura", race != "Black") %>% mutate(across(contains("score"), ~.x)))
m3 <- glm(family = binomial(),recid_filed_flag ~ oras_risk_score * race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "ORAS", county == "Ventura", race != "Black") %>% mutate(across(contains("score"), ~.x)))
m4 <- glm(family = binomial(),recid_convicted_flag ~ oras_risk_score * race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "ORAS", county == "Ventura", race != "Black") %>% mutate(across(contains("score"), ~.x)))
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ oras_risk_score * race + release_to_pretrial_end, data =
            race_df %>% filter(tool_name == "ORAS", county == "Ventura", race != "Black") %>% mutate(across(contains("score"), ~.x)))
m6 <- glm(family = binomial(), any_pretrial_failure_flag ~ oras_risk_score * race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "ORAS", county == "Ventura", race != "Black") %>% mutate(across(contains("score"), ~.x)))

stargazer(list(m1,m2,m3,m4,m5,m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("ORAS Risk Score", "Race:Hispanic",
                               "Days Released",  "ORAS*Hispanic"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

Ventura--With Interactions at score 9 -- White and Hispanic only
\newline
```{r results='asis'}
m1 <- glm(family = binomial(),fta_flag ~ oras_risk_score * race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "ORAS", county == "Ventura", race != "Black") %>% mutate(across(contains("score"), ~.x-9)))
m2 <- glm(family = binomial(),recid_arrested_flag ~ oras_risk_score * race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "ORAS", county == "Ventura", race != "Black") %>% mutate(across(contains("score"), ~.x-9)))
m3 <- glm(family = binomial(),recid_filed_flag ~ oras_risk_score * race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "ORAS", county == "Ventura", race != "Black") %>% mutate(across(contains("score"), ~.x-9)))
m4 <- glm(family = binomial(),recid_convicted_flag ~ oras_risk_score * race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "ORAS", county == "Ventura", race != "Black") %>% mutate(across(contains("score"), ~.x-9)))
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ oras_risk_score * race + release_to_pretrial_end, data =
            race_df %>% filter(tool_name == "ORAS", county == "Ventura", race != "Black") %>% mutate(across(contains("score"), ~.x-9)))
m6 <- glm(family = binomial(), any_pretrial_failure_flag ~ oras_risk_score * race + release_to_pretrial_end, data = race_df %>% filter(tool_name == "ORAS", county == "Ventura", race != "Black") %>% mutate(across(contains("score"), ~.x-9)))

stargazer(list(m1,m2,m3,m4,m5,m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("ORAS Risk Score",  "Race:Hispanic",
                               "Days Released",  "ORAS*Hispanic"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")

```
\newpage


Sonoma--Without Interactions
\newline
```{r, results='asis'}
county_df <- race_df %>%
  filter(county == "Sonoma") %>%
  filter(tool_name == "PSA")

m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score + race + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score + race + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score + race + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score + race + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score + race + release_to_pretrial_end , data = county_df)

stargazer(list(m1,m2,m3,m4,m5),
        # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", 
                               "PSA NVCA Risk Score", "Race:Black", "Race:Hispanic", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

Sonoma--With Interactions
\newline
```{r, results='asis'}
county_df <- race_df %>%
  filter(county == "Sonoma") %>%
  filter(tool_name == "PSA") %>%
  mutate(across(contains("score"), ~.x-1)) %>%
  mutate(psa_nvca_risk_score = psa_nvca_risk_score + 1)

m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score * race + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score * race + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score * race + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score * race + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score * race + release_to_pretrial_end , data = county_df)

stargazer(list(m1,m2,m3,m4,m5),
        # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", "PSA NVCA Risk Score", 
                               "Race:Black", "Race:Hispanic", "Days Released", "FTA*Black", "FTA*Hispanic",
                               "NCA*Black", "NCA*Hispanic", "NVCA*Black", "NVCA*Hispanic"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage


Sonoma--Without Interactions - White and Hispanic only
\newline
```{r, results='asis'}
county_df <- race_df %>%
  filter(county == "Sonoma") %>%
  filter(tool_name == "PSA") %>%
  filter(race %in% c("White", "Hispanic"))

m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score + race + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score + race + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score + race + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score + race + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score + race + release_to_pretrial_end , data = county_df)

stargazer(list(m1,m2,m3,m4,m5),
        # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", 
                               "PSA NVCA Risk Score", "Race:Hispanic", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

Sonoma--With Interactions - White and Hispanic only
\newline
```{r, results='asis'}
county_df <- race_df %>%
  filter(county == "Sonoma") %>%
  filter(tool_name == "PSA") %>%
  mutate(across(contains("score"), ~.x-1)) %>%
  mutate(psa_nvca_risk_score = psa_nvca_risk_score + 1) %>%
  filter(race %in% c("White", "Hispanic"))

m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score * race + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score * race + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score * race + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score * race + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score * race + release_to_pretrial_end , data = county_df)

stargazer(list(m1,m2,m3,m4,m5),
        # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", "PSA NVCA Risk Score", 
                               "Race:Hispanic", "Days Released",  "FTA*Hispanic",
                               "NCA*Hispanic",  "NVCA*Hispanic"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage


Tulare--Without Interactions 
\newline
```{r results='asis'}
county_df <- race_df %>%
  filter(county == "Tulare") %>%
  filter(tool_name == "PSA")

m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score + race + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score + race + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score + race + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score + race + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score + race + release_to_pretrial_end , data = county_df)

stargazer(list(m1,m2,m3,m4,m5),
        # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", 
                               "PSA NVCA Risk Score", "Race:Black", "Race:Hispanic", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

Tulare--Without Interactions, White and Hispanic only 
\newline
```{r  results='asis'}
county_df <- race_df %>%
  filter(race != "Black") %>%
  filter(county == "Tulare") %>%
  filter(tool_name == "PSA")

m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score + race + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score + race + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score + race + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score + race + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score + race + release_to_pretrial_end , data = county_df)

stargazer(list(m1,m2,m3,m4,m5),
        # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", 
                               "PSA NVCA Risk Score", "Race:Hispanic", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

Tulare--With Interactions  
\newline
```{r  results='asis'}
county_df <- race_df %>%
  filter(county == "Tulare") %>%
  filter(tool_name == "PSA") %>%
  mutate(across(contains("score"), ~.x-1)) %>%
  mutate(psa_nvca_risk_score = psa_nvca_risk_score + 1)

m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score * race + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score * race + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score * race + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score * race + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score * race + release_to_pretrial_end , data = county_df)

stargazer(list(m1,m2,m3,m4,m5),
        # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", "PSA NVCA Risk Score", 
                               "Race:Black", "Race:Hispanic", "Days Released", "FTA*Black", "FTA*Hispanic",
                               "NCA*Black", "NCA*Hispanic", "NVCA*Black", "NVCA*Hispanic"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

Tulare--With Interactions, White and Hispanic only 
\newline
```{r  results='asis'}
county_df <- race_df %>%
  filter(county == "Tulare") %>%
  filter(tool_name == "PSA") %>%
  filter(race != "Black") %>%
  mutate(across(contains("score"), ~.x-1)) %>%
  mutate(psa_nvca_risk_score = psa_nvca_risk_score + 1)

m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score * race + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score * race + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score * race + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score * race + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score * race + release_to_pretrial_end , data = county_df)

stargazer(list(m1,m2,m3,m4,m5),
        # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", "PSA NVCA Risk Score", 
                               "Race:Hispanic", "Days Released",  "FTA*Hispanic",
                                "NCA*Hispanic",  "NVCA*Hispanic"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage


Alameda--Without Interactions
\newline
```{r results='asis'}
county_df <- race_df %>%
  filter(county == "Alameda") %>%
  filter(tool_name == "VPRAI-R")

m1 <- glm(family = binomial(),fta_flag ~ vprair_risk_score + race + release_to_pretrial_end, data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprair_risk_score + race + release_to_pretrial_end, data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprair_risk_score + race + release_to_pretrial_end, data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprair_risk_score + race + release_to_pretrial_end, data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprair_risk_score + race + release_to_pretrial_end, data = county_df)
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprair_risk_score + race + release_to_pretrial_end, data = county_df)

stargazer(list(m1,m2,m3,m4,m5, m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("VPRAI-R Risk Score", "Race:Black", "Race:Hispanic", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

Alameda--With Interactions at score 1
\newline
```{r results='asis'}
county_df <- race_df %>%
  filter(county == "Alameda") %>%
  filter(tool_name == "VPRAI-R")%>%
  mutate(across(contains("score"), ~.x-1))

m1 <- glm(family = binomial(),fta_flag ~ vprair_risk_score * race + release_to_pretrial_end, data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprair_risk_score * race + release_to_pretrial_end, data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprair_risk_score * race + release_to_pretrial_end, data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprair_risk_score * race + release_to_pretrial_end, data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprair_risk_score * race + release_to_pretrial_end, data = county_df)
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprair_risk_score * race + release_to_pretrial_end, data = county_df)


stargazer(list(m1,m2,m3,m4,m5, m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("VPRAI-R Risk Score", "Race:Black", "Race:Hispanic",
                               "Days Released", "VPRAI-R*Black", "VPRAI-R*Hispanic"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

Alameda--With Interactions at score 6
\newline
```{r results='asis'}
county_df <- race_df %>%
  filter(county == "Alameda") %>%
  filter(tool_name == "VPRAI-R")%>%
  mutate(across(contains("score"), ~.x-6))

m1 <- glm(family = binomial(),fta_flag ~ vprair_risk_score * race + release_to_pretrial_end, data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprair_risk_score * race + release_to_pretrial_end, data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprair_risk_score * race + release_to_pretrial_end, data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprair_risk_score * race + release_to_pretrial_end, data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprair_risk_score * race + release_to_pretrial_end, data = county_df)
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprair_risk_score * race + release_to_pretrial_end, data = county_df)


stargazer(list(m1,m2,m3,m4,m5, m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("VPRAI-R Risk Score", "Race:Black", "Race:Hispanic",
                               "Days Released", "VPRAI-R*Black", "VPRAI-R*Hispanic"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
```{r}
summary(m6)
```

Santa Barbara--Without Interactions - TEMPORARILY REMOVED
\newline
```{r eval=FALSE, include=FALSE, results='asis'}
county_df <- race_df %>%
  filter(county == "Santa Barbara") %>%
  filter(tool_name == "VPRAI-R")

m1 <- glm(family = binomial(),fta_flag ~ vprair_risk_score + race + release_to_pretrial_end, data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprair_risk_score + race + release_to_pretrial_end, data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprair_risk_score + race + release_to_pretrial_end, data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprair_risk_score + race + release_to_pretrial_end, data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprair_risk_score + race + release_to_pretrial_end, data = county_df)
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprair_risk_score + race + release_to_pretrial_end, data = county_df)

stargazer(list(m1,m2,m3,m4,m5, m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("VPRAI-R Risk Score", "Race:Black", "Race:Hispanic", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

Santa Barbara--With Interactions  - TEMPORARILY REMOVED
\newline
```{r eval=FALSE, include=FALSE, results='asis'}
county_df <- race_df %>%
  filter(county == "Santa Barbara") %>%
  filter(tool_name == "VPRAI-R")%>%
  mutate(across(contains("score"), ~.x-1))

m1 <- glm(family = binomial(),fta_flag ~ vprair_risk_score * race + release_to_pretrial_end, data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprair_risk_score * race + release_to_pretrial_end, data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprair_risk_score * race + release_to_pretrial_end, data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprair_risk_score * race + release_to_pretrial_end, data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprair_risk_score * race + release_to_pretrial_end, data = county_df)
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprair_risk_score * race + release_to_pretrial_end, data = county_df)


stargazer(list(m1,m2,m3,m4,m5, m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("VPRAI-R Risk Score", "Race:Black", "Race:Hispanic",
                               "Days Released", "VPRAI-R*Black", "VPRAI-R*Hispanic"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

San Mateo--Without Interactions
\newline
```{r results='asis'}
county_df <- race_df %>%
  filter(county == "San Mateo") %>%
  filter(tool_name == "VPRAI-R")

m1 <- glm(family = binomial(),fta_flag ~ vprair_risk_score + race + release_to_pretrial_end, data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprair_risk_score + race + release_to_pretrial_end, data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprair_risk_score + race + release_to_pretrial_end, data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprair_risk_score + race + release_to_pretrial_end, data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprair_risk_score + race + release_to_pretrial_end, data = county_df)
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprair_risk_score + race + release_to_pretrial_end, data = county_df)

stargazer(list(m1,m2,m3,m4,m5, m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("VPRAI-R Risk Score", "Race:Black", "Race:Hispanic", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

San Mateo--With Interactions at score 1
\newline
```{r results='asis'}
county_df <- race_df %>%
  filter(county == "San Mateo") %>%
  filter(tool_name == "VPRAI-R")%>%
  mutate(across(contains("score"), ~.x-1))

m1 <- glm(family = binomial(),fta_flag ~ vprair_risk_score * race + release_to_pretrial_end, data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprair_risk_score * race + release_to_pretrial_end, data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprair_risk_score * race + release_to_pretrial_end, data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprair_risk_score * race + release_to_pretrial_end, data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprair_risk_score * race + release_to_pretrial_end, data = county_df)
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprair_risk_score * race + release_to_pretrial_end, data = county_df)


stargazer(list(m1,m2,m3,m4,m5, m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("VPRAI-R Risk Score", "Race:Black", "Race:Hispanic",
                               "Days Released", "VPRAI-R*Black", "VPRAI-R*Hispanic"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

San Mateo--With Interactions at score 1
\newline
```{r results='asis'}
county_df <- race_df %>%
  filter(county == "San Mateo") %>%
  filter(tool_name == "VPRAI-R")%>%
  mutate(across(contains("score"), ~.x-6))

m1 <- glm(family = binomial(),fta_flag ~ vprair_risk_score * race + release_to_pretrial_end, data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprair_risk_score * race + release_to_pretrial_end, data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprair_risk_score * race + release_to_pretrial_end, data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprair_risk_score * race + release_to_pretrial_end, data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprair_risk_score * race + release_to_pretrial_end, data = county_df)
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprair_risk_score * race + release_to_pretrial_end, data = county_df)


stargazer(list(m1,m2,m3,m4,m5, m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("VPRAI-R Risk Score", "Race:Black", "Race:Hispanic",
                               "Days Released", "VPRAI-R*Black", "VPRAI-R*Hispanic"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage


```{r}
summary(m3)
```



# Race AUCs

VPRAI 
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "VPRAI", race != "All", sex == "All", county == "All") %>%
  select(race, outcome, AUC, CI, n) %>%
  mutate(outcome = case_when(outcome == "fta_flag" ~ "FTA",
                             outcome == "recid_arrested_flag" ~ "New Arrest",
                             outcome == "recid_filed_flag" ~ "New Filing",
                             outcome == "recid_convicted_flag" ~ "New Conviction",
                             outcome == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest",
                             outcome == "any_pretrial_failure_flag" ~ "FTA or New Arrest"))

names(tool_df) <- c("race", "Outcome", "AUC", "CI (95%)", "N")

tool_df <- tool_df %>%
  pivot_wider(names_from = race, values_from = c(AUC, `CI (95%)`, N))

names(tool_df) <- gsub("AUC_|CI .*_", "", names(tool_df))

kable(tool_df[1:7], booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray",
                  font_size = 10, latex_options = "hold_position") %>%
  add_header_above(c(" " = 1, "AUC" = 3, "CI (95%)" = 3)) %>% 
  footnote(paste("N White =", tool_df$N_White[1], ", N Black =", 
                     tool_df$N_Black[1], ", N Hispanic =", tool_df$N_Hispanic[1]))
```
\newpage


VPRAI-R 
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "VPRAI-R", race != "All", sex == "All", county == "All") %>%
  select(race, outcome, AUC, CI, n) %>%
  mutate(outcome = case_when(outcome == "fta_flag" ~ "FTA",
                             outcome == "recid_arrested_flag" ~ "New Arrest",
                             outcome == "recid_filed_flag" ~ "New Filing",
                             outcome == "recid_convicted_flag" ~ "New Conviction",
                             outcome == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest",
                             outcome == "any_pretrial_failure_flag" ~ "FTA or New Arrest"))

names(tool_df) <- c("race", "Outcome", "AUC", "CI (95%)", "N")

tool_df <- tool_df %>%
  pivot_wider(names_from = race, values_from = c(AUC, `CI (95%)`, N))

names(tool_df) <- gsub("AUC_|CI .*_", "", names(tool_df))

kable(tool_df[1:7], booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray",
                  font_size = 10, latex_options = "hold_position") %>%
  add_header_above(c(" " = 1, "AUC" = 3, "CI (95%)" = 3)) %>% 
  footnote(paste("N White =", tool_df$N_White[1], ", N Black =", 
                     tool_df$N_Black[1], ", N Hispanic =", tool_df$N_Hispanic[1]))
```
\newpage


ORAS 
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "ORAS", race != "All", sex == "All", county == "All") %>%
  select(race, outcome, AUC, CI, n) %>%
  mutate(outcome = case_when(outcome == "fta_flag" ~ "FTA",
                             outcome == "recid_arrested_flag" ~ "New Arrest",
                             outcome == "recid_filed_flag" ~ "New Filing",
                             outcome == "recid_convicted_flag" ~ "New Conviction",
                             outcome == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest",
                             outcome == "any_pretrial_failure_flag" ~ "FTA or New Arrest"))

names(tool_df) <- c("race", "Outcome", "AUC", "CI (95%)", "N")

tool_df <- tool_df %>%
  pivot_wider(names_from = race, values_from = c(AUC, `CI (95%)`, N))

names(tool_df) <- gsub("AUC_|CI .*_", "", names(tool_df))

kable(tool_df[1:7], booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray",
                  font_size = 10, latex_options = "hold_position") %>%
  add_header_above(c(" " = 1, "AUC" = 3, "CI (95%)" = 3)) %>% 
  footnote(paste("N White =", tool_df$N_White[1], ", N Black =", 
                     tool_df$N_Black[1], ", N Hispanic =", tool_df$N_Hispanic[1]))
```
\newpage

PSA
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "PSA", race != "All", sex == "All", county == "All") %>%
  select(race, risk_score, outcome, AUC, CI, n) %>%
  mutate(risk_score = case_when(risk_score == "psa_fta_risk_score" ~ "PSA FTA",
                                risk_score == "psa_nca_risk_score" ~ "PSA NCA",
                                risk_score == "psa_nvca_risk_score" ~ "PSA NVCA")) %>%
  mutate(outcome = case_when(outcome == "fta_flag" ~ "FTA",
                             outcome == "recid_arrested_flag" ~ "New Arrest",
                             outcome == "recid_filed_flag" ~ "New Filing",
                             outcome == "recid_convicted_flag" ~ "New Conviction",
                             outcome == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest",
                             outcome == "any_pretrial_failure_flag" ~ "FTA or New Arrest"))

names(tool_df) <- c("race", "Risk Score", "Outcome", "AUC", "CI (95%)", "N")

tool_df <- tool_df %>%
  pivot_wider(names_from = race, values_from = c(AUC, `CI (95%)`, N))

names(tool_df) <- gsub("AUC_|CI .*_", "", names(tool_df))

kable(tool_df[1:8], booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray",
                  font_size = 10, latex_options = "hold_position") %>%
  add_header_above(c(" " = 2, "AUC" = 3, "CI (95%)" = 3)) %>% 
  footnote(paste("N White =", tool_df$N_White[1], ", N Black =", 
                     tool_df$N_Black[1], ", N Hispanic =", tool_df$N_Hispanic[1]))
```
\newpage

San Joaquin 
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "VPRAI", race != "All", sex == "All", county == "San Joaquin") %>%
  select(race, outcome, AUC, CI, n) %>%
  mutate(outcome = case_when(outcome == "fta_flag" ~ "FTA",
                             outcome == "recid_arrested_flag" ~ "New Arrest",
                             outcome == "recid_filed_flag" ~ "New Filing",
                             outcome == "recid_convicted_flag" ~ "New Conviction",
                             outcome == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest",
                             outcome == "any_pretrial_failure_flag" ~ "FTA or New Arrest"))

names(tool_df) <- c("race", "Outcome", "AUC", "CI (95%)", "N")

tool_df <- tool_df %>%
  pivot_wider(names_from = race, values_from = c(AUC, `CI (95%)`, N))

names(tool_df) <- gsub("AUC_|CI .*_", "", names(tool_df))

kable(tool_df[1:7], booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray",
                  font_size = 10, latex_options = "hold_position") %>%
  add_header_above(c(" " = 1, "AUC" = 3, "CI (95%)" = 3)) %>% 
  footnote(paste("N White =", tool_df$N_White[1], ", N Black =", 
                     tool_df$N_Black[1], ", N Hispanic =", tool_df$N_Hispanic[1]))
```
\newpage

Los Angeles
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "PSA", race != "All", sex == "All", county == "Los Angeles") %>%
  select(race, risk_score, outcome, AUC, CI, n) %>%
  mutate(risk_score = case_when(risk_score == "psa_fta_risk_score" ~ "PSA FTA",
                                risk_score == "psa_nca_risk_score" ~ "PSA NCA",
                                risk_score == "psa_nvca_risk_score" ~ "PSA NVCA")) %>%
  mutate(outcome = case_when(outcome == "fta_flag" ~ "FTA",
                             outcome == "recid_arrested_flag" ~ "New Arrest",
                             outcome == "recid_filed_flag" ~ "New Filing",
                             outcome == "recid_convicted_flag" ~ "New Conviction",
                             outcome == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest",
                             outcome == "any_pretrial_failure_flag" ~ "FTA or New Arrest"))

names(tool_df) <- c("race", "Risk Score", "Outcome", "AUC", "CI (95%)", "N")

tool_df <- tool_df %>%
  pivot_wider(names_from = race, values_from = c(AUC, `CI (95%)`, N))

names(tool_df) <- gsub("AUC_|CI .*_", "", names(tool_df))

kable(tool_df[1:8], booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray",
                  font_size = 10, latex_options = "hold_position") %>%
  add_header_above(c(" " = 2, "AUC" = 3, "CI (95%)" = 3)) %>% 
  footnote(paste("N White =", tool_df$N_White[1], ", N Black =", 
                     tool_df$N_Black[1], ", N Hispanic =", tool_df$N_Hispanic[1]))


```
\newpage

Sacramento
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "PSA", race != "All", sex == "All", county == "Sacramento") %>%
  select(race, risk_score, outcome, AUC, CI, n) %>%
  mutate(risk_score = case_when(risk_score == "psa_fta_risk_score" ~ "PSA FTA",
                                risk_score == "psa_nca_risk_score" ~ "PSA NCA",
                                risk_score == "psa_nvca_risk_score" ~ "PSA NVCA")) %>%
  mutate(outcome = case_when(outcome == "fta_flag" ~ "FTA",
                             outcome == "recid_arrested_flag" ~ "New Arrest",
                             outcome == "recid_filed_flag" ~ "New Filing",
                             outcome == "recid_convicted_flag" ~ "New Conviction",
                             outcome == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest",
                             outcome == "any_pretrial_failure_flag" ~ "FTA or New Arrest"))

names(tool_df) <- c("race", "Risk Score", "Outcome", "AUC", "CI (95%)", "N")

tool_df <- tool_df %>%
  pivot_wider(names_from = race, values_from = c(AUC, `CI (95%)`, N))

names(tool_df) <- gsub("AUC_|CI .*_", "", names(tool_df))

kable(tool_df[1:8], booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray",
                  font_size = 10, latex_options = "hold_position") %>%
  add_header_above(c(" " = 2, "AUC" = 3, "CI (95%)" = 3)) %>% 
  footnote(paste("N White =", tool_df$N_White[1], ", N Black =", 
                     tool_df$N_Black[1], ", N Hispanic =", tool_df$N_Hispanic[1]))
```
\newpage

Ventura 
\newline
```{r eval=FALSE, include=FALSE}
tool_df <- auc_df %>%
  filter(tool_name == "ORAS", race != "All", sex == "All", county == "Ventura") %>%
  select(race, outcome, AUC, CI, n) %>%
  mutate(outcome = case_when(outcome == "fta_flag" ~ "FTA",
                             outcome == "recid_arrested_flag" ~ "New Arrest",
                             outcome == "recid_filed_flag" ~ "New Filing",
                             outcome == "recid_convicted_flag" ~ "New Conviction",
                             outcome == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest",
                             outcome == "any_pretrial_failure_flag" ~ "FTA or New Arrest"))

names(tool_df) <- c("race", "Outcome", "AUC", "CI (95%)", "N")

tool_df <- tool_df %>%
  pivot_wider(names_from = race, values_from = c(AUC, `CI (95%)`, N))

names(tool_df) <- gsub("AUC_|CI .*_", "", names(tool_df))

kable(tool_df[1:7], booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray",
                  font_size = 10, latex_options = "hold_position") %>%
  add_header_above(c(" " = 1, "AUC" = 3, "CI (95%)" = 3)) %>% 
  footnote(paste("N White =", tool_df$N_White[1], ", N Black =", 
                     tool_df$N_Black[1], ", N Hispanic =", tool_df$N_Hispanic[1]))
```
\newpage

Ventura -- only White and Hispanic
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "ORAS", race != "All", race != "Black", sex == "All", county == "Ventura") %>%
  select(race, outcome, AUC, CI, n) %>%
  mutate(outcome = case_when(outcome == "fta_flag" ~ "FTA",
                             outcome == "recid_arrested_flag" ~ "New Arrest",
                             outcome == "recid_filed_flag" ~ "New Filing",
                             outcome == "recid_convicted_flag" ~ "New Conviction",
                             outcome == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest",
                             outcome == "any_pretrial_failure_flag" ~ "FTA or New Arrest"))

names(tool_df) <- c("race", "Outcome", "AUC", "CI (95%)", "N")

tool_df <- tool_df %>%
  pivot_wider(names_from = race, values_from = c(AUC, `CI (95%)`, N))

names(tool_df) <- gsub("AUC_|CI .*_", "", names(tool_df))

kable(tool_df[1:5], booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray",
                  font_size = 10, latex_options = "hold_position") %>%
  add_header_above(c(" " = 1, "AUC" = 2, "CI (95%)" = 2)) %>% 
  footnote(paste("N White =", tool_df$N_White[1],  ", N Hispanic =", tool_df$N_Hispanic[1]))
```
\newpage

Sonoma
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "PSA", race != "All", sex == "All", county == "Sonoma") %>%
  select(race, risk_score, outcome, AUC, CI, n) %>%
  mutate(risk_score = case_when(risk_score == "psa_fta_risk_score" ~ "PSA FTA",
                                risk_score == "psa_nca_risk_score" ~ "PSA NCA",
                                risk_score == "psa_nvca_risk_score" ~ "PSA NVCA")) %>%
  mutate(outcome = case_when(outcome == "fta_flag" ~ "FTA",
                             outcome == "recid_arrested_flag" ~ "New Arrest",
                             outcome == "recid_filed_flag" ~ "New Filing",
                             outcome == "recid_convicted_flag" ~ "New Conviction",
                             outcome == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest",
                             outcome == "any_pretrial_failure_flag" ~ "FTA or New Arrest"))

names(tool_df) <- c("race", "Risk Score", "Outcome", "AUC", "CI (95%)", "N")

tool_df <- tool_df %>%
  pivot_wider(names_from = race, values_from = c(AUC, `CI (95%)`, N))

names(tool_df) <- gsub("AUC_|CI .*_", "", names(tool_df))

kable(tool_df[1:8], booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray",
                  font_size = 10, latex_options = "hold_position") %>%
  add_header_above(c(" " = 2, "AUC" = 3, "CI (95%)" = 3)) %>% 
  footnote(paste("N White =", tool_df$N_White[1], ", N Black =", 
                     tool_df$N_Black[1], ", N Hispanic =", tool_df$N_Hispanic[1]))
```
\newpage

Sonoma - White and Hispanic only
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "PSA", race != "All", race != "Black", sex == "All", county == "Sonoma") %>%
  select(race, risk_score, outcome, AUC, CI, n) %>%
  mutate(risk_score = case_when(risk_score == "psa_fta_risk_score" ~ "PSA FTA",
                                risk_score == "psa_nca_risk_score" ~ "PSA NCA",
                                risk_score == "psa_nvca_risk_score" ~ "PSA NVCA")) %>%
  mutate(outcome = case_when(outcome == "fta_flag" ~ "FTA",
                             outcome == "recid_arrested_flag" ~ "New Arrest",
                             outcome == "recid_filed_flag" ~ "New Filing",
                             outcome == "recid_convicted_flag" ~ "New Conviction",
                             outcome == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest",
                             outcome == "any_pretrial_failure_flag" ~ "FTA or New Arrest"))

names(tool_df) <- c("race", "Risk Score", "Outcome", "AUC", "CI (95%)", "N")

tool_df <- tool_df %>%
  pivot_wider(names_from = race, values_from = c(AUC, `CI (95%)`, N))

names(tool_df) <- gsub("AUC_|CI .*_", "", names(tool_df))

kable(tool_df[1:6], booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray",
                  font_size = 10, latex_options = "hold_position") %>%
  add_header_above(c(" " = 2, "AUC" = 2, "CI (95%)" = 2)) %>% 
  footnote(paste("N White =", tool_df$N_White[1],  ", N Hispanic =", tool_df$N_Hispanic[1]))
```
\newpage

Tulare 
\newline
```{r }
tool_df <- auc_df %>%
  filter(tool_name == "PSA", race != "All", sex == "All", county == "Tulare") %>%
  select(race, risk_score, outcome, AUC, CI, n) %>%
  mutate(risk_score = case_when(risk_score == "psa_fta_risk_score" ~ "PSA FTA",
                                risk_score == "psa_nca_risk_score" ~ "PSA NCA",
                                risk_score == "psa_nvca_risk_score" ~ "PSA NVCA")) %>%
  mutate(outcome = case_when(outcome == "fta_flag" ~ "FTA",
                             outcome == "recid_arrested_flag" ~ "New Arrest",
                             outcome == "recid_filed_flag" ~ "New Filing",
                             outcome == "recid_convicted_flag" ~ "New Conviction",
                             outcome == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest",
                             outcome == "any_pretrial_failure_flag" ~ "FTA or New Arrest"))

names(tool_df) <- c("race", "Risk Score", "Outcome", "AUC", "CI (95%)", "N")

tool_df <- tool_df %>%
  pivot_wider(names_from = race, values_from = c(AUC, `CI (95%)`, N))

names(tool_df) <- gsub("AUC_|CI .*_", "", names(tool_df))

kable(tool_df[1:8], booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray",
                  font_size = 10, latex_options = "hold_position") %>%
  add_header_above(c(" " = 2, "AUC" = 3, "CI (95%)" = 3)) %>% 
  footnote(paste("N White =", tool_df$N_White[1], ", N Black =", 
                     tool_df$N_Black[1], ", N Hispanic =", tool_df$N_Hispanic[1]))
```
\newpage

Tulare -- only White & Hispanic 
\newline
```{r }
tool_df <- auc_df %>%
  filter(tool_name == "PSA", race != "All", race != "Black", sex == "All", county == "Tulare") %>%
  select(race, risk_score, outcome, AUC, CI, n) %>%
  mutate(risk_score = case_when(risk_score == "psa_fta_risk_score" ~ "PSA FTA",
                                risk_score == "psa_nca_risk_score" ~ "PSA NCA",
                                risk_score == "psa_nvca_risk_score" ~ "PSA NVCA")) %>%
  mutate(outcome = case_when(outcome == "fta_flag" ~ "FTA",
                             outcome == "recid_arrested_flag" ~ "New Arrest",
                             outcome == "recid_filed_flag" ~ "New Filing",
                             outcome == "recid_convicted_flag" ~ "New Conviction",
                             outcome == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest",
                             outcome == "any_pretrial_failure_flag" ~ "FTA or New Arrest"))

names(tool_df) <- c("race", "Risk Score", "Outcome", "AUC", "CI (95%)", "N")

tool_df <- tool_df %>%
  pivot_wider(names_from = race, values_from = c(AUC, `CI (95%)`, N))

names(tool_df) <- gsub("AUC_|CI .*_", "", names(tool_df))

kable(tool_df[1:6], booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray",
                  font_size = 10, latex_options = "hold_position") %>%
  add_header_above(c(" " = 2, "AUC" = 2, "CI (95%)" = 2)) %>% 
  footnote(paste("N White =", tool_df$N_White[1],  ", N Hispanic =", tool_df$N_Hispanic[1]))
```
\newpage

Alameda
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "VPRAI-R", race != "All", sex == "All", county == "Alameda") %>%
  select(race, outcome, AUC, CI, n) %>%
  mutate(outcome = case_when(outcome == "fta_flag" ~ "FTA",
                             outcome == "recid_arrested_flag" ~ "New Arrest",
                             outcome == "recid_filed_flag" ~ "New Filing",
                             outcome == "recid_convicted_flag" ~ "New Conviction",
                             outcome == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest",
                             outcome == "any_pretrial_failure_flag" ~ "FTA or New Arrest"))

names(tool_df) <- c("race", "Outcome", "AUC", "CI (95%)", "N")

tool_df <- tool_df %>%
  pivot_wider(names_from = race, values_from = c(AUC, `CI (95%)`, N))

names(tool_df) <- gsub("AUC_|CI .*_", "", names(tool_df))

kable(tool_df[1:7], booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray",
                  font_size = 10, latex_options = "hold_position") %>%
  add_header_above(c(" " = 1, "AUC" = 3, "CI (95%)" = 3)) %>% 
  footnote(paste("N White =", tool_df$N_White[1], ", N Black =", 
                     tool_df$N_Black[1], ", N Hispanic =", tool_df$N_Hispanic[1]))
```
\newpage

Santa Barbara  - TEMPORARILY REMOVED
\newline
```{r eval=FALSE, include=FALSE}
tool_df <- auc_df %>%
  filter(tool_name == "VPRAI-R", race != "All", sex == "All", county == "Santa Barbara") %>%
  select(race, outcome, AUC, CI, n) %>%
  mutate(outcome = case_when(outcome == "fta_flag" ~ "FTA",
                             outcome == "recid_arrested_flag" ~ "New Arrest",
                             outcome == "recid_filed_flag" ~ "New Filing",
                             outcome == "recid_convicted_flag" ~ "New Conviction",
                             outcome == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest",
                             outcome == "any_pretrial_failure_flag" ~ "FTA or New Arrest"))

names(tool_df) <- c("race", "Outcome", "AUC", "CI (95%)", "N")

tool_df <- tool_df %>%
  pivot_wider(names_from = race, values_from = c(AUC, `CI (95%)`, N))

names(tool_df) <- gsub("AUC_|CI .*_", "", names(tool_df))

kable(tool_df[1:7], booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray",
                  font_size = 10, latex_options = "hold_position") %>%
  add_header_above(c(" " = 1, "AUC" = 3, "CI (95%)" = 3)) %>% 
  footnote(paste("N White =", tool_df$N_White[1], ", N Black =", 
                     tool_df$N_Black[1], ", N Hispanic =", tool_df$N_Hispanic[1]))
```
\newpage 

San Mateo
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "VPRAI-R", race != "All", sex == "All", county == "San Mateo") %>%
  select(race, outcome, AUC, CI, n) %>%
  mutate(outcome = case_when(outcome == "fta_flag" ~ "FTA",
                             outcome == "recid_arrested_flag" ~ "New Arrest",
                             outcome == "recid_filed_flag" ~ "New Filing",
                             outcome == "recid_convicted_flag" ~ "New Conviction",
                             outcome == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest",
                             outcome == "any_pretrial_failure_flag" ~ "FTA or New Arrest"))

names(tool_df) <- c("race", "Outcome", "AUC", "CI (95%)", "N")

tool_df <- tool_df %>%
  pivot_wider(names_from = race, values_from = c(AUC, `CI (95%)`, N))

names(tool_df) <- gsub("AUC_|CI .*_", "", names(tool_df))

kable(tool_df[1:7], booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray",
                  font_size = 10, latex_options = "hold_position") %>%
  add_header_above(c(" " = 1, "AUC" = 3, "CI (95%)" = 3)) %>% 
  footnote(paste("N White =", tool_df$N_White[1], ", N Black =", 
                     tool_df$N_Black[1], ", N Hispanic =", tool_df$N_Hispanic[1]))
```
\newpage


# Gender Table
```{r include=FALSE}
sex_df <- eval_df %>%
  mutate(sex = factor(sex, levels = c("Male", "Female"))) %>%
  filter(sex != "Other_Unknown")
```
# Gender Risk Distributions
ORAS
\newline
```{r}
risk_df <- sex_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "ORAS", !is.na(oras_risk_score)) %>%
  group_by(sex, oras_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing",
                                        "New Conviction", "New Violent Arrest")))
  
ggplot(risk_df %>% distinct(oras_risk_score, Total, sex) %>% 
         group_by(sex) %>% 
         mutate(percent = Total/sum(Total)) %>% ungroup()) +
  aes(x = as.factor(oras_risk_score), y = percent, fill = sex) +
  geom_col(position = "dodge") +
  geom_text(vjust = -.2, aes(label = str_c(round(percent*100), "%")), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +   scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(x = "Risk Category", y = "Percent", title = "Distribution of Assessments by ORAS Risk Category", fill = "Gender")

risk_df <- risk_df %>%
  distinct(sex, oras_risk_score, Total) %>%
  pivot_wider(names_from = sex, values_from = Total) %>%
  rename(`ORAS Risk Score` = oras_risk_score)

kable(risk_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position")
```
\newpage

VPRAI
\newline
```{r}
risk_df <- sex_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "VPRAI", !is.na(vprai_risk_score)) %>%
  group_by(sex, vprai_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

ggplot(risk_df %>% distinct(vprai_risk_score, Total) %>% 
         group_by(sex) %>% 
         mutate(percent = Total/sum(Total)) %>% ungroup()) +
  aes(x = as.factor(vprai_risk_score), y = percent, fill = sex) +
  geom_col(position = "dodge") +
  geom_text(vjust = -.2, aes(label = str_c(round(percent*100), "%")), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +   scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(x = "Risk Category", y = "Percent", title = "Distribution of Assessments by VPRAI Risk Category", fill = "Gender")    

risk_df <- risk_df %>%
  distinct(sex, vprai_risk_score, Total) %>%
  pivot_wider(names_from = sex, values_from = Total) %>%
  rename(`VPRAI Risk Score` = vprai_risk_score)

kable(risk_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position")
```
\newpage

VPRAI-R
\newline
```{r}
risk_df <- sex_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "VPRAI-R", !is.na(vprair_risk_score)) %>%
  group_by(sex, vprair_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))
  
ggplot(risk_df %>% distinct(vprair_risk_score, Total) %>% 
         group_by(sex) %>% 
         mutate(percent = Total/sum(Total)) %>% ungroup()) +
  aes(x = as.factor(vprair_risk_score), y = percent, fill = sex) +
  geom_col(position = "dodge") +
  geom_text(vjust = -.2, aes(label = str_c(round(percent*100), "%")), size = 2.6, position = position_dodge(width = .9)) +
  labs(x = "Risk Category", y = "Percent", title = "Distribution of Assessments by VPRAIR Risk Category", fill = "Gender") +
  theme_bw() +   
  scale_y_continuous(labels = scales::percent_format(accuracy = 1))

risk_df <- risk_df %>%
  distinct(sex, vprair_risk_score, Total) %>%
  pivot_wider(names_from = sex, values_from = Total) %>%
  rename(`VPRAIR Risk Score` = vprair_risk_score)

kable(risk_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position")
```
\newpage

PSA
\newline
```{r fig.height=7}

risk_df <- sex_df %>%
  filter(tool_name == "PSA") %>%
  group_by(sex, psa_fta_risk_score) %>%
  summarise(across(c(fta_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag) 

names(risk_df)[2] <- "psa_risk_score"

risk_df2 <- sex_df %>%
  filter(tool_name == "PSA") %>%
  group_by(sex, psa_nca_risk_score) %>%
  summarise(across(c(recid_arrested_flag, recid_filed_flag, recid_convicted_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[2] <- "psa_risk_score"

risk_df3 <- sex_df %>%
  filter(tool_name == "PSA", !is.na(psa_nvca_risk_score)) %>%
  group_by(sex, psa_nvca_risk_score) %>%
  summarise(across(c(recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[2] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

risk_df <- risk_df %>%
  mutate(psa_risk_score = case_when(name == "New Violent Arrest" & psa_risk_score == 0 ~ "No flag",
                   name == "New Violent Arrest" & psa_risk_score == 1 ~ "Flag",
                   T ~ as.character(psa_risk_score))) %>%
  mutate(psa_risk_score = ordered(psa_risk_score, c("1", "2", "3", "4", "5", "6", "No flag", "Flag")))

ggplot(risk_df %>%
         filter(!name %in% c("New Filing", "New Conviction")) %>%
         mutate(name = case_when(name == "FTA" ~ "PSA FTA Risk Score",
                                 name == "New Arrest" ~ "PSA NCA Risk Score",
                                 name == "New Violent Arrest" ~ "PSA NVCA Risk Score")) %>% 
         group_by(sex, name) %>% 
         mutate(percent = Total/sum(Total)) %>% ungroup()) +
  aes(x = as.factor(psa_risk_score), y = percent, fill = sex) +
  geom_col(position = "dodge") +
  geom_text(vjust = -.2, aes(label = str_c(round(percent*100), "%")), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +   
  #scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  facet_wrap(~name, scales = "free", ncol = 1) +
  labs(x = "Risk Category", y = "Percent", title = "Distribution of Assessments by PSA Risk Category", fill = "Gender") +
  scale_y_continuous(expand = expansion(mult = c(.1, .25)), labels = scales::percent_format(accuracy = 1)) 

fta_df <- risk_df %>%
  filter(name == "FTA") %>%
  distinct(sex, psa_risk_score, Total) %>%
  pivot_wider(names_from = sex, values_from = Total) %>%
  rename(`PSA FTA Risk Score` = psa_risk_score)

kable(fta_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

nca_df <- risk_df %>%
  filter(name == "New Arrest") %>%
  distinct(sex, psa_risk_score, Total) %>%
  pivot_wider(names_from = sex, values_from = Total) %>%
  rename(`PSA NCA Risk Score` = psa_risk_score)

kable(nca_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

nvca_df <- risk_df %>%
  filter(name == "New Violent Arrest") %>%
  distinct(sex, psa_risk_score, Total) %>%
  pivot_wider(names_from = sex, values_from = Total) %>%
  rename(`PSA NVCA Risk Score` = psa_risk_score)

kable(nvca_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 


```
\newpage

Alameda
\newline
```{r}
risk_df <- sex_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "VPRAI-R", !is.na(vprair_risk_score), county == "Alameda") %>%
  group_by(sex, vprair_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

ggplot(risk_df %>% distinct(vprair_risk_score, Total) %>% 
         group_by(sex) %>% 
         mutate(percent = Total/sum(Total)) %>% ungroup()) +
  aes(x = as.factor(vprair_risk_score), y = percent, fill = sex) +
  geom_col(position = "dodge") +
  geom_text(vjust = -.2, aes(label = str_c(round(percent*100), "%")), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +   scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(x = "Risk Category", y = "Percent", title = "Alameda Distribution of Assessments by VPRAI-R Risk Category", fill = "Gender")  

risk_df <- risk_df %>%
  distinct(sex, vprair_risk_score, Total) %>%
  pivot_wider(names_from = sex, values_from = Total) %>%
  rename(`VPRAIR Risk Score` = vprair_risk_score)

kable(risk_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position")
```
\newpage

Los Angeles
\newline
```{r fig.height=7}
risk_df <- sex_df %>%
  filter(tool_name == "PSA", county == "Los Angeles", !is.na(psa_fta_risk_score)) %>%
  group_by(sex, psa_fta_risk_score) %>%
  summarise(across(c(fta_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag) 

names(risk_df)[2] <- "psa_risk_score"

risk_df2 <- sex_df %>%
  filter(tool_name == "PSA", county == "Los Angeles", !is.na(psa_nca_risk_score)) %>%
  group_by(sex, psa_nca_risk_score) %>%
  summarise(across(c(recid_arrested_flag, recid_filed_flag, recid_convicted_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[2] <- "psa_risk_score"

risk_df3 <- sex_df %>%
  filter(tool_name == "PSA", !is.na(psa_nvca_risk_score), county == "Los Angeles") %>%
  group_by(sex, psa_nvca_risk_score) %>%
  summarise(across(c(recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[2] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

risk_df <- risk_df %>%
  mutate(psa_risk_score = case_when(name == "New Violent Arrest" & psa_risk_score == 0 ~ "No flag",
                   name == "New Violent Arrest" & psa_risk_score == 1 ~ "Flag",
                   T ~ as.character(psa_risk_score))) %>%
  mutate(psa_risk_score = ordered(psa_risk_score, c("1", "2", "3", "4", "5", "6", "No flag", "Flag")))

ggplot(risk_df %>%
         filter(!name %in% c("New Filing", "New Conviction")) %>%
         mutate(name = case_when(name == "FTA" ~ "PSA FTA Risk Score",
                                 name == "New Arrest" ~ "PSA NCA Risk Score",
                                 name == "New Violent Arrest" ~ "PSA NVCA Risk Score")) %>% 
         group_by(sex, name) %>% 
         mutate(percent = Total/sum(Total)) %>% ungroup()) +
  aes(x = as.factor(psa_risk_score), y = percent, fill = sex) +
  geom_col(position = "dodge") +
  geom_text(vjust = -.2, aes(label = str_c(round(percent*100), "%")), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +   
  # ylim(0,100) +
  facet_wrap(~name, scales = "free", ncol = 1) +
  labs(x = "Risk Category", y = "Percent", title = "Los Angeles Distribution of Assessments by PSA Risk Category", fill = "Gender") +
  scale_y_continuous(expand = expansion(mult = c(.1, .25)), labels = scales::percent_format(accuracy = 1)) 

fta_df <- risk_df %>%
  filter(name == "FTA") %>%
  distinct(sex, psa_risk_score, Total) %>%
  pivot_wider(names_from = sex, values_from = Total) %>%
  rename(`PSA FTA Risk Score` = psa_risk_score)

kable(fta_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

nca_df <- risk_df %>%
  filter(name == "New Arrest") %>%
  distinct(sex, psa_risk_score, Total) %>%
  pivot_wider(names_from = sex, values_from = Total) %>%
  rename(`PSA NCA Risk Score` = psa_risk_score)

kable(nca_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

nvca_df <- risk_df %>%
  filter(name == "New Violent Arrest") %>%
  distinct(sex, psa_risk_score, Total) %>%
  pivot_wider(names_from = sex, values_from = Total) %>%
  rename(`PSA NVCA Risk Score` = psa_risk_score)

kable(nvca_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

```
\newpage

San Mateo
\newline
```{r}
risk_df <- sex_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "VPRAI-R", !is.na(vprair_risk_score), county == "San Mateo") %>%
  group_by(sex, vprair_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

ggplot(risk_df %>% distinct(vprair_risk_score, Total) %>% 
         group_by(sex) %>% 
         mutate(percent = Total/sum(Total)) %>% ungroup()) +
  aes(x = as.factor(vprair_risk_score), y = percent, fill = sex) +
  geom_col(position = "dodge") +
  geom_text(vjust = -.2, aes(label = str_c(round(percent*100), "%")), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +   scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(x = "Risk Category", y = "Percent", title = "San Mateo Distribution of Assessments by VPRAI-R Risk Category", fill = "Gender")  

risk_df <- risk_df %>%
  distinct(sex, vprair_risk_score, Total) %>%
  pivot_wider(names_from = sex, values_from = Total) %>%
  rename(`VPRAIR Risk Score` = vprair_risk_score)

kable(risk_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position")
```
\newpage

Sacramento
\newline
```{r fig.height=7}
risk_df <- sex_df %>%
  filter(tool_name == "PSA", county == "Sacramento") %>%
  group_by(sex, psa_fta_risk_score) %>%
  summarise(across(c(fta_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag) 

names(risk_df)[2] <- "psa_risk_score"

risk_df2 <- sex_df %>%
  filter(tool_name == "PSA", county == "Sacramento") %>%
  group_by(sex, psa_nca_risk_score) %>%
  summarise(across(c(recid_arrested_flag, recid_filed_flag, recid_convicted_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[2] <- "psa_risk_score"

risk_df3 <- sex_df %>%
  filter(tool_name == "PSA", !is.na(psa_nvca_risk_score), county == "Sacramento") %>%
  group_by(sex, psa_nvca_risk_score) %>%
  summarise(across(c(recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[2] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

risk_df <- risk_df %>%
  mutate(psa_risk_score = case_when(name == "New Violent Arrest" & psa_risk_score == 0 ~ "No flag",
                   name == "New Violent Arrest" & psa_risk_score == 1 ~ "Flag",
                   T ~ as.character(psa_risk_score))) %>%
  mutate(psa_risk_score = ordered(psa_risk_score, c("1", "2", "3", "4", "5", "6", "No flag", "Flag")))

ggplot(risk_df %>%
         filter(!name %in% c("New Filing", "New Conviction")) %>%
         mutate(name = case_when(name == "FTA" ~ "PSA FTA Risk Score",
                                 name == "New Arrest" ~ "PSA NCA Risk Score",
                                 name == "New Violent Arrest" ~ "PSA NVCA Risk Score")) %>% 
         group_by(sex, name) %>% 
         mutate(percent = Total/sum(Total)) %>% ungroup()) +
  aes(x = as.factor(psa_risk_score), y = percent, fill = sex) +
  geom_col(position = "dodge") +
  geom_text(vjust = -.2, aes(label = str_c(round(percent*100), "%")), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +  
  facet_wrap(~name, scales = "free", ncol = 1) +
  labs(x = "Risk Category", y = "Percent", title = "Sacramento Distribution of Assessments by PSA Risk Category", fill = "Gender") +
  scale_y_continuous(expand = expansion(mult = c(.1, .25)), labels = scales::percent_format(accuracy = 1)) 

fta_df <- risk_df %>%
  filter(name == "FTA") %>%
  distinct(sex, psa_risk_score, Total) %>%
  pivot_wider(names_from = sex, values_from = Total) %>%
  rename(`PSA FTA Risk Score` = psa_risk_score)

kable(fta_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

nca_df <- risk_df %>%
  filter(name == "New Arrest") %>%
  distinct(sex, psa_risk_score, Total) %>%
  pivot_wider(names_from = sex, values_from = Total) %>%
  rename(`PSA NCA Risk Score` = psa_risk_score)

kable(nca_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

nvca_df <- risk_df %>%
  filter(name == "New Violent Arrest") %>%
  distinct(sex, psa_risk_score, Total) %>%
  pivot_wider(names_from = sex, values_from = Total) %>%
  rename(`PSA NVCA Risk Score` = psa_risk_score)

kable(nvca_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

```
\newpage

San Joaquin 
\newline
```{r}
risk_df <- sex_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "VPRAI", !is.na(vprai_risk_score), county == "San Joaquin") %>%
  group_by(sex, vprai_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

ggplot(risk_df %>% distinct(vprai_risk_score, Total) %>% 
         group_by(sex) %>% 
         mutate(percent = Total/sum(Total)) %>% ungroup()) +
  aes(x = as.factor(vprai_risk_score), y = percent, fill = sex) +
  geom_col(position = "dodge") +
  geom_text(vjust = -.2, aes(label = str_c(round(percent*100), "%")), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +   scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(x = "Risk Category", y = "Percent", title = "San Joaquin Distribution of Assessments by VPRAI Risk Category", fill = "Gender")    

risk_df <- risk_df %>%
  distinct(sex, vprai_risk_score, Total) %>%
  pivot_wider(names_from = sex, values_from = Total) %>%
  rename(`VPRAI Risk Score` = vprai_risk_score)

kable(risk_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position")
```
\newpage

Santa Barbara - TEMPORARILY REMOVED
\newline
```{r eval=FALSE, include=FALSE}
risk_df <- sex_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "VPRAI-R", !is.na(vprair_risk_score), county == "Santa Barbara") %>%
  group_by(sex, vprair_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

ggplot(risk_df %>% distinct(vprair_risk_score, Total) %>% 
         group_by(sex) %>% 
         mutate(percent = Total/sum(Total)) %>% ungroup()) +
  aes(x = as.factor(vprair_risk_score), y = percent, fill = sex) +
  geom_col(position = "dodge") +
  geom_text(vjust = -.2, aes(label = str_c(round(percent*100), "%")), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +   scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(x = "Risk Category", y = "Percent", title = "Santa Barbara Distribution of Assessments by VPRAIR Risk Category", fill = "Gender")  

risk_df <- risk_df %>%
  distinct(sex, vprair_risk_score, Total) %>%
  pivot_wider(names_from = sex, values_from = Total) %>%
  rename(`VPRAIR Risk Score` = vprair_risk_score)

kable(risk_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position")
```
\newpage

Sonoma
\newline
```{r fig.height=7}
risk_df <- sex_df %>%
  filter(tool_name == "PSA", county == "Sonoma") %>%
  group_by(sex, psa_fta_risk_score) %>%
  summarise(across(c(fta_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag) 

names(risk_df)[2] <- "psa_risk_score"

risk_df2 <- sex_df %>%
  filter(tool_name == "PSA", county == "Sonoma") %>%
  group_by(sex, psa_nca_risk_score) %>%
  summarise(across(c(recid_arrested_flag, recid_filed_flag, recid_convicted_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[2] <- "psa_risk_score"

risk_df3 <- sex_df %>%
  filter(tool_name == "PSA", !is.na(psa_nvca_risk_score), county == "Sonoma") %>%
  group_by(sex, psa_nvca_risk_score) %>%
  summarise(across(c(recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[2] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

risk_df <- risk_df %>%
  mutate(psa_risk_score = case_when(name == "New Violent Arrest" & psa_risk_score == 0 ~ "No flag",
                   name == "New Violent Arrest" & psa_risk_score == 1 ~ "Flag",
                   T ~ as.character(psa_risk_score))) %>%
  mutate(psa_risk_score = ordered(psa_risk_score, c("1", "2", "3", "4", "5", "6", "No flag", "Flag")))

ggplot(risk_df %>%
         filter(!name %in% c("New Filing", "New Conviction")) %>%
         mutate(name = case_when(name == "FTA" ~ "PSA FTA Risk Score",
                                 name == "New Arrest" ~ "PSA NCA Risk Score",
                                 name == "New Violent Arrest" ~ "PSA NVCA Risk Score")) %>% 
         group_by(sex, name) %>% 
         mutate(percent = Total/sum(Total)) %>% ungroup()) +
  aes(x = as.factor(psa_risk_score), y = percent, fill = sex) +
  geom_col(position = "dodge") +
  geom_text(vjust = -.2, aes(label = str_c(round(percent*100), "%")), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +  
  # ylim(0,100) +
  facet_wrap(~name, scales = "free", ncol = 1) +
  labs(x = "Risk Category", y = "Percent", title = "Sonoma Distribution of Assessments by PSA Risk Category", fill = "Gender") +
  scale_y_continuous(expand = expansion(mult = c(.1, .25)), labels = scales::percent_format(accuracy = 1))  

fta_df <- risk_df %>%
  filter(name == "FTA") %>%
  distinct(sex, psa_risk_score, Total) %>%
  pivot_wider(names_from = sex, values_from = Total) %>%
  rename(`PSA FTA Risk Score` = psa_risk_score)

kable(fta_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

nca_df <- risk_df %>%
  filter(name == "New Arrest") %>%
  distinct(sex, psa_risk_score, Total) %>%
  pivot_wider(names_from = sex, values_from = Total) %>%
  rename(`PSA NCA Risk Score` = psa_risk_score)

kable(nca_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

nvca_df <- risk_df %>%
  filter(name == "New Violent Arrest") %>%
  distinct(sex, psa_risk_score, Total) %>%
  pivot_wider(names_from = sex, values_from = Total) %>%
  rename(`PSA NVCA Risk Score` = psa_risk_score)

kable(nvca_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

```
\newpage

Ventura
\newline
```{r}
risk_df <- sex_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "ORAS", !is.na(oras_risk_score), county == "Ventura") %>%
  group_by(sex, oras_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing",
                                        "New Conviction", "New Violent Arrest")))
  
ggplot(risk_df %>% distinct(oras_risk_score, Total) %>% 
         group_by(sex) %>% 
         mutate(percent = Total/sum(Total)) %>% ungroup()) +
  aes(x = as.factor(oras_risk_score), y = percent, fill = sex) +
  geom_col(position = "dodge") +
  geom_text(vjust = -.2, aes(label = str_c(round(percent*100), "%")), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +   scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(x = "Risk Category", y = "Percent", title = "Ventura Distribution of Assessments by ORAS Risk Category", fill = "Gender") 

risk_df <- risk_df %>%
  distinct(sex, oras_risk_score, Total) %>%
  pivot_wider(names_from = sex, values_from = Total) %>%
  rename(`ORAS Risk Score` = oras_risk_score)

kable(risk_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position")
```

Modoc
\newline
```{r}
risk_df <- sex_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "ORAS", !is.na(oras_risk_score), county == "Modoc") %>%
  group_by(sex, oras_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing",
                                        "New Conviction", "New Violent Arrest")))
  
ggplot(risk_df %>% distinct(oras_risk_score, Total) %>% 
         group_by(sex) %>% 
         mutate(percent = Total/sum(Total)) %>% ungroup()) +
  aes(x = as.factor(oras_risk_score), y = percent, fill = sex) +
  geom_col(position = "dodge") +
  geom_text(vjust = -.2, aes(label = str_c(round(percent*100), "%")), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +   scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(x = "Risk Category", y = "Percent", title = "Modoc Distribution of Assessments by ORAS Risk Category", fill = "Gender") 

risk_df <- risk_df %>%
  distinct(sex, oras_risk_score, Total) %>%
  pivot_wider(names_from = sex, values_from = Total) %>%
  rename(`ORAS Risk Score` = oras_risk_score)

kable(risk_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position")
```
\newpage

Napa
\newline
```{r}
risk_df <- sex_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "ORAS", !is.na(oras_risk_score), county == "Napa") %>%
  group_by(sex, oras_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing",
                                        "New Conviction", "New Violent Arrest")))
  
ggplot(risk_df %>% distinct(oras_risk_score, Total) %>% 
         group_by(sex) %>% 
         mutate(percent = Total/sum(Total)) %>% ungroup()) +
  aes(x = as.factor(oras_risk_score), y = percent, fill = sex) +
  geom_col(position = "dodge") +
  geom_text(vjust = -.2, aes(label = str_c(round(percent*100), "%")), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +   scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(x = "Risk Category", y = "Percent", title = "Napa Distribution of Assessments by ORAS Risk Category", fill = "Gender") 

risk_df <- risk_df %>%
  distinct(sex, oras_risk_score, Total) %>%
  pivot_wider(names_from = sex, values_from = Total) %>%
  rename(`ORAS Risk Score` = oras_risk_score)

kable(risk_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position")
```

Calaveras
\newline
```{r fig.height=7}
risk_df <- sex_df %>%
  filter(tool_name == "PSA", county == "Calaveras") %>%
  group_by(sex, psa_fta_risk_score) %>%
  summarise(across(c(fta_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag) 

names(risk_df)[2] <- "psa_risk_score"

risk_df2 <- sex_df %>%
  filter(tool_name == "PSA", county == "Calaveras") %>%
  group_by(sex, psa_nca_risk_score) %>%
  summarise(across(c(recid_arrested_flag, recid_filed_flag, recid_convicted_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[2] <- "psa_risk_score"

risk_df3 <- sex_df %>%
  filter(tool_name == "PSA", !is.na(psa_nvca_risk_score), county == "Calaveras") %>%
  group_by(sex, psa_nvca_risk_score) %>%
  summarise(across(c(recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[2] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

risk_df <- risk_df %>%
  mutate(psa_risk_score = case_when(name == "New Violent Arrest" & psa_risk_score == 0 ~ "No flag",
                   name == "New Violent Arrest" & psa_risk_score == 1 ~ "Flag",
                   T ~ as.character(psa_risk_score))) %>%
  mutate(psa_risk_score = ordered(psa_risk_score, c("1", "2", "3", "4", "5", "6", "No flag", "Flag")))

ggplot(risk_df %>%
         filter(!name %in% c("New Filing", "New Conviction")) %>%
         mutate(name = case_when(name == "FTA" ~ "PSA FTA Risk Score",
                                 name == "New Arrest" ~ "PSA NCA Risk Score",
                                 name == "New Violent Arrest" ~ "PSA NVCA Risk Score")) %>% 
         group_by(sex, name) %>% 
         mutate(percent = Total/sum(Total)) %>% ungroup()) +
  aes(x = as.factor(psa_risk_score), y = percent, fill = sex) +
  geom_col(position = "dodge") +
  geom_text(vjust = -.2, aes(label = str_c(round(percent*100), "%")), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +  
  # ylim(0,100) +
  facet_wrap(~name, scales = "free", ncol = 1) +
  labs(x = "Risk Category", y = "Percent", title = "Calaveras Distribution of Assessments by PSA Risk Category", fill = "Gender") +
  scale_y_continuous(expand = expansion(mult = c(.1, .25)), labels = scales::percent_format(accuracy = 1))  

fta_df <- risk_df %>%
  filter(name == "FTA") %>%
  distinct(sex, psa_risk_score, Total) %>%
  pivot_wider(names_from = sex, values_from = Total) %>%
  rename(`PSA FTA Risk Score` = psa_risk_score)

kable(fta_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

nca_df <- risk_df %>%
  filter(name == "New Arrest") %>%
  distinct(sex, psa_risk_score, Total) %>%
  pivot_wider(names_from = sex, values_from = Total) %>%
  rename(`PSA NCA Risk Score` = psa_risk_score)

kable(nca_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

nvca_df <- risk_df %>%
  filter(name == "New Violent Arrest") %>%
  distinct(sex, psa_risk_score, Total) %>%
  pivot_wider(names_from = sex, values_from = Total) %>%
  rename(`PSA NVCA Risk Score` = psa_risk_score)

kable(nvca_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

```
\newpage

Tulare
\newline
```{r fig.height=7}
risk_df <- sex_df %>%
  filter(tool_name == "PSA", county == "Tulare") %>%
  group_by(sex, psa_fta_risk_score) %>%
  summarise(across(c(fta_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag) 

names(risk_df)[2] <- "psa_risk_score"

risk_df2 <- sex_df %>%
  filter(tool_name == "PSA", county == "Tulare") %>%
  group_by(sex, psa_nca_risk_score) %>%
  summarise(across(c(recid_arrested_flag, recid_filed_flag, recid_convicted_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[2] <- "psa_risk_score"

risk_df3 <- sex_df %>%
  filter(tool_name == "PSA", !is.na(psa_nvca_risk_score), county == "Tulare") %>%
  group_by(sex, psa_nvca_risk_score) %>%
  summarise(across(c(recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[2] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

risk_df <- risk_df %>%
  mutate(psa_risk_score = case_when(name == "New Violent Arrest" & psa_risk_score == 0 ~ "No flag",
                   name == "New Violent Arrest" & psa_risk_score == 1 ~ "Flag",
                   T ~ as.character(psa_risk_score))) %>%
  mutate(psa_risk_score = ordered(psa_risk_score, c("1", "2", "3", "4", "5", "6", "No flag", "Flag")))

ggplot(risk_df %>%
         filter(!name %in% c("New Filing", "New Conviction")) %>%
         mutate(name = case_when(name == "FTA" ~ "PSA FTA Risk Score",
                                 name == "New Arrest" ~ "PSA NCA Risk Score",
                                 name == "New Violent Arrest" ~ "PSA NVCA Risk Score")) %>% 
         group_by(sex, name) %>% 
         mutate(percent = Total/sum(Total)) %>% ungroup()) +
  aes(x = as.factor(psa_risk_score), y = percent, fill = sex) +
  geom_col(position = "dodge") +
  geom_text(vjust = -.2, aes(label = str_c(round(percent*100), "%")), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +  
  # ylim(0,100) +
  facet_wrap(~name, scales = "free", ncol = 1) +
  labs(x = "Risk Category", y = "Percent", title = "Tulare Distribution of Assessments by PSA Risk Category", fill = "Gender") +
  scale_y_continuous(expand = expansion(mult = c(.1, .25)), labels = scales::percent_format(accuracy = 1))  

fta_df <- risk_df %>%
  filter(name == "FTA") %>%
  distinct(sex, psa_risk_score, Total) %>%
  pivot_wider(names_from = sex, values_from = Total) %>%
  rename(`PSA FTA Risk Score` = psa_risk_score)

kable(fta_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

nca_df <- risk_df %>%
  filter(name == "New Arrest") %>%
  distinct(sex, psa_risk_score, Total) %>%
  pivot_wider(names_from = sex, values_from = Total) %>%
  rename(`PSA NCA Risk Score` = psa_risk_score)

kable(nca_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

nvca_df <- risk_df %>%
  filter(name == "New Violent Arrest") %>%
  distinct(sex, psa_risk_score, Total) %>%
  pivot_wider(names_from = sex, values_from = Total) %>%
  rename(`PSA NVCA Risk Score` = psa_risk_score)

kable(nvca_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") 

```
\newpage

# Gender Logistic Regression Graphs

VPRAI
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  mutate(sex = factor(sex, levels = c("Male", "Female"))) %>%
  filter(tool_name == "VPRAI", !is.na(vprai_risk_score)) %>%
  group_by(vprai_risk_score, sex) %>%
  select(vprai_risk_score, sex, fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag,
         any_pretrial_failure_flag, recid_arrest_violent_psa_flag) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) %>%
  filter(sex %in% c("Male", "Female")) 
  # filter(county %in% c("Los Angeles", "Sacramento"))

ggplot(risk_df) +
  aes(x = vprai_risk_score, y = value, color = sex) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent", title = "Comparison of Gender Differences in Logistic Regression Curves--VPRAI") +
  scale_x_continuous(breaks = 1:5)

# eval_df %>%
#   filter(tool_name == "VPRAI") %>%
#   count(county)
```
\newpage


VPRAI-R
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  mutate(sex = factor(sex, levels = c("Male", "Female"))) %>%
  filter(tool_name == "VPRAI-R", !is.na(vprair_risk_score)) %>%
  group_by(vprair_risk_score, sex) %>%
  select(vprair_risk_score, sex, fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag,
         any_pretrial_failure_flag, recid_arrest_violent_psa_flag) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) %>%
  filter(sex %in% c("Male", "Female")) 
  # filter(county %in% c("Los Angeles", "Sacramento"))

ggplot(risk_df) +
  aes(x = vprair_risk_score, y = value, color = sex) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent", title = "Comparison of Gender Differences in Logistic Regression Curves--VPRAI-R") +
  scale_x_continuous(breaks = 1:5)

# eval_df %>%
#   filter(tool_name == "VPRAI-R") %>%
#   count(county)
```
\newpage

ORAS
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  mutate(sex = factor(sex, levels = c("Male", "Female"))) %>%
  filter(tool_name == "ORAS", !is.na(oras_risk_score)) %>%
  group_by(oras_risk_score, sex) %>%
  select(oras_risk_score, sex, fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag,
         any_pretrial_failure_flag, recid_arrest_violent_psa_flag) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) %>%
  filter(sex %in% c("Male", "Female")) 
  # filter(county %in% c("Los Angeles", "Sacramento"))

ggplot(risk_df) +
  aes(x = oras_risk_score, y = value, color = sex) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent", title = "Comparison of Gender Differences in Logistic Regression Curves--ORAS") +
  scale_x_continuous(breaks = 0:9)


```
\newpage


PSA
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  filter(tool_name == "PSA") %>%
  group_by(psa_fta_risk_score, sex, county) %>%
  select(fta_flag) %>%
  pivot_longer(fta_flag) 

names(risk_df)[1] <- "psa_risk_score"

risk_df2 <- eval_df %>%
  filter(tool_name == "PSA") %>%
  group_by(psa_nca_risk_score, sex, county) %>%
  select(recid_arrested_flag, recid_filed_flag, recid_convicted_flag) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[1] <- "psa_risk_score"

risk_df3 <- eval_df %>%
  filter(tool_name == "PSA", !is.na(psa_nvca_risk_score)) %>%
  group_by(psa_nvca_risk_score, sex, county) %>%
  select(recid_arrest_violent_psa_flag) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[1] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(sex = factor(sex, levels = c("Male", "Female"))) %>%
  filter(sex %in% c("Male", "Female")) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) %>%
  filter(county %in% c("Los Angeles", "Sacramento"))

ggplot(risk_df) +
  aes(x = psa_risk_score, y = value, color = sex) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  # facet_grid(county~name, scales = "free") +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent", title = "Comparison of Gender Differences in Logistic Regression Curves--PSA") +
  scale_x_continuous(breaks = 1:6)

# eval_df %>%
#   filter(tool_name == "PSA") %>%
#   count(county)
```
\newpage

San Joaquin  
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  filter(county == "San Joaquin") %>%
  mutate(sex = factor(sex, levels = c("Male", "Female"))) %>%
  filter(tool_name == "VPRAI", !is.na(vprai_risk_score)) %>%
  group_by(vprai_risk_score, sex) %>%
  select(vprai_risk_score, sex, fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag,
         any_pretrial_failure_flag, recid_arrest_violent_psa_flag) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) %>%
  filter(sex %in% c("Male", "Female")) 

ggplot(risk_df) +
  aes(x = vprai_risk_score, y = value, color = sex) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent",
       title = "Comparison of Gender Differences in Logistic Regression Curves--VPRAI, San Joaquin") +
  scale_x_continuous(breaks = 1:5)

# eval_df %>%
#   filter(tool_name == "VPRAI") %>%
#   count(county)
```
\newpage

Los Angeles
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  filter(county == "Los Angeles") %>%
  filter(tool_name == "PSA") %>%
  group_by(psa_fta_risk_score, sex, county) %>%
  select(fta_flag) %>%
  pivot_longer(fta_flag) 

names(risk_df)[1] <- "psa_risk_score"

risk_df2 <- eval_df %>%
  filter(county == "Los Angeles") %>%
  filter(tool_name == "PSA") %>%
  group_by(psa_nca_risk_score, sex, county) %>%
  select(recid_arrested_flag, recid_filed_flag, recid_convicted_flag) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[1] <- "psa_risk_score"

risk_df3 <- eval_df %>%
  filter(county == "Los Angeles") %>%
  filter(tool_name == "PSA", !is.na(psa_nvca_risk_score)) %>%
  group_by(psa_nvca_risk_score, sex, county) %>%
  select(recid_arrest_violent_psa_flag) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[1] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(sex = factor(sex, levels = c("Male", "Female"))) %>%
  filter(sex %in% c("Male", "Female")) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) %>%
  filter(county %in% c("Los Angeles"))

ggplot(risk_df) +
  aes(x = psa_risk_score, y = value, color = sex) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent", 
       title = "Comparison of Gender Differences in Logistic Regression Curves--PSA, Los Angeles") +
  scale_x_continuous(breaks = 1:6)
```
\newpage

Sacramento
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  filter(county == "Sacramento") %>%
  filter(tool_name == "PSA") %>%
  group_by(psa_fta_risk_score, sex, county) %>%
  select(fta_flag) %>%
  pivot_longer(fta_flag) 

names(risk_df)[1] <- "psa_risk_score"

risk_df2 <- eval_df %>%
  filter(county == "Sacramento") %>%
  filter(tool_name == "PSA") %>%
  group_by(psa_nca_risk_score, sex, county) %>%
  select(recid_arrested_flag, recid_filed_flag, recid_convicted_flag) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[1] <- "psa_risk_score"

risk_df3 <- eval_df %>%
  filter(county == "Sacramento") %>%
  filter(tool_name == "PSA", !is.na(psa_nvca_risk_score)) %>%
  group_by(psa_nvca_risk_score, sex, county) %>%
  select(recid_arrest_violent_psa_flag) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[1] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(sex = factor(sex, levels = c("Male", "Female"))) %>%
  filter(sex %in% c("Male", "Female")) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) %>%
  filter(county %in% c("Sacramento"))

ggplot(risk_df) +
  aes(x = psa_risk_score, y = value, color = sex) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent", 
       title = "Comparison of Racial Differences in Logistic Regression Curves--PSA, Sacramento") +
  scale_x_continuous(breaks = 1:6)

# eval_df %>%
#   filter(tool_name == "PSA") %>%
#   count(county)
```
\newpage

Ventura
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  mutate(sex = factor(sex, levels = c("Male", "Female"))) %>%
  filter(tool_name == "ORAS", !is.na(oras_risk_score), county == "Ventura") %>%
  group_by(oras_risk_score, sex) %>%
  select(oras_risk_score, sex, fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag,
         any_pretrial_failure_flag, recid_arrest_violent_psa_flag) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) %>%
  filter(sex %in% c("Male", "Female")) 
  # filter(county %in% c("Los Angeles", "Sacramento"))

ggplot(risk_df) +
  aes(x = oras_risk_score, y = value, color = sex) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent", title = "Comparison of Gender Differences in Logistic Regression Curves--ORAS, Ventura") +
  scale_x_continuous(breaks = 0:9)


```
\newpage

Sonoma
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  filter(county == "Sonoma") %>%
  filter(tool_name == "PSA") %>%
  group_by(psa_fta_risk_score, sex, county) %>%
  select(fta_flag) %>%
  pivot_longer(fta_flag) 

names(risk_df)[1] <- "psa_risk_score"

risk_df2 <- eval_df %>%
  filter(county == "Sonoma") %>%
  filter(tool_name == "PSA") %>%
  group_by(psa_nca_risk_score, sex, county) %>%
  select(recid_arrested_flag, recid_filed_flag, recid_convicted_flag) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[1] <- "psa_risk_score"

risk_df3 <- eval_df %>%
  filter(county == "Sonoma") %>%
  filter(tool_name == "PSA", !is.na(psa_nvca_risk_score)) %>%
  group_by(psa_nvca_risk_score, sex, county) %>%
  select(recid_arrest_violent_psa_flag) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[1] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(sex = factor(sex, levels = c("Male", "Female"))) %>%
  filter(sex %in% c("Male", "Female")) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) %>%
  filter(county %in% c("Sonoma"))

ggplot(risk_df) +
  aes(x = psa_risk_score, y = value, color = sex) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent", 
       title = "Comparison of Gender Differences in Logistic Regression Curves--PSA, Sonoma") +
  scale_x_continuous(breaks = 1:6)

# eval_df %>%
#   filter(tool_name == "PSA") %>%
#   count(county)
```
\newpage

Tulare
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  filter(county == "Tulare") %>%
  filter(tool_name == "PSA") %>%
  group_by(psa_fta_risk_score, sex, county) %>%
  select(fta_flag) %>%
  pivot_longer(fta_flag) 

names(risk_df)[1] <- "psa_risk_score"

risk_df2 <- eval_df %>%
  filter(county == "Tulare") %>%
  filter(tool_name == "PSA") %>%
  group_by(psa_nca_risk_score, sex, county) %>%
  select(recid_arrested_flag, recid_filed_flag, recid_convicted_flag) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[1] <- "psa_risk_score"

risk_df3 <- eval_df %>%
  filter(county == "Tulare") %>%
  filter(tool_name == "PSA", !is.na(psa_nvca_risk_score)) %>%
  group_by(psa_nvca_risk_score, sex, county) %>%
  select(recid_arrest_violent_psa_flag) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[1] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(sex = factor(sex, levels = c("Male", "Female"))) %>%
  filter(sex %in% c("Male", "Female")) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) %>%
  filter(county %in% c("Tulare"))

ggplot(risk_df) +
  aes(x = psa_risk_score, y = value, color = sex) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent", 
       title = "Comparison of Racial Differences in Logistic Regression Curves--PSA, Tulare") +
  scale_x_continuous(breaks = 1:6)

# eval_df %>%
#   filter(tool_name == "PSA") %>%
#   count(county)
```
\newpage

Alameda 
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  filter(county == "Alameda") %>%
  mutate(sex = factor(sex, levels = c("Male", "Female"))) %>%
  filter(tool_name == "VPRAI-R", !is.na(vprair_risk_score)) %>%
  group_by(vprair_risk_score, sex) %>%
  select(vprair_risk_score, sex, fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag,
         any_pretrial_failure_flag, recid_arrest_violent_psa_flag) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) %>%
  filter(sex %in% c("Male", "Female")) 

ggplot(risk_df) +
  aes(x = vprair_risk_score, y = value, color = sex) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent",
       title = "Comparison of Gender Differences in Logistic Regression Curves--VPRAI-R, Alameda") +
  scale_x_continuous(breaks = 0:14)


```
\newpage

Santa Barbara  - TEMPORARILY REMOVED
\newline
```{r eval=FALSE, fig.height=6, fig.width=10, dpi=1200, include=FALSE}
risk_df <- eval_df %>%
  filter(county == "Santa Barbara") %>%
  mutate(sex = factor(sex, levels = c("Male", "Female"))) %>%
  filter(tool_name == "VPRAI-R", !is.na(vprair_risk_score)) %>%
  group_by(vprair_risk_score, sex) %>%
  select(vprair_risk_score, sex, fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag,
         any_pretrial_failure_flag, recid_arrest_violent_psa_flag) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) %>%
  filter(sex %in% c("Male", "Female")) 

ggplot(risk_df) +
  aes(x = vprair_risk_score, y = value, color = sex) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent",
       title = "Comparison of Gender Differences in Logistic Regression Curves--VPRAI-R, Santa Barbara") +
  scale_x_continuous(breaks = 0:14)


```
\newpage

San Mateo 
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  filter(county == "San Mateo") %>%
  mutate(sex = factor(sex, levels = c("Male", "Female"))) %>%
  filter(tool_name == "VPRAI-R", !is.na(vprair_risk_score)) %>%
  group_by(vprair_risk_score, sex) %>%
  select(vprair_risk_score, sex, fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag,
         any_pretrial_failure_flag, recid_arrest_violent_psa_flag) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) %>%
  filter(sex %in% c("Male", "Female")) 

ggplot(risk_df) +
  aes(x = vprair_risk_score, y = value, color = sex) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent",
       title = "Comparison of Gender Differences in Logistic Regression Curves--VPRAI-R, San Mateo") +
  scale_x_continuous(breaks = 0:14)


```
\newpage

# Gender Logistic Regression Tables

VPRAI--Without Interactions
\newline
```{r results='asis'}
m1 <- glm(family = binomial(),fta_flag ~ vprai_risk_score + sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "VPRAI"))
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprai_risk_score + sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "VPRAI"))
m3 <- glm(family = binomial(),recid_filed_flag ~ vprai_risk_score + sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "VPRAI"))
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprai_risk_score + sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "VPRAI"))
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprai_risk_score + sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "VPRAI"))
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprai_risk_score + sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "VPRAI"))

stargazer(list(m1,m2,m3,m4,m5,m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("VPRAI Risk Score", "Female", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")

```
\newpage

VPRAI--With Interactions at score 1
\newline
```{r results='asis'}
m1 <- glm(family = binomial(),fta_flag ~ vprai_risk_score * sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "VPRAI") %>% mutate(across(contains("score"), ~.x-1)))
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprai_risk_score * sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "VPRAI") %>% mutate(across(contains("score"), ~.x-1)))
m3 <- glm(family = binomial(),recid_filed_flag ~ vprai_risk_score * sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "VPRAI") %>% mutate(across(contains("score"), ~.x-1)))
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprai_risk_score * sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "VPRAI") %>% mutate(across(contains("score"), ~.x-1)))
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprai_risk_score * sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "VPRAI") %>% mutate(across(contains("score"), ~.x-1)))
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprai_risk_score * sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "VPRAI") %>% mutate(across(contains("score"), ~.x-1)))

stargazer(list(m1,m2,m3,m4,m5,m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("VPRAI Risk Score", "Female",
                               "Days Released", "VPRAI*Female"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

VPRAI--With Interactions at score 5
\newline
```{r results='asis'}
m1 <- glm(family = binomial(),fta_flag ~ vprai_risk_score * sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "VPRAI") %>% mutate(across(contains("score"), ~.x-5)))
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprai_risk_score * sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "VPRAI") %>% mutate(across(contains("score"), ~.x-5)))
m3 <- glm(family = binomial(),recid_filed_flag ~ vprai_risk_score * sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "VPRAI") %>% mutate(across(contains("score"), ~.x-5)))
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprai_risk_score * sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "VPRAI") %>% mutate(across(contains("score"), ~.x-5)))
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprai_risk_score * sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "VPRAI") %>% mutate(across(contains("score"), ~.x-5)))
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprai_risk_score * sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "VPRAI") %>% mutate(across(contains("score"), ~.x-5)))

stargazer(list(m1,m2,m3,m4,m5,m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("VPRAI Risk Score", "Female",
                               "Days Released", "VPRAI*Female"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage


VPRAI-R--Without Interactions
\newline
```{r results='asis'}
m1 <- glm(family = binomial(),fta_flag ~ vprair_risk_score + sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "VPRAI-R"))
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprair_risk_score + sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "VPRAI-R"))
m3 <- glm(family = binomial(),recid_filed_flag ~ vprair_risk_score + sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "VPRAI-R"))
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprair_risk_score + sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "VPRAI-R"))
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprair_risk_score + sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "VPRAI-R"))
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprair_risk_score + sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "VPRAI-R"))

stargazer(list(m1,m2,m3,m4,m5,m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("VPRAI-R Risk Score", "Female", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")

```
\newpage

VPRAI-R--With Interactions at score 1
\newline
```{r results='asis'}
m1 <- glm(family = binomial(),fta_flag ~ vprair_risk_score * sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "VPRAI-R") %>% mutate(across(contains("score"), ~.x-1)))
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprair_risk_score * sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "VPRAI-R") %>% mutate(across(contains("score"), ~.x-1)))
m3 <- glm(family = binomial(),recid_filed_flag ~ vprair_risk_score * sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "VPRAI-R") %>% mutate(across(contains("score"), ~.x-1)))
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprair_risk_score * sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "VPRAI-R") %>% mutate(across(contains("score"), ~.x-1)))
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprair_risk_score * sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "VPRAI-R") %>% mutate(across(contains("score"), ~.x-1)))
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprair_risk_score * sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "VPRAI-R") %>% mutate(across(contains("score"), ~.x-1)))

stargazer(list(m1,m2,m3,m4,m5,m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("VPRAI-R Risk Score", "Female",
                               "Days Released", "VPRAI-R*Female"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

VPRAI-R--With Interactions at score 6
\newline
```{r results='asis'}
m1 <- glm(family = binomial(),fta_flag ~ vprair_risk_score * sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "VPRAI-R") %>% mutate(across(contains("score"), ~.x-6)))
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprair_risk_score * sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "VPRAI-R") %>% mutate(across(contains("score"), ~.x-6)))
m3 <- glm(family = binomial(),recid_filed_flag ~ vprair_risk_score * sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "VPRAI-R") %>% mutate(across(contains("score"), ~.x-6)))
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprair_risk_score * sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "VPRAI-R") %>% mutate(across(contains("score"), ~.x-6)))
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprair_risk_score * sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "VPRAI-R") %>% mutate(across(contains("score"), ~.x-6)))
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprair_risk_score * sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "VPRAI-R") %>% mutate(across(contains("score"), ~.x-6)))

stargazer(list(m1,m2,m3,m4,m5,m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("VPRAI-R Risk Score", "Female",
                               "Days Released", "VPRAI-R*Female"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

ORAS--Without Interactions
\newline
```{r results='asis'}
m1 <- glm(family = binomial(),fta_flag ~ oras_risk_score + sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "ORAS"))
m2 <- glm(family = binomial(),recid_arrested_flag ~ oras_risk_score + sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "ORAS"))
m3 <- glm(family = binomial(),recid_filed_flag ~ oras_risk_score + sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "ORAS"))
m4 <- glm(family = binomial(),recid_convicted_flag ~ oras_risk_score + sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "ORAS"))
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ oras_risk_score + sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "ORAS"))
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ oras_risk_score + sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "ORAS"))

stargazer(list(m1,m2,m3,m4,m5,m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("ORAS Risk Score", "Female", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")

```
\newpage

ORAS--With Interactions at score 1
\newline
```{r results='asis'}
m1 <- glm(family = binomial(),fta_flag ~ oras_risk_score * sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "ORAS") %>% mutate(across(contains("score"), ~.x-1)))
m2 <- glm(family = binomial(),recid_arrested_flag ~ oras_risk_score * sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "ORAS") %>% mutate(across(contains("score"), ~.x-1)))
m3 <- glm(family = binomial(),recid_filed_flag ~ oras_risk_score * sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "ORAS") %>% mutate(across(contains("score"), ~.x-1)))
m4 <- glm(family = binomial(),recid_convicted_flag ~ oras_risk_score * sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "ORAS") %>% mutate(across(contains("score"), ~.x-1)))
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ oras_risk_score * sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "ORAS") %>% mutate(across(contains("score"), ~.x-1)))
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ oras_risk_score * sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "ORAS") %>% mutate(across(contains("score"), ~.x-1)))

stargazer(list(m1,m2,m3,m4,m5,m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("ORAS Risk Score", "Female",
                               "Days Released", "ORAS*Female"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

ORAS--With Interactions at score 3
\newline
```{r results='asis'}
m1 <- glm(family = binomial(),fta_flag ~ oras_risk_score * sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "ORAS") %>% mutate(across(contains("score"), ~.x-3)))
m2 <- glm(family = binomial(),recid_arrested_flag ~ oras_risk_score * sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "ORAS") %>% mutate(across(contains("score"), ~.x-3)))
m3 <- glm(family = binomial(),recid_filed_flag ~ oras_risk_score * sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "ORAS") %>% mutate(across(contains("score"), ~.x-3)))
m4 <- glm(family = binomial(),recid_convicted_flag ~ oras_risk_score * sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "ORAS") %>% mutate(across(contains("score"), ~.x-3)))
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ oras_risk_score * sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "ORAS") %>% mutate(across(contains("score"), ~.x-3)))
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ oras_risk_score * sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "ORAS") %>% mutate(across(contains("score"), ~.x-3)))

stargazer(list(m1,m2,m3,m4,m5,m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("ORAS Risk Score", "Female",
                               "Days Released", "ORAS*Female"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

PSA--Without Interactions
\newline
```{r, results='asis'}
m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score + sex + release_to_pretrial_end , data = sex_df %>% filter(tool_name == "PSA"))
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score + sex + release_to_pretrial_end , data = sex_df %>% filter(tool_name == "PSA"))
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score + sex + release_to_pretrial_end , data = sex_df %>% filter(tool_name == "PSA"))
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score + sex + release_to_pretrial_end , data = sex_df %>% filter(tool_name == "PSA"))
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score + sex + release_to_pretrial_end , data = sex_df %>% filter(tool_name == "PSA"))

stargazer(list(m1,m2,m3,m4,m5),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", 
                               "PSA NVCA Risk Score", "Female", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

PSA--With Interactions at score 1
\newline
```{r, results='asis'}
m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score * sex + release_to_pretrial_end , data = sex_df %>% filter(tool_name == "PSA") %>% mutate(across(contains("score"), ~.x-1)))
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score * sex + release_to_pretrial_end , data = sex_df %>% filter(tool_name == "PSA") %>% mutate(across(contains("score"), ~.x-1)))
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score * sex + release_to_pretrial_end , data = sex_df %>% filter(tool_name == "PSA") %>% mutate(across(contains("score"), ~.x-1)))
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score * sex + release_to_pretrial_end , data = sex_df %>% filter(tool_name == "PSA") %>% mutate(across(contains("score"), ~.x-1)))
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score * sex + release_to_pretrial_end , data = sex_df %>% filter(tool_name == "PSA"))

stargazer(list(m1,m2,m3,m4,m5),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", "PSA NVCA Risk Score", 
                               "Female", "Days Released", "FTA*Female",
                               "NCA*Female", "NVCA*Female"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage


PSA--With Interactions at score 6
\newline
```{r, results='asis'}
m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score * sex + release_to_pretrial_end , data = sex_df %>% filter(tool_name == "PSA") %>% mutate(across(contains("score"), ~.x-6)))
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score * sex + release_to_pretrial_end , data = sex_df %>% filter(tool_name == "PSA") %>% mutate(across(contains("score"), ~.x-6)))
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score * sex + release_to_pretrial_end , data = sex_df %>% filter(tool_name == "PSA") %>% mutate(across(contains("score"), ~.x-6)))
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score * sex + release_to_pretrial_end , data = sex_df %>% filter(tool_name == "PSA") %>% mutate(across(contains("score"), ~.x-6)))
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score * sex + release_to_pretrial_end , data = sex_df %>% filter(tool_name == "PSA") %>% mutate(across(contains("score"), ~.x-1)))

stargazer(list(m1,m2,m3,m4,m5),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", "PSA NVCA Risk Score", 
                               "Female", "Days Released", "FTA*Female",
                               "NCA*Female", "NVCA*Female"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

San Joaquin--Without Interactions  
\newline
```{r results='asis'}
county_df <- sex_df %>%
  filter(county == "San Joaquin") %>%
  filter(tool_name == "VPRAI")

m1 <- glm(family = binomial(),fta_flag ~ vprai_risk_score + sex + release_to_pretrial_end, data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprai_risk_score + sex + release_to_pretrial_end, data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprai_risk_score + sex + release_to_pretrial_end, data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprai_risk_score + sex + release_to_pretrial_end, data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprai_risk_score + sex + release_to_pretrial_end, data = county_df)
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprai_risk_score + sex + release_to_pretrial_end, data = county_df)

stargazer(list(m1,m2,m3,m4,m5,m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("VPRAI Risk Score", "Female", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

San Joaquin--With Interactions 
\newline
```{r results='asis'}
county_df <- sex_df %>%
  filter(county == "San Joaquin") %>%
  filter(tool_name == "VPRAI") %>%
  mutate(across(contains("score"), ~.x-1))

m1 <- glm(family = binomial(),fta_flag ~ vprai_risk_score * sex + release_to_pretrial_end, data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprai_risk_score * sex + release_to_pretrial_end, data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprai_risk_score * sex + release_to_pretrial_end, data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprai_risk_score * sex + release_to_pretrial_end, data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprai_risk_score * sex + release_to_pretrial_end, data = county_df)
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprai_risk_score * sex + release_to_pretrial_end, data = county_df)

stargazer(list(m1,m2,m3,m4,m5,m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("VPRAI Risk Score", "Female",
                               "Days Released", "VPRAI*Female"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

Los Angeles--Without Interactions
\newline
```{r, results='asis'}
county_df <- sex_df %>%
  filter(county == "Los Angeles") %>%
  filter(tool_name == "PSA")

m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score + sex + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score + sex + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score + sex + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score + sex + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score + sex + release_to_pretrial_end , data = county_df)

stargazer(list(m1,m2,m3,m4,m5),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", 
                               "PSA NVCA Risk Score", "Female", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

Los Angeles--With Interactions
\newline
```{r, results='asis'}
county_df <- sex_df %>%
  filter(county == "Los Angeles") %>%
  filter(tool_name == "PSA") %>%
  mutate(across(contains("score"), ~.x-1)) %>%
  mutate(psa_nvca_risk_score = psa_nvca_risk_score + 1)

m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score * sex + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score * sex + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score * sex + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score * sex + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score * sex + release_to_pretrial_end , data = county_df)

stargazer(list(m1,m2,m3,m4,m5),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", "PSA NVCA Risk Score", 
                               "Female", "Days Released", "FTA*Female",
                               "NCA*Female", "NVCA*Female"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

Sacramento--Without Interactions
\newline
```{r, results='asis'}
county_df <- sex_df %>%
  filter(county == "Sacramento") %>%
  filter(tool_name == "PSA")

m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score + sex + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score + sex + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score + sex + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score + sex + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score + sex + release_to_pretrial_end , data = county_df)

stargazer(list(m1,m2,m3,m4,m5),
        # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", 
                               "PSA NVCA Risk Score", "Female", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

Sacramento--With Interactions
\newline
```{r, results='asis'}
county_df <- sex_df %>%
  filter(county == "Sacramento") %>%
  filter(tool_name == "PSA") %>%
  mutate(across(contains("score"), ~.x-1)) %>%
  mutate(psa_nvca_risk_score = psa_nvca_risk_score + 1)

m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score * sex + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score * sex + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score * sex + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score * sex + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score * sex + release_to_pretrial_end , data = county_df)

stargazer(list(m1,m2,m3,m4,m5),
        # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", "PSA NVCA Risk Score", 
                               "Female", "Days Released", "FTA*Female",
                               "NCA*Female", "NVCA*Female"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

Sonoma--Without Interactions
\newline
```{r, results='asis'}
county_df <- sex_df %>%
  filter(county == "Sonoma") %>%
  filter(tool_name == "PSA")

m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score + sex + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score + sex + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score + sex + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score + sex + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score + sex + release_to_pretrial_end , data = county_df)

stargazer(list(m1,m2,m3,m4,m5),
        # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", 
                               "PSA NVCA Risk Score", "Female", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

Sonoma--With Interactions
\newline
```{r, results='asis'}
county_df <- sex_df %>%
  filter(county == "Sonoma") %>%
  filter(tool_name == "PSA") %>%
  mutate(across(contains("score"), ~.x-1)) %>%
  mutate(psa_nvca_risk_score = psa_nvca_risk_score + 1)

m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score * sex + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score * sex + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score * sex + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score * sex + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score * sex + release_to_pretrial_end , data = county_df)

stargazer(list(m1,m2,m3,m4,m5),
        # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", "PSA NVCA Risk Score", 
                               "Female", "Days Released", "FTA*Female",
                               "NCA*Female", "NVCA*Female"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

Tulare--Without Interactions 
\newline
```{r results='asis'}
county_df <- sex_df %>%
  filter(county == "Tulare") %>%
  filter(tool_name == "PSA")

m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score + sex + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score + sex + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score + sex + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score + sex + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score + sex + release_to_pretrial_end , data = county_df)

stargazer(list(m1,m2,m3,m4,m5),
        # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", 
                               "PSA NVCA Risk Score", "Female", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

Tulare--With Interactions 
\newline
```{r  results='asis'}
county_df <- sex_df %>%
  filter(county == "Tulare") %>%
  filter(tool_name == "PSA") %>%
  mutate(across(contains("score"), ~.x-1)) %>%
  mutate(psa_nvca_risk_score = psa_nvca_risk_score + 1)

m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score * sex + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score * sex + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score * sex + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score * sex + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score * sex + release_to_pretrial_end , data = county_df)

stargazer(list(m1,m2,m3,m4,m5),
        # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", "PSA NVCA Risk Score", 
                               "Female", "Days Released", "FTA*Female",
                               "NCA*Female", "NVCA*Female"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

Ventura--Without Interactions
\newline
```{r results='asis'}
m1 <- glm(family = binomial(),fta_flag ~ oras_risk_score + sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "ORAS", county == "Ventura"))
m2 <- glm(family = binomial(),recid_arrested_flag ~ oras_risk_score + sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "ORAS", county == "Ventura"))
m3 <- glm(family = binomial(),recid_filed_flag ~ oras_risk_score + sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "ORAS", county == "Ventura"))
m4 <- glm(family = binomial(),recid_convicted_flag ~ oras_risk_score + sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "ORAS", county == "Ventura"))
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ oras_risk_score + sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "ORAS", county == "Ventura"))
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ oras_risk_score + sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "ORAS", county == "Ventura"))

stargazer(list(m1,m2,m3,m4,m5,m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("ORAS Risk Score", "Female", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")

```
\newpage

Ventura--With Interactions
\newline
```{r results='asis'}
m1 <- glm(family = binomial(),fta_flag ~ oras_risk_score * sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "ORAS", county == "Ventura") %>% mutate(across(contains("score"), ~.x-1)))
m2 <- glm(family = binomial(),recid_arrested_flag ~ oras_risk_score * sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "ORAS", county == "Ventura") %>% mutate(across(contains("score"), ~.x-1)))
m3 <- glm(family = binomial(),recid_filed_flag ~ oras_risk_score * sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "ORAS", county == "Ventura") %>% mutate(across(contains("score"), ~.x-1)))
m4 <- glm(family = binomial(),recid_convicted_flag ~ oras_risk_score * sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "ORAS", county == "Ventura") %>% mutate(across(contains("score"), ~.x-1)))
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ oras_risk_score * sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "ORAS", county == "Ventura") %>% mutate(across(contains("score"), ~.x-1)))
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ oras_risk_score * sex + release_to_pretrial_end, data = sex_df %>% filter(tool_name == "ORAS", county == "Ventura") %>% mutate(across(contains("score"), ~.x-1)))

stargazer(list(m1,m2,m3,m4,m5,m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("ORAS Risk Score", "Female",
                               "Days Released", "ORAS*Female"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage


Alameda--Without Interactions  
\newline
```{r results='asis'}
county_df <- sex_df %>%
  filter(county == "Alameda") %>%
  filter(tool_name == "VPRAI-R")

m1 <- glm(family = binomial(),fta_flag ~ vprair_risk_score + sex + release_to_pretrial_end, data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprair_risk_score + sex + release_to_pretrial_end, data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprair_risk_score + sex + release_to_pretrial_end, data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprair_risk_score + sex + release_to_pretrial_end, data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprair_risk_score + sex + release_to_pretrial_end, data = county_df)
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprair_risk_score + sex + release_to_pretrial_end, data = county_df)

stargazer(list(m1,m2,m3,m4,m5,m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("VPRAI-R Risk Score", "Female", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

Alameda--With Interactions at score 1
\newline
```{r results='asis'}
county_df <- sex_df %>%
  filter(county == "Alameda") %>%
  filter(tool_name == "VPRAI-R") %>%
  mutate(across(contains("score"), ~.x-1))

m1 <- glm(family = binomial(),fta_flag ~ vprair_risk_score * sex + release_to_pretrial_end, data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprair_risk_score * sex + release_to_pretrial_end, data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprair_risk_score * sex + release_to_pretrial_end, data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprair_risk_score * sex + release_to_pretrial_end, data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprair_risk_score * sex + release_to_pretrial_end, data = county_df)
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprair_risk_score * sex + release_to_pretrial_end, data = county_df)

stargazer(list(m1,m2,m3,m4,m5,m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("VPRAI-R Risk Score", "Female",
                               "Days Released", "VPRAI-R*Female"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

Alameda--With Interactions at score 6
\newline
```{r results='asis'}
county_df <- sex_df %>%
  filter(county == "Alameda") %>%
  filter(tool_name == "VPRAI-R") %>%
  mutate(across(contains("score"), ~.x-6))

m1 <- glm(family = binomial(),fta_flag ~ vprair_risk_score * sex + release_to_pretrial_end, data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprair_risk_score * sex + release_to_pretrial_end, data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprair_risk_score * sex + release_to_pretrial_end, data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprair_risk_score * sex + release_to_pretrial_end, data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprair_risk_score * sex + release_to_pretrial_end, data = county_df)
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprair_risk_score * sex + release_to_pretrial_end, data = county_df)

stargazer(list(m1,m2,m3,m4,m5,m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("VPRAI-R Risk Score", "Female",
                               "Days Released", "VPRAI-R*Female"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage


Santa Barbara--Without Interactions   - TEMPORARILY REMOVED
\newline
```{r eval=FALSE, include=FALSE, results='asis'}
county_df <- sex_df %>%
  filter(county == "Santa Barbara") %>%
  filter(tool_name == "VPRAI-R")

m1 <- glm(family = binomial(),fta_flag ~ vprair_risk_score + sex + release_to_pretrial_end, data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprair_risk_score + sex + release_to_pretrial_end, data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprair_risk_score + sex + release_to_pretrial_end, data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprair_risk_score + sex + release_to_pretrial_end, data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprair_risk_score + sex + release_to_pretrial_end, data = county_df)
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprair_risk_score + sex + release_to_pretrial_end, data = county_df)

stargazer(list(m1,m2,m3,m4,m5,m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("VPRAI-R Risk Score", "Female", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

Santa Barbara--With Interactions  - TEMPORARILY REMOVED
\newline
```{r eval=FALSE, include=FALSE, results='asis'}
county_df <- sex_df %>%
  filter(county == "Santa Barbara") %>%
  filter(tool_name == "VPRAI-R") %>%
  mutate(across(contains("score"), ~.x-1))

m1 <- glm(family = binomial(),fta_flag ~ vprair_risk_score * sex + release_to_pretrial_end, data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprair_risk_score * sex + release_to_pretrial_end, data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprair_risk_score * sex + release_to_pretrial_end, data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprair_risk_score * sex + release_to_pretrial_end, data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprair_risk_score * sex + release_to_pretrial_end, data = county_df)
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprair_risk_score * sex + release_to_pretrial_end, data = county_df)

stargazer(list(m1,m2,m3,m4,m5,m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("VPRAI-R Risk Score", "Female",
                               "Days Released", "VPRAI-R*Female"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

San Mateo--Without Interactions  
\newline
```{r results='asis'}
county_df <- sex_df %>%
  filter(county == "San Mateo") %>%
  filter(tool_name == "VPRAI-R")

m1 <- glm(family = binomial(),fta_flag ~ vprair_risk_score + sex + release_to_pretrial_end, data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprair_risk_score + sex + release_to_pretrial_end, data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprair_risk_score + sex + release_to_pretrial_end, data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprair_risk_score + sex + release_to_pretrial_end, data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprair_risk_score + sex + release_to_pretrial_end, data = county_df)
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprair_risk_score + sex + release_to_pretrial_end, data = county_df)

stargazer(list(m1,m2,m3,m4,m5,m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("VPRAI-R Risk Score", "Female", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

San Mateo--With Interactions 
\newline
```{r results='asis'}
county_df <- sex_df %>%
  filter(county == "San Mateo") %>%
  filter(tool_name == "VPRAI-R") %>%
  mutate(across(contains("score"), ~.x-1))

m1 <- glm(family = binomial(),fta_flag ~ vprair_risk_score * sex + release_to_pretrial_end, data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprair_risk_score * sex + release_to_pretrial_end, data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprair_risk_score * sex + release_to_pretrial_end, data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprair_risk_score * sex + release_to_pretrial_end, data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprair_risk_score * sex + release_to_pretrial_end, data = county_df)
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprair_risk_score * sex + release_to_pretrial_end, data = county_df)

stargazer(list(m1,m2,m3,m4,m5,m6),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 
          covariate.labels = c("VPRAI-R Risk Score", "Female",
                               "Days Released", "VPRAI-R*Female"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")
```
\newpage

# Gender AUCs

VPRAI
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "VPRAI", race == "All", sex != "All", county == "All") %>%
  select(sex, outcome, AUC, CI, n) %>%
  arrange(sex) %>%
  mutate(outcome = case_when(outcome == "fta_flag" ~ "FTA",
                             outcome == "recid_arrested_flag" ~ "New Arrest",
                             outcome == "recid_filed_flag" ~ "New Filing",
                             outcome == "recid_convicted_flag" ~ "New Conviction",
                             outcome == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest",
                             outcome == "any_pretrial_failure_flag" ~ "FTA or New Arrest"))

names(tool_df) <- c("sex", "Outcome", "AUC", "CI (95%)", "N")

tool_df <- tool_df %>%
  pivot_wider(names_from = sex, values_from = c(AUC, `CI (95%)`, N))

names(tool_df) <- gsub("AUC_|CI .*_", "", names(tool_df))

kable(tool_df[1:5], booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray",
                  font_size = 10, latex_options = "hold_position") %>%
  add_header_above(c(" " = 1, "AUC" = 2, "CI (95%)" = 2)) %>% 
  footnote(paste("N Female =", tool_df$N_Female[1], ", N Male =", 
                     tool_df$N_Male[1]))
```
\newpage

VPRAI-R
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "VPRAI-R", race == "All", sex != "All", county == "All") %>%
  select(sex, outcome, AUC, CI, n) %>%
  arrange(sex) %>%
  mutate(outcome = case_when(outcome == "fta_flag" ~ "FTA",
                             outcome == "recid_arrested_flag" ~ "New Arrest",
                             outcome == "recid_filed_flag" ~ "New Filing",
                             outcome == "recid_convicted_flag" ~ "New Conviction",
                             outcome == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest",
                             outcome == "any_pretrial_failure_flag" ~ "FTA or New Arrest"))

names(tool_df) <- c("sex", "Outcome", "AUC", "CI (95%)", "N")

tool_df <- tool_df %>%
  pivot_wider(names_from = sex, values_from = c(AUC, `CI (95%)`, N))

names(tool_df) <- gsub("AUC_|CI .*_", "", names(tool_df))

kable(tool_df[1:5], booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray",
                  font_size = 10, latex_options = "hold_position") %>%
  add_header_above(c(" " = 1, "AUC" = 2, "CI (95%)" = 2)) %>% 
  footnote(paste("N Female =", tool_df$N_Female[1], ", N Male =", 
                     tool_df$N_Male[1]))
```
\newpage

ORAS
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "ORAS", race == "All", sex != "All", county == "All") %>%
  select(sex, outcome, AUC, CI, n) %>%
  arrange(sex) %>%
  mutate(outcome = case_when(outcome == "fta_flag" ~ "FTA",
                             outcome == "recid_arrested_flag" ~ "New Arrest",
                             outcome == "recid_filed_flag" ~ "New Filing",
                             outcome == "recid_convicted_flag" ~ "New Conviction",
                             outcome == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest",
                             outcome == "any_pretrial_failure_flag" ~ "FTA or New Arrest"))

names(tool_df) <- c("sex", "Outcome", "AUC", "CI (95%)", "N")

tool_df <- tool_df %>%
  pivot_wider(names_from = sex, values_from = c(AUC, `CI (95%)`, N))

names(tool_df) <- gsub("AUC_|CI .*_", "", names(tool_df))

kable(tool_df[1:5], booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray",
                  font_size = 10, latex_options = "hold_position") %>%
  add_header_above(c(" " = 1, "AUC" = 2, "CI (95%)" = 2)) %>% 
  footnote(paste("N Female =", tool_df$N_Female[1], ", N Male =", 
                     tool_df$N_Male[1]))
```
\newpage

PSA
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "PSA", race == "All", sex != "All", county == "All") %>%
  select(sex, risk_score, outcome, AUC, CI, n) %>%
  arrange(sex) %>%
  mutate(risk_score = case_when(risk_score == "psa_fta_risk_score" ~ "PSA FTA",
                                risk_score == "psa_nca_risk_score" ~ "PSA NCA",
                                risk_score == "psa_nvca_risk_score" ~ "PSA NVCA")) %>%
  mutate(outcome = case_when(outcome == "fta_flag" ~ "FTA",
                             outcome == "recid_arrested_flag" ~ "New Arrest",
                             outcome == "recid_filed_flag" ~ "New Filing",
                             outcome == "recid_convicted_flag" ~ "New Conviction",
                             outcome == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest",
                             outcome == "any_pretrial_failure_flag" ~ "FTA or New Arrest"))

names(tool_df) <- c("sex", "Risk Score", "Outcome", "AUC", "CI (95%)", "N")

tool_df <- tool_df %>%
  pivot_wider(names_from = sex, values_from = c(AUC, `CI (95%)`, N))

names(tool_df) <- gsub("AUC_|CI .*_", "", names(tool_df))

kable(tool_df[1:6], booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray",
                  font_size = 10, latex_options = "hold_position") %>%
  add_header_above(c(" " = 2, "AUC" = 2, "CI (95%)" = 2)) %>% 
  footnote(paste("N Female =", tool_df$N_Female[1], ", N Male =", 
                     tool_df$N_Male[1]))
```
\newpage

San Joaquin  
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "VPRAI", race == "All", sex != "All", county == "San Joaquin") %>%
  select(sex, outcome, AUC, CI, n) %>%
  arrange(sex) %>%
  mutate(outcome = case_when(outcome == "fta_flag" ~ "FTA",
                             outcome == "recid_arrested_flag" ~ "New Arrest",
                             outcome == "recid_filed_flag" ~ "New Filing",
                             outcome == "recid_convicted_flag" ~ "New Conviction",
                             outcome == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest",
                             outcome == "any_pretrial_failure_flag" ~ "FTA or New Arrest"))

names(tool_df) <- c("sex", "Outcome", "AUC", "CI (95%)", "N")

tool_df <- tool_df %>%
  pivot_wider(names_from = sex, values_from = c(AUC, `CI (95%)`, N))

names(tool_df) <- gsub("AUC_|CI .*_", "", names(tool_df))

kable(tool_df[1:5], booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray",
                  font_size = 10, latex_options = "hold_position") %>%
  add_header_above(c(" " = 1, "AUC" = 2, "CI (95%)" = 2)) %>% 
  footnote(paste("N Female =", tool_df$N_Female[1], ", N Male =", 
                     tool_df$N_Male[1]))
```
\newpage

Los Angeles
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "PSA", race == "All", sex != "All", county == "Los Angeles") %>%
  select(sex, risk_score, outcome, AUC, CI, n) %>%
  arrange(sex) %>%
  mutate(
    risk_score = rep(c("PSA FTA", rep("PSA NCA",3), "PSA NVCA"),2)) %>%
  mutate(outcome = case_when(outcome == "fta_flag" ~ "FTA",
                             outcome == "recid_arrested_flag" ~ "New Arrest",
                             outcome == "recid_filed_flag" ~ "New Filing",
                             outcome == "recid_convicted_flag" ~ "New Conviction",
                             outcome == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest",
                             outcome == "any_pretrial_failure_flag" ~ "FTA or New Arrest"))

names(tool_df) <- c("sex", "Risk Score", "Outcome", "AUC", "CI (95%)", "N")

tool_df <- tool_df %>%
  pivot_wider(names_from = sex, values_from = c(AUC, `CI (95%)`, N))

names(tool_df) <- gsub("AUC_|CI .*_", "", names(tool_df))

kable(tool_df[1:6], booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray",
                  font_size = 10, latex_options = "hold_position") %>%
  add_header_above(c(" " = 2, "AUC" = 2, "CI (95%)" = 2)) %>% 
  footnote(paste("N Female =", tool_df$N_Female[1], ", N Male =", 
                     tool_df$N_Male[1]))
```
\newpage

Sacramento
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "PSA", race == "All", sex != "All", county == "Sacramento") %>%
  select(sex, risk_score, outcome, AUC, CI, n) %>%
  arrange(sex) %>%
  mutate(risk_score = case_when(risk_score == "psa_fta_risk_score" ~ "PSA FTA",
                                risk_score == "psa_nca_risk_score" ~ "PSA NCA",
                                risk_score == "psa_nvca_risk_score" ~ "PSA NVCA")) %>%
  mutate(outcome = case_when(outcome == "fta_flag" ~ "FTA",
                             outcome == "recid_arrested_flag" ~ "New Arrest",
                             outcome == "recid_filed_flag" ~ "New Filing",
                             outcome == "recid_convicted_flag" ~ "New Conviction",
                             outcome == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest",
                             outcome == "any_pretrial_failure_flag" ~ "FTA or New Arrest"))

names(tool_df) <- c("sex", "Risk Score", "Outcome", "AUC", "CI (95%)", "N")

tool_df <- tool_df %>%
  pivot_wider(names_from = sex, values_from = c(AUC, `CI (95%)`, N))

names(tool_df) <- gsub("AUC_|CI .*_", "", names(tool_df))

kable(tool_df[1:6], booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray",
                  font_size = 10, latex_options = "hold_position") %>%
  add_header_above(c(" " = 2, "AUC" = 2, "CI (95%)" = 2)) %>% 
  footnote(paste("N Female =", tool_df$N_Female[1], ", N Male =", 
                     tool_df$N_Male[1]))
```
\newpage

Ventura
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "ORAS", race == "All", sex != "All", county == "Ventura") %>%
  select(sex, outcome, AUC, CI, n) %>%
  arrange(sex) %>%
  mutate(outcome = case_when(outcome == "fta_flag" ~ "FTA",
                             outcome == "recid_arrested_flag" ~ "New Arrest",
                             outcome == "recid_filed_flag" ~ "New Filing",
                             outcome == "recid_convicted_flag" ~ "New Conviction",
                             outcome == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest",
                             outcome == "any_pretrial_failure_flag" ~ "FTA or New Arrest"))

names(tool_df) <- c("sex", "Outcome", "AUC", "CI (95%)", "N")

tool_df <- tool_df %>%
  pivot_wider(names_from = sex, values_from = c(AUC, `CI (95%)`, N))

names(tool_df) <- gsub("AUC_|CI .*_", "", names(tool_df))

kable(tool_df[1:5], booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray",
                  font_size = 10, latex_options = "hold_position") %>%
  add_header_above(c(" " = 1, "AUC" = 2, "CI (95%)" = 2)) %>% 
  footnote(paste("N Female =", tool_df$N_Female[1], ", N Male =", 
                     tool_df$N_Male[1]))
```
\newpage

Sonoma
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "PSA", race == "All", sex != "All", county == "Sonoma") %>%
  select(sex, risk_score, outcome, AUC, CI, n) %>%
  arrange(sex) %>%
  mutate(risk_score = case_when(risk_score == "psa_fta_risk_score" ~ "PSA FTA",
                                risk_score == "psa_nca_risk_score" ~ "PSA NCA",
                                risk_score == "psa_nvca_risk_score" ~ "PSA NVCA")) %>%
  mutate(outcome = case_when(outcome == "fta_flag" ~ "FTA",
                             outcome == "recid_arrested_flag" ~ "New Arrest",
                             outcome == "recid_filed_flag" ~ "New Filing",
                             outcome == "recid_convicted_flag" ~ "New Conviction",
                             outcome == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest",
                             outcome == "any_pretrial_failure_flag" ~ "FTA or New Arrest"))

names(tool_df) <- c("sex", "Risk Score", "Outcome", "AUC", "CI (95%)", "N")

tool_df <- tool_df %>%
  pivot_wider(names_from = sex, values_from = c(AUC, `CI (95%)`, N))

names(tool_df) <- gsub("AUC_|CI .*_", "", names(tool_df))

kable(tool_df[1:6], booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray",
                  font_size = 10, latex_options = "hold_position") %>%
  add_header_above(c(" " = 2, "AUC" = 2, "CI (95%)" = 2)) %>% 
  footnote(paste("N Female =", tool_df$N_Female[1], ", N Male =", 
                     tool_df$N_Male[1]))
```
\newpage

Tulare 
\newline
```{r }
tool_df <- auc_df %>%
  filter(tool_name == "PSA", race == "All", sex != "All", county == "Tulare") %>%
  select(sex, risk_score, outcome, AUC, CI, n) %>%
  arrange(sex) %>%
  mutate(risk_score = case_when(risk_score == "psa_fta_risk_score" ~ "PSA FTA",
                                risk_score == "psa_nca_risk_score" ~ "PSA NCA",
                                risk_score == "psa_nvca_risk_score" ~ "PSA NVCA")) %>%
  mutate(outcome = case_when(outcome == "fta_flag" ~ "FTA",
                             outcome == "recid_arrested_flag" ~ "New Arrest",
                             outcome == "recid_filed_flag" ~ "New Filing",
                             outcome == "recid_convicted_flag" ~ "New Conviction",
                             outcome == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest",
                             outcome == "any_pretrial_failure_flag" ~ "FTA or New Arrest"))

names(tool_df) <- c("sex", "Risk Score", "Outcome", "AUC", "CI (95%)", "N")

tool_df <- tool_df %>%
  pivot_wider(names_from = sex, values_from = c(AUC, `CI (95%)`, N))

names(tool_df) <- gsub("AUC_|CI .*_", "", names(tool_df))

kable(tool_df[1:6], booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray",
                  font_size = 10, latex_options = "hold_position") %>%
  add_header_above(c(" " = 2, "AUC" = 2, "CI (95%)" = 2)) %>% 
  footnote(paste("N Female =", tool_df$N_Female[1], ", N Male =", 
                     tool_df$N_Male[1]))
```
\newpage

Alameda  
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "VPRAI-R", race == "All", sex != "All", county == "Alameda") %>%
  select(sex, outcome, AUC, CI, n) %>%
  arrange(sex) %>%
  mutate(outcome = case_when(outcome == "fta_flag" ~ "FTA",
                             outcome == "recid_arrested_flag" ~ "New Arrest",
                             outcome == "recid_filed_flag" ~ "New Filing",
                             outcome == "recid_convicted_flag" ~ "New Conviction",
                             outcome == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest",
                             outcome == "any_pretrial_failure_flag" ~ "FTA or New Arrest"))

names(tool_df) <- c("sex", "Outcome", "AUC", "CI (95%)", "N")

tool_df <- tool_df %>%
  pivot_wider(names_from = sex, values_from = c(AUC, `CI (95%)`, N))

names(tool_df) <- gsub("AUC_|CI .*_", "", names(tool_df))

kable(tool_df[1:5], booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray",
                  font_size = 10, latex_options = "hold_position") %>%
  add_header_above(c(" " = 1, "AUC" = 2, "CI (95%)" = 2)) %>% 
  footnote(paste("N Female =", tool_df$N_Female[1], ", N Male =", 
                     tool_df$N_Male[1]))
```
\newpage

Santa Barbara   - TEMPORARILY REMOVED
\newline
```{r eval=FALSE, include=FALSE}
tool_df <- auc_df %>%
  filter(tool_name == "VPRAI-R", race == "All", sex != "All", county == "Santa Barbara") %>%
  select(sex, outcome, AUC, CI, n) %>%
  arrange(sex) %>%
  mutate(outcome = case_when(outcome == "fta_flag" ~ "FTA",
                             outcome == "recid_arrested_flag" ~ "New Arrest",
                             outcome == "recid_filed_flag" ~ "New Filing",
                             outcome == "recid_convicted_flag" ~ "New Conviction",
                             outcome == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest",
                             outcome == "any_pretrial_failure_flag" ~ "FTA or New Arrest"))

names(tool_df) <- c("sex", "Outcome", "AUC", "CI (95%)", "N")

tool_df <- tool_df %>%
  pivot_wider(names_from = sex, values_from = c(AUC, `CI (95%)`, N))

names(tool_df) <- gsub("AUC_|CI .*_", "", names(tool_df))

kable(tool_df[1:5], booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray",
                  font_size = 10, latex_options = "hold_position") %>%
  add_header_above(c(" " = 1, "AUC" = 2, "CI (95%)" = 2)) %>% 
  footnote(paste("N Female =", tool_df$N_Female[1], ", N Male =", 
                     tool_df$N_Male[1]))
```
\newpage

San Mateo  
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "VPRAI-R", race == "All", sex != "All", county == "San Mateo") %>%
  select(sex, outcome, AUC, CI, n) %>%
  arrange(sex) %>%
  mutate(outcome = case_when(outcome == "fta_flag" ~ "FTA",
                             outcome == "recid_arrested_flag" ~ "New Arrest",
                             outcome == "recid_filed_flag" ~ "New Filing",
                             outcome == "recid_convicted_flag" ~ "New Conviction",
                             outcome == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest",
                             outcome == "any_pretrial_failure_flag" ~ "FTA or New Arrest"))

names(tool_df) <- c("sex", "Outcome", "AUC", "CI (95%)", "N")

tool_df <- tool_df %>%
  pivot_wider(names_from = sex, values_from = c(AUC, `CI (95%)`, N))

names(tool_df) <- gsub("AUC_|CI .*_", "", names(tool_df))

kable(tool_df[1:5], booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray",
                  font_size = 10, latex_options = "hold_position") %>%
  add_header_above(c(" " = 1, "AUC" = 2, "CI (95%)" = 2)) %>% 
  footnote(paste("N Female =", tool_df$N_Female[1], ", N Male =", 
                     tool_df$N_Male[1]))
```
\newpage


# KNITR EXIT ----------------------------------------------- removed for now
```{r}
#knitr::knit_exit()
```

#AUC comparisons

PSA AUC race comparison
```{r}
rocW <- roc(fta_flag ~ psa_fta_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(race == "White"), ci = T)
rocB <- roc(fta_flag ~ psa_fta_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(race == "Black"), ci = T)
rocH <- roc(fta_flag ~ psa_fta_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW, rocB)
roc.test(rocW, rocH)
roc.test(rocB, rocH)

rocW <- roc(recid_arrested_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(race == "White"), ci = T)
rocB <- roc(recid_arrested_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(race == "Black"), ci = T)
rocH <- roc(recid_arrested_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW, rocB)
roc.test(rocW, rocH)
roc.test(rocB, rocH)

rocW <- roc(recid_filed_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(race == "White"), ci = T)
rocB <- roc(recid_filed_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(race == "Black"), ci = T)
rocH <- roc(recid_filed_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW, rocB)
roc.test(rocW, rocH)
roc.test(rocB, rocH)

rocW <- roc(recid_convicted_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(race == "White"), ci = T)
rocB <- roc(recid_convicted_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(race == "Black"), ci = T)
rocH <- roc(recid_convicted_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW, rocB)
roc.test(rocW, rocH)
roc.test(rocB, rocH)

rocW <- roc(recid_arrest_violent_psa_flag ~ psa_nvca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(race == "White"), ci = T)
rocB <- roc(recid_arrest_violent_psa_flag ~ psa_nvca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(race == "Black"), ci = T)
rocH <- roc(recid_arrest_violent_psa_flag ~ psa_nvca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW, rocB)
roc.test(rocW, rocH)
roc.test(rocB, rocH)

```

PSA AUC gender comparisons
```{r}
rocW_FTA <- roc(fta_flag ~ psa_fta_risk_score, data = eval_df %>% filter(tool_name == "PSA")  %>% filter(sex == "Female"), ci = T)
rocM_FTA <- roc(fta_flag ~ psa_fta_risk_score, data = eval_df %>% filter(tool_name == "PSA")  %>% filter(sex == "Male"), ci = T)

roc.test(rocW_FTA, rocM_FTA)


rocW_newarrest <- roc(recid_arrested_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA")  %>% filter(sex == "Female"), ci = T)
rocM_newarrest <- roc(recid_arrested_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA")  %>% filter(sex == "Male"), ci = T)

roc.test(rocW_newarrest, rocM_newarrest)


rocW_newfiling <- roc(recid_filed_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA")  %>% filter(sex == "Female"), ci = T)
rocM_newfiling <- roc(recid_filed_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA")  %>% filter(sex == "Male"), ci = T)

roc.test(rocW_newfiling, rocM_newfiling)


rocW_newconviction <- roc(recid_convicted_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA")  %>% filter(sex == "Female"), ci = T)
rocM_newconviction <- roc(recid_convicted_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA")  %>% filter(sex == "Male"), ci = T)

roc.test(rocW_newconviction, rocM_newconviction)


rocW_newviolent <- roc(recid_arrest_violent_psa_flag ~ psa_nvca_risk_score, data = eval_df %>% filter(tool_name == "PSA")  %>% filter(sex == "Female"), ci = T)
rocM_newviolent <- roc(recid_arrest_violent_psa_flag ~ psa_nvca_risk_score, data = eval_df %>% filter(tool_name == "PSA")  %>% filter(sex == "Male"), ci = T)

roc.test(rocW_newviolent, rocM_newviolent)

```


VPRAI AUC race comparison 
```{r}
rocW <- roc(fta_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI") %>% filter(race == "White"), ci = T)
rocB <- roc(fta_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI") %>% filter(race == "Black"), ci = T)
rocH <- roc(fta_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI") %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW, rocB)
roc.test(rocW, rocH)
roc.test(rocB, rocH)

rocW <- roc(recid_arrested_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI") %>% filter(race == "White"), ci = T)
rocB <- roc(recid_arrested_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI") %>% filter(race == "Black"), ci = T)
rocH <- roc(recid_arrested_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI") %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW, rocB)
roc.test(rocW, rocH)
roc.test(rocB, rocH)

rocW <- roc(recid_filed_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI") %>% filter(race == "White"), ci = T)
rocB <- roc(recid_filed_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI") %>% filter(race == "Black"), ci = T)
rocH <- roc(recid_filed_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI") %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW, rocB)
roc.test(rocW, rocH)
roc.test(rocB, rocH)

rocW <- roc(recid_convicted_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI") %>% filter(race == "White"), ci = T)
rocB <- roc(recid_convicted_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI") %>% filter(race == "Black"), ci = T)
rocH <- roc(recid_convicted_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI") %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW, rocB)
roc.test(rocW, rocH)
roc.test(rocB, rocH)

rocW <- roc(recid_arrest_violent_psa_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI") %>% filter(race == "White"), ci = T)
rocB <- roc(recid_arrest_violent_psa_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI") %>% filter(race == "Black"), ci = T)
rocH <- roc(recid_arrest_violent_psa_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI") %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW, rocB)
roc.test(rocW, rocH)
roc.test(rocB, rocH)

```

VPRAI AUC gender comparisons
```{r}
rocW_FTA <- roc(fta_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI")  %>% filter(sex == "Female"), ci = T)
rocM_FTA <- roc(fta_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI")  %>% filter(sex == "Male"), ci = T)
roc.test(rocW_FTA, rocM_FTA)


rocW_newarrest <- roc(recid_arrested_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI")  %>% filter(sex == "Female"), ci = T)
rocM_newarrest <- roc(recid_arrested_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI")  %>% filter(sex == "Male"), ci = T)

roc.test(rocW_newarrest, rocM_newarrest)


rocW_newfiling <- roc(recid_filed_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI")  %>% filter(sex == "Female"), ci = T)
rocM_newfiling <- roc(recid_filed_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI")  %>% filter(sex == "Male"), ci = T)

roc.test(rocW_newfiling, rocM_newfiling)


rocW_newconviction <- roc(recid_convicted_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI")  %>% filter(sex == "Female"), ci = T)
rocM_newconviction <- roc(recid_convicted_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI")  %>% filter(sex == "Male"), ci = T)

roc.test(rocW_newconviction, rocM_newconviction)


rocW_newviolent <- roc(recid_arrest_violent_psa_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI")  %>% filter(sex == "Female"), ci = T)
rocM_newviolent <- roc(recid_arrest_violent_psa_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI")  %>% filter(sex == "Male"), ci = T)

roc.test(rocW_newviolent, rocM_newviolent)


rocW_anyfailure <- roc(any_pretrial_failure_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI")  %>% filter(sex == "Female"), ci = T)
rocM_anyfailure <- roc(any_pretrial_failure_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI")  %>% filter(sex == "Male"), ci = T)

roc.test(rocW_anyfailure, rocM_anyfailure)

```



VPRAI-R AUC race comparisons
```{r}
rocW_FTA <- roc(fta_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R")  %>% filter(race == "White"), ci = T)
rocB_FTA <- roc(fta_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R")  %>% filter(race == "Black"), ci = T)
rocH_FTA <- roc(fta_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R")  %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW_FTA, rocB_FTA)
roc.test(rocW_FTA, rocH_FTA)
roc.test(rocB_FTA, rocH_FTA)

rocW_newarrest <- roc(recid_arrested_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R")  %>% filter(race == "White"), ci = T)
rocB_newarrest <- roc(recid_arrested_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R")  %>% filter(race == "Black"), ci = T)
rocH_newarrest <- roc(recid_arrested_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R")  %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW_newarrest, rocB_newarrest)
roc.test(rocW_newarrest, rocH_newarrest)
roc.test(rocB_newarrest, rocH_newarrest)

rocW_newfiling <- roc(recid_filed_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R")  %>% filter(race == "White"), ci = T)
rocB_newfiling <- roc(recid_filed_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R")  %>% filter(race == "Black"), ci = T)
rocH_newfiling <- roc(recid_filed_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R")  %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW_newfiling, rocB_newfiling)
roc.test(rocW_newfiling, rocH_newfiling)
roc.test(rocB_newfiling, rocH_newfiling)

rocW_newconviction <- roc(recid_convicted_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R")  %>% filter(race == "White"), ci = T)
rocB_newconviction <- roc(recid_convicted_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R")  %>% filter(race == "Black"), ci = T)
rocH_newconviction <- roc(recid_convicted_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R")  %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW_newconviction, rocB_newconviction)
roc.test(rocW_newconviction, rocH_newconviction)
roc.test(rocB_newconviction, rocH_newconviction)

rocW_newviolent <- roc(recid_arrest_violent_psa_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R")  %>% filter(race == "White"), ci = T)
rocB_newviolent <- roc(recid_arrest_violent_psa_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R")  %>% filter(race == "Black"), ci = T)
rocH_newviolent <- roc(recid_arrest_violent_psa_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R")  %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW_newviolent, rocB_newviolent)
roc.test(rocW_newviolent, rocH_newviolent)
roc.test(rocB_newviolent, rocH_newviolent)

rocW_anyfailure <- roc(any_pretrial_failure_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R")  %>% filter(race == "White"), ci = T)
rocB_anyfailure <- roc(any_pretrial_failure_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R")  %>% filter(race == "Black"), ci = T)
rocH_anyfailure <- roc(any_pretrial_failure_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R")  %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW_anyfailure, rocB_anyfailure)
roc.test(rocW_anyfailure, rocH_anyfailure)
roc.test(rocB_anyfailure, rocH_anyfailure)
```

VPRAI-R AUC gender comparisons
```{r}
rocW_FTA <- roc(fta_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R")  %>% filter(sex == "Female"), ci = T)
rocM_FTA <- roc(fta_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R") %>% filter(sex == "Male"), ci = T)

roc.test(rocW_FTA, rocM_FTA)


rocW_newarrest <- roc(recid_arrested_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R")  %>% filter(sex == "Female"), ci = T)
rocM_newarrest <- roc(recid_arrested_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R")  %>% filter(sex == "Male"), ci = T)

roc.test(rocW_newarrest, rocM_newarrest)


rocW_newfiling <- roc(recid_filed_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R") %>% filter(sex == "Female"), ci = T)
rocM_newfiling <- roc(recid_filed_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R")  %>% filter(sex == "Male"), ci = T)

roc.test(rocW_newfiling, rocM_newfiling)


rocW_newconviction <- roc(recid_convicted_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R") %>% filter(sex == "Female"), ci = T)
rocM_newconviction <- roc(recid_convicted_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R") %>% filter(sex == "Male"), ci = T)

roc.test(rocW_newconviction, rocM_newconviction)


rocW_newviolent <- roc(recid_arrest_violent_psa_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R")  %>% filter(sex == "Female"), ci = T)
rocM_newviolent <- roc(recid_arrest_violent_psa_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R") %>% filter(sex == "Male"), ci = T)

roc.test(rocW_newviolent, rocM_newviolent)


rocW_anyfailure <- roc(any_pretrial_failure_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R")  %>% filter(sex == "Female"), ci = T)
rocM_anyfailure <- roc(any_pretrial_failure_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R")  %>% filter(sex == "Male"), ci = T)

roc.test(rocW_anyfailure, rocM_anyfailure)

```

ORAS AUC race comparisons
```{r}
rocW_FTA <- roc(fta_flag ~ oras_risk_score, data = eval_df %>% filter(tool_name == "ORAS")  %>% filter(race == "White"), ci = T)
rocB_FTA <- roc(fta_flag ~ oras_risk_score, data = eval_df %>% filter(tool_name == "ORAS")  %>% filter(race == "Black"), ci = T)
rocH_FTA <- roc(fta_flag ~ oras_risk_score, data = eval_df %>% filter(tool_name == "ORAS")  %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW_FTA, rocB_FTA)
roc.test(rocW_FTA, rocH_FTA)
roc.test(rocB_FTA, rocH_FTA)

rocW_newarrest <- roc(recid_arrested_flag ~ oras_risk_score, data = eval_df %>% filter(tool_name == "ORAS")  %>% filter(race == "White"), ci = T)
rocB_newarrest <- roc(recid_arrested_flag ~ oras_risk_score, data = eval_df %>% filter(tool_name == "ORAS")  %>% filter(race == "Black"), ci = T)
rocH_newarrest <- roc(recid_arrested_flag ~ oras_risk_score, data = eval_df %>% filter(tool_name == "ORAS")  %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW_newarrest, rocB_newarrest)
roc.test(rocW_newarrest, rocH_newarrest)
roc.test(rocB_newarrest, rocH_newarrest)

rocW_newfiling <- roc(recid_filed_flag ~ oras_risk_score, data = eval_df %>% filter(tool_name == "ORAS")  %>% filter(race == "White"), ci = T)
rocB_newfiling <- roc(recid_filed_flag ~ oras_risk_score, data = eval_df %>% filter(tool_name == "ORAS")  %>% filter(race == "Black"), ci = T)
rocH_newfiling <- roc(recid_filed_flag ~ oras_risk_score, data = eval_df %>% filter(tool_name == "ORAS")  %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW_newfiling, rocB_newfiling)
roc.test(rocW_newfiling, rocH_newfiling)
roc.test(rocB_newfiling, rocH_newfiling)

rocW_newconviction <- roc(recid_convicted_flag ~ oras_risk_score, data = eval_df %>% filter(tool_name == "ORAS")  %>% filter(race == "White"), ci = T)
rocB_newconviction <- roc(recid_convicted_flag ~ oras_risk_score, data = eval_df %>% filter(tool_name == "ORAS")  %>% filter(race == "Black"), ci = T)
rocH_newconviction <- roc(recid_convicted_flag ~ oras_risk_score, data = eval_df %>% filter(tool_name == "ORAS")  %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW_newconviction, rocB_newconviction)
roc.test(rocW_newconviction, rocH_newconviction)
roc.test(rocB_newconviction, rocH_newconviction)

rocW_newviolent <- roc(recid_arrest_violent_psa_flag ~ oras_risk_score, data = eval_df %>% filter(tool_name == "ORAS")  %>% filter(race == "White"), ci = T)
rocB_newviolent <- roc(recid_arrest_violent_psa_flag ~ oras_risk_score, data = eval_df %>% filter(tool_name == "ORAS")  %>% filter(race == "Black"), ci = T)
rocH_newviolent <- roc(recid_arrest_violent_psa_flag ~ oras_risk_score, data = eval_df %>% filter(tool_name == "ORAS")  %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW_newviolent, rocB_newviolent)
roc.test(rocW_newviolent, rocH_newviolent)
roc.test(rocB_newviolent, rocH_newviolent)
```

ORAS AUC gender comparisons
```{r}
rocW_FTA <- roc(fta_flag ~ oras_risk_score, data = eval_df %>% filter(tool_name == "ORAS")  %>% filter(sex == "Female"), ci = T)
rocM_FTA <- roc(fta_flag ~ oras_risk_score, data = eval_df %>% filter(tool_name == "ORAS")  %>% filter(sex == "Male"), ci = T)
roc.test(rocW_FTA, rocM_FTA)


rocW_newarrest <- roc(recid_arrested_flag ~ oras_risk_score, data = eval_df %>% filter(tool_name == "ORAS")  %>% filter(sex == "Female"), ci = T)
rocM_newarrest <- roc(recid_arrested_flag ~ oras_risk_score, data = eval_df %>% filter(tool_name == "ORAS")  %>% filter(sex == "Male"), ci = T)

roc.test(rocW_newarrest, rocM_newarrest)


rocW_newfiling <- roc(recid_filed_flag ~ oras_risk_score, data = eval_df %>% filter(tool_name == "ORAS")  %>% filter(sex == "Female"), ci = T)
rocM_newfiling <- roc(recid_filed_flag ~ oras_risk_score, data = eval_df %>% filter(tool_name == "ORAS")  %>% filter(sex == "Male"), ci = T)

roc.test(rocW_newfiling, rocM_newfiling)


rocW_newconviction <- roc(recid_convicted_flag ~ oras_risk_score, data = eval_df %>% filter(tool_name == "ORAS")  %>% filter(sex == "Female"), ci = T)
rocM_newconviction <- roc(recid_convicted_flag ~ oras_risk_score, data = eval_df %>% filter(tool_name == "ORAS")  %>% filter(sex == "Male"), ci = T)

roc.test(rocW_newconviction, rocM_newconviction)


rocW_newviolent <- roc(recid_arrest_violent_psa_flag ~ oras_risk_score, data = eval_df %>% filter(tool_name == "ORAS")  %>% filter(sex == "Female"), ci = T)
rocM_newviolent <- roc(recid_arrest_violent_psa_flag ~ oras_risk_score, data = eval_df %>% filter(tool_name == "ORAS")  %>% filter(sex == "Male"), ci = T)

roc.test(rocW_newviolent, rocM_newviolent)

```


Los Angeles PSA AUC race comparisons
```{r}
rocW_FTA <- roc(fta_flag ~ psa_fta_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Los Angeles") %>% filter(race == "White"), ci = T)
rocB_FTA <- roc(fta_flag ~ psa_fta_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Los Angeles") %>% filter(race == "Black"), ci = T)
rocH_FTA <- roc(fta_flag ~ psa_fta_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Los Angeles") %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW_FTA, rocB_FTA)
roc.test(rocW_FTA, rocH_FTA)
roc.test(rocB_FTA, rocH_FTA)

rocW_newarrest <- roc(recid_arrested_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Los Angeles") %>% filter(race == "White"), ci = T)
rocB_newarrest <- roc(recid_arrested_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Los Angeles") %>% filter(race == "Black"), ci = T)
rocH_newarrest <- roc(recid_arrested_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Los Angeles") %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW_newarrest, rocB_newarrest)
roc.test(rocW_newarrest, rocH_newarrest)
roc.test(rocB_newarrest, rocH_newarrest)

rocW_newfiling <- roc(recid_filed_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Los Angeles") %>% filter(race == "White"), ci = T)
rocB_newfiling <- roc(recid_filed_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Los Angeles") %>% filter(race == "Black"), ci = T)
rocH_newfiling <- roc(recid_filed_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Los Angeles") %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW_newfiling, rocB_newfiling)
roc.test(rocW_newfiling, rocH_newfiling)
roc.test(rocB_newfiling, rocH_newfiling)

rocW_newconviction <- roc(recid_convicted_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Los Angeles") %>% filter(race == "White"), ci = T)
rocB_newconviction <- roc(recid_convicted_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Los Angeles") %>% filter(race == "Black"), ci = T)
rocH_newconviction <- roc(recid_convicted_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Los Angeles") %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW_newconviction, rocB_newconviction)
roc.test(rocW_newconviction, rocH_newconviction)
roc.test(rocB_newconviction, rocH_newconviction)

rocW_newviolent <- roc(recid_arrest_violent_psa_flag ~ psa_nvca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Los Angeles") %>% filter(race == "White"), ci = T)
rocB_newviolent <- roc(recid_arrest_violent_psa_flag ~ psa_nvca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Los Angeles") %>% filter(race == "Black"), ci = T)
rocH_newviolent <- roc(recid_arrest_violent_psa_flag ~ psa_nvca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Los Angeles") %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW_newviolent, rocB_newviolent)
roc.test(rocW_newviolent, rocH_newviolent)
roc.test(rocB_newviolent, rocH_newviolent)
```

Los Angeles PSA AUC race comparisons
```{r}
rocM_FTA <- roc(fta_flag ~ psa_fta_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Los Angeles") %>% filter(sex == "Male"), ci = T)
rocW_FTA <- roc(fta_flag ~ psa_fta_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Los Angeles") %>% filter(sex == "Female"), ci = T)

roc.test(rocM_FTA, rocW_FTA)


rocM_newarrest <- roc(recid_arrested_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Los Angeles") %>% filter(sex == "Male"), ci = T)
rocW_newarrest <- roc(recid_arrested_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Los Angeles") %>% filter(sex == "Female"), ci = T)

roc.test(rocM_newarrest, rocW_newarrest)


rocM_newfiling <- roc(recid_filed_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Los Angeles") %>% filter(sex == "Male"), ci = T)
rocW_newfiling <- roc(recid_filed_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Los Angeles") %>% filter(sex == "Female"), ci = T)

roc.test(rocM_newfiling, rocW_newfiling)


rocM_newconviction <- roc(recid_convicted_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Los Angeles") %>% filter(sex == "Male"), ci = T)
rocW_newconviction <- roc(recid_convicted_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Los Angeles") %>% filter(sex == "Female"), ci = T)

roc.test(rocM_newconviction, rocW_newconviction)


rocM_newviolent <- roc(recid_arrest_violent_psa_flag ~ psa_nvca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Los Angeles") %>% filter(sex == "Male"), ci = T)
rocW_newviolent <- roc(recid_arrest_violent_psa_flag ~ psa_nvca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Los Angeles") %>% filter(sex == "Female"), ci = T)

roc.test(rocM_newviolent, rocW_newviolent)



```


Sacramento PSA AUC race comparisons
```{r}
rocW_FTA <- roc(fta_flag ~ psa_fta_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Sacramento") %>% filter(race == "White"), ci = T)
rocB_FTA <- roc(fta_flag ~ psa_fta_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Sacramento") %>% filter(race == "Black"), ci = T)
rocH_FTA <- roc(fta_flag ~ psa_fta_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Sacramento") %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW_FTA, rocB_FTA)
roc.test(rocW_FTA, rocH_FTA)
roc.test(rocB_FTA, rocH_FTA)

rocW_newarrest <- roc(recid_arrested_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Sacramento") %>% filter(race == "White"), ci = T)
rocB_newarrest <- roc(recid_arrested_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Sacramento") %>% filter(race == "Black"), ci = T)
rocH_newarrest <- roc(recid_arrested_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Sacramento") %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW_newarrest, rocB_newarrest)
roc.test(rocW_newarrest, rocH_newarrest)
roc.test(rocB_newarrest, rocH_newarrest)

rocW_newfiling <- roc(recid_filed_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Sacramento") %>% filter(race == "White"), ci = T)
rocB_newfiling <- roc(recid_filed_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Sacramento") %>% filter(race == "Black"), ci = T)
rocH_newfiling <- roc(recid_filed_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Sacramento") %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW_newfiling, rocB_newfiling)
roc.test(rocW_newfiling, rocH_newfiling)
roc.test(rocB_newfiling, rocH_newfiling)

rocW_newconviction <- roc(recid_convicted_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Sacramento") %>% filter(race == "White"), ci = T)
rocB_newconviction <- roc(recid_convicted_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Sacramento") %>% filter(race == "Black"), ci = T)
rocH_newconviction <- roc(recid_convicted_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Sacramento") %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW_newconviction, rocB_newconviction)
roc.test(rocW_newconviction, rocH_newconviction)
roc.test(rocB_newconviction, rocH_newconviction)

rocW_newviolent <- roc(recid_arrest_violent_psa_flag ~ psa_nvca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Sacramento") %>% filter(race == "White"), ci = T)
rocB_newviolent <- roc(recid_arrest_violent_psa_flag ~ psa_nvca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Sacramento") %>% filter(race == "Black"), ci = T)
rocH_newviolent <- roc(recid_arrest_violent_psa_flag ~ psa_nvca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Sacramento") %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW_newviolent, rocB_newviolent)
roc.test(rocW_newviolent, rocH_newviolent)
roc.test(rocB_newviolent, rocH_newviolent)
```

Sacramento PSA AUC gender comparisons
```{r}
rocW_FTA <- roc(fta_flag ~ psa_fta_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Sacramento") %>% filter(sex == "Female"), ci = T)
rocM_FTA <- roc(fta_flag ~ psa_fta_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Sacramento") %>% filter(sex == "Male"), ci = T)

roc.test(rocW_FTA, rocM_FTA)


rocW_newarrest <- roc(recid_arrested_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Sacramento") %>% filter(sex == "Female"), ci = T)
rocM_newarrest <- roc(recid_arrested_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Sacramento") %>% filter(sex == "Male"), ci = T)

roc.test(rocW_newarrest, rocM_newarrest)


rocW_newfiling <- roc(recid_filed_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Sacramento") %>% filter(sex == "Female"), ci = T)
rocM_newfiling <- roc(recid_filed_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Sacramento") %>% filter(sex == "Male"), ci = T)

roc.test(rocW_newfiling, rocM_newfiling)


rocW_newconviction <- roc(recid_convicted_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Sacramento") %>% filter(sex == "Female"), ci = T)
rocM_newconviction <- roc(recid_convicted_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Sacramento") %>% filter(sex == "Male"), ci = T)

roc.test(rocW_newconviction, rocM_newconviction)


rocW_newviolent <- roc(recid_arrest_violent_psa_flag ~ psa_nvca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Sacramento") %>% filter(sex == "Female"), ci = T)
rocM_newviolent <- roc(recid_arrest_violent_psa_flag ~ psa_nvca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Sacramento") %>% filter(sex == "Male"), ci = T)

roc.test(rocW_newviolent, rocM_newviolent)

```


Alameda VPRAI-R AUC race comparisons
```{r}
rocW_FTA <- roc(fta_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R") %>% filter(county == "Alameda") %>% filter(race == "White"), ci = T)
rocB_FTA <- roc(fta_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R") %>% filter(county == "Alameda") %>% filter(race == "Black"), ci = T)
rocH_FTA <- roc(fta_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R") %>% filter(county == "Alameda") %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW_FTA, rocB_FTA)
roc.test(rocW_FTA, rocH_FTA)
roc.test(rocB_FTA, rocH_FTA)

rocW_newarrest <- roc(recid_arrested_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R") %>% filter(county == "Alameda") %>% filter(race == "White"), ci = T)
rocB_newarrest <- roc(recid_arrested_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R") %>% filter(county == "Alameda") %>% filter(race == "Black"), ci = T)
rocH_newarrest <- roc(recid_arrested_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R") %>% filter(county == "Alameda") %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW_newarrest, rocB_newarrest)
roc.test(rocW_newarrest, rocH_newarrest)
roc.test(rocB_newarrest, rocH_newarrest)

rocW_newfiling <- roc(recid_filed_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R") %>% filter(county == "Alameda") %>% filter(race == "White"), ci = T)
rocB_newfiling <- roc(recid_filed_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R") %>% filter(county == "Alameda") %>% filter(race == "Black"), ci = T)
rocH_newfiling <- roc(recid_filed_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R") %>% filter(county == "Alameda") %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW_newfiling, rocB_newfiling)
roc.test(rocW_newfiling, rocH_newfiling)
roc.test(rocB_newfiling, rocH_newfiling)

rocW_newconviction <- roc(recid_convicted_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R") %>% filter(county == "Alameda") %>% filter(race == "White"), ci = T)
rocB_newconviction <- roc(recid_convicted_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R") %>% filter(county == "Alameda") %>% filter(race == "Black"), ci = T)
rocH_newconviction <- roc(recid_convicted_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R") %>% filter(county == "Alameda") %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW_newconviction, rocB_newconviction)
roc.test(rocW_newconviction, rocH_newconviction)
roc.test(rocB_newconviction, rocH_newconviction)

rocW_newviolent <- roc(recid_arrest_violent_psa_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R") %>% filter(county == "Alameda") %>% filter(race == "White"), ci = T)
rocB_newviolent <- roc(recid_arrest_violent_psa_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R") %>% filter(county == "Alameda") %>% filter(race == "Black"), ci = T)
rocH_newviolent <- roc(recid_arrest_violent_psa_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R") %>% filter(county == "Alameda") %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW_newviolent, rocB_newviolent)
roc.test(rocW_newviolent, rocH_newviolent)
roc.test(rocB_newviolent, rocH_newviolent)

rocW_anyfailure <- roc(any_pretrial_failure_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R") %>% filter(county == "Alameda") %>% filter(race == "White"), ci = T)
rocB_anyfailure <- roc(any_pretrial_failure_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R") %>% filter(county == "Alameda") %>% filter(race == "Black"), ci = T)
rocH_anyfailure <- roc(any_pretrial_failure_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R") %>% filter(county == "Alameda") %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW_anyfailure, rocB_anyfailure)
roc.test(rocW_anyfailure, rocH_anyfailure)
roc.test(rocB_anyfailure, rocH_anyfailure)
```

Alameda VPRAI-R AUC gender comparisons
```{r}
rocW_FTA <- roc(fta_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R") %>% filter(county == "Alameda") %>% filter(sex == "Female"), ci = T)
rocM_FTA <- roc(fta_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R") %>% filter(county == "Alameda") %>% filter(sex == "Male"), ci = T)

roc.test(rocW_FTA, rocM_FTA)


rocW_newarrest <- roc(recid_arrested_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R") %>% filter(county == "Alameda") %>% filter(sex == "Female"), ci = T)
rocM_newarrest <- roc(recid_arrested_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R") %>% filter(county == "Alameda") %>% filter(sex == "Male"), ci = T)

roc.test(rocW_newarrest, rocM_newarrest)


rocW_newfiling <- roc(recid_filed_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R") %>% filter(county == "Alameda") %>% filter(sex == "Female"), ci = T)
rocM_newfiling <- roc(recid_filed_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R") %>% filter(county == "Alameda") %>% filter(sex == "Male"), ci = T)

roc.test(rocW_newfiling, rocM_newfiling)


rocW_newconviction <- roc(recid_convicted_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R") %>% filter(county == "Alameda") %>% filter(sex == "Female"), ci = T)
rocM_newconviction <- roc(recid_convicted_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R") %>% filter(county == "Alameda") %>% filter(sex == "Male"), ci = T)

roc.test(rocW_newconviction, rocM_newconviction)


rocW_newviolent <- roc(recid_arrest_violent_psa_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R") %>% filter(county == "Alameda") %>% filter(sex == "Female"), ci = T)
rocM_newviolent <- roc(recid_arrest_violent_psa_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R") %>% filter(county == "Alameda") %>% filter(sex == "Male"), ci = T)

roc.test(rocW_newviolent, rocM_newviolent)


rocW_anyfailure <- roc(any_pretrial_failure_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R") %>% filter(county == "Alameda") %>% filter(sex == "Female"), ci = T)
rocM_anyfailure <- roc(any_pretrial_failure_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R") %>% filter(county == "Alameda") %>% filter(sex == "Male"), ci = T)

roc.test(rocW_anyfailure, rocM_anyfailure)

```


San Mateo VPRAI-R AUC race comparisons
```{r}
rocW_FTA <- roc(fta_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R") %>% filter(county == "San Mateo") %>% filter(race == "White"), ci = T)
rocB_FTA <- roc(fta_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R") %>% filter(county == "San Mateo") %>% filter(race == "Black"), ci = T)
rocH_FTA <- roc(fta_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R") %>% filter(county == "San Mateo") %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW_FTA, rocB_FTA)
roc.test(rocW_FTA, rocH_FTA)
roc.test(rocB_FTA, rocH_FTA)

rocW_newarrest <- roc(recid_arrested_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R") %>% filter(county == "San Mateo") %>% filter(race == "White"), ci = T)
rocB_newarrest <- roc(recid_arrested_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R") %>% filter(county == "San Mateo") %>% filter(race == "Black"), ci = T)
rocH_newarrest <- roc(recid_arrested_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R") %>% filter(county == "San Mateo") %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW_newarrest, rocB_newarrest)
roc.test(rocW_newarrest, rocH_newarrest)
roc.test(rocB_newarrest, rocH_newarrest)

rocW_newfiling <- roc(recid_filed_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R") %>% filter(county == "San Mateo") %>% filter(race == "White"), ci = T)
rocB_newfiling <- roc(recid_filed_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R") %>% filter(county == "San Mateo") %>% filter(race == "Black"), ci = T)
rocH_newfiling <- roc(recid_filed_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R") %>% filter(county == "San Mateo") %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW_newfiling, rocB_newfiling)
roc.test(rocW_newfiling, rocH_newfiling)
roc.test(rocB_newfiling, rocH_newfiling)

rocW_newconviction <- roc(recid_convicted_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R") %>% filter(county == "San Mateo") %>% filter(race == "White"), ci = T)
rocB_newconviction <- roc(recid_convicted_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R") %>% filter(county == "San Mateo") %>% filter(race == "Black"), ci = T)
rocH_newconviction <- roc(recid_convicted_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R") %>% filter(county == "San Mateo") %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW_newconviction, rocB_newconviction)
roc.test(rocW_newconviction, rocH_newconviction)
roc.test(rocB_newconviction, rocH_newconviction)

rocW_newviolent <- roc(recid_arrest_violent_psa_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R") %>% filter(county == "San Mateo") %>% filter(race == "White"), ci = T)
rocB_newviolent <- roc(recid_arrest_violent_psa_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R") %>% filter(county == "San Mateo") %>% filter(race == "Black"), ci = T)
rocH_newviolent <- roc(recid_arrest_violent_psa_flag ~ vprair_risk_score, data = eval_df %>% filter(tool_name == "VPRAI-R") %>% filter(county == "San Mateo") %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW_newviolent, rocB_newviolent)
roc.test(rocW_newviolent, rocH_newviolent)
roc.test(rocB_newviolent, rocH_newviolent)
```

Tulare PSA AUC race comparisons
```{r}
rocW_FTA <- roc(fta_flag ~ psa_fta_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Tulare") %>% filter(race == "White"), ci = T)
rocB_FTA <- roc(fta_flag ~ psa_fta_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Tulare") %>% filter(race == "Black"), ci = T)
rocH_FTA <- roc(fta_flag ~ psa_fta_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Tulare") %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW_FTA, rocB_FTA)
roc.test(rocW_FTA, rocH_FTA)
roc.test(rocB_FTA, rocH_FTA)

rocW_newarrest <- roc(recid_arrested_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Tulare") %>% filter(race == "White"), ci = T)
rocB_newarrest <- roc(recid_arrested_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Tulare") %>% filter(race == "Black"), ci = T)
rocH_newarrest <- roc(recid_arrested_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Tulare") %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW_newarrest, rocB_newarrest)
roc.test(rocW_newarrest, rocH_newarrest)
roc.test(rocB_newarrest, rocH_newarrest)

rocW_newfiling <- roc(recid_filed_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Tulare") %>% filter(race == "White"), ci = T)
rocB_newfiling <- roc(recid_filed_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Tulare") %>% filter(race == "Black"), ci = T)
rocH_newfiling <- roc(recid_filed_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Tulare") %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW_newfiling, rocB_newfiling)
roc.test(rocW_newfiling, rocH_newfiling)
roc.test(rocB_newfiling, rocH_newfiling)

rocW_newconviction <- roc(recid_convicted_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Tulare") %>% filter(race == "White"), ci = T)
rocB_newconviction <- roc(recid_convicted_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Tulare") %>% filter(race == "Black"), ci = T)
rocH_newconviction <- roc(recid_convicted_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Tulare") %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW_newconviction, rocB_newconviction)
roc.test(rocW_newconviction, rocH_newconviction)
roc.test(rocB_newconviction, rocH_newconviction)

rocW_newviolent <- roc(recid_arrest_violent_psa_flag ~ psa_nvca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Tulare") %>% filter(race == "White"), ci = T)
rocB_newviolent <- roc(recid_arrest_violent_psa_flag ~ psa_nvca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Tulare") %>% filter(race == "Black"), ci = T)
rocH_newviolent <- roc(recid_arrest_violent_psa_flag ~ psa_nvca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Tulare") %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW_newviolent, rocB_newviolent)
roc.test(rocW_newviolent, rocH_newviolent)
roc.test(rocB_newviolent, rocH_newviolent)
```

Tulare PSA AUC gender comparisons
```{r}
rocM_FTA <- roc(fta_flag ~ psa_fta_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Tulare") %>% filter(sex == "Male"), ci = T)
rocW_FTA <- roc(fta_flag ~ psa_fta_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Tulare") %>% filter(sex == "Female"), ci = T)

roc.test(rocM_FTA, rocW_FTA)


rocM_newarrest <- roc(recid_arrested_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Tulare") %>% filter(sex == "Male"), ci = T)
rocW_newarrest <- roc(recid_arrested_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Tulare") %>% filter(sex == "Female"), ci = T)

roc.test(rocM_newarrest, rocW_newarrest)


rocM_newfiling <- roc(recid_filed_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Tulare") %>% filter(sex == "Male"), ci = T)
rocW_newfiling <- roc(recid_filed_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Tulare") %>% filter(sex == "Female"), ci = T)

roc.test(rocM_newfiling, rocW_newfiling)


rocM_newconviction <- roc(recid_convicted_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Tulare") %>% filter(sex == "Male"), ci = T)
rocW_newconviction <- roc(recid_convicted_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Tulare") %>% filter(sex == "Female"), ci = T)

roc.test(rocM_newconviction, rocW_newconviction)


rocM_newviolent <- roc(recid_arrest_violent_psa_flag ~ psa_nvca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Tulare") %>% filter(sex == "Male"), ci = T)
rocW_newviolent <- roc(recid_arrest_violent_psa_flag ~ psa_nvca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Tulare") %>% filter(sex == "Female"), ci = T)

roc.test(rocM_newviolent, rocW_newviolent)



```

Sonoma PSA AUC race comparisons
```{r}
rocW_FTA <- roc(fta_flag ~ psa_fta_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Sonoma") %>% filter(race == "White"), ci = T)
#rocB_FTA <- roc(fta_flag ~ psa_fta_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Sonoma") %>% filter(race == "Black"), ci = T)
rocH_FTA <- roc(fta_flag ~ psa_fta_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Sonoma") %>% filter(race == "Hispanic"), ci = T)
#roc.test(rocW_FTA, rocB_FTA)
roc.test(rocW_FTA, rocH_FTA)
#roc.test(rocB_FTA, rocH_FTA)

rocW_newarrest <- roc(recid_arrested_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Sonoma") %>% filter(race == "White"), ci = T)
#rocB_newarrest <- roc(recid_arrested_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Sonoma") %>% filter(race == "Black"), ci = T)
rocH_newarrest <- roc(recid_arrested_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Sonoma") %>% filter(race == "Hispanic"), ci = T)
#roc.test(rocW_newarrest, rocB_newarrest)
roc.test(rocW_newarrest, rocH_newarrest)
#roc.test(rocB_newarrest, rocH_newarrest)

rocW_newfiling <- roc(recid_filed_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Sonoma") %>% filter(race == "White"), ci = T)
#rocB_newfiling <- roc(recid_filed_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Sonoma") %>% filter(race == "Black"), ci = T)
rocH_newfiling <- roc(recid_filed_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Sonoma") %>% filter(race == "Hispanic"), ci = T)
#roc.test(rocW_newfiling, rocB_newfiling)
roc.test(rocW_newfiling, rocH_newfiling)
#roc.test(rocB_newfiling, rocH_newfiling)

rocW_newconviction <- roc(recid_convicted_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Sonoma") %>% filter(race == "White"), ci = T)
#rocB_newconviction <- roc(recid_convicted_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Sonoma") %>% filter(race == "Black"), ci = T)
rocH_newconviction <- roc(recid_convicted_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Sonoma") %>% filter(race == "Hispanic"), ci = T)
#roc.test(rocW_newconviction, rocB_newconviction)
roc.test(rocW_newconviction, rocH_newconviction)
#roc.test(rocB_newconviction, rocH_newconviction)

rocW_newviolent <- roc(recid_arrest_violent_psa_flag ~ psa_nvca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Sonoma") %>% filter(race == "White"), ci = T)
#rocB_newviolent <- roc(recid_arrest_violent_psa_flag ~ psa_nvca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Sonoma") %>% filter(race == "Black"), ci = T)
rocH_newviolent <- roc(recid_arrest_violent_psa_flag ~ psa_nvca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Sonoma") %>% filter(race == "Hispanic"), ci = T)
#roc.test(rocW_newviolent, rocB_newviolent)
roc.test(rocW_newviolent, rocH_newviolent)
#roc.test(rocB_newviolent, rocH_newviolent)
```

Sonoma PSA AUC gender comparisons
```{r}
rocM_FTA <- roc(fta_flag ~ psa_fta_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Sonoma") %>% filter(sex == "Male"), ci = T)
rocW_FTA <- roc(fta_flag ~ psa_fta_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Sonoma") %>% filter(sex == "Female"), ci = T)

roc.test(rocM_FTA, rocW_FTA)


rocM_newarrest <- roc(recid_arrested_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Sonoma") %>% filter(sex == "Male"), ci = T)
rocW_newarrest <- roc(recid_arrested_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Sonoma") %>% filter(sex == "Female"), ci = T)

roc.test(rocM_newarrest, rocW_newarrest)


rocM_newfiling <- roc(recid_filed_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Sonoma") %>% filter(sex == "Male"), ci = T)
rocW_newfiling <- roc(recid_filed_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Sonoma") %>% filter(sex == "Female"), ci = T)

roc.test(rocM_newfiling, rocW_newfiling)


rocM_newconviction <- roc(recid_convicted_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Sonoma") %>% filter(sex == "Male"), ci = T)
rocW_newconviction <- roc(recid_convicted_flag ~ psa_nca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Sonoma") %>% filter(sex == "Female"), ci = T)

roc.test(rocM_newconviction, rocW_newconviction)


rocM_newviolent <- roc(recid_arrest_violent_psa_flag ~ psa_nvca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Sonoma") %>% filter(sex == "Male"), ci = T)
rocW_newviolent <- roc(recid_arrest_violent_psa_flag ~ psa_nvca_risk_score, data = eval_df %>% filter(tool_name == "PSA") %>% filter(county == "Sonoma") %>% filter(sex == "Female"), ci = T)

roc.test(rocM_newviolent, rocW_newviolent)



```


Ventura ORAS AUC race comparisons
```{r}
rocW_FTA <- roc(fta_flag ~ oras_risk_score, data = eval_df %>% filter(tool_name == "ORAS") %>% filter(county == "Ventura") %>% filter(race == "White"), ci = T)
#rocB_FTA <- roc(fta_flag ~ oras_risk_score, data = eval_df %>% filter(tool_name == "ORAS") %>% filter(county == "Ventura") %>% filter(race == "Black"), ci = T)
rocH_FTA <- roc(fta_flag ~ oras_risk_score, data = eval_df %>% filter(tool_name == "ORAS") %>% filter(county == "Ventura") %>% filter(race == "Hispanic"), ci = T)
#roc.test(rocW_FTA, rocB_FTA)
roc.test(rocW_FTA, rocH_FTA)
#roc.test(rocB_FTA, rocH_FTA)

rocW_newarrest <- roc(recid_arrested_flag ~ oras_risk_score, data = eval_df %>% filter(tool_name == "ORAS") %>% filter(county == "Ventura") %>% filter(race == "White"), ci = T)
rocB_newarrest <- roc(recid_arrested_flag ~ oras_risk_score, data = eval_df %>% filter(tool_name == "ORAS") %>% filter(county == "Ventura") %>% filter(race == "Black"), ci = T)
rocH_newarrest <- roc(recid_arrested_flag ~ oras_risk_score, data = eval_df %>% filter(tool_name == "ORAS") %>% filter(county == "Ventura") %>% filter(race == "Hispanic"), ci = T)
#roc.test(rocW_newarrest, rocB_newarrest)
roc.test(rocW_newarrest, rocH_newarrest)
#roc.test(rocB_newarrest, rocH_newarrest)

rocW_newfiling <- roc(recid_filed_flag ~ oras_risk_score, data = eval_df %>% filter(tool_name == "ORAS") %>% filter(county == "Ventura") %>% filter(race == "White"), ci = T)
#rocB_newfiling <- roc(recid_filed_flag ~ oras_risk_score, data = eval_df %>% filter(tool_name == "ORAS") %>% filter(county == "Ventura") %>% filter(race == "Black"), ci = T)
rocH_newfiling <- roc(recid_filed_flag ~ oras_risk_score, data = eval_df %>% filter(tool_name == "ORAS") %>% filter(county == "Ventura") %>% filter(race == "Hispanic"), ci = T)
#roc.test(rocW_newfiling, rocB_newfiling)
roc.test(rocW_newfiling, rocH_newfiling)
#roc.test(rocB_newfiling, rocH_newfiling)

rocW_newconviction <- roc(recid_convicted_flag ~ oras_risk_score, data = eval_df %>% filter(tool_name == "ORAS") %>% filter(county == "Ventura") %>% filter(race == "White"), ci = T)
#rocB_newconviction <- roc(recid_convicted_flag ~ oras_risk_score, data = eval_df %>% filter(tool_name == "ORAS") %>% filter(county == "Ventura") %>% filter(race == "Black"), ci = T)
rocH_newconviction <- roc(recid_convicted_flag ~ oras_risk_score, data = eval_df %>% filter(tool_name == "ORAS") %>% filter(county == "Ventura") %>% filter(race == "Hispanic"), ci = T)
#roc.test(rocW_newconviction, rocB_newconviction)
roc.test(rocW_newconviction, rocH_newconviction)
#roc.test(rocB_newconviction, rocH_newconviction)

rocW_newviolent <- roc(recid_arrest_violent_psa_flag ~ oras_risk_score, data = eval_df %>% filter(tool_name == "ORAS") %>% filter(county == "Ventura") %>% filter(race == "White"), ci = T)
#rocB_newviolent <- roc(recid_arrest_violent_psa_flag ~ oras_risk_score, data = eval_df %>% filter(tool_name == "ORAS") %>% filter(county == "Ventura") %>% filter(race == "Black"), ci = T)
rocH_newviolent <- roc(recid_arrest_violent_psa_flag ~ oras_risk_score, data = eval_df %>% filter(tool_name == "ORAS") %>% filter(county == "Ventura") %>% filter(race == "Hispanic"), ci = T)
#roc.test(rocW_newviolent, rocB_newviolent)
roc.test(rocW_newviolent, rocH_newviolent)
#roc.test(rocB_newviolent, rocH_newviolent)
```


Ventura ORAS AUC gender comparisons
```{r}
rocW_FTA <- roc(fta_flag ~ oras_risk_score, data = eval_df %>% filter(tool_name == "ORAS") %>% filter(county == "Ventura") %>% filter(sex == "Female"), ci = T)
rocM_FTA <- roc(fta_flag ~ oras_risk_score, data = eval_df %>% filter(tool_name == "ORAS") %>% filter(county == "Ventura") %>% filter(sex == "Male"), ci = T)
roc.test(rocW_FTA, rocM_FTA)


rocW_newarrest <- roc(recid_arrested_flag ~ oras_risk_score, data = eval_df %>% filter(tool_name == "ORAS") %>% filter(county == "Ventura") %>% filter(sex == "Female"), ci = T)
rocM_newarrest <- roc(recid_arrested_flag ~ oras_risk_score, data = eval_df %>% filter(tool_name == "ORAS") %>% filter(county == "Ventura") %>% filter(sex == "Male"), ci = T)

roc.test(rocW_newarrest, rocM_newarrest)


rocW_newfiling <- roc(recid_filed_flag ~ oras_risk_score, data = eval_df %>% filter(tool_name == "ORAS") %>% filter(county == "Ventura") %>% filter(sex == "Female"), ci = T)
rocM_newfiling <- roc(recid_filed_flag ~ oras_risk_score, data = eval_df %>% filter(tool_name == "ORAS") %>% filter(county == "Ventura") %>% filter(sex == "Male"), ci = T)

roc.test(rocW_newfiling, rocM_newfiling)


rocW_newconviction <- roc(recid_convicted_flag ~ oras_risk_score, data = eval_df %>% filter(tool_name == "ORAS") %>% filter(county == "Ventura") %>% filter(sex == "Female"), ci = T)
rocM_newconviction <- roc(recid_convicted_flag ~ oras_risk_score, data = eval_df %>% filter(tool_name == "ORAS") %>% filter(county == "Ventura") %>% filter(sex == "Male"), ci = T)

roc.test(rocW_newconviction, rocM_newconviction)


rocW_newviolent <- roc(recid_arrest_violent_psa_flag ~ oras_risk_score, data = eval_df %>% filter(tool_name == "ORAS") %>% filter(county == "Ventura") %>% filter(sex == "Female"), ci = T)
rocM_newviolent <- roc(recid_arrest_violent_psa_flag ~ oras_risk_score, data = eval_df %>% filter(tool_name == "ORAS") %>% filter(county == "Ventura") %>% filter(sex == "Male"), ci = T)

roc.test(rocW_newviolent, rocM_newviolent)

```


San Joaquin VPRAI AUC race comparisons
```{r}
rocW_FTA <- roc(fta_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI") %>% filter(county == "San Joaquin") %>% filter(race == "White"), ci = T)
rocB_FTA <- roc(fta_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI") %>% filter(county == "San Joaquin") %>% filter(race == "Black"), ci = T)
rocH_FTA <- roc(fta_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI") %>% filter(county == "San Joaquin") %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW_FTA, rocB_FTA)
roc.test(rocW_FTA, rocH_FTA)
roc.test(rocB_FTA, rocH_FTA)

rocW_newarrest <- roc(recid_arrested_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI") %>% filter(county == "San Joaquin") %>% filter(race == "White"), ci = T)
rocB_newarrest <- roc(recid_arrested_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI") %>% filter(county == "San Joaquin") %>% filter(race == "Black"), ci = T)
rocH_newarrest <- roc(recid_arrested_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI") %>% filter(county == "San Joaquin") %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW_newarrest, rocB_newarrest)
roc.test(rocW_newarrest, rocH_newarrest)
roc.test(rocB_newarrest, rocH_newarrest)

rocW_newfiling <- roc(recid_filed_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI") %>% filter(county == "San Joaquin") %>% filter(race == "White"), ci = T)
rocB_newfiling <- roc(recid_filed_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI") %>% filter(county == "San Joaquin") %>% filter(race == "Black"), ci = T)
rocH_newfiling <- roc(recid_filed_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI") %>% filter(county == "San Joaquin") %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW_newfiling, rocB_newfiling)
roc.test(rocW_newfiling, rocH_newfiling)
roc.test(rocB_newfiling, rocH_newfiling)

rocW_newconviction <- roc(recid_convicted_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI") %>% filter(county == "San Joaquin") %>% filter(race == "White"), ci = T)
rocB_newconviction <- roc(recid_convicted_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI") %>% filter(county == "San Joaquin") %>% filter(race == "Black"), ci = T)
rocH_newconviction <- roc(recid_convicted_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI") %>% filter(county == "San Joaquin") %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW_newconviction, rocB_newconviction)
roc.test(rocW_newconviction, rocH_newconviction)
roc.test(rocB_newconviction, rocH_newconviction)

rocW_newviolent <- roc(recid_arrest_violent_psa_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI") %>% filter(county == "San Joaquin") %>% filter(race == "White"), ci = T)
rocB_newviolent <- roc(recid_arrest_violent_psa_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI") %>% filter(county == "San Joaquin") %>% filter(race == "Black"), ci = T)
rocH_newviolent <- roc(recid_arrest_violent_psa_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI") %>% filter(county == "San Joaquin") %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW_newviolent, rocB_newviolent)
roc.test(rocW_newviolent, rocH_newviolent)
roc.test(rocB_newviolent, rocH_newviolent)

rocW_anyfailure <- roc(any_pretrial_failure_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI") %>% filter(county == "San Joaquin") %>% filter(race == "White"), ci = T)
rocB_anyfailure <- roc(any_pretrial_failure_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI") %>% filter(county == "San Joaquin") %>% filter(race == "Black"), ci = T)
rocH_anyfailure <- roc(any_pretrial_failure_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI") %>% filter(county == "San Joaquin") %>% filter(race == "Hispanic"), ci = T)
roc.test(rocW_anyfailure, rocB_anyfailure)
roc.test(rocW_anyfailure, rocH_anyfailure)
roc.test(rocB_anyfailure, rocH_anyfailure)
```


San Joaquin VPRAI AUC gender comparisons
```{r}
rocW_FTA <- roc(fta_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI") %>% filter(county == "San Joaquin") %>% filter(sex == "Female"), ci = T)
rocM_FTA <- roc(fta_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI") %>% filter(county == "San Joaquin") %>% filter(sex == "Male"), ci = T)
roc.test(rocW_FTA, rocM_FTA)


rocW_newarrest <- roc(recid_arrested_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI") %>% filter(county == "San Joaquin") %>% filter(sex == "Female"), ci = T)
rocM_newarrest <- roc(recid_arrested_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI") %>% filter(county == "San Joaquin") %>% filter(sex == "Male"), ci = T)

roc.test(rocW_newarrest, rocM_newarrest)


rocW_newfiling <- roc(recid_filed_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI") %>% filter(county == "San Joaquin") %>% filter(sex == "Female"), ci = T)
rocM_newfiling <- roc(recid_filed_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI") %>% filter(county == "San Joaquin") %>% filter(sex == "Male"), ci = T)

roc.test(rocW_newfiling, rocM_newfiling)


rocW_newconviction <- roc(recid_convicted_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI") %>% filter(county == "San Joaquin") %>% filter(sex == "Female"), ci = T)
rocM_newconviction <- roc(recid_convicted_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI") %>% filter(county == "San Joaquin") %>% filter(sex == "Male"), ci = T)

roc.test(rocW_newconviction, rocM_newconviction)


rocW_newviolent <- roc(recid_arrest_violent_psa_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI") %>% filter(county == "San Joaquin") %>% filter(sex == "Female"), ci = T)
rocM_newviolent <- roc(recid_arrest_violent_psa_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI") %>% filter(county == "San Joaquin") %>% filter(sex == "Male"), ci = T)

roc.test(rocW_newviolent, rocM_newviolent)


rocW_anyfailure <- roc(any_pretrial_failure_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI") %>% filter(county == "San Joaquin") %>% filter(sex == "Female"), ci = T)
rocM_anyfailure <- roc(any_pretrial_failure_flag ~ vprai_risk_score, data = eval_df %>% filter(tool_name == "VPRAI") %>% filter(county == "San Joaquin") %>% filter(sex == "Male"), ci = T)

roc.test(rocW_anyfailure, rocM_anyfailure)

```


# KNITR EXIT -----------------------------------------------
```{r}
knitr::knit_exit()
```


# Exploration of Supervision
```{r}
eval_df %>%
  mutate(monitoring_level_grouped = if_else(grepl("Own Recognizance", monitoring_level_grouped), "Own Recognizance", monitoring_level_grouped)) %>%
  mutate(monitoring_level_grouped = if_else(monitoring_level_grouped %in% c("Lowest Levels", "Medium Levels", "Highest Levels", "Own Recognizance"), monitoring_level_grouped, NA_character_)) %>%
  group_by(county) %>%
  mutate(totn = sum(booking_assessed_count)) %>%
  group_by(county, monitoring_level_grouped) %>%
  summarise(group_count = sum(booking_assessed_count), total = mean(totn), percent = round(group_count/total*100)) %>%
  select(-group_count) %>%
  pivot_wider(names_from = monitoring_level_grouped, values_from = percent) %>%
  select(total, 'Own Recognizance', 'Lowest Levels', 'Medium Levels', 'Highest Levels', 'NA')

eval_df %>%
  mutate(monitoring_level_grouped = if_else(grepl("Own Recognizance", monitoring_level_grouped), "Own Recognizance", monitoring_level_grouped)) %>%
  mutate(monitoring_level_grouped = if_else(monitoring_level_grouped %in% c("Lowest Levels", "Medium Levels", "Highest Levels", "Own Recognizance"), monitoring_level_grouped, NA_character_)) %>%
  mutate(bail_flag = if_else(release_type == "Bail Bond", 1, 0)) %>%
  count(bail_flag, monitoring_level_grouped)

eval_df <- eval_df %>%
  mutate(monitoring_level_grouped = if_else(grepl("Own Recognizance", monitoring_level_grouped), "Own Recognizance", monitoring_level_grouped)) %>%
  mutate(monitoring_level_grouped = if_else(monitoring_level_grouped %in% c("Lowest Levels", "Medium Levels", "Highest Levels", "Own Recognizance"), monitoring_level_grouped, NA_character_)) %>%
  mutate(bail_or_sup = case_when(release_type %in% c("Bail Bond") ~ "Bail Bond",
                                 !is.na(monitoring_level_grouped) ~ monitoring_level_grouped,
                                 release_type %in% c("Own Recognizance") ~ "Own Recognizance",
                                 release_type %in% c("Cite Release", "CiteR elease") ~ "Cite Release")) 
  
  
eval_df %>%
  count(release_type)

eval_df %>%
  count(county, bail_or_sup) %>%
  pivot_wider(names_from = bail_or_sup, values_from = n)
```
Sacramento with supervision
```{r}
county_df <- eval_df %>%
  filter(county == "Sacramento", tool_name == "PSA")

m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score + release_to_pretrial_end + bail_or_sup, data = county_df %>% filter(!is.na(psa_fta_risk_score)))
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score + release_to_pretrial_end + bail_or_sup, data = county_df %>% filter(!is.na(psa_nca_risk_score)))
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score + release_to_pretrial_end + bail_or_sup, data = county_df %>% filter(!is.na(psa_nca_risk_score)))
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score + release_to_pretrial_end + bail_or_sup, data = county_df %>% filter(!is.na(psa_nca_risk_score)))
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score + release_to_pretrial_end + bail_or_sup, data = county_df %>% filter(!is.na(psa_nvca_risk_score)))

summary(m1)
summary(m2)
summary(m3)
summary(m4)
summary(m5)

# eval_df %>%
#   count(county, bail_or_sup)
```

Sacramento graphs by supervision
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  filter(county == "Sacramento") %>%
  filter(tool_name == "PSA") %>%
  group_by(psa_fta_risk_score, bail_or_sup, county) %>%
  select(fta_flag) %>%
  pivot_longer(fta_flag) 

names(risk_df)[1] <- "psa_risk_score"

risk_df2 <- eval_df %>%
  filter(county == "Sacramento") %>%
  filter(tool_name == "PSA") %>%
  group_by(psa_nca_risk_score, bail_or_sup, county) %>%
  select(recid_arrested_flag, recid_filed_flag, recid_convicted_flag) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[1] <- "psa_risk_score"

risk_df3 <- eval_df %>%
  filter(county == "Sacramento") %>%
  filter(tool_name == "PSA", !is.na(psa_nvca_risk_score)) %>%
  group_by(psa_nvca_risk_score, bail_or_sup, county) %>%
  select(recid_arrest_violent_psa_flag) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[1] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(race = factor(bail_or_sup, levels = c("Cite Release", "Own Recognizance", "Bail Bond", "Lowest Levels", "Medium Levels", "Highest Levels"))) %>%
  filter(!is.na(bail_or_sup)) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) %>%
  filter(county %in% c("Los Angeles", "Sacramento"))

ggplot(risk_df) +
  aes(x = psa_risk_score, y = value, color = bail_or_sup) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent", title = "Comparison of Release Differences in Logistic Regression Curves--PSA, Sacramento") +
  scale_x_continuous(breaks = 1:6)


```

```{r}
ggplot(risk_df %>%
         filter(bail_or_sup %in% c("Lowest Levels", "Medium Levels", "Highest Levels", "Bail Bond"))) +
  aes(x = psa_risk_score, y = value, color = bail_or_sup) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent", title = "Comparison of Release Differences in Logistic Regression Curves--PSA, Sacramento") +
  scale_x_continuous(breaks = 1:6)

```

Extra table for Deirdre
```{r}
ab74_df <- join_df %>%
  filter(booking_date >= as.Date("2019-10-01")) %>%
  filter(booking_assessed_count == 1,
         scored_assessment == 1,
         release_eligible_count ==1,
         released_pretrial_count == 1,
         pretrial_period_end_count == 1,
         booking_date < as.Date("2022-01-01"),
         tool_name %in% c("ORAS", "PSA", "VPRAI", "VPRAI-R", "VPRAIO")
         ) %>%
  mutate(release_to_pretrial_end = pretrial_period_end_date - release_date)

ab74_df <- ab74_df %>%
  mutate(monitor_level = monitoring_level_grouped) %>%
  mutate(County = county)
```
For Deirdre - 2G by misdo/felony
```{r message=FALSE, warning=FALSE}
sup_df <- ab74_df %>%
  filter(monitor_level %in% c("Lowest Levels", "Medium Levels", "Highest Levels")) %>%
  mutate(monitor_level = factor(monitor_level, levels =  c("Lowest Levels", "Medium Levels", "Highest Levels"))) %>%
  # filter(County != "San Joaquin") %>%
  mutate(revoked_flag = if_else(fta_flag == 1|recid_arrested_flag == 1|pretrial_termination_outcome == "Unsuccessful", 1, 0)) %>%
  mutate(revoked_flag = if_else(is.na(revoked_flag), 0, revoked_flag)) 

#Aggregated 

outcome_df <- sup_df %>%
  filter(charge_level %in% c("M", "F")) %>%
  group_by(charge_level, monitor_level) %>%
  summarise(FTA = round(mean(fta_flag)*n()), New_Arrest = round(mean(recid_arrested_flag)*n()), Total_Revoked = round(mean(revoked_flag)*n()), Total = n())

write.xlsx(outcome_df, file = "G:/CrimJustice/Pretrial/000-Pretrial Pilot Program/SB 36 and AB 74  Reporting/SB 36 tables 2022/2G Supervision Level Aggregated by charge level.xlsx", asTable = T) 

outcome_per_df <- outcome_df %>%
  mutate(FTA_percent = FTA / Total,
         New_Arrest_Percent = New_Arrest / Total,
         Total_Revoked_percent = Total_Revoked/Total)

write.xlsx(outcome_per_df, file = "G:/CrimJustice/Pretrial/000-Pretrial Pilot Program/SB 36 and AB 74  Reporting/SB 36 tables 2022/2G Supervision Level Aggregated Percent by charge level.xlsx", asTable = T)

eval_df %>%
  filter(monitor_level %in% c("Lowest Levels", "Medium Levels", "Highest Levels")) %>%
  count()
```
Misdo only
```{r message=FALSE, warning=FALSE}
mon_df <- ab74_df %>%
  filter(charge_level == "M") %>%
  mutate(recid_flag = recid_county_or_doj) %>%
  filter(monitor_level %in% c("Lowest Levels", "Medium Levels", "Highest Levels")) %>%
  mutate(monitor_level = factor(monitor_level, levels =  c("Lowest Levels", "Medium Levels", "Highest Levels"))) %>%
  mutate(revoked_flag = if_else(fta_flag == 1|recid_flag == 1|pretrial_termination_outcome == "Unsuccessful", 1, 0)) %>%
  mutate(revoked_flag = if_else(is.na(revoked_flag), 0, revoked_flag)) 

fta_df <- mon_df %>%
  group_by(monitor_level, fta_flag) %>%
  count() %>%
  group_by(monitor_level) %>%
  mutate(Total = sum(n), n = paste0(round(n/Total*100), "%", " ", n)) %>%
  spread(fta_flag, n) %>%
  select(-`0`) %>%
  bind_rows(mon_df %>%
              count(fta_flag) %>%
              mutate(Total = sum(n), n = paste0(round(n/Total*100), "%", " ", n)) %>%
  spread(fta_flag, n) %>%
  select(-`0`) %>%
  mutate(monitor_level = "All_Levels")) %>%
  separate(`1`, sep = " ", into = c("Percent", "Count"))

recid_df <- mon_df %>%
  group_by(monitor_level, recid_flag) %>%
  count() %>%
  group_by(monitor_level) %>%
  mutate(Total = sum(n), n = paste0(round(n/Total*100), "%", " ", n)) %>%
  spread(recid_flag, n) %>%
  select(-`0`) %>%
  bind_rows(mon_df %>%
              count(recid_flag) %>%
              mutate(Total = sum(n), n = paste0(round(n/Total*100), "%", " ", n)) %>%
  spread(recid_flag, n) %>%
  select(-`0`) %>%
  mutate(monitor_level = "All_Levels")) %>%
  separate(`1`, sep = " ", into = c("Percent", "Count"))

revoked_df <- mon_df %>%
  group_by(monitor_level, revoked_flag) %>%
  count() %>%
  group_by(monitor_level) %>%
  mutate(Total = sum(n), n = paste0(round(n/Total*100), "%", " ", n)) %>%
  spread(revoked_flag, n) %>%
  select(-`0`) %>%
  bind_rows(mon_df %>%
              count(revoked_flag) %>%
              mutate(Total = sum(n), n = paste0(round(n/Total*100), "%", " ", n)) %>%
  spread(revoked_flag, n) %>%
  select(-`0`) %>%
  mutate(monitor_level = "All_Levels")) %>%
  separate(`1`, sep = " ", into = c("Percent", "Count"))

  
outcome_df <- bind_cols(fta_df, recid_df[3:4], revoked_df[3:4])

names(outcome_df) <- gsub("\\..*", "", names(outcome_df))


kable(outcome_df, booktabs = T, format.args = list(big.mark = ","),
        # table.attr = "style = \"color: black;\"",
        format = "html") %>%
    kable_styling(position = "center", full_width = T,
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", latex_options = "hold_position") %>%
  add_header_above(c(" " = 2, "FTA" = 2, "New Crime" = 2, "Total\n Revoked" = 2)) 
# %>%
#   column_spec(2:10, width = ".5in") %>%
#   column_spec(1, width = "1in") %>%
#   row_spec(5, bold = T) 


```

Felony only
```{r message=FALSE, warning=FALSE}
mon_df <- ab74_df %>%
  filter(charge_level == "F") %>%
  mutate(recid_flag = recid_county_or_doj) %>%
  filter(monitor_level %in% c("Lowest Levels", "Medium Levels", "Highest Levels")) %>%
  mutate(monitor_level = factor(monitor_level, levels =  c("Lowest Levels", "Medium Levels", "Highest Levels"))) %>%
  mutate(revoked_flag = if_else(fta_flag == 1|recid_flag == 1|pretrial_termination_outcome == "Unsuccessful", 1, 0)) %>%
  mutate(revoked_flag = if_else(is.na(revoked_flag), 0, revoked_flag)) 

fta_df <- mon_df %>%
  group_by(monitor_level, fta_flag) %>%
  count() %>%
  group_by(monitor_level) %>%
  mutate(Total = sum(n), n = paste0(round(n/Total*100), "%", " ", n)) %>%
  spread(fta_flag, n) %>%
  select(-`0`) %>%
  bind_rows(mon_df %>%
              count(fta_flag) %>%
              mutate(Total = sum(n), n = paste0(round(n/Total*100), "%", " ", n)) %>%
  spread(fta_flag, n) %>%
  select(-`0`) %>%
  mutate(monitor_level = "All_Levels")) %>%
  separate(`1`, sep = " ", into = c("Percent", "Count"))

recid_df <- mon_df %>%
  group_by(monitor_level, recid_flag) %>%
  count() %>%
  group_by(monitor_level) %>%
  mutate(Total = sum(n), n = paste0(round(n/Total*100), "%", " ", n)) %>%
  spread(recid_flag, n) %>%
  select(-`0`) %>%
  bind_rows(mon_df %>%
              count(recid_flag) %>%
              mutate(Total = sum(n), n = paste0(round(n/Total*100), "%", " ", n)) %>%
  spread(recid_flag, n) %>%
  select(-`0`) %>%
  mutate(monitor_level = "All_Levels")) %>%
  separate(`1`, sep = " ", into = c("Percent", "Count"))

revoked_df <- mon_df %>%
  group_by(monitor_level, revoked_flag) %>%
  count() %>%
  group_by(monitor_level) %>%
  mutate(Total = sum(n), n = paste0(round(n/Total*100), "%", " ", n)) %>%
  spread(revoked_flag, n) %>%
  select(-`0`) %>%
  bind_rows(mon_df %>%
              count(revoked_flag) %>%
              mutate(Total = sum(n), n = paste0(round(n/Total*100), "%", " ", n)) %>%
  spread(revoked_flag, n) %>%
  select(-`0`) %>%
  mutate(monitor_level = "All_Levels")) %>%
  separate(`1`, sep = " ", into = c("Percent", "Count"))

  
outcome_df <- bind_cols(fta_df, recid_df[3:4], revoked_df[3:4])

names(outcome_df) <- gsub("\\..*", "", names(outcome_df))


kable(outcome_df, booktabs = T, format.args = list(big.mark = ","),
        # table.attr = "style = \"color: black;\"",
        format = "html") %>%
    kable_styling(position = "center", full_width = T,
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", latex_options = "hold_position") %>%
  add_header_above(c(" " = 2, "FTA" = 2, "New Crime" = 2, "Total\n Revoked" = 2)) 
# %>%
#   column_spec(2:10, width = ".5in") %>%
#   column_spec(1, width = "1in") %>%
#   row_spec(5, bold = T) 


```

San Mateo with supervision
\newline
```{r, results='asis'}
county_df <- eval_df %>%
  filter(county == "San Mateo") %>%
  mutate(sup_or_none = if_else(bail_or_sup %in% c("Lowest Levels", "Medium Levels", "Highest Levels"), "Supervision", bail_or_sup)) %>%
  filter(sup_or_none %in% c("Supervision", "Bail Bond"))

m1 <- glm(family = binomial(),fta_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)

summary(m1)
summary(m2)
summary(m3)
summary(m4)
summary(m5)
summary(m6)


# main effect of supervision
m1 <- glm(family = binomial(),fta_flag ~ vprair_risk_score + sup_or_none + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprair_risk_score + sup_or_none + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprair_risk_score + sup_or_none + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprair_risk_score + sup_or_none + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprair_risk_score + sup_or_none + release_to_pretrial_end , data = county_df)
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprair_risk_score + sup_or_none + release_to_pretrial_end , data = county_df)

summary(m1)
summary(m2)
summary(m3)
summary(m4)
summary(m5)
summary(m6)

# interaction effect of supervision
m1 <- glm(family = binomial(),fta_flag ~ vprair_risk_score*sup_or_none + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprair_risk_score*sup_or_none + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprair_risk_score*sup_or_none + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprair_risk_score*sup_or_none + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprair_risk_score*sup_or_none + release_to_pretrial_end , data = county_df)
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprair_risk_score*sup_or_none + release_to_pretrial_end , data = county_df)

summary(m1)
summary(m2)
summary(m3)
summary(m4)
summary(m5)
summary(m6)

ggplot(m2) %>%
  aes(x = vprair_risk_score, y = recid_arrested_flag, color = sup_or_none)+
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2)
  
  
ggplot(county_df) +
  aes(x = vprair_risk_score, y = recid_arrested_flag, color = sup_or_none) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() #+
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent", title = "Comparison of Release Differences in Logistic Regression Curves") +
  scale_x_continuous(breaks = 1:6)
```
\newpage

Alameda with supervision
\newline
```{r, results='asis'}
county_df <- eval_df %>%
  filter(county == "Alameda") %>%
  mutate(sup_or_none = if_else(bail_or_sup %in% c("Lowest Levels", "Medium Levels", "Highest Levels"), "Supervision", bail_or_sup)) %>%
  filter(sup_or_none %in% c("Supervision", "Bail Bond"))

m1 <- glm(family = binomial(),fta_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)

summary(m1)
summary(m2)
summary(m3)
summary(m4)
summary(m5)
summary(m6)


# main effect of supervision
m1 <- glm(family = binomial(),fta_flag ~ vprair_risk_score + sup_or_none + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprair_risk_score + sup_or_none + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprair_risk_score + sup_or_none + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprair_risk_score + sup_or_none + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprair_risk_score + sup_or_none + release_to_pretrial_end , data = county_df)
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprair_risk_score + sup_or_none + release_to_pretrial_end , data = county_df)

summary(m1)
summary(m2)
summary(m3)
summary(m4)
summary(m5)
summary(m6)

# interaction effect of supervision
m1 <- glm(family = binomial(),fta_flag ~ vprair_risk_score*sup_or_none + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprair_risk_score*sup_or_none + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprair_risk_score*sup_or_none + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprair_risk_score*sup_or_none + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprair_risk_score*sup_or_none + release_to_pretrial_end , data = county_df)
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprair_risk_score*sup_or_none + release_to_pretrial_end , data = county_df)

summary(m1)
summary(m2)
summary(m3)
summary(m4)
summary(m5)
summary(m6)
  
  
ggplot(county_df) +
  aes(x = vprair_risk_score, y = fta_flag, color = sup_or_none) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  theme_bw()

ggsave("Alameda FTA bail vs supervision.png")

ggplot(county_df) +
  aes(x = vprair_risk_score, y = recid_arrested_flag, color = sup_or_none) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  theme_bw()

ggsave("Alameda recid arrest bail vs supervision.png")


ggplot(county_df) +
  aes(x = vprair_risk_score, y = recid_filed_flag, color = sup_or_none) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  theme_bw()

ggsave("Alameda recid filed bail vs supervision.png")


ggplot(county_df) +
  aes(x = vprair_risk_score, y = recid_convicted_flag, color = sup_or_none) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  theme_bw()

ggsave("Alameda recid convicted bail vs supervision.png")


ggplot(county_df) +
  aes(x = vprair_risk_score, y = recid_arrest_violent_psa_flag, color = sup_or_none) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  theme_bw()

ggsave("Alameda recid violent bail vs supervision.png")


ggplot(county_df) +
  aes(x = vprair_risk_score, y = any_pretrial_failure_flag, color = sup_or_none) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  theme_bw()

ggsave("Alameda combined failure bail vs supervision.png")

```
\newpage

San Joaquin with supervision
\newline
```{r, results='asis'}
county_df <- eval_df %>%
  filter(county == "San Joaquin") %>%
  mutate(sup_or_none = if_else(bail_or_sup %in% c("Lowest Levels", "Medium Levels", "Highest Levels"), "Supervision", bail_or_sup)) %>%
  filter(sup_or_none %in% c("Supervision", "Bail Bond"))

m1 <- glm(family = binomial(),fta_flag ~ vprai_risk_score + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprai_risk_score + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprai_risk_score + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprai_risk_score + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprai_risk_score + release_to_pretrial_end , data = county_df)
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprai_risk_score + release_to_pretrial_end , data = county_df)

summary(m1)
summary(m2)
summary(m3)
summary(m4)
summary(m5)
summary(m6)


# main effect of supervision
m1 <- glm(family = binomial(),fta_flag ~ vprai_risk_score + sup_or_none + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprai_risk_score + sup_or_none + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprai_risk_score + sup_or_none + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprai_risk_score + sup_or_none + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprai_risk_score + sup_or_none + release_to_pretrial_end , data = county_df)
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprai_risk_score + sup_or_none + release_to_pretrial_end , data = county_df)

summary(m1)
summary(m2)
summary(m3)
summary(m4)
summary(m5)
summary(m6)

# interaction effect of supervision
m1 <- glm(family = binomial(),fta_flag ~ vprai_risk_score*sup_or_none + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprai_risk_score*sup_or_none + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprai_risk_score*sup_or_none + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprai_risk_score*sup_or_none + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprai_risk_score*sup_or_none + release_to_pretrial_end , data = county_df)
m6 <- glm(family = binomial(),any_pretrial_failure_flag ~ vprai_risk_score*sup_or_none + release_to_pretrial_end , data = county_df)

summary(m1)
summary(m2)
summary(m3)
summary(m4)
summary(m5)
summary(m6)
  
  
ggplot(county_df) +
  aes(x = vprai_risk_score, y = fta_flag, color = sup_or_none) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  theme_bw()

ggsave("San Joaquin FTA  bail vs supervision.png")

ggplot(county_df) +
  aes(x = vprai_risk_score, y = recid_arrested_flag, color = sup_or_none) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  theme_bw()

ggsave("San Joaquin recid arrest bail vs supervision.png")


ggplot(county_df) +
  aes(x = vprai_risk_score, y = recid_filed_flag, color = sup_or_none) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  theme_bw()

ggsave("San Joaquin recid filed bail vs supervision.png")


ggplot(county_df) +
  aes(x = vprai_risk_score, y = recid_convicted_flag, color = sup_or_none) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  theme_bw()

ggsave("San Joaquin recid convicted bail vs supervision.png")


ggplot(county_df) +
  aes(x = vprai_risk_score, y = recid_arrest_violent_psa_flag, color = sup_or_none) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  theme_bw()

ggsave("San Joaquin recid violent bail vs supervision.png")


ggplot(county_df) +
  aes(x = vprai_risk_score, y = any_pretrial_failure_flag, color = sup_or_none) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  theme_bw()

ggsave("San Joaquin combined failure bail vs supervision.png")

```
\newpage

Sonoma graphs by supervision
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  filter(county == "Sonoma") %>%
  filter(tool_name == "PSA") %>%
  group_by(psa_fta_risk_score, bail_or_sup, county) %>%
  select(fta_flag) %>%
  pivot_longer(fta_flag) 

names(risk_df)[1] <- "psa_risk_score"

risk_df2 <- eval_df %>%
  filter(county == "Sonoma") %>%
  filter(tool_name == "PSA") %>%
  group_by(psa_nca_risk_score, bail_or_sup, county) %>%
  select(recid_arrested_flag, recid_filed_flag, recid_convicted_flag) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[1] <- "psa_risk_score"

risk_df3 <- eval_df %>%
  filter(county == "Sonoma") %>%
  filter(tool_name == "PSA", !is.na(psa_nvca_risk_score)) %>%
  group_by(psa_nvca_risk_score, bail_or_sup, county) %>%
  select(recid_arrest_violent_psa_flag) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[1] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(race = factor(bail_or_sup, levels = c("Cite Release", "Own Recognizance", "Bail Bond", "Lowest Levels", "Medium Levels", "Highest Levels"))) %>%
  filter(!is.na(bail_or_sup)) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) 

ggplot(risk_df) +
  aes(x = psa_risk_score, y = value, color = bail_or_sup) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent", title = "Comparison of Release Differences in Logistic Regression Curves--PSA, Sonoma") +
  scale_x_continuous(breaks = 1:6)


```


Tulare graphs by supervision
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  filter(county == "Tulare") %>%
  filter(tool_name == "PSA") %>%
  group_by(psa_fta_risk_score, bail_or_sup, county) %>%
  select(fta_flag) %>%
  pivot_longer(fta_flag) 

names(risk_df)[1] <- "psa_risk_score"

risk_df2 <- eval_df %>%
  filter(county == "Tulare") %>%
  filter(tool_name == "PSA") %>%
  group_by(psa_nca_risk_score, bail_or_sup, county) %>%
  select(recid_arrested_flag, recid_filed_flag, recid_convicted_flag) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[1] <- "psa_risk_score"

risk_df3 <- eval_df %>%
  filter(county == "Tulare") %>%
  filter(tool_name == "PSA", !is.na(psa_nvca_risk_score)) %>%
  group_by(psa_nvca_risk_score, bail_or_sup, county) %>%
  select(recid_arrest_violent_psa_flag) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[1] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(race = factor(bail_or_sup, levels = c("Cite Release", "Own Recognizance", "Bail Bond", "Lowest Levels", "Medium Levels", "Highest Levels"))) %>%
  filter(!is.na(bail_or_sup)) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) 

ggplot(risk_df) +
  aes(x = psa_risk_score, y = value, color = bail_or_sup) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent", title = "Comparison of Release Differences in Logistic Regression Curves--PSA, Tulare") +
  scale_x_continuous(breaks = 1:6)


```


All PSA graphs by supervision
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  filter(tool_name == "PSA") %>%
  group_by(psa_fta_risk_score, bail_or_sup, county) %>%
  select(fta_flag) %>%
  pivot_longer(fta_flag) 

names(risk_df)[1] <- "psa_risk_score"

risk_df2 <- eval_df %>%
  filter(tool_name == "PSA") %>%
  group_by(psa_nca_risk_score, bail_or_sup, county) %>%
  select(recid_arrested_flag, recid_filed_flag, recid_convicted_flag) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[1] <- "psa_risk_score"

risk_df3 <- eval_df %>%
  filter(tool_name == "PSA", !is.na(psa_nvca_risk_score)) %>%
  group_by(psa_nvca_risk_score, bail_or_sup, county) %>%
  select(recid_arrest_violent_psa_flag) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[1] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(race = factor(bail_or_sup, levels = c("Cite Release", "Own Recognizance", "Bail Bond", "Lowest Levels", "Medium Levels", "Highest Levels"))) %>%
  filter(!is.na(bail_or_sup)) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) 

ggplot(risk_df %>%
         filter(county != "Los Angeles")) +
  aes(x = psa_risk_score, y = value, color = bail_or_sup) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent", title = "Comparison of Release Differences in Logistic Regression Curves--PSA without LA") +
  scale_x_continuous(breaks = 1:6)


```


# Exploration of condition flags
```{r}
eval_df %>%
  filter(1 ==1,
         county == 'Napa') %>%
  select(court_date_reminder_flag, transit_service_flag,
         condition_phone_flag, condition_inperson_flag, condition_drug_test_flag,
         condition_alcohol_flag, condition_em_flag, condition_no_contact_flag)

eval_df %>%
  group_by(county) %>%
  summarise(n = sum(booking_assessed_count),
            court_reminder = round(mean(court_date_reminder_flag)*100), 
            transit_service = round(mean(transit_service_flag)*100),
            phone = round(mean(condition_phone_flag)*100), 
            inperson = round(mean(condition_inperson_flag)*100), 
            drug_test = round(mean(condition_drug_test_flag)*100),
            alcohol = round(mean(condition_alcohol_flag)*100), 
            em = round(mean(condition_em_flag)*100), 
            nocontact =round(mean(condition_no_contact_flag)*100))
  

# Sonoma has a decent number and spread of flags
# Alameda could look at court reminder and in person
```
Sonoma with supervision flags
```{r}
county_df <- eval_df %>%
  filter(county == "Sonoma", tool_name == "PSA")

m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score + release_to_pretrial_end + court_date_reminder_flag + condition_phone_flag + condition_inperson_flag + condition_drug_test_flag + condition_alcohol_flag + condition_em_flag + condition_no_contact_flag, data = county_df %>% filter(!is.na(psa_fta_risk_score)))
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score + release_to_pretrial_end + court_date_reminder_flag + condition_phone_flag + condition_inperson_flag + condition_drug_test_flag + condition_alcohol_flag + condition_em_flag + condition_no_contact_flag, data = county_df %>% filter(!is.na(psa_nca_risk_score)))
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score + release_to_pretrial_end + court_date_reminder_flag + condition_phone_flag + condition_inperson_flag + condition_drug_test_flag + condition_alcohol_flag + condition_em_flag + condition_no_contact_flag, data = county_df %>% filter(!is.na(psa_nca_risk_score)))
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score + release_to_pretrial_end + court_date_reminder_flag + condition_phone_flag + condition_inperson_flag + condition_drug_test_flag + condition_alcohol_flag + condition_em_flag + condition_no_contact_flag, data = county_df %>% filter(!is.na(psa_nca_risk_score)))
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score + release_to_pretrial_end + court_date_reminder_flag + condition_phone_flag + condition_inperson_flag + condition_drug_test_flag + condition_alcohol_flag + condition_em_flag + condition_no_contact_flag, data = county_df %>% filter(!is.na(psa_nvca_risk_score)))

summary(m1)
summary(m2)
summary(m3)
summary(m4)
summary(m5)


```

Sonoma graphs by alcohol flag
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  filter(county == "Sonoma") %>%
  filter(tool_name == "PSA") %>%
  group_by(psa_fta_risk_score, condition_alcohol_flag, county) %>%
  select(fta_flag) %>%
  pivot_longer(fta_flag) 

names(risk_df)[1] <- "psa_risk_score"

risk_df2 <- eval_df %>%
  filter(county == "Sonoma") %>%
  filter(tool_name == "PSA") %>%
  group_by(psa_nca_risk_score, condition_alcohol_flag, county) %>%
  select(recid_arrested_flag, recid_filed_flag, recid_convicted_flag) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[1] <- "psa_risk_score"

risk_df3 <- eval_df %>%
  filter(county == "Sonoma") %>%
  filter(tool_name == "PSA", !is.na(psa_nvca_risk_score)) %>%
  group_by(psa_nvca_risk_score, condition_alcohol_flag, county) %>%
  select(recid_arrest_violent_psa_flag) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[1] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(condition_alcohol_flag = factor(condition_alcohol_flag)) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) 

ggplot(risk_df) +
  aes(x = psa_risk_score, y = value, color = condition_alcohol_flag) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent", title = "Comparison of Alcohol Condition Differences in Logistic Regression Curves--PSA, Sonoma") +
  scale_x_continuous(breaks = 1:6)

```

Sonoma graphs by court_date_reminder_flag
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  filter(county == "Sonoma") %>%
  filter(tool_name == "PSA") %>%
  group_by(psa_fta_risk_score, court_date_reminder_flag, county) %>%
  select(fta_flag) %>%
  pivot_longer(fta_flag) 

names(risk_df)[1] <- "psa_risk_score"

risk_df2 <- eval_df %>%
  filter(county == "Sonoma") %>%
  filter(tool_name == "PSA") %>%
  group_by(psa_nca_risk_score, court_date_reminder_flag, county) %>%
  select(recid_arrested_flag, recid_filed_flag, recid_convicted_flag) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[1] <- "psa_risk_score"

risk_df3 <- eval_df %>%
  filter(county == "Sonoma") %>%
  filter(tool_name == "PSA", !is.na(psa_nvca_risk_score)) %>%
  group_by(psa_nvca_risk_score, court_date_reminder_flag, county) %>%
  select(recid_arrest_violent_psa_flag) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[1] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(court_date_reminder_flag = factor(court_date_reminder_flag)) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) 

ggplot(risk_df) +
  aes(x = psa_risk_score, y = value, color = court_date_reminder_flag) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent", title = "Comparison of Court Date Reminder Differences in Logistic Regression Curves--PSA, Sonoma") +
  scale_x_continuous(breaks = 1:6)

```

Sonoma graphs by condition_drug_test_flag
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  filter(county == "Sonoma") %>%
  filter(tool_name == "PSA") %>%
  group_by(psa_fta_risk_score, condition_drug_test_flag, county) %>%
  select(fta_flag) %>%
  pivot_longer(fta_flag) 

names(risk_df)[1] <- "psa_risk_score"

risk_df2 <- eval_df %>%
  filter(county == "Sonoma") %>%
  filter(tool_name == "PSA") %>%
  group_by(psa_nca_risk_score, condition_drug_test_flag, county) %>%
  select(recid_arrested_flag, recid_filed_flag, recid_convicted_flag) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[1] <- "psa_risk_score"

risk_df3 <- eval_df %>%
  filter(county == "Sonoma") %>%
  filter(tool_name == "PSA", !is.na(psa_nvca_risk_score)) %>%
  group_by(psa_nvca_risk_score, condition_drug_test_flag, county) %>%
  select(recid_arrest_violent_psa_flag) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[1] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(condition_drug_test_flag = factor(condition_drug_test_flag)) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) 

ggplot(risk_df) +
  aes(x = psa_risk_score, y = value, color = condition_drug_test_flag) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent", title = "Comparison of Drug Test Condition Differences in Logistic Regression Curves--PSA, Sonoma") +
  scale_x_continuous(breaks = 1:6)

```

Sonoma graphs by condition_inperson_flag
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  filter(county == "Sonoma") %>%
  filter(tool_name == "PSA") %>%
  group_by(psa_fta_risk_score, condition_inperson_flag, county) %>%
  select(fta_flag) %>%
  pivot_longer(fta_flag) 

names(risk_df)[1] <- "psa_risk_score"

risk_df2 <- eval_df %>%
  filter(county == "Sonoma") %>%
  filter(tool_name == "PSA") %>%
  group_by(psa_nca_risk_score, condition_inperson_flag, county) %>%
  select(recid_arrested_flag, recid_filed_flag, recid_convicted_flag) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[1] <- "psa_risk_score"

risk_df3 <- eval_df %>%
  filter(county == "Sonoma") %>%
  filter(tool_name == "PSA", !is.na(psa_nvca_risk_score)) %>%
  group_by(psa_nvca_risk_score, condition_inperson_flag, county) %>%
  select(recid_arrest_violent_psa_flag) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[1] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(condition_inperson_flag = factor(condition_inperson_flag)) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) 

ggplot(risk_df) +
  aes(x = psa_risk_score, y = value, color = condition_inperson_flag) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent", title = "Comparison of In Person Condition Differences in Logistic Regression Curves--PSA, Sonoma") +
  scale_x_continuous(breaks = 1:6)

```

Sonoma graphs by condition_em_flag
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  filter(county == "Sonoma") %>%
  filter(tool_name == "PSA") %>%
  group_by(psa_fta_risk_score, condition_em_flag, county) %>%
  select(fta_flag) %>%
  pivot_longer(fta_flag) 

names(risk_df)[1] <- "psa_risk_score"

risk_df2 <- eval_df %>%
  filter(county == "Sonoma") %>%
  filter(tool_name == "PSA") %>%
  group_by(psa_nca_risk_score, condition_em_flag, county) %>%
  select(recid_arrested_flag, recid_filed_flag, recid_convicted_flag) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[1] <- "psa_risk_score"

risk_df3 <- eval_df %>%
  filter(county == "Sonoma") %>%
  filter(tool_name == "PSA", !is.na(psa_nvca_risk_score)) %>%
  group_by(psa_nvca_risk_score, condition_em_flag, county) %>%
  select(recid_arrest_violent_psa_flag) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[1] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(condition_em_flag = factor(condition_em_flag)) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) 

ggplot(risk_df) +
  aes(x = psa_risk_score, y = value, color = condition_em_flag) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent", title = "Comparison of EM Differences in Logistic Regression Curves--PSA, Sonoma") +
  scale_x_continuous(breaks = 1:6)

```

Sonoma graphs by condition_no_contact_flag
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  filter(county == "Sonoma") %>%
  filter(tool_name == "PSA") %>%
  group_by(psa_fta_risk_score, condition_no_contact_flag, county) %>%
  select(fta_flag) %>%
  pivot_longer(fta_flag) 

names(risk_df)[1] <- "psa_risk_score"

risk_df2 <- eval_df %>%
  filter(county == "Sonoma") %>%
  filter(tool_name == "PSA") %>%
  group_by(psa_nca_risk_score, condition_no_contact_flag, county) %>%
  select(recid_arrested_flag, recid_filed_flag, recid_convicted_flag) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[1] <- "psa_risk_score"

risk_df3 <- eval_df %>%
  filter(county == "Sonoma") %>%
  filter(tool_name == "PSA", !is.na(psa_nvca_risk_score)) %>%
  group_by(psa_nvca_risk_score, condition_no_contact_flag, county) %>%
  select(recid_arrest_violent_psa_flag) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[1] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(condition_no_contact_flag = factor(condition_no_contact_flag)) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) 

ggplot(risk_df) +
  aes(x = psa_risk_score, y = value, color = condition_no_contact_flag) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent", title = "Comparison of No Contact Differences in Logistic Regression Curves--PSA, Sonoma") +
  scale_x_continuous(breaks = 1:6)

```


# Exploration of arrest offense types
```{r eval=FALSE, include=FALSE}
#arrest_felony_flag, arrest_misd_flag, arrest_violent_psa_flag, arrest_property_flag, arrest_drug_flag, arrest_dui_flag, arrest_dv_flag

test_df <- eval_df %>%
  mutate(arrest_cat = case_when(arrest_dv_flag == 1 ~ "DV",
                                arrest_violent_psa_flag == 1 ~ "Violent",
                                arrest_drug_flag == 1 ~ "Drug",
                                arrest_property_flag == 1 ~ "Property",
                                arrest_dui_flag == 1 ~ "DUI",
                                T ~ "Other/Unknown")) %>%
  count(county, arrest_charge_level, arrest_cat) %>%
  arrange(county, arrest_charge_level, arrest_cat)


eval_df %>%
  count(arrest_charge_level, arrest_felony_flag, arrest_misd_flag)

# why is charge level different from arrest charge level?? oy vey.
eval_df %>%
  count(charge_level_orig, arrest_charge_level)
```
Los Angeles--Without Interactions
\newline
```{r, results='asis'}
county_df <- eval_df %>%
  filter(county == "Los Angeles") %>%
  filter(tool_name == "PSA") %>%
  mutate(arrest_cat = case_when(arrest_dv_flag == 1 ~ "DV",
                                arrest_violent_psa_flag == 1 ~ "Violent",
                                arrest_drug_flag == 1 ~ "Drug",
                                arrest_property_flag == 1 ~ "Property",
                                arrest_dui_flag == 1 ~ "DUI",
                                T ~ "Other/Unknown"))

m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score + arrest_cat + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score + arrest_cat + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score + arrest_cat + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score + arrest_cat + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score + arrest_cat + release_to_pretrial_end , data = county_df)

stargazer(list(m1,m2,m3,m4,m5),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", 
                               "PSA NVCA Risk Score", "Race:Black", "Race:Hispanic", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")

summary(m1)
summary(m2)
summary(m3)
summary(m4)
summary(m5)
```
\newpage

Los Angeles--With Interactions
\newline
```{r, results='asis'}
county_df <- eval_df %>%
  filter(county == "Los Angeles") %>%
  filter(tool_name == "PSA") %>%
  mutate(across(contains("score"), ~.x-1)) %>%
  mutate(psa_nvca_risk_score = psa_nvca_risk_score + 1) %>%
  mutate(arrest_cat = case_when(arrest_dv_flag == 1 ~ "DV",
                                arrest_violent_psa_flag == 1 ~ "Violent",
                                arrest_drug_flag == 1 ~ "Drug",
                                arrest_property_flag == 1 ~ "Property",
                                arrest_dui_flag == 1 ~ "DUI",
                                T ~ "Other/Unknown"))

m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score * arrest_cat + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score * arrest_cat + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score * arrest_cat + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score * arrest_cat + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score * arrest_cat + release_to_pretrial_end , data = county_df)

stargazer(list(m1,m2,m3,m4,m5),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", "PSA NVCA Risk Score",
                               "Race:Black", "Race:Hispanic", "Days Released", "FTA*Black", "FTA*Hispanic",
                               "NCA*Black", "NCA*Hispanic", "NVCA*Black", "NVCA*Hispanic"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F, font.size = "small")

summary(m1)
summary(m2)
summary(m3)
summary(m4)
summary(m5)
```
\newpage

Los Angeles -- graph of logistic regression by arrest offense type
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  filter(county == "Los Angeles") %>%
  filter(tool_name == "PSA", !is.na(psa_fta_risk_score)) %>%
  mutate(arrest_cat = case_when(arrest_dv_flag == 1 ~ "DV",
                                arrest_violent_psa_flag == 1 ~ "Violent",
                                arrest_drug_flag == 1 ~ "Drug",
                                arrest_property_flag == 1 ~ "Property",
                                arrest_dui_flag == 1 ~ "DUI",
                                T ~ "Other/Unknown")) %>%
  group_by(psa_fta_risk_score, arrest_cat, county) %>%
  select(fta_flag) %>%
  pivot_longer(fta_flag) 

names(risk_df)[1] <- "psa_risk_score"

risk_df2 <- eval_df %>%
  filter(county == "Los Angeles") %>%
  filter(tool_name == "PSA", !is.na(psa_nca_risk_score)) %>%
  mutate(arrest_cat = case_when(arrest_dv_flag == 1 ~ "DV",
                                arrest_violent_psa_flag == 1 ~ "Violent",
                                arrest_drug_flag == 1 ~ "Drug",
                                arrest_property_flag == 1 ~ "Property",
                                arrest_dui_flag == 1 ~ "DUI",
                                T ~ "Other/Unknown")) %>%
  group_by(psa_nca_risk_score, arrest_cat, county) %>%
  select(recid_arrested_flag, recid_filed_flag, recid_convicted_flag) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[1] <- "psa_risk_score"

risk_df3 <- eval_df %>%
  filter(county == "Los Angeles") %>%
  filter(tool_name == "PSA", !is.na(psa_nvca_risk_score)) %>%
  mutate(arrest_cat = case_when(arrest_dv_flag == 1 ~ "DV",
                                arrest_violent_psa_flag == 1 ~ "Violent",
                                arrest_drug_flag == 1 ~ "Drug",
                                arrest_property_flag == 1 ~ "Property",
                                arrest_dui_flag == 1 ~ "DUI",
                                T ~ "Other/Unknown")) %>%
  group_by(psa_nvca_risk_score, arrest_cat, county) %>%
  select(recid_arrest_violent_psa_flag) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[1] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(arrest_cat = factor(arrest_cat)) %>%
  #filter(arrest_cat != "Other/Unknown") %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) 

ggplot(risk_df) +
  aes(x = psa_risk_score, y = value, color = arrest_cat) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent",
       title = "Comparison of Arrest Offense Type Differences in Logistic Regression Curves--PSA, Los Angeles") +
  scale_x_continuous(breaks = 1:6)

# eval_df %>%
#   filter(tool_name == "PSA") %>%
#   count(county)


```

```{r}
eval_df %>%
  select(contains("recid_arrest_"))
```

Los Angeles -- graphs of recidivism arrest type for new arrest by arrest offense type
\newline
```{r fig.height=6, fig.width=10, dpi=1200}

risk_df <- eval_df %>%
  left_join(addon_df) %>%
  filter(county == "Los Angeles") %>%
  filter(tool_name == "PSA", !is.na(psa_nca_risk_score)) %>%
  mutate(arrest_cat = case_when(arrest_dv_flag == 1 ~ "DV",
                                arrest_violent_psa_flag == 1 ~ "Violent",
                                arrest_drug_flag == 1 ~ "Drug",
                                arrest_property_flag == 1 ~ "Property",
                                arrest_dui_flag == 1 ~ "DUI",
                                T ~ "Other/Unknown")) %>%
  group_by(psa_nca_risk_score, arrest_cat, county) %>%
  select(recid_arrest_violent_psa_flag_doj, recid_arrest_dv_flag_doj, recid_arrest_dui_flag_doj, recid_arrest_property_flag_doj, recid_arrest_drug_flag_doj) %>%
  pivot_longer(recid_arrest_violent_psa_flag_doj:recid_arrest_drug_flag_doj) 

names(risk_df)[1] <- "psa_risk_score"




risk_df <- risk_df %>%
  mutate(arrest_cat = factor(arrest_cat)) %>%
  #filter(arrest_cat != "Other/Unknown") %>%
  mutate(name = case_when(name == "recid_arrest_violent_psa_flag_doj" ~ "New Arrest Violent PSA",
                          name == "recid_arrest_dv_flag_doj" ~ "New DV Arrest",
                          name == "recid_arrest_dui_flag_doj" ~ "New DUI Arrest",
                          name == "recid_arrest_property_flag_doj" ~ "New Property Arrest",
                          name == "recid_arrest_drug_flag_doj" ~ "New Drug Arrest"),
         name = factor(name)) 

ggplot(risk_df) +
  aes(x = psa_risk_score, y = value, color = arrest_cat) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent",
       title = "Comparison of Arrest Offense Type Differences in Logistic Regression Curves--PSA, Los Angeles") +
  scale_x_continuous(breaks = 1:6)

# eval_df %>%
#   filter(tool_name == "PSA") %>%
#   count(county)


```

Alameda 
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  filter(county == "Alameda") %>%
  mutate(arrest_cat = case_when(arrest_dv_flag == 1 ~ "DV",
                                arrest_violent_psa_flag == 1 ~ "Violent",
                                arrest_drug_flag == 1 ~ "Drug",
                                arrest_property_flag == 1 ~ "Property",
                                arrest_dui_flag == 1 ~ "DUI",
                                T ~ "Other/Unknown")) %>%
  mutate(arrest_cat = factor(arrest_cat)) %>%
  filter(tool_name == "VPRAI-R", !is.na(vprair_risk_score)) %>%
  group_by(vprair_risk_score, arrest_cat) %>%
  select(vprair_risk_score, arrest_cat, fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag,
         any_pretrial_failure_flag, recid_arrest_violent_psa_flag) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) %>%
  filter(arrest_cat != "DUI") #not enough observations

ggplot(risk_df) +
  aes(x = vprair_risk_score, y = value, color = arrest_cat) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent",
       title = "Comparison of Arrest Offense Type Differences in Logistic Regression Curves--VPRAI-R, Alameda") +
  scale_x_continuous(breaks = 0:14)

# risk_df %>%
#   ungroup() %>%
#   count(arrest_cat)
```
\newpage

Alameda -- recidivism arrest type by arrest offense type
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  filter(county == "Alameda") %>%
  left_join(addon_df) %>%
  mutate(arrest_cat = case_when(arrest_dv_flag == 1 ~ "DV",
                                arrest_violent_psa_flag == 1 ~ "Violent",
                                arrest_drug_flag == 1 ~ "Drug",
                                arrest_property_flag == 1 ~ "Property",
                                arrest_dui_flag == 1 ~ "DUI",
                                T ~ "Other/Unknown")) %>%
  mutate(arrest_cat = factor(arrest_cat)) %>%
  filter(tool_name == "VPRAI-R", !is.na(vprair_risk_score)) %>%
  group_by(vprair_risk_score, arrest_cat) %>%
  select(vprair_risk_score, arrest_cat, recid_arrest_violent_psa_flag_doj, recid_arrest_dv_flag_doj, recid_arrest_dui_flag_doj, recid_arrest_property_flag_doj, recid_arrest_drug_flag_doj) %>%
  pivot_longer(recid_arrest_violent_psa_flag_doj:recid_arrest_drug_flag_doj) %>%
  mutate(name = case_when(name == "recid_arrest_violent_psa_flag_doj" ~ "New Arrest Violent PSA",
                          name == "recid_arrest_dv_flag_doj" ~ "New DV Arrest",
                          name == "recid_arrest_dui_flag_doj" ~ "New DUI Arrest",
                          name == "recid_arrest_property_flag_doj" ~ "New Property Arrest",
                          name == "recid_arrest_drug_flag_doj" ~ "New Drug Arrest"),
         name = factor(name))  %>%
  filter(arrest_cat != "DUI",
         name != "New DUI Arrest")  #not enough observations
 

ggplot(risk_df) +
  aes(x = vprair_risk_score, y = value, color = arrest_cat) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent",
       title = "Comparison of Arrest Offense Type Differences in Logistic Regression Curves--VPRAI-R, Alameda") +
  scale_x_continuous(breaks = 0:14)

# risk_df %>%
#   ungroup() %>%
#   count(arrest_cat)
```
\newpage

Ventura -- Arrest offense
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  mutate(arrest_cat = case_when(arrest_dv_flag == 1 ~ "DV",
                                arrest_violent_psa_flag == 1 ~ "Violent",
                                arrest_drug_flag == 1 ~ "Drug",
                                arrest_property_flag == 1 ~ "Property",
                                arrest_dui_flag == 1 ~ "DUI",
                                T ~ "Other/Unknown")) %>%
  mutate(arrest_cat = factor(arrest_cat)) %>%
  filter(tool_name == "ORAS", !is.na(oras_risk_score), county == "Ventura") %>%
  group_by(oras_risk_score, arrest_cat) %>%
  select(oras_risk_score, arrest_cat, fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag,
         any_pretrial_failure_flag, recid_arrest_violent_psa_flag) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) %>%
  filter(arrest_cat !="DUI")

ggplot(risk_df) +
  aes(x = oras_risk_score, y = value, color = arrest_cat) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent", title = "Comparison of Arrest Offense Type Differences in Logistic Regression Curves--ORAS, Ventura") +
  scale_x_continuous(breaks = 0:9)


```
\newpage
