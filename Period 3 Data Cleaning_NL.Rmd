---
title: "County Data Loading"
author: "Noah Lehman"
date: "7/13/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

knitr::opts_knit$set(root.dir = "G:/CrimJustice/PretrialAssessmentPilot")

# library(rlang)
library(tidyverse)
library(data.table)
library(openxlsx)
library(readxl)
library(lubridate)
library(XML)
library(xml2)
# library(xmltools)o
library(gsubfn)
library(fuzzyjoin)
library(dplyr)
library(openxlsx)
# library(multidplyr)
```


# Function Creation
```{r}

```

# Charge Hierarchy Creation

2020 DOJ Hieararchies
```{r, eval=FALSE, include=FALSE}
#DOJ Crime Severity Ratings 2008
doj_hierarchy_2020 <- fread("G:/CrimJustice/PretrialAssessmentPilot/Charge Definitions and Hierarchy/Master Charge Code Table 2020.csv")
doj_hierarchy_2020_jbsis <- read_excel("G:/CrimJustice/PretrialAssessmentPilot/Charge Definitions and Hierarchy/2020_March04_DOJ_Offense_Table_JBSIS.xlsx")


names(doj_hierarchy_2020) <- c("offense_id", "cjis_code", "hierarchy", "charge_level", "charge", "charge_code", "master_charge_description", "sentence")
names(doj_hierarchy_2020_jbsis) <- c("offense_id", "cjis_code", "hierarchy", "charge_level", "charge", "charge_code", "master_charge_description", "sentence", "jbsis_code")

doj_hierarchy_2020 <- left_join(doj_hierarchy_2020, doj_hierarchy_2020_jbsis)

doj_hierarchy_2020 <- doj_hierarchy_2020 %>%
  mutate(charge_level = toupper(charge_level),
         charge_level = if_else(!charge_level %in% c("F", "I", "M"), "Other", charge_level),
         charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}|EX|\\+|","", charge)),
         charge_code = if_else(!charge_code %in% c("PC", "VC", "HS", "BP", "WI", "US"), "Other", charge_code)) %>%
  distinct(charge, charge_code, charge_level, .keep_all = T) %>%
  unite(join_var, charge_level, charge_code, charge, remove = F) %>%
  select(join_var, master_charge_description, hierarchy, charge_level, charge_code, charge, jbsis_code)
```


2017 DOJ Hieararchies
```{r, eval=FALSE, include=FALSE}
#DOJ Crime Severity Ratings 2008
doj_hierarchy_2017 <- read_excel("G:/CrimJustice/PretrialAssessmentPilot/Charge Definitions and Hierarchy/dojoffenses.xls")

doj_hierarchy_2017 <- doj_hierarchy_2017 %>%
  mutate(STATUTE2 = gsub("\\/|\\(|\\)| |\\.|\\.*","", STATUTE2)) %>%
  unite("charge",STATUTE1,STATUTE2, sep = "") %>%
  mutate(charge = gsub("NA", "", charge)) %>%
  select(charge, master_charge_description = DESCRIPTION, hierarchy = HIERARCHY, charge_code = CODE_TYPE, charge_level = CHARGE_TYPE) %>%
  filter(!is.na(hierarchy)) %>%
  # mutate(charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}","", charge))) %>%
  mutate(charge_level = if_else(!charge_level %in% c("F", "I", "M"), "Other", charge_level),
         charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}|EX|\\+|","", charge)),
         charge_code = if_else(!charge_code %in% c("PC", "VC", "HS", "BP", "WI", "US"), "Other", charge_code)) %>%
  # mutate(charge_level = fct_collapse(charge_level, O = c("S", "X"))) %>% #Incorretly labeled, juvenile, and miscelanious 
  distinct(charge, charge_code, charge_level, .keep_all = T) %>%
  unite(join_var, charge_level, charge_code, charge, remove = F) %>%
  select(join_var, master_charge_description, hierarchy, charge_level, charge_code, charge)

```

 -Visualizes above chunk
```{r, eval=FALSE, include=FALSE} 
#--This visualizes the above chunk
table(doj_hierarchy_2017$charge_code, doj_hierarchy_2017$charge_level)

doj_hierarchy_2017 %>%
  # filter(HIERARCHY < 1.7e5) %>%
  ggplot() +
  aes(x = hierarchy, color = charge_level) +
  geom_density() +
  theme_few()
```


2008 DOJ Hierarchies
```{r}
#DOJ Crime Severity Ratings 2008
doj_hierarchy_2008 <- read_excel("G:/CrimJustice/PretrialAssessmentPilot/Charge Definitions and Hierarchy/DOJ Crime Severity Ratings May 2008.xls", col_names = FALSE, skip = 11)

#Recreating Variables
names(doj_hierarchy_2008) <- c("sum", "bcs", "hierarchy", "charge_level", "charge", "charge_code", "master_charge_description", "sentence")

#collapsed codes for merger with Fresno
doj_hierarchy_2008 <- doj_hierarchy_2008 %>% 
  # mutate(charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}","", charge))) %>%
  mutate(charge_level = strapplyc(charge_level, "^(.).*", simplify = T)) %>%
  mutate(charge_level = if_else(!charge_level %in% c("F", "I", "M"), "Other", charge_level),
         charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}|EX|\\+|","", charge)),
         charge_code = if_else(!charge_code %in% c("PC", "VC", "HS", "BP", "WI", "US"), "Other", charge_code)) %>%
  filter(!is.na(hierarchy)) %>%
  # mutate(charge_level = fct_recode(charge_level, "Other" = "S")) %>%
  distinct(charge_level, charge_code, charge, .keep_all = T)  %>%
  select(-c(sum, bcs, sentence)) %>%
  unite(join_var, charge_level, charge_code, charge, remove = F) %>%
  select(join_var, master_charge_description, hierarchy, charge_level, charge_code, charge)
 
```

 -Visualizes above chunk
```{r, eval=FALSE, include=FALSE} 
#--This visualizes the above chunk
table(doj_hierarchy_2008$charge_code, doj_hierarchy_2008$charge_level)

doj_hierarchy_2008 %>%
  filter(hierarchy < 1.7e5) %>%
  ggplot() +
  aes(x = hierarchy, color = charge_level) +
  geom_density() +
  theme_few()
```


 Charge Code Table 
```{r}
#--This chunk pulls the master charge code table and standardizes it. 
mcct_2016 <- read_excel("G:/CrimJustice/PretrialAssessmentPilot/Charge Definitions and Hierarchy/Master Charge Code Table 2016.xlsx", guess_max = Inf)

mcct_2016 <- mcct_2016 %>%
  filter(!is.na(`CalDOJ HIERARCHY Code Informational only`))

mcct_2016 <- mcct_2016 %>% 
  select(charge_code = CODE, 
         charge = `CODE SECTION (upper/lower case)`, 
         hierarchy = `CalDOJ HIERARCHY Code Informational only`,
         master_charge_description = `Offense Display (For AJIS and ISAB Departments)`,
         charge_level = LEVEL) %>%
  # mutate(charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}","", charge))) %>%
  mutate(charge_level = if_else(!charge_level %in% c("F", "I", "M"), "Other", charge_level),
         charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}|EX|\\+|","", charge)),
         charge_code = if_else(!charge_code %in% c("PC", "VC", "HS", "BP", "WI", "US"), "Other", charge_code)) %>%
  distinct(charge_level, charge_code, charge, .keep_all = T) %>%
  mutate(hierarchy = as.numeric(hierarchy)) %>%
  unite(join_var, charge_level, charge_code, charge, remove = F) %>%
  select(join_var, master_charge_description, hierarchy, charge_level, charge_code, charge)
```

 -Visualizes above chunk
```{r, eval=FALSE, include=FALSE} 
#--This visualizes the above chunk
table(mcct_2016$charge_code, mcct_2016$charge_level)

mcct_2016 %>%
  # filter(HIERARCHY < 3e5) %>%
  ggplot() +
  aes(x = hierarchy, color = charge_level) +
  geom_density() +
  theme_few()
```


JBSIS Hierarchies
```{r, eval=FALSE, include=FALSE}
#JBSIS matched Charges
charge_hier_jbsis <- read_excel("G:/CrimJustice/PretrialAssessmentPilot/Charge Definitions and Hierarchy/Copy of 2016_Nov21_DOJ_Offense_Table_JBSIS.xlsx") 

names(charge_hier_jbsis) <- toupper(names(charge_hier_jbsis))

charge_hier_jbsis <- charge_hier_jbsis %>% 
  select(charge = `CODE SECTION`,
         charge_code = `CODE TYPE`,
         master_charge_description = `OFFENSE DESCRIPTION`,
         charge_level = `OFF LEVEL`,
         hierarchy = HIERARCHY) %>%
  # mutate(charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*","", charge))) %>% 
  mutate(charge_level = if_else(!charge_level %in% c("F", "I", "M"), "Other", charge_level),
         charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}|EX|\\+|","", charge)),
         charge_code = if_else(!charge_code %in% c("PC", "VC", "HS", "BP", "WI", "US"), "Other", charge_code)) %>%
  distinct(charge, charge_code, charge_level, .keep_all = T) %>%
  unite(join_var, charge_level, charge_code, charge, remove = F) %>%
  select(join_var, master_charge_description, hierarchy, charge_level, charge_code, charge)
```

 -Visualizes above chunk
```{r, eval=FALSE, include=FALSE} 
#--This visualizes the above chunk
table(charge_hier_jbsis$charge_code, charge_hier_jbsis$charge_level)

charge_hier_jbsis %>%
 
   # filter(HIERARCHY < 1.7e5) %>%
  ggplot() +
  aes(x = as.numeric(hierarchy), color = charge_level) +
  geom_density() +
  theme_few()

```

Special Allegations--Hierarchies are Max
```{r}
charge_hier_special <- fread("G:/CrimJustice/PretrialAssessmentPilot/Charge Definitions and Hierarchy/San_Mateo_Qualifier_Flags_Court_charges.csv", header = T)
charge_hier_special2 <- fread("G:/CrimJustice/PretrialAssessmentPilot/Charge Definitions and Hierarchy/Yuba_Qualifier_Flags_Court_charges.csv", header = T)
charge_hier_special3 <- read_excel("G:/CrimJustice/PretrialAssessmentPilot/Charge Definitions and Hierarchy/qualifier_codes_for_Noah_Kings_Court.xlsx")
charge_hier_special4 <- read_excel("G:/CrimJustice/PretrialAssessmentPilot/Charge Definitions and Hierarchy/qualifier_codes_for_Noah_Napa_Court.xlsx")
charge_hier_special5 <- read_excel("G:/CrimJustice/PretrialAssessmentPilot/Charge Definitions and Hierarchy/qualifier_codes_for_Noah_Sonoma_Court.xlsx")

charge_hier_special6 <- tibble(join_var = c("M_VC_23578", "M_VC_231035", "F_PC_117012C1", "F_PC_120225A", "F_PC_1170H3", "F_PC_1170H", 
                                               "F_PC_120227A", "F_PC_120221", "F_PC_667A1", "F_PC_12022A1", "F_PC_12022B1", 
                                               "F_VC_23577", "F_PC_1202253C", "F_PC_290018BZ", "F_PC_1202253B", 
                                               "F_PC_6676D", "F_PC_1202253D", "F_PC_1203K", "F_HS_113702A", "F_PC_120307A11", 
                                               "F_HS_11370A", "F_PC_6675C21", "F_PC_667E1", "F_PC_6676C", "F_PC_120306A1", "F_PC_969F", 
                                               "F_PC_120306A1", "F_PC_1170H5B", "F_PC_1170H5A")) %>%
  separate(join_var, c("court_charge_level", "court_charge_code", "court_charge"))


charge_hier_special <- bind_rows(charge_hier_special, charge_hier_special2, charge_hier_special3, charge_hier_special4, charge_hier_special5, charge_hier_special6) 

rm(charge_hier_special2, charge_hier_special3, charge_hier_special4, charge_hier_special5, charge_hier_special6)

charge_hier_special <- charge_hier_special %>%
  select(charge_code = court_charge_code, charge_level = court_charge_level, charge = court_charge, master_charge_description = court_charge_description) %>%
  mutate(charge_level = if_else(!charge_level %in% c("F", "I", "M"), "Other", charge_level),
         charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}|EX|\\+|","", charge)),
         charge_code = if_else(!charge_code %in% c("PC", "VC", "HS", "BP", "WI", "US"), "Other", charge_code)) %>%
  mutate(master_charge_description = gsub("^.*-", "", toupper(master_charge_description))) %>%
  group_by(charge_code, charge) %>% 
  mutate(master_charge_description = if_else(is.na(master_charge_description), max(master_charge_description, na.rm = T), master_charge_description)) %>%
  ungroup() %>%
  distinct(charge, charge_code, charge_level, .keep_all = T) %>%
  unite(join_var, charge_level, charge_code, charge, remove = F) %>%
  mutate(hierarchy = 1e6) %>%
  select(join_var, master_charge_description, hierarchy, charge_level, charge_code, charge) %>%
  mutate(special_flag = 1) 

# charge_hier_special %>%
#   filter(grepl("23578", join_var)) %>%
#   group_by(charge_code, charge) %>%
#   mutate(master_charge_description = if_else(is.na(master_charge_description), max(master_charge_description, na.rm = T), master_charge_description))
```

  -New Special Allegations
```{r}  
  
charge_hier_check <- tibble(join_var = c("M_VC_23578", "M_VC_231035", "F_PC_117012C1", "F_PC_120225A", "F_PC_1170H3", "F_PC_1170H", 
                                               "F_PC_120227A", "F_PC_120221", "F_PC_667A1", "F_PC_667A1", "F_PC_12022A1", "F_PC_12022B1", 
                                               "F_VC_23577", "F_PC_1202253C", "F_PC_290018BZ", "F_PC_290018BZ", "F_PC_1202253B", 
                                               "F_PC_6676D", "F_PC_1202253D", "F_PC_1203K", "F_HS_113702A", "F_PC_120307A11", 
                                               "F_HS_11370A", "F_PC_6675C21"))
anti_join(charge_hier_check, charge_hier_special)
```

Missing Charges
```{r}
charge_hier_missing <- read_excel("G:/CrimJustice/PretrialAssessmentPilot/Charge Definitions and Hierarchy/Charges Missing from the Charge Code Tables original.xlsx", sheet = "Combined") 

charge_hier_missing <- charge_hier_missing %>% 
  mutate(charge_level = if_else(!charge_level %in% c("F", "I", "M"), "Other", charge_level),
         charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}|EX|\\+|","", charge)),
         charge_code = if_else(!charge_code %in% c("PC", "VC", "HS", "BP", "WI", "US"), "Other", charge_code)) %>%
  distinct(charge, charge_code, charge_level, .keep_all = T) %>%
  unite(join_var, charge_level, charge_code, charge, remove = F) %>%
  select(join_var, master_charge_description, hierarchy, charge_level, charge_code, charge) 
```

Merging hiearchies 
```{r}
charge_hier <- bind_rows(doj_hierarchy_2020, doj_hierarchy_2017, doj_hierarchy_2008, mcct_2016, charge_hier_jbsis, charge_hier_special, charge_hier_missing) %>%
  mutate(special_flag = if_else(is.na(special_flag), 0, special_flag)) %>%
  group_by(join_var) %>%
  mutate(special_flag = max(special_flag)) %>%
  ungroup() %>%
  distinct(join_var, .keep_all = T) %>%
  mutate(hierarchy = if_else(is.na(hierarchy|hierarchy >= 3e5|hierarchy < 1000), 1e6, hierarchy))

save(charge_hier, file = "Complete Charge Code Hierarchy.RData")
# shell.exec(getwd())
```

 -Visualizes above chunk
```{r, eval=FALSE, include=FALSE} 
#--This visualizes the above chunk
table(charge_hier_jbsis$code_type, charge_hier_jbsis$charge_type)

charge_hier %>%
  filter(hierarchy < 1.7e5) %>%
  ggplot() +
  aes(x = as.numeric(hierarchy), color = charge_level) +
  geom_density() +
  theme_few()

charge_hier %>%
  count(charge_level)

charge_hier %>%
  count(charge_code) %>%
  arrange(desc(n))

charge_hier %>%
  mutate(code_type = gsub(".* ", "", code_type))  %>%
  count(code_type) %>%
  arrange(desc(n))

load("Complete Charge Code Hierarchy.RData")

charge_hier %>%
  count(charge_code)
```


# Charge Hierarchy Flag Adds
```{r}
load("Complete Charge Code Hierarchy.RData")

#Serious and Violent Felonies
serious_violent_charges <- read_excel("G:/CrimJustice/PretrialAssessmentPilot/Charge Definitions and Hierarchy/Serious and Violent Charges.xlsx", 
    sheet = "Data") %>%
  # filter(Serious == T | Violent == T)
  select(charge, charge_level, serious_felony_flag = Serious, violent_felony_flag = Violent) %>%
  filter(serious_felony_flag == 1 | violent_felony_flag == 1, charge_level == "F") %>%
  mutate(charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|\\\\.*|\\{o|\\}","", charge))) %>%
  mutate(charge = gsub("HSC", "HS_", charge),
         charge = gsub("PEN", "PC_", charge),
         charge = gsub("VEH", "VC_", charge)) %>%
  unite(join_var, charge_level, charge) %>%
  mutate(serious_violent_flag = if_else(serious_felony_flag == T|violent_felony_flag == T, 1, 0)) %>%
  # mutate(serious_felony_flag = if_else(serious_felony_flag == T, 1, 0),
  #        violent_felony_flag = if_else(violent_felony_flag == T, 1, 0)) %>%
  mutate_all(funs(ifelse(is.na(.), 0, .))) %>%
  distinct(join_var, .keep_all = T) %>%
  ungroup()

charge_hier <- charge_hier %>%
  left_join(serious_violent_charges) %>%
  mutate(serious_violent_flag = if_else(is.na(serious_violent_flag), 0, serious_violent_flag)) 
  # mutate_at(vars(serious_felony_flag, violent_felony_flag), funs(if_else(is.na(.), 0, .)))

rm(serious_violent_charges)

#Pretrial Violent Charges
pretrial_violent <- read_excel("G:/CrimJustice/PretrialAssessmentPilot/Charge Definitions and Hierarchy/Pretrial Pilot Consensus on Violent Offense List - FINAL 2-3-20.xlsx")

names(pretrial_violent) <- c("charge", "violent_description", "violent_psa_flag")

pretrial_violent <- pretrial_violent %>%
  mutate(violent_psa_flag = 1,
         charge_code = if_else(grepl("Veh Code", charge), "VC", "PC"),
         charge = gsub("\\/|\\(|\\)| |\\.|\\.*|\\\\.*|\\{|\\}|^[A-Z]* [A-Z]* ","", toupper(charge))) %>%
  select(-violent_description)

charge_hier <- left_join(charge_hier, pretrial_violent) %>%
  mutate(violent_psa_flag = if_else(is.na(violent_psa_flag), 0, violent_psa_flag))


# Charge Flags Added--Needs fixing
charge_hier <- charge_hier %>%
  mutate(capital_flag = if_else(charge_code == "PC" & charge %in% c("37", "128", "206", "2095", "218", "2361C2", "273AB"), 1, 0),
         dv_flag = if_else(grepl("DOMESTIC|SPOUSE|PARTNER|COHABITANT", master_charge_description) &
                             !grepl("MARRY|CRT ORD|COURT ORDER|FOREIGN|LAND|FAIL|SHELTER", master_charge_description), 1, 0),
         #Attach Flags DV and Sup Vio Flags #Sup Vio Based on Charge Descriptions--Including Flash Incarceration
         sup_vio_flag = if_else((grepl("^SUP| SUP |SUPERVISION|PROBATION|PAROLE", master_charge_description) &
                                  !grepl("^AGG ARSON|SUPV/ETC PROSTITUTION|MENTALY DISORDERD|^SEXUAL ACTIVITY|^SUPPLY|^ADL|SEX|TRANSFER|PROSTITUTION",
                                         master_charge_description))| charge %in% c("3454", "3455", "12032", "12032A"), 1, 0),
         fta_flag = if_else(grepl("APPEAR|FTA", master_charge_description) & !grepl("^DEMAND|WITNESS", master_charge_description), 1, 0),
         marijuana_flag = if_else(grepl("MARIJ|CANNA", master_charge_description), 1, 0),
         sex_flag = if_else(grepl("SEX|COPULATION|RAPE|ORAL|PENETRATION|MOLLEST|LASCIVIOUS|INCEST", 
                                  master_charge_description)|(charge_code == "PC" & charge %in% c("2434", "2641", "266H", "266I", "266J", "269", "272", "285", "286", "288",
                                                           "288a", "2882", "2884", "2885", "2887", "289", "3111", "31111", "314",
                                                           "6476", "653FC")), 1, 0),
         sb10_sex_flag = if_else(sex_flag == 1, 1, 0),
         dui_flag = if_else((charge_code == "VC" & charge %in% c("23546", "23153", "23578"))|(charge_code == "PC" & charge == "1915B"), 1, 0),
         sb10_dui_flag = if_else((charge_code == "VC" & charge %in% c("23546", "23153", "23578"))|(charge_code == "PC" & charge == "1915B"), 1, 0),
         restrain_flag = if_else(charge_code == "PC" & charge %in% c("166C4", "166D1", "27365A", "6499B"), 1, 0),
         sb10_witness_intim_flag = if_else(charge_code == "PC" & charge %in% c("1361", "1365"), 1, 0),
         sb10_onduty_inel_flag = if_else(charge_code == "PC" & charge %in% c("166", "18626", "18628", "18633", "240", "241", "2411", "2412", "2413",
                                                                             "2414", "2415", "2416", "2417", "2418", "242", "243", "2431", "2432",
                                                                             "24325", "2433", "24335", "2435", "2436", "24365", "2437", "2438",
                                                                             "24383", "2439", "24310", "24315", "2445", "245", "2456", "2463", "247",
                                                                             "2475","248", "120215", "12022A", "12022B", "12022C", "120222A",
                                                                             "120223B", "120225", "653M"), 1, 0),
         property_flag = if_else(oo_code %in% c("220", "70"), 1, 0),
         drug_flag = if_else(jbsis_code %in% c("230", "80"), 1, 0),
         minor_flag = if_else(charge %in% c("fix this"), 1, 0),
         pre_arr_inel_flag = if_else(charge %in% c("fix this"), 1, 0)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, as.numeric(.))))

save(charge_hier, file = "Complete Charge Code Hierarchy.RData")

# write.xlsx(charge_hier, file = "G:/CrimJustice/PretrialAssessmentPilot/Charge Definitions and Hierarchy/Complete Charge Hieararchy with Flags.xlsx", asTable = T, tableStyle = "TableStyleMedium1")
```

  Flag Excel for Legal
```{r}
load("Complete Charge Code Hierarchy.RData")

flag_list <- lapply(8:28, function(i) {
  df <- charge_hier %>%
    select(1:7, i) %>%
    filter_at(8, all_vars(. == 1)) %>%
    mutate(wrong_offense = 0, missing_offense = 0) %>%
    select(1:2, 4:6, 8:10, 3, 7)
}) 

write.xlsx(
  flag_list,
  "Offense Flags for Kara and Eve Sex Offenses.xlsx",
  asTable = T,
  tableStyle = "TableStyleMedium1",
  sheetName = c(
    "Special Allegations",
    "Serious Felonies",
    "Violent Felonies",
    "Serious and Violent Felonies",
    "PSA Violent",
    "Capital Offenses",
    "Domestic Violence",
    "Supervision Violations",
    "Failures to Appear",
    "Marijuana Offenses",
    "Sex Offenses",
    "SB 10 Sex Offenses",
    "DUIs",
    "SB10 DUIs",
    "Restrain Order Vios",
    "Witness Intimidation",
    "SB 10 Onduty Ineligibile",
    "JBSIS Property Offenses",
    "JBSIS Drug Offenses",
    "Minor Offenses",
    "SB 10 Pre Arraign Ineligible"
  ),
  colWidths = "auto",
  firstRow = T
)

flag_defs <- tibble(
  `Excel Tab Name` = c(
    "Special Allegations",
    "Serious Felonies",
    "Violent Felonies",
    "Serious and Violent Felonies",
    "PSA Violent",
    "Capital Offenses",
    "Domestic Violence",
    "Supervision Violations",
    "Failures to Appear",
    "Marijuana Offenses",
    "Sex Offenses",
    "SB 10 Sex Offenses",
    "DUIs",
    "SB10 DUIs",
    "Restrain Order Vios",
    "Witness Intimidation",
    "SB 10 Onduty Ineligibile",
    "JBSIS Property Offenses",
    "JBSIS Drug Offenses",
    "Minor Offenses",
    "SB 10 Pre Arraign Ineligible"
  ),
  `Flag Names` = names(charge_hier)[8:28],
  Definition = NA
)

write.xlsx(
  flag_defs,
  "Offense Flag Definitions for Kara and Eve.xlsx",
  asTable = T,
  tableStyle = "TableStyleMedium1",
  colWidths = "auto",
  firstRow = T
  )

serious_violent <- fread("G:/CrimJustice/PretrialAssessmentPilot/Charge Definitions and Hierarchy/Bail Deviation Exclusion List_for review by Pretrial Pilots - updated for research team 4-24-20.csv", header = T)

names(serious_violent) <- c("charge", "master_charge_description", "serious_flag", "violent_flag", "remove", "remove2", "remove3")

serious_violent <- serious_violent %>%
  filter(charge != "", !grepl("Conspiracy", master_charge_description)) %>%
  select(1:4) %>%
  separate_rows(charge, sep = "/") %>%
  mutate_at(vars(contains("flag")), funs(if_else(. == "", 0, 1))) %>%
  mutate(master_charge_description = gsub("\t", "", master_charge_description),
         charge_level = "F",
         charge_code = case_when(grepl("^Veh", charge) ~ "VC",
                                 grepl("^Health", charge) ~ "HS",
                                 grepl("^Military|^Election", charge) ~ "Other",
                                 grepl("^Welf", charge) ~ "WI",
                                 T ~ "PC"),
         charge = gsub("&| |\\.", "", charge),
         charge = gsub("\\/|\\(|\\)| |\\.|\\.*|\\\\.*|\\{|\\}|\\*|^[A-Z]*","", toupper(charge))) %>%
  unite(join_var, charge_level, charge_code, charge, remove = F) %>%
  mutate(master_charge_description = toupper(master_charge_description)) %>%
  select(join_var, master_charge_description, charge_level, charge_code, charge, serious_flag, violent_flag)

missing_df <- anti_join(serious_violent, charge_hier, by = "join_var") 

write.xlsx(missing_df, file = "G:/CrimJustice/PretrialAssessmentPilot/Charge Definitions and Hierarchy/Missing Serious and Violent Charges.xlsx")
```

  
Flag Add Diagnostics
```{r eval=FALSE, include=FALSE}
charge_hier %>%
  summarise_at(vars(dv_flag:violent), sum)

charge_hier %>%
  filter(violent == 1)

# lapply(names(charge_hier)[grepl("flag", names(charge_hier))], function(i){
#   
#   charge_hier %>%
#     filter(get(i) == 1) %>%
#     select(charge_level, charge_code, charge, master_charge_description, i)
#     
# })

#PC 12032, 
#6675 B

charge_hier %>%
  filter(grepl("300008", join_var))

charge_hier %>%
  filter(dv_flag == 1)

charge_hier %>%
  mutate(dv_fake = if_else(grepl("DOMESTIC|SPOUSE|PARTNER|COHABITANT", master_charge_description), 1, 0)) %>%
  count(dv_flag, dv_fake)

flag_list <- lapply(8:28, function(i) {
  df <- charge_hier %>%
    select(1:7, i) %>%
    filter_at(8, all_vars(. == 1)) %>%
    mutate(wrong_offense = 0, missing_offense = 0) %>%
    select(1:2, 4:6, 8:10, 3, 7)
}) 

charge_hier %>%
  select(1:7)

charge_hier[charge_hier[,8] == 1,]

charge_hier 
```

Lawyer Reviewed Flags
```{r}
file <- "G:/CrimJustice/PretrialAssessmentPilot/Charge Definitions and Hierarchy/Legal Review of Offense Flags.xlsx"

# getSheetNames(file)


df_list <- lapply(c(2:4, 6:22), function(i){
  df <- read_excel(file, sheet = i) %>%
    mutate_all(as.character)
  
  names(df) <- tolower(names(df))
  
  return(df)
})


charge_df <- bind_rows(df_list)

charge_df <- charge_df %>%
  mutate_all(funs(if_else(is.na(.), "0", .))) %>%
  mutate(wrong_offense = if_else(wrong_offense == "1" & grepl("Already captured|repealed|extra numbers", notes), 
                                 "0", 
                                 wrong_offense),
         dv_possible_flag = if_else(grepl("DV depending", notes), "1", "0"),
         charge_level = if_else(charge_level == "0", "Other", charge_level),
         join_var = if_else(!grepl("_.*_", join_var), paste(charge_level, charge_code, charge, sep = "_"), join_var)) %>% 
  select(-c(charge_level, charge_code, charge)) %>%
  separate(join_var, c("charge_level", "charge_code", "charge"), sep = "_", remove = F) %>% 
  filter(wrong_offense != "1") %>%
  select(-contains("notes"), -`sarah review`, -not_charge, -wrong_offense, -missing_offense) %>%
  group_by(join_var) %>%
  mutate_at(vars(hierarchy, jbsis_code, contains("flag")), parse_number) %>%
  summarise_all(max) 
  
  
load("Complete Charge Code Hierarchy Base.RData")

#Fixing missing JBSIS Codes
doj_hierarchy_2020_jbsis <- read_excel("G:/CrimJustice/PretrialAssessmentPilot/Charge Definitions and Hierarchy/2020_March04_DOJ_Offense_Table_JBSIS.xlsx")

names(doj_hierarchy_2020_jbsis) <- c("offense_id", "cjis_code", "hierarchy", "charge_level", "charge", "charge_code", "master_charge_description", "sentence", "jbsis_code")

doj_hierarchy_2020_jbsis <- doj_hierarchy_2020_jbsis %>%
  mutate(charge_level = toupper(charge_level),
         charge_level = if_else(!charge_level %in% c("F", "I", "M"), "Other", charge_level),
         charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}|EX|\\+|","", charge)),
         charge_code = if_else(!charge_code %in% c("PC", "VC", "HS", "BP", "WI", "US"), "Other", charge_code)) %>%
  distinct(charge, charge_code, charge_level, .keep_all = T) %>%
  unite(join_var, charge_level, charge_code, charge, remove = F) %>%
  select(join_var, jbsis_code)


charge_hier <- charge_hier %>%
  select(-jbsis_code) %>%
  #Fixing a few codes manually that didn't match on to the DOJ data. We selected the top 7 codes which were not matched.
  left_join(doj_hierarchy_2020_jbsis, by = "join_var") %>%
  mutate(jbsis_code = if_else(join_var == "M_HS_113641A", 230, jbsis_code),
         jbsis_code = if_else(join_var == "M_PC_484488", 220, jbsis_code),
         jbsis_code = if_else(join_var == "M_BP_4140", 230, jbsis_code),
         jbsis_code = if_else(join_var == "F_PC_12020A", 90, jbsis_code),
         jbsis_code = if_else(join_var == "F_PC_45736", 90, jbsis_code))

# Updated 1/7/2021 to match jbsis codes to charges with missing jbsis codes determined by the base charge, when there is no conflict of jbsis codes.
# SB 10 flags are also removed due to its failure. 
charge_hier <- charge_hier %>%
  mutate(charge_start = as.integer(parse_number(charge)),
         jbsis_code = if_else(is.na(jbsis_code)|jbsis_code == 0, 1000, jbsis_code)) %>%
  group_by(charge_level, charge_code, charge_start) %>%
  mutate(n = sum(!(unique(jbsis_code) %in% c(1000, 90, 250, 270)))) %>%
  mutate(jbsis_code = if_else(jbsis_code == 1000 & n %in% 0:1, min(jbsis_code), jbsis_code)) %>%
  ungroup() %>%
  mutate(#Fixing property and drug jbsis flagsdd
         property_flag = if_else(jbsis_code %in% c("220", "70"), 1, 0),
         drug_flag = if_else(jbsis_code %in% c("230", "80"), 1, 0))


match_df <- charge_hier %>%
  select(join_var) %>%
  inner_join(charge_df, by = "join_var")

match_df2 <- charge_hier %>%
  select(join_var:jbsis_code) %>%
  anti_join(charge_df, by = "join_var") 
  
match_df3 <- charge_df %>%
  anti_join(charge_hier, by = "join_var") 

 
charge_hier <- bind_rows(match_df, match_df3, match_df2) %>%
  distinct(join_var, .keep_all = T) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, .))) %>%
  select(-contains("sb10")) 

save(charge_hier, file = "Complete Charge Code Hierarchy.RData")

# load("Complete Charge Code Hierarchy.RData")
# 
# charge_hier %>%
#   filter(property_flag == 1)
# 
# charge_hier %>%
#   filter(property_flag == 1, grepl("GRAND THEFT", master_charge_description))
# 
# 
# charge_hier %>%
#   filter(property_flag == 1, grepl("487", charge))
# 
# charge_hier %>%
#   filter(property_flag == 0, grepl("GRAND THEFT", master_charge_description))
# 
# charge_hier %>%
#   mutate(property_flag = if_else())


  
# 
# charge_hier %>%
#   ungroup() %>%
#   filter(charge_start == 487) %>%
#   count(jbsis_code, charge_level)
#   filter(jbsis_code == 270)
#   count(jbsis_code)
#   filter(charge_level == "M", jbsis_code < 100)
# 
#   group_by(charge_level, charge_code, charge_start) %>%
#   add_count() %>%
#   arrange(desc(nn))
#   filter(n > 1)
# 
# charge_hier %>%
#   filter(as.integer(parse_number(charge)) == 4324)
# 
# charge_hier %>%
#   filter(grepl("^647[A-Z]", charge))
# 
# sum(unique(c("A", "B", "0")) != 0)
# 
# charge_hier %>%
#   filter(jbsis_code == 1000, special_flag == 0)
# 
# charge_hier <- charge_hier %>%
#   mutate(charge_start = as.integer(parse_number(charge)),
#          jbsis_code = if_else(is.na(jbsis_code)|jbsis_code == 0, 1000, jbsis_code)) %>%
#   group_by(charge_level, charge_code, charge_start) %>%
#   # mutate(n = sum(!(unique(jbsis_code) %in% c(1000, 90, 250, 270)))) %>%
#   mutate(jbsis_code = if_else(jbsis_code == 1000, min(jbsis_code), jbsis_code)) %>%
#   ungroup()

# charge_hier_jbsis %>%
#   filter(charge == "11377A")
# 
# shell.exec(getwd())

# charge_hier %>%
#   filter(grepl("45736", charge))
# 
# doj_hierarchy_2020_jbsis %>%
#   filter(grepl("12020", join_var))
```


# Alameda

Jail Data
```{r}
# Jail Bookings Data Import--- Alameda, 2015-01-01 to 2020-01-01
  ## book_df contains one row per booking and includes information on the person as well as the time of booking and release. It contains no charge information.
  ## book_charge contains one row per charge and includes the charge information on each of the bookings from book_df which are joined on the book_num. 

####

# Person Data--Integrated County
  ## person_df contains one row per event/person combination.
# person_df <- fread("Historical Data Submissions/Alameda/P2 Submission-June 30/11_05_2020/1_Identifiers And Demographics.csv")
person_df <- read_excel("Historical Data Submissions/Alameda/P3 Submission-Jan 15/2.5.21/IdentifiersAndDemographicsBookings07012016to12312020.xlsx")

# Variable name standardization--See pg. xxx for more details. 
  ## Variable race_code is redundant and will be dropped. 

names(person_df) <- c("event_id", "local_id", "first_name", "last_name", "dob", "cii", "fbi", "race_original", "sex_original", "cdl_id", "cdl_state",  "zip_code", "arrest_date", "book_date", "assessment_flag") 


#Removing Dates because they are found on the booking table.
person_df <- person_df %>%
  select(-book_date, -arrest_date)


# Standardize Factors--See pg. xxx for more details.
person_df <- person_df %>%
  mutate(sex = case_when(sex_original %in% c("M") ~ "Male",
                         sex_original %in% c("F") ~ "Female"),
         
  ## Trimming white space on original race first
         race_original = trimws(race_original),
         race = case_when(race_original %in% c("BLACK") ~ "Black",
                          race_original %in% c("HISPANIC") ~ "Hispanic",
                          race_original %in% c("WHITE") ~ "White",
                          T ~ "Other_Unknown"))

# Booking Data
  ## book_df contains one row per booking and includes information on the person as well as the time of booking and release. It contains no charge information.
  ## Ask Alameda meaning of booking sequence number.
book_df <- read_excel("Historical Data Submissions/Alameda/P3 Submission-Jan 15/2.5.21/Bookings07012016to12312020.xlsx", col_types = "text")

# Variable name standardization--See pg. xxx for more details. 
  ## Variable race_code is redundant and will be dropped. 
names(book_df) <- c("event_id", "book_num", "local_id", "booking_seq", "book_type_original", "arrest_date", "arrest_time", "arrest_agency", "book_date", "book_time", "bail_type", "book_location", "bail_amt", "release_date", "release_time", "release_type_original")

# Date Reformatting--See pg. xxx for more details.
  ## booking_sequence and courtcase_id are also fixed here as well. 
book_df <- book_df %>%
  mutate(arrest_date_time = convertToDateTime(as.numeric(arrest_date) + as.numeric(arrest_time)),
         book_date_time = convertToDateTime(as.numeric(book_date) + as.numeric(book_time)),
         release_date_time = convertToDateTime(as.numeric(release_date) + as.numeric(release_time) - 25569)) %>%
  mutate_at(vars(arrest_date, book_date, release_date), convertToDate) %>%
  select(-arrest_time, -book_time, - release_time) %>%
  mutate(booking_seq = as.integer(booking_seq))



# Standardize Factors--See pg. xxx for more details.
book_df <- book_df %>%
  mutate(book_type_original = trimws(book_type_original),
         book_type = case_when(book_type_original %in% c("ONVIEW") ~ "On_View",
                               book_type_original %in% c("DA WARRANT") ~ "New_Warrant",
                               book_type_original %in% c("WARRANT") ~ "Other_Warrant",
                               book_type_original %in% c("ENROUTE") ~ "Hold",
                               book_type_original %in% c("DA CITATION", "CITATION") ~ "Cite_Release",
                               book_type_original %in% c("COURT") ~ "Court_Order",
                               book_type_original %in% c("DRUNK") ~ "Detain_Only",
                               book_type_original %in% c("NULL") ~ "Unknown",
                               T ~ "Other"),
         
         release_type_original = trimws(release_type_original),
         release_type = case_when(release_type_original %in% c("GROSS TIME SERVED", "PROBATION (FORMAL)", 
                                                               "WORK TIME SERVED", "PART TIME SERVED") ~ "Time_Served",
                                  release_type_original %in% c("RELEASED ENROUTE", "HOLD DROPPED", 
                                                               "PAST TIME TO PICK UP", "PICKED UP OUT OF AGENCY") ~ "Hold_Release",
                                  release_type_original %in% c("CITATION IN JAIL AFTER BOOKING") ~ "Cite_Release",
                                  release_type_original %in% c("BAIL", "BAIL BOND") ~ "Bail_Bond",
                                  release_type_original %in% c("DISMISSED", "NO COMPLAINT") ~ "Dismissed_Dropped",
                                  release_type_original %in% c("OWN RECOGNIZANCE") ~ "OR",
                                  release_type_original %in% c("ORDERED RELEASED") ~ "Court_Order",
                                  release_type_original %in% c("OWN RECOGNIZANCE TO PROGRAM") ~ "OR_Conditions",
                                  release_type_original %in% c("IDENTIFIED AND RELEASED") ~ "Administrative",
                                  release_type_original %in% c("STATE PRISON TERM PRESCRIBED") ~ "Prison",
                                  release_type_original %in% c("RELEASED (UNCODED REASON)") ~ "Unknown",
                                  T ~ "Other"),
         warrant_flag = if_else(grepl("Warrant", book_type), 1, 0),
         onview_flag = if_else(grepl("On_View", book_type), 1, 0))
####

# Jail Booking Charges Data Import.
  ## book_charge contains one row per charge and includes the charge information on each of the bookings from book_df which are joined on the book_num.  
book_charge <- read_excel("Historical Data Submissions/Alameda/P3 Submission-Jan 15/2.5.21/ArrestCharges07012016to12312020.xlsx")


# Variable name standardization--See pg. xxx for more details. 
names(book_charge) <- c("event_id",  "local_id", "book_num", "book_date", "booking_seq", "arrest_charge_count", "arrest_charge_level_original", "arrest_charge_original")

# Date Reformatting--See pg. xxx for more details.
  ## booking_sequence and courtcase_id are also fixed here as well. 
book_charge <- book_charge %>%
  select(-book_date)


# Standardize Charges and join charge hierarchy--See pg. xxx for more details about this process. 
  # Book Charge contains "Re-Arrest" charges for booking sequences greater than one. These are removed as there are no associated charges.
book_charge <- book_charge %>%
  mutate(attempt_flag = if_else(grepl("664", arrest_charge_original), 1, 0),
         arrest_charge = if_else(arrest_charge_original == "RE-ARREST", "REARREST", arrest_charge_original),
         arrest_charge = if_else(arrest_charge == "NULL", NA_character_, arrest_charge)) %>%
  separate_rows(arrest_charge, sep = "\\\\|\\-|\\/") %>%
  mutate(
         arrest_charge_level = case_when(
           arrest_charge_level_original == "Felony" ~ "F",
           arrest_charge_level_original == "Infraction" ~ "I",
           arrest_charge_level_original == "Misdemeanor" ~ "M",
           T ~ "Other"),
         arrest_charge_code = str_extract(arrest_charge, "^.."),
         arrest_charge_code = if_else(!arrest_charge_code %in% c("PC", "VC", "HS", "BP", "WI", "US"),
                                      "Other", arrest_charge_code),
         arrest_charge = gsub("^.. *", "", arrest_charge),
         arrest_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}|EX|\\+|R$| [A-Z]*","",
                                      arrest_charge))) %>%  
  filter(!arrest_charge %in% c("1", "2", "1St", "2ND", "664", "")) %>% 
  mutate(arrest_charge_level = if_else(arrest_charge == "120221" & arrest_charge_level == "F" & arrest_charge_code == "PC", "Other", arrest_charge_level),
         arrest_charge_level = if_else(arrest_charge == "3455" & arrest_charge_level == "Other" & arrest_charge_code == "PC", "F", arrest_charge_level)) %>%
  unite(join_var, arrest_charge_level, arrest_charge_code, arrest_charge, remove = F)
  
load("Complete Charge Code Hierarchy.RData")
  
book_charge <- book_charge %>%
  left_join(charge_hier) %>%
  rename_at(vars(contains("flag")), funs(paste0("arrest_", .))) %>%
  mutate(arrest_felony_flag = if_else(arrest_charge_level == "F", 1, 0),
         arrest_misd_flag = if_else(arrest_charge_level == "M", 1, 0)) 
  
charge_hier
```
  
  Jail Collapse
```{r}
# Getting rid of one duplicate
person_df <- person_df %>%
  distinct(event_id, .keep_all = T)

# Booking Join--All booking data frames are combined.
book_df <- left_join(book_df %>% mutate(across(c(event_id, book_num), as.numeric)), book_charge %>% mutate(booking_seq = as.integer(booking_seq)))

# Booking Collapse--See pg. xxx for more details about this process. 
book_df <- book_df %>%
  mutate(time_first_release = release_date_time - book_date_time) %>%
  mutate(hierarchy = if_else(is.na(hierarchy), 1e6, as.numeric(hierarchy))) %>%
  group_by(event_id, book_num, book_date) %>%
  # select(-c("arrest_charge"))
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, .))) %>%
  mutate_at(vars(contains("flag")), funs("count" = sum(.))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  mutate(join_var = paste(join_var, collapse = " ")) %>%
  # group_by(event_id, book_num, book_date) %>%
  filter(hierarchy == min(hierarchy)) %>%
  distinct(book_num, book_date, event_id, .keep_all = T) %>%
  ungroup()

save(book_df, file = "G:/CrimJustice/PretrialAssessmentPilot/Agency Collapse CSV Files/Alameda Booking Collapse.RData")
```


Court Data
```{r}
# Court Case Data Import--- Alameda, 2015-01-01 to 2019-12-31
  ## court_df contains one row per court case and includes information on the person as well as case status and case type. 
  ## court_fta contains one row per charge and includes the charge information on each of the bookings from book_df which are joined on the book_num. 
  ## court_fta_war contains one row per fta event (with a bench warrant issued) as well as one NULL row for each case without an fta bench warrant issued event. 
  ## court_hearing contains one row per hearing event on each court case and includes informatioin about each hearing.
  ## court_charge contains one row per each charge associated with a court case and includes information on the charges and dispostions of the court case. 
  ## court_sent contains one row per sentence event component in which the sentence event is confinement and one NULL row for each court case without a sentence event.
  ## court_sent2 contains one row per sentence event component in which the sentence event is supervision (e.g. probation) and one NULL row for each court case without a sentence event. Sometimes terms for each sentence event are split across rows and are considered different sentence components. 

####

####

# Court Filing Charges 
  ## court_charge contains one row per each charge associated with a court case and includes information on the charges and dispostions of the court case. 
court_charge <- read_excel("Historical Data Submissions/Alameda/P3 Submission-Jan 15/2.5.21/ChargeFilingsForBookings07012016to12312020.xlsx")

# Variable name standardization--See pg. xxx for more details. 
names(court_charge) <- c("event_id", "local_id", "court_case_id", "court_docket_id", "court_charge_id", "court_charge_count", "court_charge_sequence_number", "court_charge_stage", "file_date", "court_charge_level_original", "court_charge_original", "court_charge_description", "court_charge_amend_type")

# Date Reformatting--See pg. xxx for more details.
court_charge <- court_charge %>%
  mutate(file_date = as_date(file_date))


# Charge Standardization and Flag Adds--See pg. xxx for more details.
court_charge <- court_charge %>%
  mutate(court_charge_code = str_extract(trimws(court_charge_description), "^.." ),
         court_charge_code = if_else(!court_charge_code %in% c("PC", "VC", "HS", "BP", "WI", "US"), "Other",
                                     court_charge_code),
         court_charge_level = str_extract(trimws(court_charge_level_original), "^." ),
         court_charge_level = if_else(!court_charge_level %in% c("F", "I", "M"), "Other", court_charge_level),
         court_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}|\\+|-.*","", court_charge_original))) %>%
  mutate(attempt_flag = if_else(grepl("-664", court_charge_original), 1, 0)) %>%
  separate_rows(court_charge, sep = "-") %>%
  filter(!court_charge %in% c("F", "M", "I", "664", "1", "2", "")) %>%
  unite(join_var, court_charge_level, court_charge_code, court_charge, remove = F) 

load("Complete Charge Code Hierarchy.RData")

court_charge <- left_join(court_charge, charge_hier, by = "join_var") %>%
  mutate(felony_flag = if_else(court_charge_level == "F", 1, 0),
         misd_flag = if_else(court_charge_level == "M", 1, 0)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, as.numeric(.)))) %>% 
  rename_at(vars(contains("flag"), -contains("conviction")), funs(paste0("court_", .)))


####

# Court Dispositions
court_dispo  <- read_excel("Historical Data Submissions/Alameda/P3 Submission-Jan 15/2.5.21/DispositionsForBookings07012016to12312020.xlsx")

# Variable name standardization--See pg. xxx for more details. 
names(court_dispo) <- c("event_id", "local_id", "court_case_id", "court_docket_id", "court_charge_id", "court_charge_count", "court_charge_sequence_number", "court_charge_stage", "disposition_date", "court_charge_level_original", "court_charge_original", "court_charge_description", "disposition_type_original", "book_date")

# Date Reformatting--See pg. xxx for more details.
court_dispo <- court_dispo %>%
  mutate(disposition_date = as_date(disposition_date)) %>%
  select(-book_date)


# Standardize Factors--See pg. xxx for more details.
court_dispo <- court_dispo %>%
  mutate(disposition_type = case_when(
           disposition_type_original %in% c("Plea of Guilty/Nolo", 
                                            "Found True",  "Certified for Sentencing",
                                            "Court Finding of Guilt", "Convicted - Guilty Plea", "Jury Verdict of Guilty",
                                            "Court Finds Guilty - Lesser Included/Reasonably Related Off",
                                            "Certified Convicted Guilty", 
                                            "Admit", "Guilty",
                                            "Guilty Plea to Lesser/Reasonably Related Charge", 
                                            "Certified Convicted Guilty") ~ "Guilty",
           disposition_type_original %in% c("Convicted - No Contest", "No Contest", "Certified Convicted No Contest",
                                            "No Contest Plea to Lesser/Reasonably Related Charge") ~ "Nolo_Contendere",
           grepl("Dism|DISM", disposition_type_original) ~ "Dismissed",
           disposition_type_original %in% c("Jury Verdict of Not Guilty", "Found Not True", "Court Finding of Not Guilty",
                                            "Jury Verdict Found Not True","Acquittal", 
                                            "Not Guilty By Reason of Insanity","After jury trial - Acquittal")|
             grepl("Not Guilty", disposition_type_original) ~ "Not_Guilty",
           T ~ "Other")) 

# Charge Standardization and Flag Adds--See pg. xxx for more details.
  ## Charges on contained on the filing and disposition tables.
court_dispo <- court_dispo %>%
  mutate(court_charge_code = str_extract(trimws(court_charge_description), "^.." ),
         court_charge_code = if_else(!court_charge_code %in% c("PC", "VC", "HS", "BP", "WI", "US"), "Other",
                                     court_charge_code),
         court_charge_level = str_extract(trimws(court_charge_level_original), "^." ),
         court_charge_level = if_else(!court_charge_level %in% c("F", "I", "M"), "Other", court_charge_level),
         court_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}|\\+|-.*","", court_charge_original))) %>%
  mutate(attempt_flag = if_else(grepl("-664", court_charge_original), 1, 0)) %>%
  separate_rows(court_charge, sep = "-") %>%
  filter(!court_charge %in% c("F", "M", "I", "664", "1", "2", "")) %>%
  unite(join_var, court_charge_level, court_charge_code, court_charge, remove = F) 

load("Complete Charge Code Hierarchy.RData")

court_dispo <- left_join(court_dispo, charge_hier, by = "join_var") %>%
  mutate(felony_flag = if_else(court_charge_level == "F", 1, 0),
         misd_flag = if_else(court_charge_level == "M", 1, 0)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, as.numeric(.)))) %>%
  mutate_at(vars(contains("flag")), funs("conviction" = if_else(. == 1 & disposition_type %in% c("Guilty", "Nolo_Contendere"), 1, 0))) %>%
  rename_at(vars(contains("flag"), -contains("conviction")), funs(paste0("court_", .))) %>%
  rename_at(vars(contains("conviction")), funs(paste0("conviction_", gsub("_conviction", "", .)))) 


####

# Court Hearings
  ## court_hearing contains one row per hearing event on each court case and includes informatioin about each hearing including FTAs. 

court_hearing <- read_excel("Historical Data Submissions/Alameda/P3 Submission-Jan 15/2.5.21/HearingsForBookings07012016to12312020.xlsx")


# Variable name standardization--See pg. xxx for more details.
names(court_hearing) <- c("event_id", "local_id", "court_case_id", "court_docket_id", "hearing_type_original", "hearing_date", "hearing_time", "hearing_result_original", "fta_all_flag")


# Date Reformatting--See pg. xxx for more details.
court_hearing <- court_hearing %>%
  mutate(hearing_date_time = as_datetime(as.numeric(hearing_date) + as.numeric(hearing_time)) + years(70),
         hearing_date = as_date(hearing_date),
         fta_date = if_else(fta_all_flag == "BWI", hearing_date, NA_Date_)) %>%
  select(-hearing_time)


# Standardize Factors--See pg. xxx for more details.
court_hearing <- court_hearing %>%
  mutate(hearing_type = case_when(grepl("Arraignment", hearing_type_original) ~ "Arraignment",
                                  grepl("Sentence", hearing_type_original) ~ "Sentencing",
                                  T ~ "Other"))
  
# Flag Adds--See pg. xxx for more details.
court_hearing <- court_hearing %>%
  mutate(fta_all_flag = if_else(fta_all_flag == "BWI", 1, 0),
         fta_flag = if_else(hearing_result_original == "FTA", 1, 0))


####

# Court Sentences  
  ## court_sent contains one row per sentence event component in which the sentence event is confinement and one NULL row for each court case without a sentence event. Sometimes terms for each sentence event are split across rows and are considered different sentence components.  
  ## Why are there only 47 sentences
court_sent <- read_excel("Historical Data Submissions/Alameda/P3 Submission-Jan 15/2.5.21/SentencingForBookings07012016to12312020.xlsx")


# Variable name standardization--See pg. xxx for more details.
names(court_sent) <- c("event_id", "local_id", "court_case_id", "court_docket_id", "case_type", "arrest_date", "sentence_date",
                       "sentence_type_original", "term_type", "sentence_start_date", "sentence_end_date", "sentence_days",
                       "sentence_months", "sentence_years", "sentence_life", "sentence_facility", "sentence_comment",
                       "new_conditions", "condition_start_date")


# Date Reformatting--See pg. xxx for more details.
court_sent <- court_sent %>%
  mutate_at(vars(contains("date")), funs(if_else(grepl("-", .), as_date(.), convertToDate(.)))) %>%
  distinct()


# Standardize Factors--See pg. xxx for more details.
court_sent <- court_sent %>%
  filter(sentence_type_original != "NULL") %>%
  mutate(sentence_type = case_when(grepl("Jail", sentence_type_original) ~ "Jail",
                                  grepl("Prison", sentence_type_original) ~ "Prison",
                                  grepl("Probation", sentence_type_original) ~ "Probation",
                                  T ~ "Other"))

####

# Court Pleas 
  ## court_sent contains one row per sentence event component in which the sentence event is confinement and one NULL row for each court case without a sentence event. Sometimes terms for each sentence event are split across rows and are considered different sentence components.  
court_plea <- read_excel("Historical Data Submissions/Alameda/P3 Submission-Jan 15/2.5.21/PleasForBookings07012016to12312020.xlsx")

# Variable name standardization--See pg. xxx for more details.
names(court_plea) <- c("event_id", "local_id", "court_case_id", "court_docket_id", "court_charge_id", "court_charge_count", "court_charge_sequence_number", "charge_stage", "plea_date", "court_charge_level_original", "court_charge_description", "plea_type_original", "plea_amend_type")

# Date Reformatting--See pg. xxx for more details.
court_plea <- court_plea %>%
  mutate(plea_date  = as_date(plea_date)) %>%
  distinct()

# Standardize Factors--See pg. xxx for more details.
court_plea <- court_plea %>%
  mutate(plea_type = case_when(grepl("No Contest|Nolo", plea_type_original) ~ "Nolo Contendere",
                               grepl("Not Guilty", plea_type_original) ~ "Not Guilty",
                               grepl("^Guilty", plea_type_original) ~ "Guilty"))  %>%
  #Removing charges because they are already on court charges.
  select(-c(court_charge_level_original, court_charge_description))

```

  Court Collapse
```{r}

  ## Ask about court charge count and court charge sequence number

# Combining court_charges and court_dispo into one charges table
  ## Deduplicating charges with mulitiple filings/dates to take the earliest and/or first one
court_charge <- court_charge %>%
  arrange(file_date) %>%
  distinct(event_id, court_charge_id, .keep_all = T)

  ## Taking the first disposition date on each charge while maintaining flags for conviction
court_dispo <- court_dispo %>%
  group_by(event_id, court_charge_id) %>%
  mutate_at(vars(contains("flag")), max) %>%
  ungroup() %>%
  arrange(disposition_date) %>%
  distinct(event_id, court_charge_id, .keep_all = T)


court_charge2 <- court_charge %>%
  select(-file_date) %>%
  anti_join(court_dispo, by = c("court_case_id", "event_id"))

  ## Combining
court_charge2 <- bind_rows(court_dispo, court_charge2 %>% mutate(court_charge_count = as.numeric(court_charge_count)))

  ## Adding Back on Filing Date
court_filing <- court_charge %>%
  select(court_charge_id, file_date, event_id)

court_charge2 <- court_charge2 %>%
  left_join(court_filing)


# Court Charge Collapse--See pg. xxx for more details about this process. 
suppressWarnings(court_charge2 <- court_charge2 %>%
  mutate(disposition_type = ordered(disposition_type, levels = c("Other", "Dismissed", "Not_Guilty", "Nolo_Contendere", "Guilty"))) %>%
  group_by(court_case_id, event_id) %>%
  mutate(disposition_date = max(disposition_date),
         disposition_type = max(disposition_type)) %>%
  mutate(hierarchy = if_else(is.na(hierarchy), 1e6, as.numeric(hierarchy))) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, .))) %>%
  mutate_at(vars(contains("flag")), funs("count" = sum(.))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  mutate(join_var = paste(join_var, collapse = " ")) %>%  
  filter(hierarchy == min(hierarchy)) %>%
  ungroup() %>%
  distinct(court_case_id, event_id, .keep_all = T))


# Court FTAs are collapsed to each case. 
  ## Court FTA war is used due to the very small number of ftas that do not have a bench warrant issued along with it.  
court_fta_war <- court_hearing %>%
  filter(!is.na(fta_date)) %>%
  arrange(fta_date) %>%
  group_by(court_case_id) %>%
  mutate(fta_flag = max(fta_flag),
         fta_flag_count = sum(fta_flag)) %>%
  distinct(court_case_id, .keep_all = T) %>%
  select(court_case_id, fta_date, fta_flag, fta_all_flag)


# Court hearings are filtered for arraignment information and collapsed to court case id. 
court_arraignment <- court_hearing %>%
  filter(hearing_type == "Arraignment") %>%
  arrange(hearing_date) %>%
  rename(arraignment_date = hearing_date,
         arraignment_date_time = hearing_date_time) %>%
  arrange(arraignment_date) %>%
  distinct(court_case_id, .keep_all = T) %>%
  select(court_case_id, arraignment_date, arraignment_date_time)


# Court hearings are filtered for plea events  and collapsed to court case id. 
  ## The disposition prefix in this case is misleading because of Alameda's vertifcal data structure. It actually represents plea information when filtered for the the "Plea Event" stage.  
court_plea <- court_plea %>%
  filter(!is.na(plea_date)) %>%
  arrange(plea_date) %>%
  mutate(guilty_plea_flag = if_else(plea_type %in% c("Guilty", "Nolo_Contendere"), 1, 0)) %>%
  group_by(court_case_id) %>%
  mutate(guilty_plea_flag = max(guilty_plea_flag)) %>%
  ungroup() %>%
  distinct(court_case_id, .keep_all = T) %>%
  select(court_case_id, plea_date, plea_type, guilty_plea_flag)


# Court sentences are combined and collapsed to court case id. 
  ## Currently whatever is in the top row of sentence type is filtered. E.g. if the first row is "Jail" and the second is "Prison", "Jail" will be the selected row. However, confinement is always given priority over any type of supervision because court_sent contains sentences to confinment and and court_sent2 contains sentences to supervision.  
court_sent <- court_sent %>%
  arrange(sentence_date) %>%
  mutate(sentence_type = ordered(sentence_type, levels = c("Other", "Probation", "Jail", "Prison"))) %>% 
  group_by(court_case_id) %>%
  mutate(sentence_type = max(sentence_type)) %>%
  ungroup() %>%
  distinct(court_case_id, .keep_all = T) %>%
  select(court_case_id, sentence_date, sentence_type_original, sentence_type)

# All data is joined.
court_df <- reduce(list(court_charge2, court_arraignment, court_fta_war, court_plea, court_sent), left_join, by = "court_case_id") %>%
  select(-contains(".y")) %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x", "", .))) %>%
  mutate(pretrial_end_date = if_else(disposition_date < sentence_date|is.na(sentence_date), disposition_date, sentence_date),
         conviction_flag = if_else(disposition_type %in% c("Nolo_Contendere", "Guilty"), 1, 0))

save(court_df, file = "G:/CrimJustice/PretrialAssessmentPilot/Agency Collapse CSV Files/Alameda Court Collapse.RData")
```


Assessment Data
```{r}
# Alameda Assessment Data Import
  ## assess_df contains one row per risk assessment event/risk assessment question/pretrial terms and conditions. The tool questions are widened into columns.

# May be missing earlier assessments from PHASE 1. 
####

# Assessments Data Import
  ## assess_df contains one row per risk assessment event/risk assessment question/pretrial terms and conditions. The questions are widened into columns.
# assess_df <- read_excel("Historical Data Submissions/Alameda/P2 Submission-June 30/4_Assessment-and-Recommendation.xls", col_types = "text")
# 
# assess_prearraignment <-  read_excel("Historical Data Submissions/Alameda/P2 Submission-June 30/5_Judicial-Order-Prearraignment.xls", col_types = "text")
# 
# assess_hearing <- read_excel("Historical Data Submissions/Alameda/P2 Submission-June 30/6_Judicial-Order-Hearing.xls", col_types = "text")

#Renamind assess_status assess_df for now. Using Vprai-R
    ## Contains summarised information from assess_rec, assess_decision, and assess_monitor. 

####

# Pretrial Assessments and Recommendations
assess_rec <- read_excel("Historical Data Submissions/Alameda/P3 Submission-Jan 15/2.5.21/PT3_AssessmentsAndRecommendations_PHASE2.xlsx")

# Variable name standardization--See pg. xxx for more details.
  ## This table includes tool and pretrial service recommendations. These values are often seperate. 
names(assess_rec) <- c("event_id", "local_id", "tool_name", "assessment_date", "sup_approval_date", "sup_approval_time", "pc_dec_avail", "non_participant", "non_par_reason", "vprair_tool_response_1", "vprair_tool_response_2", "vprair_tool_response_3", "vprair_tool_response_4", "vprair_tool_response_5", "vprair_tool_response_6", "vprair_tool_response_7", "vprair_tool_response_8", "vprair_release_recommendation_original", "vprair_release_recommendation_original_level", "vprair_release_recommendation_condition_original", "release_recommendation_original", "release_recommendation_level_original")


 
# Date Reformatting--See pg. xxx for more details.
assess_rec <- assess_rec %>%
  select(-sup_approval_time) %>%
  mutate(assessment_date = convertToDate(assessment_date),
         sup_approval_date = as_date(sup_approval_date))

# Risk Score Standardization--Tool Response values are changed to their numeric point value.
assess_rec <- assess_rec %>%
  mutate_if(is.character, funs(if_else(. == "NULL"|. == ""|. == "N/A", NA_character_, .))) %>%
  mutate_at(vars(contains("vprair_tool_response")), funs(if_else(. == "No Data", NA_character_, .))) %>%
  mutate(vprair_tool_response_1 = if_else(vprair_tool_response_1 == "Y", 2, 0),
         vprair_tool_response_2 = if_else(vprair_tool_response_2 == "Y", 3, 0),
         vprair_tool_response_3 = if_else(vprair_tool_response_3 == "Y", 2, 0),
         vprair_tool_response_4 = if_else(vprair_tool_response_4 == "Y", 2, 0),
         vprair_tool_response_5 = if_else(vprair_tool_response_5 == "Y", 1, 0),
         vprair_tool_response_6 = if_else(vprair_tool_response_6 == "Y", 1, 0),
         vprair_tool_response_7 = if_else(vprair_tool_response_7 == "Y", 1, 0),
         vprair_tool_response_8 = if_else(vprair_tool_response_8 == "Y", 2, 0))

# Standardize Factors--See pg. xxx for more details.
assess_rec <- assess_rec %>%
  mutate(tool_name = "vprair",
     release_recommendation = if_else(release_recommendation_original == "Release", release_recommendation_level_original,
                                      release_recommendation_original),
     release_recommendation = case_when(
       release_recommendation %in% c("Own Recognizance", "Pretrial Monitoring (Reminder Only)") ~ "OR",
       release_recommendation %in% c("Pretrial Supervision Level I", "Pretrial Supervision Level II",
                                             "Pretrial Supervision Level III") ~ "Monitor",
       release_recommendation %in% c("Detain") ~ "Detain",
       T ~ "Other_Unknown")) 

####

# Pretrial judicial orders Pre-araignment
assess_prearraignment <- read_excel("Historical Data Submissions/Alameda/P3 Submission-Jan 15/2.5.21/PT4_PreArraignmentOrders_PHASE2.xlsx")

names(assess_prearraignment) <- c("event_id", "local_id", "release_authorization", "prearraignment_flag", "release_decision_date", "release_decision_original", "release_decision_level_original")

# Standardize Factors--See pg. xxx for more details.
assess_prearraignment <- assess_prearraignment %>%
   mutate_if(is.character, funs(if_else(. == "NULL"|. == ""|. == "N/A", NA_character_, .))) %>%
  mutate(tool_name = "vprair",
     release_decision = if_else(release_decision_original == "release", release_decision_level_original,
                                      release_decision_original),
     release_decision = case_when(
       release_decision%in% c("Own Recognizance", "Pretrial Monitoring (Reminder Only)") ~ "OR",
       release_decision %in% c("Pretrial Supervision Level I", "Pretrial Supervision Level II",
                                             "Pretrial Supervision Level III") ~ "Monitor",
     release_decision %in% c("detain") ~ "Detain",
       T ~ "Other_Unknown")) 

####

# Pretrial judicial orders Araignment
  ## Release decision at arraignment only includes release decisions 
assess_arraignment <- read_excel("Historical Data Submissions/Alameda/P3 Submission-Jan 15/2.5.21/PT5_ArraignmentOrders_PHASE2.xlsx")

# Ask about hearing types that aren't at arraignment. Also ask about bond_setting_history_id.
names(assess_arraignment) <- c("event_id", "local_id", "court_docket_id", "court_case_number", "release_authorization_original", "bond_id", "release_decision_original", "release_decision_date", "hearing_type_original")

# Standardize Factors--See pg. xxx for more details.
assess_arraignment <- assess_arraignment %>%
   mutate_if(is.character, funs(if_else(. == "NULL"|. == ""|. == "N/A", NA_character_, .))) %>%
  mutate(tool_name = "vprair",
     release_decision = case_when(
       release_decision_original %in% c("OR Release", "Pretrial Release") ~ "OR",
       release_decision_original %in% c("Level I - Pretrial Release Supervision	", "Level II - Pretrial Release Supervision",
                                             "Level III - Pretrial Release Supervision",
                                        "Monitoring - Pretrial Release") ~ "Monitor",
       #They do not include detention/no release decisions
     # release_decision_original %in% c("detain") ~ "Detain",
       T ~ "Other_Unknown"))

assess_decision <- bind_rows(assess_prearraignment, assess_arraignment)

assess_decision <- assess_decision %>%
  mutate(release_authorization = "Judge")



####

# Pretrial Assessments and Recommendations Conditions
assess_rec_conditions <- read_excel("Historical Data Submissions/Alameda/P3 Submission-Jan 15/2.5.21/PT3a_AssessmentsAndRecommendationsDPOConditions_PHASE2.xlsx")

names(assess_rec_conditions) <- c("event_id", "local_id", "assessment_date", "sup_approval_date", "sup_approval_time", "drug_edu_flag", "rec_drug_test_flag", "mh_flag", "no_alcohol_flag", "no_drugs_flag", "no_guns_flag", "search_residence_flag", "protective_order_flag", "no_threaten_flag", "no_threaten_detail", "stay_away_flag", "stay_away_detail", "stay_away_location_flag", "stay_away_location_detail", "rec_drug_test_flag2", "search_person_flag", "search_electronics_flag", "other_condition_flag", "other_condition_more_flag", "mitigatting_factors", "rec_em_flag", "rec_no_contact_flag", "no_contact_detail")


####

# Pretrial judicial orders Pre-araignment Conditions
assess_prearraignment_conditions <- read_excel("Historical Data Submissions/Alameda/P3 Submission-Jan 15/2.5.21/PT4a_PreArraignmentOrdersJudicialConditions_PHASE2.xlsx")

  #What is the PCReviewed field?
  #Should we use Stay Away, No Contact, protective order, or all of them for no_contact_flag?
names(assess_prearraignment_conditions) <- c("event_id", "local_id", "release_authorization_original", "release_decision_original", "detain_flag", "concurrence_flag", "monitor_level_original", "PC_reviewed_flag", "drug_edu_flag", "condition_drug_test_flag", "mh_flag", "no_alcohol_flag", "no_drugs_flag", "no_guns_flag", "search_residence_flag", "protective_order_flag", "no_threaten_flag", "no_threaten_detail", "stay_away_flag", "stay_away_detail", "stay_away_location_flag", "stay_away_location_detail", "condition_drug_test_flag2", "search_person_flag", "search_electronics_flag", "other_condition_flag", "other_condition_more_flag", "condition_em_flag", "condition_no_contact_flag", "no_contact_detail")

####

# Pretrial judicial orders Araignment Conditions
  #Confirm that differenlty named fields are the same
assess_arraignment_conditions <- read_excel("Historical Data Submissions/Alameda/P3 Submission-Jan 15/2.5.21/PT5a_ArraignmentOrdersJudicialConditions_PHASE2.xlsx")

names(assess_arraignment_conditions) <- c("event_id", "local_id", "court_docket_id", "court_case_number", "release_authorization_original", "bond_id", "release_decision_original", "release_decision_date", "monitor_level_original", "drug_edu_flag", "condition_drug_test_flag", "mh_flag", "no_alcohol_flag", "no_drugs_flag", "no_guns_flag", "search_flag", "protective_order_flag", "no_threaten_flag", "stay_away_flag", "stay_away_location_flag",  "condition_drug_test_flag2", "other_condition_flag")

assess_conditions <- bind_rows(assess_rec_conditions, assess_prearraignment_conditions, assess_arraignment_conditions %>% mutate(local_id = as.character(local_id)))

# Standardize Factors--See pg. xxx for more details.
assess_conditions <- assess_conditions %>%
  mutate(monitor_level = case_when(
    monitor_level_original %in% c("Level I - Pretrial Release Supervision",
                                     "Pretrial Supervision Level I", "1") ~ "Low",
    monitor_level_original %in% c("Level II - Pretrial Release Supervision",
                                     "Pretrial Supervision Level II", "2") ~ "Medium",
    monitor_level_original %in% c("Level III - Pretrial Release Supervision",
                                     "Pretrial Supervision Level III", "3:4") ~ "High",
                              T ~ "Other_Unknown"),
    monitor_level = ordered(monitor_level, levels = c("Other_Unknown", "Low", "Medium", "High")))

# Flag Standardization---See pg. xxx for more details.

assess_conditions <- assess_conditions %>%
  mutate_at(vars(contains("flag")), funs(if_else(. == "N"|is.na(.), 0, 1))) %>%
  mutate_if(is.character, funs(if_else(. == "NULL"|. == ""|. == "N/A", NA_character_, .)))
  

  


# Follow up about newly missing elements that were in previous extracts
    #  pretrial_ineligible_reason = case_when(
    #    pretrial_release_type_original %in% c("Bail") ~ "Bail_Bond",
    #    pretrial_release_type_original %in% c("Charges Dismissed", "Sentenced") ~ "Case_Disposed",
    #    T ~ "Other_Unknown"),
    # 
    #  risk_level = case_when(
    #    risk_level_original %in% c("Level 1", "Level 2") ~ "Low",
    #    risk_level_original %in% c("Level 3", "Level 4") ~ "Medium",
    #    risk_level_original %in% c("Level 5", "Level 6") ~ "High",
    #    T ~ "Other_Unknown"
    #  ),
    # #What about when Release = Monitoring?
    # pretrial_termination_reason = case_when(pretrial_status_original %in% c("PTS - Closed Successful") ~ "Case_Disposed",
    #                                         pretrial_status_original %in% c("PTS - Revoked") ~ "Violation",
    #                                         T ~ "Other_Unknown")

# Flag Standardization---See pg. xxx for more details.
  ## Need to follow up with Santa Barbara on the definitions of release recommendation, release type, release authorization, pretrial_violation_flag, and pretrial_termination_outcome. What does pretrial ID uniquely identify? Also need to figure out if we can determine Judge overrides. When do people have mulitple assessments. 
# assess_df <- assess_df %>%
#   mutate(assess_flag = if_else(is.na(assessment_date), 0, 1),
#          rec_release_flag = if_else(),
#          decision_release_flag = if_else(),
#          condition_release_flag = if_else(),
#          pretrial_override_flag = if_else(),
#          rec_em_flag = if_else(),
#          rec_phone_flag = if_else(),
#          rec_inperson_flag = if_else(),
#          rec_drug_alc_flag = if_else(),
#          rec_other_flag = if_else(),
#          condition_em_flag = if_else(),
#          condition_phone_flag = if_else(),
#          condition_inperson_flag = if_else(),
#          condition_drug_alc_flag = if_else(),
#          condition_other_flag = if_else(),
#          pretrial_violation_flag= if_else(!is.na(pretrial_violation_date)))

```

  Assessment Collapse
```{r}
# Recommendations are already collapsed to distinct event_id
# assess_rec %>%
#   distinct(event_id)

# Taking the earliest release decision associated with each event
assess_decision <- assess_decision %>%
  select(-court_docket_id, -bond_id, -court_case_number, -hearing_type_original) %>%
  arrange(release_decision_date) %>%
  distinct(event_id, .keep_all = T)
  

#Conditions Collapse
assess_conditions <- assess_conditions %>%
  select(-matches("date|time")) %>%
  mutate_at(vars(contains("flag")), funs(if_else(. == "N"|is.na(.), 0, .))) %>%
  mutate_if(is.character, funs(if_else(. == "NULL"|. == ""|. == "N/A", NA_character_, .))) %>%
  mutate_at(vars(matches("cond|rec"), monitor_level_original, monitor_level), funs(ifelse(is.na(.), 0, .))) %>% 
  group_by(event_id, local_id) %>%
  summarise_at(vars(matches("cond|rec"), monitor_level_original, monitor_level), max) 

assess_df <- assess_rec %>%
  select(-tool_name) %>%
  left_join(assess_decision) %>%
  left_join(assess_conditions)

assess_df <- assess_df %>%
  rowwise() %>% 
  mutate(vprair_risk_score = sum(c_across(vprair_tool_response_1:vprair_tool_response_8), na.rm = T),
         vprair_risk_score = if_else(is.na(vprair_tool_response_1), NA_real_, vprair_risk_score),
         risk_level = NA_character_) 
  

save(assess_df, file = "G:/CrimJustice/PretrialAssessmentPilot/Agency Collapse CSV Files/Alameda Assessment Collapse.RData")
```


Join
```{r}
# Person Data--Integrated County
  ## person_df contains one row per event/person combination.
person_df <- read_excel("Historical Data Submissions/Alameda/P3 Submission-Jan 15/2.5.21/IdentifiersAndDemographicsBookings07012016to12312020.xlsx")

# Variable name standardization--See pg. xxx for more details. 
  ## Variable race_code is redundant and will be dropped. 

names(person_df) <- c("event_id", "local_id", "first_name", "last_name", "dob", "cii", "fbi", "race_original", "sex_original", "cdl_id", "cdl_state",  "zip_code", "arrest_date", "book_date", "assessment_flag") 


#Removing Dates because they are found on the booking table.
person_df <- person_df %>%
  select(-book_date, -arrest_date)


# Standardize Factors--See pg. xxx for more details.
person_df <- person_df %>%
  mutate(sex = case_when(sex_original %in% c("M") ~ "Male",
                         sex_original %in% c("F") ~ "Female"),
         
  ## Trimming white space on original race first
         race_original = trimws(race_original),
         race = case_when(race_original %in% c("BLACK") ~ "Black",
                          race_original %in% c("HISPANIC") ~ "Hispanic",
                          race_original %in% c("WHITE") ~ "White",
                          T ~ "Other_Unknown"),
  event_id = as.numeric(event_id))
 
load("G:/CrimJustice/PretrialAssessmentPilot/Agency Collapse CSV Files/Alameda Booking Collapse.RData") 

load("G:/CrimJustice/PretrialAssessmentPilot/Agency Collapse CSV Files/Alameda Court Collapse.RData") 

load("G:/CrimJustice/PretrialAssessmentPilot/Agency Collapse CSV Files/Alameda Assessment Collapse.RData") 

# date_df <- fread("G:/CrimJustice/PretrialAssessmentPilot/County Join Dates/VENTURA Join Dates.csv", colClasses = "character") %>%
#   # rename(file_date = filing_date) %>%
#   mutate_at(vars(contains("date")), as_date)

# #Changing dates to DOJ format
# book_df <- book_df %>%
#   mutate(cii = parse_number(cii),
#          cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
#                          nchar(cii) == 7 ~ paste0("000", cii),
#                          nchar(cii) == 8 ~ paste0("00", cii),
#                          nchar(cii) == 9 ~ paste0("0", cii),
#                          T ~ as.character(cii)),
#          cii = if_else(nchar(cii) != 10, NA_character_, cii)) 
# 
# court_df <- court_df %>%
#   mutate(cii = parse_number(cii),
#          cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
#                          nchar(cii) == 7 ~ paste0("000", cii),
#                          nchar(cii) == 8 ~ paste0("00", cii),
#                          nchar(cii) == 9 ~ paste0("0", cii),
#                          T ~ as.character(cii)),
#          cii = if_else(nchar(cii) != 10, NA_character_, cii)) 



# Match rate when matching on event_id from booking to court data ~ 58%
# No other matching strategies needed
nrow(book_df %>%
  semi_join(court_df, by = c("event_id"), na_matches = "never")) / nrow(book_df) * 100

# Match rate when matching on court_case_id and local_id from court to booking data ~ 100%
# No other matching strategies needed
nrow(court_df %>%
  semi_join(book_df, by = c("event_id"), na_matches = "never")) / nrow(court_df) * 100

# Joining jail and court data
join_df <- book_df %>%
  left_join(court_df, by = c("event_id"), na_matches = "never") %>%
  select(-contains(".y")) %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x", "", .)))


# Match rate when matching on court_case_id and local_id from court to booking data ~ 100%
# No other matching strategies needed
nrow(assess_df %>%
  semi_join(join_df, by = c("event_id"), na_matches = "never")) / nrow(assess_df) * 100


# Joining jail and court data with assessment data
join_df2 <- join_df %>%
  left_join(assess_df, by = c("event_id"), na_matches = "never") %>%
  select(-contains(".y")) %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x", "", .)))

# Adding Demographic Info
join_df2 <- join_df2 %>%
  left_join(person_df)

```

Collapse
```{r}
suppressWarnings(alameda_collapse <- join_df2 %>%
  mutate(sentence_date = if_else(sentence_date < book_date, NA_Date_, sentence_date)) %>%
  mutate(across(c(contains("date"), -matches("time|reminder")), ~if_else(.x == -Inf|.x == Inf, NA_Date_, as_date(.x)))) %>%
  mutate(across(contains("flag"), ~if_else(is.na(.x), 0, as.numeric(.x)))) %>%
  mutate(pretrial_end_date = if_else(is.na(pretrial_end_date) & release_type == "Dismissed_Dropped", release_date, pretrial_end_date)) %>%
  mutate(new_arrest_flag = if_else(book_type %in% c("On_View", "New_Warrant"), 1, 0)) %>%
  mutate(release_type = ordered(release_type, levels = c("Unknown", "Other", "Sentenced", "Time_Served", "Detain_Only", "Dismissed_Dropped", "OR",
                                                         "Bail_Bond", "Cite_Release", "Hold_Release"))) %>%
  group_by(event_id) %>%
  mutate(release_type = max(release_type)) %>%
  mutate(across(contains("sup_vio"), max)) %>%
  filter(sum(new_arrest_flag) == 0 | new_arrest_flag == 1) %>%
  mutate(across(c(contains("flag"), pretrial_end_date, disposition_date), max)) %>%
  mutate(sentence_date = min(sentence_date, na.rm = T)) %>%
  ungroup() %>%
  distinct(event_id, .keep_all = T) %>%
  mutate(across(c(contains("date"), -matches("time|reminder")), ~if_else(.x == -Inf|.x == Inf, NA_Date_, as_date(.x)))) %>%
  mutate(pretrial_end_date = if_else(pretrial_end_date < sentence_date|is.na(sentence_date), pretrial_end_date, sentence_date)))

save(alameda_collapse, file = "G:/CrimJustice/PretrialAssessmentPilot/Agency Collapse CSV Files/Alameda Join Collapse.RData")

# alameda_collapse %>%
#   filter(is.na(pretrial_end_date), release_type == "Dismissed_Dropped")
# 
# join_df2 %>%
#   mutate(across(c(contains("date"), -matches("time|reminder")), ~if_else(.x == -Inf|.x == Inf, NA_Date_, as_date(.x)))) %>%
#   filter(pretrial_end_date >= book_date|is.na(pretrial_end_date)) %>%
#   distinct(event_id, court_case_id, .keep_all = T) %>%
#   add_count(event_id) %>%
#   filter(n > 1) %>%
#   filter(book_num %in% book_num[is.na(pretrial_end_date)]) %>%
#   filter(book_num %in% book_num[!is.na(pretrial_end_date)]) %>%
#   select(book_num, court_case_id, book_date, release_date, pretrial_end_date, disposition_date, sentence_date, court_charge_description, disposition_type) 
#   
# join_df2 %>%
#   select(contains("date"), -contains("time"))
# 
# join_df2 %>%
#   count(release_type)
``` 


Data Extraction
  DOJ CII/Linking Extraction
```{r}
#Alameda has an integrated system. Only one CII file.

cii_df <- read_excel("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Alameda/P3 Submission-Jan 15/2.5.21/IdentifiersAndDemographicsBookings07012016to12312020.xlsx")  

names(cii_df) <- c("event_id", "local_id", "first_name", "last_name", "dob", "cii", "fbi", "race_original", "sex_original", "cdl_id", "cdl_state", "zip_code", "arrest_date", "book_date", "pt_assessed")


cii_df <- cii_df %>%
  select(any_of(c("cii", "cdl_id", "fbi", "last_name", "first_name", "middle_name", "dob", "sex_original", "race_original"))) %>%
  mutate(
    cii = parse_number(cii),
    cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                    nchar(cii) == 7 ~ paste0("000", cii),
                    nchar(cii) == 8 ~ paste0("00", cii),
                    nchar(cii) == 9 ~ paste0("0", cii),
                    T ~ as.character(cii)),
    cii = if_else(nchar(cii) != 10, NA_character_, cii)) %>%
  distinct()

# # CIIs from assessment tables
# doj_integrated <- df_list[[1]]
# 
# #CIIS from the past Court
# doj_court <- read_xlsx("CIIs for DOJ/June 2020/Alameda CIIs and Demographics for DOJ.xlsx", sheet = "court")
# 
# #CIIS from the past Jail
# doj_jail <- read_xlsx("CIIs for DOJ/June 2020/Alameda CIIs and Demographics for DOJ.xlsx", sheet = "booking")
# 
#CIIs for DOJ
doj_cii <- cii_df %>%
  select(cii) %>%
  distinct() %>%
  filter(nchar(cii) == 10)



#Create an excel workbook with all data table. Make sure to include the cii table first. 
write.xlsx(list(doj_cii, cii_df), file = "CIIs for DOJ/February 2021/Alameda P3 CIIs and Demographics for DOJ.xlsx", sheetName = c("ciis", "integrated"))

# # Examine missing ciis and duplicates on cii. 
# doj_book %>% #Off by about 3,000-2633 due to missing cii
#   distinct()
# 
# doj_book %>% 
#   distinct(cii)
# 
# doj_book %>% 
#   distinct() %>%
#   add_count(cii) %>%
#   filter(n > 1) %>%
#   arrange(desc(n)) %>% 
#   View()
# 
# doj_court %>% #Off by about 12,000, 13,069/25,642
#   distinct()
# 
# doj_court %>% 
#   distinct(cii)
# 
# doj_court %>% #11,510 due to missing cii
#   distinct() %>%
#   add_count(cii) %>%
#   filter(n > 1) %>%o
#   arrange(desc(n)) %>% 
#   View()
```

  Assessment Tables
```{r}
assess_table <- assess_df %>%
  #Pulling in demo and booking info from the booking table
  left_join(person_df %>% select(local_id, dob, sex, race)) %>%
  # Collapse to each assessment.
  distinct(local_id, assessment_date, .keep_all = T) %>%
  # Filter for only those actually assessed
  filter(!is.na(assessment_date),
         vprair_risk_score >= 0) %>%
  # Create county name.
  mutate(county = "Alameda",
         tool_name = "vprair") %>%
  mutate(dob = convertToDate(dob))

# Save file  
save(assess_table, file = "G:/CrimJustice/PretrialAssessmentPilot/Assessment Output Tables/Alameda Assessment Output 02-2021.RData")

# assess_df %>%
#   # Collapse to each assessment
#   distinct(pretrial_id, .keep_all = T) %>%
#   # Filter for only those actually assessed
#   filter(!is.na(assessment_date)) %>%
#   count(risk_level) %>%
#   mutate(total = sum(n),
#          risk_level = round(n/total*100)) %>%
#   spread(risk_level, n)
# 
# rowsu

assess_df %>%
  filter(vprair_risk_score < 0)

assess_df %>%
  left_join(book_df %>% select(local_id, dob, sex, race, book_num)) %>%
  distinct()
```


# Los Angeles

Jail Data
```{r}
# Jail Bookings Data Import--- Los Angeles, 2015-01-01 to 2020-06-30
  ## book_df contains one row per booking/charge/courtcase combination and includes information on the person as well as the time of booking and release. Currently the charges are incorrectly duplicated across each court case. This is split apart after the names are standardized and the court cases have been separated out. 
  # book_charge is constructed from book_df and contains one row per booking/charge combination and contains other information on the booking. LA has no booking type information.  o
  ## book_court is contrsucted from book_df contains one row per booking/courtcase combination. No other information is included.  


####

# Jail Bookings--Historical and Q1
  ## book_df contains one row per booking/charge/courtcase combination and includes information on the person as well as the time of booking and release. Currently the charges are incorrectly duplicated across each court case. This is split apart after the name standardization.  
book_df <- lapply(2015:2019, function(i){
  read_xlsx(paste0("Historical Data Submissions/Los Angeles/",i, "_data_fields_added.xlsx"))}) %>%
  bind_rows() 

  ## Submission 2 data came in with slightly different names, but in the same order, so I changed the names to match the first submission before joining them.   
book_df2 <- read_xlsx("Historical Data Submissions/Los Angeles/P2 Submission-June 30/LASD_Rls_Jan_Jun_2020.xlsx") 

book_df3 <- read_xlsx("Historical Data Submissions/Los Angeles/P3 Submission-Jan 15/LASD_JAN_DEC_2020.xlsx")

names(book_df2) <- names(book_df)
names(book_df3) <- names(book_df)

#Removing duplicates between submission 1 and 2 with releases during the P2 time period(2020-01-01 through 2020-06-30)
book_df <- book_df %>%
  anti_join(book_df2, by = "Booking Number") %>%
  anti_join(book_df3, by = "Booking Number")

book_df2 <- book_df2 %>%
  anti_join(book_df3, by = "Booking Number")

book_df <- bind_rows(book_df, book_df2, book_df3 %>% mutate(CII = as.character(CII))) %>% distinct()
rm(book_df2, book_df3)

# Variable name standardization--See pg. xxx for more details. 
names(book_df) <- c("last_name", "first_name", "dob", "race_original", "sex_original", "cdl_id", "cii", "arrest_date", "book_date", "book_num", "court_case_id", "arrest_charge_original", "arrest_charge_level_original", "release_date", "release_type_original", "bail")

####

# Booking charges
  ## book_charge is constructed from book_df and contains one row per booking/charge combination and contains other information on the booking. LA has no booking type information.  
book_charge <- book_df %>%
  select(-court_case_id) %>%
  distinct()


# Standardize Factors--See pg. xxx for more details.
book_charge <- book_charge %>%
  mutate(sex = case_when(sex_original %in% c("M") ~ "Male",
                         sex_original %in% c("F") ~ "Female"),
         
         race = case_when(race_original %in% c("B") ~ "Black",
                          race_original %in% c("H") ~ "Hispanic",
                          race_original %in% c("W") ~ "White",
                          #All Other races/ethnicities collapsed into other
                          T ~ "Other_Unknown"),
        
         book_type = case_when(release_type_original %in% c("DCLR") ~ "Sup_Vio_Post",
                               T ~ "Unknown"),
         
         release_type = case_when(release_type_original %in% c("CUST") ~ "Prison",
                                  release_type_original %in% c("EXP") ~ "Hold_Release",
                                  release_type_original %in% c("SHRT", "PROB", "TSER", "ERLY", "24HR", "SUSP") ~ "Time_Served",
                                  release_type_original %in% c("CITE") ~ "Cite_Release",
                                  release_type_original %in% c("BOND", "BAIL") ~ "Bail_Bond",
                                  release_type_original %in% c("DISM", "REJ", "49B1", "WDEF") ~ "Dismissed_Dropped",
                                  release_type_original %in% c("OR") ~ "OR",
                                  release_type_original %in% c("ORDS") ~ "Court_Order",
                                  release_type_original %in% c("PRCT") ~ "Unspec_Capacity",
                                  release_type_original %in% c("PRET") ~ "Pretrial_Sup",
                                  T ~ "Other"))

# Standardize Charges and join charge hierarchy--See pg. xxx for more details about this process. 
book_charge <- book_charge %>%
  # mutate(attempt = if_else(grepl("664", arrest_charge_original), 1, 0)) %>%
  # separate_rows(arrest_charge_original, sep = "\\\\|\\-|\\/") %>%
  mutate(arrest_charge_level = if_else(!arrest_charge_level_original %in% c("F", "M", "I"), "Other", arrest_charge_level_original),
         #|ALC|AUTO|PTT|GTA|ACC|BAT|RSD|PSN|RES|DD|COM|SHP|FDG
         arrest_charge = gsub("-F|-M", "", arrest_charge_original),
         arrest_charge = gsub("PC.*$", "PC", arrest_charge),
         arrest_charge = gsub("VC.*$", "VC", arrest_charge),
         arrest_charge = gsub("LA.*$", "LA", arrest_charge),
         arrest_charge_code = str_extract(arrest_charge, "..$")) %>%
  separate_rows(arrest_charge, sep = "-") %>%
  mutate(arrest_charge_code = if_else(!arrest_charge_code %in% c("PC", "VC", "HS", "BP", "WI", "US"), "Other", arrest_charge_code),
         arrest_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}|EX|\\+|[A-Z]{2}$","", arrest_charge))) %>%
  unite(join_var, arrest_charge_level, arrest_charge_code, arrest_charge, remove = F)

load("Complete Charge Code Hierarchy.RData")

book_charge <- left_join(book_charge, charge_hier, by = "join_var") %>%
  mutate(felony_flag = if_else(arrest_charge_level == "F", 1, 0),
         misd_flag = if_else(arrest_charge_level == "M", 1, 0)) %>%
  rename_at(vars(contains("flag")), funs(paste0("arrest_", .))) 

####

# Booking court case matches
    ## book_court is contrsucted from book_df contains one row per booking/courtcase combination. No other information is included.   
book_court <- book_df %>%
  select(book_num, court_case_id) %>%
  distinct() %>%
  filter(!is.na(court_case_id))
```

  Jail Collapse
```{r}
# Booking Collapse--See pg. xxx for more details about this process.
  ## LA's court case information was previously seperated due to innaccurate duplicates. After the charges are collapsed, the court case information is reattached. 
book_charge <- book_charge %>%
  mutate(time_first_release = release_date - book_date) %>%
  mutate(hierarchy = if_else(is.na(hierarchy), 1e6, as.numeric(hierarchy))) %>%
  group_by(book_num) %>%
  # mutate(max_booktype = book_type[hierarchy == min(hierarchy)][1],
  #        max_arrest_charge = arrest_charge[hierarchy == min(hierarchy)][1],
  #        max_charge_description = master_charge_description[hierarchy == min(hierarchy)][1],
  #        max_hier = min(hierarchy)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, .))) %>%
  mutate_at(vars(contains("flag")), funs("count" = sum(.))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  mutate(join_var = paste(join_var, collapse = " ")) %>%
  filter(hierarchy == min(hierarchy)) %>%
  ungroup() %>%
  distinct(book_num, .keep_all = T) 

book_df <- left_join(book_charge, book_court)

save(book_df, file = "G:/CrimJustice/PretrialAssessmentPilot/Agency Collapse CSV Files/Los Angeles Booking Collapse.RData")
```

Court Data
```{r}
# Court cases
  ## court_cases contains one row per court case and includes some basic information about the court case

court_df <- fread("Historical Data Submissions/Los Angeles/JCC-historical-court-cases2.csv",
                  sep = "|", colClasses = "character")

court_df2 <- fread("Historical Data Submissions/Los Angeles/P2 Submission-June 30/ISAB_CourtCaseExtract_20201021.csv",
                  sep = "|", colClasses = "character")[,1:30]

court_df3 <- fread("Historical Data Submissions/Los Angeles/P3 Submission-Jan 15/ISAB_CourtCaseExtract_20210114.csv",
                  sep = "|", colClasses = "character")[,1:30]


#Removing duplicates between submission 1 and 2 with releases during the P2 time period(2020-01-01 through 2020-06-30)
court_df <- court_df %>%
  anti_join(court_df2, by = "CASE_ID") %>%
  anti_join(court_df3, by = "CASE_ID")

court_df2 <- court_df2 %>%
  anti_join(court_df3, by = "CASE_ID")


court_df <- bind_rows(court_df, court_df2, court_df3)

rm(court_df2, court_df3)

# Variable name standardization--See pg. xxx for more details. 
names(court_df) <- c("row_num", "court_case_id", "court_docket_id", "local_id", "cii", "first_name", "last_name", "dob", "sex_original", "race_original", "file_date", "charge_id", "count", "court_charge_code_original", "court_charge_original", "court_charge_level_original", "disposition_id", "disposition_type_original", "disposition_code", "disposition_date", "sentence_time", "fine_amt", "sentence_time_code", "sentence_location", "fine_or_jail_code", "probation_code", "probation_length", "probation_length_code", "probation_andor_code", "book_num", "case_create_date")


# Date Reformatting--See pg. xxx for more details.
court_df <- court_df %>%
  mutate_at(vars(contains("date"), dob), as_date)

# Charge Standardization and Flag Adds--See pg. xxx for more details.
  ## LAs use of "/" doesn't actually appear to be separate charges. This should be checked with the lawyers. E.g. (242/243 B is only one charge)
  ## Follow up with Lawyers on "/" and special allegations.
  ## WHen LA uses & this means the charge is followed by a special allegatioin. "/" is used differently. It indicates a special allegation, and attempt, or a generic form of the same charge. THese are flagged and removed. 
court_df <- court_df %>%
  mutate(special_allegation = if_else(grepl("666/|667/|&.*", court_charge_original), 1, 0),
         attempt = if_else(grepl("664/", court_charge_original), 1, 0),
         court_charge = gsub("666/|667/|&.*|664/", "", court_charge_original)) %>% 
  # separate_rows(court_charge, sep = "/|&|\\\\") %>%
  mutate(court_charge_level = if_else(!court_charge_level_original %in% c("F", "M", "I"), "Other", court_charge_level_original),
         court_charge_code = if_else(!court_charge_code_original %in% c("PC", "VC", "HS", "BP", "WI", "US"), "Other", court_charge_code_original),
         court_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}","", court_charge))) %>%
  mutate(court_charge_code = if_else(court_charge_code == "Other" & court_charge == "484A", "PC", court_charge_code)) %>%
  unite(join_var, court_charge_level, court_charge_code, court_charge, remove = F)  

load("Complete Charge Code Hierarchy.RData")

court_df <- left_join(court_df, charge_hier, by = "join_var")

court_df <- court_df %>%
  left_join(charge_hier) %>%
  mutate(felony_flag = if_else(court_charge_level == "F", 1, 0),
         misd_flag = if_else(court_charge_level == "M", 1, 0)) %>%
  mutate_at(vars(contains("flag")), funs("conviction" = if_else(. == 1 &  disposition_code %in% c("CON", "CNJ", "CNC"), 1, 0))) %>%
  rename_at(vars(contains("flag"), -contains("conviction")), funs(paste0("court_", .))) %>%
  rename_at(vars(contains("conviction")), funs(paste0("conviction_", gsub("_conviction", "", .))))
 


# Standardize Factors--See pg. xxx for more details.
court_df <- court_df %>%
  mutate(sex = case_when(sex_original %in% c("M") ~ "Male",
                         sex_original %in% c("F") ~ "Female",
                         T ~ "Other_Unknown"),
         
         race = case_when(race_original %in% c("B") ~ "Black",
                          race_original %in% c("H") ~ "Hispanic",
                          race_original %in% c("W") ~ "White",
                          #All Other races/ethnicities collapsed into other
                          T ~ "Other_Unknown"),
         
         disposition_type = case_when(disposition_code %in% c("CON", "CNJ", "CNC") ~ "Guilty",
                                 disposition_code %in% c("DIA", "DIN", "DID", "DIM", "DIP", "DIC", "DIS") ~ "Dismissed",
                                 disposition_code %in% c("AQJ", "ACQ") ~ "Not_Guilty",
                                 T ~ "Other"))


# Court FTA Data Historical and Q1
court_fta <- fread("Historical Data Submissions/Los Angeles/JCC-historical-bench-warrants2.csv", 
                   sep = "|", colClasses = "character")

court_fta2 <- fread("Historical Data Submissions/Los Angeles/P2 Submission-June 30/ISAB_BenchWarrantExtract_20201021.csv",
                  sep = "|", colClasses = "character")

court_fta3 <- fread("Historical Data Submissions/Los Angeles/P3 Submission-Jan 15/ISAB_BenchWarrantExtract_20210114.csv",
                  sep = "|", colClasses = "character")

#Removing duplicates between submission 1 and 2 with releases during the P2 time period(2020-01-01 through 2020-06-30)
court_fta <- court_fta %>%
  anti_join(court_fta2, by = "CASE_ID") %>%
  anti_join(court_fta3, by = "CASE_ID")

court_fta2 <- court_fta2 %>%
  anti_join(court_fta3, by = "CASE_ID")

court_fta <- bind_rows(court_fta, court_fta2, court_fta3) %>%
  select(-extractDate)

rm(court_fta2, court_fta3)

# Variable name standardization--See pg. xxx for more details. 
names(court_fta) <- c("row_num", "court_case_id", "court_docket_id", "fta_warrant_id", "fta_warrant_date", "fta_warrant_disposition_date")


# Date Reformatting--See pg. xxx for more details.
court_fta <- court_fta %>%
  mutate_at(vars(contains("date")), as_date) %>%
  mutate(fta_flag = 1)
```

  Court Collapse
```{r}
# Partitioning court df collapse process because I have too little RAM.
suppressWarnings(court_df <- court_df %>%
  arrange(file_date) %>%
  mutate(hierarchy = if_else(is.na(hierarchy), 1e6, as.numeric(hierarchy)),
         sentence_date = if_else(disposition_type == "Guilty", disposition_date, NA_Date_)) %>%
  group_by(court_case_id) %>%
  mutate(disposition_date = max(disposition_date, na.rm = T),
         sentence_date = min(sentence_date, na.rm = T)))

case_sample <- court_df$court_case_id %in% sample(court_df$court_case_id, length(unique(court_df$court_case_id))/2)

court_df_part1 <- court_df[case_sample,]
  
court_df_part2 <- court_df[!case_sample,]

rm(court_df)

court_df_part1 <- court_df_part1 %>%
  group_by(court_case_id) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, .))) %>%
    ## Add this back in later. It's now working right now due to computational issues.
  mutate_at(vars(contains("flag")), funs("count" = sum(.))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  mutate(join_var = paste(join_var, collapse = " ")) 

court_df_part2 <- court_df_part2 %>%
  group_by(court_case_id) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, .))) %>%
    ## Add this back in later. It's now working right now due to computational issues.
  mutate_at(vars(contains("flag")), funs("count" = sum(.))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  mutate(join_var = paste(join_var, collapse = " ")) 
  
suppressWarnings(court_df_part1 <- court_df_part1 %>%
  group_by(court_case_id, book_num) %>%  
  filter(hierarchy == min(hierarchy)) %>%
  ungroup() %>%
  distinct(court_case_id, book_num, .keep_all = T)) 

suppressWarnings(court_df_part2 <- court_df_part2 %>%
  group_by(court_case_id, book_num) %>%  
  filter(hierarchy == min(hierarchy)) %>%
  ungroup() %>%
  distinct(court_case_id, book_num, .keep_all = T)) 

court_df <- bind_rows(court_df_part1, court_df_part2)
rm(court_df_part1, court_df_part2)
  
court_df <- court_df %>%
  mutate(pretrial_end_date = if_else(disposition_date < sentence_date|is.na(sentence_date), disposition_date, sentence_date),
         conviction_flag = if_else(!is.na(sentence_date), 1, 0))

court_fta <- court_fta %>%
  select(-row_num, -fta_warrant_id) %>%
  arrange(fta_warrant_date) %>%
  distinct(court_case_id, court_docket_id, .keep_all = T)

court_df <- court_df %>%
  left_join(court_fta, by = c("court_case_id", "court_docket_id"))

save(court_df, file = "G:/CrimJustice/PretrialAssessmentPilot/Agency Collapse CSV Files/Los Angeles Court Collapse.RData")
```
  
  
Assessment Data
```{r}
# Los Angeles Assessment Data Import
  ## assess_df contains one row per risk assessment event/risk assessment question/pretrial terms and conditions. The tool questions are widened into columns.

####

# Assessments Data Import
  ## assess_df contains one row per risk assessment event/risk assessment question/pretrial terms and conditions. The questions are widened into columns.
assess_df <- fread("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Los Angeles/P2 Submission-June 30/ISAB_PsaHistoricalExtract_20201021.csv",
                  sep = "|", colClasses = "character")

assess_dfq2 <- fread("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Los Angeles/P3 Submission-Jan 15/ISAB_PsaHistoricalExtract_20210114.csv",
                  sep = "|", colClasses = "character")

assess_df <- bind_rows(assess_df, assess_dfq2)

rm(assess_dfq2)

#Widening PSA Tool Responses
assess_df <- assess_df %>%
  spread(prep_risk_factor_type, prep_value)

# Variable name standardization--See pg. xxx for more details.
names(assess_df) <- c("pretrial_id", "tool_name", "local_id", "cii", "first_name", "last_name", "dob", "sex_original", "race_original", "assessment_date", "psa_fta_risk_score", "psa_nca_risk_score", "psa_nvca_risk_score", "release_decision_original", "release_authorization_original", "release_decision_date", "release_conditions_original", "pretrial_violation_original", "pretrial_violation_date", "court_date_reminder_original", "other_pretrial_service_original", "pretrial_termination_outcome_original", "pretrial_termination_date", "extract_date", "psa_tool_response_1", "psa_tool_response_2", "psa_tool_response_2a", "psa_tool_response_3", "psa_tool_response_4", "psa_tool_response_5", "psa_tool_response_5a", "psa_tool_response_6", "psa_tool_response_7", "psa_tool_response_8", "psa_tool_response_9")


# Date Reformatting--See pg. xxx for more details.
assess_df <- assess_df %>%
  mutate_at(vars(contains("date"), dob, -court_date_reminder_original), as_date)


# Risk Score Standardization--Tool Response values are changed to their numeric point value.
assess_df <- assess_df %>%
  mutate(tool_name = "psa",
         psa_nvca_risk_score = if_else(psa_nvca_risk_score == "Y", 1 ,0))

# Risk Score Standardization--Tool Response values are changed to their numeric point value.
assess_df <- assess_df %>%
  mutate(psa_tool_response_1 = if_else(psa_tool_response_1 >= 23, 0, 2),
         psa_tool_response_2 = if_else(psa_tool_response_2 == "True", 2, 0),
         psa_tool_response_2a = if_else(psa_tool_response_2a == "True", 1, 0),
         psa_tool_response_3 = if_else(psa_tool_response_3 == "True", 1, 0),
         psa_tool_response_4 = if_else(psa_tool_response_4 == "True", 1, 0),
         psa_tool_response_5 = if_else(psa_tool_response_5 == "True", 1, 0),
         psa_tool_response_5a = if_else(psa_tool_response_5a == "True", 1, 0),
         psa_tool_response_6 = case_when(psa_tool_response_6 == 0 ~ 0,
                                         psa_tool_response_6 %in% c(1:2) ~ 1,
                                         psa_tool_response_6 >= 3 ~ 2),
         psa_tool_response_7 = case_when(psa_tool_response_7 == 0 ~ 0,
                                         psa_tool_response_7 == 1 ~ 2,
                                         psa_tool_response_7 >= 2 ~ 4),
         psa_tool_response_8 = if_else(psa_tool_response_8 == "True", 1, 0),
         psa_tool_response_9 = if_else(psa_tool_response_9 == "True", 2, 0))

# Standardize Factors--See pg. xxx for more details.
assess_df <- assess_df %>%
  mutate(sex = case_when(sex_original %in% c("M") ~ "Male",
                         sex_original %in% c("F") ~ "Female",
                         T ~ "Other_Unknown"),
         
         #Trimming white space on original race first
         race_original = trimws(race_original),
         race = case_when(race_original %in% c("B") ~ "Black",
                          race_original %in% c("H") ~ "Hispanic",
                          race_original %in% c("W") ~ "White",
                          #All Other races/ethnicities collapsed into other
                          T ~ "Other_Unknown"),
         release_recommendation = case_when(
         #   release_recommendation_original %in% c("OR-with court reminders", "Pre-arraignment Release", "OR without court reminders") ~ "OR",
         #   release_recommendation_original %in% c("OR with check-ins", "OR with SCRAM", "PTS-Elevated", "PTS-Intensive 2", "PTS-Intensive 3", 
         #                                          "PTS-Standard", "PTS with court reminders") ~ "Monitor",
         #   release_recommendation_original %in% c("Remain Detained") ~ "Detain",
         #   release_recommendation_original %in% c("Posted Bail", "No Complaint Filed") ~ "Ineligible",
           T ~ "Other_Unknown"),
         release_decision = case_when(
           
           #Confirm that LA has no monitoring?
           release_decision_original %in% c("Release") ~ "OR",
           # release_decision_original %in% c("OR with check-ins", "OR with SCRAM", "PTS-Elevated", "PTS-Intensive 2", "PTS-Intensive 3", 
           #                                        "PTS-Standard", "PTS with court reminders", "OR with treatment program") ~ "Monitor",
           release_decision_original %in% c("Detain") ~ "Detain",
           release_decision_original %in% c("Ineligible - 1270.1", "Ineligible - Bail Increase Granted", "Ineligible - PC1319.5(b)(2) FTA",
                                            "Ineligible - Probation/Parole", "Invalid") ~ "Ineligible",
           T ~ "Other_Unknown"),
         pretrial_ineligible_reason = case_when(
           # release_decision_original == "Posted Bail"|release_recommendation_original == "Posted Bail" ~ "Bail_Bond",
           # release_decision_original %in% c("No Complaint Filed", "Time Served")|release_recommendation_original %in% c("No Complaint Filed", "Time Served") ~ "Case_Disposed",
           T ~ "Other_Unknown")) 
         # pretrial_release_type = case_when(pretrial_release_type_original),
         # release_authorization = case_when(release_authorization_original),
         # pretrial_termination_outcome = case_when(pretrial_termination_outcome_original),
         # pretrial_termination_reason = case_when(pretrial_termination_outcome_original))
         #Follow up with SB about appropriate ways to understand monitoring levels in SB.  
         # pts_monitor_level_recommended = case_when(release_recommendation_original))



# assess_df2 <- read_excel("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Los Angeles/P2 Submission-June 30/Los Angeles County Pretrial Services Bureau - JCC Quarterly SB10 Data (2020-04-01 to 2020-06-30) - Revised.xlsx", sheet = 2, col_types = "text")

assess_df2 <- read_excel("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Los Angeles/P3 Submission-Jan 15/Los Angeles County Pretrial Services Bureau - JCC Court Pilot Data (2020-01-01 to 2020-12-31).xlsx", sheet = 3, col_types = "text")

names(assess_df2) <- toupper(names(assess_df2))

assess_df2_response <- read_excel("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Los Angeles/P3 Submission-Jan 15/Los Angeles County Pretrial Services Bureau - JCC Court Pilot Data (2020-01-01 to 2020-12-31).xlsx", sheet = 4, col_types = "text")

assess_df2 <- assess_df2 %>%
  distinct(APPLICATION_ID, .keep_all = T) %>%
  left_join(assess_df2_response, by = "APPLICATION_ID")
  
rm(assess_df2_response)

names(assess_df2) <- c("pretrial_id", "cii", "fbi", "local_id", "cdl_id", "name", "dob", "sex_original", "race_original", "tool_name", "assessment_date", "zip_code","risk_level_original", "release_recommendation_original", "release_authorization_original", "release_decision_original", "pretrial_release_date", "release_conditions_original", "pretrial_violation_original", "pretrial_violation_date", "court_date_reminder_original", "other_pretrial_service_original", "pretrial_termination_outcome_original", "pretrial_termination_date", "ccat_tool_response_1", "ccat_tool_response_2", "ccat_tool_response_3", "ccat_tool_response_4", "ccat_tool_response_5", "ccat_tool_response_6", "ccat_tool_response_7", "ccat_tool_response_8", "ccat_tool_response_9", "ccat_tool_response_10", "ccat_tool_response_11", "ccat_tool_response_12", "ccat_tool_response_13", "ccat_tool_response_14", "ccat_tool_response_15", "ccat_tool_response_16", "ccat_tool_response_17", "ccat_tool_response_18", "ccat_tool_response_19", "ccat_tool_response_20")



# Date Reformatting--See pg. xxx for more details.
assess_df2 <- assess_df2 %>%
  mutate_at(vars(contains("date"), dob, -court_date_reminder_original), convertToDate)


# Risk Score Standardization--Tool Response values are changed to their numeric point value.
assess_df2 <- assess_df2 %>%
  mutate(tool_name = "ccat",
         ccat_tool_response_1 = case_when(ccat_tool_response_1 %in% c("Felony Drug Offense") ~ 3,
                                          ccat_tool_response_1 %in% c("Misdemeanor Property Offense") ~ 2,
                                          ccat_tool_response_1 %in% c("Weapons Offense") ~ 1,
                                          ccat_tool_response_1 %in% c("Unknown") ~ NA_real_,
                                          ccat_tool_response_1 %in% c("Other") ~ 0,
                                          T ~ NA_real_),
         ccat_tool_response_2 = case_when(ccat_tool_response_2 %in% c("Yes") ~ 1,
                                          ccat_tool_response_2 %in% c("No") ~ 0,
                                          ccat_tool_response_2 %in% c("Unknown") ~ NA_real_,
                                          T ~ NA_real_),
         ccat_tool_response_3 = case_when(ccat_tool_response_3 %in% c("Three+") ~ 3,
                                          ccat_tool_response_3 %in% c("Two") ~ 2,
                                          ccat_tool_response_3 %in% c("One") ~ 1,
                                          ccat_tool_response_3 %in% c("Unknown") ~ NA_real_,
                                          ccat_tool_response_3 %in% c("Zero") ~ 0,
                                          T ~ NA_real_),
         ccat_tool_response_4 = case_when(ccat_tool_response_4 %in% c("Yes") ~ 3,
                                          ccat_tool_response_4 %in% c("No", "N/A") ~ 0,
                                          ccat_tool_response_4 %in% c("Unknown") ~ NA_real_,
                                          T ~ NA_real_),
         ccat_tool_response_5 = case_when(ccat_tool_response_5 %in% c("Yes") ~ 2,
                                          ccat_tool_response_5 %in% c("No") ~ 0,
                                          ccat_tool_response_5 %in% c("Unknown") ~ NA_real_,
                                          T ~ NA_real_),
         ccat_tool_response_6 = case_when(ccat_tool_response_6 %in% c("Yes") ~ 2,
                                          ccat_tool_response_6 %in% c("No") ~ 0,
                                          ccat_tool_response_6 %in% c("Unknown") ~ NA_real_,
                                          T ~ NA_real_),
         ccat_tool_response_7 = case_when(ccat_tool_response_7 %in% c("Yes") ~ 2,
                                          ccat_tool_response_7 %in% c("No") ~ 0,
                                          ccat_tool_response_7 %in% c("Unknown") ~ NA_real_,
                                          T ~ NA_real_),
         ccat_tool_response_8 = case_when(ccat_tool_response_8 %in% c("Male") ~ 1,
                                          ccat_tool_response_8 %in% c("Female", "Nonbinary") ~ 0,
                                          T ~ NA_real_),
         ccat_tool_response_9 = if_else(is.na(risk_level_original), NA_real_, 0),
         ccat_tool_response_10 = case_when(ccat_tool_response_10 %in% c("Up to 19 years old") ~ 7,
                                           ccat_tool_response_10 %in% c("20-24 years old") ~ 6,
                                           ccat_tool_response_10 %in% c("25-29 years old") ~ 4,
                                           ccat_tool_response_10 %in% c("30-39 years old") ~ 3,
                                           ccat_tool_response_10 %in% c("40-49 years old") ~ 2,
                                           ccat_tool_response_10 %in% c("50-59 years old") ~ 1,
                                           ccat_tool_response_10 %in% c("60+ years old") ~ 0,
                                           T ~ NA_real_),
         ccat_tool_response_11 = case_when(ccat_tool_response_11 %in% c("Some high school", "Grade school") ~ 1,
                                           ccat_tool_response_11 %in% c("College or more", "High-school or GED") ~ 0,
                                           T ~ NA_real_),
         ccat_tool_response_12 = case_when(ccat_tool_response_12 %in% c("No") ~ 1,
                                           grepl("Yes", ccat_tool_response_12) ~ 0,
                                           T ~ NA_real_),
         ccat_tool_response_13 = if_else(is.na(risk_level_original), NA_real_, 0),
         
         ccat_tool_response_14 = case_when(ccat_tool_response_14 %in% 
                                             c("Homeless (on the streets, in a car, in a drop-in s",
                                               "Living in a long-term shelter (transitional housin") ~ 2,
                                           ccat_tool_response_14 == "Refusal to answer" ~ NA_real_,
                                           is.na(risk_level_original) ~ NA_real_,
                                           T ~ 0),
         ccat_tool_response_15 = if_else(is.na(risk_level_original), NA_real_, 0),
         ccat_tool_response_16 = if_else(is.na(risk_level_original), NA_real_, 0),
         ccat_tool_response_17 = if_else(is.na(risk_level_original), NA_real_, 0),
         ccat_tool_response_18 = case_when(ccat_tool_response_12 %in% 
                                             c("Multiple times a day", 
                                             "About every day (five or more times a week)") ~ 1,
                                           is.na(ccat_tool_response_18)| 
                                             ccat_tool_response_18 == "Refusal to answer"	~ NA_real_,
                                           T ~ 0),
         ccat_tool_response_19 = if_else(is.na(risk_level_original), NA_real_, 0),
         ccat_tool_response_20 = if_else(is.na(risk_level_original), NA_real_, 0)) %>%
  rowwise() %>%
  mutate(ccat_risk_score = sum(c_across(ccat_tool_response_1:ccat_tool_response_20), na.rm = T)) %>%
  ungroup()


# Standardize Factors--See pg. xxx for more details.
assess_df2 <- assess_df2 %>%
  mutate(sex = case_when(sex_original %in% c("M") ~ "Male",
                         sex_original %in% c("F") ~ "Female",
                         T ~ "Other_Unknown"),

         #Trimming white space on original race first
         race_original = trimws(race_original),
         
         race = case_when(race_original %in% c("B") ~ "Black",
                          race_original %in% c("H") ~ "Hispanic",
                          race_original %in% c("W") ~ "White",
                          #All Other races/ethnicities collapsed into other
                          T ~ "Other_Unknown"),
         
         release_recommendation = case_when(
           release_recommendation_original %in% c("Own Recognizance Release") ~ "OR",
           release_recommendation_original %in% c("Found Unsuitable for Release") ~ "Detain",
           T ~ "Other_Unknown"),
         
           release_decision = case_when(
           
           #Confirm that LA has no monitoring?
           release_decision_original %in% c("Released OR at Court Appearance") ~ "OR",
           release_decision_original %in% c("Place on EM Conditional Release (Tracked in EM Pro",
                                            "Supervised Release Ordered by Court") ~ "Monitor",
           release_decision_original %in% c("Defendant Remanded to Custody (Detained)") ~ "Detain",
           release_decision_original %in% c("Bonded/Bailed Prior to Court Appearance", "Case Dismissed by Court",
                                            "Cited Out Prior to Court Appearance", "Defendant Sentenced by the Court",
                                            "Ineligible for Pretrial Investigation", 
                                            "No Pretrial Investigation Conducted",
                                            "Not Qualified for Pretrial Services", "") ~ "Ineligible",
           T ~ "Other_Unknown"),
         pretrial_ineligible_reason = case_when(
           release_decision_original == "Bonded/Bailed Prior to Court Appearance" ~ "Bail_Bond",
           release_decision_original %in% c("Case Dismissed by Court",
                                            "Defendant Sentenced by the Court") ~ "Case_Disposed",
         T ~ "Other_Unknown"),
         release_authorization = if_else(release_authorization_original == "Court", "Court", "Other_Unknown"),
         
         pretrial_termination_reason = case_when(
           pretrial_termination_outcome_original == "Failure-To-Appear" ~ "FTA",
           pretrial_termination_outcome_original == "New Criminal Arrest" ~ "New_Crime",
           pretrial_termination_outcome_original == "Sentenced by the Court" ~ "Case_Disposed",
           pretrial_termination_outcome_original == "Pretrial Release Revoked by the Court" ~ "Violation",
           is.na(pretrial_termination_outcome_original) ~ "Not_Tracked",
           T ~ "Other_Unknown"
           ),
         pretrial_termination_outcome = 
           case_when(pretrial_termination_reason %in% c("Case_Disposed") ~ "Successful",
                     pretrial_termination_reason %in% c("Abscond", "FTA", "New_Crime", "Violation") ~ "Unsuccessful",
                     pretrial_termination_reason %in% c("Not_Tracked") ~ "Not_Tracked",
                     T ~ "Other_Unknown"),
         risk_level = case_when(risk_level_original == "HIgh" ~ "High",
                                risk_level_original %in% c("Moderate", "Moderate-High") ~ "Medium",
                                risk_level_original %in% c("Low") ~ "Low"))


# Flag Standardization---See pg. xxx for more details.
assess_df2 <- assess_df2 %>%
  mutate(assess_flag = if_else(is.na(assessment_date), 0, 1),
         rec_release_flag = if_else(release_recommendation %in% c("OR", "Monitor"), 1, 0),
         decision_release_flag = if_else(release_decision %in% c("OR", "Monitor"), 1, 0),
         #This field needs to come from the jail data.
         # pretrial_release_flag = if_else(),
         release_override_flag = if_else(rec_release_flag != decision_release_flag & 
                                            !release_recommendation %in% c("Ineligible", "Other_Unknown") & 
                                            !release_decision %in% c("Ineligible", "Other_Unknown"), 1, 0),
         # rec_em_flag = if_else(grepl("SCRAM", toupper(release_recommendation_original)), 1, 0),
         # # rec_phone_flag = if_else(),
         # # rec_inperson_flag = if_else(),
         # rec_drug_test_flag = if_else(grepl("TEST", toupper(release_recommendation_original)), 1, 0),
         condition_em_flag = if_else(release_conditions_original == "ELECTRONIC MONITORING (CONDITIONAL GPS)", 1, 0),
         condition_phone_flag = if_else(grepl("CONTACT", release_conditions_original), 1, 0),
         #condition_inperson_flag
          ## Does test as requested entail a request flag? What is the treatment program?
         # condition_drug_test_flag = if_else( 0),
         condition_no_contact_flag = if_else(grepl("NO CONTACT|136", toupper(release_conditions_original)), 1, 0),
         court_date_reminder_flag = if_else(court_date_reminder_original == "Yes", 1, 0),
         # Transit service doesn't actually exist here.  
         # transit_service_flag = if_else(grepl("BUS", toupper(other_pretrial_service_original)), 1, 0),
         ## Are all violations violations that result in termation? Why does pretrial release revoked by court not result in violation. 
         pretrial_violation_flag = if_else(pretrial_violation_original != "N/A", 1, 0))

#          pretrial_violation_flag= if_else(!is.na(pretrial_violation_date)))


#Ask about EM in LA.
assess_df3 <- read_excel("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Los Angeles/P2 Submission-June 30/Los Angeles County Pretrial Services Bureau - JCC Quarterly SB10 Data (2020-04-01 to 2020-06-30) - Revised.xlsx", sheet = 3, col_types = "text")

  
names(assess_df3) <- c("key", "pretrial_id", "cii", "fbi", "local_id", "cdl_id", "first_name", "last_name", "dob", "sex_original", "race_original", "tool_name", "assessment_date", "zip_code", "modified_wisconsin_score", "release_recommendation_original", "release_authorization_original", "release_decision_original", "pretrial_release_date", "release_conditions_original", "pretrial_violation_original", "pretrial_violation_date", "court_date_reminder_original", "other_pretrial_service_original", "pretrial_termination_outcome_original", "pretrial_termination_date")


# Date Reformatting--See pg. xxx for more details.
assess_df3 <- assess_df3 %>%
  mutate_at(vars(contains("date"), dob, -court_date_reminder_original), convertToDate)

assess_df3 %>%
  count(pretrial_termination_outcome_original)

# Standardize Factors--See pg. xxx for more details.
assess_df3 <- assess_df3 %>%
  mutate(sex = case_when(sex_original %in% c("M") ~ "Male",
                         sex_original %in% c("F") ~ "Female",
                         T ~ "Other_Unknown"),

         #Trimming white space on original race first
         race_original = trimws(race_original),
         
         race = case_when(race_original %in% c("B") ~ "Black",
                          race_original %in% c("H") ~ "Hispanic",
                          race_original %in% c("W") ~ "White",
                          #All Other races/ethnicities collapsed into other
                          T ~ "Other_Unknown"),
         
         release_recommendation = case_when(
           release_recommendation_original %in% c("Favorable - Alcohol Monitoring", "Favorable - Found Suitable",
                                                  "Court Ordered EM") ~ "Monitoring",
           release_recommendation_original == "Ineligible - No Contact" ~ "Ineligible",
           T ~ "Other_Unknown"),
         #What does Suitable excluded charge mean?
       
           release_decision = "Monitoring",
         
      
         # pretrial_ineligible_reason = case_when(
         #   release_decision_original == "Bonded/Bailed Prior to Court Appearance" ~ "Bail_Bond",
         #   release_decision_original %in% c("Case Dismissed by Court",
         #                                    "Defendant Sentenced by the Court") ~ "Case_Disposed",
         # T ~ "Other_Unknown"),
         release_authorization = if_else(release_authorization_original == "Court", "Court", "Other_Unknown"),
         
         pretrial_termination_reason = case_when(
           pretrial_termination_outcome_original == "Abscond" ~ "Abscond",
           pretrial_termination_outcome_original == "Failure-To-Appear" ~ "FTA",
           pretrial_termination_outcome_original == "New Arrest" ~ "New_Crime",
           pretrial_termination_outcome_original == "Completed" ~ "Case_Disposed",
           pretrial_termination_outcome_original %in% c("Non-Compliance", "Failure To Enroll") ~ "Violation",
           T ~ "Other_Unknown"
           ),
         pretrial_termination_outcome = 
           case_when(pretrial_termination_reason %in% c("Case_Disposed") ~ "Successful",
                     pretrial_termination_reason %in% c("Abscond", "FTA", "New_Crime", "Violation") ~ "Unsuccessful",
                     pretrial_termination_reason %in% c("Not_Tracked") ~ "Not_Tracked",
                     T ~ "Other_Unknown"))

# Flag Standardization---See pg. xxx for more details.
assess_df3 <- assess_df3 %>%
  mutate(rec_em_flag = if_else(grepl("COURT ORDERED EM|FOUND SUITABLE", toupper(release_recommendation_original)), 
                               1, 0),
         rec_drug_test_flag = if_else(grepl("ALCOHOL", toupper(release_recommendation_original)), 1, 0),
         condition_em_flag = if_else(toupper(release_decision_original) == "ELECTRONIC MONITORING", 1, 0),
         condition_drug_test_flag = if_else(toupper(release_decision_original) == "ALCOHOL MONITORING", 1, 0))


# Will future data include more informaiton on terminations and violations.
# Everyone released pre-arraignment is OR, correct? 
# There are no tool or probation recommendations, correct?
```

  Assessment Collapase
```{r}
assess_df <- assess_df %>%
  bind_rows(assess_df2, assess_df3) %>%
  select(-extract_date) %>%
  distinct()

save(assess_df, file = "G:/CrimJustice/PretrialAssessmentPilot/Agency Collapse CSV Files/Los Angeles Assessment Collapse.RData")
```
  
  
Join
```{r}
# Wait for CII Join
load("G:/CrimJustice/PretrialAssessmentPilot/Agency Collapse CSV Files/Los Angeles Booking Collapse.RData") 

load("G:/CrimJustice/PretrialAssessmentPilot/Agency Collapse CSV Files/Los Angeles Court Collapse.RData") 

load("G:/CrimJustice/PretrialAssessmentPilot/Agency Collapse CSV Files/Los Angeles Assessment Collapse.RData")

book_df <- book_df %>%
  mutate(court_docket_id = court_case_id) %>%
  select(-court_case_id)

court_df <- court_df %>%
  mutate(court_docket_id = gsub("^...", "", court_docket_id),
         court_docket_id = gsub(" ", "", court_docket_id)) 


# date_df <- fread("G:/CrimJustice/PretrialAssessmentPilot/County Join Dates/Los Angeles Join Dates.csv", colClasses = "character") %>%
#   # rename(file_date = filing_date) %>%
#   mutate_at(vars(contains("date")), as_date)

#Changing dates to DOJ format
book_df <- book_df %>%
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) %>%
  mutate(across(c(arrest_date, release_date, book_date), as_date))

court_df <- court_df %>%
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii))

assess_df <- assess_df %>%
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii))


# Match rate when matching on court_docket_id from booking to court data ~ 63.3%
nrow(book_df %>%
  semi_join(court_df, by = c("court_docket_id"), na_matches = "never")) / nrow(book_df) * 100

# Match rate when matching on court_docket_id from booking to court data ~ 46.6%
nrow(court_df %>%
  semi_join(book_df, by = c("court_docket_id"), na_matches = "never")) / nrow(court_df) * 100


# Joining jail and court data
join_df <- book_df %>%
  full_join(court_df, by = c("court_docket_id"), na_matches = "never") %>%
  select(-contains(".y")) %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x", "", .)))


# Match rate when matching on cii from assessment to joined data ~ 61%
nrow(assess_df %>%
  semi_join(book_df, by = c("cii"), na_matches = "never")) / nrow(assess_df) * 100


assess_df %>%
  anti_join(court_df, by = c("cii"), na_matches = "never") %>%
  anti_join(book_df, by = c("cii"), na_matches = "never") %>%
  filter()

#joining assess_df to joined booking and court data on local id and assessment date within 2 days of booking, match rate = 43.4%
nrow(assess_df %>%
  # select(-book_date) %>%
  inner_join(join_df, by = c("cii"), na_matches = "never") %>%
  select(-contains(".y")) %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x", "", .))) %>%
  filter(file_date >= assessment_date|assessment_date >= book_date - 2) %>%
  # filter(file_date <= file_date + 10) %>%
  distinct(pretrial_id, .keep_all = T) )/nrow(assess_df %>% distinct(pretrial_id, .keep_all = T))


assess_df %>%
  count(year(assessment_date), month(assessment_date))

court_df %>%
  count(year(file_date), month(file_date))

intersect(names(assess_df), names(court_df))

court_df %>%
  select(contains("date"))

court_df %>%
  select(contains("date")) %>%
  filter(year(file_date) >= 2015) 

assess_df %>%
  select(cii, assessment_date) %>%
  left_join(join_df, by = "cii")

book_df %>%
  select(arrest_date, book_date)

court_df %>%
  select(file_date)

assess_df %>%
  select(assessment_date)


#Joining
  # Only match on assessment done within two days of booking. This will result in many dropped instances of ccat assessments. 
  # This needs to be addressed later. 
  ## Drop CCAT from full county combined analysis--Talk to LA about this. 
join_df <- join_df %>%
  mutate(start = as.numeric(book_date),
         end = start + 5) %>%
  as_tibble()

assess_df <- assess_df %>%
  filter(!is.na(assessment_date)) %>%
  mutate(start = as.numeric(assessment_date),
         end = start) %>%
  as_tibble()

join_df2 <- genome_left_join(join_df, assess_df, by = c("cii", "start", "end")) %>%
  select(-contains(".y")) %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x", "", .)))

# Match rate when matching on court_case_id and local_id from court to booking data ~ 100%
# No other matching strategies needed
nrow(assess_df %>%
  semi_join(join_df, by = c("cii"), na_matches = "never")) / nrow(assess_df) * 100

join_df2 %>%
  mutate(dif = as.numeric(assessment_date) - as.numeric(book_date)) %>%
  count(tool_name, dif) %>%
  spread(tool_name, n)
```

Collapse
```{r}
# Los Angeles Final Collapse
  ## LA does not have booking type. Additionally, 98% of bookings match to arrest cycles in the doj data. This means that they are either providing us only with new arrest type bookings (e.g. not including commitment bookings) OR they are giving DOJ "fake" arrests cycles.
  # Talk with LA.

## 98% of bookings match to new arrest cycles in the doj data.
nrow(book_df %>%
  semi_join(date_df))/nrow(book_df)

# Collapse
join_collapse <- join_df2 %>%
  mutate(across(contains("flag"), ~if_else(is.na(.x), as.integer(0), as.integer(.x)))) %>%
  mutate(release_type = ordered(release_type, levels = c("Unknown", "Other", "Sentenced", "Time_Served", "Detain_Only", "Dismissed_Dropped", "OR",
                                                         "Bail_Bond", "Cite_Release", "Hold_Release"))) %>%
  group_by(book_num) %>%
  ## LA does not have mulitple release types per booking.
  # mutate(release_type = max(release_type)) %>%
  mutate(across(contains("sup_vio"), max)) %>%
  ungroup() %>%
  filter(pretrial_end_date >= book_date) %>%
  group_by(book_num) %>%
  mutate(across(contains("flag"), max)) %>%
  ungroup() %>%
  distinct(book_num, .keep_all = T)

fwrite(join_collapse, "G:/CrimJustice/PretrialAssessmentPilot/Agency Collapse CSV Files/Los Angeles Join Collapse.csv")

sample
``` 


Data Extraction
  DOJ CII/Linking Extraction
```{r}
# Grab Tables with CII
df_list <- sapply(
  ls()[which(sapply(ls(), function(i){
    sum(names(get(i)) %in% "cii")
    }) == 1)],
  function(j){
    df <- get(j)
    df <- df %>%
      select(any_of(c("cii", "cdl_id", "fbi", "last_name", "first_name", "middle_name", "dob", "sex_original", "race_original"))) %>%
       mutate(
         cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) %>%
  distinct()
  
})

# CIIs from assessment tables
doj_assess <- bind_rows(df_list[1:3])

# CIIs from booking tables
doj_book <- bind_rows(df_list[4:5])

# CIIs from court tables
doj_court <- bind_rows(df_list[[6]]) 


#CIIs for DOJ
doj_cii <- bind_rows(doj_book %>% select(cii), doj_court %>% select(cii), doj_assess %>% select(cii)) %>% 
  distinct() %>%
  filter(nchar(cii) == 10)


#Create an excel workbook with all data table. Make sure to include the cii table first. 
write.xlsx(list(doj_cii, doj_book, doj_court, doj_assess), file = "CIIs for DOJ/February 2021/Los Angeles P3 CIIs and Demographics for DOJ.xlsx", sheetName = c("ciis", "booking", "court", "assessment"))

# # Examine missing ciis and duplicates on cii. 
# doj_book %>% #Off by about 3,000-2633 due to missing cii
#   distinct()
# 
# doj_book %>% 
#   distinct(cii)
# 
# doj_book %>% 
#   distinct() %>%
#   add_count(cii) %>%
#   filter(n > 1) %>%
#   arrange(desc(n)) %>% 
#   View()
# 
# doj_court %>% #Off by about 12,000, 13,069/25,642
#   distinct()
# 
# doj_court %>% 
#   distinct(cii)
# 
# doj_court %>% #11,510 due to missing cii
#   distinct() %>%
#   add_count(cii) %>%
#   filter(n > 1) %>%o
#   arrange(desc(n)) %>% 
#   View()
```

  Assessment Tables
```{r}
assess_table <- assess_df %>%
  distinct(pretrial_id, .keep_all = T) %>%
  # Already Collapsed to each assessment.
  # Create county name.
  mutate(county = "Los Angeles") %>%
  ungroup() 
  # Select relevants variables.
  # select(county, release_recommendation, release_decision, assessment_date, 
         # psa_nca_risk_score, psa_nvca_risk_score, psa_fta_risk_score, tool_name, assessment_date, dob, sex, race)



# Save file  
save(assess_table, file = "G:/CrimJustice/PretrialAssessmentPilot/Assessment Output Tables/Los Angeles Assessment Output 02-2021.RData")

# assess_df %>%
#   # Collapse to each assessment
#   distinct(pretrial_id, .keep_all = T) %>%
#   # Filter for only those actually assessed
#   filter(!is.na(assessment_date)) %>%
#   count(risk_level) %>%
#   mutate(total = sum(n),
#          risk_level = round(n/total*100)) %>%
#   spread(risk_level, n)
# 
# rowsu

```

Assessment and Booking Mismatch for LAs Review
```{r}
assess_df %>%
  count(cii) %>%
  arrange(desc(n))

book_df %>%
  count(cii) %>%
  arrange(desc(n))

assess_df %>%
  anti_join(book_df, by = c("cii"), na_matches = "never")

book_df %>%
  anti_join(assess_df, by = c("cii"), na_matches = "never")

book_df2 <- book_df %>%
  distinct(book_num, .keep_all = T) %>%
  count(year = year(book_date), month = month(book_date)) %>%
  rename(bookings = n)

assess_df2 <- assess_df %>%
  distinct(pretrial_id, .keep_all = T) %>%
  filter(tool_name == "psa") %>%
  count(year = year(assessment_date), month =  month(assessment_date)) %>%
  rename(assessments = n)

df <- left_join(book_df2, assess_df2) %>%
  # mutate(ratio = assessments/bookings) %>%
  left_join(jps %>%
              filter(county == "los angeles") %>%
              select(year, month, jail_profile_survey_bookings = tot_booked)) %>%
  filter(year == 2020)


df2 <- assess_df %>%
  # distinct(pretrial_id, assessment_date, cii)
  anti_join(book_df, by = "cii") %>%
    select(pretrial_id)

write.xlsx(list(df, df2), asTable = T, file = "Assessment without Booking Data from Los Angeles.xlsx")
shell.exec(getwd())

assess_df %>%
  select(-extract_date) %>%
  distinct()
  add_count(pretrial_id) %>%
  filter(n > 1) %>%
  arrange(pretrial_id)

```


# Santa Barbara

Jail Data
```{r}
# Jail Bookings Data Import--- Santa Barbara, 2015-01-01 to 2019-12-30
  ## book_df contains one row per booking/charge/courtcase combination and includes information on the person, the charge, as well as the time of booking and release. It contains some duplicates based around release information. Additional, it is ambiguous whether identical charges attached to some bookings are a separate count or dupliation error. Follow up with SB.    

####

# Jail Bookings--Historical and Q1oo
  ## book_df contains one row per booking/charge/courtcase combination and includes information on the person, the charge, as well as the time of booking and release. It contains some duplicates based around release information. Additional, it is ambiguous whether identical charges attached to some bookings are a separate count or dupliation error. Follow up with SB.    
book_df <- read_excel("Historical Data Submissions/Santa Barbara/Jail.Data.12.5.xlsx", col_types = "text")

book_df2 <- read_excel("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Santa Barbara/PretrialJailData1.28.xlsx", col_types = "text") %>%
  select(-10)

book_df3 <- read_excel("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Santa Barbara/P2 Submission-June 30/JailData.Jan.Jun.20.xlsx", col_types = "text")

book_df4 <- read_excel("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Santa Barbara/P3 Submission-Jan 15/SB.Jail.Data.Jul.Dec.20.xlsx", col_types = "text")

  ## Period 1 and 2 Submission data came in with slightly different names than the historical data, but in the same order, so I changed the names to match the first submission before joining them.   
names(book_df2) <- names(book_df)

names(book_df3) <- c(names(book_df), "cid")

names(book_df4) <- c(names(book_df), "cid")

book_df <- book_df %>%
  anti_join(book_df2, by = "BookingNumber") %>%
  anti_join(book_df3, by = "BookingNumber") %>%
  anti_join(book_df4, by = "BookingNumber")

book_df2 <- book_df2 %>%
  anti_join(book_df3, by = "BookingNumber") %>%
  anti_join(book_df4, by = "BookingNumber")

book_df3 <- book_df3 %>%
  anti_join(book_df4, by = "BookingNumber")
  

book_df <- bind_rows(book_df, book_df2, book_df3, book_df4) %>% distinct()

rm(book_df2, book_df3, book_df4)

# Variable name standardization--See pg. xxx for more details. 
names(book_df) <- c("cii", "first_name", "last_name", "dob", "arrest_date_time", "book_num", "book_date_time", "book_type_original", "court_docket_id", "arrest_charge_code_original", "arrest_charge_original", "arrest_charge_level_original", "release_date_time", "release_type_original", "sex_original", "race_original", "cid")


# Date Reformatting--See pg. xxx for more details.
book_df <- book_df %>%
  mutate_at(vars(arrest_date_time, book_date_time, release_date_time), convertToDateTime) %>%
  mutate(dob = convertToDate(dob)) %>%
  mutate(arrest_date = as_date(arrest_date_time),
         book_date = as_date(book_date_time),
         release_date = as_date(release_date_time))

# Deduplicating entries with and without release information.--follow up with Santa Barbara about identical lines. Are they mulitiple counts or coding dupulicates.  
book_df <- book_df %>%
  arrange(book_date_time, release_date_time) %>%
  distinct_at(vars(-contains("release")), .keep_all = T) 


# Charge Standardization and Flag Adds--See pg. xxx for more details.
book_df <- book_df %>%
  mutate(attempt = if_else(grepl("664", arrest_charge_original), 1, 0)) %>%
  separate_rows(arrest_charge_original, sep = "\\\\|\\-|\\/") %>%
  mutate(arrest_charge = if_else(arrest_charge_original %in% c("CC", "CCP", "CO", "CP", "CR", "OC", "PR"), "PC", arrest_charge_code_original),
         arrest_charge_code = if_else(!arrest_charge_code_original %in% c("PC", "VC", "HS", "BP", "WI", "US"), "Other",
                                      arrest_charge_code_original),
         arrest_charge_level = arrest_charge_level_original,
         arrest_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}|EX|\\+|\\-","", arrest_charge_original))) %>%
  # mutate(hierarchy = if_else(grepl("12032", join_var) & is.na(hierarchy), 178400, hierarchy))
  unite(join_var, arrest_charge_level, arrest_charge_code, arrest_charge, remove = F)

load("Complete Charge Code Hierarchy.RData")


book_df <- left_join(book_df, charge_hier, by = "join_var") %>%
  mutate(felony_flag = if_else(arrest_charge_level == "F", 1, 0),
         misd_flag = if_else(arrest_charge_level == "M", 1, 0)) %>%
  rename_at(vars(contains("flag")), funs(paste0("arrest_", .))) 


# Standardize Factors--See pg. xxx for more details.
book_df <- book_df %>%
  mutate(sex = case_when(sex_original %in% c("M") ~ "Male",
                         sex_original %in% c("F") ~ "Female",
                         T ~ "Other_Unknown"),
         
         #Trimming white space on original race first
         race_original = trimws(race_original),
         race = case_when(race_original %in% c("B") ~ "Black",
                          race_original %in% c("H") ~ "Hispanic",
                          race_original %in% c("W") ~ "White",
                          #All Other races/ethnicities collapsed into other
                          T ~ "Other_Unknown"),
         
         book_type_original = trimws(book_type_original),
         book_type = case_when(book_type_original %in% c("ON VIEW", "CITIZEN ARREST") ~ "On_View",
                               book_type_original %in% c("WARRANT ARREST", "ORDER TO PRODUCE") ~ "New_warrant",
                               book_type_original %in% c("RAMEY WARRANT") ~ "Other_Warrant",
                               book_type_original %in% c("ENROUTE") ~ "Hold",
                               book_type_original %in% c("DA CITATION", "CITATION") ~ "Cite_Release",
                               book_type_original %in% c("REMAND TO CUSTODY", "BAIL SURRENDER") ~ "Court_Order",
                               book_type_original %in% c("DETAINER", "FLASH", "REV PAROLE", "REV PROB") ~ "Sup_Vio_Post",
                               book_type_original %in% c("EX PARTE") ~ "Administrative",
                               book_type_original %in% c("SENTENCED COUNTY JAIL", "COMMITMENT", "SENTENCED STATE") ~ "Commitment",
                               T ~ "Other"),
         
         
         release_type_original = trimws(release_type_original),
         release_type = case_when(release_type_original %in% c("TIME SERVED") ~ "Time_Served",
                                  release_type_original %in% c("RELEASE TO OTHER COUNTY", "TO OTHER AGENCY", "RELEASE TO OTHER STATE") ~ "Hold_Release",
                                  release_type_original %in% c("CITE RELEASED") ~ "Cite_Release",
                                  release_type_original %in% c("BAIL BOND", "CASH BAIL") ~ "Bail_Bond",
                                  release_type_original %in% c("ORDERED DISCHARGED", "NO COMPLAINT/849PC", "WARRANT RECALLED") ~ "Dismissed_Dropped",
                                  release_type_original %in% c("RELEASED O.R.") ~ "OR",
                                  release_type_original %in% c("COURT ORDERED/PHF 1370PC") ~ "Court_Order",
                                  release_type_original %in% c("STATE INSTITUTE/PRIS", "RELEASE TO C.D.C.R.") ~ "Prison",
                                  release_type_original %in% c("CAP/TIME SERVED") ~ "Sent_Cap",
                                  book_type_original %in% c("EX PARTE", "825PC ADMIN REL") ~ "Administrative",
                                  T ~ "Other")) %>%
  mutate(arrest_sup_vio_flag = if_else(book_type == "Sup_Vio_Post", 1, arrest_sup_vio_flag))

```

  Jail Collapse
```{r}
# Booking Collapse--See pg. xxx for more details about this process.
book_df <- book_df %>%
  mutate(time_first_release = release_date - book_date) %>%
  mutate(hierarchy = if_else(is.na(hierarchy), 1e6, as.numeric(hierarchy))) %>%
  group_by(book_num, book_date, court_docket_id) %>%
  # mutate(max_booktype = book_type[hierarchy == min(hierarchy)][1],
  #        max_arrest_charge = arrest_charge[hierarchy == min(hierarchy)][1],
  #        max_charge_description = master_charge_description[hierarchy == min(hierarchy)][1],
  #        max_hier = min(hierarchy)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, .))) %>%
  mutate_at(vars(contains("flag")), funs("count" = sum(.))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  mutate(join_var = paste(join_var, collapse = " ")) %>%
  filter(hierarchy == min(hierarchy)) %>%
  ungroup() %>%
  distinct(book_num, book_date, court_docket_id, .keep_all = T) 

save(book_df, file = "G:/CrimJustice/PretrialAssessmentPilot/Agency Collapse CSV Files/Santa Barbara Booking Collapse.RData")
```

 
Court Data
```{r}
#Court cases data import--Santa Barbara, 2017-01-03 to 2020-01-10
  ## court_charge contains one row per court case/charge/dispostion/plea combination. As a result, charges are currently duplicated in the instance of mulitple dispositions or pleas. For example, when someone completed diversion and got their case stricken, the charge will appear multiple times. This is dealt with in the collapse. ----Figure out how to deal with the dispositions vs the final date. ----Follow up with SB about -1, -2, etc after charges. 
  ## court_hearing contains one row per hearing event on each court case and includes information on the hearing type and result.
  ## court_sent contains one row per sentence event and term/sentence location combinations. E.g. The same case will appear twice if they receive a term of 3 years and 80 days. Additionally, some exact duplicates are removed.    
  ## court_sent2 contains one row per sentence event component in which the sentence event is supervision (e.g. probation). Many court_case_ids have multiple sentence events to supervision, unlike confinement. Exact duplicates are removed.
  ## Court person contains one row per defendant, court_case, and assessment date combination. It includes information on the person, the filing date, and the assessment date.--Seperate in the collapse.
   ## court_fta_war contains one row per fta instance on each court case. Some court cases have an fta but are missing the fta date.
   ## Court status shows whether cases are active or inactive on a given date.


####


#Court Charges
  ## court_charge contains one row per court case/charge/dispostion/plea combination. As a result, charges are currently duplicated in the instance of mulitple dispositions or pleas. For example, when someone completed diversion and got their case stricken, the charge will appear multiple times. This is dealt with in the collapse. ----Figure out how to deal with the dispositions vs the final date. ----Follow up with SB about -1, -2, etc after charges. Additionally, many cases with plea types of nolo or guilty do not have a disposition date and do not appear in the sentencing data. Follow up with SB. 
court_charge <- fread("Historical Data Submissions/Santa Barbara/P3 Submission-Jan 15/Charges.csv", header = F)

# Variable name standardization--See pg. xxx for more details.
names(court_charge) <- c("court_case_id", "court_docket_id", "court_charge_count", "court_charge_original", "court_charge_level_original", "court_charge_description", "plea_date", "plea_type_original", "disposition_date", "disposition_type_original", "final_date")


#Date Standaradization
court_charge <- court_charge %>%
  mutate_at(vars(contains("date")), as_date)


# Charge Standardization and Flag Adds--See pg. xxx for more details.
court_charge <- court_charge %>%
  mutate_at(vars(contains("date")), as_date) %>%
  mutate(court_attempt_flag = if_else(grepl("-664", court_charge_original), 1, 0)) %>%
  mutate(court_charge = gsub("-664|-[0-9]$", "", court_charge_original)) %>%
  # separate_rows(court_charge_original, sep = "\\/") %>%
  mutate(court_charge_level = case_when(grepl("^F", court_charge_level_original) ~ "F",
                                        grepl("^M", court_charge_level_original) ~ "M",
                                        grepl("^I", court_charge_level_original) ~ "I",
                                        T ~ "Other"),
         court_charge_code = str_extract(court_charge_description, "^.."),
         court_charge_code = if_else(!court_charge_code %in% c("PC", "VC", "HS", "BP", "WI", "US"), "Other", court_charge_code),
         court_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}|EX|\\+|\\-","", court_charge))) %>%
  unite(join_var, court_charge_level, court_charge_code, court_charge, remove = F) 

load("Complete Charge Code Hierarchy.RData")

court_charge <- left_join(court_charge, charge_hier, by = "join_var") %>%
  mutate(felony_flag = if_else(court_charge_level == "F", 1, 0),
         misd_flag = if_else(court_charge_level == "M", 1, 0)) %>%
  mutate_at(vars(contains("flag")), funs("conviction" = if_else(. == 1 & disposition_type_original %in% c("Sentenced: Plea of Nolo Contendere", 
                                                                                                          "Sentenced: Plea of Guilty",
                                                                                                          "Found Guilty: Jury", "Found Guilty: Court"), 1, 0))) %>%
  rename_at(vars(contains("flag"), -contains("conviction")), funs(paste0("court_", .))) %>%
  rename_at(vars(contains("conviction")), funs(paste0("conviction_", gsub("_conviction", "", .))))


# Standardize Factors--See pg. xxx for more details.
court_charge <- court_charge %>%
  mutate(plea_type = case_when(plea_type_original %in% c("Nolo Contendere") ~ "Nolo_Contendere",
                               plea_type_original %in% c("Not Guilty", "Deny", "Not Guilty & Not Guilty by Reason of Insanity", 
                                                         "Not Guilty by Reason of Insanity") ~ "Not_Guilty",
                               plea_type_original %in% c("Admit", "Guilty") ~ "Guilty",
                               T ~ "Other"),
         disposition_type_original = trimws(disposition_type_original),
         disposition_type = case_when(disposition_type_original %in% c("Sentenced: Plea of Nolo Contendere", "Sentenced: Plea of Guilty", 
                                                                       "Found Guilty: Jury", "Found Guilty: Court") ~ "Guilty",
                                      disposition_type_original %in% c("Dism: PC1385-Furtherance of Justice	", "Dism: Plea Negotiation",
                                                                       "Dism: Motion of the People", "Dismissal/Stricken Per PC 1210.1",
                                                                       "Dismissal Per PC 1203.4 (Probation)", "Dism: Other Dismissal",
                                                                       "Dism: After Deferred Entry of Judgment", 
                                                                       "Discharged")|grepl("Dism", disposition_type_original) ~ "Dismissed",
                                      disposition_type_original %in% c("Found Not Guilty: Jury") ~ "Not_Guilty",
                                      T ~ "Other"))


####

# Court hearing data
  ## court_hearing contains one row per hearing event on each court case and includes information on the hearing type and result. 
court_hearing <- fread("Historical Data Submissions/Santa Barbara/P3 Submission-Jan 15/Hearings.csv", header = F)


# Variable name standardization--See pg. xxx for more details. 
names(court_hearing) <- c("court_case_id", "court_docket_id", "hearing_date", "hearing_type_original", "hearing_result")


# Date Reformatting--See pg. xxx for more details.
court_hearing <- court_hearing %>%
  mutate(hearing_date = mdy(hearing_date))


# Standardize Factors--See pg. xxx for more details.
court_hearing <- court_hearing %>%
  mutate(hearing_type = case_when(grepl("Arraignment", hearing_type_original) ~ "Arraignment",
                                  T ~ "Other"))


####

# Court Sentences to Confinement 
  ## court_sent contains one row per sentence event and term/sentence location combinations. E.g. The same case will appear twice if they receive a term of 3 years and 80 days. Additionally, some exact duplicates are removed.    
court_sent <- fread("Historical Data Submissions/Santa Barbara/P3 Submission-Jan 15/SentConf.csv")


# Variable name standardization--See pg. xxx for more details. 
names(court_sent) <- c("court_case_id", "court_docket_id", "sentence_date", "sentence_type_original", "sentence_loc",
                              "sentence_term", "term_length")


# Date Reformatting--See pg. xxx for more details.
court_sent <- court_sent %>%
  mutate(sentence_date = mdy(sentence_date))


# Standardize Factors--See pg. xxx for more details.
  ## Duplicates are removed here. 
court_sent <- court_sent %>%
  #They don't differentiate between jail and probation. All are confinement.
  mutate(sentence_type = case_when(grepl("Jail", sentence_loc) ~ "Jail",
                                  grepl("Prison", sentence_loc) ~ "Prison",
                                  T ~ "Other")) %>%
  distinct()

####

# Court Sentences to Supervision
  ## court_sent2 contains one row per sentence event component in which the sentence event is supervision (e.g. probation). Many court_case_ids have multiple sentence events to supervision, unlike confinement. Exact duplicates are removed.  
court_sent2 <- fread("Historical Data Submissions/Santa Barbara/P3 Submission-Jan 15/SentProb.csv", header = F)


# Variable name standardization--See pg. xxx for more details. 
names(court_sent2) <- c("court_case_id", "court_docket_id", "sentence_date", "sentence_type_original", "sentence_loc",
                              "term_length", "sentence_term")

# Date Reformatting--See pg. xxx for more details.
court_sent2 <- court_sent2 %>%
  mutate(sentence_date = mdy(sentence_date))


# Standardize Factors--See pg. xxx for more details.
  ## Duplicates are removed here. 
court_sent2 <- court_sent2 %>%
  mutate(sentence_type = case_when(grepl("Probation", sentence_type_original) ~ "Probation",
                                  T ~ "Other")) %>%
  distinct()

####

# Court Person IDs
  ## Court person contains one row per defendant, court_case, and assessment date combination. It includes information on the person, the filing date, and the assessment date.--Seperate in the collapse.    
court_person <- fread("Historical Data Submissions/Santa Barbara/P3 Submission-Jan 15/TechElements.csv", header = F)


# Variable name standardization--See pg. xxx for more details. 
names(court_person) <- c("court_case_id", "court_docket_id", "last_name", "first_name", "middle_name", "file_date", "dob", "cii", "cdl_id", "fbi", "sex_original", "race_original", "cdl_state", "assessment_date")


# Date Reformatting--See pg. xxx for more details.
court_person <- court_person %>%
  mutate_at(vars(contains("date"), dob), mdy)


# Standardize Factors--See pg. xxx for more details.
court_person <- court_person %>%
  mutate(sex = case_when(sex_original %in% c("Male") ~ "Male",
                         sex_original %in% c("Female") ~ "Female",
                         T ~ "Other_Unknown"),
         
         #Trimming white space on original race first
         race_original = trimws(race_original),
         race = case_when(race_original %in% c("Black") ~ "Black",
                          race_original %in% c("Hispanic") ~ "Hispanic",
                          race_original %in% c("White") ~ "White",
                          #All Other races/ethnicities collapsed into other
                          T ~ "Other_Unknown"))


# Court FTA Data
  ## court_fta_war contains one row per fta instance on each court case. Some court cases have an fta but are missing the fta date. 
court_fta_war <- fread("Historical Data Submissions/Santa Barbara/P3 Submission-Jan 15/Warrants.csv", header = F)


# Variable name standardization--See pg. xxx for more details. 
names(court_fta_war) <- c("court_case_id", "court_docket_id", "fta_all_flag", "fta_date", "fta_flag", "fta_warrant_date", "fta_description")


# Date Reformatting--See pg. xxx for more details.
court_fta_war <- court_fta_war %>%
  mutate_at(vars(contains("date")), funs(as_date(gsub(" .*", "", .))))


#### NOT USED 

#Court Status
  ## Court status shows whether cases are active or inactive on a given date.
court_status <- fread("Historical Data Submissions/Santa Barbara/P3 Submission-Jan 15/CaseStatus.csv", header = F)


# Variable name standardization--See pg. xxx for more details.
names(court_status) <- c("court_case_id", "court_docket_id", "status_date", "case_status_original")


# Date Reformatting--See pg. xxx for more details.
court_status <- court_status %>%
  mutate(status_date = mdy(status_date))


# Standardize Factors--See pg. xxx for more details.
court_status <- court_status %>%
         mutate(case_status = if_else(case_status_original == "Active", "Active", "Inactive"))
```

  Court Collapse
```{r}
# Court Charge Collapse--See pg. xxx for more details about this process.

#Court Charges
  ## court_charge contains one row per court case/charge/dispostion/plea combination. As a result, charges are currently duplicated in the instance of mulitple dispositions or pleas. For example, when someone completed diversion and got their case stricken, the charge will appear multiple times. This is dealt with in the collapse. ----Figure out how to deal with the dispositions vs the final date. ----Follow up with SB about -1, -2, etc after charges. Additionally, many cases with plea types of nolo or guilty do not have a disposition date and do not appear in the sentencing data. Follow up with SB. 
court_dispo <- court_charge %>%
  mutate(disposition_date = if_else(is.na(disposition_date) & plea_type %in% c("Guilty", "Nolo_Contendere"), plea_date, disposition_date)) %>%
  select(-c(plea_date, plea_type_original, plea_type)) %>%
  distinct() %>%
  mutate(disposition_type = ordered(disposition_type, levels = c("Other", "Dismissed", "Not_Guilty", "Nolo_Contendere", "Guilty"))) %>%
  mutate(hierarchy = if_else(is.na(hierarchy), 1e6, as.numeric(hierarchy))) %>%
  group_by(court_case_id, court_docket_id) %>%
  mutate(disposition_date = max(disposition_date)) %>%
  mutate(
    # max_court_charge_level = court_charge_level[hierarchy == min(hierarchy)][1],
    #      max_court_charge_code = court_charge_code[hierarchy == min(hierarchy)][1],
    #      max_court_charge = court_charge[hierarchy == min(hierarchy)][1],
    #      max_charge_description = master_charge_description[hierarchy == min(hierarchy)][1],
    #      max_hier = min(hierarchy),
         disposition_type = max(disposition_type)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, .))) %>%
  mutate_at(vars(contains("flag")), funs("count" = sum(.))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  mutate(join_var = paste(join_var, collapse = " ")) %>%
  filter(hierarchy == min(hierarchy)) %>%
  ungroup() %>%
  distinct(court_case_id, court_docket_id, .keep_all = T) 


# Court Ftas are not separated out between warrants and non-warrant ftas. Everything is collapsed to the court case. 
court_fta_war <- court_fta_war %>%
  arrange(fta_warrant_date) %>%
  group_by(court_case_id, court_docket_id) %>%
  mutate(fta_flag = max(fta_flag),
         fta_flag_count = sum(fta_flag),
         fta_all_flag = max(fta_flag),
         fta_all_flag_count = sum(fta_flag)) %>%
  distinct(court_case_id, court_docket_id, .keep_all = T) 


# Court hearings are just selected for arraignment date. 
court_hearing <- court_hearing %>%
  filter(hearing_type == "Arraignment") %>%
  arrange(hearing_date) %>%
  rename(arraignment_date = hearing_date) %>%
  distinct(court_case_id, court_docket_id, .keep_all = T) %>%
  select(court_case_id, court_docket_id, arraignment_date)


# Court pleas are taken from the charge table
court_plea <- court_charge %>%
  arrange(plea_date) %>%
  mutate(guilty_plea_flag = if_else(plea_type == "Guilty|Nolo_Contendere", 1, 0)) %>%
  group_by(court_case_id, court_docket_id) %>%
  mutate(guilty_plea_flag = max(guilty_plea_flag)) %>%
  ungroup() %>%
  distinct(court_case_id, court_docket_id, .keep_all = T) %>%
  select(court_case_id, court_docket_id, plea_date, plea_type_original, plea_type, guilty_plea_flag)


#Court sentences are from the sentences to confinement and probation tables combined. They are collapsed to the case level. 
court_sent <- bind_rows(court_sent, court_sent2) %>%
  arrange(sentence_date) %>%
  mutate(sentence_type = ordered(sentence_type, levels = c("Other", "Probation", "Jail", "Prison"))) %>%
  group_by(court_case_id, court_docket_id) %>%
  mutate(sentence_type = max(sentence_type)) %>%
  ungroup() %>%
  distinct(court_case_id,  court_docket_id, .keep_all = T)


# Sometimes there are mulitple assessments for the same court case. These are collapsed.  
court_person <- court_person %>%
  arrange(file_date, assessment_date) %>%
  distinct(court_case_id, court_docket_id, .keep_all = T)


#many missing dispos from court_person
court_df <- reduce(list(court_person, court_dispo, court_fta_war, court_hearing, court_plea, court_sent), 
                   left_join, by = c("court_case_id", "court_docket_id")) %>%
  select(-contains(".y")) %>% 
  rename_at(vars(contains(".x")), funs(gsub("\\.x", "", .))) %>%
  mutate(pretrial_end_date = if_else(disposition_date <= sentence_date|is.na(sentence_date), disposition_date, sentence_date),
         conviction_flag = if_else(!is.na(sentence_date), 1, 0))

save(court_df, file = "G:/CrimJustice/PretrialAssessmentPilot/Agency Collapse CSV Files/Santa Barbara Court Collapse.RData")

load("G:/CrimJustice/PretrialAssessmentPilot/County Flag Check.RData")
```

 
Assessment Data 
```{r}
### Start Here
# Santa Barbara Assessment Data Import
  ## assess_df contains one row per risk assessment event/risk assessment question/pretrial terms and conditions. The tool questions are widened into columns.

####

# Assessments Data Import
  ## assess_df contains one row per risk assessment event/risk assessment question/pretrial terms and conditions. The questions are widened into columns.
assess_df <- read_excel("Historical Data Submissions/Santa Barbara/P2 Submission-June 30/SB.Probation.Jan.Jun.20.xlsx", col_types = "text")

assess_df2 <- read_excel("Historical Data Submissions/Santa Barbara/P3 Submission-Jan 15/SB.PTS.Jul.Dec.20.xlsx", col_types = "text") %>%
  rename("Tool_Name" = "Tool_Name*")

assess_df <- bind_rows(assess_df, assess_df2)

rm(assess_df2)

# The tool questions are widened so that each question is a variable and each response a value. This is done first, so that standardized names may be added. 
assess_df <- assess_df %>%
  mutate(`Tool Question` = tolower(`Tool Question`),
         `Tool Question` = gsub(",.*", "", `Tool Question`)) %>%
  unite("tool_question", c(Tool_Name, `Tool Question`), remove = F, sep = "__") %>%
  select(-`Tool Question`) %>%
  spread(tool_question, Tool_Responses) %>%
  select(-NULL__null)

# Variable name standardization--See pg. xxx for more details.
names(assess_df) <- c("pretrial_id", "cii", "court_case_id", "court_docket_id", "fbi", "local_id", "cdl_id", "first_name", "last_name", "dob", "sex_original", "race_original", "hispanic_flag", "tool_name", "assessment_date_time", "zip_code", "vprair_risk_score", "release_recommendation_original", "recommendation_comments", "release_authorization_original", "pretrial_release_type_original", "release_date", "release_conditions_original", "pretrial_violation_original", "pretrial_violation_date",  "court_date_reminder_original", "other_pretrial_service_original", "pretrial_termination_reason_original", "pretrial_termination_date", "open_date", "assignment_date", "arrest_date", "monitor_level_original", "vprair_tool_response_1", "vprair_tool_response_4", "vprair_tool_response_2", "vprair_tool_response_8", "vprair_tool_response_7", "vprair_tool_response_3", "vprair_tool_response_5", "vprair_tool_response_6", "vprai_tool_response_1", "vprai_tool_response_3", "vprai_tool_response_8", "vprai_tool_response_6", "vprai_tool_response_7", "vprai_tool_response_2", "vprai_tool_response_4", "vprai_tool_response_5")

# Separating Risk Scores into VPRAI-R and VPRAI
assess_df <- assess_df %>%
  mutate(tool_name = case_when(tool_name == "Virginia Pretrial Risk Assessment_Old" ~ "vprai",
                               tool_name == "Virginia Pretrial Risk Assessment" ~ "vprair",
                               T ~ "NULL")) %>%
  mutate(vprai_risk_score = if_else(tool_name == "vprai", parse_number(vprair_risk_score), NA_real_),
         vprair_risk_score = if_else(tool_name == "vprair", parse_number(vprair_risk_score), NA_real_))

# Date Reformatting--See pg. xxx for more details.
assess_df <- assess_df %>%
  mutate_at(vars(contains("date"), dob, -court_date_reminder_original, -assessment_date_time), convertToDate) %>%
  mutate(assessment_date_time = as_datetime(assessment_date_time),
         assessment_date = as_date(assessment_date_time))

# Risk Score Standardization--Tool Response values are changed to their numeric point value.
assess_df <- assess_df %>%
  mutate(vprai_tool_response_1 = if_else(vprai_tool_response_1 == "Felony", 1, 0),
         vprai_tool_response_2 = if_else(vprai_tool_response_2 == "Yes", 1, 0),
         vprai_tool_response_3 = if_else(vprai_tool_response_3 == "Yes", 1, 0),
         vprai_tool_response_4 = if_else(vprai_tool_response_4 == "Yes", 2, 0),
         vprai_tool_response_5 = if_else(vprai_tool_response_5 == "Yes", 1, 0),
         vprai_tool_response_6 = if_else(vprai_tool_response_6 == "Yes", 1, 0),
         vprai_tool_response_7 = if_else(vprai_tool_response_7 == "Yes", 1, 0),
         vprai_tool_response_8 = if_else(vprai_tool_response_8 == "Yes", 1, 0),
         vprair_tool_response_1 = if_else(vprair_tool_response_1 == "Yes", 2, 0),
         vprair_tool_response_2 = if_else(vprair_tool_response_2 == "Yes", 3, 0),
         vprair_tool_response_3 = if_else(vprair_tool_response_3 == "Yes", 2, 0),
         vprair_tool_response_4 = if_else(vprair_tool_response_4 == "Yes", 2, 0),
         vprair_tool_response_5 = if_else(vprair_tool_response_5 == "Yes", 1, 0),
         vprair_tool_response_6 = if_else(vprair_tool_response_6 == "Yes", 1, 0),
         vprair_tool_response_7 = if_else(vprair_tool_response_7 == "Yes", 1, 0),
         vprair_tool_response_8 = if_else(vprair_tool_response_8 == "Yes", 2, 0),
         # Risk Level from Santa Barbara's matrix.
         risk_level = NA_integer_)
         # case_when(vprai_risk_score <= 2 ~ "Low",
         #                        vprair_risk_score %in% 3:4 ~ "Medium",
         #                        vprai_risk_score >= 5 ~ "High"))

# Standardize Factors--See pg. xxx for more details.
assess_df <- assess_df %>%
  mutate(sex = case_when(sex_original %in% c("Male") ~ "Male",
                         sex_original %in% c("Female") ~ "Female",
                         T ~ "Other_Unknown"),
         
         #Trimming white space on original race first
         race_original = trimws(race_original),
         race = case_when(hispanic_flag == 1 ~ "Hispanic",
                          race_original %in% c("Black") ~ "Black",
                          race_original %in% c("Hispanic") ~ "Hispanic",
                          race_original %in% c("White") ~ "White",
                          #All Other races/ethnicities collapsed into other
                          T ~ "Other_Unknown"),
         release_recommendation = case_when(
           release_recommendation_original %in% c("OR-with court reminders", "Pre-arraignment Release", "OR without court reminders") ~ "OR",
           release_recommendation_original %in% c("OR with check-ins", "OR with SCRAM", "PTS-Elevated", "PTS-Intensive 2", "PTS-Intensive 3", 
                                                  "PTS-Standard", "PTS with court reminders") ~ "Monitor",
           release_recommendation_original %in% c("Remain Detained") ~ "Detain",
           release_recommendation_original %in% c("Posted Bail", "No Complaint Filed") ~ "Ineligible",
           T ~ "Other_Unknown"),
         release_decision = case_when(
           pretrial_release_type_original %in% c("OR-with court reminders", "Pre-arraignment Release", "OR without court reminders") ~ "OR",
           pretrial_release_type_original %in% c("OR with check-ins", "OR with SCRAM", "PTS-Elevated", "PTS-Intensive 2", "PTS-Intensive 3", 
                                                  "PTS-Standard", "PTS with court reminders", "OR with treatment program") ~ "Monitor",
           pretrial_release_type_original %in% c("Remain Detained") ~ "Detain",
           pretrial_release_type_original %in% c("Posted Bail", "No Complaint Filed", "Cite/Released", "Time Served") ~ "Ineligible",
           T ~ "Other_Unknown"),
         pretrial_ineligible_reason = case_when(
           pretrial_release_type_original == "Posted Bail"|release_recommendation_original == "Posted Bail" ~ "Bail_Bond",
           pretrial_release_type_original %in% c("No Complaint Filed", "Time Served")|release_recommendation_original %in% c("No Complaint Filed", "Time Served") ~ "Case_Disposed",
           T ~ "Other_Unknown"),
         #Ask SB about Probation Release authorization
         release_authorization = case_when(release_authorization_original == "Judge" ~ "Judge",
                                           release_authorization_original == "SBSO" ~ "Sheriff",
                                           T ~ "Other_Unknown"),
         # Check what termination outcome means for: NULL, Non-Interview, Abscond, Basic OR, Remands, No Bail Posted. 
         pretrial_termination_reason = case_when(pretrial_termination_reason_original %in% c("Charges Dismissed", "No Charges Filed", 
                                                                                              "Dismissed", "Sentenced") ~ "Case_Disposed",
                                                 pretrial_termination_reason_original %in% c("Abscond") ~ "Abscond",
                                                 pretrial_termination_reason_original %in% c("Failure to Appear") ~ "FTA",
                                                 pretrial_termination_reason_original %in% c("Felony Arrest", "Misdemeanor Arrest") ~ "New_Crime",
                                                 pretrial_termination_reason_original %in% c("Remand-SCRAM violations/tamper") ~ "Violation",
                                                 pretrial_termination_reason_original %in% c("Release Denied", "Posted Bond", "Non-Interview",
                                                                                              "Basic OR", "Diversion") ~ "Not_Tracked",
                                                 T ~ "Other_Unknown"),
         pretrial_termination_outcome = case_when(pretrial_termination_reason %in% c("Case_Disposed") ~ "Successful",
                                                  pretrial_termination_reason %in% c("Abscond", "FTA", "New_Crime", "Violation") ~ "Unsuccessful",
                                                  pretrial_termination_reason %in% c("Not_Tracked") ~ "Not_Tracked",
                                                  T ~ "Other_Unknown"),
         #Risk Level and monitoring level are drawn deterministically from their matrix. 
         risk_level_original = case_when(vprair_risk_score %in% 0:2 ~ "Level 1",
                                         vprair_risk_score %in% 3:4 ~ "Level 2",
                                         vprair_risk_score %in% 5:6 ~ "Level 3",
                                         vprair_risk_score %in% 7:8 ~ "Level 4",
                                         vprair_risk_score %in% 9:10 ~ "Level 5",
                                         vprair_risk_score %in% 11:14 ~ "Level 6",
                                         T ~ "Other_Unknown"),
         
         risk_level = case_when(vprair_risk_score %in% 0:4 ~ "Low",
                                vprair_risk_score %in% 5:8 ~ "Medium",
                                vprair_risk_score %in% 9:14 ~ "High",
                                vprai_risk_score %in% 0:4 ~ "Low",
                                vprai_risk_score %in% 5:8 ~ "Medium",
                                vprai_risk_score %in% 9:14 ~ "High"),
         
         monitor_level = case_when(vprair_risk_score %in% 0:4 ~ "Low",
                                   vprair_risk_score %in% 5:8 ~ "Medium",
                                   vprair_risk_score %in% 9:14 ~ "High"))
         
          ## Get from jail data
         # pretrial_release_type = case_when(pretrial_release_type_original),
         #Follow up with SB about appropriate ways to understand monitoring levels in SB.  
         # pts_monitor_level_recommended = case_when(release_recommendation_original))


# Flag Standardization---See pg. xxx for more details.
  ## Need to follow up with Santa Barbara on the definitions of release recommendation, release type, release authorization, pretrial_violation_flag, and pretrial_termination_outcome. What does pretrial ID uniquely identify? Also need to figure out if we can determine Judge overrides. When do people have mulitple assessments. Follow up about receiving matrix decision. We don't know who's standard, elevated, etc.   
assess_df <- assess_df %>%
  mutate(assess_flag = if_else(is.na(assessment_date), 0, 1),
         rec_release_flag = if_else(release_recommendation %in% c("OR", "Monitor"), 1, 0),
         decision_release_flag = if_else(release_decision %in% c("OR", "Monitor"), 1, 0),
         #This field needs to come from the jail data.
         # pretrial_release_flag = if_else(),
         release_override_flag = if_else(rec_release_flag != decision_release_flag & 
                                            !release_recommendation %in% c("Ineligible", "Other_Unknown") & 
                                            !release_decision %in% c("Ineligible", "Other_Unknown"), 1, 0),
         rec_em_flag = if_else(grepl("SCRAM", toupper(release_recommendation_original)), 1, 0),
         # rec_phone_flag = if_else(),
         # rec_inperson_flag = if_else(),
         rec_drug_test_flag = if_else(grepl("TEST", toupper(release_recommendation_original)), 1, 0),
         condition_em_flag = if_else(grepl("ELECTRONIC MONITOR|GPS|SCRAM", toupper(release_conditions_original))|
                                             grepl("SCRAM", toupper(pretrial_release_type_original)), 1, 0),
         # Discuss release_conditions_original with Santa Barbara along with their original materias to determine phone and inperson flag. 
          ## Does test as requested entail a request flag? What is the treatment program?
         condition_drug_test_flag = if_else(grepl("SCRAM|TEST", toupper(release_conditions_original))|
                                                    grepl("SCRAM|TEST", toupper(pretrial_release_type_original)), 1, 0),
         condition_no_contact_flag = if_else(grepl("NO CONTACT|136", toupper(release_conditions_original)), 1, 0),
         court_date_reminder_flag = if_else(court_date_reminder_original == "CourtAppearance"|
                                              pretrial_release_type_original %in% c("PTS with court reminders", "OR-with court reminders"), 1, 0),
         # Transit service doesn't actually exist here.  
         transit_service_flag = if_else(grepl("BUS", toupper(other_pretrial_service_original)), 1, 0),
         ## Are all violations violations that result in termation? 
         pretrial_violation_flag = if_else(!is.na(pretrial_violation_date), 1, 0))

# names_check <- read_excel("Data Preparation Documentation/Variable Standardization.xlsx", sheet = 3)
# 
# assess_df %>%
#   filter(release_conditions_original != "NULL") %>%
#   filter(!is.na(vprair_risk_score)) %>%
#   count(vprair_risk_score, release_conditions_original) %>%
#   arrange(desc(n)) %>%
#   group_by(vprair_risk_score) %>%
#   slice(1:10) %>%
#   View()

#### County Notes

# Good Morning Noah, incorporate into explanation
# 
#  
# 
# Julius researched the release authorization question and provided me with the back ground on it.  It now makes complete sense to me.  J It is not data that is inputted by the users, it is actually mapped based on the following criteria.  Hopefully this makes sense to you as well but if not please let me know and we can discuss further.  It goes back to the fact that the court doesnt actually make orders about specific things such as the level of supervision and the early decisions the judge isnt actually involved in. 
# 
#  
# 
# The data was mapped with the following logic:
# 
#  
# 
# Release Type = Posted Bail, Time Served, No Complaint Filed, Cite/Released THEN Release Authorization = SBSO
# 
#  
# 
# Release Type=Judges Name THEN Release Authorization=Judge
# 
#  
# 
# If the Release_Recommendation is the following:
# 
# OR without court reminders = Judge
# 
# Remain Detained = Judge
# 
# Pre-arraignment Release = Judge
# 
# OR with SCRAM = Judge
# 
# OR with check-ins = Judge
# 
# OR with testing = Judge
# 
# OR with treatment program = Judge
# 
# Court Ordered Release = Judge
# 
# OR-with court reminders = Judge
# 
#  
# 
# PTS with court reminders = Probation
# 
# PTS-Standard = Probation
# 
# PTS-Elevated = Probation
# 
# PTS-Intensive = Probation
# 
# PTS-Intensive 1 = Probation
# 
# PTS-Intensive 2 = Probation
# 
# PTS-Intensive 3 = Probation
```

  Assessment Collapse
```{r}
# Assessment data is duplicated across terms and conditions. These are collapsed. 
  ## Next Time fix NULL and NA values that are missing.  
assess_df <- assess_df %>%
  group_by(pretrial_id, assessment_date) %>%
  mutate_at(vars(contains("flag")), funs(max(., na.rm = T))) %>%
  distinct(pretrial_id, assessment_date, court_docket_id, .keep_all = T)

save(assess_df, file = "G:/CrimJustice/PretrialAssessmentPilot/Agency Collapse CSV Files/Santa Barbara Assessment Collapse.RData")
```

  Assessment Collapse
```{r}
#No Collapse Needed
assess_df <- assess_tracking %>%
  arrange(interview_date) %>%
  distinct(book_num, .keep_all = T) %>%
  separate(name, c("last_name", "first_name", "middle_name"), sep = ", | ") %>%
  mutate_at(vars(first_name, last_name, middle_name), toupper) 
```


Join
```{r}
load("G:/CrimJustice/PretrialAssessmentPilot/Agency Collapse CSV Files/Santa Barbara Booking Collapse.RData") 

load("G:/CrimJustice/PretrialAssessmentPilot/Agency Collapse CSV Files/Santa Barbara Court Collapse.RData") 

load("G:/CrimJustice/PretrialAssessmentPilot/Agency Collapse CSV Files/Santa Barbara Assessment Collapse.RData")

# date_df <- fread("G:/CrimJustice/PretrialAssessmentPilot/County Join Dates/SANTA BARBARA Join Dates.csv") %>%
#   rename(file_date = filing_date) %>%
#   mutate_at(vars(contains("date")), as_date)

#Changing ciis to DOJ format
book_df <- book_df %>%
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii))

court_df <- court_df %>%
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) %>%
  select(-assessment_date)

assess_df <- assess_df %>%
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii))

# Match rate when matching on court_docket_id from booking to court data ~ 30%
nrow(book_df %>%
  semi_join(court_df, by = c("court_docket_id"), na_matches = "never")) / nrow(book_df) * 100

# Match rate when matching on court_docket_id from booking to court data ~ 54%
nrow(court_df %>%
  semi_join(book_df, by = c("court_docket_id"), na_matches = "never")) / nrow(court_df) * 100


# Joining jail and court data
join_df <- book_df %>%
  left_join(court_df, by = c("court_docket_id"), na_matches = "never") %>%
  select(-contains(".y")) %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x", "", .)))



#joining assess_df to joined booking and court data on local id and assessment date within 2 days of booking, match rate = 43.4%
# nrow(assess_df %>%
#   # select(-book_date) %>%
#   inner_join(join_df, by = c("first_name", "last_name", "dob"), na_matches = "never") %>%
#   select(-contains(".y")) %>%
#   rename_at(vars(contains(".x")), funs(gsub("\\.x", "", .))) %>%
#   filter(assessment_date >= book_date) %>%
#   filter(assessment_date <= book_date + 5) %>%
#   distinct(pretrial_id, .keep_all = T) )/nrow(assess_df %>% distinct(pretrial_id, .keep_all = T))

#Joining
# join_df <- join_df %>%
#   mutate(start = as.numeric(book_date),
#          end = start + 5,
#          person_id = paste(first_name, last_name, dob)) %>%
#   as_tibble()
# 
# assess_df <- assess_df %>%
#   filter(!is.na(assessment_date)) %>%
#   mutate(start = as.numeric(assessment_date),
#          end = start,
#          person_id = paste(first_name, last_name, dob)) %>%
#   as_tibble()

# join_df2 <- genome_left_join(join_df, assess_df, by = c("person_id", "start", "end")) %>%
#   select(-contains(".y")) %>%
#   rename_at(vars(contains(".x")), funs(gsub("\\.x", "", .)))

# Match rate when matching on court_case_id and local_id from court to booking data ~ 100%
# No other matching strategies needed

nrow(assess_df %>%
  semi_join(join_df, by = c("court_docket_id"), na_matches = "never")) / nrow(assess_df) * 100

join_df2 <- join_df %>%
  full_join(assess_df, by = c("court_docket_id"), na_matches = "never") %>%
  select(-contains(".y")) %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x", "", .)))
```

Collapse
```{r}
 suppressWarnings(santa_barbara_collapse <- join_df2 %>%
  mutate(sentence_date = if_else(sentence_date < book_date, NA_Date_, sentence_date)) %>%
  mutate(across(c(contains("date"), -matches("time|reminder")), ~if_else(.x == -Inf|.x == Inf, NA_Date_, as_date(.x)))) %>%
  mutate(across(contains("flag"), ~if_else(is.na(.x), 0, as.numeric(.x)))) %>%
  mutate(pretrial_end_date = if_else(is.na(pretrial_end_date) & release_type == "Dismissed_Dropped", release_date, pretrial_end_date)) %>%
  mutate(new_arrest_flag = if_else(book_type %in% c("On_View", "New_Warrant"), 1, 0)) %>%
  mutate(release_type = ordered(release_type, levels = c("Unknown", "Other", "Sentenced", "Time_Served", "Detain_Only", "Dismissed_Dropped", "OR",
                                                         "Bail_Bond", "Cite_Release", "Hold_Release"))) %>%
  group_by(book_num) %>%
  mutate(release_type = max(release_type)) %>%
  mutate(across(contains("sup_vio"), max)) %>%
  filter(sum(new_arrest_flag) == 0 | new_arrest_flag == 1) %>%
  mutate(across(c(contains("flag"), pretrial_end_date, disposition_date), max)) %>%
  mutate(sentence_date = min(sentence_date, na.rm = T)) %>%
  ungroup() %>%
  distinct(book_num, .keep_all = T) %>%
  mutate(across(c(contains("date"), -matches("time|reminder")), ~if_else(.x == -Inf|.x == Inf, NA_Date_, as_date(.x)))) %>%
  mutate(pretrial_end_date = if_else(pretrial_end_date < sentence_date|is.na(sentence_date), pretrial_end_date, sentence_date)))

save(santa_barbara_collapse, file = "G:/CrimJustice/PretrialAssessmentPilot/Agency Collapse CSV Files/Santa Barbara Join Collapse.RData")


# Diagnostics
join_df2 %>%
  group_by(book_num) %>%
  add_count() %>%
  filter(n > 1) %>%o
  mutate(n = length(unique(release_type))) %>%
  filter(n > 1)
```


Data Extraction
  DOJ CII/Linking Extraction
```{r}
# Grab Tables with CII
df_list <- sapply(
  ls()[which(sapply(ls(), function(i){
    sum(names(get(i)) %in% "cii")
    }) == 1)],
  function(j){
    df <- get(j)
    df <- df %>%
      select(any_of(c("cii", "cdl_id", "fbi", "last_name", "first_name", "middle_name", "dob", "sex_original", "race_original"))) %>%
       mutate(
         cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) %>%
  distinct()
  
})

df_list

# CIIs from assessment tables
doj_assess <- bind_rows(df_list[[1]])

# CIIs from booking tables
doj_book <- bind_rows(df_list[[2]])

# CIIs from court tables
doj_court <- bind_rows(df_list[[3]]) 


#CIIs for DOJ
doj_cii <- bind_rows(doj_book %>% select(cii), doj_court %>% select(cii), doj_assess %>% select(cii)) %>% 
  distinct() %>%
  filter(nchar(cii) == 10)


#Create an excel workbook with all data table. Make sure to include the cii table first. 
write.xlsx(list(doj_cii, doj_book, doj_court, doj_assess), file = "CIIs for DOJ/February 2021/Santa Barbara P3 CIIs and Demographics for DOJ.xlsx", sheetName = c("ciis", "booking", "court", "assessment"))


# # Examine missing ciis and duplicates on cii. 
# doj_book %>% #Off by about 3,000-2633 due to missing cii
#   distinct()
# 
# doj_book %>% 
#   distinct(cii)
# 
# doj_book %>% 
#   distinct() %>%
#   add_count(cii) %>%
#   filter(n > 1) %>%
#   arrange(desc(n)) %>% 
#   View()
# 
# doj_court %>% #Off by about 12,000, 13,069/25,642
#   distinct()
# 
# doj_court %>% 
#   distinct(cii)
# 
# doj_court %>% #11,510 due to missing cii
#   distinct() %>%
#   add_count(cii) %>%
#   filter(n > 1) %>%o
#   arrange(desc(n)) %>% 
#   View()
```

  Assessment Tables
```{r}
assess_table <- assess_df %>%
  # Collapse to each assessment.
  distinct(pretrial_id, .keep_all = T) %>%
  # Filter for only those actually assessed
  filter(!is.na(assessment_date)) %>%
  # Create county name.
  mutate(county = "Santa Barbara") 
  # Select relevants variables.
  # select(county, risk_level, monitor_level, release_recommendation, release_decision, assessment_date, vprai_risk_score, vprair_risk_score, tool_name, assessment_date, dob, sex, race, pretrial_termination_reason, pretrial_ineligible_reason)

# Save file  
save(assess_table, file = "G:/CrimJustice/PretrialAssessmentPilot/Assessment Output Tables/Santa Barbara Assessment Output 10-2020.RData")

# assess_df %>%
#   # Collapse to each assessment
#   distinct(pretrial_id, .keep_all = T) %>%
#   # Filter for only those actually assessed
#   filter(!is.na(assessment_date)) %>%
#   count(risk_level) %>%
#   mutate(total = sum(n),
#          risk_level = round(n/total*100)) %>%
#   spread(risk_level, n)
# 
# rowsu

# assess_table %>%
#   count(pretrial_ineligible_reason)
```

# Tulare 

Jail Data
```{r}
#Jail Data
# doc <- read_xml("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Tulare/P3 Submission-Jan 15/10_01_2020-02_01_2021.xml")
# doc_list <- lapply(
#   paste0("Historical Data Submissions/Tulare/P2 Submission-June 30/JMS", c("2015", "2016", "2017", "2018", "20200101_20200630"), ".xml"),
#   read_xml
#   )
# 
# jail_list <- as_list(doc)
# 
# jail_df <- tibble(bookings = jail_list)
# 
# jail_df <- jail_df %>%
#   unnest(bookings) %>%
#   unnest_wider(bookings)
# 
# jail_df
# 
# jail_df <- jail_df %>%
#   unnest_auto(jacket) %>%
#   unnest_auto(bookingdate) %>%
#   unnest_auto(bookingnumber) %>%
#   unnest_auto(bookingtime) %>%
#   unnest_auto(bookingtime) %>%
#   unnest_auto(inmateid) %>%
#   unnest_auto(lname) %>%
#   unnest_auto(mname) %>%
#   unnest_auto(fname) %>%
#   unnest_auto(dob) %>%
#   unnest_auto(gender) %>%
#   unnest_auto(hair) %>%
#   unnest_auto(race) %>%
#   unnest_auto(dlnumber) %>%
#   unnest_auto(fbinumber) %>%
#   unnest_auto(ciinumber) %>%
#   unnest_auto(employed) %>%
#   unnest_auto(arrestdate) %>%
#   unnest_auto(arresttime) %>%
#   unnest_auto(charges) %>%
#   unnest_auto(chargelevel) %>%
#   unnest_auto(physicalreleasedate) %>%
#   unnest_auto(physicalreleasetype) %>%
#   unnest_auto(firstcourtdate) %>%
#   unnest_auto(bailamount) %>%
#   unnest_auto(bailtype)
# 
# 
# fwrite(jail_df, file = "G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Tulare/P3 Submission-Jan 15/Tulare Jail xml to csv 2-18-2021.csv")

####

# Jail Bookings Data Import--- Tulare, 2015-01-01 to 2019-12-30
  ## book_df contains one row per booking/charge/courtcase combination and includes information on the person, the charge, as well as the time of booking and release. It contains some duplicates based around release information. Additional, it is ambiguous whether identical charges attached to some bookings are a separate count or dupliation error. Follow up with SB.    



book_df <- fread("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Tulare/P3 Submission-Jan 15/Tulare Jail xml to csv 2-18-2021.csv",
                 colClasses = "character")

names(book_df) <- c("book_id", "book_date", "book_time", "book_num", "book_type", "local_id", "last_name", "first_name", "middle_name", "dob", "gender", "hair", "race", "cdl_id", "fbi", "cii", "employed_flag", "arrest_date", "arrest_time", "charge_original", "charge_level_original", "release_date", "release_type_original", "first_court_date", "bail_amt", "bail_type") 


# Removing unnecessary variables
book_df <- book_df %>%
  #Time variables are empty
  select(-hair)


# Date Reformatting--See pg. xxx for more details.
book_df <- book_df %>%
  mutate_at(vars(contains("date"), dob), as_date)

# Deduplicating 1 entry.
book_df <- book_df %>%
  arrange(book_date, release_date) %>%
  distinct(book_num, .keep_all = T)

# Standardize Factors--See pg. xxx for more details.

book_df <- book_df %>%
  mutate(sex = case_when(sex_original %in% c("M") ~ "Male",
                         sex_original %in% c("F") ~ "Female",
                         T ~ "Other_Unknown"),

         #Trimming white space on original race first
         race_original = trimws(race_original),
         race = case_when(race_original %in% c("B") ~ "Black",
                          race_original %in% c("H") ~ "Hispanic",
                          race_original %in% c("W") ~ "White",
                          #All Other races/ethnicities collapsed into other
                          T ~ "Other_Unknown"),
         zip_code = gsub(" .*", "", zip_code))

         # release_type_original = trimws(release_type_original),
         # release_type = case_when(release_type_original %in% c("TIME SERVED") ~ "Time_Served",
         #                          release_type_original %in% c("RELEASE TO OTHER COUNTY", "TO OTHER AGENCY", "RELEASE TO OTHER STATE") ~ "Hold_Release",
         #                          release_type_original %in% c("CITE RELEASED") ~ "Cite_Release",
         #                          release_type_original %in% c("BAIL BOND", "CASH BAIL") ~ "Bail_Bond",
         #                          release_type_original %in% c("ORDERED DISCHARGED", "NO COMPLAINT/849PC", "WARRANT RECALLED") ~ "Dismissed_Dropped",
         #                          release_type_original %in% c("RELEASED O.R.") ~ "OR",
         #                          release_type_original %in% c("COURT ORDERED/PHF 1370PC") ~ "Court_Order",
         #                          release_type_original %in% c("STATE INSTITUTE/PRIS", "RELEASE TO C.D.C.R.") ~ "Prison",
         #                          release_type_original %in% c("CAP/TIME SERVED") ~ "Sent_Cap",
         #                          book_type_original %in% c("EX PARTE", "825PC ADMIN REL") ~ "Administrative",
         #                          T ~ "Other")) 


# Charge Standardization and Flag Adds--See pg. xxx for more details.
book_df <- book_df %>%
  separate_rows(arrest_charge_original, sep = ";") %>%
  mutate(attempt = if_else(grepl("664", arrest_charge_original), 1, 0)) %>%
  mutate(arrest_charge_code_original = str_extract(trimws(arrest_charge_original), "^.."),
         arrest_charge_code = if_else(!arrest_charge_code_original %in% c("PC", "VC", "HS", "BP", "WI", "US"), "Other",
                                      arrest_charge_code_original),
         arrest_charge_level = toupper(arrest_charge_level_original),
         arrest_charge_level = if_else(!arrest_charge_level %in% c("F", "M"), "Other", arrest_charge_level),
         arrest_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}|EX|\\+|\\-","", arrest_charge_original))) %>%
  # mutate(hierarchy = if_else(grepl("12032", join_var) & is.na(hierarchy), 178400, hierarchy))
  unite(join_var, arrest_charge_level, arrest_charge_code, arrest_charge, remove = F)

load("Complete Charge Code Hierarchy.RData")

#Seperate out data with missing charge levels and joing seperately without charge level for ones missing it.
book_df_missing <- book_df %>%
  filter(arrest_charge_level == "Other")

book_df_notmissing <- book_df %>%
  filter(arrest_charge_level != "Other")

book_df_notmissing <- book_df_notmissing %>%
  left_join(charge_hier, by = "join_var") %>%
  mutate(felony_flag = if_else(arrest_charge_level == "F", 1, 0),
         misd_flag = if_else(arrest_charge_level == "M", 1, 0)) %>%
  rename_at(vars(contains("flag")), funs(paste0("arrest_", .))) 


book_df_missing <- book_df_missing %>%
  #Assuming misd for all charges with missing levels. This is obviously incorrect.
  select(-join_var) %>%
  mutate(row = row_number()) %>%
  left_join(charge_hier, by = c("arrest_charge" = "charge", "arrest_charge_code" = "charge_code")) %>%
  group_by(row) %>%
  arrange(row, desc(charge_level)) %>%
  distinct(row, .keep_all = T) %>%
  ungroup() %>%
  select(-row)
  
book_df <- bind_rows(book_df_notmissing, book_df_missing)  
```

  Jail Collapse
```{r}
# Booking Collapse--See pg. xxx for more details about this process.
book_df <- book_df %>%
  mutate(time_first_release = release_date - book_date) %>%
  mutate(hierarchy = if_else(is.na(hierarchy), 1e6, as.numeric(hierarchy))) %>%
  group_by(book_num, book_date) %>%
  # mutate(max_booktype = book_type[hierarchy == min(hierarchy)][1],
  #        max_arrest_charge = arrest_charge[hierarchy == min(hierarchy)][1],
  #        max_charge_description = master_charge_description[hierarchy == min(hierarchy)][1],
  #        max_hier = min(hierarchy)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, .))) %>%
  mutate_at(vars(contains("flag")), funs("count" = sum(.))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  group_by(book_num, book_date) %>%
  filter(hierarchy == min(hierarchy)) %>%
  ungroup() %>%
  distinct(book_num, book_date, .keep_all = T) 

fwrite(book_df, "G:/CrimJustice/PretrialAssessmentPilot/Agency Collapse CSV Files/Tulare Booking Collapse.csv")
```


Court Data
```{r}
court_df <- lapply(1:6, function(i){
  read_excel("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Tulare/P3 Submission-Jan 15/TCSC Case Filings.xlsx", col_types = "text", sheet = i, col_names = F)
}) %>% bind_rows()

names(court_df) <- court_df[1,]

court_df <- court_df %>%
  slice(-1)

#Standardize Names
names(court_df) <- c("court_case_id", "court_docket_id", "filing_date", "case_status", "case_status_date", "name", "dob", "sex_original", "race_original", "fbi", "cii", "cdl_id",  "court_charge_level_original", "court_charge_original", "court_charge_description", "disposition_date", "disposition_type_original", "sentence_date", "sentence_type_original","sentence_term", "service_location", "final_disposition_date", "arrest_date", "arrest_agency", "book_num")


#Standardize Dates
court_df <- court_df %>%
  mutate_at(vars(contains("date")), convertToDate) %>%
  mutate(dob = mdy(dob))


#Fixing Court Charges
court_df <- court_df %>%
  mutate(court_attempt_flag = if_else(grepl("664\\/", court_charge_original), 1, 0)) %>%
  mutate(court_charge_level = if_else(grepl("Misdemeanor", court_charge_level_original), "M", court_charge_level_original),
         court_charge_level = if_else(grepl("Infraction", court_charge_level_original), "I", court_charge_level),
         court_charge_level = str_extract(court_charge_level, "^."),
         court_charge_level = if_else(is.na(court_charge_level), "Other", court_charge_level),
         court_charge_code = str_extract(court_charge_original, "^.."),
         court_charge_code = if_else(!court_charge_code %in% c("PC", "VC", "HS", "BP", "WI", "US"), "Other", court_charge_code),
         # court_charge_code = if_else(court_charge_code == "Other", str_extract(court_charge_code_original, "^.."), court_charge_code),
         court_charge_code = if_else(!court_charge_code %in% c("PC", "VC", "HS", "BP", "WI", "US"), "Other", court_charge_code),
         court_charge = toupper(gsub("^[A-Z]*|664\\/","", court_charge_original))) %>%
  separate_rows(court_charge, sep = "/") %>%
  mutate(court_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}|EX|\\+|","", court_charge_original)),
         #Fixing mislabeled charges, codes, and levels. 
         court_charge = if_else(court_charge == "11364A1", "11364A", court_charge),
         court_charge_code = if_else(court_charge == "10851A", "VC", court_charge_code),
         court_charge_code = if_else(court_charge %in% c("148A1", "484A", "273AB"), "PC", court_charge_code),
         court_charge_code = if_else(grepl("23152", court_charge), "VC", court_charge_code)) %>%
  unite(join_var, court_charge_level, court_charge_code, court_charge, remove = F) 


load("Complete Charge Code Hierarchy.RData")

court_df <- left_join(court_df, charge_hier, by = "join_var") %>%
  mutate(felony_flag = if_else(court_charge_level == "F", 1, 0),
         misd_flag = if_else(court_charge_level == "M", 1, 0)) %>%
  mutate_at(vars(contains("flag")), funs("conviction" = if_else(. == 1 & (disposition_type_original %in% c("Conviction: Nolo Plea", 
                                                                       "Conviction: Guilty Plea", "Found True")|grepl("^Conviction|^Guilty",
                                                                                                        disposition_type_original)), 1, 0))) %>%
  rename_at(vars(contains("flag"), -contains("conviction")), funs(paste0("court_", .))) %>%
  rename_at(vars(contains("conviction")), funs(paste0("conviction_", gsub("_conviction", "", .))))

# Standardize Factors
court_df <- court_df %>%
  mutate(sex = case_when(sex_original %in% c("M") ~ "Male",
                         sex_original %in% c("F") ~ "Female",
                         T ~ "Other_Unknown"),
         
         #Trimming white space on original race first
         race = case_when(race_original %in% c("B") ~ "Black",
                          race_original %in% c("H") ~ "Hispanic",
                          race_original %in% c("W") ~ "White",
                          #All Other races/ethnicities collapsed into other
                          T ~ "Other_Unknown"),
         
         disposition_type = case_when(disposition_type_original %in% c("Conviction: Nolo Plea", 
                                                                       "Conviction: Guilty Plea", "Found True")|grepl("^Conviction|^Guilty",
                                                                                                        disposition_type_original) ~ "Guilty",
                                      disposition_type_original %in% c("Dismissal", "Discharged")|grepl("^Dismissal", 
                                                                                                        disposition_type_original) ~ "Dismissed",
                                      disposition_type_original %in% c("Acquittal") ~ "Not_Guilty",
                                      T ~ "Other"),
         
         sentence_type = case_when(grepl("Jail", sentence_type_original) ~ "Jail",
                                   grepl("Probation", sentence_type_original) ~ "Probation",
                                   grepl("Prison|Life", sentence_type_original) ~ "Prison",
                                   T ~ "Other"))

####

court_hearing <- lapply(1:3, function(i){
  read_excel("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Tulare/P3 Submission-Jan 15/TCSC Hearings.xlsx", col_types = "text", sheet = i, col_names = F)
}) %>% bind_rows()

names(court_hearing) <- court_hearing[1,]

court_hearing <- court_hearing %>%
  slice(-1)

#Standardize Names
names(court_hearing) <- c("court_case_id", "name", "hearing_date_time", "hearing_type_original", "fta_all_flag", "fta_flag")

# Standardize Factors
court_hearing <- court_hearing %>%
  mutate(hearing_type = case_when(grepl("Arraignment", hearing_type_original) ~ "Arraignment",
                                  grepl("Sentencing", hearing_type_original) ~ "Sentencing",
                                  T ~ "Other"))
#Standardize Flags
court_hearing <- court_hearing %>%
  mutate(fta_all_flag = if_else(fta_all_flag == "Yes", 1, 0),
         fta_flag =  if_else(fta_flag == "Yes", 1, 0))

court_df %>%
  # semi_join(court_hearing, by = "court_case_id") %>%o
  count(year(filing_date))

court_hearing %>%
  # semi_join(court_df) %>%
  count(year(hearing_date_time))

# Diagnostics
# court_df %>%
#   semi_join(year())
# 
# court_hearing <- lapply(1:2, function(i){
#   read_excel("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Tulare/P3 Submission-Jan 15/TCSC Hearings.xlsx", col_types = "text", sheet = i, col_names = F)
# }) %>% bind_rows()
```

  Court Collapse
```{r}
# Court Charge Collapse--See pg. xxx for more details about this process.

#Court Charges
  ## Disposition date is missing and replaced with the charge dispostion date.
court_df <- court_df %>%
  mutate(disposition_date = charge_disposition_date) %>%
  select(-charge_filing_date)

court_df <- court_df %>%
  mutate(disposition_type = ordered(disposition_type, levels = c("Other", "Dismissed", "Not_Guilty", "Nolo_Contendere", "Guilty"))) %>%
  mutate(hierarchy = if_else(is.na(hierarchy), 1e6, as.numeric(hierarchy))) %>%
  # group_by(court_case_id) %>%
  # mutate(disposition_date = max(disposition_date)) %>%
  mutate(
    # max_court_charge_level = court_charge_level[hierarchy == min(hierarchy)][1],
    #      max_court_charge_code = court_charge_code[hierarchy == min(hierarchy)][1],
    #      max_court_charge = court_charge[hierarchy == min(hierarchy)][1],
    #      max_charge_description = master_charge_description[hierarchy == min(hierarchy)][1],
    #      max_hier = min(hierarchy),
         disposition_type = max(disposition_type)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, .))) %>%
  mutate_at(vars(contains("flag")), funs("count" = sum(.))) %>%
  mutate_at(vars(contains("flag")), max) 
  # filter(hierarchy == min(hierarchy)) %>%
  # ungroup() %>%
  # distinct(court_case_id, .keep_all = T) 

court_df <- court_df %>%
  mutate(pretrial_end_date = if_else(disposition_date <= sentence_date|is.na(sentence_date), disposition_date, sentence_date),
         conviction_flag = if_else(!is.na(sentence_date), 1, 0))

fwrite(court_df, "G:/CrimJustice/PretrialAssessmentPilot/Agency Collapse CSV Files/Tulare Court Collapse.csv")
```


Assessment Data 
```{r}
# Tulare Assessment Data Import
  ## assess_df contains one row per risk assessment event/risk assessment question/pretrial terms and conditions. The tool questions are widened into columns.

####

# Assessments Data Import
  ## assess_df contains one row per risk assessment event/risk assessment question/pretrial terms and conditions. The questions are widened into columns.
assess_df <- read_excel("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Tulare/P2 Submission-June 30/PreTrialProject_DataElementInventory 20200101-20200630 run 20200819 1506.xlsx", col_types = "text")

# The tool questions are widened so that each question is a variable and each response a value. This is done first, so that standardized names may be added. 
assess_df <- assess_df %>%
  mutate(Tool_Responses = case_when(Tool_Responses == "New Violent Criminal Activity" ~ "psa_nvca_raw_risk_score",
                                    Tool_Responses == "Failure to Appear" ~ "psa_fta_raw_risk_score",
                                    Tool_Responses == "New Criminal Activity" ~ "psa_nca_raw_risk_score")) %>%
  spread(Tool_Responses, Score) 


names_df <- tibble(original_field = names(assess_df)) 

# Variable name standardization--See pg. xxx for more details.
names(assess_df) <- c("tool_name", "assessment_date_time", "zip_code", "release_recommendation_original", "release_authorization_original", "release_decision_original", "release_date", "release_conditions_original", "pretrial_violation_original", "pretrial_violation_date", "court_date_reminder_original", "pretrial_termination_reason_original", "pretrial_termination_date", "cii", "fbi", "local_id", "cdl_id", "name", "dob", "sex_original", "race_original", "book_num", "assessment_id", "psa_fta_raw_risk_score", "psa_nca_raw_risk_score", "psa_nvca_raw_risk_score")

names_df$field <- names(assess_df) 

# Date Reformatting--See pg. xxx for more details.
assess_df <- assess_df %>%
  mutate_at(vars(contains("date"), dob, -court_date_reminder_original, -assessment_date_time), convertToDate) %>%
  mutate(assessment_date_time = convertToDateTime(assessment_date_time),
         assessment_date = as_date(assessment_date_time))

# Risk Score Standardization--Tool Response values are changed to their numeric point value.
assess_df <- assess_df %>%
  mutate(tool_name = "psa",
         psa_nvca_risk_score = if_else(psa_nvca_raw_risk_score >= 4, 1 ,0),
         psa_nca_risk_score = case_when(psa_nca_raw_risk_score %in% 0 ~ 1,
                                        psa_nca_raw_risk_score %in% 1:2 ~ 2,
                                        psa_nca_raw_risk_score %in% 3:4 ~ 3,
                                        psa_nca_raw_risk_score %in% 5:6 ~ 4,
                                        psa_nca_raw_risk_score %in% 7:8 ~ 5,
                                        psa_nca_raw_risk_score %in% 9:13 ~ 6),
         psa_fta_risk_score = case_when(psa_fta_raw_risk_score %in% 0 ~ 1,
                                        psa_fta_raw_risk_score %in% 1 ~ 2,
                                        psa_fta_raw_risk_score %in% 2 ~ 3,
                                        psa_fta_raw_risk_score %in% 3:4 ~ 4,
                                        psa_fta_raw_risk_score %in% 5:6 ~ 5,
                                        psa_fta_raw_risk_score %in% 7 ~ 6))

# Standardize Factors--See pg. xxx for more details.
assess_df <- assess_df %>%
  mutate(sex = case_when(sex_original %in% c("Male") ~ "Male",
                         sex_original %in% c("Female") ~ "Female",
                         T ~ "Other_Unknown"),
         
         #Trimming white space on original race first
         race_original = trimws(race_original),
         race = case_when(race_original %in% c("Black") ~ "Black",
                          race_original %in% c("Hispanic") ~ "Hispanic",
                          race_original %in% c("White") ~ "White",
                          #All Other races/ethnicities collapsed into other
                          T ~ "Other_Unknown"),
         release_recommendation = case_when(
           release_recommendation_original %in% c("Release Own Recognizance") ~ "OR",
           release_recommendation_original %in% c("PML 1 - Low", "PML 2 - Medium", "PML 3 - High") ~ "Monitor",
           release_recommendation_original %in% c("Detain", "Detain/If released, max reporting") ~ "Detain",
           T ~ "Other_Unknown"),
         release_decision = case_when(
           release_decision_original %in% c("Release Own Recognizance") ~ "OR",
           release_decision_original %in% c("PML 1 - Low", "PML 2 - Medium", "PML 3 - High", "SORR") ~ "Monitor",
           release_decision_original %in% c("Detain") ~ "Detain",
           release_decision_original %in% c("No Case Filed, Released")|is.na(release_decision_original) ~ "Ineligible",
           T ~ "Other_Unknown"),
          pretrial_termination_reason = case_when(
           pretrial_termination_reason_original %in% c("Acquittal", "Dismissed", "No Charges Filed", "Sentenced") ~ "Case_Disposed",
           pretrial_termination_reason_original %in% c("Failure to Appear") ~ "FTA",
           pretrial_termination_reason_original %in% c("Failure to Report", "Technical Violation") ~ "Violation",
           pretrial_termination_reason_original %in% c("Felony Arrest") ~ "New_Crime",
           pretrial_termination_reason_original %in% c("Bond Posted", "Cite to Appear", "Diversion", "Filed as Misdemeanor", "Release Denied",
                                                       "Release Own Recognizance") ~ "Not_Tracked",
           T ~ "Other_Unknown"),
         pretrial_ineligible_reason = case_when(
           release_decision_original %in% c("No Case Filed, Released") ~ "Case_Disposed",
           pretrial_termination_reason_original %in% c("Bond Posted") ~ "Bail_Bond",
           T ~ "Other_Unknown"),
        
         pretrial_termination_outcome = case_when(pretrial_termination_reason %in% c("Case_Disposed") ~ "Successful",
                                                  pretrial_termination_reason %in% c("Abscond", "FTA", "New_Crime", "Violation") ~ "Unsuccessful",
                                                  pretrial_termination_reason %in% c("Not_Tracked") ~ "Not_Tracked",
                                                  T ~ "Other_Unknown"),
         release_authorization = case_when(release_authorization_original == "Judge" ~ "Judge",
                                           T ~ "Other_Unknown"))
          

# Flag Standardization---See pg. xxx for more details.
assess_df <- assess_df %>%
  mutate(assess_flag = if_else(is.na(assessment_date), 0, 1),
         rec_release_flag = if_else(release_recommendation %in% c("OR", "Monitor"), 1, 0),
         decision_release_flag = if_else(release_decision %in% c("OR", "Monitor"), 1, 0),
         #This field needs to come from the jail data.
         # pretrial_release_flag = if_else(),
         release_override_flag = if_else(rec_release_flag != decision_release_flag & 
                                            !release_recommendation %in% c("Ineligible", "Other_Unknown") & 
                                            !release_decision %in% c("Ineligible", "Other_Unknown"), 1, 0),
         # rec_em_flag = if_else(grepl("SCRAM", toupper(release_recommendation_original)), 1, 0),
         # rec_phone_flag = if_else(),
         # rec_inperson_flag = if_else(),
         # rec_drug_test_flag = if_else(grepl("TEST", toupper(release_recommendation_original)), 1, 0),
         # rec_other_flag = if_else(),
         condition_em_flag = if_else(grepl("ELECTRONIC MONITOR|GPS|TAD|ELECTRONIC", toupper(release_conditions_original)), 1, 0),
         # Discuss release_conditions_original with Santa Barbara along with their original materias to determine phone and inperson flag. 
         # condition_phone_flag = if_else(),
         # condition_inperson_flag = if_else(),
         ## Does test as requested entail a request flag? What is the treatment program?
         condition_drug_test_flag = if_else(grepl("TAD|TEST", toupper(release_conditions_original)), 1, 0),
         # condition_treatment_flag = if_else(grepl("TREATMENT", toupper(release_conditions_original)), 1, 0),
         condition_no_contact_flag = if_else(grepl("NO FURTHER CONTACT|NO CONTACT", toupper(release_conditions_original)), 1, 0),
         court_date_reminder_flag = if_else(court_date_reminder_original == "Yes", 1, 0),
         # Transit service doesn't actually exist here.  
         # transit_service_flag = if_else(grepl("BUS", toupper(other_pretrial_service_original)), 1, 0),
         ## Are all violations violations that result in termation? 
         pretrial_violation_flag = if_else(!is.na(pretrial_violation_original), 1, 0),
         monitor_level = case_when(
           release_decision_original == "PML 1 - Low" ~ "Low",
           release_decision_original == "PML 2 - Medium" ~ "Medium",
           release_decision_original == "PML 3 - High" ~ "High",
           
           psa_nca_risk_score == 3 & psa_fta_risk_score == 2 ~ "Low",
           psa_nca_risk_score == 3 & psa_fta_risk_score == 3 ~ "Low",
           psa_nca_risk_score == 3 & psa_fta_risk_score == 4 ~ "Low",
           psa_nca_risk_score == 2 & psa_fta_risk_score == 3 ~ "Low",
           psa_nca_risk_score == 2 & psa_fta_risk_score == 4 ~ "Low",
           
           psa_nca_risk_score == 2 & psa_fta_risk_score == 5 ~ "Medium",
           psa_nca_risk_score == 3 & psa_fta_risk_score == 5 ~ "Medium",
           psa_nca_risk_score == 4 & psa_fta_risk_score == 2 ~ "Medium",
           psa_nca_risk_score == 4 & psa_fta_risk_score == 3 ~ "Medium",
           psa_nca_risk_score == 4 & psa_fta_risk_score == 4 ~ "Medium",
           
           psa_nca_risk_score == 4 & psa_fta_risk_score == 5 ~ "High",
           psa_nca_risk_score == 5 & psa_fta_risk_score == 2 ~ "High",
           psa_nca_risk_score == 5 & psa_fta_risk_score == 3 ~ "High",
           psa_nca_risk_score == 5 & psa_fta_risk_score == 4 ~ "High",
           
           T ~ "Other_Unknown"
           ))





####

assess_response <-  read_excel("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Tulare/P2 Submission-June 30/PreTrialProject_AssessmentPSA 20200819 1502.xlsx", col_types = "text")


# Variable name standardization--See pg. xxx for more details.
names(assess_response) <- c("assessment_id", "assessment_date_time", "arrest_num", "psa_tool_response_1", "psa_tool_response_2", "psa_tool_response_2a", "psa_tool_response_3", "psa_tool_response_4", "psa_tool_response_5", "psa_tool_response_5a", "psa_tool_response_6", "psa_tool_response_7", "psa_tool_response_8", "psa_tool_response_9")

# Date Reformatting--See pg. xxx for more details.
assess_response <- assess_response %>%
  mutate(assessment_date_time = convertToDateTime(assessment_date_time),
         assessment_date = as_date(assessment_date_time))

# Risk Score Standardization--Tool Response values are changed to their numeric point value.
assess_response <- assess_response %>%
  mutate(tool_name = "psa",
         psa_tool_response_1 = if_else(psa_tool_response_1 == "23 or older", 0, 2),
         psa_tool_response_2 = if_else(psa_tool_response_2 == "Yes", 2, 0),
         psa_tool_response_2a = if_else(psa_tool_response_2a == "Yes", 1, 0),
         psa_tool_response_3 = if_else(psa_tool_response_3 == "Yes", 1, 0),
         psa_tool_response_4 = if_else(psa_tool_response_4 == "Yes", 1, 0),
         psa_tool_response_5 = if_else(psa_tool_response_5 == "Yes", 1, 0),
         psa_tool_response_5a = if_else(psa_tool_response_5a == "Yes", 1, 0),
         psa_tool_response_6 = case_when(psa_tool_response_6 == "0" ~ 0,
                                         psa_tool_response_6 %in% c("1","2") ~ 1,
                                         psa_tool_response_6 == "3 or more" ~ 2),
         psa_tool_response_7 = case_when(psa_tool_response_7 == "0" ~ 0,
                                         psa_tool_response_7 %in% c("1") ~ 2,
                                         psa_tool_response_7 == "2 or more" ~ 4),
         psa_tool_response_8 = if_else(psa_tool_response_8 == "Yes", 1, 0),
         psa_tool_response_9 = if_else(psa_tool_response_9 == "Yes", 2, 0))

# assess_df %>%
#   count(release_decision_original)
# 
# assess_df2 <- assess_df %>%
#   filter(as_date(assessment_date) > as_date(pretrial_termination_date)| as_date(assessment_date) > as_date(release_date)) %>%
#   select(name, dob, contains("date"), - court_date_reminder_flag, -court_date_reminder_original)

# write.xlsx(assess_df2, file = "People who have assessment dates after release or termination dates.xlsx")
```

  Assess Collapse
```{r}
assess_df <- assess_df %>%
  group_by(assessment_id) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, .))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  distinct(assessment_id, .keep_all = T)
  
assess_response %>%
  distinct(assessment_id)

assess_df <- assess_df %>%
  left_join(assess_response)

fwrite(assess_df, "G:/CrimJustice/PretrialAssessmentPilot/Agency Collapse CSV Files/Tulare Assessment Collapse.csv")
```


Join
```{r eval=FALSE, include=FALSE}
#Alameda has an integrated criminal justice system. Information is joined across agencies on the jail_court_ID. It is contained in the book_df, court_df, and book_charge tables. 

#Jail Court ID is duplicated when split between cases
book_df <- book_df %>% distinct(jail_court_id, .keep_all = T)

#Jail Court ID is duplicated when split between cases
court_df <- court_df %>% distinct(jail_court_id, .keep_all = T)

book_no_court <- anti_join(book_df, court_df, by = c("jail_court_id"))
nrow(book_df)
nrow(book_no_court)
nrow(book_no_court)/nrow(book_df)

court_no_book <- anti_join(court_df, book_df, by = c("jail_court_id"))
nrow(court_df)
nrow(court_no_book)
nrow(court_no_book)/nrow(court_df)
```

Collapse
```{r}

```

Data Extraction
  DOJ CII/Linking Extraction
```{r}
# Only have court data for now.
# Grab Tables with CII
df_list <- sapply(
  ls()[which(sapply(ls(), function(i){
    sum(names(get(i)) %in% "cii")
    }) == 1)],
  function(j){
    df <- get(j)
    df <- df %>%
      select(any_of(c("cii", "cdl_id", "fbi", "last_name", "first_name", "middle_name", "dob", "sex_original", "race_original"))) %>%
       mutate(
         cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) %>%
  distinct()

})

# book_df <- book_df %>%
#       select(any_of(c("cii", "cdl_id", "fbi", "last_name", "first_name", "middle_name", "dob", "sex_original", "race_original"))) %>%
#        mutate(
#          cii = parse_number(cii),
#          cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
#                          nchar(cii) == 7 ~ paste0("000", cii),
#                          nchar(cii) == 8 ~ paste0("00", cii),
#                          nchar(cii) == 9 ~ paste0("0", cii),
#                          T ~ as.character(cii)),
#          cii = if_else(nchar(cii) != 10, NA_character_, cii)) %>%
#   distinct()

# # CIIs from assessment tables
# doj_assess <- bind_rows(df_list[[1]])
# 
# CIIs from booking tables
doj_book <- bind_rows(df_list[[1]])

# CIIs from court tables
doj_court <- df_list[[2]]


#CIIs for DOJ
doj_cii <- bind_rows(doj_book %>% select(cii),
                     doj_court %>% select(cii)) %>%
                     #doj_assess %>% select(cii)) %>%
  distinct() %>%
  filter(nchar(cii) == 10)

# doj_cii <- court_df %>%
#   select(cii)

#Create an excel workbook with all data table. Make sure to include the cii table first. 
write.xlsx(list(doj_cii, doj_book, doj_court), file = "CIIs for DOJ/February 2021/Tulare P3 CIIs and Demographics for DOJ.xlsx", sheetName = c("ciis", "book", "court"))

# # Examine missing ciis and duplicates on cii. 
# doj_book %>% #Off by about 3,000-2633 due to missing cii
#   distinct()
# 
# doj_book %>% 
#   distinct(cii)
# 
# doj_book %>% 
#   distinct() %>%
#   add_count(cii) %>%
#   filter(n > 1) %>%
#   arrange(desc(n)) %>% 
#   View()
# 
# doj_court %>% #Off by about 12,000, 13,069/25,642
#   distinct()
# 
# doj_court %>% 
#   distinct(cii)
# 
# doj_court %>% #11,510 due to missing cii
#   distinct() %>%
#   add_count(cii) %>%
#   filter(n > 1) %>%o
#   arrange(desc(n)) %>% 
#   View()
```

  Assessment Tables
```{r}
assess_table <- assess_df %>%
  # Collapse to each assessment.
  distinct(local_id, assessment_date_time, .keep_all = T) %>%
  # Filter for only those actually assessed
  filter(!is.na(assessment_date)) %>%
  # Create county name.
  mutate(county = "Tulare") %>%
  # Select relevants variables.
  select(county, release_recommendation, release_decision, assessment_date, psa_nvca_risk_score, psa_nca_risk_score, psa_fta_risk_score, tool_name, assessment_date, dob, sex, race, monitor_level, pretrial_termination_reason)

# Save file  
fwrite(assess_table, file = "G:/CrimJustice/PretrialAssessmentPilot/Assessment Output Tables/Tulare Assessment Output 10-2020.csv")

# assess_df %>%
#   # Collapse to each assessment
#   distinct(pretrial_id, .keep_all = T) %>%
#   # Filter for only those actually assessed
#   filter(!is.na(assessment_date)) %>%
#   count(risk_level) %>%
#   mutate(total = sum(n),
#          risk_level = round(n/total*100)) %>%
#   spread(risk_level, n)
# 
# rowsu

assess_df %>%
  select(-release_conditions_original) %>%
  distinct() %>%
  add_count(local_id, assessment_date_time) %>%
  filter(n > 1) %>%
  arrange(local_id) %>%
  View()

```


# Tuolumne

Jail Data
```{r}
#Jail Data
# doc <- read_xml("Historical Data Submissions/Tuolumne/Inmates-202001115.XML")
# doc <- read_xml("Historical Data Submissions/Tuolumne/P2 Submission-June 30/Inmates-20200814.XML")
# doc <- read_xml("Historical Data Submissions/Tuolumne/P3 Submission-Jan 15/Inmates-20210121.XML")
# 
# jail_list <- as_list(doc)
# 
# jail_df <- tibble(inmate = jail_list)
# 
# jail_df <- jail_df %>%
#   unnest(inmate) %>%
#   unnest_wider(inmate)
# 
# jail_df <- jail_df %>%
#   unnest_auto(Name) %>%
#   unnest_auto(DOB) %>%
#   unnest_auto(CII) %>%
#   unnest_auto(FBI) %>%
#   unnest_auto(Occupation) %>%
#   unnest_auto(Employer) %>%
#   unnest_auto(Gender) %>%
#   unnest_auto(Race) %>%
#   unnest_auto(Last) %>%
#   unnest_auto(First) %>%
#   unnest_auto(Middle) #%>%
#   # unnest_auto(Suffix)
# 
# jail_df <- jail_df %>%
#   unnest_longer(CDL) %>%
#   unnest_longer(CDL) %>%
#   mutate(CDL_id = if_else(is.na(CDL_id), "Number", CDL_id)) %>%
#   pivot_wider(names_from = CDL_id, values_from = CDL)
# 
# 
# jail_df <- jail_df %>%
#   unnest(Bookings)  %>%
#   unnest_wider(Bookings)
# 
# jail_df <- jail_df %>%
#   unnest_longer(ArrestDateTime) %>%
#   unnest_longer(BookingType) %>%
#   unnest_longer(BookingNumber) %>%
#   unnest_longer(BookingDateTime) %>%
#   unnest_longer(CourtDocket) %>%
#   unnest_longer(ReleaseDate) %>%
#   unnest_longer(ReleaseType) %>%
#   unnest_longer(ConvictionDate)
# 
# jail_df <- jail_df %>%
#   unnest(Charges) %>%
#   unnest_wider(Charges)
# 
# jail_df <- jail_df %>%
#   unnest_longer(ChargeLevel) %>%
#   unnest_longer(ChargeSection) %>%
#   unnest_longer(ChargeStatute) %>%
#   unnest_longer(WN) %>%
#   unnest_longer(Suffix)

# fwrite(jail_df, file = "G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Tuolumne/Tuolumne Jail xml to csv Period 3.csv")

#Jail Data Loaded from fixed XML bullshit

# book_df <- fread("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Tuolumne/Tuolumne Jail xml to csv Period 2.csv")
book_df <- fread("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Tuolumne/Tuolumne Jail xml to csv Period 3.csv")

# original_field <- names(book_df)

names(book_df) <- c("last_name", "first_name", "middle_name", "name_suffix","dob", "cii", "fbi", "occupation", "employer", "arrest_date_time", "book_type_original", "book_num", "book_date_time", "court_docket_id", "release_date_time", "release_type_original", "arrest_charge_level_original", "arrest_charge_original", "arrest_charge_code_original", "court_case_id", "conviction_date", "sex_original", "race_original", "cdl_state", "cdl_id")

book_df <- book_df %>%
  mutate_at(vars(dob, conviction_date), as_date) %>%
  mutate_at(vars(arrest_date_time, book_date_time, release_date_time), ymd_hm) %>%
  mutate(arrest_date = as_date(arrest_date_time),
         book_date = as_date(book_date_time),
         release_date = as_date(release_date_time))

# Cleaning Up Charges
book_df <- book_df %>%
  mutate(attempt = if_else(grepl("664", arrest_charge_original), 1, 0)) %>%
  separate_rows(arrest_charge_original, sep = "\\\\|\\-|\\/") %>%
  mutate(arrest_charge_code = if_else(!arrest_charge_code_original %in% c("PC", "VC", "HS", "BP", "WI", "US"), "Other",
                                      arrest_charge_code_original),
         arrest_charge_level = if_else(!arrest_charge_level_original %in% c("F", "M", "I"), "Other", arrest_charge_level_original),
         arrest_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}|EX|\\+|\\-","", arrest_charge_original)),
         arrest_charge = if_else(arrest_charge %in% c("23152", "23152AB") & arrest_charge_level == "M", "23152A", arrest_charge),
         arrest_charge_code = if_else(arrest_charge %in% c("5305A", "13205", "3455", "2735", "273AA"), "PC", arrest_charge_code),
         arrest_charge = if_else(arrest_charge == "3454", "3454C", arrest_charge)) %>%
  unite(join_var, arrest_charge_level, arrest_charge_code, arrest_charge, remove = F)

load("Complete Charge Code Hierarchy.RData")


book_df <- left_join(book_df, charge_hier, by = "join_var") %>%
  mutate(felony_flag = if_else(arrest_charge_level == "F", 1, 0),
         misd_flag = if_else(arrest_charge_level == "M", 1, 0)) %>%
  rename_at(vars(contains("flag")), funs(paste0("arrest_", .))) 

book_df<- book_df %>%
  mutate(hierarchy = if_else(is.na(hierarchy) & arrest_charge_level_original == "DETAIN", 1e6, hierarchy),
         hierarchy = if_else(is.na(hierarchy) & arrest_charge_level_original == "I", 1e6, hierarchy))

# original_df[[13]] <- tibble(table_name = "book_df", original_field = original_field, modified_field = names(book_df))


book_df <- book_df %>%
  mutate(sex = case_when(sex_original %in% c("M") ~ "Male",
                         sex_original %in% c("F") ~ "Female",
                         T ~ "Other"),
         
         #Trimming white space on original race first
         race_original = trimws(race_original),
         race = case_when(race_original %in% c("B") ~ "Black",
                          race_original %in% c("H") ~ "Hispanic",
                          race_original %in% c("W") ~ "White",
                          #All Other races/ethnicities collapsed into other
                          T ~ "Other_Unknown"),
         
         book_type = case_when(book_type_original %in% c("FRESH", "1170(H) VIOL") ~ "On_View",
                               book_type_original %in% c("WARRANT") ~ "Warrant",
                               book_type_original %in% c("OUT OF COUNTY HOLD", "PROBATION HOLD", "PAROLE HOLD", "OUT OF STATE HOLD", "ENROUTE") ~ "Hold",
                               book_type_original %in% c("BOOK AND RELEASE") ~ "Cite_Release",
                               book_type_original %in% c("REMAND") ~ "Court_Order",
                               book_type_original %in% c("COMMITMENT") ~ "Commitment",
                               T ~ "Other"),
         
         release_type = case_when(release_type_original %in% c("TIME SERVED") ~ "Time_Served",
                                  release_type_original %in% c("RELEASE TO AGENCY WITH HOLD", "TO OTHER AGENCY", 
                                                               "RELEASE TO OTHER STATE", "TURNED OVER TO ANOTHER AGENCY") ~ "Hold_Release",
                                  release_type_original %in% c("CITE RELEASED") ~ "Cite_Release",
                                  release_type_original %in% c("BAIL BOND", "CASH BAIL") ~ "Bail_Bond",
                                  release_type_original %in% c("CASE DISMISSED", "849(B)(2)PC", "DA NOT FILING", 
                                                               "849(B)(1)PC", "849(B)(3)PC", "849 PC") ~ "Dismissed_Dropped",
                                  release_type_original %in% c("RELEASE ON OWN RECOGNIZANCE", "RELEASE O/R BY JUDGE") ~ "OR",
                                  release_type_original %in% c("COURT ORDERED/PHF 1370PC") ~ "Court_Order",
                                  release_type_original %in% c("PRISON") ~ "Prison",
                                  release_type_original %in% c("O/R- PRETRIAL PROG") ~ "Monitoring",
                                  release_type_original %in% c("TIME SERVED - OVERCROWDING") ~ "Sent_Cap",
                                  book_type_original %in% c("EX PARTE", "825PC ADMIN REL") ~ "Administrative",
                                  T ~ "Other"))
```

  Jail Collapse
```{r}
#Book numbers are completely distinct for date and court case id. Except one instance.
book_df <- book_df %>%
  mutate(time_first_release = release_date - book_date) %>%
  mutate(hierarchy = if_else(is.na(hierarchy), 1e6, as.numeric(hierarchy))) %>%
  group_by(book_num) %>%
  # mutate(max_booktype = book_type[hierarchy == min(hierarchy)][1],
  #        max_arrest_charge = arrest_charge[hierarchy == min(hierarchy)][1],
  #        max_charge_description = master_charge_description[hierarchy == min(hierarchy)][1],
  #        max_hier = min(hierarchy)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, .))) %>%
  mutate_at(vars(contains("flag")), funs("count" = sum(.))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  mutate(join_var = paste(join_var, collapse = " ")) %>%
  filter(hierarchy == min(hierarchy)) %>%
  ungroup() %>%
  distinct(book_num, .keep_all = T) 

# # Diagnostics
# book_df %>%
#   distinct(book_num, book_date) %>%
#   arrange(book_num) %>%
#   group_by(book_num) %>%
#   add_count() %>%
#   arrange(desc(n)) %>%
#   filter(n > 1)
# 
# book_df %>%
#   distinct(book_num, court_case_id)

save(book_df, file = "G:/CrimJustice/PretrialAssessmentPilot/Agency Collapse CSV Files/Tuolumne Booking Collapse.RData")
```

 
Court Data
```{r}
# Court Case Data Import--- Tuolumne, 2015-01-06 to 2020-06-26
  ## Tuolumne submitted the data in an Excel file with multiple sheets and they are being imported separately and turned into the respective tables described below.
  ## court_df contains one row per booking after duplicate rows are removed and contains information about the court case including information about relevant dates.
  ## court_charge contains one row per court case and charge combination, as well as information on each of the charges. Initially, it also duplicated information when a charge had multiple disposition dates. The first date is taken.
  ## court_sent contains one row per court_case_id and sentence event. Initially, it also duplicated rows based on charge. Charge information is deduplicated and removed as it is redundant with the court_charge table.
  ## court_hearing contains one row per court_case_id and hearing event.
  ## court_person contains one row per person, court case, arrest number, and booking number combination.
  ## court_fta contains one row per FTA event.
  ## court_fta_war contains one row per FTA event with a bench warrant issued.
 
# Court Cases
court_case <- read_excel("Historical Data Submissions/Tuolumne/P3 Submission-Jan 15/Tuolumne Pretrial Assessment Information_2015 to 2020_Complete.xls", sheet = 1, col_types = "text")

# Variable name standardization--See pg. xxx for more details.
names(court_case) <- c("court_case_id", "name", "disposition_type_original", "disposition_date", "filing_date", "case_type")
 
# Removing duplicates
  ## Some of the court data contain duplicate rows with missing fields and are removed.
court_case <- court_case %>%
  arrange(disposition_date) %>%
  distinct(court_case_id, .keep_all = T)
 
# Date Reformatting--See pg. xxx for more details.
court_case <- court_case %>%
  mutate_at(vars(contains("date")), mdy)
 
# Standardize Factors--See pg. xxx for more details.
court_case <- court_case %>%
  mutate(disposition_type = case_when(
    disposition_type_original %in% c("Dismissal", "Dismissal: Diversion Successful", "Dismissal: DEJ Successful", "Dismissal: Conviction Set Aside") ~ "Dismissed",
    disposition_type_original %in% c("Conviction: Nolo Plea") ~ "Nolo_Contendere",
    disposition_type_original %in% c("Conviction: Guilty Plea", "Conviction: Jury Verdict", "Conviction: Bail Forfeiture", "Conviction: Court Finding of Guilt", "Conviction: DEJ Unsuccessful") ~ "Guilty",
    disposition_type_original %in% c("Acquittal") ~ "Not_Guilty",
    T ~ "Other"
  ))
 
####
 
# Court Filing Charges
  ## court_charge contains one row per court case and charge combination, as well as information on each of the charges. Initially, it also duplicated information when a charge had multiple disposition dates. The first date is taken.
court_charge <- read_excel("Historical Data Submissions/Tuolumne/P3 Submission-Jan 15/Tuolumne Pretrial Assessment Information_2015 to 2020_Complete.xls", sheet = 2, col_types = "text")
 
# Variable name standardization--See pg. xxx for more details.
names(court_charge) <- c("court_case_id", "counts", "court_charge_original", "court_charge_level_original", "charge_description", "disposition_type_original", "disposition_date", "plea_type_original", "plea_date")
 
# Date Reformatting--See pg. xxx for more details.
court_charge <- court_charge %>%
  mutate_at(vars(contains("date")), mdy)
 
# Standardize Factors--See pg. xxx for more details.
court_charge <- court_charge %>%
  mutate(disposition_type = case_when(
    disposition_type_original %in% c("Dismissal", "Dismissed with a Harvey Waiver", "Dismissal: Diversion Successful", "Dismissal: DEJ Successful") ~ "Dismissed",
    disposition_type_original %in% c("") ~ "Dropped",
    disposition_type_original %in% c("Conviction: Nolo Plea") ~ "Nolo_Contendere",
    disposition_type_original %in% c("Conviction: Guilty Plea", "Conviction: Jury Verdict", "Conviction: Bail Forfeiture", "Guilty Plea: DEJ", "Admitted", "Conviction: Court Finding of Guilt", "Conviction: DEJ Unsuccessful", "Conviction: Traf Sch Not Complete") ~ "Guilty",
    disposition_type_original %in% c("Acquittal") ~ "Not_Guilty",
    T ~ "Other"
  ),
  plea_type = case_when(
    plea_type_original %in% c("Guilty") ~ "Guilty",
    plea_type_original %in% c("Not Guilty") ~ "Not_Guilty",
    T ~ "Other"
  ))
 
# Charge Standardization and Flag Adds--See pg. xxx for more details.
court_charge <- court_charge %>%
  mutate(court_charge_code = case_when(
    grepl("PC", court_charge_original, ignore.case = T) ~ "PC",
    grepl("VC", court_charge_original, ignore.case = T) ~ "VC",
    grepl("HS", court_charge_original, ignore.case = T) ~ "HS",
    grepl("BP", court_charge_original, ignore.case = T) ~ "BP",
    grepl("WI", court_charge_original, ignore.case = T) ~ "WI",
    grepl("US", court_charge_original, ignore.case = T) ~ "US",
    T ~ "Other"
  ),
  attempt_flag = if_else(grepl("664/", court_charge_original), 1, 0),
  court_charge = gsub(".*/", "", court_charge_original),
  court_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}", "", court_charge)),
  # These variables did not match the initial hierarchy. Check if they match the new hierarchy after the joining.
  court_charge = if_else(court_charge == "29800A", "29800A2", court_charge),
  court_charge_code = if_else(court_charge == "11360B", "HS", court_charge_code),
  court_charge_level = case_when(
    grepl("Felony", court_charge_level_original) ~ "F",
    grepl("Misdemeanor", court_charge_level_original) ~ "M",
    grepl("Infraction", court_charge_level_original) ~ "I",
    T ~ "Other"
  )) %>%
  distinct()
 
load("Complete Charge Code Hierarchy.RData")
 
court_charge <- court_charge %>%
  unite(join_var, court_charge_level, court_charge_code, court_charge, remove = F) %>%
  left_join(charge_hier) %>%
  mutate(felony_flag = if_else(court_charge_level == "F", 1, 0),
         misd_flag = if_else(court_charge_level == "M", 1, 0)) %>%
  rename_at(vars(contains("_flag")), funs(paste0("court_", .))) %>%
  mutate_at(vars(contains("_flag")), funs("conviction" = if_else(disposition_type %in% c("Nolo_Contendere", "Guilty") & . == 1, 1, 0))) %>%
  rename_at(vars(contains("_conviction")), funs(paste0("conviction_", gsub("court_|_conviction", "", .))))
 
# Removing duplicates
  ## Some of the court data contain duplicate rows with missing fields and are removed.
court_charge <- court_charge %>%
  arrange(disposition_date) %>%
  distinct(counts, court_case_id, join_var, .keep_all = T)
 
####
 
# Court Sentences
  ## court_sent contains one row per court_case_id and sentence event. Initially, it also duplicated rows based on charge. Charge information is deduplicated and removed as it is redundant with the court_charge table.
  ## Combining tables and deduplicating
court_sent <- read_excel("Historical Data Submissions/Tuolumne/P3 Submission-Jan 15/Tuolumne Pretrial Assessment Information_2015 to 2020_Complete.xls", sheet = 3, col_types = "text") %>%
  select(-Violation)
 
# Variable name standardization--See pg. xxx for more details.
names(court_sent) <- c("court_case_id", "sentence_date", "sentence_type_original", "term", "term_suspended", "sentence_location", "sentence_status", "count")
 
# Date Reformatting--See pg. xxx for more details.
court_sent <- court_sent %>%
  mutate(sentence_date = mdy(sentence_date))
 
# Standardize Factors--See pg. xxx for more details.
  ## Double check about "Mandatory Supervision".
court_sent <- court_sent %>%
  mutate(sentence_type = case_when(
    sentence_type_original %in% c("State Prison") ~ "Prison",
    sentence_type_original %in% c("County Jail", "County Jail: VOP", "County Jail: PC1170", "County Jail: Supervision Violation") ~ "Jail",
    sentence_type_original %in% c("Probation: Summary", "Probation: Formal", "Probation: Prop 36", "Mandatory Supervision") ~ "Probation",
    T ~ "Other"
  ))
 
####
 
# Court Hearings
  ## court_hearing contains one row per court_case_id and hearing event.
court_hearing <- lapply(4:9, function(i){
  read_excel("Historical Data Submissions/Tuolumne/P3 Submission-Jan 15/Tuolumne Pretrial Assessment Information_2015 to 2020_Complete.xls", sheet = i, col_types = "text")
  }) %>%
  bind_rows()

# Variable name standardization--See pg. xxx for more details.
names(court_hearing) <- c("court_case_id", "hearing_type_original", "hearing_date", "hearing_time", "hearing_result")
 
# Date Reformatting--See pg. xxx for more details.
court_hearing <- court_hearing %>%
  mutate(hearing_date_time = mdy_hm(paste(hearing_date, hearing_time)),
         hearing_date = mdy(hearing_date)) %>%
  select(-hearing_time)
 
# Standardize Factors--See pg. xxx for more details.
court_hearing <- court_hearing %>%
  mutate(hearing_type = case_when(
    grepl("Arraignment", hearing_type_original, ignore.case = T) ~ "Arraignment",
    grepl("Sentencing", hearing_type_original, ignore.case = T) ~ "Sentencing",
    T ~ "Other"
  ))
 
####
 
# Court Person Information
  ## court_person contains one row per person, court case, arrest number, and booking number combination.
  ## The new cumulative data does not contain cii and fbi. The old data had cii information, but not fbi information.
court_person <- read_excel("Historical Data Submissions/Tuolumne/P3 Submission-Jan 15/Tuolumne Pretrial Assessment Information_2015 to 2020_Complete.xls", sheet = 11, col_types = "text")

# Variable name standardization--See pg. xxx for more details.
names(court_person) <- c("court_case_id", "first_name", "last_name", "dob", "sex_original", "race_original", "arrest_num", "book_num")
 
# Date Reformatting--See pg. xxx for more details.
court_person <- court_person %>%
  mutate(dob = mdy(dob))
 
# Standardize Factors--See pg. xxx for more details.
court_person <- court_person %>%
  mutate(race = if_else(!race_original %in% c("Hispanic", "Black", "White"), "Other_Unknown", race_original),
         sex = if_else(!sex_original %in% c("Female", "Male"), "Other_Unknown", sex_original))

# Removing duplicates
  ## Some of the court data contain duplicate rows with missing fields and are removed.
court_person <- court_person %>%
  arrange(desc(dob)) %>%
  distinct(first_name, last_name, court_case_id, arrest_num, book_num, .keep_all = T)
 
####
 
# Court CII Information
court_cii <- read_excel("Historical Data Submissions/Tuolumne/P3 Submission-Jan 15/Tuolumne Pretrial Assessment Information_2015 to 2020_Complete.xls", sheet = 12, col_types = "text")
 
# Variable name standardization--See pg. xxx for more details.
names(court_cii) <- c("court_case_id", "first_name", "last_name", "type", "cii")
 
# Selecting for cii numbers, only one fbi number
court_cii <- court_cii %>%
  filter(type == "CII Number") %>%
  select(-type)
 
####
 
# Court FTAs
  ## court_fta contains one row per FTA event.
court_fta <- read_excel("Historical Data Submissions/Tuolumne/P3 Submission-Jan 15/Tuolumne Pretrial Assessment Information_2015 to 2020_Complete.xls", sheet = 14, col_types = "text")

# Variable name standardization--See pg. xxx for more details.
names(court_fta) <- c("court_case_id", "fta_date", "fta")
 
# Date Reformatting--See pg. xxx for more details.
court_fta <- court_fta %>%
  mutate(fta_date = mdy(fta_date))
 
# Flag Adds--See pg. xxx for more details.
court_fta <- court_fta %>%
  mutate(fta_flag = if_else(grepl("Issued", fta), 1, 0),
         fta_all_flag = 1) 
  # rename_at(vars(contains("flag")), funs(paste0("court_", .)))
 
####
 
# Court FTAs with Warrants
  ## court_fta_war contains one row per FTA event with a bench warrant issued.
court_fta_war <- read_excel("Historical Data Submissions/Tuolumne/P3 Submission-Jan 15/Tuolumne Pretrial Assessment Information_2015 to 2020_Complete.xls", sheet = 15, col_types = "text")

# Variable name standardization--See pg. xxx for more details.
names(court_fta_war) <- c("court_case_id", "fta_date", "fta")
 
# Date Reformatting--See pg. xxx for more details.
court_fta_war <- court_fta_war %>%
  mutate(fta_date = mdy(fta_date))
 
# Flag Adds--See pg. xxx for more details.
court_fta_war <- court_fta_war %>%
  mutate(fta_flag = 1,
         fta_all_flag = 1) 
  # rename_at(vars(contains("flag")), funs(paste0("court_", .)))
 
rm(court_df, court_df_p1, court_sheets, court_sheets_p1)

#### NOT USED ####
 
# # Court Case Lawyer Information
# court_lawyer <- read_excel("Historical Data Submissions/Modoc/Modoc Pretrial Assessment Information.xls", sheet = 5, col_types = "text") %>%
#   bind_rows(read_excel("Historical Data Submissions/Modoc/Modoc Pretrial Assessment Information_2nd quarter_2019_2020.xls", sheet = 5, col_types = "text")) %>%
#   distinct()
#
# names(court_lawyer) <- c("court_case_id", "lawyer_type", "appointment_date", "appointment_status", "appointment_end_date")
#
# court_lawyer <- court_lawyer %>%
#   mutate_at(vars(contains("date")), convertToDate)
#
# ####
#
# # Court Bail Information
# court_bail <- read_excel("Historical Data Submissions/Modoc/Modoc Pretrial Assessment Information.xls", sheet = 7, col_types = "text") %>%
#   bind_rows(read_excel("Historical Data Submissions/Modoc/Modoc Pretrial Assessment Information_2nd quarter_2019_2020.xls", sheet = 7, col_types = "text")) %>%
#   distinct()
#
# # Variable name standardization--See pg. xxx for more details.
# names(court_bail) <- c("court_case_id", "release_type_original", "release_date", "bail_status", "bail_status_date")
#
# # Date Reformatting--See pg. xxx for more details.
# court_bail <- court_bail %>%
#   mutate_at(vars(contains("date")), convertToDate)
#
# # Standardize Factors--See pg. xxx for more details.
# court_bail <- court_bail %>%
#   mutate(release_type = "Bail_Bond")
```

  Court Collapse
```{r}
court_dispo <- court_charge %>%
  group_by(court_case_id) %>%
  # Charges that have not been disposed of are removed
  # filter(stage %in% c("DISPOSITION EVENT")) %>%
  select(-c(plea_date, plea_type_original, plea_type)) %>%
  mutate(hierarchy = if_else(is.na(hierarchy), 1e6, as.numeric(hierarchy))) %>%
  group_by(court_case_id) %>%
  mutate(disposition_date = max(disposition_date)) %>%
  # mutate(max_court_charge_level = court_charge_level[hierarchy == min(hierarchy)][1],
  #        max_court_charge_code = court_charge_code[hierarchy == min(hierarchy)][1],
  #        max_court_charge = court_charge[hierarchy == min(hierarchy)][1],
  #        max_charge_description = master_charge_description[hierarchy == min(hierarchy)][1],
  #        max_hier = min(hierarchy)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, .))) %>%
  mutate_at(vars(contains("flag")), funs("count" = sum(.))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  mutate(join_var = paste(join_var, collapse = " ")) %>%
  filter(hierarchy == min(hierarchy)) %>%
  ungroup() %>%
  distinct(court_case_id, .keep_all = T) 

court_cii <- court_cii %>%
  distinct(court_case_id, .keep_all = T) %>%
  rename_all(tolower)

#Do we need bail release?
# court_bail_release


#FTAs fta_warrant is redundant
court_fta <- court_fta %>%
  group_by(court_case_id) %>%
  arrange(fta_date) %>%
  mutate(fta_flag = max(fta_flag),
         fta_flag_count = sum(fta_flag),
         fta_all_flag = max(fta_all_flag),
         fta__all_flag_count = sum(fta_all_flag)) %>%
  distinct(court_case_id, .keep_all = T) 

court_hearing <- court_hearing %>%
  filter(hearing_type == "Arraignment") %>%
  arrange(hearing_date) %>%
  rename(arraignment_date = hearing_date) %>%
  distinct(court_case_id, .keep_all = T) %>%
  select(court_case_id, arraignment_date)

court_sent <- court_sent %>%
  arrange(sentence_date) %>%
  distinct(court_case_id, .keep_all = T) %>%
  select(court_case_id, sentence_date, sentence_type_original, sentence_type)

# Unused--court_person, court_bail, court_lawyer

court_df <- reduce(list(court_case, court_person, court_cii, court_dispo, court_fta, court_hearing, court_sent), left_join, by = "court_case_id") %>%
  select(-contains(".y")) %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x", "", .))) %>%
  mutate(pretrial_end_date = if_else(disposition_date <= sentence_date|is.na(sentence_date), disposition_date, sentence_date),
         conviction_flag = if_else(!is.na(sentence_date), 1, 0))


save(court_df, file = "G:/CrimJustice/PretrialAssessmentPilot/Agency Collapse CSV Files/Tuolumne Court Collapse.RData")

# Diagnostics
# court_fta %>%
#   count(fta_all_flag)
# 
# court_fta_war %>%
#   count(fta_flag)
# 
# full_join(court_fta %>% filter(fta_all_flag == 1), court_fta_war %>% filter(fta_flag == 1) %>% rename(fta_date = fta_war_date), by = c("court_case_id", "fta_date")) %>%
#   filter(fta_all_flag != fta_flag) %>%
#   add_count(court_case_id) %>%
#   filter(n > 1) %>%
#   arrange(court_case_id, fta_date)
# 
# court_hearing %>%
#   count(hearing_type_original) %>%
#   arrange(desc(n))
#   
# court_charge %>%
#   filter(stage %in% c("DISPOSITION EVENT")) %>%
#   select(-c(disposition_num, charge_id, charge_history_id, offense_id, disposition_hist_id, disposition_id, disposition_type_code, amend_reason_id, amend_reason))
#   # filter(stage %in% c("Sentence Event")) %>%
#   count(dispos) %>%
#   arrange(desc(n))
#   
# court_dispo %>%
#   distinct(court_case_id, disposition_date, .keep_all = T) %>%
#   add_count(court_case_id) %>%
#   filter(n > 1) %>%
#   arrange(desc(n))
# 
# court_charge %>%
#   filter(stage %in% c("PLEA EVENT")) %>%
#   count(disposition_type_original) %>%
#   arrange(desc(n))
#   distinct(court_case_id, disposition_date, .keep_all = T) %>%
#   add_count(court_case_id) %>%
#   filter(n > 1) %>%
#   arrange(desc(n))
#   # select(-c(disposition_num, charge_id, charge_history_id, offense_id, disposition_hist_id, disposition_id, disposition_type_code, amend_reason_id, amend_reason))
#   # filter(stage %in% c("Sentence Event")) %>%
#   count(dispos) %>%
#   arrange(desc(n))
# 
# court_charge %>%
#   # filter(stage %in% c("CASE FILING")) %>%
#   # filter(stage %in% c("SENTENCE EVENT", "DISPOSITION EVENT")) %>%
#   # distinct(court_case_id) 
#   count(stage)
#   filter(court_case_id == "921214")
```


Assessment Data
```{r}
# Tuolumne Assessment Data Import
  ## assess_df contains one row per risk assessment event/risk assessment question/pretrial terms and conditions. The tool questions are widened into columns.

####

# Assessments Data Import
  ## assess_df contains one row per risk assessment event/risk assessment question/pretrial terms and conditions. The questions are widened into columns.
  ## Bring in and standardize data
assess_df <- read_excel("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Tuolumne/P2 Submission-June 30/Pre-Trial Spreadsheet April-June 2020.xlsx", col_types = "text")

# Fixing names to match P2
assess_df2 <- read_excel("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Tuolumne/P3 Submission-Jan 15/6.30.20-12.31.20 Pretrial Spreadsheet.xlsx", col_types = "text") %>%
  mutate("Arrest Date and Time" = paste(convertToDate(`Arrest Date`), `Arrest Time`, sep = "-"),
         "Risk Assessment Date and Time" = paste(convertToDate(`PSA Date`), `PSA Time`, sep = "-"),
         "Arrest Date and Time" = paste(convertToDate(`Arrest Date`), `Arrest Time`, sep = "-"),
         "Termination Date and Time" = paste(convertToDate(`Termination Date`), `Termination Time`, sep = "-"),
         "Risk Assessment Tool" = "psa") %>%
  select(-c(`Arrest Date`, `Arrest Time`, `PSA Date`, `PSA Time`, `Termination Date`, `Termination Time`)) %>%
  rename("Court Date Reminder" = "Court Reminders")

# Binding Rows
assess_df <- bind_rows(assess_df, assess_df2)

rm(assess_df2)

# Variable name standardization--See pg. xxx for more details.
names(assess_df) <- c("name", "local_id", "cii", "fbi", "cdl_id", "dob", "sex_original", "race_original", "zip_code", "arrest_date_time", "book_num",  "court_case_id", "book_type","tool_name", "assessment_date_time", "local_risk_score", "risk_level_original", "release_recommendation_original", "release_authorization_original", "case_status", "OR_release_date", "release_conditions_original", "pretrial_violation_original", "pretrial_violation_date", "next_hearing_date", "court_date_reminder_original", "emp_status", "pretrial_termination_outcome_original", "pretrial_termination_reason_original", "pretrial_termination_date_time", "fta_count", "other_pretrial_service_original", "notes", "psa_fta_risk_score", "psa_nca_risk_score", "psa_nvca_risk_score", "monitor_level_original", "pretrial_eligible_flag", "pretrial_ineligible_reason", "release_decision_original", "post_arraignment_release_decision_original", "condition_no_contact_flag", "next_hearing_time")

# Date Reformatting--See pg. xxx for more details.
  ## Violation dates are duplicated and inconsistent. Fix later. 
assess_df <- assess_df %>%
  select(-next_hearing_time) %>%
  mutate_at(vars(pretrial_violation_date, next_hearing_date), funs(gsub(",.*|-.*", "", .))) %>%
  mutate_at(vars(contains("time")), funs(case_when(grepl("/", .) ~ mdy_hm(.),
                                                   grepl("-", .) ~ ymd_hm(.),
                                                   T ~ convertToDateTime(.)))) %>%
  mutate_at(vars(contains("date"), -contains("time"), -court_date_reminder_original, dob), funs(if_else(grepl("/", .), mdy(.), convertToDate(.)))) %>%
  mutate_at(vars(contains("time")), funs("date" = as_date(.)))

# Fixing Date names
names(assess_df) <- gsub("_time_date", "", names(assess_df))


# Risk Score Standardization--Tool Response values are changed to their numeric point value.
assess_df <- assess_df %>%
  mutate(tool_name = if_else(tool_name != "psa", "tuol_co_pretrial", "psa"),
         release_authorization = "Judge")

# Standardize Factors--See pg. xxx for more details.
assess_df <- assess_df %>%
  mutate(risk_level = case_when(risk_level_original %in% c("High", "Mod-High") ~ "High",
                                risk_level_original %in% c("Mod", "Low-Mod") ~ "Medium",
                                risk_level_original %in% c("Low") ~ "Low",
                                T ~ "Other"),
        
         sex = case_when(sex_original %in% c("M") ~ "Male",
                         sex_original %in% c("F") ~ "Female",
                         T ~ "Other_Unknown"),
         
         #Trimming white space on original race first
         race_original = trimws(race_original),
         race = case_when(race_original %in% c("Black") ~ "Black",
                          race_original %in% c("Hispanic") ~ "Hispanic",
                          race_original %in% c("White") ~ "White",
                          #All Other races/ethnicities collapsed into other
                          T ~ "Other_Unknown"),
         release_recommendation = case_when(
           release_recommendation_original %in% c("Release Prearraignment") ~ "Monitor",
           # release_recommendation_original %in% c("PML 1 - Low", "PML 2 - Medium", "PML 3 - High") ~ "Monitor",
           # release_recommendation_original %in% c("Detain", "Detain/If released, max reporting") ~ "Detain",
           T ~ "Other_Unknown"),
         release_decision = case_when(
           # pretrial_release_type_original %in% c("Release Own Recognizance") ~ "OR",
           release_decision_original %in% c("Granted") |
             release_decision_original %in% c("Granted") & post_arraignment_release_decision_original != "NA"|
             grepl("Released", post_arraignment_release_decision_original) ~ "Monitor",
           release_decision_original %in% c("Denied") & post_arraignment_release_decision_original == "NA" ~ "Detain",
           is.na(release_decision_original) ~ "Other_Unknown",
           T ~ "Ineligible"),
         pretrial_ineligible_reason = case_when(
           grepl("Bail", release_decision_original)  ~ "Bail_Bond",
           grepl("OR|Cite", release_decision_original)  ~ "Cite_Release",
           T ~ "Other_Unknown"),
         pretrial_termination_reason = case_when(
           pretrial_termination_reason_original %in% c("DA Not Filing", 
                                                       "Dismissed", "Sentenced") ~ "Case_Disposed",
           pretrial_termination_reason_original %in% c("Abscond") ~ "Abscond",
           pretrial_termination_reason_original %in% c("Failure to Appear") ~ "FTA",
           pretrial_termination_reason_original %in% c("Abscond") ~ "Abscond",
           pretrial_termination_reason_original %in% c("Felony Arrest", "Misdemeanor Arrest") ~ "New_Crime",
           pretrial_termination_reason_original %in% c("OR Revoked", "Remand") ~ "Violation",
           pretrial_termination_reason_original %in% c("Bond") ~ "Not_Tracked",
           T ~ "Other_Unknown"),
         pretrial_termination_outcome = case_when(
           pretrial_termination_reason %in% c("Case_Disposed") ~ "Successful",
           pretrial_termination_reason %in% c("Abscond", "FTA", "New_Crime", "Violation") ~ "Unsuccessful",
           pretrial_termination_reason %in% c("Not_Tracked") ~ "Not_Tracked",
           T ~ "Other_Unknown"),
         psa_nvca_risk_score = if_else(psa_nvca_risk_score == "Yes", 1, 0)) %>%
  mutate(monitor_level = case_when(monitor_level_original %in% 1:2 ~ "Low",
                                   monitor_level_original == 3 ~ "Medium",
                                   monitor_level_original == 4 ~ "High")) %>%
  
  select(-notes)
         #  pretrial_release_type = case_when(
         #   pretrial_release_type_original %in% c("Release Own Recognizance") ~ "OR",
         #   pretrial_release_type_original %in% c("PML 1 - Low", "PML 2 - Medium", "PML 3 - High", "SORR") ~ "Monitor",
         #   pretrial_release_type_original %in% c("Detain") ~ "Detain",
         #   pretrial_release_type_original %in% c("No Case Filed, Released") ~ "Detain",
         #   T ~ "Other_Unknown"))

# Flag Standardization---See pg. xxx for more details.
  ## Need to follow up with Santa Barbara on the definitions of release recommendation, release type, release authorization, pretrial_violation_flag, and pretrial_termination_outcome. What does pretrial ID uniquely identify? Also need to figure out if we can determine Judge overrides. When do people have mulitple assessments. 
assess_df <- assess_df %>%
  mutate(assess_flag = if_else(is.na(assessment_date), 0, 1),
         rec_release_flag = if_else(release_recommendation %in% c("OR", "Monitor"), 1, 0),
         decision_release_flag = if_else(release_decision %in% c("OR", "Monitor"), 1, 0),
         #This field needs to come from the jail data.
         # pretrial_release_flag = if_else(),
         release_override_flag = if_else(rec_release_flag != decision_release_flag & 
                                            !release_recommendation %in% c("Ineligible", "Other_Unknown") & 
                                            !release_decision %in% c("Ineligible", "Other_Unknown"), 1, 0),
         # rec_em_flag = if_else(grepl("SCRAM", toupper(release_recommendation_original)), 1, 0),
         # rec_phone_flag = if_else(),
         # rec_inperson_flag = if_else(),
         # rec_drug_test_flag = if_else(grepl("TEST", toupper(release_recommendation_original)), 1, 0),
         condition_em_flag = if_else(!is.na(emp_status), 1, 0),
         # condition_drug_test_flag = if_else(grepl("SCRAM|TEST", toupper(release_conditions_original))|
                                                    # grepl("SCRAM|TEST", toupper(pretrial_release_type_original)), 1, 0),
         condition_no_contact_flag = if_else(condition_no_contact_flag == "Stay Away", 1, 0),
         court_date_reminder_flag = if_else(is.na(court_date_reminder_original) | court_date_reminder_original %in% c("No number", "No", "Refused"), 0, 1),
         # Transit service doesn't actually exist here.  
         # transit_service_flag = if_else(grepl("BUS", toupper(other_pretrial_service_original)), 1, 0),
         ## Are all violations violations that result in termation? 
         pretrial_violation_flag = if_else(!is.na(pretrial_violation_original), 1, 0))


####

# Assessment Responses
assess_response <- read_excel("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Tuolumne/P3 Submission-Jan 15/PSAs 6.30.20-12.31.20.xls", col_types = "text", skip = 1)


# Variable name standardization--See pg. xxx for more details.
names(assess_response) <- c("name", "dob", "local_id", "age", "officer", "assessment_date", "book_date", "book_num", "court_case_id", "current_charge", "pretrial_eligible_flag", "detention_eligible_flag", "prob_vio_flag", "psa_fta_risk_score", "psa_nca_risk_score", "psa_nvca_risk_score", "monitor_level", "other_info", "other_info_2", "psa_tool_response_1", "psa_tool_response_2", "psa_tool_response_2a", "psa_tool_response_3", "psa_tool_response_4", "psa_tool_response_5", "psa_tool_response_5a", "psa_tool_response_6", "psa_tool_response_7", "psa_tool_response_8", "psa_tool_response_9")


# Date Reformatting--See pg. xxx for more details.
assess_response <- assess_response %>%
  mutate(assessment_date_time = convertToDateTime(assessment_date),
         assessment_date = as_date(assessment_date_time)) %>%
  # Removing redundant variables
  select(-c(name, officer, dob, age, book_date, book_num, court_case_id, current_charge, pretrial_eligible_flag, detention_eligible_flag, prob_vio_flag, other_info, other_info_2, assessment_date_time, psa_fta_risk_score, psa_nca_risk_score, psa_nvca_risk_score, monitor_level))


# Risk Score Standardization--Tool Response values are changed to their numeric point value.
assess_response <- assess_response %>%
  mutate(psa_tool_response_1 = if_else(psa_tool_response_1 == "23 or Older", 0, 2),
         psa_tool_response_2 = if_else(psa_tool_response_2 == "Yes", 2, 0),
         psa_tool_response_2a = if_else(psa_tool_response_2a == "Yes", 1, 0),
         psa_tool_response_3 = if_else(psa_tool_response_3 == "Yes", 1, 0),
         psa_tool_response_4 = if_else(psa_tool_response_4 == "Yes", 1, 0),
         psa_tool_response_5 = if_else(psa_tool_response_5 == "Yes", 1, 0),
         psa_tool_response_5a = if_else(psa_tool_response_5a == "Yes", 1, 0),
         psa_tool_response_6 = case_when(psa_tool_response_6 == "None" ~ 0,
                                         psa_tool_response_6 == "1 or 2" ~ 1,
                                         psa_tool_response_6 >= "3 or more" ~ 2),
         psa_tool_response_7 = case_when(psa_tool_response_7 == "None" ~ 0,
                                         psa_tool_response_7 == "1" ~ 2,
                                         psa_tool_response_7 >= "2 or more" ~ 4),
         psa_tool_response_8 = if_else(psa_tool_response_8 == "Yes", 1, 0),
         psa_tool_response_9 = if_else(psa_tool_response_9 == "Yes", 2, 0))

```

  Assessment Collapse
```{r}
# Distinct Responses
assess_response <- assess_response %>%
  distinct(local_id, assessment_date, .keep_all = T)


#Removing 1 duplicates on Assess Df
assess_df <- assess_df %>%
  distinct(local_id, assessment_date, court_case_id, book_num, .keep_all = T)

assess_df <- left_join(assess_df, assess_response)

save(assess_df, file = "G:/CrimJustice/PretrialAssessmentPilot/Agency Collapse CSV Files/Tuolumne Assessment Collapse.RData")
```


Join
```{r}
load("G:/CrimJustice/PretrialAssessmentPilot/Agency Collapse CSV Files/Tuolumne Booking Collapse.RData") 

load("G:/CrimJustice/PretrialAssessmentPilot/Agency Collapse CSV Files/Tuolumne Court Collapse.RData") 

load("G:/CrimJustice/PretrialAssessmentPilot/Agency Collapse CSV Files/Tuolumne Assessment Collapse.RData")

#Changing dates to DOJ format
book_df <- book_df %>%
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii),
         row = row_number()) 
  
court_df <- court_df %>%
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) 

# Match rate when matching on court_docket_id from booking to court data ~ 30%
nrow(book_df %>%
  semi_join(court_df, by = c("court_case_id"), na_matches = "never")) / nrow(book_df) * 100

# Match rate when matching on court_docket_id from booking to court data ~ 54%
nrow(court_df %>%
  semi_join(book_df, by = c("court_case_id"), na_matches = "never")) / nrow(court_df) * 100


# Joining jail and court data
join_df1 <- book_df %>%
  inner_join(court_df, by = c("court_case_id"), na_matches = "never") %>%
  select(-contains(".y")) %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x", "", .)))

join_df2 <- book_df %>%
  inner_join(court_df, by = c("book_num"), na_matches = "never") %>%
  mutate(court_case_id = court_case_id.y) %>%
  select(-contains(".y"), - court_case_id.x) %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x", "", .)))

join_df <- bind_rows(join_df1, join_df2) %>%
  distinct()

join_df3 <- book_df %>%
  anti_join(join_df, by = "row")

join_df <- bind_rows(join_df, join_df3) 

rm(join_df1, join_df2, join_df3)


nrow(assess_df %>%
  semi_join(join_df, by = c("book_num"), na_matches = "never")) / nrow(assess_df) * 100

join_df2 <- join_df %>%
  full_join(assess_df, by = c("book_num"), na_matches = "never") %>%
  select(-contains(".y")) %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x", "", .)))
```

Collapse
```{r}
 suppressWarnings(tuolumne_collapse <- join_df2 %>%
  mutate(sentence_date = if_else(sentence_date < book_date, NA_Date_, sentence_date)) %>%
  mutate(across(c(contains("date"), -matches("time|reminder")), ~if_else(.x == -Inf|.x == Inf, NA_Date_, as_date(.x)))) %>%
  mutate(across(contains("flag"), ~if_else(is.na(.x), 0, as.numeric(.x)))) %>%
  mutate(pretrial_end_date = if_else(is.na(pretrial_end_date) & release_type == "Dismissed_Dropped", release_date, pretrial_end_date)) %>%
  mutate(new_arrest_flag = if_else(book_type %in% c("On_View", "Warrant"), 1, 0)) %>%
  mutate(release_type = ordered(release_type, levels = c("Unknown", "Other", "Sentenced", "Time_Served", "Detain_Only", "Dismissed_Dropped", "OR",
                                                         "Bail_Bond", "Cite_Release", "Hold_Release"))) %>%
  group_by(book_num) %>%
  mutate(release_type = max(release_type)) %>%
  mutate(across(contains("sup_vio"), max)) %>%
  filter(sum(new_arrest_flag) == 0 | new_arrest_flag == 1) %>%
  mutate(across(c(contains("flag"), pretrial_end_date, disposition_date), max)) %>%
  mutate(sentence_date = min(sentence_date, na.rm = T)) %>%
  ungroup() %>%
  distinct(book_num, .keep_all = T) %>%
  mutate(across(c(contains("date"), -matches("time|reminder")), ~if_else(.x == -Inf|.x == Inf, NA_Date_, as_date(.x)))) %>%
  mutate(pretrial_end_date = if_else(pretrial_end_date < sentence_date|is.na(sentence_date), pretrial_end_date, sentence_date)))

 

save(tuolumne_collapse, file = "G:/CrimJustice/PretrialAssessmentPilot/Agency Collapse CSV Files/tuolumne Join Collapse.RData")
```

Data Extraction
  DOJ CII/Linking Extraction
```{r}
# Grab Tables with CII
df_list <- sapply(
  ls()[which(sapply(ls(), function(i){
    sum(names(get(i)) %in% "cii")
    }) == 1)],
  function(j){
    df <- get(j)
    df <- df %>%
      select(any_of(c("cii", "cdl_id", "fbi", "last_name", "first_name", "middle_name", "dob", "sex_original", "race_original"))) %>%
       mutate(
         cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) %>%
  distinct()
  
})

# CIIs from assessment tables
doj_assess <- bind_rows(df_list[[1]])

# CIIs from booking tables
doj_book <- bind_rows(df_list[[2]])

# CIIs from court tables
doj_court <- bind_rows(df_list[[3]]) 


#CIIs for DOJ
doj_cii <- bind_rows(doj_book %>% select(cii), doj_court %>% select(cii), doj_assess %>% select(cii)) %>% 
  distinct() %>%
  filter(nchar(cii) == 10)


#Create an excel workbook with all data table. Make sure to include the cii table first. 
write.xlsx(list(doj_cii, doj_book, doj_court, doj_assess), file = "CIIs for DOJ/February 2021/Tuolumne P3 CIIs and Demographics for DOJ.xlsx", sheetName = c("ciis", "booking", "court", "assessment"))

# # Examine missing ciis and duplicates on cii. 
# doj_book %>% #Off by about 3,000-2633 due to missing cii
#   distinct()
# 
# doj_book %>% 
#   distinct(cii)
# 
# doj_book %>% 
#   distinct() %>%
#   add_count(cii) %>%
#   filter(n > 1) %>%
#   arrange(desc(n)) %>% 
#   View()
# 
# doj_court %>% #Off by about 12,000, 13,069/25,642
#   distinct()
# 
# doj_court %>% 
#   distinct(cii)
# 
# doj_court %>% #11,510 due to missing cii
#   distinct() %>%
#   add_count(cii) %>%
#   filter(n > 1) %>%o
#   arrange(desc(n)) %>% 
#   View()
```

  Assessment Tables
```{r}
assess_table <- assess_df %>%
  # Filter for only those actually assesse
  filter(!is.na(assessment_date)) %>%
  # Collapse to each assessment.
  distinct(local_id, assessment_date, .keep_all = T) %>%
  # Create county name.
  mutate(county = "Tuolumne") 

# Save file  
save(assess_table, file = "G:/CrimJustice/PretrialAssessmentPilot/Assessment Output Tables/Tuolumne Assessment Output 02-2021.RData")

# assess_df %>%
#   # Collapse to each assessment
#   distinct(pretrial_id, .keep_all = T) %>%
#   # Filter for only those actually assessed
#   filter(!is.na(assessment_date)) %>%
#   count(risk_level) %>%
#   mutate(total = sum(n),
#          risk_level = round(n/total*100)) %>%
#   spread(risk_level, n)
# 
# rowsu

```

