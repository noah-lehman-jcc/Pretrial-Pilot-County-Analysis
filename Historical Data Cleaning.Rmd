<<<<<<< HEAD
---
title: "County Data Loading"
author: "Noah Lehman"
date: "10/15/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

knitr::opts_knit$set(root.dir = "G:/CrimJustice/PretrialAssessmentPilot")
```

# Libraries
```{r}
library(data.table)
library(openxlsx)
library(readxl)
library(lubridate)
library(tidyverse)
```

# Function Creation
```{r}
# name_keeper <- function(df){
#   attr(df, "names_original") <- names(df)
# }

rm(name_keeper)
```


# Alameda

--Next Step: Create Mapping between variables in codebook. 

Jail Data
```{r}
original_df <- list()

# Jail Bookings
book_df <- lapply(1:4, function(i){
  fread(paste0("Historical Data Submissions/Alameda/BOOK_", i, ".csv"), colClasses = "character")}) %>%
  bind_rows()

original_field <- names(book_df)

names(book_df) <- c("cii", "fbi", "pfn_x", "first_name", "last_name", "dob", "dln", "dln_state", "race_code", "race", "sex_cd", "arrest_date", "arrest_time", "jail_court_id", "booking_seq", "book_type_code", "book_type", "book_date", "book_time", "release_date", "release_time", "release_type_code", "release_type", "case_id", "case_number")

original_df[[1]] <- tibble(table_name = "book_df", original_field = original_field, modified_field = names(book_df))

book_df <- book_df %>%
  mutate(arrest_date_time = mdy_hms(paste(arrest_date, arrest_time), tz = 'America/Los_Angeles'),
         book_date_time = mdy_hms(paste(book_date, book_time), tz = 'America/Los_Angeles'),
         release_date_time = mdy_hms(paste(release_date, release_time), tz = 'America/Los_Angeles')) %>%
  mutate_at(vars(dob, arrest_date, book_date, release_date), mdy) 

# Jail Booking Charges
book_charge <- lapply(1:2, function(i){
  fread(paste0("Historical Data Submissions/Alameda/ARRCHG_", i, ".csv"), colClasses = "character")}) %>%
  bind_rows()

original_field <- names(book_charge)

names(book_charge) <- c("jail_court_id", "charge_num", "entry_code", "charge_code", "charge", "charge_level")

original_df[[2]] <- tibble(table_name = "book_charge", original_field = original_field, modified_field = names(book_charge))
```

Court Data
```{r}
# Court Cases
court_df <- lapply(c("", "_2"), function(i){
  fread(paste0("Historical Data Submissions/Alameda/CASE", i, ".csv"), colClasses = "character")}) %>%
  bind_rows()

original_field <- names(court_df)

names(court_df) <- c("case_id", "case_number", "jail_court_id", "pfn_x", "case_type_code", "case_type", "file_date", "case_status_code", "case_status", "case_status_date", "cii", "fbi", "dln", "dln_state", "dob", "dob_loc", "race_code", "race", "sex_code", "first_name", "last_name")

original_df[[3]] <- tibble(table_name = "court_df", original_field = original_field, modified_field = names(court_df))

court_df <- court_df %>%
  mutate(file_date = ymd(file_date))

# Court FTAs
court_fta <- lapply(c("", "_2"), function(i){
  fread(paste0("Historical Data Submissions/Alameda/FTA", i, ".csv"), colClasses = "character")}) %>%
  bind_rows()

original_field <- names(court_fta)

names(court_fta) <- c("case_id", "fta_date", "fta_id", "fta_type_code", "fta_type")

original_df[[4]] <- tibble(table_name = "court_fta", original_field = original_field, modified_field = names(court_fta))

court_fta <- court_fta %>%
  mutate(fta_date = ymd(fta_date))

# Court FTAs with Warrants
court_fta_war <- lapply(c("", "_2"), function(i){
  fread(paste0("Historical Data Submissions/Alameda/WARR", i, ".csv"), colClasses = "character")}) %>%
  bind_rows()

original_field <- names(court_fta_war)

names(court_fta_war) <- c("case_id", "fta_war_date", "fta_id", "fta_type_code", "fta_type")

original_df[[5]] <- tibble(table_name = "court_fta_war", original_field = original_field, modified_field = names(court_fta_war))

court_fta_war <- court_fta_war %>%
  mutate(fta_war_date = ymd(fta_war_date))

# Court Hearings
court_hearing <- lapply(1:8, function(i){
  fread(paste0("Historical Data Submissions/Alameda/HEA_", i, ".csv"), colClasses = "character")}) %>%
  bind_rows()

original_field <- names(court_hearing)

names(court_hearing) <- c("case_id", "case_number", "event_num", "event_id", "hearing_type_code", "hearing_type", "hearing_date", "hearing_time")

original_df[[6]] <- tibble(table_name = "court_hearing", original_field = original_field, modified_field = names(court_hearing))

court_hearing <- court_hearing %>%
  mutate(hearing_date_time = mdy_hms(paste(hearing_date, hearing_time), tz = "America/Los_Angeles"),
         hearing_date = mdy(hearing_date)) 
  # select(-hearing_time)

# Court Filing Charges
court_charge <- lapply(1:8, function(i){
  fread(paste0("Historical Data Submissions/Alameda/CHG_", i, ".csv"), colClasses = "character")}) %>%
  bind_rows()

original_field <- names(court_charge)

names(court_charge) <- c("case_id", "case_number", "event_num", "chare_id", "charge_history_id", "charge_number", "allegation", "qualifier", "offense_id", "charge", "charge_level", "event_date", "event_hist_id", "stage", "event_id", "event_type_code", "event_type", "amend_reason_id", "amend_reason")

original_df[[7]] <- tibble(table_name = "court_charge", original_field = original_field, modified_field = names(court_charge))

court_charge <- court_charge %>%
  mutate(event_date = ymd(event_date))

# Court Sentences to Confinement 
court_sent <- lapply(c("", "_2"), function(i){
  fread(paste0("Historical Data Submissions/Alameda/JAIL", i, ".csv"), colClasses = "character")}) %>%
  bind_rows()

original_field <- names(court_sent)

names(court_sent) <- c("case_id", "case_number", "event_num", "event_id", "sentence_date", "amend_reason_code", "amend_reason", "sentence_id", "component_instance_id", "start_date", "confinement_type_code", "confinement_type", "facilty_id", "facility", "term_type_code", "term_type", "term_years", "term_months", "term_days", "term_to_life", "life_flag", "death_flag")

original_df[[8]] <- tibble(table_name = "court_sent", original_field = original_field, modified_field = names(court_sent))

court_sent <- court_sent %>%
  mutate_at(vars(sentence_date, start_date), ymd)

# Court Sentences to Supervision
court_sup <- lapply(c("", "_2"), function(i){
  fread(paste0("Historical Data Submissions/Alameda/SUP", i, ".csv"), colClasses = "character")}) %>%
  bind_rows()

original_field <- names(court_sup)

names(court_sup) <- c("case_id", "case_number", "event_num", "event_id", "sentence_date", "amend_reason_code", "amend_reason", "sentence_id", "component_instance_id", "probation_type_code", "probation_type", "start_date", "end_date", "term_years", "term_months", "term_days", "latest_status_code", "latest_status")

original_df[[9]] <- tibble(table_name = "court_sup", original_field = original_field, modified_field = names(court_sup))

court_sup <- court_sup %>%
  mutate_at(vars(sentence_date, start_date, end_date), ymd)
```

Code Book
```{r eval=FALSE, include=FALSE}
rm(original_field)

original_df <- bind_rows(original_df)

Alameda_df <- lapply(ls()[!grepl("original", ls())], function(i){
  df <- get(i)
  
  if(sum(grepl("date", names(df))) > 0){
  df2 <- df %>%
  select(contains("date"), -contains("time")) %>%
  gather("modified_field", "value") %>%
  group_by(modified_field) %>%
  summarise_all(funs(min = as.character(min(., na.rm = T)), mean = as.character(mean(., na.rm = T)), max = as.character(max(., na.rm = T))))
  }else{
    df2 <- tibble(modified_field = NA_character_, min = NA_character_, mean = NA_character_, max = NA_character_)
  }
  
  df <- df %>%
    mutate_if(~length(unique(.)) > 50|is.Date(.)|is.POSIXct(.), ~(. = "not_factor")) %>%    
    mutate_all(~if_else(is.na(.), "na_missing", as.character(.))) %>%
    gather(modified_field, factor_value) %>%
    count(modified_field, factor_value) %>%
    mutate(table_name = i, county = "Alameda") %>%
    mutate(factor_flag = if_else(factor_value == "not_factor", 0, 1)) %>%
    group_by(table_name, modified_field) %>%
    mutate(table_count = sum(n)) %>%
    ungroup() %>%
    rename("factor_count" = "n") %>%
    mutate(factor_count = if_else(factor_value == "not_factor", NA_integer_, factor_count),
           factor_percent = round(factor_count/table_count*100, 1)) %>%
    arrange(desc(factor_flag), modified_field, desc(factor_count))
  
  df <- left_join(df, df2, by = "modified_field")
    }) %>% 
  bind_rows() %>%
  left_join(original_df) %>%
   select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_count,
           factor_percent, table_count, min, mean, max) 

write.xlsx(Alameda_df, file = "Code Books/Alameda Code Book.xlsx")
```

Join
```{r eval=FALSE, include=FALSE}
#Alameda has an integrated criminal justice system. Information is joined across agencies on the jail_court_ID. It is contained in the book_df, court_df, and book_charge tables. 

#Jail Court ID is duplicated when split between cases
book_df <- book_df %>% distinct(jail_court_id, .keep_all = T)

#Jail Court ID is duplicated when split between cases
court_df <- court_df %>% distinct(jail_court_id, .keep_all = T)

book_no_court <- anti_join(book_df, court_df, by = c("jail_court_id"))
nrow(book_df)
nrow(book_no_court)
nrow(book_no_court)/nrow(book_df)

court_no_book <- anti_join(court_df, book_df, by = c("jail_court_id"))
nrow(court_df)
nrow(court_no_book)
nrow(court_no_book)/nrow(court_df)
```

# Calaveras

Jail Data
```{r}
book_df <- read_excel("Historical Data Submissions/Calaveras/JailData.xlsx")

names(book_df) <- c("name", "cii", "fbi", "alpha_num", "dln", "race", "sex", "dob", "arrest_date", "book_num", "book_date", "book_type", "case_number", "charge", "charge_level", "bail_amt", "disposition_type", "disposition_date", "release_date", "release_type")

book_df <- book_df %>%
  mutate(arrest_date_time = mdy_hm(arrest_date),
         book_date_time = mdy_hm(book_date),
         arrest_date = as_date(arrest_date_time),
         book_date =as_date(book_date_time),
         dob = as_date(dob))
```

Probation Data
```{r}
prob_df <- read_excel("Historical Data Submissions/Calaveras/ProbationData.xlsx", col_types = "text")

names(prob_df) <- c("cii", "fbi", "dln", "local_id", "name", "dob", "sex", "race")

prob_df <- prob_df %>%
  mutate(dob = convertToDate(dob))
```

# Kings

Jail Data (Maybe all data?, no FTA information)
```{r}
original_df <- list()

book_df <- lapply(2015:2019, function(i){
  fread(paste0("Historical Data Submissions/Kings/Pretrial Pilot Program-", i, ".csv"))
}) %>% bind_rows()


#bunch of demo info that needs fixing
names(book_df) <- c("title", "demo_info", "book_num", "book_date", "book_type", "release_date", "release_type", "case_id", "charge_ref", "counts_ref", "charge_level_ref", "disposition_type_ref", "disposition_date_ref", "charge", "counts", "charge_level", "disposition_type", "disposition_date", "total")

book_df <- book_df %>%
  separate(demo_info, paste("x", 1:20, sep = "_"), sep = "\\\r\\\n") %>%
  separate(x_20, paste("y", 1:5, sep = "_"), sep = ":") %>%
  rename(cii = y_2, fbi = y_3, local_id = y_4, employed = y_5, dob = x_8, gender = x_10, race = x_12, dln = x_15,
         dln_state = x_17) %>%
  unite(name, c(x_3, x_5, x_1), sep = " ") %>%
  select(-c(x_2, x_4, x_6, x_7, x_9, x_11, x_13, x_14, x_16, x_18, x_19, y_1)) %>%
  mutate(cii = gsub(" FBI", "", cii),
         fbi = gsub(" Local ID", "", fbi),
         local_id = gsub(" Employer", "", local_id),
         employed = if_else(employed != " ", 1, 0),
         total = parse_number(total)) %>%
  mutate_at(vars(book_num:case_id), funs(gsub(".*: ","",.))) %>%
  select(-contains("ref"), -title) %>%
  mutate(dob = mdy(dob),
         book_date_time = mdy_hm(book_date),
         release_date_time = mdy_hm(release_date),
         book_date = as_date(book_date_time),
         release_date = as_date(release_date_time),
         disposition_date = as_date(mdy_hms(disposition_date)))

original_field <- names(book_df)

original_df[[1]] <- tibble(table_name = "book_df", original_field = original_field, modified_field = names(book_df))
```

```{r}
rm(original_field)

original_df <- bind_rows(original_df)

Kings_df <- lapply(ls()[!grepl("original", ls())], function(i){
  df <- get(i)
  
  if(sum(grepl("date", names(df))) > 0){
  df2 <- df %>%
  select(contains("date"), -contains("time")) %>%
  gather("modified_field", "value") %>%
  group_by(modified_field) %>%
  summarise_all(funs(min = as.character(min(., na.rm = T)), mean = as.character(mean(., na.rm = T)), max = as.character(max(., na.rm = T))))
  }else{
    df2 <- tibble(modified_field = NA_character_, min = NA_character_, mean = NA_character_, max = NA_character_)
  }
  
  df <- df %>%
    mutate_if(~length(unique(.)) > 50|is.Date(.)|is.POSIXct(.), ~(. = "not_factor")) %>%    
    mutate_all(~if_else(is.na(.), "na_missing", as.character(.))) %>%
    gather(modified_field, factor_value) %>%
    count(modified_field, factor_value) %>%
    mutate(table_name = i, county = "Kings") %>%
    mutate(factor_flag = if_else(factor_value == "not_factor", 0, 1)) %>%
    group_by(table_name, modified_field) %>%
    mutate(table_count = sum(n)) %>%
    ungroup() %>%
    rename("factor_count" = "n") %>%
    mutate(factor_count = if_else(factor_value == "not_factor", NA_integer_, factor_count),
           factor_percent = round(factor_count/table_count*100, 1)) %>%
    arrange(desc(factor_flag), modified_field, desc(factor_count))
  
  df <- left_join(df, df2, by = "modified_field")
    }) %>% 
  bind_rows() %>%
  left_join(original_df) %>%
   select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_count,
           factor_percent, table_count, min, mean, max) 

write.xlsx(Kings_df, file = "Code Books/Kings Code Book.xlsx")
```

# Los Angeles

Jail Data
```{r}
original_df <- list()

# Jail Bookings--Historical and Q1
book_df <- lapply(2015:2019, function(i){
  read_xlsx(paste0("Historical Data Submissions/Los Angeles/",i, "_data_fields_added.xlsx"))}) %>%
  bind_rows()

book_df_q1 <- read_xlsx("Historical Data Submissions/Los Angeles/LACounty_July_Dec2019.xlsx")
names(book_df_q1) <- names(book_df)

book_df <- bind_rows(book_df, book_df_q1) %>% distinct()
rm(book_df_q1)

original_field <- names(book_df)

names(book_df) <- c("last_name", "first_name", "dob", "race", "gender", "dln", "cii", "arrest_date", "book_date", "book_num", "case_num", "charge", "charge_level", "release_date", "release_type", "bail")

original_df[[1]] <- tibble(table_name = "book_df", original_field = original_field, modified_field = names(book_df))
```

Court Data
```{r}
# Court Information
court_df <- fread("Historical Data Submissions/Los Angeles/JCC-historical-court-cases2.csv",
                  sep = "|")

original_field <- names(court_df)

names(court_df) <- c("row_num", "case_id", "case_num", "person_id", "cii", "first_name", "last_name", "dob", "gender", "race", "file_date", "charge_id", "count", "code_type", "charge", "charge_level", "disposition_id", "disposition_type", "disposition_code", "disposition_date", "sentence_time", "fine_amt", "sentence_time_code", "sentence_location", "fine_or_jail_code", "probation_code", "probation_length", "probation_length_code", "probation_andor_code", "book_num")

original_df[[2]] <- tibble(table_name = "court_df", original_field = original_field, modified_field = names(court_df))

court_df <- court_df %>%
  mutate_at(vars(contains("date"), dob), as_date)


# Court FTA Data
court_fta <- fread("Historical Data Submissions/Los Angeles/JCC-historical-bench-warrants2.csv", 
                   sep = "|")

original_field <- names(court_fta)

names(court_fta) <- c("row_num", "case_id", "case_num", "warrant_id", "warrant_issue_date", "warrant_disposition_date")

original_df[[3]] <- tibble(table_name = "court_fta", original_field = original_field, modified_field = names(court_fta))

court_fta <- court_fta %>%
  mutate_at(vars(contains("date")), as_date)
```

Probation (assessment) Data
```{r}
#OR Risk Assessment--Arraignment Favorable, Ineligible, and Unfavorable
assess_OR <- read_excel("Historical Data Submissions/Los Angeles/Los Angeles County JCC Data - Arraignment Favorable Recommendations (2015-01 to 2019-09).xlsx")

assess_OR2 <- read_excel("Historical Data Submissions/Los Angeles/Los Angeles County JCC Data - Arraignment Ineligible Applications (2015-01 to 2019-09).xlsx") %>% mutate(`Score(s)` = as.numeric(`Score(s)`), Termination_Date = as_datetime(Termination_Date))

assess_OR3 <- read_excel("Historical Data Submissions/Los Angeles/Los Angeles County JCC Data - Arraignment Unfavorable Recommendations (2015-01 to 2019-09).xlsx") %>% mutate(Termination_Date = as_datetime(Termination_Date))

assess_OR <- bind_rows(assess_OR, assess_OR2, assess_OR3)

rm(assess_OR2, assess_OR3)

original_field <- names(assess_OR)

names(assess_OR) <- c("application_id", "application_type", "tool_name", "assessment_date_time", "zip_code", "tool_response1", "tool_response2", "tool_response3", "tool_response4", "tool_response5", "tool_response6", "tool_response7", "tool_response8", "tool_response9", "tool_response10", "tool_response11", "tool_response12", "tool_response13", "tool_response14", "score", "recommendation", "release_date", "release_authorization", "release_type", "pretrial_conditions", "pretrial_violation", "pretrial_violation_date", "court_date_reminder", "other_pretrial_service", "termination_outcome", "termination_date", "cii", "fbi", "dln", "local_id", "name", "dob", "gender", "race", "tool_not_administered")

original_df[[4]] <- tibble(table_name = "assess_OR", original_field = original_field, modified_field = names(assess_OR))

assess_OR <- assess_OR %>%
  mutate(assessment_date = as_date(assessment_date_time),
         release_date = convertToDate(as.numeric(release_date))) %>%
  mutate_at(vars(termination_date, dob, pretrial_violation_date), as_date) %>%
  separate(name, c("last_name", "first_name"))


#BD Point Scale--Bail Increase, Bail Increae Denied, Not Qualified, Released OR, Bail Reduction Granted, and Bail Reduction Denied
assess_BD <- read_excel("Historical Data Submissions/Los Angeles/Los Angeles County JCC Data - Pre-arraignment Bail Increase and Ineligible Subjects (2015-01 to 2019-09).xlsx", 
                      sheet = 1) %>%  mutate(`Score(s)` = as.numeric(`Score(s)`))

assess_BD2 <- read_excel("Historical Data Submissions/Los Angeles/Los Angeles County JCC Data - Pre-arraignment Bail Increase and Ineligible Subjects (2015-01 to 2019-09).xlsx", 
                      sheet = 2) %>% mutate(Assessment_Date_Time = convertToDateTime(Assessment_Date_Time))

assess_BD3 <- read_excel("Historical Data Submissions/Los Angeles/Los Angeles County JCC Data - Pre-arraignment Bail Increase and Ineligible Subjects (2015-01 to 2019-09).xlsx", 
                      sheet = 3) %>% mutate(`Score(s)` = as.numeric(`Score(s)`))

assess_BD4 <- read_excel("Historical Data Submissions/Los Angeles/Los Angeles County JCC Data - Pre-arraignment OR Release and Bail Reductions Granted (2015-01 to 2019-09).xlsx", 
                      sheet = 1)

assess_BD5 <- read_excel("Historical Data Submissions/Los Angeles/Los Angeles County JCC Data - Pre-arraignment OR Release and Bail Reductions Granted (2015-01 to 2019-09).xlsx", 
                      sheet = 2)

assess_BD6 <- read_excel("Historical Data Submissions/Los Angeles/Los Angeles County JCC Data - Pre-arraignment OR Release Denied (2015-01 to 2019-09).xlsx")

assess_BD <- bind_rows(assess_BD2, assess_BD3, assess_BD4, assess_BD5, assess_BD6, assess_BD)

rm(assess_BD2, assess_BD3, assess_BD4, assess_BD5, assess_BD6)

original_field <- names(assess_BD)

names(assess_BD) <- c("application_id", "application_type", "tool_name", "assessment_date_time", "zip_code", "tool_response1", "tool_response2", "tool_response3", "tool_response4", "tool_response5", "tool_response6", "tool_response7", "tool_response8", "tool_response9", "tool_response10", "tool_response11", "tool_response12", "tool_response13", "tool_response14", "tool_response15", "score", "recommendation", "release_date", "release_authorization", "release_type", "pretrial_conditions", "pretrial_violation", "pretrial_violation_date", "court_date_reminder", "other_pretrial_service", "termination_outcome", "termination_date", "cii", "fbi", "dln", "local_id", "name", "dob", "gender", "race", "tool_not_administered")

original_df[[5]] <- tibble(table_name = "assess_BD", original_field = original_field, modified_field = names(assess_BD))

assess_BD <- assess_BD %>%
  mutate(assessment_date = as_date(assessment_date_time),
         release_date = convertToDate(as.numeric(release_date)),
         termination_date = mdy(paste(termination_date, year(assessment_date), sep = "/")),
         dob = as_date(dob),
         pretrial_violation_date = convertToDate(pretrial_violation_date)) %>%
  separate(name, c("last_name", "first_name"))

# Probation EM Responses
assess_EM_response <- read_excel("Historical Data Submissions/Los Angeles/California JCC Historical EM Records (Revised 2019-11-25).xlsx", sheet = 2)

original_field <- names(assess_EM_response)

names(assess_EM_response) <- c("key", "tool_question", "tool_response", "score")

original_df[[6]] <- tibble(table_name = "assess_EM_response", original_field = original_field, modified_field = names(assess_EM_response))

#Probation EM Total 
assess_EM <- read_excel("Historical Data Submissions/Los Angeles/California JCC Historical EM Records (Revised 2019-11-25).xlsx", 
                      sheet = 1)

original_field <- names(assess_EM)

names(assess_EM) <- c("key", "application_id", "cii", "fbi", "local_id", "dln", "first_name", "last_name", "dob", "sex", "race", "application_id_redundant", "tool_name", "assessment_date_time", "zip_code", "tool_response", "score","score_collapse", "recommendation", "release_authorization", "release_type", "release_date_time","pretrial_conditions","pretrial_violation", "pretrial_violation_date", "court_date_reminder", "other_pretrial_service", "termination_outcome", "termination_date")

original_df[[7]] <- tibble(table_name = "assess_EM", original_field = original_field, modified_field = names(assess_EM))

assess_EM <- assess_EM %>%
  select(-application_id_redundant) %>%
  mutate(assessment_date = as_date(assessment_date_time),
         release_date = as_date(release_date_time)) %>%
  mutate_at(vars(dob, pretrial_violation_date, termination_date), as_date)
```

Code Book
```{r eval=FALSE, include=FALSE}
rm(original_field)

original_df <- bind_rows(original_df)

Los_Angeles_df <- lapply(ls()[!grepl("original", ls())], function(i){
  df <- get(i)
  
  if(sum(grepl("date", names(df))) > 0){
  df2 <- df %>%
  select(contains("date"), -contains("time"), -contains("reminder")) %>%
  gather("modified_field", "value") %>%
  group_by(modified_field) %>%
  summarise_all(funs(min = as.character(min(., na.rm = T)), mean = as.character(mean(., na.rm = T)), 
                     max = as.character(max(., na.rm = T))))
  }else{
    df2 <- tibble(modified_field = NA_character_, min = NA_character_, mean = NA_character_, max = NA_character_)
  }
  
  df <- df %>%
    mutate_if(~length(unique(.)) > 50|is.Date(.)|is.POSIXct(.), ~(. = "not_factor")) %>%    
    mutate_all(~if_else(is.na(.), "na_missing", as.character(.))) %>%
    gather(modified_field, factor_value) %>%
    count(modified_field, factor_value) %>%
    mutate(table_name = i, county = "Los Angeles") %>%
    mutate(factor_flag = if_else(factor_value == "not_factor", 0, 1)) %>%
    group_by(table_name, modified_field) %>%
    mutate(table_count = sum(n)) %>%
    ungroup() %>%
    rename("factor_count" = "n") %>%
    mutate(factor_count = if_else(factor_value == "not_factor", NA_integer_, factor_count),
           factor_percent = round(factor_count/table_count*100, 1)) %>%
    arrange(desc(factor_flag), modified_field, desc(factor_count))
  
  df <- left_join(df, df2, by = "modified_field")
    }) %>% 
  bind_rows() %>%
  left_join(original_df) %>%
   select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_count,
           factor_percent, table_count, min, mean, max) 

write.xlsx(Los_Angeles_df, file = "Code Books/Los Angeles Code Book.xlsx")
```


Join
```{r eval=FALSE, include=FALSE}
#Alameda has an integrated criminal justice system. Information is joined across agencies on the jail_court_ID. It is contained in the book_df, court_df, and book_charge tables. 

#Jail Court ID is duplicated when split between cases
book_df <- book_df %>% distinct(jail_court_id, .keep_all = T)

#Jail Court ID is duplicated when split between cases
court_df <- court_df %>% distinct(jail_court_id, .keep_all = T)

book_no_court <- anti_join(book_df, court_df, by = c("jail_court_id"))
nrow(book_df)
nrow(book_no_court)
nrow(book_no_court)/nrow(book_df)

court_no_book <- anti_join(court_df, book_df, by = c("jail_court_id"))
nrow(court_df)
nrow(court_no_book)
nrow(court_no_book)/nrow(court_df)
```

# Modoc

Jail Data
```{r}
#Booking data
book_df <- fread("Historical Data Submissions/Modoc/Modoc Jail Pretrial  January 1 2013-November 30 2019.csv")

#The first 7 observations are test inputs
book_df <- book_df[8:length(book_df),]
```

Court Data 
```{r}
court_df <- read_excel("Historical Data Submissions/Modoc/Modoc Pretrial Assessment Information.xls", sheet = 1)

names(court_df) <- c("case_id", "name", "disposition_type", "disposition_date", "filing_date", "case_type")

court_charge <- read_excel("Historical Data Submissions/Modoc/Modoc Pretrial Assessment Information.xls", sheet = 2)

names(court_charge) <- c("case_id", "counts", "charge", "charge_level", "charge_description", "disposition_type", "disposition_date", "plea_type", "plea_date")

court_sent <- read_excel("Historical Data Submissions/Modoc/Modoc Pretrial Assessment Information.xls", sheet = 3)

names(court_sent) <- c("case_id", "sentence_date", "sentence_type", "term", "term_suspended", "sentence_location", "sentence_status", "count", "charge")

court_hearing <- read_excel("Historical Data Submissions/Modoc/Modoc Pretrial Assessment Information.xls", sheet = 4)

names(court_hearing) <- c("case_id", "hearing_type", "hearing_date", "hearing_time", "hearing_result")

court_lawyer <- read_excel("Historical Data Submissions/Modoc/Modoc Pretrial Assessment Information.xls", sheet = 5)

names(court_lawyer) <- c("case_id", "lawyer_type", "appointment_date", "appointment_status", "appointment_end_date")

court_person <- read_excel("Historical Data Submissions/Modoc/Modoc Pretrial Assessment Information.xls", sheet = 6)

names(court_person) <- c("first_name", "last_name", "dob", "sex", "race", "cii", "fbi", "arrest_num", "book_num")

court_bail <- read_excel("Historical Data Submissions/Modoc/Modoc Pretrial Assessment Information.xls", sheet = 7)

names(court_bail) <- c("case_id", "release_type", "release_date", "bail_status", "bail_status_date")

court_fta <- read_excel("Historical Data Submissions/Modoc/Modoc Pretrial Assessment Information.xls", sheet = 8)

names(court_fta) <- c("case_id", "fta_date", "fta")

court_fta_war <- read_excel("Historical Data Submissions/Modoc/Modoc Pretrial Assessment Information.xls", sheet = 9)

names(court_fta_war) <- c("case_id", "fta_date", "fta")
```

# Napa

Jail Data
```{r}
original_df <- list()

#Jail Demographic and Personal Identification
person_df <- read_excel("Historical Data Submissions/Napa/Historical_1.xlsx", sheet = 1)

original_field <- names(person_df)

names(person_df) <- c("cii", "fbi", "local_id", "dln", "dln_state", "name", "dob", "sex", "race")

original_df[[1]] <- tibble(table_name = "person_df", original_field = original_field, modified_field = names(person_df))

#Jail Booking Events 
book_df <- read_excel("Historical Data Submissions/Napa/Historical_1.xlsx", sheet = 2, col_types = "text")

original_field <- names(book_df)

names(book_df) <- c("book_num", "arrest_date", "case_id", "local_id", "book_type", "book_date", "release_date", "release_type")

original_df[[2]] <- tibble(table_name = "book_df", original_field = original_field, modified_field = names(book_df))

book_df <- book_df %>%
  mutate(release_date = convertToDate(release_date)) %>%
  mutate_at(vars(arrest_date, book_date),  funs("time" = convertToDateTime(.))) %>%
  mutate_at(vars(arrest_date, book_date), convertToDate)
```

DA Data (contains filing dates)
```{r}
#Filing Dates
da_df <- read_excel("Historical Data Submissions/Napa/Historical_1.xlsx", sheet = 3)

original_field <- names(da_df)

names(da_df) <- c("case_id", "local_id", "file_date", "case_status", "case_status_date")

original_df[[3]] <- tibble(table_name = "da_df", original_field = original_field, modified_field = names(da_df))

da_df <- da_df %>%
  mutate(file_date_time = file_date,
         case_status_date_time = case_status_date) %>%
  mutate_at(vars(file_date, case_status_date), as_date)

#Da Charges
da_charge <- read_excel("Historical Data Submissions/Napa/Historical_1.xlsx", sheet = 4)

original_field <- names(da_charge)

names(da_charge) <- c("case_id", "local_id", "charge", "charge_description", "charge_level", "plea_type")

original_df[[4]] <- tibble(table_name = "da_charge", original_field = original_field, modified_field = names(da_charge))
```

Court Data
```{r}
#Court Data on FTAs
court_df <- read_excel("Historical Data Submissions/Napa/Historical_1.xlsx", sheet = 5)

original_field <- names(court_df)

names(court_df) <- c("case_id", "local_id", "fta", "fta_warrant")

original_df[[5]] <- tibble(table_name = "court_df", original_field = original_field, modified_field = names(court_df))

#Court Charges
court_charge <- read_excel("Historical Data Submissions/Napa/Historical_1.xlsx", sheet = 6)

original_field <- names(court_charge)

names(court_charge) <- c("case_id", "local_id", "charge", "charge_description", "dispostion_type", "disposition_date", "sentence_type", "sentence_date")

original_df[[6]] <- tibble(table_name = "court_charge", original_field = original_field, modified_field = names(court_charge))

court_charge <- court_charge %>%
  mutate_at(vars(contains("date")), convertToDate)

#Court FTA Warrants
court_fta_war <- read_excel("Historical Data Submissions/Napa/Historical_1.xlsx", sheet = 7)

original_field <- names(court_fta_war)

names(court_fta_war) <- c("case_id", "local_id", "fta_war_date")

original_df[[7]] <- tibble(table_name = "court_fta_war", original_field = original_field, modified_field = names(court_fta_war))

#Court FTAs
court_fta <- read_excel("Historical Data Submissions/Napa/Historical_1.xlsx", sheet = 8)

original_field <- names(court_fta)

names(court_fta) <- c("case_id", "local_id", "fta_date")

original_df[[8]] <- tibble(table_name = "court_fta", original_field = original_field, modified_field = names(court_fta))
```

Assessment Data
```{r}
prob_df <- read_excel("Historical Data Submissions/Napa/Assessment_Historical.xlsx")

original_field <- names(prob_df)

names(prob_df) <- c("tool_name", "local_id", "zip_code", "assessment_date", "item_label", "assessment_item", "assessment_response", "risk_score", "risk_level")

original_df[[9]] <- tibble(table_name = "prob_df", original_field = original_field, modified_field = names(prob_df))
```

Code Book
```{r eval=FALSE, include=FALSE}
rm(original_field)

original_df <- bind_rows(original_df)

Napa_df <- lapply(ls()[!grepl("original", ls())], function(i){
  df <- get(i)
  
  if(sum(grepl("date", names(df))) > 0){
  df2 <- df %>%
  select(contains("date"), -contains("time")) %>%
  gather("modified_field", "value") %>%
  group_by(modified_field) %>%
  summarise_all(funs(min = as.character(min(., na.rm = T)), mean = as.character(mean(., na.rm = T)), max = as.character(max(., na.rm = T))))
  }else{
    df2 <- tibble(modified_field = NA_character_, min = NA_character_, mean = NA_character_, max = NA_character_)
  }
  
  df <- df %>%
    mutate_if(~length(unique(.)) > 50|is.Date(.)|is.POSIXct(.), ~(. = "not_factor")) %>%    
    mutate_all(~if_else(is.na(.), "na_missing", as.character(.))) %>%
    gather(modified_field, factor_value) %>%
    count(modified_field, factor_value) %>%
    mutate(table_name = i, county = "Napa") %>%
    mutate(factor_flag = if_else(factor_value == "not_factor", 0, 1)) %>%
    group_by(table_name, modified_field) %>%
    mutate(table_count = sum(n)) %>%
    ungroup() %>%
    rename("factor_count" = "n") %>%
    mutate(factor_count = if_else(factor_value == "not_factor", NA_integer_, factor_count),
           factor_percent = round(factor_count/table_count*100, 1)) %>%
    arrange(desc(factor_flag), modified_field, desc(factor_count))
  
  df <- left_join(df, df2, by = "modified_field")
    }) %>% 
  bind_rows() %>%
  left_join(original_df) %>%
   select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_count,
           factor_percent, table_count, min, mean, max) 

write.xlsx(Napa_df, file = "Code Books/Napa Code Book.xlsx")
```

# Nevada-Sierra

Jail Data
```{r}
book_df <- read_excel("Historical Data Submissions/Nevada/SO Pretrial Submitted Data.xlsx")

names(book_df) <- c("cii", "name", "dob", "arrest_date", "book_num", "book_date", "book_type", "case_id", "charge", "charge_level", "release_date", "fbi", "dln", "sex", "race", "bail_amt", "employment_status", "county")
```

Probation Data (Assessment Data, needs fixing)
```{r}
prob_df <- lapply(c("2016.", "2017.", "2018. "), function(i){
  lapply(getSheetNames(paste0("Historical Data Submissions/Nevada/PRETRIAL STATS ", i, "Nevada.xlsx")), function(j){
    read_excel(paste0("Historical Data Submissions/Nevada/PRETRIAL STATS ", i, "Nevada.xlsx"), 
               col_names = F, sheet = j, col_types = "text")
}) %>% bind_rows() 
}) %>% bind_rows()

names(prob_df) <- c("name", "charge", "charge_level", "risk_score", "risk_level", "sex", "age", "book_date", "release_date", "po", "ref", "or_flag", "or_condition_flag", "gps_flag", "alcohol_flag", "denied_flag", "other_flag", "termination_type", "termination_date", "termination_reason", "pretrial_recommendation", "pretrial_decision")

prob_df <- prob_df %>%
  filter(grepl("^[0-9]", charge))
```

# Sacramento
- Everything is Join

Jail Data
```{r}
original_df <- list()

# Jail Bookings
book_df <- fread("Historical Data Submissions/Sacramento/SacBookingDetail.csv") %>%
  bind_rows(fread("Historical Data Submissions/Sacramento/SacBookingDetail10012019.csv"))

original_field <- names(book_df)

names(book_df) <- c("jail_court_id", "book_date_wrong", "release_date_wrong", "registry_num", "registry_sub_num", "book_type_code", "book_type", "charge_level", "charge", "charge_description", "release_type_code", "release_type", "release_comment", "charge_date", "charge_release_date", "court_combined_id", "court_id", "case_id", "release_line")

original_df[[1]] <- tibble(table_name = "book_df", original_field = original_field, modified_field = names(book_df))

book_df <- book_df %>%
  select(-matches("date"))

#Booking Dates
book_date <- fread("Historical Data Submissions/Sacramento/SacBookingMain.csv") %>%
  bind_rows(fread("Historical Data Submissions/Sacramento/SacBookingMain10012019.csv"))

original_field <- names(book_date)

names(book_date) <- c("jail_court_id", "registry_num", "book_date", "release_date", "hours_detained", "days_detained")

original_df[[2]] <- tibble(table_name = "book_date", original_field = original_field, modified_field = names(book_date))

book_date <- book_date %>%
  mutate_at(vars(book_date, release_date), funs(time = as_datetime(., tz = 'America/Los_Angeles'))) %>%
  mutate(book_date = as_date(book_date_time),
         release_date = as_date(release_date_time))

#Jail Bail Amounts
book_bail <- fread("Historical Data Submissions/Sacramento/SacBail.csv") %>%
  bind_rows(fread("Historical Data Submissions/Sacramento/SacBail10012019.csv"))

original_field <- names(book_bail)

names(book_bail) <- c("jail_court_id", "registry_num", "registry_sub_num", "book_type_code", "bail_amt")

original_df[[3]] <- tibble(table_name = "book_bail", original_field = original_field, modified_field = names(book_bail))
```

Court Data
```{r}
#High level casees
court_df <- fread("Historical Data Submissions/Sacramento/SacCases.csv") %>%
  bind_rows(fread("Historical Data Submissions/Sacramento/SacCases10102019.csv"))

original_field <- names(court_df)

names(court_df) <- c("jail_court_id", "court_combined_id", "court_id", "case_id", "file_date", "case_status", "status_description", "status_date")

original_df[[4]] <- tibble(table_name = "court_df", original_field = original_field, modified_field = names(court_df))

court_df <- court_df %>%
  mutate(file_date = as_date(file_date))

#Court Hearing Data
court_hearing <- fread("Historical Data Submissions/Sacramento/SacAppear.csv") %>%
  bind_rows(fread("Historical Data Submissions/Sacramento/SacAppear10012019.csv"))

original_field <- names(court_hearing)

names(court_hearing) <- c("jail_court_id", "court_combined_id", "court_id", "case_id", "hearing_date", "hearing_type_code", "hearing_type", "hearing_comment", "hearing_result_code", "hearing_result", "hearing_result_comment")

original_df[[5]] <- tibble(table_name = "court_hearing", original_field = original_field, modified_field = names(court_hearing))

court_hearing <- court_hearing %>%
  mutate(hearing_date_time = as_datetime(hearing_date, tz = 'America/Los_Angeles'),
         hearing_date = as_date(hearing_date_time))

#Court case dispostions
court_dispos <- fread("Historical Data Submissions/Sacramento/SacDispos.csv") %>%
  bind_rows(fread("Historical Data Submissions/Sacramento/SacDispos10012019.csv"))

original_field <- names(court_dispos)

names(court_dispos) <- c("jail_court_id", "court_combined_id", "court_id", "case_id", "please_code", "charge_dispo_code", "case_charge_code", "charge_level", "charge", "disposition_date")

original_df[[6]] <- tibble(table_name = "court_dispos", original_field = original_field, modified_field = names(court_dispos))

court_dispos <- court_dispos %>%
  mutate(disposition_date = as_date(disposition_date))

#Court person ids
court_person <- fread("Historical Data Submissions/Sacramento/SacPersonDetail.csv") %>%
  bind_rows(fread("Historical Data Submissions/Sacramento/SacPersonDetail10012019.csv"))

original_field <- names(court_person)

names(court_person) <- c("jail_court_id", "first_name", "last_name", "name", "sex", "race", "dob", "cii", "fbi", "dln")

original_df[[7]] <- tibble(table_name = "court_person", original_field = original_field, modified_field = names(court_person))

court_person <- court_person %>%
  mutate(dob = ymd(gsub(" .*", "", trimws(dob))))

#Court Warrants
court_warrants <- fread("Historical Data Submissions/Sacramento/SacWarrants.csv") %>%
  bind_rows(fread("Historical Data Submissions/Sacramento/SacWarrants10012019.csv"))

original_field <- names(court_warrants)

names(court_warrants) <- c("jail_court_id", "court", "warrant_num", "warrant_id", "warrant_status", "charge_level", "warrant_type", "judge", "judge_comment", "complaint_lea", "lea_loc", "lea", "lea_foreign", "lea_hold", "charges_comments", "warrant_date", "warrant_clear_date", "warrant_duration", "bail_amt", "no_bail_flag", "case_id", "mandatory_appear_flag")

original_df[[8]] <- tibble(table_name = "court_warrants", original_field = original_field, modified_field = names(court_warrants))

court_warrants <- court_warrants %>%
  select(-judge) %>%
  mutate_at(vars(warrant_date, warrant_clear_date), as_date)
```

Code Book
```{r eval=FALSE, include=FALSE}
rm(original_field)

original_df <- bind_rows(original_df)

Sacramento_df <- lapply(ls()[!grepl("original", ls())], function(i){
  df <- get(i)
  
  if(sum(grepl("date", names(df))) > 0){
  df2 <- df %>%
  select(contains("date"), -contains("time")) %>%
  gather("modified_field", "value") %>%
  group_by(modified_field) %>%
  summarise_all(funs(min = as.character(min(., na.rm = T)), mean = as.character(mean(., na.rm = T)), max = as.character(max(., na.rm = T))))
  }else{
    df2 <- tibble(modified_field = NA_character_, min = NA_character_, mean = NA_character_, max = NA_character_)
  }
  
  df <- df %>%
    mutate_if(~length(unique(.)) > 50|is.Date(.)|is.POSIXct(.), ~(. = "not_factor")) %>%    
    mutate_all(~if_else(is.na(.), "na_missing", as.character(.))) %>%
    gather(modified_field, factor_value) %>%
    count(modified_field, factor_value) %>%
    mutate(table_name = i, county = "Sacramento") %>%
    mutate(factor_flag = if_else(factor_value == "not_factor", 0, 1)) %>%
    group_by(table_name, modified_field) %>%
    mutate(table_count = sum(n)) %>%
    ungroup() %>%
    rename("factor_count" = "n") %>%
    mutate(factor_count = if_else(factor_value == "not_factor", NA_integer_, factor_count),
           factor_percent = round(factor_count/table_count*100, 1)) %>%
    arrange(desc(factor_flag), modified_field, desc(factor_count))
  
  df <- left_join(df, df2, by = "modified_field")
    }) %>% 
  bind_rows() %>%
  left_join(original_df) %>%
   select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_count,
           factor_percent, table_count, min, mean, max) 

write.xlsx(Sacramento_df, file = "Code Books/Sacramento Code Book.xlsx")
```

# San Joaquin
- Everything is Join

Jail Data
```{r}
original_df <- list()

#Booking Data
book_df <- fread("Historical Data Submissions/San Joaquin/Jail_ATIMS_Data_BOOKING_20150101_to_20190930_3.csv")

original_field <- names(book_df)

names(book_df) <- c("book_num", "lar", "case_id", "bail_amt", "arrest_date", "book_date", "book_type", 
                    "release_date", "release_type")

original_df[[1]] <- tibble(table_name = "book_df", original_field = original_field, modified_field = names(book_df))

book_df <- book_df %>%
  mutate_at(vars(contains("date")), mdy)


#Booking Charges
book_charge <- fread("Historical Data Submissions/San Joaquin/Jail_ATIMS_Data_CHARGES_20150101_to_20190930_3.csv")

original_field <- names(book_charge)

names(book_charge) <- c("book_num", "count", "charge_code", "charge", "charge_description", "charge_level")

original_df[[2]] <- tibble(table_name = "book_charge", original_field = original_field, modified_field = names(book_charge))


#Booking Demographics
book_demo <- fread("Historical Data Submissions/San Joaquin/Jail_ATIMS_Data_PARTY_20150101_to_20190930_3.csv")

original_field <- names(book_demo)

names(book_demo) <- c("lar", "cii", "first_name", "last_name", "dln", "dln_state", "dob", "sex", "race")

original_df[[3]] <- tibble(table_name = "book_demo", original_field = original_field, modified_field = names(book_demo))

book_demo <- book_demo %>%
  mutate(dob = if_else(mdy(dob) > "2002-01-01", mdy(dob) - years(100), mdy(dob)))


#Booking Codes
book_ipid <- fread("Historical Data Submissions/San Joaquin/Jail_ATIMS_Data_LAR_to_IPID_20150101_to_20190930_3.csv")

original_field <- names(book_ipid)

names(book_ipid) <- c("lar", "ipid")

original_df[[4]] <- tibble(table_name = "book_ipid", original_field = original_field, modified_field = names(book_ipid))
```

Court Data
```{r}
#Court Cases High level 
court_df <- fread("Historical Data Submissions/San Joaquin/pretrial case.csv")

original_field <- names(court_df)

names(court_df) <- c("ipid", "court_id", "case_id", "case_id_previous", "complaint_id", "file_date", "case_status", "case_status_date")

original_df[[5]] <- tibble(table_name = "court_df", original_field = original_field, modified_field = names(court_df))

court_df <- court_df %>%
  mutate_at(vars(contains("date")), as_date)

#Court Charges
court_charge <- lapply(1:4, function(i){
  fread(paste0("Historical Data Submissions/San Joaquin/pretrial charge ", i, ".csv"), colClasses = "character")}) %>%
  bind_rows()

original_field <- names(court_charge)

names(court_charge) <- c("ipid", "court_id", "case_id", "complaint_id", "charge", "charge_level", "charge_description", 
                         "count", "qualifier", "police_reference", "disposition_type", "disposition_date", "sentence_date", "disposition_result", "dispostion_final_date", "seentence_final_date", "confinement_type", "confinement_facilty", "confinement_date", "confinement_end_date", "term_years", "term_months", "term_days", "today", "to_date", "term_to_days", "term_life", "result_id")

original_df[[6]] <- tibble(table_name = "court_charge", original_field = original_field, modified_field = names(court_charge))

court_charge <- court_charge %>%
  mutate_at(vars(contains("date"), today), as_date)


#Court Hearing Data
court_hearing <- fread("Historical Data Submissions/San Joaquin/pretrial hearing.csv")

original_field <- names(court_hearing)

names(court_hearing) <- c("case_id", "case_type", "hearing_date", "hearing_type")

original_df[[7]] <- tibble(table_name = "court_hearing", original_field = original_field, modified_field = names(court_hearing))

court_hearing <- court_hearing %>%
  mutate(hearing_date = as_date(hearing_date))


#Court Demographics
court_person <- fread("Historical Data Submissions/San Joaquin/pretrial party.csv")

original_field <- names(court_person)

names(court_person) <- c("ipid", "court_id", "last_name", "first_name", "dob", "gender", "race", "ethnicity", "dln", "dln_state")

original_df[[8]] <- tibble(table_name = "court_person", original_field = original_field, modified_field = names(court_person))

court_person <- court_person %>%
  mutate(dob = as_date(dob))


#Court FTAs
court_fta <- fread("Historical Data Submissions/San Joaquin/pretrial FTA by hearing.csv")

original_field <- names(court_fta)

names(court_fta) <- c("case_id", "case_type", "hearing_date", "hearing_type")

original_df[[9]] <- tibble(table_name = "court_fta", original_field = original_field, modified_field = names(court_fta))

court_fta <- court_fta %>%
  mutate(hearing_date = as_date(hearing_date))


#Court FTA Warrants
court_fta_warrant <- fread("Historical Data Submissions/San Joaquin/pretrial FTA by warrant.csv")

original_field <- names(court_fta_warrant)

names(court_fta_warrant) <- c("case_id", "case_type", "warrant_num", "fta_warrant_date")

original_df[[10]] <- tibble(table_name = "court_fta_warrant", original_field = original_field, modified_field = names(court_fta_warrant))

court_fta_warrant <- court_fta_warrant %>%
  mutate(fta_warrant_date = as_date(fta_warrant_date))
```

DA data 
```{r}
#DA Info
da_df <- fread("Historical Data Submissions/San Joaquin/pretrial booking.csv")

original_field <- names(da_df)

names(da_df) <- c("ipid", "fce_entity_id", "case_id", "case_id_full", "da_complaint_num", "book_num")

original_df[[11]] <- tibble(table_name = "da_df", original_field = original_field, modified_field = names(da_df))

#DA Statuses
prob_df <- fread("Historical Data Submissions/San Joaquin/pretrial assessment report.csv")

original_field <- names(prob_df)

names(prob_df) <- c("case_id", "report_status", "ra_date")

original_df[[12]] <- tibble(table_name = "prob_df", original_field = original_field, modified_field = names(prob_df))

prob_df <- prob_df %>%
  mutate(ra_date = as_date(ra_date))
```

Probation (assessment) data--Fix later

```{r}
#Assessment Data
prob_df2 <- read_excel("Historical Data Submissions/San Joaquin/MASTER Pretrial Data Collection Variables 2011.xlsx", sheet = "2017-Present", col_types = "text") %>%
  rename_all(str_squish) %>%
  rename_at(vars(contains("...")), funs(paste0("...", as.numeric(gsub("...", "", .)) - 2))) %>%
  bind_rows(
    lapply(c("2014", "2015", "2016"), function(i) {
      read_excel("Historical Data Submissions/San Joaquin/MASTER Pretrial Data Collection Variables 2011.xlsx", sheet = i, col_types = "text") %>%
        rename_all(str_squish)
    })
  )

original_field <- names(prob_df2)


names(prob_df2) <- c("count", "assessment_date", "book_num", "unknown_id", "cii", "local_id", "dln_state", "dln", "case_num", "last_name", "first_name", "dob", "gender", "race", "zipcode", "score", "tansdermal_study", "overide", "auto_hold_1270.1", "auto_hold_1319", "auto_hold_other", "release_authorization_prearraignment", "release_authorization_postarraignment", "concurrence", "judge_name", "gps", "pretrial_release_date", "pretrial_monitor_start_date", "pretrial_monitor_end_date", "monitor_level", "fta_warrant", "court_remand", "remand_date", "remand_memo", "rearrest", "rearrest_date", "rearrest_charge", "charge_description", "charge_level", "termination_outcome", "notes")

original_df[[13]] <- tibble(table_name = "prob_df2", original_field = original_field, modified_field = names(prob_df2))

prob_df2 <- prob_df2 %>%
  filter(row_number() != 1) %>%
  mutate_at(vars(contains("date"), dob), convertToDate)
```

Code Book
```{r eval=FALSE, include=FALSE}
rm(original_field)

original_df <- bind_rows(original_df)

San_Joaquin_df <- lapply(ls()[!grepl("original", ls())], function(i){
  df <- get(i)
  
  if(sum(grepl("date", names(df))) > 0){
  df2 <- df %>%
  select(contains("date"), -contains("time")) %>%
  gather("modified_field", "value") %>%
  group_by(modified_field) %>%
  summarise_all(funs(min = as.character(min(., na.rm = T)), mean = as.character(mean(., na.rm = T)), max = as.character(max(., na.rm = T))))
  }else{
    df2 <- tibble(modified_field = NA_character_, min = NA_character_, mean = NA_character_, max = NA_character_)
  }
  
  df <- df %>%
    mutate_if(~length(unique(.)) > 50|is.Date(.)|is.POSIXct(.), ~(. = "not_factor")) %>%    
    mutate_all(~if_else(is.na(.), "na_missing", as.character(.))) %>%
    gather(modified_field, factor_value) %>%
    count(modified_field, factor_value) %>%
    mutate(table_name = i, county = "San_Joaquin") %>%
    mutate(factor_flag = if_else(factor_value == "not_factor", 0, 1)) %>%
    group_by(table_name, modified_field) %>%
    mutate(table_count = sum(n)) %>%
    ungroup() %>%
    rename("factor_count" = "n") %>%
    mutate(factor_count = if_else(factor_value == "not_factor", NA_integer_, factor_count),
           factor_percent = round(factor_count/table_count*100, 1)) %>%
    arrange(desc(factor_flag), modified_field, desc(factor_count))
  
  df <- left_join(df, df2, by = "modified_field")
    }) %>% 
  bind_rows() %>%
  left_join(original_df) %>%
   select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_count,
           factor_percent, table_count, min, mean, max) 

write.xlsx(San_Joaquin_df, file = "Code Books/San Joaquin Code Book.xlsx")
```
# San Mateo
- Everything is Join

Jail Data
```{r}
original_df <- list()

book_df <- fread("Historical Data Submissions/San Mateo/41-SO-01OF01-JAN2015-JUN2019.csv", colClasses = "text")
book_df2 <- fread("Historical Data Submissions/San Mateo/41-SO-01OF02-JUL2019-SEPT2019.csv", colClasses = "text", header = F)

names(book_df2) <- names(book_df)

book_df <- bind_rows(book_df, book_df2)

rm(book_df2)

original_field <- names(book_df)

names(book_df) <- c("cii", "name", "dob", "fbi", "local_id", "dln", "sex", "race", "arrest_date", "book_num", "book_date", "book_type", "case_id", "charge", "charge_level", "release_date", "release_type", "bail_amt", "conviction_date", "conviction_charge", "employment_status")

original_df[[1]] <- tibble(table_name = "book_df", original_field = original_field, modified_field = names(book_df))

book_df <- book_df %>%
  select(-c(conviction_date, conviction_charge, employment_status)) %>%
  mutate_at(vars(contains("date")), funs(time = as_datetime(., tz = 'America/Los_Angeles'))) %>%
  mutate_at(vars(contains("date"), dob), as_date)
```

Court Data
```{r}
#High level cases
court_df <- fread("Historical Data Submissions/San Mateo/41-COURT-01OF03-JAN2016-SEP2019.csv")

original_field <- names(court_df)

names(court_df) <- c("case_id", "court_id", "filing_date", "case_type", "person_id", "cii", "fbi", "local_id", "dln", 
                     "name", "dob", "sex", "race")

original_df[[2]] <- tibble(table_name = "court_df", original_field = original_field, modified_field = names(court_df))

court_df <- court_df %>%
  mutate_at(vars(dob, filing_date), as_date)

#Sentence Data
court_sentence <- fread("Historical Data Submissions/San Mateo/41-COURT-02OF03-JAN2016-SEP2019.csv")

original_field <- names(court_sentence)

names(court_sentence) <- c("case_id", "court_id", "filing_date", "case_type", "case_status", "case_status_date", "book_num", "arrest_date", "arrest_control", "arrest_agency", "offence_id", "charge_id", "charge_num", "offense_date", "charge", "charge_level", "charge_description", "plea_type", "plea_date", "disposition_type", "disposition_date", "disposition_final_date", "sentence_type", "sentence_date", "sentence_loc", "probation_type", "term_years_probation", "term_months_probation", "term_days_probation", "jail_type", "term_years_jail", "term_months_jail", "term_days_jail")

original_df[[3]] <- tibble(table_name = "court_sentence", original_field = original_field, modified_field = names(court_sentence))

court_sentence <- court_sentence %>%
  mutate_at(vars(contains("date")), as_date)

#Court hearings--Contains Warrants
court_hearing <- fread("Historical Data Submissions/San Mateo/41-COURT-03OF03-JAN2016-SEP2019.csv")

original_field <- names(court_hearing)

names(court_hearing) <- c("case_id", "case_number", "filing_date", "case_type", "setting_id", "hearing_date", "hearing_type_loc", "court_loc", "hearing_type_code", "hearing_type", "hearing_result", "hearing_date_next", "fta", "fta_warrant")

original_df[[4]] <- tibble(table_name = "court_hearing", original_field = original_field, modified_field = names(court_hearing))

court_hearing <- court_hearing %>%
  mutate_at(vars(contains("date")), as_date)
```

Probation. No Actual Assessment data. Do not use.  
```{r}
# prob_df1 <- fread("Historical Data Submissions/San Mateo/41-PROBATION-01OF04-JAN2015-SEP2019.csv")
# prob_df2 <- fread("Historical Data Submissions/San Mateo/41-PROBATION-02OF04-JAN2015-SEP2019.csv")
# prob_df3 <- fread("Historical Data Submissions/San Mateo/41-PROBATION-03OF04-JAN2015-SEP2019.csv")
# prob_df4 <- fread("Historical Data Submissions/San Mateo/41-PROBATION-04OF04-JAN2015-SEP2019.csv")
```

Code Book
```{r eval=FALSE, include=FALSE}
rm(original_field)

original_df <- bind_rows(original_df)

San_Mateo_df <- lapply(ls()[!grepl("original", ls())], function(i){
  df <- get(i)
  
  if(sum(grepl("date", names(df))) > 0){
  df2 <- df %>%
  select(contains("date"), -contains("time")) %>%
  gather("modified_field", "value") %>%
  group_by(modified_field) %>%
  summarise_all(funs(min = as.character(min(., na.rm = T)), mean = as.character(mean(., na.rm = T)), max = as.character(max(., na.rm = T))))
  }else{
    df2 <- tibble(modified_field = NA_character_, min = NA_character_, mean = NA_character_, max = NA_character_)
  }
  
  df <- df %>%
    mutate_if(~length(unique(.)) > 50|is.Date(.)|is.POSIXct(.), ~(. = "not_factor")) %>%    
    mutate_all(~if_else(is.na(.), "na_missing", as.character(.))) %>%
    gather(modified_field, factor_value) %>%
    count(modified_field, factor_value) %>%
    mutate(table_name = i, county = "San Mateo") %>%
    mutate(factor_flag = if_else(factor_value == "not_factor", 0, 1)) %>%
    group_by(table_name, modified_field) %>%
    mutate(table_count = sum(n)) %>%
    ungroup() %>%
    rename("factor_count" = "n") %>%
    mutate(factor_count = if_else(factor_value == "not_factor", NA_integer_, factor_count),
           factor_percent = round(factor_count/table_count*100, 1)) %>%
    arrange(desc(factor_flag), modified_field, desc(factor_count))
  
  df <- left_join(df, df2, by = "modified_field")
    }) %>% 
  bind_rows() %>%
  left_join(original_df) %>%
   select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_count,
           factor_percent, table_count, min, mean, max) 

write.xlsx(San_Mateo_df, file = "Code Books/San Mateo Code Book.xlsx")
```

# Santa Barbara

Jail Data
```{r}
original_df <- list()

# Jail Bookings
book_df <- read_excel("Historical Data Submissions/Santa Barbara/Jail.Data.12.5.xlsx", col_types = "text")

original_field <- names(book_df)

names(book_df) <- c("cii", "first_name", "last_name", "dob", "arrest_date_time", "book_num", "book_date_time", "book_type", "case_id", "charge_code", "charge", "charge_level", "release_date_time", "release_type", "gender", "race")

original_df[[1]] <- tibble(table_name = "book_df", original_field = original_field, modified_field = names(book_df))

book_df <- book_df %>%
  mutate_at(vars(arrest_date_time, book_date_time, release_date_time), convertToDateTime) %>%
  mutate(dob = convertToDate(dob)) %>%
  mutate(arrest_date = as_date(arrest_date_time),
         book_date = as_date(book_date_time),
         release_date = as_date(release_date_time))
```

Court Data
```{r}
#Court Status
court_status <- fread("Historical Data Submissions/Santa Barbara/CaseStatus.csv", header = F)

original_field <- names(court_status)

names(court_status) <- c("case_id", "case_num", "status_date", "status")

original_df[[2]] <- tibble(table_name = "court_status", original_field = original_field, modified_field = names(court_status))

court_status <- court_status %>%
  mutate(status_date = mdy(status_date))


#Court Charges
court_charges <- fread("Historical Data Submissions/Santa Barbara/Charges.csv", header = F)

original_field <- names(court_charges)

names(court_charges) <- c("case_id", "case_num", "charge_code", "charge", "charge_level", "charge_description", "plea_date", "plea_type", "disposition_date", "dispositiontype", "disposition_date_final")

original_df[[3]] <- tibble(table_name = "court_charges", original_field = original_field, modified_field = names(court_charges))

court_charges <- court_charges %>%
  mutate_at(vars(contains("date")), as_date)


#Court hearing data
court_hearing <- fread("Historical Data Submissions/Santa Barbara/Hearings.csv", header = F)

original_field <- names(court_hearing)

names(court_hearing) <- c("case_id", "case_num", "hearing_date", "hearing_type", "hearing_result")

original_df[[4]] <- tibble(table_name = "court_hearing", original_field = original_field, modified_field = names(court_hearing))

court_hearing <- court_hearing %>%
  mutate(hearing_date = mdy(hearing_date))


#The following is for confinement sentencing.
court_confinement <- fread("Historical Data Submissions/Santa Barbara/SentConf.csv")

original_field <- names(court_confinement)

names(court_confinement) <- c("case_id", "case_num", "sentence_date", "setence_type", "sentence_loc",
                              "sentence_term", "term_length")

original_df[[5]] <- tibble(table_name = "court_confinement", original_field = original_field, modified_field = names(court_confinement))

court_confinement <- court_confinement %>%
  mutate(sentence_date = mdy(sentence_date))


#The following is for probation sentencing.
court_probation <- fread("Historical Data Submissions/Santa Barbara/SentProb.csv", header = F)

original_field <- names(court_probation)

names(court_probation) <- c("case_id", "case_num", "sentence_date", "setence_type", "sentence_loc",
                              "term_length", "sentence_term")

original_df[[6]] <- tibble(table_name = "court_probation", original_field = original_field, modified_field = names(court_probation))

court_probation <- court_probation %>%
  mutate(sentence_date = mdy(sentence_date))


#Court Person IDs
court_person <- fread("Historical Data Submissions/Santa Barbara/TechElements.csv", header = F)

original_field <- names(court_person)

names(court_person) <- c("case_id", "case_num", "last_name", "first_name", "middle_name", "file_date", "dob", "cii", "dln", "fbi", "sex", "race", "dln_state", "ra_date")

original_df[[7]] <- tibble(table_name = "court_person", original_field = original_field, modified_field = names(court_person))

court_person <- court_person %>%
  mutate_at(vars(contains("date"), dob), mdy)


#FTA Warrants
court_fta_war <- fread("Historical Data Submissions/Santa Barbara/Warrants.csv", header = F)

original_field <- names(court_fta_war)

names(court_fta_war) <- c("case_id", "case_num", "fta", "fta_date", "fta_warrant", "fta_warrant_date", "fta_description")

original_df[[8]] <- tibble(table_name = "court_fta_war", original_field = original_field, modified_field = names(court_fta_war))

court_fta_war <- court_fta_war %>%
  mutate_at(vars(contains("date")), mdy)
```

Assessment Data (Court)
```{r}
#Assessment with Full Interviews
assess_interview <- read_excel("Historical Data Submissions/Santa Barbara/Full.xlsm", skip = 1)

original_field <- names(assess_interview)

names(assess_interview) <- c("name", "dob", "book_num", "arrest_date", "interview_type", "interviewer", "interview_date", "location", "refferal_type", "court_loc", "case", "cid", "alcohol_flag", "civic_flag", "drug_flag", "financial_flag", "personal_flag", "property_flag", "order_flag", "sex_flag", "traffic_flag", "violation_flag", "violent_flag", "other_flag", "other2_flag", "charge_level", "charge_score", "pending_flag", "pending_score", "residence_type", "residence_score", "employment_type", "employment_score", "crim_history", "crim_history_score", "drug_abuse_history", "drug_abuse_history_score", "fta_history", "fta_score", "vc_history", "vc_score", "risk_score", "pretrial_recommendation", "sup_agency", "conern_risk", "concern_public_safety", "concern_poi", "concern_no_bail", "concern_fta_possibilty", "concern_ineligible", "concern_other", "concern2_other", "bail_recommend", "custody", "cond_call_in", "cond_ptco", "cond_avoid_place", "cond_avoid_contact", "cond_maths", "cond_passport", "cond_drugs", "cond_scram", "cond_gps", "cond_weapons", "cond_sands", "cond_other", "aoda_recommend", "reassess_change", "reassess_ref", "reassess_victim", "reassess_info", "reassess_charges", "comments", "pts_assessment", "sex", "race_ai", "race_asian", "race_black", "race_hispanic", "race_me", "race_pi", "race_white", "race_other", "race2_other", "language", "bw", "gang", "supervision", "sbc_partner", "sbc_family", "sbc_children", "sbc_work", "sbc_school", "sbc_none", "ca_partner", "ca_family", "ca_children", "ca_work", "ca_school", "ca_none", "outside_partner", "outside_family", "outside_children", "outside_work", "outside_schoool", "outside_none", "cellphone", "email", "alcohol_use", "narcotics_use", "employed", "in_school", "living_conditions", "information_quality", "references", "omissions", "deception", "no_refs", "other_issues", "other2_issues", "id", "data")

original_df[[9]] <- tibble(table_name = "assess_interview", original_field = original_field, modified_field = names(assess_interview))

assess_interview <- assess_interview %>%
  mutate(arrest_date = convertToDate(arrest_date))

#Assessment Tracking
assess_tracking <- read_excel("Historical Data Submissions/Santa Barbara/Full.xlsm", skip = 1, sheet = 3)

original_field <- names(assess_tracking)

names(assess_tracking) <- c("id", "name", "dob", "cide", "interview_date", "book_num", "referral_type", "court", "risk_score", "pretrial_recommend", "supervision_agency", "custody", "bail_before_court_flag", "pretrial_decision", "bailed_after_court", "continue_tracking_flag")

original_df[[10]] <- tibble(table_name = "assess_tracking", original_field = original_field, modified_field = names(assess_tracking))


#Assessment Outcomes
assess_outcome <- read_excel("Historical Data Submissions/Santa Barbara/Full.xlsm", skip = 1, sheet = 4)

original_field <- names(assess_outcome)

names(assess_outcome) <- c("id", "name", "cid", "interview_date", "referral_type", "decision", "case_num", "charge_level", "case_status", "cd1", "cd1_appeared", "cd2", "cd2_appeared", "cd3", "cd3_appeared", "cd4", "cd4_appeared", "cd5", "cd5_appeared", "cd6", "cd6_appeared", "cd7", "cd7_appeared", "cd8", "cd8_appeared", "cd9", "cd9_appeared", "pretrial_rearrest", "pretrial_rearrest_date", "remand_flag", "rearrest_remand_case", "phone_num", "contact_notes", "other")

original_df[[11]] <- tibble(table_name = "assess_outcome", original_field = original_field, modified_field = names(assess_outcome))

assess_outcome <- assess_outcome %>%
  mutate_at(vars(cd1, cd2, cd5, cd6, cd7, cd8, pretrial_rearrest_date), convertToDate)

#Assessments without Interivew
assess_nointerview <- read_excel("Historical Data Submissions/Santa Barbara/Non.xlsm", skip = 1)

original_field <- names(assess_nointerview)

names(assess_nointerview) <- c("name", "dob", "book_num", "arrest_date", "reviewer", "review_date", "review_loc", "referral_type", "court", "cid", "case_num", "stage_none", "stage_preinterview", "stage_interview", "stage_references", "stage_victim", "stage_assess", "alcohol_flag", "civic_flag", "drug_flag", "financial_flag", "personal_flag", "property_flag", "order_flag", "sex_flag", "traffic_flag", "violation_flag", "violent_flag", "other_flag", "other2_flag", "non_unwilling", "non", "non_capital", "non_supervision", "non_other_agency", "non_sick", "non_849", "non_bail", "non_warrants", "non_other", "non_other_more", "aoda", "reassess_cricumstance", "reassess_willing", "reassess_info", "reassess_holds", "reassess_charge", "sex", "race_ai", "race_asian", "race_black", "race_hispanic", "race_me", "race_pi", "race_white", "race_other", "race2_other", "language", "id", "filename")

original_df[[12]] <- tibble(table_name = "assess_nointerview", original_field = original_field, modified_field = names(assess_nointerview))
```

Code Book
```{r eval=FALSE, include=FALSE}
rm(original_field)

original_df <- bind_rows(original_df)

Santa_Barbara_df <- lapply(ls()[!grepl("original", ls())], function(i){
  df <- get(i)
  
  if(sum(grepl("date", names(df))) > 0){
  df2 <- df %>%
  select(contains("date"), -contains("time")) %>%
  gather("modified_field", "value") %>%
  group_by(modified_field) %>%
  summarise_all(funs(min = as.character(min(., na.rm = T)), mean = as.character(mean(., na.rm = T)), max = as.character(max(., na.rm = T))))
  }else{
    df2 <- tibble(modified_field = NA_character_, min = NA_character_, mean = NA_character_, max = NA_character_)
  }
  
  df <- df %>%
    mutate_if(~length(unique(.)) > 50|is.Date(.)|is.POSIXct(.), ~(. = "not_factor")) %>%    
    mutate_all(~if_else(is.na(.), "na_missing", as.character(.))) %>%
    gather(modified_field, factor_value) %>%
    count(modified_field, factor_value) %>%
    mutate(table_name = i, county = "Santa Barbara") %>%
    mutate(factor_flag = if_else(factor_value == "not_factor", 0, 1)) %>%
    group_by(table_name, modified_field) %>%
    mutate(table_count = sum(n)) %>%
    ungroup() %>%
    rename("factor_count" = "n") %>%
    mutate(factor_count = if_else(factor_value == "not_factor", NA_integer_, factor_count),
           factor_percent = round(factor_count/table_count*100, 1)) %>%
    arrange(desc(factor_flag), modified_field, desc(factor_count))
  
  df <- left_join(df, df2, by = "modified_field")
    }) %>% 
  bind_rows() %>%
  left_join(original_df) %>%
   select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_count,
           factor_percent, table_count, min, mean, max) 

write.xlsx(Santa_Barbara_df, file = "Code Books/Santa Barbara Code Book.xlsx")

?write.xlsx()
```


# Tulare
- Everything is Join

Jail Data
```{r}
book_df <- fread("Historical Data Submissions/Tulare/JMS data.csv", sep = NULL, col.names = "x")

book_df <- book_df %>%
  mutate(x = gsub(", ,", ",NA,", x),
         x = gsub(", ", " ", x),
         x = gsub("[A-Z](,,,,)[A-Z]", ",,,", x)) %>%
  separate(x, c("cii", "fbi", "ref", "dln", "name", "dob", "ref2", "race", "bail_amt", "date",
                "charge", "ref3", "ref4", "name2", "dob2", "date2", "unknown", "date3", "ref5", 
                "ref6", "charge2", "date4", "date5", "numeric"),
           sep = ",") %>%
  select(-contains("ref"))

book_df <- book_df %>%
  mutate_at(vars(dob, dob2), funs(mdy(if_else(nchar(.) == 7, paste0("0", .), .)))) %>%
  mutate_at(vars(contains("date")), ymd_hms)
```

Court Data
```{r}
original_df <- list()

court_df <- lapply(c("15-16", "16-17", "17-18", "18-19"), function(i){
  fread(paste0("Historical Data Submissions/Tulare/PretrialStatsFY", i, ".csv"), colClasses = "character", header = F)}) %>%
  bind_rows()

original_field <- names(court_df)

names(court_df) <- c("case_id", "filing_date", "disposition_date", "case_type", "name", "dob", "sex", "race", "fbi", "cii", "dln", "arrest_date", "arrest_agency", "report_id", "charge_level", "charge", "charge_filing_date", "charge_type", "charge_code", "charge_description", "disposition_date_charge", "disposition", "sentence_date", "sentence_charge", "sentence", "sentence_amt", "sentence_type", "term", "sentence_status", "hearing_date", "hearing_type", "hearing_result", "warrant_date", "warrant_type", "total")

original_df[[1]] <- tibble(table_name = "court_df", original_field = original_field, modified_field = names(court_df))

court_df <- court_df %>%
  mutate_at(vars(contains("date"), dob), mdy)
```

Probation (assessment)--Confusing Data. Figure out later. 
```{r}
prob_df <- fread("Historical Data Submissions/Tulare/Extremely Rough DRAFT Pretrial Project data 20191008 1722.csv")

original_field <- names(prob_df)

names(prob_df) <- c("event_id", "tool_name", "ra_date", "zip_code", "tool_response", "risk_score", "release_recommendation", "release_decision", "release_type", "release_date", "release_conditions", "pretrial_violation", "pretrial_violation_date", "court_date_reminder", "termination_outcome", "termination_date", "cii", "fbi", "local_id", "dln", "name", "dob", "sex", "race")

original_df[[2]] <- tibble(table_name = "prob_df", original_field = original_field, modified_field = names(prob_df))

prob_df <- prob_df %>%
  mutate(ra_date_time = mdy_hms(ra_date),
         ra_date = as_date(ra_date_time),
         release_date_time = mdy_hms(release_date),
         release_date = as_date(release_date_time)) %>%
  mutate_at(vars(pretrial_violation_date, termination_date, dob), mdy)
```

Code Book
```{r eval=FALSE, include=FALSE}
rm(original_field)

original_df <- bind_rows(original_df)

Tulare_df <- lapply(ls()[!grepl("original", ls())], function(i){
  df <- get(i)
  
  if(sum(grepl("date", names(df))) > 0){
  df2 <- df %>%
  select(contains("date"), -contains("time")) %>%
  gather("modified_field", "value") %>%
  group_by(modified_field) %>%
  summarise_all(funs(min = as.character(min(., na.rm = T)), mean = as.character(mean(., na.rm = T)), max = as.character(max(., na.rm = T))))
  }else{
    df2 <- tibble(modified_field = NA_character_, min = NA_character_, mean = NA_character_, max = NA_character_)
  }
  
  df <- df %>%
    mutate_if(~length(unique(.)) > 50|is.Date(.)|is.POSIXct(.), ~(. = "not_factor")) %>%    
    mutate_all(~if_else(is.na(.), "na_missing", as.character(.))) %>%
    gather(modified_field, factor_value) %>%
    count(modified_field, factor_value) %>%
    mutate(table_name = i, county = "Tulare") %>%
    mutate(factor_flag = if_else(factor_value == "not_factor", 0, 1)) %>%
    group_by(table_name, modified_field) %>%
    mutate(table_count = sum(n)) %>%
    ungroup() %>%
    rename("factor_count" = "n") %>%
    mutate(factor_count = if_else(factor_value == "not_factor", NA_integer_, factor_count),
           factor_percent = round(factor_count/table_count*100, 1)) %>%
    arrange(desc(factor_flag), modified_field, desc(factor_count))
  
  df <- left_join(df, df2, by = "modified_field")
    }) %>% 
  bind_rows() %>%
  left_join(original_df) %>%
   select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_count,
           factor_percent, table_count, min, mean, max) 

write.xlsx(Tulare_df, file = "Code Books/Tulare Code Book.xlsx")
```


Join
```{r eval=FALSE, include=FALSE}
#Alameda has an integrated criminal justice system. Information is joined across agencies on the jail_court_ID. It is contained in the book_df, court_df, and book_charge tables. 

#Jail Court ID is duplicated when split between cases
book_df <- book_df %>% distinct(jail_court_id, .keep_all = T)

#Jail Court ID is duplicated when split between cases
court_df <- court_df %>% distinct(jail_court_id, .keep_all = T)

book_no_court <- anti_join(book_df, court_df, by = c("jail_court_id"))
nrow(book_df)
nrow(book_no_court)
nrow(book_no_court)/nrow(book_df)

court_no_book <- anti_join(court_df, book_df, by = c("jail_court_id"))
nrow(court_df)
nrow(court_no_book)
nrow(court_no_book)/nrow(court_df)
```


# Tuolumne

Jail Data
```{r}

```

Court Data
```{r}
court_df <- read_excel("Historical Data Submissions/Tuolomne/Tuolumne Pretrial Assessment Information.xls", sheet = 1)

court_charges <- read_excel("Historical Data Submissions/Tuolomne/Tuolumne Pretrial Assessment Information.xls", sheet = 2)

court_sentence <- read_excel("Historical Data Submissions/Tuolomne/Tuolumne Pretrial Assessment Information.xls", sheet = 3)

court_hearing <- read_excel("Historical Data Submissions/Tuolomne/Tuolumne Pretrial Assessment Information.xls", sheet = 4)
court_hearing2 <- read_excel("Historical Data Submissions/Tuolomne/Tuolumne Pretrial Assessment Information.xls", sheet = 5)

court_hearing <- bind_rows(court_hearing, court_hearing2)
rm(court_hearing2)

court_lawyer <- read_excel("Historical Data Submissions/Tuolomne/Tuolumne Pretrial Assessment Information.xls", sheet = 6)

court_demo <- read_excel("Historical Data Submissions/Tuolomne/Tuolumne Pretrial Assessment Information.xls", sheet = 7)

court_demo2 <- read_excel("Historical Data Submissions/Tuolomne/Tuolumne Pretrial Assessment Information.xls", sheet = 8)
```

Probation (assessment)--Confusing Data. Figure out later. 
```{r}
# prob_df <- lapply(2018:2019, function(i){
#   lapply(getSheetNames(paste0("Historical Data Submissions/Tuolomne/Tuolumne County Probation Pre-Trial Data ", i, ".xlsx")),
#          function(j){
#     df <- read_excel(paste0("Historical Data Submissions/Tuolomne/Tuolumne County Probation Pre-Trial Data ", i, ".xlsx"),
#                      skip = 2, sheet = j, col_types = "text")
#     df$risk_score <- j
#     return(df)
# }) %>% bind_rows() 
# }) %>% bind_rows()
```


# Ventura

Jail Data
```{r}
book_df <- read_excel("Historical Data Submissions/Ventura/jcc_ptm_vcsh_2015_2019.xlsx")

names(book_df) <- c("cii", "name", "dob", "arrest_date", "book_num", "book_date", "book_type", "case_id", "charge", "charge_level", "release_date", "release_type", "cii_2", "fbi", "local_id", "dln", "name-2", "dob_2", "sex", "race", "bail_amt", "conviction_date", "conviction_charge", "employee_status")
```

Court Data
```{r}
court_df <- read_excel("Historical Data Submissions/Ventura/jcc_ptm_vcct_2015_2019.xlsx")

names(court_df) <- c("case_id", "other_id", "hearing_fta_flag", "fta_date", "fta_warrant_flag", "fta_warrant_date", "disposition", "disposition_date", "disposition_final_date", "sentence_type", "sentence_date", "cii", "fbi", "local_id", "dln", "name", "dob", "sex", "race", "filing_date", "case_status", "case_status_date", "charge", "charge_level", "charge_description", "hearing_type", "hearing_date", "plea_type", "plea_date", "sentence_loc", "term", "ra_date")
```

Probation (assessment)--Confusing Data. Figure out later. 
```{r}
prob_df <- read_excel("Historical Data Submissions/Ventura/Pretrial Supervision - VCPA.xlsx")

names(prob_df) <- c("person_id", "case_id", "name", "dob", "sex", "race", "cii", "fbi", "dln", "date", "dv", "pretrial_recommendation", "pretrial_screening_flag", "pat_flag", "pretrial_decision", "success_date", "fta_date", "new_arrest_date", "offense_type", "charge_level", "pretrial_violation_date", "pretrial_outcome", "outcome_type", "pretrial_time_spent")
```

Code Book
```{r eval=FALSE, include=FALSE}
rm(original_field)

original_df <- bind_rows(original_df)

Sacramento_df <- lapply(ls()[!grepl("original", ls())], function(i){
  df <- get(i)
  
  if(sum(grepl("date", names(df))) > 0){
  df2 <- df %>%
  select(contains("date"), -contains("time")) %>%
  gather("modified_field", "value") %>%
  group_by(modified_field) %>%
  summarise_all(funs(min = as.character(min(., na.rm = T)), mean = as.character(mean(., na.rm = T)), max = as.character(max(., na.rm = T))))
  }else{
    df2 <- tibble(modified_field = NA_character_, min = NA_character_, mean = NA_character_, max = NA_character_)
  }
  
  df <- df %>%
    mutate_if(~length(unique(.)) > 50|is.Date(.)|is.POSIXct(.), ~(. = "not_factor")) %>%    
    mutate_all(~if_else(is.na(.), "na_missing", as.character(.))) %>%
    gather(modified_field, factor_value) %>%
    count(modified_field, factor_value) %>%
    mutate(table_name = i, county = "Sacramento") %>%
    mutate(factor_flag = if_else(factor_value == "not_factor", 0, 1)) %>%
    group_by(table_name, modified_field) %>%
    mutate(table_count = sum(n)) %>%
    ungroup() %>%
    rename("factor_count" = "n") %>%
    mutate(factor_count = if_else(factor_value == "not_factor", NA_integer_, factor_count),
           factor_percent = round(factor_count/table_count*100, 1)) %>%
    arrange(desc(factor_flag), modified_field, desc(factor_count))
  
  df <- left_join(df, df2, by = "modified_field")
    }) %>% 
  bind_rows() %>%
  left_join(original_df) %>%
   select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_count,
           factor_percent, table_count, min, mean, max) 

write.xlsx(Sacramento_df, file = "Code Books/Sacramento Code Book.xlsx")
```


# Yuba

Jail Data
```{r}
original_df <- list()

# Jail Bookings
book_df <- fread("Historical Data Submissions/Yuba/JailExtract.csv")

original_field <- names(book_df)

names(book_df) <- c("cii", "fbi", "last_name", "first_name", "middle_name", "dob", "arrest_date_time", "book_num", "book_date_time", "court_id", "charge_code", "charge", "charge_level", "release_date", "release_type", "local_id", "other_id", "dln_state", "sex", "race", "nationality", "bail_amt", "no_bail", "cash_bail", "bail_reduction", "employement", "status")

original_df[[1]] <- tibble(table_name = "book_df", original_field = original_field, modified_field = names(book_df))

book_df <- book_df
```

Code Book
```{r eval=FALSE, include=FALSE}
rm(original_field)

original_df <- bind_rows(original_df)

Alameda_df <- lapply(ls()[!grepl("original", ls())], function(i){
  df <- get(i)
  
  if(sum(grepl("date", names(df))) > 0){
  df2 <- df %>%
  select(contains("date"), -contains("time")) %>%
  gather("modified_field", "value") %>%
  group_by(modified_field) %>%
  summarise_all(funs(min = as.character(min(., na.rm = T)), mean = as.character(mean(., na.rm = T)), max = as.character(max(., na.rm = T))))
  }else{
    df2 <- tibble(modified_field = NA_character_, min = NA_character_, mean = NA_character_, max = NA_character_)
  }
  
  df <- df %>%
    mutate_if(~length(unique(.)) > 50|is.Date(.)|is.POSIXct(.), ~(. = "not_factor")) %>%    
    mutate_all(~if_else(is.na(.), "na_missing", as.character(.))) %>%
    gather(modified_field, factor_value) %>%
    count(modified_field, factor_value) %>%
    mutate(table_name = i, county = "Alameda") %>%
    mutate(factor_flag = if_else(factor_value == "not_factor", 0, 1)) %>%
    group_by(table_name, modified_field) %>%
    mutate(table_count = sum(n)) %>%
    ungroup() %>%
    rename("factor_count" = "n") %>%
    mutate(factor_count = if_else(factor_value == "not_factor", NA_integer_, factor_count),
           factor_percent = round(factor_count/table_count*100, 1)) %>%
    arrange(desc(factor_flag), modified_field, desc(factor_count))
  
  df <- left_join(df, df2, by = "modified_field")
    }) %>% 
  bind_rows() %>%
  left_join(original_df) %>%
   select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_count,
           factor_percent, table_count, min, mean, max) 

write.xlsx(Yuba_df, file = "Code Books/Alameda Code Book.xlsx")
```
=======
---
title: "County Data Loading"
author: "Noah Lehman"
date: "10/15/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

knitr::opts_knit$set(root.dir = "G:/CrimJustice/PretrialAssessmentPilot")
```

# Libraries
```{r}
library(data.table)
library(openxlsx)
library(readxl)
library(lubridate)
library(tidyverse)
```

# Function Creation
```{r}
# name_keeper <- function(df){
#   attr(df, "names_original") <- names(df)
# }

rm(name_keeper)
```


# Alameda

--Next Step: Create Mapping between variables in codebook. 

Jail Data
```{r}
original_df <- list()

# Jail Bookings
book_df <- lapply(1:4, function(i){
  fread(paste0("Historical Data Submissions/Alameda/BOOK_", i, ".csv"), colClasses = "character")}) %>%
  bind_rows()

original_field <- names(book_df)

names(book_df) <- c("cii", "fbi", "pfn_x", "first_name", "last_name", "dob", "dln", "dln_state", "race_code", "race", "sex_cd", "arrest_date", "arrest_time", "jail_court_id", "booking_seq", "book_type_code", "book_type", "book_date", "book_time", "release_date", "release_time", "release_type_code", "release_type", "case_id", "case_number")

original_df[[1]] <- tibble(table_name = "book_df", original_field = original_field, modified_field = names(book_df))

book_df <- book_df %>%
  mutate(arrest_date_time = mdy_hms(paste(arrest_date, arrest_time), tz = 'America/Los_Angeles'),
         book_date_time = mdy_hms(paste(book_date, book_time), tz = 'America/Los_Angeles'),
         release_date_time = mdy_hms(paste(release_date, release_time), tz = 'America/Los_Angeles')) %>%
  mutate_at(vars(dob, arrest_date, book_date, release_date), mdy) 

# Jail Booking Charges
book_charge <- lapply(1:2, function(i){
  fread(paste0("Historical Data Submissions/Alameda/ARRCHG_", i, ".csv"), colClasses = "character")}) %>%
  bind_rows()

original_field <- names(book_charge)

names(book_charge) <- c("jail_court_id", "charge_num", "entry_code", "charge_code", "charge", "charge_level")

original_df[[2]] <- tibble(table_name = "book_charge", original_field = original_field, modified_field = names(book_charge))
```

Court Data
```{r}
# Court Cases
court_df <- lapply(c("", "_2"), function(i){
  fread(paste0("Historical Data Submissions/Alameda/CASE", i, ".csv"), colClasses = "character")}) %>%
  bind_rows()

original_field <- names(court_df)

names(court_df) <- c("case_id", "case_number", "jail_court_id", "pfn_x", "case_type_code", "case_type", "file_date", "case_status_code", "case_status", "case_status_date", "cii", "fbi", "dln", "dln_state", "dob", "dob_loc", "race_code", "race", "sex_code", "first_name", "last_name")

original_df[[3]] <- tibble(table_name = "court_df", original_field = original_field, modified_field = names(court_df))

court_df <- court_df %>%
  mutate(file_date = ymd(file_date))

# Court FTAs
court_fta <- lapply(c("", "_2"), function(i){
  fread(paste0("Historical Data Submissions/Alameda/FTA", i, ".csv"), colClasses = "character")}) %>%
  bind_rows()

original_field <- names(court_fta)

names(court_fta) <- c("case_id", "fta_date", "fta_id", "fta_type_code", "fta_type")

original_df[[4]] <- tibble(table_name = "court_fta", original_field = original_field, modified_field = names(court_fta))

court_fta <- court_fta %>%
  mutate(fta_date = ymd(fta_date))

# Court FTAs with Warrants
court_fta_war <- lapply(c("", "_2"), function(i){
  fread(paste0("Historical Data Submissions/Alameda/WARR", i, ".csv"), colClasses = "character")}) %>%
  bind_rows()

original_field <- names(court_fta_war)

names(court_fta_war) <- c("case_id", "fta_war_date", "fta_id", "fta_type_code", "fta_type")

original_df[[5]] <- tibble(table_name = "court_fta_war", original_field = original_field, modified_field = names(court_fta_war))

court_fta_war <- court_fta_war %>%
  mutate(fta_war_date = ymd(fta_war_date))

# Court Hearings
court_hearing <- lapply(1:8, function(i){
  fread(paste0("Historical Data Submissions/Alameda/HEA_", i, ".csv"), colClasses = "character")}) %>%
  bind_rows()

original_field <- names(court_hearing)

names(court_hearing) <- c("case_id", "case_number", "event_num", "event_id", "hearing_type_code", "hearing_type", "hearing_date", "hearing_time")

original_df[[6]] <- tibble(table_name = "court_hearing", original_field = original_field, modified_field = names(court_hearing))

court_hearing <- court_hearing %>%
  mutate(hearing_date_time = mdy_hms(paste(hearing_date, hearing_time), tz = "America/Los_Angeles"),
         hearing_date = mdy(hearing_date)) 
  # select(-hearing_time)

# Court Filing Charges
court_charge <- lapply(1:8, function(i){
  fread(paste0("Historical Data Submissions/Alameda/CHG_", i, ".csv"), colClasses = "character")}) %>%
  bind_rows()

original_field <- names(court_charge)

names(court_charge) <- c("case_id", "case_number", "event_num", "chare_id", "charge_history_id", "charge_number", "allegation", "qualifier", "offense_id", "charge", "charge_level", "event_date", "event_hist_id", "stage", "event_id", "event_type_code", "event_type", "amend_reason_id", "amend_reason")

original_df[[7]] <- tibble(table_name = "court_charge", original_field = original_field, modified_field = names(court_charge))

court_charge <- court_charge %>%
  mutate(event_date = ymd(event_date))

# Court Sentences to Confinement 
court_sent <- lapply(c("", "_2"), function(i){
  fread(paste0("Historical Data Submissions/Alameda/JAIL", i, ".csv"), colClasses = "character")}) %>%
  bind_rows()

original_field <- names(court_sent)

names(court_sent) <- c("case_id", "case_number", "event_num", "event_id", "sentence_date", "amend_reason_code", "amend_reason", "sentence_id", "component_instance_id", "start_date", "confinement_type_code", "confinement_type", "facilty_id", "facility", "term_type_code", "term_type", "term_years", "term_months", "term_days", "term_to_life", "life_flag", "death_flag")

original_df[[8]] <- tibble(table_name = "court_sent", original_field = original_field, modified_field = names(court_sent))

court_sent <- court_sent %>%
  mutate_at(vars(sentence_date, start_date), ymd)

# Court Sentences to Supervision
court_sup <- lapply(c("", "_2"), function(i){
  fread(paste0("Historical Data Submissions/Alameda/SUP", i, ".csv"), colClasses = "character")}) %>%
  bind_rows()

original_field <- names(court_sup)

names(court_sup) <- c("case_id", "case_number", "event_num", "event_id", "sentence_date", "amend_reason_code", "amend_reason", "sentence_id", "component_instance_id", "probation_type_code", "probation_type", "start_date", "end_date", "term_years", "term_months", "term_days", "latest_status_code", "latest_status")

original_df[[9]] <- tibble(table_name = "court_sup", original_field = original_field, modified_field = names(court_sup))

court_sup <- court_sup %>%
  mutate_at(vars(sentence_date, start_date, end_date), ymd)
```

Code Book
```{r eval=FALSE, include=FALSE}
rm(original_field)

original_df <- bind_rows(original_df)

Alameda_df <- lapply(ls()[!grepl("original", ls())], function(i){
  df <- get(i)
  
  if(sum(grepl("date", names(df))) > 0){
  df2 <- df %>%
  select(contains("date"), -contains("time")) %>%
  gather("modified_field", "value") %>%
  group_by(modified_field) %>%
  summarise_all(funs(min = as.character(min(., na.rm = T)), mean = as.character(mean(., na.rm = T)), max = as.character(max(., na.rm = T))))
  }else{
    df2 <- tibble(modified_field = NA_character_, min = NA_character_, mean = NA_character_, max = NA_character_)
  }
  
  df <- df %>%
    mutate_if(~length(unique(.)) > 50|is.Date(.)|is.POSIXct(.), ~(. = "not_factor")) %>%    
    mutate_all(~if_else(is.na(.), "na_missing", as.character(.))) %>%
    gather(modified_field, factor_value) %>%
    count(modified_field, factor_value) %>%
    mutate(table_name = i, county = "Alameda") %>%
    mutate(factor_flag = if_else(factor_value == "not_factor", 0, 1)) %>%
    group_by(table_name, modified_field) %>%
    mutate(table_count = sum(n)) %>%
    ungroup() %>%
    rename("factor_count" = "n") %>%
    mutate(factor_count = if_else(factor_value == "not_factor", NA_integer_, factor_count),
           factor_percent = round(factor_count/table_count*100, 1)) %>%
    arrange(desc(factor_flag), modified_field, desc(factor_count))
  
  df <- left_join(df, df2, by = "modified_field")
    }) %>% 
  bind_rows() %>%
  left_join(original_df) %>%
   select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_count,
           factor_percent, table_count, min, mean, max) 

write.xlsx(Alameda_df, file = "Code Books/Alameda Code Book.xlsx")
```

Join
```{r eval=FALSE, include=FALSE}
#Alameda has an integrated criminal justice system. Information is joined across agencies on the jail_court_ID. It is contained in the book_df, court_df, and book_charge tables. 

#Jail Court ID is duplicated when split between cases
book_df <- book_df %>% distinct(jail_court_id, .keep_all = T)

#Jail Court ID is duplicated when split between cases
court_df <- court_df %>% distinct(jail_court_id, .keep_all = T)

book_no_court <- anti_join(book_df, court_df, by = c("jail_court_id"))
nrow(book_df)
nrow(book_no_court)
nrow(book_no_court)/nrow(book_df)

court_no_book <- anti_join(court_df, book_df, by = c("jail_court_id"))
nrow(court_df)
nrow(court_no_book)
nrow(court_no_book)/nrow(court_df)
```

# Calaveras

Jail Data
```{r}
book_df <- read_excel("Historical Data Submissions/Calaveras/JailData.xlsx")

names(book_df) <- c("name", "cii", "fbi", "alpha_num", "dln", "race", "sex", "dob", "arrest_date", "book_num", "book_date", "book_type", "case_number", "charge", "charge_level", "bail_amt", "disposition_type", "disposition_date", "release_date", "release_type")

book_df <- book_df %>%
  mutate(arrest_date_time = mdy_hm(arrest_date),
         book_date_time = mdy_hm(book_date),
         arrest_date = as_date(arrest_date_time),
         book_date =as_date(book_date_time),
         dob = as_date(dob))
```

Probation Data
```{r}
prob_df <- read_excel("Historical Data Submissions/Calaveras/ProbationData.xlsx", col_types = "text")

names(prob_df) <- c("cii", "fbi", "dln", "local_id", "name", "dob", "sex", "race")

prob_df <- prob_df %>%
  mutate(dob = convertToDate(dob))
```

# Kings

Jail Data (Maybe all data?, no FTA information)
```{r}
original_df <- list()

book_df <- lapply(2015:2019, function(i){
  fread(paste0("Historical Data Submissions/Kings/Pretrial Pilot Program-", i, ".csv"))
}) %>% bind_rows()


#bunch of demo info that needs fixing
names(book_df) <- c("title", "demo_info", "book_num", "book_date", "book_type", "release_date", "release_type", "case_id", "charge_ref", "counts_ref", "charge_level_ref", "disposition_type_ref", "disposition_date_ref", "charge", "counts", "charge_level", "disposition_type", "disposition_date", "total")

book_df <- book_df %>%
  separate(demo_info, paste("x", 1:20, sep = "_"), sep = "\\\r\\\n") %>%
  separate(x_20, paste("y", 1:5, sep = "_"), sep = ":") %>%
  rename(cii = y_2, fbi = y_3, local_id = y_4, employed = y_5, dob = x_8, gender = x_10, race = x_12, dln = x_15,
         dln_state = x_17) %>%
  unite(name, c(x_3, x_5, x_1), sep = " ") %>%
  select(-c(x_2, x_4, x_6, x_7, x_9, x_11, x_13, x_14, x_16, x_18, x_19, y_1)) %>%
  mutate(cii = gsub(" FBI", "", cii),
         fbi = gsub(" Local ID", "", fbi),
         local_id = gsub(" Employer", "", local_id),
         employed = if_else(employed != " ", 1, 0),
         total = parse_number(total)) %>%
  mutate_at(vars(book_num:case_id), funs(gsub(".*: ","",.))) %>%
  select(-contains("ref"), -title) %>%
  mutate(dob = mdy(dob),
         book_date_time = mdy_hm(book_date),
         release_date_time = mdy_hm(release_date),
         book_date = as_date(book_date_time),
         release_date = as_date(release_date_time),
         disposition_date = as_date(mdy_hms(disposition_date)))

original_field <- names(book_df)

original_df[[1]] <- tibble(table_name = "book_df", original_field = original_field, modified_field = names(book_df))
```

```{r}
rm(original_field)

original_df <- bind_rows(original_df)

Kings_df <- lapply(ls()[!grepl("original", ls())], function(i){
  df <- get(i)
  
  if(sum(grepl("date", names(df))) > 0){
  df2 <- df %>%
  select(contains("date"), -contains("time")) %>%
  gather("modified_field", "value") %>%
  group_by(modified_field) %>%
  summarise_all(funs(min = as.character(min(., na.rm = T)), mean = as.character(mean(., na.rm = T)), max = as.character(max(., na.rm = T))))
  }else{
    df2 <- tibble(modified_field = NA_character_, min = NA_character_, mean = NA_character_, max = NA_character_)
  }
  
  df <- df %>%
    mutate_if(~length(unique(.)) > 50|is.Date(.)|is.POSIXct(.), ~(. = "not_factor")) %>%    
    mutate_all(~if_else(is.na(.), "na_missing", as.character(.))) %>%
    gather(modified_field, factor_value) %>%
    count(modified_field, factor_value) %>%
    mutate(table_name = i, county = "Kings") %>%
    mutate(factor_flag = if_else(factor_value == "not_factor", 0, 1)) %>%
    group_by(table_name, modified_field) %>%
    mutate(table_count = sum(n)) %>%
    ungroup() %>%
    rename("factor_count" = "n") %>%
    mutate(factor_count = if_else(factor_value == "not_factor", NA_integer_, factor_count),
           factor_percent = round(factor_count/table_count*100, 1)) %>%
    arrange(desc(factor_flag), modified_field, desc(factor_count))
  
  df <- left_join(df, df2, by = "modified_field")
    }) %>% 
  bind_rows() %>%
  left_join(original_df) %>%
   select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_count,
           factor_percent, table_count, min, mean, max) 

write.xlsx(Kings_df, file = "Code Books/Kings Code Book.xlsx")
```

# Los Angeles

Jail Data
```{r}
original_df <- list()

# Jail Bookings--Historical and Q1
book_df <- lapply(2015:2019, function(i){
  read_xlsx(paste0("Historical Data Submissions/Los Angeles/",i, "_data_fields_added.xlsx"))}) %>%
  bind_rows()

book_df_q1 <- read_xlsx("Historical Data Submissions/Los Angeles/LACounty_July_Dec2019.xlsx")
names(book_df_q1) <- names(book_df)

book_df <- bind_rows(book_df, book_df_q1) %>% distinct()
rm(book_df_q1)

original_field <- names(book_df)

names(book_df) <- c("last_name", "first_name", "dob", "race", "gender", "dln", "cii", "arrest_date", "book_date", "book_num", "case_num", "charge", "charge_level", "release_date", "release_type", "bail")

original_df[[1]] <- tibble(table_name = "book_df", original_field = original_field, modified_field = names(book_df))
```

Court Data
```{r}
# Court Information
court_df <- fread("Historical Data Submissions/Los Angeles/JCC-historical-court-cases2.csv",
                  sep = "|")

original_field <- names(court_df)

names(court_df) <- c("row_num", "case_id", "case_num", "person_id", "cii", "first_name", "last_name", "dob", "gender", "race", "file_date", "charge_id", "count", "code_type", "charge", "charge_level", "disposition_id", "disposition_type", "disposition_code", "disposition_date", "sentence_time", "fine_amt", "sentence_time_code", "sentence_location", "fine_or_jail_code", "probation_code", "probation_length", "probation_length_code", "probation_andor_code", "book_num")

original_df[[2]] <- tibble(table_name = "court_df", original_field = original_field, modified_field = names(court_df))

court_df <- court_df %>%
  mutate_at(vars(contains("date"), dob), as_date)


# Court FTA Data
court_fta <- fread("Historical Data Submissions/Los Angeles/JCC-historical-bench-warrants2.csv", 
                   sep = "|")

original_field <- names(court_fta)

names(court_fta) <- c("row_num", "case_id", "case_num", "warrant_id", "warrant_issue_date", "warrant_disposition_date")

original_df[[3]] <- tibble(table_name = "court_fta", original_field = original_field, modified_field = names(court_fta))

court_fta <- court_fta %>%
  mutate_at(vars(contains("date")), as_date)
```

Probation (assessment) Data
```{r}
#OR Risk Assessment--Arraignment Favorable, Ineligible, and Unfavorable
assess_OR <- read_excel("Historical Data Submissions/Los Angeles/Los Angeles County JCC Data - Arraignment Favorable Recommendations (2015-01 to 2019-09).xlsx")

assess_OR2 <- read_excel("Historical Data Submissions/Los Angeles/Los Angeles County JCC Data - Arraignment Ineligible Applications (2015-01 to 2019-09).xlsx") %>% mutate(`Score(s)` = as.numeric(`Score(s)`), Termination_Date = as_datetime(Termination_Date))

assess_OR3 <- read_excel("Historical Data Submissions/Los Angeles/Los Angeles County JCC Data - Arraignment Unfavorable Recommendations (2015-01 to 2019-09).xlsx") %>% mutate(Termination_Date = as_datetime(Termination_Date))

assess_OR <- bind_rows(assess_OR, assess_OR2, assess_OR3)

rm(assess_OR2, assess_OR3)

original_field <- names(assess_OR)

names(assess_OR) <- c("application_id", "application_type", "tool_name", "assessment_date_time", "zip_code", "tool_response1", "tool_response2", "tool_response3", "tool_response4", "tool_response5", "tool_response6", "tool_response7", "tool_response8", "tool_response9", "tool_response10", "tool_response11", "tool_response12", "tool_response13", "tool_response14", "score", "recommendation", "release_date", "release_authorization", "release_type", "pretrial_conditions", "pretrial_violation", "pretrial_violation_date", "court_date_reminder", "other_pretrial_service", "termination_outcome", "termination_date", "cii", "fbi", "dln", "local_id", "name", "dob", "gender", "race", "tool_not_administered")

original_df[[4]] <- tibble(table_name = "assess_OR", original_field = original_field, modified_field = names(assess_OR))

assess_OR <- assess_OR %>%
  mutate(assessment_date = as_date(assessment_date_time),
         release_date = convertToDate(as.numeric(release_date))) %>%
  mutate_at(vars(termination_date, dob, pretrial_violation_date), as_date) %>%
  separate(name, c("last_name", "first_name"))


#BD Point Scale--Bail Increase, Bail Increae Denied, Not Qualified, Released OR, Bail Reduction Granted, and Bail Reduction Denied
assess_BD <- read_excel("Historical Data Submissions/Los Angeles/Los Angeles County JCC Data - Pre-arraignment Bail Increase and Ineligible Subjects (2015-01 to 2019-09).xlsx", 
                      sheet = 1) %>%  mutate(`Score(s)` = as.numeric(`Score(s)`))

assess_BD2 <- read_excel("Historical Data Submissions/Los Angeles/Los Angeles County JCC Data - Pre-arraignment Bail Increase and Ineligible Subjects (2015-01 to 2019-09).xlsx", 
                      sheet = 2) %>% mutate(Assessment_Date_Time = convertToDateTime(Assessment_Date_Time))

assess_BD3 <- read_excel("Historical Data Submissions/Los Angeles/Los Angeles County JCC Data - Pre-arraignment Bail Increase and Ineligible Subjects (2015-01 to 2019-09).xlsx", 
                      sheet = 3) %>% mutate(`Score(s)` = as.numeric(`Score(s)`))

assess_BD4 <- read_excel("Historical Data Submissions/Los Angeles/Los Angeles County JCC Data - Pre-arraignment OR Release and Bail Reductions Granted (2015-01 to 2019-09).xlsx", 
                      sheet = 1)

assess_BD5 <- read_excel("Historical Data Submissions/Los Angeles/Los Angeles County JCC Data - Pre-arraignment OR Release and Bail Reductions Granted (2015-01 to 2019-09).xlsx", 
                      sheet = 2)

assess_BD6 <- read_excel("Historical Data Submissions/Los Angeles/Los Angeles County JCC Data - Pre-arraignment OR Release Denied (2015-01 to 2019-09).xlsx")

assess_BD <- bind_rows(assess_BD2, assess_BD3, assess_BD4, assess_BD5, assess_BD6, assess_BD)

rm(assess_BD2, assess_BD3, assess_BD4, assess_BD5, assess_BD6)

original_field <- names(assess_BD)

names(assess_BD) <- c("application_id", "application_type", "tool_name", "assessment_date_time", "zip_code", "tool_response1", "tool_response2", "tool_response3", "tool_response4", "tool_response5", "tool_response6", "tool_response7", "tool_response8", "tool_response9", "tool_response10", "tool_response11", "tool_response12", "tool_response13", "tool_response14", "tool_response15", "score", "recommendation", "release_date", "release_authorization", "release_type", "pretrial_conditions", "pretrial_violation", "pretrial_violation_date", "court_date_reminder", "other_pretrial_service", "termination_outcome", "termination_date", "cii", "fbi", "dln", "local_id", "name", "dob", "gender", "race", "tool_not_administered")

original_df[[5]] <- tibble(table_name = "assess_BD", original_field = original_field, modified_field = names(assess_BD))

assess_BD <- assess_BD %>%
  mutate(assessment_date = as_date(assessment_date_time),
         release_date = convertToDate(as.numeric(release_date)),
         termination_date = mdy(paste(termination_date, year(assessment_date), sep = "/")),
         dob = as_date(dob),
         pretrial_violation_date = convertToDate(pretrial_violation_date)) %>%
  separate(name, c("last_name", "first_name"))

# Probation EM Responses
assess_EM_response <- read_excel("Historical Data Submissions/Los Angeles/California JCC Historical EM Records (Revised 2019-11-25).xlsx", sheet = 2)

original_field <- names(assess_EM_response)

names(assess_EM_response) <- c("key", "tool_question", "tool_response", "score")

original_df[[6]] <- tibble(table_name = "assess_EM_response", original_field = original_field, modified_field = names(assess_EM_response))

#Probation EM Total 
assess_EM <- read_excel("Historical Data Submissions/Los Angeles/California JCC Historical EM Records (Revised 2019-11-25).xlsx", 
                      sheet = 1)

original_field <- names(assess_EM)

names(assess_EM) <- c("key", "application_id", "cii", "fbi", "local_id", "dln", "first_name", "last_name", "dob", "sex", "race", "application_id_redundant", "tool_name", "assessment_date_time", "zip_code", "tool_response", "score","score_collapse", "recommendation", "release_authorization", "release_type", "release_date_time","pretrial_conditions","pretrial_violation", "pretrial_violation_date", "court_date_reminder", "other_pretrial_service", "termination_outcome", "termination_date")

original_df[[7]] <- tibble(table_name = "assess_EM", original_field = original_field, modified_field = names(assess_EM))

assess_EM <- assess_EM %>%
  select(-application_id_redundant) %>%
  mutate(assessment_date = as_date(assessment_date_time),
         release_date = as_date(release_date_time)) %>%
  mutate_at(vars(dob, pretrial_violation_date, termination_date), as_date)
```

Code Book
```{r eval=FALSE, include=FALSE}
rm(original_field)

original_df <- bind_rows(original_df)

Los_Angeles_df <- lapply(ls()[!grepl("original", ls())], function(i){
  df <- get(i)
  
  if(sum(grepl("date", names(df))) > 0){
  df2 <- df %>%
  select(contains("date"), -contains("time"), -contains("reminder")) %>%
  gather("modified_field", "value") %>%
  group_by(modified_field) %>%
  summarise_all(funs(min = as.character(min(., na.rm = T)), mean = as.character(mean(., na.rm = T)), 
                     max = as.character(max(., na.rm = T))))
  }else{
    df2 <- tibble(modified_field = NA_character_, min = NA_character_, mean = NA_character_, max = NA_character_)
  }
  
  df <- df %>%
    mutate_if(~length(unique(.)) > 50|is.Date(.)|is.POSIXct(.), ~(. = "not_factor")) %>%    
    mutate_all(~if_else(is.na(.), "na_missing", as.character(.))) %>%
    gather(modified_field, factor_value) %>%
    count(modified_field, factor_value) %>%
    mutate(table_name = i, county = "Los Angeles") %>%
    mutate(factor_flag = if_else(factor_value == "not_factor", 0, 1)) %>%
    group_by(table_name, modified_field) %>%
    mutate(table_count = sum(n)) %>%
    ungroup() %>%
    rename("factor_count" = "n") %>%
    mutate(factor_count = if_else(factor_value == "not_factor", NA_integer_, factor_count),
           factor_percent = round(factor_count/table_count*100, 1)) %>%
    arrange(desc(factor_flag), modified_field, desc(factor_count))
  
  df <- left_join(df, df2, by = "modified_field")
    }) %>% 
  bind_rows() %>%
  left_join(original_df) %>%
   select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_count,
           factor_percent, table_count, min, mean, max) 

write.xlsx(Los_Angeles_df, file = "Code Books/Los Angeles Code Book.xlsx")
```


Join
```{r eval=FALSE, include=FALSE}
#Alameda has an integrated criminal justice system. Information is joined across agencies on the jail_court_ID. It is contained in the book_df, court_df, and book_charge tables. 

#Jail Court ID is duplicated when split between cases
book_df <- book_df %>% distinct(jail_court_id, .keep_all = T)

#Jail Court ID is duplicated when split between cases
court_df <- court_df %>% distinct(jail_court_id, .keep_all = T)

book_no_court <- anti_join(book_df, court_df, by = c("jail_court_id"))
nrow(book_df)
nrow(book_no_court)
nrow(book_no_court)/nrow(book_df)

court_no_book <- anti_join(court_df, book_df, by = c("jail_court_id"))
nrow(court_df)
nrow(court_no_book)
nrow(court_no_book)/nrow(court_df)
```

# Modoc

Jail Data
```{r}
#Booking data
book_df <- fread("Historical Data Submissions/Modoc/Modoc Jail Pretrial  January 1 2013-November 30 2019.csv")

#The first 7 observations are test inputs
book_df <- book_df[8:length(book_df),]
```

Court Data 
```{r}
court_df <- read_excel("Historical Data Submissions/Modoc/Modoc Pretrial Assessment Information.xls", sheet = 1)

names(court_df) <- c("case_id", "name", "disposition_type", "disposition_date", "filing_date", "case_type")

court_charge <- read_excel("Historical Data Submissions/Modoc/Modoc Pretrial Assessment Information.xls", sheet = 2)

names(court_charge) <- c("case_id", "counts", "charge", "charge_level", "charge_description", "disposition_type", "disposition_date", "plea_type", "plea_date")

court_sent <- read_excel("Historical Data Submissions/Modoc/Modoc Pretrial Assessment Information.xls", sheet = 3)

names(court_sent) <- c("case_id", "sentence_date", "sentence_type", "term", "term_suspended", "sentence_location", "sentence_status", "count", "charge")

court_hearing <- read_excel("Historical Data Submissions/Modoc/Modoc Pretrial Assessment Information.xls", sheet = 4)

names(court_hearing) <- c("case_id", "hearing_type", "hearing_date", "hearing_time", "hearing_result")

court_lawyer <- read_excel("Historical Data Submissions/Modoc/Modoc Pretrial Assessment Information.xls", sheet = 5)

names(court_lawyer) <- c("case_id", "lawyer_type", "appointment_date", "appointment_status", "appointment_end_date")

court_person <- read_excel("Historical Data Submissions/Modoc/Modoc Pretrial Assessment Information.xls", sheet = 6)

names(court_person) <- c("first_name", "last_name", "dob", "sex", "race", "cii", "fbi", "arrest_num", "book_num")

court_bail <- read_excel("Historical Data Submissions/Modoc/Modoc Pretrial Assessment Information.xls", sheet = 7)

names(court_bail) <- c("case_id", "release_type", "release_date", "bail_status", "bail_status_date")

court_fta <- read_excel("Historical Data Submissions/Modoc/Modoc Pretrial Assessment Information.xls", sheet = 8)

names(court_fta) <- c("case_id", "fta_date", "fta")

court_fta_war <- read_excel("Historical Data Submissions/Modoc/Modoc Pretrial Assessment Information.xls", sheet = 9)

names(court_fta_war) <- c("case_id", "fta_date", "fta")
```

# Napa

Jail Data
```{r}
original_df <- list()

#Jail Demographic and Personal Identification
person_df <- read_excel("Historical Data Submissions/Napa/Historical_1.xlsx", sheet = 1)

original_field <- names(person_df)

names(person_df) <- c("cii", "fbi", "local_id", "dln", "dln_state", "name", "dob", "sex", "race")

original_df[[1]] <- tibble(table_name = "person_df", original_field = original_field, modified_field = names(person_df))

#Jail Booking Events 
book_df <- read_excel("Historical Data Submissions/Napa/Historical_1.xlsx", sheet = 2, col_types = "text")

original_field <- names(book_df)

names(book_df) <- c("book_num", "arrest_date", "case_id", "local_id", "book_type", "book_date", "release_date", "release_type")

original_df[[2]] <- tibble(table_name = "book_df", original_field = original_field, modified_field = names(book_df))

book_df <- book_df %>%
  mutate(release_date = convertToDate(release_date)) %>%
  mutate_at(vars(arrest_date, book_date),  funs("time" = convertToDateTime(.))) %>%
  mutate_at(vars(arrest_date, book_date), convertToDate)
```

DA Data (contains filing dates)
```{r}
#Filing Dates
da_df <- read_excel("Historical Data Submissions/Napa/Historical_1.xlsx", sheet = 3)

original_field <- names(da_df)

names(da_df) <- c("case_id", "local_id", "file_date", "case_status", "case_status_date")

original_df[[3]] <- tibble(table_name = "da_df", original_field = original_field, modified_field = names(da_df))

da_df <- da_df %>%
  mutate(file_date_time = file_date,
         case_status_date_time = case_status_date) %>%
  mutate_at(vars(file_date, case_status_date), as_date)

#Da Charges
da_charge <- read_excel("Historical Data Submissions/Napa/Historical_1.xlsx", sheet = 4)

original_field <- names(da_charge)

names(da_charge) <- c("case_id", "local_id", "charge", "charge_description", "charge_level", "plea_type")

original_df[[4]] <- tibble(table_name = "da_charge", original_field = original_field, modified_field = names(da_charge))
```

Court Data
```{r}
#Court Data on FTAs
court_df <- read_excel("Historical Data Submissions/Napa/Historical_1.xlsx", sheet = 5)

original_field <- names(court_df)

names(court_df) <- c("case_id", "local_id", "fta", "fta_warrant")

original_df[[5]] <- tibble(table_name = "court_df", original_field = original_field, modified_field = names(court_df))

#Court Charges
court_charge <- read_excel("Historical Data Submissions/Napa/Historical_1.xlsx", sheet = 6)

original_field <- names(court_charge)

names(court_charge) <- c("case_id", "local_id", "charge", "charge_description", "dispostion_type", "disposition_date", "sentence_type", "sentence_date")

original_df[[6]] <- tibble(table_name = "court_charge", original_field = original_field, modified_field = names(court_charge))

court_charge <- court_charge %>%
  mutate_at(vars(contains("date")), convertToDate)

#Court FTA Warrants
court_fta_war <- read_excel("Historical Data Submissions/Napa/Historical_1.xlsx", sheet = 7)

original_field <- names(court_fta_war)

names(court_fta_war) <- c("case_id", "local_id", "fta_war_date")

original_df[[7]] <- tibble(table_name = "court_fta_war", original_field = original_field, modified_field = names(court_fta_war))

#Court FTAs
court_fta <- read_excel("Historical Data Submissions/Napa/Historical_1.xlsx", sheet = 8)

original_field <- names(court_fta)

names(court_fta) <- c("case_id", "local_id", "fta_date")

original_df[[8]] <- tibble(table_name = "court_fta", original_field = original_field, modified_field = names(court_fta))
```

Assessment Data
```{r}
prob_df <- read_excel("Historical Data Submissions/Napa/Assessment_Historical.xlsx")

original_field <- names(prob_df)

names(prob_df) <- c("tool_name", "local_id", "zip_code", "assessment_date", "item_label", "assessment_item", "assessment_response", "risk_score", "risk_level")

original_df[[9]] <- tibble(table_name = "prob_df", original_field = original_field, modified_field = names(prob_df))
```

Code Book
```{r eval=FALSE, include=FALSE}
rm(original_field)

original_df <- bind_rows(original_df)

Napa_df <- lapply(ls()[!grepl("original", ls())], function(i){
  df <- get(i)
  
  if(sum(grepl("date", names(df))) > 0){
  df2 <- df %>%
  select(contains("date"), -contains("time")) %>%
  gather("modified_field", "value") %>%
  group_by(modified_field) %>%
  summarise_all(funs(min = as.character(min(., na.rm = T)), mean = as.character(mean(., na.rm = T)), max = as.character(max(., na.rm = T))))
  }else{
    df2 <- tibble(modified_field = NA_character_, min = NA_character_, mean = NA_character_, max = NA_character_)
  }
  
  df <- df %>%
    mutate_if(~length(unique(.)) > 50|is.Date(.)|is.POSIXct(.), ~(. = "not_factor")) %>%    
    mutate_all(~if_else(is.na(.), "na_missing", as.character(.))) %>%
    gather(modified_field, factor_value) %>%
    count(modified_field, factor_value) %>%
    mutate(table_name = i, county = "Napa") %>%
    mutate(factor_flag = if_else(factor_value == "not_factor", 0, 1)) %>%
    group_by(table_name, modified_field) %>%
    mutate(table_count = sum(n)) %>%
    ungroup() %>%
    rename("factor_count" = "n") %>%
    mutate(factor_count = if_else(factor_value == "not_factor", NA_integer_, factor_count),
           factor_percent = round(factor_count/table_count*100, 1)) %>%
    arrange(desc(factor_flag), modified_field, desc(factor_count))
  
  df <- left_join(df, df2, by = "modified_field")
    }) %>% 
  bind_rows() %>%
  left_join(original_df) %>%
   select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_count,
           factor_percent, table_count, min, mean, max) 

write.xlsx(Napa_df, file = "Code Books/Napa Code Book.xlsx")
```

# Nevada-Sierra

Jail Data
```{r}
book_df <- read_excel("Historical Data Submissions/Nevada/SO Pretrial Submitted Data.xlsx")

names(book_df) <- c("cii", "name", "dob", "arrest_date", "book_num", "book_date", "book_type", "case_id", "charge", "charge_level", "release_date", "fbi", "dln", "sex", "race", "bail_amt", "employment_status", "county")
```

Probation Data (Assessment Data, needs fixing)
```{r}
prob_df <- lapply(c("2016.", "2017.", "2018. "), function(i){
  lapply(getSheetNames(paste0("Historical Data Submissions/Nevada/PRETRIAL STATS ", i, "Nevada.xlsx")), function(j){
    read_excel(paste0("Historical Data Submissions/Nevada/PRETRIAL STATS ", i, "Nevada.xlsx"), 
               col_names = F, sheet = j, col_types = "text")
}) %>% bind_rows() 
}) %>% bind_rows()

names(prob_df) <- c("name", "charge", "charge_level", "risk_score", "risk_level", "sex", "age", "book_date", "release_date", "po", "ref", "or_flag", "or_condition_flag", "gps_flag", "alcohol_flag", "denied_flag", "other_flag", "termination_type", "termination_date", "termination_reason", "pretrial_recommendation", "pretrial_decision")

prob_df <- prob_df %>%
  filter(grepl("^[0-9]", charge))
```

# Sacramento
- Everything is Join

Jail Data
```{r}
original_df <- list()

# Jail Bookings
book_df <- fread("Historical Data Submissions/Sacramento/SacBookingDetail.csv") %>%
  bind_rows(fread("Historical Data Submissions/Sacramento/SacBookingDetail10012019.csv"))

original_field <- names(book_df)

names(book_df) <- c("jail_court_id", "book_date_wrong", "release_date_wrong", "registry_num", "registry_sub_num", "book_type_code", "book_type", "charge_level", "charge", "charge_description", "release_type_code", "release_type", "release_comment", "charge_date", "charge_release_date", "court_combined_id", "court_id", "case_id", "release_line")

original_df[[1]] <- tibble(table_name = "book_df", original_field = original_field, modified_field = names(book_df))

book_df <- book_df %>%
  select(-matches("date"))

#Booking Dates
book_date <- fread("Historical Data Submissions/Sacramento/SacBookingMain.csv") %>%
  bind_rows(fread("Historical Data Submissions/Sacramento/SacBookingMain10012019.csv"))

original_field <- names(book_date)

names(book_date) <- c("jail_court_id", "registry_num", "book_date", "release_date", "hours_detained", "days_detained")

original_df[[2]] <- tibble(table_name = "book_date", original_field = original_field, modified_field = names(book_date))

book_date <- book_date %>%
  mutate_at(vars(book_date, release_date), funs(time = as_datetime(., tz = 'America/Los_Angeles'))) %>%
  mutate(book_date = as_date(book_date_time),
         release_date = as_date(release_date_time))

#Jail Bail Amounts
book_bail <- fread("Historical Data Submissions/Sacramento/SacBail.csv") %>%
  bind_rows(fread("Historical Data Submissions/Sacramento/SacBail10012019.csv"))

original_field <- names(book_bail)

names(book_bail) <- c("jail_court_id", "registry_num", "registry_sub_num", "book_type_code", "bail_amt")

original_df[[3]] <- tibble(table_name = "book_bail", original_field = original_field, modified_field = names(book_bail))
```

Court Data
```{r}
#High level casees
court_df <- fread("Historical Data Submissions/Sacramento/SacCases.csv") %>%
  bind_rows(fread("Historical Data Submissions/Sacramento/SacCases10102019.csv"))

original_field <- names(court_df)

names(court_df) <- c("jail_court_id", "court_combined_id", "court_id", "case_id", "file_date", "case_status", "status_description", "status_date")

original_df[[4]] <- tibble(table_name = "court_df", original_field = original_field, modified_field = names(court_df))

court_df <- court_df %>%
  mutate(file_date = as_date(file_date))

#Court Hearing Data
court_hearing <- fread("Historical Data Submissions/Sacramento/SacAppear.csv") %>%
  bind_rows(fread("Historical Data Submissions/Sacramento/SacAppear10012019.csv"))

original_field <- names(court_hearing)

names(court_hearing) <- c("jail_court_id", "court_combined_id", "court_id", "case_id", "hearing_date", "hearing_type_code", "hearing_type", "hearing_comment", "hearing_result_code", "hearing_result", "hearing_result_comment")

original_df[[5]] <- tibble(table_name = "court_hearing", original_field = original_field, modified_field = names(court_hearing))

court_hearing <- court_hearing %>%
  mutate(hearing_date_time = as_datetime(hearing_date, tz = 'America/Los_Angeles'),
         hearing_date = as_date(hearing_date_time))

#Court case dispostions
court_dispos <- fread("Historical Data Submissions/Sacramento/SacDispos.csv") %>%
  bind_rows(fread("Historical Data Submissions/Sacramento/SacDispos10012019.csv"))

original_field <- names(court_dispos)

names(court_dispos) <- c("jail_court_id", "court_combined_id", "court_id", "case_id", "please_code", "charge_dispo_code", "case_charge_code", "charge_level", "charge", "disposition_date")

original_df[[6]] <- tibble(table_name = "court_dispos", original_field = original_field, modified_field = names(court_dispos))

court_dispos <- court_dispos %>%
  mutate(disposition_date = as_date(disposition_date))

#Court person ids
court_person <- fread("Historical Data Submissions/Sacramento/SacPersonDetail.csv") %>%
  bind_rows(fread("Historical Data Submissions/Sacramento/SacPersonDetail10012019.csv"))

original_field <- names(court_person)

names(court_person) <- c("jail_court_id", "first_name", "last_name", "name", "sex", "race", "dob", "cii", "fbi", "dln")

original_df[[7]] <- tibble(table_name = "court_person", original_field = original_field, modified_field = names(court_person))

court_person <- court_person %>%
  mutate(dob = ymd(gsub(" .*", "", trimws(dob))))

#Court Warrants
court_warrants <- fread("Historical Data Submissions/Sacramento/SacWarrants.csv") %>%
  bind_rows(fread("Historical Data Submissions/Sacramento/SacWarrants10012019.csv"))

original_field <- names(court_warrants)

names(court_warrants) <- c("jail_court_id", "court", "warrant_num", "warrant_id", "warrant_status", "charge_level", "warrant_type", "judge", "judge_comment", "complaint_lea", "lea_loc", "lea", "lea_foreign", "lea_hold", "charges_comments", "warrant_date", "warrant_clear_date", "warrant_duration", "bail_amt", "no_bail_flag", "case_id", "mandatory_appear_flag")

original_df[[8]] <- tibble(table_name = "court_warrants", original_field = original_field, modified_field = names(court_warrants))

court_warrants <- court_warrants %>%
  select(-judge) %>%
  mutate_at(vars(warrant_date, warrant_clear_date), as_date)
```

Code Book
```{r eval=FALSE, include=FALSE}
rm(original_field)

original_df <- bind_rows(original_df)

Sacramento_df <- lapply(ls()[!grepl("original", ls())], function(i){
  df <- get(i)
  
  if(sum(grepl("date", names(df))) > 0){
  df2 <- df %>%
  select(contains("date"), -contains("time")) %>%
  gather("modified_field", "value") %>%
  group_by(modified_field) %>%
  summarise_all(funs(min = as.character(min(., na.rm = T)), mean = as.character(mean(., na.rm = T)), max = as.character(max(., na.rm = T))))
  }else{
    df2 <- tibble(modified_field = NA_character_, min = NA_character_, mean = NA_character_, max = NA_character_)
  }
  
  df <- df %>%
    mutate_if(~length(unique(.)) > 50|is.Date(.)|is.POSIXct(.), ~(. = "not_factor")) %>%    
    mutate_all(~if_else(is.na(.), "na_missing", as.character(.))) %>%
    gather(modified_field, factor_value) %>%
    count(modified_field, factor_value) %>%
    mutate(table_name = i, county = "Sacramento") %>%
    mutate(factor_flag = if_else(factor_value == "not_factor", 0, 1)) %>%
    group_by(table_name, modified_field) %>%
    mutate(table_count = sum(n)) %>%
    ungroup() %>%
    rename("factor_count" = "n") %>%
    mutate(factor_count = if_else(factor_value == "not_factor", NA_integer_, factor_count),
           factor_percent = round(factor_count/table_count*100, 1)) %>%
    arrange(desc(factor_flag), modified_field, desc(factor_count))
  
  df <- left_join(df, df2, by = "modified_field")
    }) %>% 
  bind_rows() %>%
  left_join(original_df) %>%
   select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_count,
           factor_percent, table_count, min, mean, max) 

write.xlsx(Sacramento_df, file = "Code Books/Sacramento Code Book.xlsx")
```

# San Joaquin
- Everything is Join

Jail Data
```{r}
original_df <- list()

#Booking Data
book_df <- fread("Historical Data Submissions/San Joaquin/Jail_ATIMS_Data_BOOKING_20150101_to_20190930_3.csv")

original_field <- names(book_df)

names(book_df) <- c("book_num", "lar", "case_id", "bail_amt", "arrest_date", "book_date", "book_type", 
                    "release_date", "release_type")

original_df[[1]] <- tibble(table_name = "book_df", original_field = original_field, modified_field = names(book_df))

book_df <- book_df %>%
  mutate_at(vars(contains("date")), mdy)


#Booking Charges
book_charge <- fread("Historical Data Submissions/San Joaquin/Jail_ATIMS_Data_CHARGES_20150101_to_20190930_3.csv")

original_field <- names(book_charge)

names(book_charge) <- c("book_num", "count", "charge_code", "charge", "charge_description", "charge_level")

original_df[[2]] <- tibble(table_name = "book_charge", original_field = original_field, modified_field = names(book_charge))


#Booking Demographics
book_demo <- fread("Historical Data Submissions/San Joaquin/Jail_ATIMS_Data_PARTY_20150101_to_20190930_3.csv")

original_field <- names(book_demo)

names(book_demo) <- c("lar", "cii", "first_name", "last_name", "dln", "dln_state", "dob", "sex", "race")

original_df[[3]] <- tibble(table_name = "book_demo", original_field = original_field, modified_field = names(book_demo))

book_demo <- book_demo %>%
  mutate(dob = if_else(mdy(dob) > "2002-01-01", mdy(dob) - years(100), mdy(dob)))


#Booking Codes
book_ipid <- fread("Historical Data Submissions/San Joaquin/Jail_ATIMS_Data_LAR_to_IPID_20150101_to_20190930_3.csv")

original_field <- names(book_ipid)

names(book_ipid) <- c("lar", "ipid")

original_df[[4]] <- tibble(table_name = "book_ipid", original_field = original_field, modified_field = names(book_ipid))
```

Court Data
```{r}
#Court Cases High level 
court_df <- fread("Historical Data Submissions/San Joaquin/pretrial case.csv")

original_field <- names(court_df)

names(court_df) <- c("ipid", "court_id", "case_id", "case_id_previous", "complaint_id", "file_date", "case_status", "case_status_date")

original_df[[5]] <- tibble(table_name = "court_df", original_field = original_field, modified_field = names(court_df))

court_df <- court_df %>%
  mutate_at(vars(contains("date")), as_date)

#Court Charges
court_charge <- lapply(1:4, function(i){
  fread(paste0("Historical Data Submissions/San Joaquin/pretrial charge ", i, ".csv"), colClasses = "character")}) %>%
  bind_rows()

original_field <- names(court_charge)

names(court_charge) <- c("ipid", "court_id", "case_id", "complaint_id", "charge", "charge_level", "charge_description", 
                         "count", "qualifier", "police_reference", "disposition_type", "disposition_date", "sentence_date", "disposition_result", "dispostion_final_date", "seentence_final_date", "confinement_type", "confinement_facilty", "confinement_date", "confinement_end_date", "term_years", "term_months", "term_days", "today", "to_date", "term_to_days", "term_life", "result_id")

original_df[[6]] <- tibble(table_name = "court_charge", original_field = original_field, modified_field = names(court_charge))

court_charge <- court_charge %>%
  mutate_at(vars(contains("date"), today), as_date)


#Court Hearing Data
court_hearing <- fread("Historical Data Submissions/San Joaquin/pretrial hearing.csv")

original_field <- names(court_hearing)

names(court_hearing) <- c("case_id", "case_type", "hearing_date", "hearing_type")

original_df[[7]] <- tibble(table_name = "court_hearing", original_field = original_field, modified_field = names(court_hearing))

court_hearing <- court_hearing %>%
  mutate(hearing_date = as_date(hearing_date))


#Court Demographics
court_person <- fread("Historical Data Submissions/San Joaquin/pretrial party.csv")

original_field <- names(court_person)

names(court_person) <- c("ipid", "court_id", "last_name", "first_name", "dob", "gender", "race", "ethnicity", "dln", "dln_state")

original_df[[8]] <- tibble(table_name = "court_person", original_field = original_field, modified_field = names(court_person))

court_person <- court_person %>%
  mutate(dob = as_date(dob))


#Court FTAs
court_fta <- fread("Historical Data Submissions/San Joaquin/pretrial FTA by hearing.csv")

original_field <- names(court_fta)

names(court_fta) <- c("case_id", "case_type", "hearing_date", "hearing_type")

original_df[[9]] <- tibble(table_name = "court_fta", original_field = original_field, modified_field = names(court_fta))

court_fta <- court_fta %>%
  mutate(hearing_date = as_date(hearing_date))


#Court FTA Warrants
court_fta_warrant <- fread("Historical Data Submissions/San Joaquin/pretrial FTA by warrant.csv")

original_field <- names(court_fta_warrant)

names(court_fta_warrant) <- c("case_id", "case_type", "warrant_num", "fta_warrant_date")

original_df[[10]] <- tibble(table_name = "court_fta_warrant", original_field = original_field, modified_field = names(court_fta_warrant))

court_fta_warrant <- court_fta_warrant %>%
  mutate(fta_warrant_date = as_date(fta_warrant_date))
```

DA data 
```{r}
#DA Info
da_df <- fread("Historical Data Submissions/San Joaquin/pretrial booking.csv")

original_field <- names(da_df)

names(da_df) <- c("ipid", "fce_entity_id", "case_id", "case_id_full", "da_complaint_num", "book_num")

original_df[[11]] <- tibble(table_name = "da_df", original_field = original_field, modified_field = names(da_df))

#DA Statuses
prob_df <- fread("Historical Data Submissions/San Joaquin/pretrial assessment report.csv")

original_field <- names(prob_df)

names(prob_df) <- c("case_id", "report_status", "ra_date")

original_df[[12]] <- tibble(table_name = "prob_df", original_field = original_field, modified_field = names(prob_df))

prob_df <- prob_df %>%
  mutate(ra_date = as_date(ra_date))
```

Probation (assessment) data--Fix later

```{r}
#Assessment Data
prob_df2 <- read_excel("Historical Data Submissions/San Joaquin/MASTER Pretrial Data Collection Variables 2011.xlsx", sheet = "2017-Present", col_types = "text") %>%
  rename_all(str_squish) %>%
  rename_at(vars(contains("...")), funs(paste0("...", as.numeric(gsub("...", "", .)) - 2))) %>%
  bind_rows(
    lapply(c("2014", "2015", "2016"), function(i) {
      read_excel("Historical Data Submissions/San Joaquin/MASTER Pretrial Data Collection Variables 2011.xlsx", sheet = i, col_types = "text") %>%
        rename_all(str_squish)
    })
  )

original_field <- names(prob_df2)


names(prob_df2) <- c("count", "assessment_date", "book_num", "unknown_id", "cii", "local_id", "dln_state", "dln", "case_num", "last_name", "first_name", "dob", "gender", "race", "zipcode", "score", "tansdermal_study", "overide", "auto_hold_1270.1", "auto_hold_1319", "auto_hold_other", "release_authorization_prearraignment", "release_authorization_postarraignment", "concurrence", "judge_name", "gps", "pretrial_release_date", "pretrial_monitor_start_date", "pretrial_monitor_end_date", "monitor_level", "fta_warrant", "court_remand", "remand_date", "remand_memo", "rearrest", "rearrest_date", "rearrest_charge", "charge_description", "charge_level", "termination_outcome", "notes")

original_df[[13]] <- tibble(table_name = "prob_df2", original_field = original_field, modified_field = names(prob_df2))

prob_df2 <- prob_df2 %>%
  filter(row_number() != 1) %>%
  mutate_at(vars(contains("date"), dob), convertToDate)
```

Code Book
```{r eval=FALSE, include=FALSE}
rm(original_field)

original_df <- bind_rows(original_df)

San_Joaquin_df <- lapply(ls()[!grepl("original", ls())], function(i){
  df <- get(i)
  
  if(sum(grepl("date", names(df))) > 0){
  df2 <- df %>%
  select(contains("date"), -contains("time")) %>%
  gather("modified_field", "value") %>%
  group_by(modified_field) %>%
  summarise_all(funs(min = as.character(min(., na.rm = T)), mean = as.character(mean(., na.rm = T)), max = as.character(max(., na.rm = T))))
  }else{
    df2 <- tibble(modified_field = NA_character_, min = NA_character_, mean = NA_character_, max = NA_character_)
  }
  
  df <- df %>%
    mutate_if(~length(unique(.)) > 50|is.Date(.)|is.POSIXct(.), ~(. = "not_factor")) %>%    
    mutate_all(~if_else(is.na(.), "na_missing", as.character(.))) %>%
    gather(modified_field, factor_value) %>%
    count(modified_field, factor_value) %>%
    mutate(table_name = i, county = "San_Joaquin") %>%
    mutate(factor_flag = if_else(factor_value == "not_factor", 0, 1)) %>%
    group_by(table_name, modified_field) %>%
    mutate(table_count = sum(n)) %>%
    ungroup() %>%
    rename("factor_count" = "n") %>%
    mutate(factor_count = if_else(factor_value == "not_factor", NA_integer_, factor_count),
           factor_percent = round(factor_count/table_count*100, 1)) %>%
    arrange(desc(factor_flag), modified_field, desc(factor_count))
  
  df <- left_join(df, df2, by = "modified_field")
    }) %>% 
  bind_rows() %>%
  left_join(original_df) %>%
   select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_count,
           factor_percent, table_count, min, mean, max) 

write.xlsx(San_Joaquin_df, file = "Code Books/San Joaquin Code Book.xlsx")
```
# San Mateo
- Everything is Join

Jail Data
```{r}
original_df <- list()

book_df <- fread("Historical Data Submissions/San Mateo/41-SO-01OF01-JAN2015-JUN2019.csv", colClasses = "text")
book_df2 <- fread("Historical Data Submissions/San Mateo/41-SO-01OF02-JUL2019-SEPT2019.csv", colClasses = "text", header = F)

names(book_df2) <- names(book_df)

book_df <- bind_rows(book_df, book_df2)

rm(book_df2)

original_field <- names(book_df)

names(book_df) <- c("cii", "name", "dob", "fbi", "local_id", "dln", "sex", "race", "arrest_date", "book_num", "book_date", "book_type", "case_id", "charge", "charge_level", "release_date", "release_type", "bail_amt", "conviction_date", "conviction_charge", "employment_status")

original_df[[1]] <- tibble(table_name = "book_df", original_field = original_field, modified_field = names(book_df))

book_df <- book_df %>%
  select(-c(conviction_date, conviction_charge, employment_status)) %>%
  mutate_at(vars(contains("date")), funs(time = as_datetime(., tz = 'America/Los_Angeles'))) %>%
  mutate_at(vars(contains("date"), dob), as_date)
```

Court Data
```{r}
#High level cases
court_df <- fread("Historical Data Submissions/San Mateo/41-COURT-01OF03-JAN2016-SEP2019.csv")

original_field <- names(court_df)

names(court_df) <- c("case_id", "court_id", "filing_date", "case_type", "person_id", "cii", "fbi", "local_id", "dln", 
                     "name", "dob", "sex", "race")

original_df[[2]] <- tibble(table_name = "court_df", original_field = original_field, modified_field = names(court_df))

court_df <- court_df %>%
  mutate_at(vars(dob, filing_date), as_date)

#Sentence Data
court_sentence <- fread("Historical Data Submissions/San Mateo/41-COURT-02OF03-JAN2016-SEP2019.csv")

original_field <- names(court_sentence)

names(court_sentence) <- c("case_id", "court_id", "filing_date", "case_type", "case_status", "case_status_date", "book_num", "arrest_date", "arrest_control", "arrest_agency", "offence_id", "charge_id", "charge_num", "offense_date", "charge", "charge_level", "charge_description", "plea_type", "plea_date", "disposition_type", "disposition_date", "disposition_final_date", "sentence_type", "sentence_date", "sentence_loc", "probation_type", "term_years_probation", "term_months_probation", "term_days_probation", "jail_type", "term_years_jail", "term_months_jail", "term_days_jail")

original_df[[3]] <- tibble(table_name = "court_sentence", original_field = original_field, modified_field = names(court_sentence))

court_sentence <- court_sentence %>%
  mutate_at(vars(contains("date")), as_date)

#Court hearings--Contains Warrants
court_hearing <- fread("Historical Data Submissions/San Mateo/41-COURT-03OF03-JAN2016-SEP2019.csv")

original_field <- names(court_hearing)

names(court_hearing) <- c("case_id", "case_number", "filing_date", "case_type", "setting_id", "hearing_date", "hearing_type_loc", "court_loc", "hearing_type_code", "hearing_type", "hearing_result", "hearing_date_next", "fta", "fta_warrant")

original_df[[4]] <- tibble(table_name = "court_hearing", original_field = original_field, modified_field = names(court_hearing))

court_hearing <- court_hearing %>%
  mutate_at(vars(contains("date")), as_date)
```

Probation. No Actual Assessment data. Do not use.  
```{r}
# prob_df1 <- fread("Historical Data Submissions/San Mateo/41-PROBATION-01OF04-JAN2015-SEP2019.csv")
# prob_df2 <- fread("Historical Data Submissions/San Mateo/41-PROBATION-02OF04-JAN2015-SEP2019.csv")
# prob_df3 <- fread("Historical Data Submissions/San Mateo/41-PROBATION-03OF04-JAN2015-SEP2019.csv")
# prob_df4 <- fread("Historical Data Submissions/San Mateo/41-PROBATION-04OF04-JAN2015-SEP2019.csv")
```

Code Book
```{r eval=FALSE, include=FALSE}
rm(original_field)

original_df <- bind_rows(original_df)

San_Mateo_df <- lapply(ls()[!grepl("original", ls())], function(i){
  df <- get(i)
  
  if(sum(grepl("date", names(df))) > 0){
  df2 <- df %>%
  select(contains("date"), -contains("time")) %>%
  gather("modified_field", "value") %>%
  group_by(modified_field) %>%
  summarise_all(funs(min = as.character(min(., na.rm = T)), mean = as.character(mean(., na.rm = T)), max = as.character(max(., na.rm = T))))
  }else{
    df2 <- tibble(modified_field = NA_character_, min = NA_character_, mean = NA_character_, max = NA_character_)
  }
  
  df <- df %>%
    mutate_if(~length(unique(.)) > 50|is.Date(.)|is.POSIXct(.), ~(. = "not_factor")) %>%    
    mutate_all(~if_else(is.na(.), "na_missing", as.character(.))) %>%
    gather(modified_field, factor_value) %>%
    count(modified_field, factor_value) %>%
    mutate(table_name = i, county = "San Mateo") %>%
    mutate(factor_flag = if_else(factor_value == "not_factor", 0, 1)) %>%
    group_by(table_name, modified_field) %>%
    mutate(table_count = sum(n)) %>%
    ungroup() %>%
    rename("factor_count" = "n") %>%
    mutate(factor_count = if_else(factor_value == "not_factor", NA_integer_, factor_count),
           factor_percent = round(factor_count/table_count*100, 1)) %>%
    arrange(desc(factor_flag), modified_field, desc(factor_count))
  
  df <- left_join(df, df2, by = "modified_field")
    }) %>% 
  bind_rows() %>%
  left_join(original_df) %>%
   select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_count,
           factor_percent, table_count, min, mean, max) 

write.xlsx(San_Mateo_df, file = "Code Books/San Mateo Code Book.xlsx")
```

# Santa Barbara

Jail Data
```{r}
original_df <- list()

# Jail Bookings
book_df <- read_excel("Historical Data Submissions/Santa Barbara/Jail.Data.12.5.xlsx", col_types = "text")

original_field <- names(book_df)

names(book_df) <- c("cii", "first_name", "last_name", "dob", "arrest_date_time", "book_num", "book_date_time", "book_type", "case_id", "charge_code", "charge", "charge_level", "release_date_time", "release_type", "gender", "race")

original_df[[1]] <- tibble(table_name = "book_df", original_field = original_field, modified_field = names(book_df))

book_df <- book_df %>%
  mutate_at(vars(arrest_date_time, book_date_time, release_date_time), convertToDateTime) %>%
  mutate(dob = convertToDate(dob)) %>%
  mutate(arrest_date = as_date(arrest_date_time),
         book_date = as_date(book_date_time),
         release_date = as_date(release_date_time))
```

Court Data
```{r}
#Court Status
court_status <- fread("Historical Data Submissions/Santa Barbara/CaseStatus.csv", header = F)

original_field <- names(court_status)

names(court_status) <- c("case_id", "case_num", "status_date", "status")

original_df[[2]] <- tibble(table_name = "court_status", original_field = original_field, modified_field = names(court_status))

court_status <- court_status %>%
  mutate(status_date = mdy(status_date))


#Court Charges
court_charges <- fread("Historical Data Submissions/Santa Barbara/Charges.csv", header = F)

original_field <- names(court_charges)

names(court_charges) <- c("case_id", "case_num", "charge_code", "charge", "charge_level", "charge_description", "plea_date", "plea_type", "disposition_date", "dispositiontype", "disposition_date_final")

original_df[[3]] <- tibble(table_name = "court_charges", original_field = original_field, modified_field = names(court_charges))

court_charges <- court_charges %>%
  mutate_at(vars(contains("date")), as_date)


#Court hearing data
court_hearing <- fread("Historical Data Submissions/Santa Barbara/Hearings.csv", header = F)

original_field <- names(court_hearing)

names(court_hearing) <- c("case_id", "case_num", "hearing_date", "hearing_type", "hearing_result")

original_df[[4]] <- tibble(table_name = "court_hearing", original_field = original_field, modified_field = names(court_hearing))

court_hearing <- court_hearing %>%
  mutate(hearing_date = mdy(hearing_date))


#The following is for confinement sentencing.
court_confinement <- fread("Historical Data Submissions/Santa Barbara/SentConf.csv")

original_field <- names(court_confinement)

names(court_confinement) <- c("case_id", "case_num", "sentence_date", "setence_type", "sentence_loc",
                              "sentence_term", "term_length")

original_df[[5]] <- tibble(table_name = "court_confinement", original_field = original_field, modified_field = names(court_confinement))

court_confinement <- court_confinement %>%
  mutate(sentence_date = mdy(sentence_date))


#The following is for probation sentencing.
court_probation <- fread("Historical Data Submissions/Santa Barbara/SentProb.csv", header = F)

original_field <- names(court_probation)

names(court_probation) <- c("case_id", "case_num", "sentence_date", "setence_type", "sentence_loc",
                              "term_length", "sentence_term")

original_df[[6]] <- tibble(table_name = "court_probation", original_field = original_field, modified_field = names(court_probation))

court_probation <- court_probation %>%
  mutate(sentence_date = mdy(sentence_date))


#Court Person IDs
court_person <- fread("Historical Data Submissions/Santa Barbara/TechElements.csv", header = F)

original_field <- names(court_person)

names(court_person) <- c("case_id", "case_num", "last_name", "first_name", "middle_name", "file_date", "dob", "cii", "dln", "fbi", "sex", "race", "dln_state", "ra_date")

original_df[[7]] <- tibble(table_name = "court_person", original_field = original_field, modified_field = names(court_person))

court_person <- court_person %>%
  mutate_at(vars(contains("date"), dob), mdy)


#FTA Warrants
court_fta_war <- fread("Historical Data Submissions/Santa Barbara/Warrants.csv", header = F)

original_field <- names(court_fta_war)

names(court_fta_war) <- c("case_id", "case_num", "fta", "fta_date", "fta_warrant", "fta_warrant_date", "fta_description")

original_df[[8]] <- tibble(table_name = "court_fta_war", original_field = original_field, modified_field = names(court_fta_war))

court_fta_war <- court_fta_war %>%
  mutate_at(vars(contains("date")), mdy)
```

Assessment Data (Court)
```{r}
#Assessment with Full Interviews
assess_interview <- read_excel("Historical Data Submissions/Santa Barbara/Full.xlsm", skip = 1)

original_field <- names(assess_interview)

names(assess_interview) <- c("name", "dob", "book_num", "arrest_date", "interview_type", "interviewer", "interview_date", "location", "refferal_type", "court_loc", "case", "cid", "alcohol_flag", "civic_flag", "drug_flag", "financial_flag", "personal_flag", "property_flag", "order_flag", "sex_flag", "traffic_flag", "violation_flag", "violent_flag", "other_flag", "other2_flag", "charge_level", "charge_score", "pending_flag", "pending_score", "residence_type", "residence_score", "employment_type", "employment_score", "crim_history", "crim_history_score", "drug_abuse_history", "drug_abuse_history_score", "fta_history", "fta_score", "vc_history", "vc_score", "risk_score", "pretrial_recommendation", "sup_agency", "conern_risk", "concern_public_safety", "concern_poi", "concern_no_bail", "concern_fta_possibilty", "concern_ineligible", "concern_other", "concern2_other", "bail_recommend", "custody", "cond_call_in", "cond_ptco", "cond_avoid_place", "cond_avoid_contact", "cond_maths", "cond_passport", "cond_drugs", "cond_scram", "cond_gps", "cond_weapons", "cond_sands", "cond_other", "aoda_recommend", "reassess_change", "reassess_ref", "reassess_victim", "reassess_info", "reassess_charges", "comments", "pts_assessment", "sex", "race_ai", "race_asian", "race_black", "race_hispanic", "race_me", "race_pi", "race_white", "race_other", "race2_other", "language", "bw", "gang", "supervision", "sbc_partner", "sbc_family", "sbc_children", "sbc_work", "sbc_school", "sbc_none", "ca_partner", "ca_family", "ca_children", "ca_work", "ca_school", "ca_none", "outside_partner", "outside_family", "outside_children", "outside_work", "outside_schoool", "outside_none", "cellphone", "email", "alcohol_use", "narcotics_use", "employed", "in_school", "living_conditions", "information_quality", "references", "omissions", "deception", "no_refs", "other_issues", "other2_issues", "id", "data")

original_df[[9]] <- tibble(table_name = "assess_interview", original_field = original_field, modified_field = names(assess_interview))

assess_interview <- assess_interview %>%
  mutate(arrest_date = convertToDate(arrest_date))

#Assessment Tracking
assess_tracking <- read_excel("Historical Data Submissions/Santa Barbara/Full.xlsm", skip = 1, sheet = 3)

original_field <- names(assess_tracking)

names(assess_tracking) <- c("id", "name", "dob", "cide", "interview_date", "book_num", "referral_type", "court", "risk_score", "pretrial_recommend", "supervision_agency", "custody", "bail_before_court_flag", "pretrial_decision", "bailed_after_court", "continue_tracking_flag")

original_df[[10]] <- tibble(table_name = "assess_tracking", original_field = original_field, modified_field = names(assess_tracking))


#Assessment Outcomes
assess_outcome <- read_excel("Historical Data Submissions/Santa Barbara/Full.xlsm", skip = 1, sheet = 4)

original_field <- names(assess_outcome)

names(assess_outcome) <- c("id", "name", "cid", "interview_date", "referral_type", "decision", "case_num", "charge_level", "case_status", "cd1", "cd1_appeared", "cd2", "cd2_appeared", "cd3", "cd3_appeared", "cd4", "cd4_appeared", "cd5", "cd5_appeared", "cd6", "cd6_appeared", "cd7", "cd7_appeared", "cd8", "cd8_appeared", "cd9", "cd9_appeared", "pretrial_rearrest", "pretrial_rearrest_date", "remand_flag", "rearrest_remand_case", "phone_num", "contact_notes", "other")

original_df[[11]] <- tibble(table_name = "assess_outcome", original_field = original_field, modified_field = names(assess_outcome))

assess_outcome <- assess_outcome %>%
  mutate_at(vars(cd1, cd2, cd5, cd6, cd7, cd8, pretrial_rearrest_date), convertToDate)

#Assessments without Interivew
assess_nointerview <- read_excel("Historical Data Submissions/Santa Barbara/Non.xlsm", skip = 1)

original_field <- names(assess_nointerview)

names(assess_nointerview) <- c("name", "dob", "book_num", "arrest_date", "reviewer", "review_date", "review_loc", "referral_type", "court", "cid", "case_num", "stage_none", "stage_preinterview", "stage_interview", "stage_references", "stage_victim", "stage_assess", "alcohol_flag", "civic_flag", "drug_flag", "financial_flag", "personal_flag", "property_flag", "order_flag", "sex_flag", "traffic_flag", "violation_flag", "violent_flag", "other_flag", "other2_flag", "non_unwilling", "non", "non_capital", "non_supervision", "non_other_agency", "non_sick", "non_849", "non_bail", "non_warrants", "non_other", "non_other_more", "aoda", "reassess_cricumstance", "reassess_willing", "reassess_info", "reassess_holds", "reassess_charge", "sex", "race_ai", "race_asian", "race_black", "race_hispanic", "race_me", "race_pi", "race_white", "race_other", "race2_other", "language", "id", "filename")

original_df[[12]] <- tibble(table_name = "assess_nointerview", original_field = original_field, modified_field = names(assess_nointerview))
```

Code Book
```{r eval=FALSE, include=FALSE}
rm(original_field)

original_df <- bind_rows(original_df)

Santa_Barbara_df <- lapply(ls()[!grepl("original", ls())], function(i){
  df <- get(i)
  
  if(sum(grepl("date", names(df))) > 0){
  df2 <- df %>%
  select(contains("date"), -contains("time")) %>%
  gather("modified_field", "value") %>%
  group_by(modified_field) %>%
  summarise_all(funs(min = as.character(min(., na.rm = T)), mean = as.character(mean(., na.rm = T)), max = as.character(max(., na.rm = T))))
  }else{
    df2 <- tibble(modified_field = NA_character_, min = NA_character_, mean = NA_character_, max = NA_character_)
  }
  
  df <- df %>%
    mutate_if(~length(unique(.)) > 50|is.Date(.)|is.POSIXct(.), ~(. = "not_factor")) %>%    
    mutate_all(~if_else(is.na(.), "na_missing", as.character(.))) %>%
    gather(modified_field, factor_value) %>%
    count(modified_field, factor_value) %>%
    mutate(table_name = i, county = "Santa Barbara") %>%
    mutate(factor_flag = if_else(factor_value == "not_factor", 0, 1)) %>%
    group_by(table_name, modified_field) %>%
    mutate(table_count = sum(n)) %>%
    ungroup() %>%
    rename("factor_count" = "n") %>%
    mutate(factor_count = if_else(factor_value == "not_factor", NA_integer_, factor_count),
           factor_percent = round(factor_count/table_count*100, 1)) %>%
    arrange(desc(factor_flag), modified_field, desc(factor_count))
  
  df <- left_join(df, df2, by = "modified_field")
    }) %>% 
  bind_rows() %>%
  left_join(original_df) %>%
   select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_count,
           factor_percent, table_count, min, mean, max) 

write.xlsx(Santa_Barbara_df, file = "Code Books/Santa Barbara Code Book.xlsx")

?write.xlsx()
```


# Tulare
- Everything is Join

Jail Data
```{r}
book_df <- fread("Historical Data Submissions/Tulare/JMS data.csv", sep = NULL, col.names = "x")

book_df <- book_df %>%
  mutate(x = gsub(", ,", ",NA,", x),
         x = gsub(", ", " ", x),
         x = gsub("[A-Z](,,,,)[A-Z]", ",,,", x)) %>%
  separate(x, c("cii", "fbi", "ref", "dln", "name", "dob", "ref2", "race", "bail_amt", "date",
                "charge", "ref3", "ref4", "name2", "dob2", "date2", "unknown", "date3", "ref5", 
                "ref6", "charge2", "date4", "date5", "numeric"),
           sep = ",") %>%
  select(-contains("ref"))

book_df <- book_df %>%
  mutate_at(vars(dob, dob2), funs(mdy(if_else(nchar(.) == 7, paste0("0", .), .)))) %>%
  mutate_at(vars(contains("date")), ymd_hms)
```

Court Data
```{r}
original_df <- list()

court_df <- lapply(c("15-16", "16-17", "17-18", "18-19"), function(i){
  fread(paste0("Historical Data Submissions/Tulare/PretrialStatsFY", i, ".csv"), colClasses = "character", header = F)}) %>%
  bind_rows()

original_field <- names(court_df)

names(court_df) <- c("case_id", "filing_date", "disposition_date", "case_type", "name", "dob", "sex", "race", "fbi", "cii", "dln", "arrest_date", "arrest_agency", "report_id", "charge_level", "charge", "charge_filing_date", "charge_type", "charge_code", "charge_description", "disposition_date_charge", "disposition", "sentence_date", "sentence_charge", "sentence", "sentence_amt", "sentence_type", "term", "sentence_status", "hearing_date", "hearing_type", "hearing_result", "warrant_date", "warrant_type", "total")

original_df[[1]] <- tibble(table_name = "court_df", original_field = original_field, modified_field = names(court_df))

court_df <- court_df %>%
  mutate_at(vars(contains("date"), dob), mdy)
```

Probation (assessment)--Confusing Data. Figure out later. 
```{r}
prob_df <- fread("Historical Data Submissions/Tulare/Extremely Rough DRAFT Pretrial Project data 20191008 1722.csv")

original_field <- names(prob_df)

names(prob_df) <- c("event_id", "tool_name", "ra_date", "zip_code", "tool_response", "risk_score", "release_recommendation", "release_decision", "release_type", "release_date", "release_conditions", "pretrial_violation", "pretrial_violation_date", "court_date_reminder", "termination_outcome", "termination_date", "cii", "fbi", "local_id", "dln", "name", "dob", "sex", "race")

original_df[[2]] <- tibble(table_name = "prob_df", original_field = original_field, modified_field = names(prob_df))

prob_df <- prob_df %>%
  mutate(ra_date_time = mdy_hms(ra_date),
         ra_date = as_date(ra_date_time),
         release_date_time = mdy_hms(release_date),
         release_date = as_date(release_date_time)) %>%
  mutate_at(vars(pretrial_violation_date, termination_date, dob), mdy)
```

Code Book
```{r eval=FALSE, include=FALSE}
rm(original_field)

original_df <- bind_rows(original_df)

Tulare_df <- lapply(ls()[!grepl("original", ls())], function(i){
  df <- get(i)
  
  if(sum(grepl("date", names(df))) > 0){
  df2 <- df %>%
  select(contains("date"), -contains("time")) %>%
  gather("modified_field", "value") %>%
  group_by(modified_field) %>%
  summarise_all(funs(min = as.character(min(., na.rm = T)), mean = as.character(mean(., na.rm = T)), max = as.character(max(., na.rm = T))))
  }else{
    df2 <- tibble(modified_field = NA_character_, min = NA_character_, mean = NA_character_, max = NA_character_)
  }
  
  df <- df %>%
    mutate_if(~length(unique(.)) > 50|is.Date(.)|is.POSIXct(.), ~(. = "not_factor")) %>%    
    mutate_all(~if_else(is.na(.), "na_missing", as.character(.))) %>%
    gather(modified_field, factor_value) %>%
    count(modified_field, factor_value) %>%
    mutate(table_name = i, county = "Tulare") %>%
    mutate(factor_flag = if_else(factor_value == "not_factor", 0, 1)) %>%
    group_by(table_name, modified_field) %>%
    mutate(table_count = sum(n)) %>%
    ungroup() %>%
    rename("factor_count" = "n") %>%
    mutate(factor_count = if_else(factor_value == "not_factor", NA_integer_, factor_count),
           factor_percent = round(factor_count/table_count*100, 1)) %>%
    arrange(desc(factor_flag), modified_field, desc(factor_count))
  
  df <- left_join(df, df2, by = "modified_field")
    }) %>% 
  bind_rows() %>%
  left_join(original_df) %>%
   select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_count,
           factor_percent, table_count, min, mean, max) 

write.xlsx(Tulare_df, file = "Code Books/Tulare Code Book.xlsx")
```


Join
```{r eval=FALSE, include=FALSE}
#Alameda has an integrated criminal justice system. Information is joined across agencies on the jail_court_ID. It is contained in the book_df, court_df, and book_charge tables. 

#Jail Court ID is duplicated when split between cases
book_df <- book_df %>% distinct(jail_court_id, .keep_all = T)

#Jail Court ID is duplicated when split between cases
court_df <- court_df %>% distinct(jail_court_id, .keep_all = T)

book_no_court <- anti_join(book_df, court_df, by = c("jail_court_id"))
nrow(book_df)
nrow(book_no_court)
nrow(book_no_court)/nrow(book_df)

court_no_book <- anti_join(court_df, book_df, by = c("jail_court_id"))
nrow(court_df)
nrow(court_no_book)
nrow(court_no_book)/nrow(court_df)
```


# Tuolumne

Jail Data
```{r}

```

Court Data
```{r}
court_df <- read_excel("Historical Data Submissions/Tuolomne/Tuolumne Pretrial Assessment Information.xls", sheet = 1)

court_charges <- read_excel("Historical Data Submissions/Tuolomne/Tuolumne Pretrial Assessment Information.xls", sheet = 2)

court_sentence <- read_excel("Historical Data Submissions/Tuolomne/Tuolumne Pretrial Assessment Information.xls", sheet = 3)

court_hearing <- read_excel("Historical Data Submissions/Tuolomne/Tuolumne Pretrial Assessment Information.xls", sheet = 4)
court_hearing2 <- read_excel("Historical Data Submissions/Tuolomne/Tuolumne Pretrial Assessment Information.xls", sheet = 5)

court_hearing <- bind_rows(court_hearing, court_hearing2)
rm(court_hearing2)

court_lawyer <- read_excel("Historical Data Submissions/Tuolomne/Tuolumne Pretrial Assessment Information.xls", sheet = 6)

court_demo <- read_excel("Historical Data Submissions/Tuolomne/Tuolumne Pretrial Assessment Information.xls", sheet = 7)

court_demo2 <- read_excel("Historical Data Submissions/Tuolomne/Tuolumne Pretrial Assessment Information.xls", sheet = 8)
```

Probation (assessment)--Confusing Data. Figure out later. 
```{r}
# prob_df <- lapply(2018:2019, function(i){
#   lapply(getSheetNames(paste0("Historical Data Submissions/Tuolomne/Tuolumne County Probation Pre-Trial Data ", i, ".xlsx")),
#          function(j){
#     df <- read_excel(paste0("Historical Data Submissions/Tuolomne/Tuolumne County Probation Pre-Trial Data ", i, ".xlsx"),
#                      skip = 2, sheet = j, col_types = "text")
#     df$risk_score <- j
#     return(df)
# }) %>% bind_rows() 
# }) %>% bind_rows()
```


# Ventura

Jail Data
```{r}
book_df <- read_excel("Historical Data Submissions/Ventura/jcc_ptm_vcsh_2015_2019.xlsx")

names(book_df) <- c("cii", "name", "dob", "arrest_date", "book_num", "book_date", "book_type", "case_id", "charge", "charge_level", "release_date", "release_type", "cii_2", "fbi", "local_id", "dln", "name-2", "dob_2", "sex", "race", "bail_amt", "conviction_date", "conviction_charge", "employee_status")
```

Court Data
```{r}
court_df <- read_excel("Historical Data Submissions/Ventura/jcc_ptm_vcct_2015_2019.xlsx")

names(court_df) <- c("case_id", "other_id", "hearing_fta_flag", "fta_date", "fta_warrant_flag", "fta_warrant_date", "disposition", "disposition_date", "disposition_final_date", "sentence_type", "sentence_date", "cii", "fbi", "local_id", "dln", "name", "dob", "sex", "race", "filing_date", "case_status", "case_status_date", "charge", "charge_level", "charge_description", "hearing_type", "hearing_date", "plea_type", "plea_date", "sentence_loc", "term", "ra_date")
```

Probation (assessment)--Confusing Data. Figure out later. 
```{r}
prob_df <- read_excel("Historical Data Submissions/Ventura/Pretrial Supervision - VCPA.xlsx")

names(prob_df) <- c("person_id", "case_id", "name", "dob", "sex", "race", "cii", "fbi", "dln", "date", "dv", "pretrial_recommendation", "pretrial_screening_flag", "pat_flag", "pretrial_decision", "success_date", "fta_date", "new_arrest_date", "offense_type", "charge_level", "pretrial_violation_date", "pretrial_outcome", "outcome_type", "pretrial_time_spent")
```

Code Book
```{r eval=FALSE, include=FALSE}
rm(original_field)

original_df <- bind_rows(original_df)

Sacramento_df <- lapply(ls()[!grepl("original", ls())], function(i){
  df <- get(i)
  
  if(sum(grepl("date", names(df))) > 0){
  df2 <- df %>%
  select(contains("date"), -contains("time")) %>%
  gather("modified_field", "value") %>%
  group_by(modified_field) %>%
  summarise_all(funs(min = as.character(min(., na.rm = T)), mean = as.character(mean(., na.rm = T)), max = as.character(max(., na.rm = T))))
  }else{
    df2 <- tibble(modified_field = NA_character_, min = NA_character_, mean = NA_character_, max = NA_character_)
  }
  
  df <- df %>%
    mutate_if(~length(unique(.)) > 50|is.Date(.)|is.POSIXct(.), ~(. = "not_factor")) %>%    
    mutate_all(~if_else(is.na(.), "na_missing", as.character(.))) %>%
    gather(modified_field, factor_value) %>%
    count(modified_field, factor_value) %>%
    mutate(table_name = i, county = "Sacramento") %>%
    mutate(factor_flag = if_else(factor_value == "not_factor", 0, 1)) %>%
    group_by(table_name, modified_field) %>%
    mutate(table_count = sum(n)) %>%
    ungroup() %>%
    rename("factor_count" = "n") %>%
    mutate(factor_count = if_else(factor_value == "not_factor", NA_integer_, factor_count),
           factor_percent = round(factor_count/table_count*100, 1)) %>%
    arrange(desc(factor_flag), modified_field, desc(factor_count))
  
  df <- left_join(df, df2, by = "modified_field")
    }) %>% 
  bind_rows() %>%
  left_join(original_df) %>%
   select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_count,
           factor_percent, table_count, min, mean, max) 

write.xlsx(Sacramento_df, file = "Code Books/Sacramento Code Book.xlsx")
```


# Yuba

Jail Data
```{r}
original_df <- list()

# Jail Bookings
book_df <- fread("Historical Data Submissions/Yuba/JailExtract.csv")

original_field <- names(book_df)

names(book_df) <- c("cii", "fbi", "last_name", "first_name", "middle_name", "dob", "arrest_date_time", "book_num", "book_date_time", "court_id", "charge_code", "charge", "charge_level", "release_date", "release_type", "local_id", "other_id", "dln_state", "sex", "race", "nationality", "bail_amt", "no_bail", "cash_bail", "bail_reduction", "employement", "status")

original_df[[1]] <- tibble(table_name = "book_df", original_field = original_field, modified_field = names(book_df))

book_df <- book_df
```

Code Book
```{r eval=FALSE, include=FALSE}
rm(original_field)

original_df <- bind_rows(original_df)

Alameda_df <- lapply(ls()[!grepl("original", ls())], function(i){
  df <- get(i)
  
  if(sum(grepl("date", names(df))) > 0){
  df2 <- df %>%
  select(contains("date"), -contains("time")) %>%
  gather("modified_field", "value") %>%
  group_by(modified_field) %>%
  summarise_all(funs(min = as.character(min(., na.rm = T)), mean = as.character(mean(., na.rm = T)), max = as.character(max(., na.rm = T))))
  }else{
    df2 <- tibble(modified_field = NA_character_, min = NA_character_, mean = NA_character_, max = NA_character_)
  }
  
  df <- df %>%
    mutate_if(~length(unique(.)) > 50|is.Date(.)|is.POSIXct(.), ~(. = "not_factor")) %>%    
    mutate_all(~if_else(is.na(.), "na_missing", as.character(.))) %>%
    gather(modified_field, factor_value) %>%
    count(modified_field, factor_value) %>%
    mutate(table_name = i, county = "Alameda") %>%
    mutate(factor_flag = if_else(factor_value == "not_factor", 0, 1)) %>%
    group_by(table_name, modified_field) %>%
    mutate(table_count = sum(n)) %>%
    ungroup() %>%
    rename("factor_count" = "n") %>%
    mutate(factor_count = if_else(factor_value == "not_factor", NA_integer_, factor_count),
           factor_percent = round(factor_count/table_count*100, 1)) %>%
    arrange(desc(factor_flag), modified_field, desc(factor_count))
  
  df <- left_join(df, df2, by = "modified_field")
    }) %>% 
  bind_rows() %>%
  left_join(original_df) %>%
   select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_count,
           factor_percent, table_count, min, mean, max) 

write.xlsx(Alameda_df, file = "Code Books/Alameda Code Book.xlsx")
```
>>>>>>> c528e800b009bf961474fd89003c7686b999751e
