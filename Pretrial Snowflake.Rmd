---
title: "R Notebook"
output: html_notebook
---
Install
```{r}
#install.packages(c("DBI", "dplyr","dbplyr","odbc"))
#install.packages("DBI")
```

# Load

Libraries
```{r setup}
library(DBI)
library(dplyr)
library(dbplyr)
library(odbc)
library(tidyverse)
library(openxlsx)
library(lubridate)
```

Connection
```{r eval=FALSE, include=FALSE}
con <- dbConnect(odbc::odbc(), "snowflake_pretrial", uid ="Sal.Lempert@jud.ca.gov", pwd = .rs.askForPassword("Password"))
```

# Aggregate Data

Snowflake Aggregate KPIs by County
```{sql connection = con, output.var = sf_kpi}
SELECT County,
SUM(Booking_Count) AS Booking_Count,
SUM(Release_Eligible_Count) AS Release_Eligible_Count,
SUM(Booking_Assessed_Count) AS Booking_Assessed_Count,
SUM(Released_To_Pretrial_Services_Count) AS Released_To_Pretrial_Services_Count,
SUM(Released_Pretrial_Count) AS Released_Pretrial_Count,
SUM(Failure_To_Appear_Count) AS Failure_To_Appear_Count,
SUM(New_Crimnal_Activity_Count) AS New_Crimnal_Activity_Count
FROM "DWH_UAT"."DWH"."AGG_PRETRIAL_KPI"
WHERE (Booking_date BETWEEN '2018-07-01' AND '2020-12-31') AND (COUNTY <> 'Tulare')
GROUP BY County
ORDER BY County;
```

Snowflake Aggregate KPIs by County, Month, and Year
```{sql connection = con, output.var = sf_kpi_month}
SELECT County, YEAR(Booking_date) AS YEAR, MONTH(Booking_date) AS MONTH, 
SUM(Booking_Count) AS Booking_Count,
SUM(Release_Eligible_Count) AS Release_Eligible_Count,
SUM(Booking_Assessed_Count) AS Booking_Assessed_Count,
SUM(Released_To_Pretrial_Services_Count) AS Released_To_Pretrial_Services_Count,
SUM(Released_Pretrial_Count) AS Released_Pretrial_Count,
SUM(Failure_To_Appear_Count) AS Failure_To_Appear_Count,
SUM(New_Crimnal_Activity_Count) AS New_Crimnal_Activity_Count
FROM "DWH_UAT"."DWH"."AGG_PRETRIAL_KPI"
WHERE (Booking_date BETWEEN '2018-07-01' AND '2020-12-31') AND (COUNTY <> 'Tulare')
GROUP BY County, YEAR, MONTH
ORDER BY County, YEAR, MONTH;
```

JCC KPIs by County/ JCC KPIs by County, Month, and Year
```{r}
jcc_kpi <- read.xlsx("C:/Work/PretrialAssessmentPilot/Snowflake/kpi_from_CJS.xlsx", sheet = 1)

jcc_kpi <- jcc_kpi %>%
  mutate(county = gsub("_", " ", county),
         county = tools::toTitleCase(county))

names(jcc_kpi) <- c("COUNTY", "BOOKING_COUNT", "RELEASE_ELIGIBLE_COUNT", "BOOKING_ASSESSED_COUNT", "RELEASED_TO_PRETRIAL_SERVICES_COUNT",
                    "OTHER_RELEASE_COUNT", "TWO_DAY_RELEASE_COUNT", "PRE_ARR_RELEASE_COUNT", "RELEASED_PRETRIAL_COUNT", "RELEASES_COUNT",
                    "FAILURE_TO_APPEAR_COUNT", "NEW_CRIMNAL_ACTIVITY_COUNT", "VIOLATION_COUNT", "PRETRIAL_COMPLETE_COUNT")

jcc_kpi_month <- read.xlsx("C:/Work/PretrialAssessmentPilot/Snowflake/kpi_from_CJS.xlsx", sheet = 2)

jcc_kpi_month <- jcc_kpi_month %>%
  mutate(county = gsub("_", " ", county),
         county = tools::toTitleCase(county))

names(jcc_kpi_month) <- c("COUNTY", "YEAR", "MONTH", "BOOKING_COUNT", "RELEASE_ELIGIBLE_COUNT", "BOOKING_ASSESSED_COUNT",
                          "RELEASED_TO_PRETRIAL_SERVICES_COUNT", "OTHER_RELEASE_COUNT", "TWO_DAY_RELEASE_COUNT", "PRE_ARR_RELEASE_COUNT",
                          "RELEASED_PRETRIAL_COUNT", "RELEASES_COUNT", "FAILURE_TO_APPEAR_COUNT", "NEW_CRIMNAL_ACTIVITY_COUNT", 
                          "VIOLATION_COUNT", "PRETRIAL_COMPLETE_COUNT")
```

# UAT Matching
County
```{r}
match_kpi <- jcc_kpi %>%
  select(names(sf_kpi)) %>%
  semi_join(sf_kpi, by = "COUNTY") %>%
  semi_join(jcc_kpi, by = "COUNTY")

sf_kpi <- sf_kpi %>%
  semi_join(match_kpi, by = "COUNTY")

match_kpi[2:length(match_kpi)] <- round(sf_kpi[2:length(sf_kpi)]/match_kpi[2:length(match_kpi)]*100)

names(jcc_kpi)[2:ncol(jcc_kpi)] <- paste0(names(jcc_kpi)[2:ncol(jcc_kpi)], "_JCC")
names(sf_kpi)[2:ncol(sf_kpi)] <- paste0(names(sf_kpi)[2:ncol(sf_kpi)], "_CLOUD")
names(match_kpi)[2:ncol(match_kpi)] <- paste0(names(match_kpi)[2:ncol(match_kpi)], "_MATCH")

match_kpi2 <- left_join(jcc_kpi, sf_kpi, by = "COUNTY") %>%
  left_join(match_kpi, by = "COUNTY")


match_kpi2 <- match_kpi2 %>%
  select(COUNTY, order(names(match_kpi2)))

write.xlsx(match_kpi2, file = "Match Rate Between Snowflake and JCC Pretrial Data.xlsx", as.table = T)

shell.exec(getwd())
```

County, Year, Month
```{r}
match_kpi_month <- jcc_kpi_month %>%
  select(names(sf_kpi_month)) %>%
  semi_join(sf_kpi_month, by = c("COUNTY", "YEAR", "MONTH"))

match_kpi_month[4:length(match_kpi_month)] <- round(sf_kpi_month[4:length(sf_kpi_month)]/match_kpi_month[4:length(match_kpi_month)]*100)

match_kpi_month <- left_join(jcc_kpi_month, sf_kpi_month, by = c("COUNTY", "YEAR", "MONTH")) %>%
  left_join(match_kpi_month, by = c("COUNTY", "YEAR", "MONTH")) 

names(match_kpi_month) <- gsub("\\.x", "_JCC", names(match_kpi_month))
names(match_kpi_month) <- gsub("\\.y", "_SF", names(match_kpi_month))
# names(match_kpi_month) <- gsub("\\.x", "_MR", names(match_kpi_month))


match_kpi_month <- match_kpi_month %>%
  select(COUNTY, YEAR, MONTH, order(names(match_kpi_month)))

court_df <- court_df2
```

# Tulare Special Check
Snowflake Aggregate KPIs by County
```{sql connection = con, output.var = tulare_kpi}
SELECT County,
SUM(Booking_Count) AS Booking_Count,
SUM(Release_Eligible_Count) AS Release_Eligible_Count,
SUM(Booking_Assessed_Count) AS Booking_Assessed_Count,
SUM(Released_To_Pretrial_Services_Count) AS Released_To_Pretrial_Services_Count,
SUM(Released_Pretrial_Count) AS Released_Pretrial_Count,
SUM(Failure_To_Appear_Count) AS Failure_To_Appear_Count,
SUM(New_Crimnal_Activity_Count) AS New_Crimnal_Activity_Count
FROM "DWH_UAT"."DWH"."AGG_PRETRIAL_KPI"
WHERE (Booking_date BETWEEN '2018-07-01' AND '2020-12-31') AND (COUNTY = 'Tulare')
GROUP BY County
ORDER BY County;
```

Snowflake Aggregate KPIs by County, Month, and Year
```{sql connection = con, output.var = tulare_kpi_month}
SELECT County, YEAR(Booking_date) AS YEAR, MONTH(Booking_date) AS MONTH, 
SUM(Booking_Count) AS Booking_Count,
SUM(Release_Eligible_Count) AS Release_Eligible_Count,
SUM(Booking_Assessed_Count) AS Booking_Assessed_Count,
SUM(Released_To_Pretrial_Services_Count) AS Released_To_Pretrial_Services_Count,
SUM(Released_Pretrial_Count) AS Released_Pretrial_Count,
SUM(Failure_To_Appear_Count) AS Failure_To_Appear_Count,
SUM(New_Crimnal_Activity_Count) AS New_Crimnal_Activity_Count
FROM "DWH_UAT"."DWH"."AGG_PRETRIAL_KPI"
WHERE (Booking_date BETWEEN '2018-07-01' AND '2020-12-31') AND (COUNTY = 'Tulare')
GROUP BY County, YEAR, MONTH
ORDER BY County, YEAR, MONTH;
```

```{sql connection = con, output.var = tulare_court}
SELECT *
FROM "54_TULARE-DWH_UAT"."SECURE_SHARE"."FACT_COURT_CASE";
```

```{sql connection = con, output.var = tulare_assessment}
SELECT *
FROM "54_TULARE-DWH_UAT"."SECURE_SHARE"."FACT_PRETRIAL_ASSESSMENT";
```

```{sql connection = con, output.var = tuolumne_assessment}
SELECT *
FROM "55_TUOLUMNE-DWH_UAT"."SECURE_SHARE"."FACT_PRETRIAL_ASSESSMENT";
```

```{sql connection = con, output.var = napa_assess}
SELECT *
FROM "28_NAPA-DWH_UAT"."SECURE_SHARE"."FACT_PRETRIAL_";
```


UAT
```{r}
load("C:/Work/PretrialAssessmentPilot/tularesb36.RData")

tularesb36 %>%
  count(year(assess_date), month(assess_date))

tulare_assessment %>%
  count(DIM_ASSESSMENT_TOOL_KEY)
  filter(DIM_ASSESSMENT_TOOL_KEY == 1) %>%
  count()
  
tulare_court %>%
  count(CASE_ID, CASE_KEY)
  
tulare_kpi

tulare_assessment %>%
  distinct()

tuolumne_assessment %>%
  # ungroup() %>%
  filter(DIM_ASSESSMENT_DATE_KEY <= 20201231 & DIM_ASSESSMENT_DATE_KEY >= 20200601) %>%
  distinct(PRETRIAL_ASSESSMENT_KEY)

tulare_kpi
```
# LA check
```{sql connection = con, output.var = la_snow}

SELECT Booking_ID, Public_Case_Number, Booking_Date, Case_Filed_Date, Pretrial_Period_End_Date, County
FROM "DWH_UAT"."DWH"."AGG_PRETRIAL_KPI"
WHERE YEAR(Booking_Date) = 2020
AND Public_Case_Number IS NOT NULL;

```

```{sql connection = con, output.var = la_snow}

SELECT Booking_ID, Public_Case_Number, Booking_Date, Case_Filed_Date, Pretrial_Period_End_Date
FROM "DWH_UAT"."DWH"."AGG_PRETRIAL_KPI"
WHERE YEAR(Booking_Date) = 2020
AND County = 'Los Angeles'
AND Public_Case_Number IS NOT NULL;

```

```{r}
la_snow <- la_snow %>%
  filter(year(CASE_FILED_DATE) == 2020)

la_cjs <- full_df %>%
  filter(county == "los_angeles") %>%
  filter(new_arrest_flag == 1) %>%
  filter(year(book_date) == 2020) %>%
  filter(!is.na(court_charge_original))

la_cjs %>%
  anti_join(la_snow , by = c("book_num" = "BOOKING_ID")) %>%
  select(book_num, local_id, book_date, release_date, file_date, pretrial_end_date, court_case_id, court_docket_id)

la_snow %>%
  filter(BOOKING_ID %in% c("5702599", "5835607", "5835609", "5835612", "5835615", "5835661", "5835694", "5835695", "5835777", "5614853"))

la_snow %>%
  anti_join(la_cjs , by = c("BOOKING_ID" = "book_num")) 

full_df %>%
  filter(county == "los_angeles") %>%
  filter(book_num %in% c("5957969", "5901904", "5896123", "5896123"))%>%
  select(book_num, local_id, book_date, release_date, file_date, pretrial_end_date, court_case_id, court_docket_id)

court_df %>%
  filter(grepl("LAX0AR1154401", court_docket_id))

book_df %>%
  filter(book_num == 5702599)
  
court_df %>%
  select(local_id)

book_df %>%
  filter(cii == "0025789724")
```

# San Mateo check
```{sql connection = con, output.var = sm_snow}

SELECT County, Booking_Key, Public_Case_Number, Booking_Date, Assessment_Date, Release_Date, Case_Filed_Date, Arraignment_Date, Pretrial_Period_End_Date, Failure_To_Appear_Date, Is_Release_Eligible, Is_Released_Pretrial, Recidivism_Date, Has_New_Criminal_Activity
FROM "41_SANMATEO-DWH_UAT"."SECURE_SHARE"."AGG_PRETRIAL_KPI"
WHERE County = 'San Mateo'
AND Is_Release_Eligible = 'Yes';

```

```{r}
sm_cjs <- full_df %>%
  filter(county == "san_mateo") %>%
  filter(new_arrest_flag == 1) %>%
  filter(book_date >= "2018-07-01", 
         book_date <= "2020-12-31") %>%
  mutate(release_elig_flag = if_else(new_arrest_flag == 1 & (is.na(pretrial_end_date)  | !pretrial_end_date < book_date), 1, 0),
         pretrial_release_flag = if_else(new_arrest_flag == 1 & (!is.na(release_date) & is.na(pretrial_end_date) & !is.na(court_charge_original) | release_date < pretrial_end_date), 1, 0)) %>%
  select(book_num, court_docket_id, book_date, assessment_date, release_date, file_date, arraignment_date, pretrial_end_date, fta_date, release_elig_flag, pretrial_release_flag, cii)


sm_cjs <- full_df %>%
  filter(county == "san_mateo") %>%
  filter(new_arrest_flag == 1) %>%
  filter(is.na(pretrial_end_date) | !pretrial_end_date < book_date) %>%
  #filter(!is.na(pretrial_end_date)) %>%
  filter(book_date > "2018-07-01", 
       book_date <= "2020-12-31") %>%
  filter(is.na(pretrial_end_date) | year(pretrial_end_date) != 2021) %>%
  mutate(pretrial_complete_flag = if_else(new_arrest_flag == 1 & !is.na(pretrial_end_date), 1, 0),
         pretrial_release_flag = if_else(new_arrest_flag == 1 & (!is.na(release_date) & is.na(pretrial_end_date) & !is.na(court_charge_original) | release_date < pretrial_end_date), 1, 0)) %>%
  select(book_num, court_case_id, court_docket_id, book_date, assessment_date, release_date, file_date, arraignment_date, pretrial_end_date, fta_date, pretrial_release_flag, cii, contains("recid"))



sm_cjs %>%
  mutate(book_num = as.numeric(book_num)) %>%
  filter(!is.na(pretrial_end_date)) %>%
  inner_join(sm_snow %>%
               mutate(BOOKING_KEY = 100*as.numeric(BOOKING_KEY)), by = c("book_num" = "BOOKING_KEY")) %>%
  filter(HAS_NEW_CRIMINAL_ACTIVITY == "Yes" & (is.na(recid_arrested_flag | recid_arrested_flag == 0))) 

  filter(!is.na(court_case_id) & is.na(PUBLIC_CASE_NUMBER))
  filter(court_docket_id != PUBLIC_CASE_NUMBER) %>%
  filter(court_docket_id != "NULL") %>%
  filter(pretrial_end_date >=book_date) %>%
  select(court_docket_id, PUBLIC_CASE_NUMBER, pretrial_end_date, PRETRIAL_PERIOD_END_DATE, book_date, book_num, everything())

  filter(IS_RELEASED_PRETRIAL == "Yes") %>%
  filter(is.na(pretrial_release_flag) | pretrial_release_flag == 0)

sm_cjs %>%
  count(pretrial_end_date < book_date)

sm_cjs %>%
  count(pretrial_release_flag)

sm_cjs %>%
  count(IS_RELEASED_PRETRIAL)

sm_snow %>%
  mutate(BOOKING_KEY = 100*as.numeric(BOOKING_KEY)) %>%
  anti_join(sm_cjs %>%
               mutate(book_num = as.numeric(book_num)), by = c("BOOKING_KEY" = "book_num"))
  count(IS_RELEASED_PRETRIAL)

full_df %>%
  filter(county == "san_mateo") %>%
  count(year(book_date), month(book_date))
  filter(grepl("0007065579", cii)) %>%
  select(book_num, book_date, release_date, pretrial_end_date, court_case_id, disposition_date, disposition_type, sentence_date, pretrial_end_date, pretrial_end_date_doj) %>%
  arrange(book_date)
  
sm_snow %>%
  filter(HAS_NEW_CRIMINAL_ACTIVITY == "Yes") %>%
  #filter(is.na(PRETRIAL_PERIOD_END_DATE)) %>%
  #count(RECIDIVISM_DATE > BOOKING_DATE)
  #count(RECIDIVISM_DATE > BOOKING_DATE)
  #count(is.na(PRETRIAL_PERIOD_END_DATE), RECIDIVISM_DATE < PRETRIAL_PERIOD_END_DATE)
  count(IS_RELEASED_PRETRIAL, HAS_NEW_CRIMINAL_ACTIVITY, is.na(PRETRIAL_PERIOD_END_DATE))
```

# Santa Barbara check
```{sql connection = con, output.var = sb_snow}

SELECT County, Booking_Key, Public_Case_Number, Booking_Date, Assessment_Date, Release_Date, Case_Filed_Date, Arraignment_Date, Pretrial_Period_End_Date, Failure_To_Appear_Date, Is_Release_Eligible, Is_Released_Pretrial
FROM "42_SANTABARBARA-DWH_UAT"."SECURE_SHARE"."AGG_PRETRIAL_KPI"
WHERE County = 'Santa Barbara'
AND year(Booking_Date) = 2020;

```

```{r}
sb_cjs <- full_df %>%
  filter(county == "santa_barbara") %>%
  #filter(new_arrest_flag == 1) %>%
  filter(year(book_date) == 2020) %>%
  mutate(release_elig_flag = if_else(new_arrest_flag == 1 & (is.na(pretrial_end_date)  | !pretrial_end_date < book_date), 1, 0),
         pretrial_release_flag = if_else(new_arrest_flag == 1 & (!is.na(release_date) & is.na(pretrial_end_date) & !is.na(court_charge_original) | release_date < pretrial_end_date), 1, 0)) %>%
  select(book_num, court_docket_id, court_case_id, book_date, assessment_date, release_date, file_date, arraignment_date, pretrial_end_date, fta_date, release_elig_flag, pretrial_release_flag) %>%
  filter(!grepl("\\.", book_num))#santa barbara has messed up book_nums, filter these out


sb_cjs %>%
  inner_join(sb_snow, by = c("book_num" = "BOOKING_KEY")) %>%
  filter(court_docket_id != PUBLIC_CASE_NUMBER) %>%
  filter(court_docket_id != "NULL") %>%
  filter(pretrial_end_date >=book_date) %>%
  select(court_docket_id, PUBLIC_CASE_NUMBER, pretrial_end_date, PRETRIAL_PERIOD_END_DATE, book_date, book_num, everything())

  filter(IS_RELEASED_PRETRIAL == "Yes") %>%
  filter(is.na(pretrial_release_flag) | pretrial_release_flag == 0)
```

#Tuolumne check
```{sql connection = con, output.var = tu_snow}

SELECT County, Booking_Key, Public_Case_Number, Booking_Date, Assessment_Date, Release_Date, Case_Filed_Date, Arraignment_Date, Pretrial_Period_End_Date, Failure_To_Appear_Date, Is_Release_Eligible, Is_Released_Pretrial, Recidivism_Date, Has_New_Criminal_Activity
FROM "55_TUOLUMNE-DWH_UAT"."SECURE_SHARE"."AGG_PRETRIAL_KPI"
WHERE County = 'Tuolumne';

```

```{r}
tu_cjs <- full_df %>%
  filter(county == "tuolumne") %>%
  filter(new_arrest_flag == 1) %>%
  filter(is.na(pretrial_end_date) | !pretrial_end_date < book_date) %>%
  #filter(!is.na(pretrial_end_date)) %>%
  filter(book_date > "2018-07-01", 
       book_date <= "2020-12-31") %>%
  filter(is.na(pretrial_end_date) | year(pretrial_end_date) != 2021) %>%
  mutate(pretrial_complete_flag = if_else(new_arrest_flag == 1 & !is.na(pretrial_end_date), 1, 0),
         pretrial_release_flag = if_else(new_arrest_flag == 1 & (!is.na(release_date) & is.na(pretrial_end_date) & !is.na(court_charge_original) | release_date < pretrial_end_date), 1, 0)) %>%
  select(book_num, court_case_id, court_docket_id, book_date, assessment_date, release_date, file_date, arraignment_date, pretrial_end_date, fta_date, pretrial_release_flag, cii, contains("recid"))




tu_cjs %>%
  inner_join(tu_snow, by = c("book_num" = "BOOKING_KEY")) %>%
  filter(!is.na(pretrial_end_date), is.na(PRETRIAL_PERIOD_END_DATE)) %>%
  #filter(court_case_id == "CRF58202" | court_docket_id == "CRF58202")
  filter(book_num == "B0110819")
  
full_df %>%
  filter(county == "tuolumne") %>%
  filter(court_case_id == "" & !is.na(court_docket_id)) %>%
  count(is.na(pretrial_end_date))
  filter(book_num == "B0110819") %>%
  select(book_num, court_case_id, court_docket_id)
  filter(cii == "0027912064") %>%
  filter(county == "tuolumne") %>%
  arrange(book_date)
```


```{r}
filter(!is.na(court_case_id) & is.na(PUBLIC_CASE_NUMBER))
  filter(court_docket_id != PUBLIC_CASE_NUMBER) %>%
  filter(court_docket_id != "NULL") %>%
  filter(pretrial_end_date >=book_date) %>%
  select(court_docket_id, PUBLIC_CASE_NUMBER, pretrial_end_date, PRETRIAL_PERIOD_END_DATE, book_date, book_num, everything())

  filter(IS_RELEASED_PRETRIAL == "Yes") %>%
  filter(is.na(pretrial_release_flag) | pretrial_release_flag == 0)

sm_cjs %>%
  count(pretrial_end_date < book_date)

sm_cjs %>%
  count(pretrial_release_flag)

sm_cjs %>%
  count(IS_RELEASED_PRETRIAL)

sm_snow %>%
  mutate(BOOKING_KEY = 100*as.numeric(BOOKING_KEY)) %>%
  anti_join(sm_cjs %>%
               mutate(book_num = as.numeric(book_num)), by = c("BOOKING_KEY" = "book_num"))
  count(IS_RELEASED_PRETRIAL)

full_df %>%
  filter(county == "san_mateo") %>%
  count(year(book_date), month(book_date))
  filter(grepl("0007065579", cii)) %>%
  select(book_num, book_date, release_date, pretrial_end_date, court_case_id, disposition_date, disposition_type, sentence_date, pretrial_end_date, pretrial_end_date_doj) %>%
  arrange(book_date)
  
sm_snow %>%
  filter(HAS_NEW_CRIMINAL_ACTIVITY == "Yes") %>%
  #filter(is.na(PRETRIAL_PERIOD_END_DATE)) %>%
  #count(RECIDIVISM_DATE > BOOKING_DATE)
  #count(RECIDIVISM_DATE > BOOKING_DATE)
  #count(is.na(PRETRIAL_PERIOD_END_DATE), RECIDIVISM_DATE < PRETRIAL_PERIOD_END_DATE)
  count(IS_RELEASED_PRETRIAL, HAS_NEW_CRIMINAL_ACTIVITY, is.na(PRETRIAL_PERIOD_END_DATE))
```


#Napa check
```{sql connection = con, output.var = na_snow}

SELECT County, Booking_Key, Booking_ID, Public_Case_Number, Booking_Date, Assessment_Date, Release_Date, Case_Filed_Date, Arraignment_Date, Pretrial_Period_End_Date, Failure_To_Appear_Date, Is_Release_Eligible, Is_Released_Pretrial, Recidivism_Date, Has_New_Criminal_Activity
FROM "28_NAPA-DWH_UAT"."SECURE_SHARE"."AGG_PRETRIAL_KPI"
WHERE County = 'Napa';

```

```{r}
tu_cjs <- full_df %>%
  filter(county == "tuolumne") %>%
  filter(new_arrest_flag == 1) %>%
  filter(is.na(pretrial_end_date) | !pretrial_end_date < book_date) %>%
  #filter(!is.na(pretrial_end_date)) %>%
  filter(book_date > "2018-07-01", 
       book_date <= "2020-12-31") %>%
  filter(is.na(pretrial_end_date) | year(pretrial_end_date) != 2021) %>%
  mutate(pretrial_complete_flag = if_else(new_arrest_flag == 1 & !is.na(pretrial_end_date), 1, 0),
         pretrial_release_flag = if_else(new_arrest_flag == 1 & (!is.na(release_date) & is.na(pretrial_end_date) & !is.na(court_charge_original) | release_date < pretrial_end_date), 1, 0)) %>%
  select(book_num, court_case_id, court_docket_id, book_date, assessment_date, release_date, file_date, arraignment_date, pretrial_end_date, fta_date, pretrial_release_flag, cii, contains("recid"))




tu_cjs %>%
  inner_join(tu_snow, by = c("book_num" = "BOOKING_KEY")) %>%
  filter(!is.na(pretrial_end_date), is.na(PRETRIAL_PERIOD_END_DATE)) %>%
  #filter(court_case_id == "CRF58202" | court_docket_id == "CRF58202")
  filter(book_num == "B0110819")
  
full_df %>%
  filter(county == "tuolumne") %>%
  filter(court_case_id == "" & !is.na(court_docket_id)) %>%
  count(is.na(pretrial_end_date))
  filter(book_num == "B0110819") %>%
  select(book_num, court_case_id, court_docket_id)
  filter(cii == "0027912064") %>%
  filter(county == "tuolumne") %>%
  arrange(book_date)
```


```{r}
filter(!is.na(court_case_id) & is.na(PUBLIC_CASE_NUMBER))
  filter(court_docket_id != PUBLIC_CASE_NUMBER) %>%
  filter(court_docket_id != "NULL") %>%
  filter(pretrial_end_date >=book_date) %>%
  select(court_docket_id, PUBLIC_CASE_NUMBER, pretrial_end_date, PRETRIAL_PERIOD_END_DATE, book_date, book_num, everything())

  filter(IS_RELEASED_PRETRIAL == "Yes") %>%
  filter(is.na(pretrial_release_flag) | pretrial_release_flag == 0)

sm_cjs %>%
  count(pretrial_end_date < book_date)

sm_cjs %>%
  count(pretrial_release_flag)

sm_cjs %>%
  count(IS_RELEASED_PRETRIAL)

sm_snow %>%
  mutate(BOOKING_KEY = 100*as.numeric(BOOKING_KEY)) %>%
  anti_join(sm_cjs %>%
               mutate(book_num = as.numeric(book_num)), by = c("BOOKING_KEY" = "book_num"))
  count(IS_RELEASED_PRETRIAL)

full_df %>%
  filter(county == "san_mateo") %>%
  count(year(book_date), month(book_date))
  filter(grepl("0007065579", cii)) %>%
  select(book_num, book_date, release_date, pretrial_end_date, court_case_id, disposition_date, disposition_type, sentence_date, pretrial_end_date, pretrial_end_date_doj) %>%
  arrange(book_date)
  
sm_snow %>%
  filter(HAS_NEW_CRIMINAL_ACTIVITY == "Yes") %>%
  #filter(is.na(PRETRIAL_PERIOD_END_DATE)) %>%
  #count(RECIDIVISM_DATE > BOOKING_DATE)
  #count(RECIDIVISM_DATE > BOOKING_DATE)
  #count(is.na(PRETRIAL_PERIOD_END_DATE), RECIDIVISM_DATE < PRETRIAL_PERIOD_END_DATE)
  count(IS_RELEASED_PRETRIAL, HAS_NEW_CRIMINAL_ACTIVITY, is.na(PRETRIAL_PERIOD_END_DATE))
```

# Old
```{r}
mydata <- dbGetQuery(con,"SELECT * FROM \"54_TULARE-DWH_UAT\".\"SECURE_SHARE\".\"DIM_PLEA_DATE\"")

tbl(con, "AGG_PRETRIAL_KPI")

tbl(con, "54_TULARE-DWH_UAT\".\"SECURE_SHARE\".\"AGG_PRETRIAL_KPI")

head(mydata)

dbListTables(con)

tbl(con, in_schema("SECURE_SHARE", "DIM_PLEA_DATE"))
```

