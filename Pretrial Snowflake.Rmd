---
title: "R Notebook"
output: html_notebook
---
Install
```{r}
#install.packages(c("DBI", "dplyr","dbplyr","odbc"))
#install.packages("DBI")
```

# Load

Libraries
```{r setup}
library(DBI)
library(dplyr)
library(dbplyr)
library(odbc)
library(tidyverse)
library(openxlsx)
library(lubridate)
```

Connection
```{r eval=FALSE, include=FALSE}
con <- dbConnect(odbc::odbc(), "snowflake_pretrial", uid ="Sal.Lempert@jud.ca.gov", pwd = .rs.askForPassword("Password"))
```

# Aggregate Data

Snowflake Aggregate KPIs by County
```{sql connection = con, output.var = sf_kpi}
SELECT County,
SUM(Booking_Count) AS Booking_Count,
SUM(Release_Eligible_Count) AS Release_Eligible_Count,
SUM(Booking_Assessed_Count) AS Booking_Assessed_Count,
SUM(Released_To_Pretrial_Services_Count) AS Released_To_Pretrial_Services_Count,
SUM(Released_Pretrial_Count) AS Released_Pretrial_Count,
SUM(Failure_To_Appear_Count) AS Failure_To_Appear_Count,
SUM(New_Crimnal_Activity_Count) AS New_Crimnal_Activity_Count
FROM "DWH_UAT"."DWH"."AGG_PRETRIAL_KPI"
WHERE (Booking_date BETWEEN '2018-07-01' AND '2020-12-31') AND (COUNTY <> 'Tulare')
GROUP BY County
ORDER BY County;
```

Snowflake Aggregate KPIs by County, Month, and Year
```{sql connection = con, output.var = sf_kpi_month}
SELECT County, YEAR(Booking_date) AS YEAR, MONTH(Booking_date) AS MONTH, 
SUM(Booking_Count) AS Booking_Count,
SUM(Release_Eligible_Count) AS Release_Eligible_Count,
SUM(Booking_Assessed_Count) AS Booking_Assessed_Count,
SUM(Released_To_Pretrial_Services_Count) AS Released_To_Pretrial_Services_Count,
SUM(Released_Pretrial_Count) AS Released_Pretrial_Count,
SUM(Failure_To_Appear_Count) AS Failure_To_Appear_Count,
SUM(New_Crimnal_Activity_Count) AS New_Crimnal_Activity_Count
FROM "DWH_UAT"."DWH"."AGG_PRETRIAL_KPI"
WHERE (Booking_date BETWEEN '2018-07-01' AND '2020-12-31') AND (COUNTY <> 'Tulare')
GROUP BY County, YEAR, MONTH
ORDER BY County, YEAR, MONTH;
```

JCC KPIs by County/ JCC KPIs by County, Month, and Year
```{r}
jcc_kpi <- read.xlsx("C:/Work/PretrialAssessmentPilot/Snowflake/kpi_from_CJS.xlsx", sheet = 1)

jcc_kpi <- jcc_kpi %>%
  mutate(county = gsub("_", " ", county),
         county = tools::toTitleCase(county))

names(jcc_kpi) <- c("COUNTY", "BOOKING_COUNT", "RELEASE_ELIGIBLE_COUNT", "BOOKING_ASSESSED_COUNT", "RELEASED_TO_PRETRIAL_SERVICES_COUNT",
                    "OTHER_RELEASE_COUNT", "TWO_DAY_RELEASE_COUNT", "PRE_ARR_RELEASE_COUNT", "RELEASED_PRETRIAL_COUNT", "RELEASES_COUNT",
                    "FAILURE_TO_APPEAR_COUNT", "NEW_CRIMNAL_ACTIVITY_COUNT", "VIOLATION_COUNT", "PRETRIAL_COMPLETE_COUNT")

jcc_kpi_month <- read.xlsx("C:/Work/PretrialAssessmentPilot/Snowflake/kpi_from_CJS.xlsx", sheet = 2)

jcc_kpi_month <- jcc_kpi_month %>%
  mutate(county = gsub("_", " ", county),
         county = tools::toTitleCase(county))

names(jcc_kpi_month) <- c("COUNTY", "YEAR", "MONTH", "BOOKING_COUNT", "RELEASE_ELIGIBLE_COUNT", "BOOKING_ASSESSED_COUNT",
                          "RELEASED_TO_PRETRIAL_SERVICES_COUNT", "OTHER_RELEASE_COUNT", "TWO_DAY_RELEASE_COUNT", "PRE_ARR_RELEASE_COUNT",
                          "RELEASED_PRETRIAL_COUNT", "RELEASES_COUNT", "FAILURE_TO_APPEAR_COUNT", "NEW_CRIMNAL_ACTIVITY_COUNT", 
                          "VIOLATION_COUNT", "PRETRIAL_COMPLETE_COUNT")
```

# UAT Matching
County
```{r}
match_kpi <- jcc_kpi %>%
  select(names(sf_kpi)) %>%
  semi_join(sf_kpi, by = "COUNTY") %>%
  semi_join(jcc_kpi, by = "COUNTY")

sf_kpi <- sf_kpi %>%
  semi_join(match_kpi, by = "COUNTY")

match_kpi[2:length(match_kpi)] <- round(sf_kpi[2:length(sf_kpi)]/match_kpi[2:length(match_kpi)]*100)

names(jcc_kpi)[2:ncol(jcc_kpi)] <- paste0(names(jcc_kpi)[2:ncol(jcc_kpi)], "_JCC")
names(sf_kpi)[2:ncol(sf_kpi)] <- paste0(names(sf_kpi)[2:ncol(sf_kpi)], "_CLOUD")
names(match_kpi)[2:ncol(match_kpi)] <- paste0(names(match_kpi)[2:ncol(match_kpi)], "_MATCH")

match_kpi2 <- left_join(jcc_kpi, sf_kpi, by = "COUNTY") %>%
  left_join(match_kpi, by = "COUNTY")


match_kpi2 <- match_kpi2 %>%
  select(COUNTY, order(names(match_kpi2)))

write.xlsx(match_kpi2, file = "Match Rate Between Snowflake and JCC Pretrial Data.xlsx", as.table = T)

shell.exec(getwd())
```

County, Year, Month
```{r}
match_kpi_month <- jcc_kpi_month %>%
  select(names(sf_kpi_month)) %>%
  semi_join(sf_kpi_month, by = c("COUNTY", "YEAR", "MONTH"))

match_kpi_month[4:length(match_kpi_month)] <- round(sf_kpi_month[4:length(sf_kpi_month)]/match_kpi_month[4:length(match_kpi_month)]*100)

match_kpi_month <- left_join(jcc_kpi_month, sf_kpi_month, by = c("COUNTY", "YEAR", "MONTH")) %>%
  left_join(match_kpi_month, by = c("COUNTY", "YEAR", "MONTH")) 

names(match_kpi_month) <- gsub("\\.x", "_JCC", names(match_kpi_month))
names(match_kpi_month) <- gsub("\\.y", "_SF", names(match_kpi_month))
# names(match_kpi_month) <- gsub("\\.x", "_MR", names(match_kpi_month))


match_kpi_month <- match_kpi_month %>%
  select(COUNTY, YEAR, MONTH, order(names(match_kpi_month)))

court_df <- court_df2
```

# Tulare Special Check
Snowflake Aggregate KPIs by County
```{sql connection = con, output.var = tulare_kpi}
SELECT County,
SUM(Booking_Count) AS Booking_Count,
SUM(Release_Eligible_Count) AS Release_Eligible_Count,
SUM(Booking_Assessed_Count) AS Booking_Assessed_Count,
SUM(Released_To_Pretrial_Services_Count) AS Released_To_Pretrial_Services_Count,
SUM(Released_Pretrial_Count) AS Released_Pretrial_Count,
SUM(Failure_To_Appear_Count) AS Failure_To_Appear_Count,
SUM(New_Crimnal_Activity_Count) AS New_Crimnal_Activity_Count
FROM "DWH_UAT"."DWH"."AGG_PRETRIAL_KPI"
WHERE (Booking_date BETWEEN '2018-07-01' AND '2020-12-31') AND (COUNTY = 'Tulare')
GROUP BY County
ORDER BY County;
```

Snowflake Aggregate KPIs by County, Month, and Year
```{sql connection = con, output.var = tulare_kpi_month}
SELECT County, YEAR(Booking_date) AS YEAR, MONTH(Booking_date) AS MONTH, 
SUM(Booking_Count) AS Booking_Count,
SUM(Release_Eligible_Count) AS Release_Eligible_Count,
SUM(Booking_Assessed_Count) AS Booking_Assessed_Count,
SUM(Released_To_Pretrial_Services_Count) AS Released_To_Pretrial_Services_Count,
SUM(Released_Pretrial_Count) AS Released_Pretrial_Count,
SUM(Failure_To_Appear_Count) AS Failure_To_Appear_Count,
SUM(New_Crimnal_Activity_Count) AS New_Crimnal_Activity_Count
FROM "DWH_UAT"."DWH"."AGG_PRETRIAL_KPI"
WHERE (Booking_date BETWEEN '2018-07-01' AND '2020-12-31') AND (COUNTY = 'Tulare')
GROUP BY County, YEAR, MONTH
ORDER BY County, YEAR, MONTH;
```

```{sql connection = con, output.var = tulare_court}
SELECT *
FROM "54_TULARE-DWH_UAT"."SECURE_SHARE"."FACT_COURT_CASE";
```

```{sql connection = con, output.var = tulare_assessment}
SELECT *
FROM "54_TULARE-DWH_UAT"."SECURE_SHARE"."FACT_PRETRIAL_ASSESSMENT";
```

```{sql connection = con, output.var = tuolumne_assessment}
SELECT *
FROM "55_TUOLUMNE-DWH_UAT"."SECURE_SHARE"."FACT_PRETRIAL_ASSESSMENT";
```

```{sql connection = con, output.var = napa_assess}
SELECT *
FROM "28_NAPA-DWH_UAT"."SECURE_SHARE"."FACT_PRETRIAL_";
```


UAT
```{r}
load("C:/Work/PretrialAssessmentPilot/tularesb36.RData")

tularesb36 %>%
  count(year(assess_date), month(assess_date))

tulare_assessment %>%
  count(DIM_ASSESSMENT_TOOL_KEY)
  filter(DIM_ASSESSMENT_TOOL_KEY == 1) %>%
  count()
  
tulare_court %>%
  count(CASE_ID, CASE_KEY)
  
tulare_kpi

tulare_assessment %>%
  distinct()

tuolumne_assessment %>%
  # ungroup() %>%
  filter(DIM_ASSESSMENT_DATE_KEY <= 20201231 & DIM_ASSESSMENT_DATE_KEY >= 20200601) %>%
  distinct(PRETRIAL_ASSESSMENT_KEY)

tulare_kpi
```
# LA check
```{sql connection = con, output.var = la_snow}

SELECT County, Booking_Key, Booking_ID, Public_Case_Number, Booking_Date, Assessment_Date, Release_Date, Case_Filed_Date, Arraignment_Date, Pretrial_Period_End_Date, Failure_To_Appear_Date, Is_Release_Eligible, Is_Released_Pretrial, Recidivism_Date, Has_New_Criminal_Activity, Has_Failure_To_Appear
FROM "19_LOSANGELES-DWH_UAT"."SECURE_SHARE"."AGG_PRETRIAL_KPI"
WHERE YEAR(Booking_Date) = 2020;

```

```{sql connection = con, output.var = la_snow}

SELECT Booking_ID, Public_Case_Number, Booking_Date, Assessment_Date, Release_Date, Case_Filed_Date, Arraignment_Date, Pretrial_Period_End_Date, Failure_To_Appear_Date, Is_Release_Eligible, Is_Released_Pretrial, Recidivism_Date, Has_New_Criminal_Activity
FROM "DWH_UAT"."DWH"."AGG_PRETRIAL_KPI"
WHERE YEAR(Booking_Date) = 2020
AND County = 'Los Angeles';

```

```{r}
# la_snow <- la_snow %>%
#   filter(year(CASE_FILED_DATE) == 2020)

la_cjs <- full_df %>%
  filter(county == "los_angeles") %>%
  filter(new_arrest_flag == 1) %>%
  filter(year(book_date) == 2020) #%>%
  #filter(!is.na(court_charge_original))
```

```{r}
la_cjs %>%
    mutate(pretrial_complete_flag = if_else(new_arrest_flag == 1 & !is.na(pretrial_end_date), 1, 0),
         pretrial_release_flag = if_else(new_arrest_flag == 1 & (!is.na(release_date) & is.na(pretrial_end_date) & !is.na(court_charge_original) | release_date < pretrial_end_date), 1, 0),
         pts_release_flag = if_else(new_arrest_flag == 1 & release_decision == "Monitor", 1, 0),
         pre_arr_release = if_else(new_arrest_flag == 1 & pretrial_release_flag == 1 & release_date < arraignment_date, 1, 0),
         no_court_case = if_else(new_arrest_flag == 1 & is.na(court_charge_original), 1, 0),
         has_case = if_else(new_arrest_flag == 1 & !is.na(court_charge_original), 1, 0),
         fta_flag = if_else(pretrial_release_flag ==1 & (fta_flag == 1|arrest_fta_flag == 1|court_fta_flag == 1), 1, 0),
         recid_arrested_flag = if_else(pretrial_release_flag ==1, recid_arrested_flag, 0),
         violation_flag = if_else(fta_flag == 1 | recid_arrested_flag == 1, 1, 0),
         no_violation_flag = if_else(pretrial_release_flag == 1 & violation_flag != 1, 1, 0)) %>%
  inner_join(la_snow, by = c("book_num" = "BOOKING_ID")) %>%
  filter(IS_RELEASED_PRETRIAL == "Yes", is.na(pretrial_release_flag) | pretrial_release_flag == 0) %>%
  select(book_num, court_docket_id, PUBLIC_CASE_NUMBER, book_date, BOOKING_DATE, release_date, RELEASE_DATE, release_type, pretrial_end_date, PRETRIAL_PERIOD_END_DATE) %>%
  filter(!is.na(pretrial_end_date))# %>%
  pull(book_num)


  filter(IS_RELEASED_PRETRIAL == "Yes", is.na(pretrial_release_flag) | pretrial_release_flag == 0)

court_df %>%
  filter(book_num == "5839888")
```


```{r}
la_cjs %>%
  anti_join(la_snow , by = c("book_num" = "BOOKING_ID")) %>%
  select(book_num, local_id, book_date, release_date, file_date, pretrial_end_date, court_case_id, court_docket_id)

la_snow %>%
  filter(BOOKING_ID %in% c("5702599", "5835607", "5835609", "5835612", "5835615", "5835661", "5835694", "5835695", "5835777", "5614853"))

la_snow %>%
  inner_join(la_cjs , by = c("BOOKING_ID" = "book_num")) %>%
  filter(!is.na(PUBLIC_CASE_NUMBER)) %>%
  filter(is.na(court_charge_original))

la_cjs %>%
  count(is.na(file_date))
  count(file_date > release_date)
```

```{r}
la_snow %>%
  filter(!is.na(PUBLIC_CASE_NUMBER)) %>%
  anti_join(join_df, by = c("PUBLIC_CASE_NUMBER" = "court_docket_id"))

join_df %>%
  mutate(book_num = as.character(book_num)) %>%
  inner_join(la_snow, by = c("book_num" = "BOOKING_ID")) %>%
  select(book_num, court_docket_id, PUBLIC_CASE_NUMBER)
  filter(court_docket_id == PUBLIC_CASE_NUMBER) 
  

```
```{r}
court_df %>%
  filter(grepl("BA47035201", court_docket_id)) %>%
  select(court_docket_id, court_charge_original, file_date, book_num)
```
```{r}
book_df %>%
  filter(grepl("5425724", book_num)) %>%
  select(book_num, court_docket_id)
```
```{r}
join_df %>%
  filter(grepl("BA47035201", court_docket_id)) %>%
  select(court_docket_id, court_charge_original, file_date, book_num, book_date)

join_df %>%
  filter(grepl("0GD0081201", court_docket_id)) %>%
  select(court_docket_id, court_charge_original, file_date, book_num, book_date, cii, local_id, first_name, last_name, dob, race, sex)

court_df %>%
  #filter(grepl("5874687", book_num)) %>%
  filter(grepl("0GD0081201", court_docket_id)) %>%
  select(court_docket_id, file_date, book_num, cii, first_name, last_name)

full_df %>%
  filter(grepl("5874687", book_num)) %>%
  select(court_docket_id, court_charge_original, file_date, book_num, book_date, cii, local_id, first_name, last_name, dob, race, sex)

court_df3 %>%
  filter(grepl("0GD0081201", CASE_COURT_CASE_NUMBER))

court_df3 %>%
  filter(grepl("8GD0473601", CASE_COURT_CASE_NUMBER))
```

```{r}
full_df %>%
  filter(county == "los_angeles") %>%
  filter(book_num %in% c("5957969", "5901904", "5896123", "5896123"))%>%
  select(book_num, local_id, book_date, release_date, file_date, pretrial_end_date, court_case_id, court_docket_id)

court_df %>%
  filter(grepl("LAX0AR1154401", court_docket_id))

book_df %>%
  filter(book_num == 5702599)
  
court_df %>%
  select(local_id)

book_df %>%
  filter(cii == "0025789724")

la_cjs %>%
  mutate(pretrial_complete_flag = if_else(new_arrest_flag == 1 & !is.na(pretrial_end_date), 1, 0),
         pretrial_release_flag = if_else(new_arrest_flag == 1 & (!is.na(release_date) & is.na(pretrial_end_date) & !is.na(court_charge_original) | release_date < pretrial_end_date), 1, 0),
         pts_release_flag = if_else(new_arrest_flag == 1 & release_decision == "Monitor", 1, 0),
         pre_arr_release = if_else(new_arrest_flag == 1 & pretrial_release_flag == 1 & release_date < arraignment_date, 1, 0),
         no_court_case = if_else(new_arrest_flag == 1 & is.na(court_charge_original), 1, 0),
         has_case = if_else(new_arrest_flag == 1 & !is.na(court_charge_original), 1, 0),
         fta_flag = if_else(pretrial_release_flag ==1 & (fta_flag == 1|arrest_fta_flag == 1|court_fta_flag == 1), 1, 0),
         recid_arrested_flag = if_else(pretrial_release_flag ==1, recid_arrested_flag, 0),
         violation_flag = if_else(fta_flag == 1 | recid_arrested_flag == 1, 1, 0),
         no_violation_flag = if_else(pretrial_release_flag == 1 & violation_flag != 1, 1, 0)) %>%
  #filter(fta_flag ==1) %>%
  inner_join(la_snow, by = c("book_num" = "BOOKING_ID")) %>%
  #count(fta_flag, HAS_FAILURE_TO_APPEAR)
  #filter(HAS_FAILURE_TO_APPEAR == "No") %>%
  count(year(CASE_FILED_DATE) == 2021)
  count(is.na(PUBLIC_CASE_NUMBER), is.na(court_case_id))
  select(book_num, cii, court_case_id, court_docket_id, PUBLIC_CASE_NUMBER, book_date, BOOKING_DATE, file_date, CASE_FILED_DATE, pretrial_end_date, PRETRIAL_PERIOD_END_DATE, FAILURE_TO_APPEAR_DATE)
  
  
la_cjs %>%
  filter(nchar(court_docket_id)!=10) %>%
  select(court_docket_id) %>%
  distinct()
```

```{r}
full_df %>%
  filter(county == "los_angeles") %>%
  filter(book_num %in% c("5994027", "5852340", "5842201", "5634444"))%>%
  select(book_num, local_id, book_date, release_date, file_date, pretrial_end_date, court_case_id, court_docket_id)

```

# San Mateo check
```{sql connection = con, output.var = sm_snow}

SELECT County, Booking_Key, Public_Case_Number, Booking_Date, Assessment_Date, Release_Date, Case_Filed_Date, Arraignment_Date, Pretrial_Period_End_Date, Failure_To_Appear_Date, Is_Release_Eligible, Is_Released_Pretrial, Recidivism_Date, Has_New_Criminal_Activity
FROM "41_SANMATEO-DWH_UAT"."SECURE_SHARE"."AGG_PRETRIAL_KPI"
WHERE County = 'San Mateo'
AND Is_Release_Eligible = 'Yes';

```

```{r}
sm_cjs <- full_df %>%
  filter(county == "san_mateo") %>%
  filter(new_arrest_flag == 1) %>%
  filter(book_date >= "2018-07-01", 
         book_date <= "2020-12-31") %>%
  mutate(release_elig_flag = if_else(new_arrest_flag == 1 & (is.na(pretrial_end_date)  | !pretrial_end_date < book_date), 1, 0),
         pretrial_release_flag = if_else(new_arrest_flag == 1 & (!is.na(release_date) & is.na(pretrial_end_date) & !is.na(court_charge_original) | release_date < pretrial_end_date), 1, 0)) %>%
  select(book_num, court_docket_id, book_date, assessment_date, release_date, file_date, arraignment_date, pretrial_end_date, fta_date, release_elig_flag, pretrial_release_flag, cii)


sm_cjs <- full_df %>%
  filter(county == "san_mateo") %>%
  filter(new_arrest_flag == 1) %>%
  filter(is.na(pretrial_end_date) | !pretrial_end_date < book_date) %>%
  #filter(!is.na(pretrial_end_date)) %>%
  filter(book_date > "2018-07-01", 
       book_date <= "2020-12-31") %>%
  filter(is.na(pretrial_end_date) | year(pretrial_end_date) != 2021) %>%
  mutate(pretrial_complete_flag = if_else(new_arrest_flag == 1 & !is.na(pretrial_end_date), 1, 0),
         pretrial_release_flag = if_else(new_arrest_flag == 1 & (!is.na(release_date) & is.na(pretrial_end_date) & !is.na(court_charge_original) | release_date < pretrial_end_date), 1, 0)) %>%
  select(book_num, court_case_id, court_docket_id, book_date, assessment_date, release_date, release_type, release_type_original, file_date, arraignment_date, pretrial_end_date, fta_date, pretrial_release_flag, cii, contains("recid"))



sm_cjs %>%
  mutate(book_num = as.numeric(book_num)) %>%
  filter(!is.na(pretrial_end_date)) %>%
  inner_join(sm_snow %>%
               mutate(BOOKING_KEY = 100*as.numeric(BOOKING_KEY)), by = c("book_num" = "BOOKING_KEY")) %>%
  #count(HAS_NEW_CRIMINAL_ACTIVITY, IS_RELEASED_PRETRIAL)
  #filter(HAS_NEW_CRIMINAL_ACTIVITY == "Yes" & IS_RELEASED_PRETRIAL == "Yes" & (is.na(recid_arrested_flag | recid_arrested_flag == 0))) %>%
  #count(year(RECIDIVISM_DATE), month(RECIDIVISM_DATE))
  #filter(year(RECIDIVISM_DATE) != 2021) %>%
  filter(is.na(PRETRIAL_PERIOD_END_DATE) & release_type == "Detain_Only")
  count(release_type)

sm_snow %>%
  count(HAS_NEW_CRIMINAL_ACTIVITY)

sm_cjs %>%
  count(release_type, release_type_original)

full_df %>%
  filter(release_type == "Detain_Only") %>%
  filter(release_type_original == "TIME SERVED") %>%
  count(county)
  count(release_type_original) %>%
  arrange(desc(n))
  

```


```{r}
filter(!is.na(court_case_id) & is.na(PUBLIC_CASE_NUMBER))
  filter(court_docket_id != PUBLIC_CASE_NUMBER) %>%
  filter(court_docket_id != "NULL") %>%
  filter(pretrial_end_date >=book_date) %>%
  select(court_docket_id, PUBLIC_CASE_NUMBER, pretrial_end_date, PRETRIAL_PERIOD_END_DATE, book_date, book_num, everything())

  filter(IS_RELEASED_PRETRIAL == "Yes") %>%
  filter(is.na(pretrial_release_flag) | pretrial_release_flag == 0)

sm_cjs %>%
  count(pretrial_end_date < book_date)

sm_cjs %>%
  count(pretrial_release_flag)

sm_cjs %>%
  count(IS_RELEASED_PRETRIAL)

sm_snow %>%
  mutate(BOOKING_KEY = 100*as.numeric(BOOKING_KEY)) %>%
  anti_join(sm_cjs %>%
               mutate(book_num = as.numeric(book_num)), by = c("BOOKING_KEY" = "book_num"))
  count(IS_RELEASED_PRETRIAL)

full_df %>%
  filter(county == "san_mateo") %>%
  count(year(book_date), month(book_date))
  filter(grepl("0007065579", cii)) %>%
  select(book_num, book_date, release_date, pretrial_end_date, court_case_id, disposition_date, disposition_type, sentence_date, pretrial_end_date, pretrial_end_date_doj) %>%
  arrange(book_date)
  
sm_snow %>%
  filter(HAS_NEW_CRIMINAL_ACTIVITY == "Yes") %>%
  #filter(is.na(PRETRIAL_PERIOD_END_DATE)) %>%
  #count(RECIDIVISM_DATE > BOOKING_DATE)
  #count(RECIDIVISM_DATE > BOOKING_DATE)
  #count(is.na(PRETRIAL_PERIOD_END_DATE), RECIDIVISM_DATE < PRETRIAL_PERIOD_END_DATE)
  count(IS_RELEASED_PRETRIAL, HAS_NEW_CRIMINAL_ACTIVITY, is.na(PRETRIAL_PERIOD_END_DATE))
```

# Santa Barbara check
```{sql connection = con, output.var = sb_snow}

SELECT County, Booking_Key, Public_Case_Number, Booking_Date, Assessment_Date, Release_Date, Case_Filed_Date, Arraignment_Date, Pretrial_Period_End_Date, Failure_To_Appear_Date, Is_Release_Eligible, Is_Released_Pretrial, Recidivism_Date, Has_New_Criminal_Activity, Has_Failure_To_Appear, Is_Released_To_Pretrial_Services
FROM "42_SANTABARBARA-DWH_UAT"."SECURE_SHARE"."AGG_PRETRIAL_KPI"
WHERE County = 'Santa Barbara';

```

```{r}
sb_cjs <- full_df %>%
  filter(county == "santa_barbara") %>%
  #filter(new_arrest_flag == 1) %>%
  #filter(year(book_date) == 2020) %>%
  filter(book_date > "2018-07-01",
         book_date <= "2020-12-31") %>%
  mutate(release_elig_flag = if_else(new_arrest_flag == 1 & (is.na(pretrial_end_date)  | !pretrial_end_date < book_date), 1, 0),
         pretrial_release_flag = if_else(new_arrest_flag == 1 & (!is.na(release_date) & is.na(pretrial_end_date) & !is.na(court_charge_original) | release_date < pretrial_end_date), 1, 0),
         pts_release_flag = if_else(new_arrest_flag == 1 & release_decision == "Monitor", 1, 0),
         recid_arrested_flag = if_else(pretrial_release_flag ==1, recid_arrested_flag, 0)) %>%
  select(book_num, court_docket_id, court_case_id, book_date, assessment_date, release_date, release_type, file_date, arraignment_date, pretrial_end_date, fta_date, release_elig_flag, pretrial_release_flag, pts_release_flag, release_decision, release_decision_original, recid_arrested_flag) %>%
  filter(!grepl("\\.", book_num))#santa barbara has messed up book_nums, filter these out


sb_cjs %>%
  inner_join(sb_snow, by = c("book_num" = "BOOKING_KEY")) %>%
  #filter(court_docket_id != PUBLIC_CASE_NUMBER) %>%
  filter(court_docket_id != "NULL" & !is.na(PUBLIC_CASE_NUMBER)) %>%
  #filter(pretrial_end_date >=book_date) %>%
  filter(IS_RELEASED_PRETRIAL == "Yes", pretrial_release_flag == 0 | is.na(pretrial_release_flag)) %>%
  select(court_docket_id, PUBLIC_CASE_NUMBER, pretrial_end_date, PRETRIAL_PERIOD_END_DATE, release_date, RELEASE_DATE, book_date, book_num, file_date, CASE_FILED_DATE, everything())

  
  filter(is.na(pretrial_release_flag) | pretrial_release_flag == 0)
  
full_df %>%
  count(county)

sb_cjs %>%
  inner_join(sb_snow, by = c("book_num" = "BOOKING_KEY")) %>%
  filter(HAS_NEW_CRIMINAL_ACTIVITY == "Yes", recid_arrested_flag == 0) %>%
  select(book_num, BOOKING_DATE, book_date, release_date, release_type, RELEASE_DATE, pretrial_end_date, PRETRIAL_PERIOD_END_DATE, RECIDIVISM_DATE, PUBLIC_CASE_NUMBER, court_case_id, court_docket_id) %>%
  filter(!pretrial_end_date < book_date) %>%
  filter(release_type != "Dismissed_Dropped") %>%
  #count(RECIDIVISM_DATE > pretrial_end_date)
  #count(!is.na(court_case_id) & is.na(PUBLIC_CASE_NUMBER))
  #count(is.na(PRETRIAL_PERIOD_END_DATE)) #%>%
  # filter(pretrial_end_date < RECIDIVISM_DATE) %>%
  # count(release_type)

sb_cjs %>%
  inner_join(sb_snow, by = c("book_num" = "BOOKING_KEY")) %>%
  filter(HAS_NEW_CRIMINAL_ACTIVITY == "No", recid_arrested_flag == 1) %>%
  select(book_num, BOOKING_DATE, book_date, release_date, release_type, RELEASE_DATE, pretrial_end_date, PRETRIAL_PERIOD_END_DATE, RECIDIVISM_DATE)

sb_cjs %>%
  count(release_type) %>%
  arrange(desc(n))

sb_snow
```

```{r}
sb_cjs %>%
  inner_join(sb_snow, by = c("book_num" = "BOOKING_KEY")) %>%
  filter(pts_release_flag == 0, IS_RELEASED_TO_PRETRIAL_SERVICES == "Yes")

sb_cjs %>%
  inner_join(sb_snow, by = c("book_num" = "BOOKING_KEY")) %>%
  filter(IS_RELEASED_TO_PRETRIAL_SERVICES == "Yes") %>%
  count(IS_RELEASED_PRETRIAL)

sb_cjs %>%
  inner_join(sb_snow, by = c("book_num" = "BOOKING_KEY")) %>%
  filter(pts_release_flag == 1) %>%
  mutate(pretrial_release_flag = if_else(is.na(pretrial_release_flag), 0, pretrial_release_flag)) %>%
  count(pretrial_release_flag)
```

# Tuolumne check
```{sql connection = con, output.var = tu_snow}

SELECT County, Booking_Key, Public_Case_Number, Booking_Date, Assessment_Date, Release_Date, Case_Filed_Date, Arraignment_Date, Pretrial_Period_End_Date, Failure_To_Appear_Date, Is_Release_Eligible, Is_Released_Pretrial, Recidivism_Date, Has_New_Criminal_Activity
FROM "55_TUOLUMNE-DWH_UAT"."SECURE_SHARE"."AGG_PRETRIAL_KPI"
WHERE County = 'Tuolumne';

```

```{r}
tu_cjs <- full_df %>%
  filter(county == "tuolumne") %>%
  filter(new_arrest_flag == 1) %>%
  filter(is.na(pretrial_end_date) | !pretrial_end_date < book_date) %>%
  #filter(!is.na(pretrial_end_date)) %>%
  filter(book_date > "2018-07-01", 
       book_date <= "2020-12-31") %>%
  filter(is.na(pretrial_end_date) | year(pretrial_end_date) != 2021) %>%
  mutate(pretrial_complete_flag = if_else(new_arrest_flag == 1 & !is.na(pretrial_end_date), 1, 0),
         pretrial_release_flag = if_else(new_arrest_flag == 1 & (!is.na(release_date) & is.na(pretrial_end_date) & !is.na(court_charge_original) | release_date < pretrial_end_date), 1, 0)) %>%
  select(book_num, court_case_id, court_docket_id, book_date, assessment_date, release_date, file_date, arraignment_date, pretrial_end_date, fta_date, pretrial_release_flag, cii, contains("recid"))




tu_cjs %>%
  inner_join(tu_snow, by = c("book_num" = "BOOKING_KEY")) %>%
  filter(!is.na(pretrial_end_date), is.na(PRETRIAL_PERIOD_END_DATE)) %>%
  #filter(court_case_id == "CRF58202" | court_docket_id == "CRF58202")
  filter(book_num == "B0110819")
  
full_df %>%
  filter(county == "tuolumne") %>%
  filter(court_case_id == "" & !is.na(court_docket_id)) %>%
  count(is.na(pretrial_end_date))
  filter(book_num == "B0110819") %>%
  select(book_num, court_case_id, court_docket_id)
  filter(cii == "0027912064") %>%
  filter(county == "tuolumne") %>%
  arrange(book_date)
```


```{r}
filter(!is.na(court_case_id) & is.na(PUBLIC_CASE_NUMBER))
  filter(court_docket_id != PUBLIC_CASE_NUMBER) %>%
  filter(court_docket_id != "NULL") %>%
  filter(pretrial_end_date >=book_date) %>%
  select(court_docket_id, PUBLIC_CASE_NUMBER, pretrial_end_date, PRETRIAL_PERIOD_END_DATE, book_date, book_num, everything())

  filter(IS_RELEASED_PRETRIAL == "Yes") %>%
  filter(is.na(pretrial_release_flag) | pretrial_release_flag == 0)

sm_cjs %>%
  count(pretrial_end_date < book_date)

sm_cjs %>%
  count(pretrial_release_flag)

sm_cjs %>%
  count(IS_RELEASED_PRETRIAL)

sm_snow %>%
  mutate(BOOKING_KEY = 100*as.numeric(BOOKING_KEY)) %>%
  anti_join(sm_cjs %>%
               mutate(book_num = as.numeric(book_num)), by = c("BOOKING_KEY" = "book_num"))
  count(IS_RELEASED_PRETRIAL)

full_df %>%
  filter(county == "san_mateo") %>%
  count(year(book_date), month(book_date))
  filter(grepl("0007065579", cii)) %>%
  select(book_num, book_date, release_date, pretrial_end_date, court_case_id, disposition_date, disposition_type, sentence_date, pretrial_end_date, pretrial_end_date_doj) %>%
  arrange(book_date)
  
sm_snow %>%
  filter(HAS_NEW_CRIMINAL_ACTIVITY == "Yes") %>%
  #filter(is.na(PRETRIAL_PERIOD_END_DATE)) %>%
  #count(RECIDIVISM_DATE > BOOKING_DATE)
  #count(RECIDIVISM_DATE > BOOKING_DATE)
  #count(is.na(PRETRIAL_PERIOD_END_DATE), RECIDIVISM_DATE < PRETRIAL_PERIOD_END_DATE)
  count(IS_RELEASED_PRETRIAL, HAS_NEW_CRIMINAL_ACTIVITY, is.na(PRETRIAL_PERIOD_END_DATE))
```


# Napa check
```{sql connection = con, output.var = na_snow}

SELECT County, Booking_Key, Booking_ID, Public_Case_Number, Booking_Date, Assessment_Date, Release_Date, Case_Filed_Date, Arraignment_Date, Pretrial_Period_End_Date, Failure_To_Appear_Date, Is_Release_Eligible, Is_Released_Pretrial, Recidivism_Date, Has_New_Criminal_Activity
FROM "28_NAPA-DWH_QA"."SECURE_SHARE"."AGG_PRETRIAL_KPI"
WHERE County = 'Napa';

```

```{r}
na_cjs <- full_df %>%
  filter(county == "napa") %>%
  #filter(new_arrest_flag == 1) %>%
  #filter(is.na(pretrial_end_date) | !pretrial_end_date < book_date) %>%
  #filter(!is.na(pretrial_end_date)) %>%
  filter(book_date > "2018-07-01", 
       book_date <= "2020-12-31") %>%
  filter(is.na(pretrial_end_date) | year(pretrial_end_date) != 2021) %>%
  mutate(pretrial_complete_flag = if_else(new_arrest_flag == 1 & !is.na(pretrial_end_date), 1, 0),
         pretrial_release_flag = if_else(new_arrest_flag == 1 & (!is.na(release_date) & is.na(pretrial_end_date) & !is.na(court_charge_original) | release_date < pretrial_end_date), 1, 0)) %>%
  select(book_num, court_case_id, court_docket_id, book_date, assessment_date, release_date, file_date, arraignment_date, pretrial_end_date, fta_date, pretrial_release_flag, cii, contains("recid"), new_arrest_flag)

na_snow %>%
  inner_join(na_cjs, by = c("BOOKING_ID" = "book_num")) %>%
  filter(!is.na(PRETRIAL_PERIOD_END_DATE) & is.na(pretrial_end_date)) %>%
  filter(court_case_id == PUBLIC_CASE_NUMBER) %>%
  filter(year(PRETRIAL_PERIOD_END_DATE) != 2021) %>%
  pull(court_case_id)


court_charge %>%
  filter(court_case_id %in% ids) %>%
  count(is.na(disposition_date))

na_snow %>%
  inner_join(na_cjs, by = c("BOOKING_ID" = "book_num")) %>%
  filter(!is.na(ASSESSMENT_DATE) & is.na(assessment_date))
  
na_snow %>%
  filter(BOOKING_DATE > "2018-07-01", 
       BOOKING_DATE <= "2020-12-31") %>%
  anti_join(na_cjs, by = c("BOOKING_ID" = "book_num")) %>%
  filter(!is.na(ASSESSMENT_DATE))

na_cjs %>%
  count(is.na(assessment_date), new_arrest_flag)
```


```{r}
filter(!is.na(court_case_id) & is.na(PUBLIC_CASE_NUMBER))
  filter(court_docket_id != PUBLIC_CASE_NUMBER) %>%
  filter(court_docket_id != "NULL") %>%
  filter(pretrial_end_date >=book_date) %>%
  select(court_docket_id, PUBLIC_CASE_NUMBER, pretrial_end_date, PRETRIAL_PERIOD_END_DATE, book_date, book_num, everything())

  filter(IS_RELEASED_PRETRIAL == "Yes") %>%
  filter(is.na(pretrial_release_flag) | pretrial_release_flag == 0)

sm_cjs %>%
  count(pretrial_end_date < book_date)

sm_cjs %>%
  count(pretrial_release_flag)

sm_cjs %>%
  count(IS_RELEASED_PRETRIAL)

sm_snow %>%
  mutate(BOOKING_KEY = 100*as.numeric(BOOKING_KEY)) %>%
  anti_join(sm_cjs %>%
               mutate(book_num = as.numeric(book_num)), by = c("BOOKING_KEY" = "book_num"))
  count(IS_RELEASED_PRETRIAL)

full_df %>%
  filter(county == "san_mateo") %>%
  count(year(book_date), month(book_date))
  filter(grepl("0007065579", cii)) %>%
  select(book_num, book_date, release_date, pretrial_end_date, court_case_id, disposition_date, disposition_type, sentence_date, pretrial_end_date, pretrial_end_date_doj) %>%
  arrange(book_date)
  
sm_snow %>%
  filter(HAS_NEW_CRIMINAL_ACTIVITY == "Yes") %>%
  #filter(is.na(PRETRIAL_PERIOD_END_DATE)) %>%
  #count(RECIDIVISM_DATE > BOOKING_DATE)
  #count(RECIDIVISM_DATE > BOOKING_DATE)
  #count(is.na(PRETRIAL_PERIOD_END_DATE), RECIDIVISM_DATE < PRETRIAL_PERIOD_END_DATE)
  count(IS_RELEASED_PRETRIAL, HAS_NEW_CRIMINAL_ACTIVITY, is.na(PRETRIAL_PERIOD_END_DATE))
```

```{r}
court_war %>%
  filter(war_date > "2018-07-01", 
       war_date <= "2020-12-31") %>%
  filter(court_fta_flag == 1) %>%
  distinct(court_case_id)

court_dispo %>%
  inner_join(court_war %>%
  filter(war_date > "2018-07-01", 
       war_date <= "2020-12-31") %>%
  filter(court_fta_flag == 1) %>%
  distinct(court_case_id))

court_dispo
```

```{r}
nrow(book_df %>%
semi_join(court_df, by = c("court_case_id", "local_id"), na_matches = "never"))/nrow(book_df)

nrow(court_df %>%
semi_join(book_df, by = c("court_case_id", "local_id"), na_matches = "never"))/nrow(court_df)
```
```{r}
court_df %>%
  count(disposition_type_original) %>%
  arrange(desc(n))

court_df %>%
  filter(grepl("NC", court_case_id))

book_df %>%
  distinct(court_case_id)

book_df %>%
  filter(release_type_original == "No Complaint") %>%
  count(book_type_original) %>%
  arrange(desc(n))
```

```{r}
book_df %>%
  count(release_type_original) %>%
  arrange(desc(n))

book_df %>%
  filter(grepl("NC", court_case_id))
```

# Sonoma check
```{sql connection = con, output.var = son_snow}

SELECT County, Booking_Key, Booking_ID, Public_Case_Number, Booking_Date, Assessment_Date, Release_Date, Case_Filed_Date, Arraignment_Date, Pretrial_Period_End_Date, Failure_To_Appear_Date, Is_Release_Eligible, Is_Released_Pretrial, Is_Released_To_Pretrial_Services, Recidivism_Date, Has_New_Criminal_Activity, Release_Type
FROM "49_SONOMA-DWH_UAT"."SECURE_SHARE"."AGG_PRETRIAL_KPI"
WHERE County = 'Sonoma';

```

```{r}
son_cjs <- full_df %>%
  filter(county == "sonoma") %>%
  #filter(new_arrest_flag == 1) %>%
  filter(is.na(pretrial_end_date) | !pretrial_end_date < book_date) %>%
  #filter(!is.na(pretrial_end_date)) %>%
  filter(book_date > "2018-07-01", 
       book_date <= "2020-12-31") %>%
  filter(is.na(pretrial_end_date) | year(pretrial_end_date) != 2021) %>%
   mutate(release_elig_flag = if_else(new_arrest_flag == 1 & (is.na(pretrial_end_date)  | !pretrial_end_date < book_date), 1, 0),
         pretrial_release_flag = if_else(new_arrest_flag == 1 & (!is.na(release_date) & is.na(pretrial_end_date) & !is.na(court_charge_original) | release_date < pretrial_end_date), 1, 0),
         pts_release_flag = if_else(new_arrest_flag == 1 & release_decision == "Monitor", 1, 0),
         recid_arrested_flag = if_else(pretrial_release_flag ==1, recid_arrested_flag, 0)) %>%
  select(book_num, court_docket_id, court_case_id, book_date, assessment_date, release_date, release_type, file_date, arraignment_date, pretrial_end_date, fta_date, release_elig_flag, pretrial_release_flag, pts_release_flag, release_decision, release_decision_original, recid_arrested_flag)




son_cjs %>%
  inner_join(son_snow, by = c("book_num" = "BOOKING_ID")) %>%
  filter(IS_RELEASED_PRETRIAL == "Yes" & (is.na(pretrial_release_flag) | pretrial_release_flag == 0)) %>%
  filter(is.na(RELEASE_DATE) | year(RELEASE_DATE)!= 2021)

son_cjs %>%
  inner_join(son_snow, by = c("book_num" = "BOOKING_ID")) %>%
  filter(!is.na(court_case_id)) %>%
  count(year(book_date), is.na(court_charge_original))


son_snow %>%
  summarise(min_book = min(BOOKING_DATE, na.rm = T), max_book = max(BOOKING_DATE, na.rm = T))

court_disposition %>%
  filter(disposition_date > "2018-07-01", 
       disposition_date <= "2020-12-31")

son_cjs %>%
  inner_join(son_snow, by = c("book_num" = "BOOKING_ID")) %>%
  filter(pts_release_flag == 1 & IS_RELEASED_TO_PRETRIAL_SERVICES == "No") %>%
  select(book_num)


son_cjs %>%
  filter(book_num == "10216370")
  inner_join(son_snow, by = c("book_num" = "BOOKING_ID")) %>%
  filter(pts_release_flag == 1 & IS_RELEASED_TO_PRETRIAL_SERVICES == "No") 
  
son_cjs %>%
  inner_join(son_snow, by = c("book_num" = "BOOKING_ID")) %>%
  filter(HAS_NEW_CRIMINAL_ACTIVITY == "Yes", recid_arrested_flag == 0) %>%
  select(book_num, BOOKING_DATE, book_date, release_date, RELEASE_DATE, release_type, RELEASE_TYPE, pretrial_end_date, PRETRIAL_PERIOD_END_DATE, RECIDIVISM_DATE, PUBLIC_CASE_NUMBER, court_case_id, court_docket_id, file_date, arraignment_date)
```


```{r}
filter(!is.na(court_case_id) & is.na(PUBLIC_CASE_NUMBER))
  filter(court_docket_id != PUBLIC_CASE_NUMBER) %>%
  filter(court_docket_id != "NULL") %>%
  filter(pretrial_end_date >=book_date) %>%
  select(court_docket_id, PUBLIC_CASE_NUMBER, pretrial_end_date, PRETRIAL_PERIOD_END_DATE, book_date, book_num, everything())

  filter(IS_RELEASED_PRETRIAL == "Yes") %>%
  filter(is.na(pretrial_release_flag) | pretrial_release_flag == 0)

sm_cjs %>%
  count(pretrial_end_date < book_date)

sm_cjs %>%
  count(pretrial_release_flag)

sm_cjs %>%
  count(IS_RELEASED_PRETRIAL)

sm_snow %>%
  mutate(BOOKING_KEY = 100*as.numeric(BOOKING_KEY)) %>%
  anti_join(sm_cjs %>%
               mutate(book_num = as.numeric(book_num)), by = c("BOOKING_KEY" = "book_num"))
  count(IS_RELEASED_PRETRIAL)

full_df %>%
  filter(county == "san_mateo") %>%
  count(year(book_date), month(book_date))
  filter(grepl("0007065579", cii)) %>%
  select(book_num, book_date, release_date, pretrial_end_date, court_case_id, disposition_date, disposition_type, sentence_date, pretrial_end_date, pretrial_end_date_doj) %>%
  arrange(book_date)
  
sm_snow %>%
  filter(HAS_NEW_CRIMINAL_ACTIVITY == "Yes") %>%
  #filter(is.na(PRETRIAL_PERIOD_END_DATE)) %>%
  #count(RECIDIVISM_DATE > BOOKING_DATE)
  #count(RECIDIVISM_DATE > BOOKING_DATE)
  #count(is.na(PRETRIAL_PERIOD_END_DATE), RECIDIVISM_DATE < PRETRIAL_PERIOD_END_DATE)
  count(IS_RELEASED_PRETRIAL, HAS_NEW_CRIMINAL_ACTIVITY, is.na(PRETRIAL_PERIOD_END_DATE))
```

# Nevada check
```{sql connection = con, output.var = nev_snow}

SELECT County, Booking_Key, Booking_ID, Public_Case_Number, Booking_Date, Assessment_Date, Release_Date, Case_Filed_Date, Arraignment_Date, Pretrial_Period_End_Date, Failure_To_Appear_Date, Is_Release_Eligible, Is_Released_Pretrial, Is_Released_To_Pretrial_Services, Recidivism_Date, Has_New_Criminal_Activity, Release_Type
FROM "29_NEVADA-DWH_UAT"."SECURE_SHARE"."AGG_PRETRIAL_KPI"
WHERE County = 'Nevada';

```

```{r}
nev_cjs <- full_df %>%
  filter(county == "nevada") %>%
  filter(is.na(county_sierra)) %>%
  #filter(new_arrest_flag == 1) %>%
  filter(is.na(pretrial_end_date) | !pretrial_end_date < book_date) %>%
  #filter(!is.na(pretrial_end_date)) %>%
  filter(book_date > "2018-07-01", 
       book_date <= "2020-12-31") %>%
  filter(is.na(pretrial_end_date) | year(pretrial_end_date) != 2021) %>%
   mutate(release_elig_flag = if_else(new_arrest_flag == 1 & (is.na(pretrial_end_date)  | !pretrial_end_date < book_date), 1, 0),
         pretrial_release_flag = if_else(new_arrest_flag == 1 & (!is.na(release_date) & is.na(pretrial_end_date) & !is.na(court_charge_original) | release_date < pretrial_end_date), 1, 0),
         pts_release_flag = if_else(new_arrest_flag == 1 & release_decision == "Monitor", 1, 0),
         fta_flag = if_else(pretrial_release_flag ==1 & (fta_flag == 1|arrest_fta_flag == 1|court_fta_flag == 1), 1, 0),
         recid_arrested_flag = if_else(pretrial_release_flag ==1, recid_arrested_flag, 0)) %>%
  select(book_num, court_docket_id, court_case_id, book_date, assessment_date, release_date, release_type, file_date, arraignment_date, pretrial_end_date, fta_flag, fta_date, release_elig_flag, pretrial_release_flag, pts_release_flag, release_decision, release_decision_original, recid_arrested_flag)



nev_cjs %>%
  inner_join(nev_snow, by = c("book_num" = "BOOKING_KEY")) %>%
  mutate(recid_arrested_flag = if_else(is.na(recid_arrested_flag), 0, recid_arrested_flag)) %>%
  filter(HAS_NEW_CRIMINAL_ACTIVITY == "Yes" & IS_RELEASED_PRETRIAL  == "Yes" & pretrial_release_flag == 1 & recid_arrested_flag == 0) %>%
 # count(pretrial_release_flag)
  select(book_num, PUBLIC_CASE_NUMBER, court_case_id, RELEASE_DATE, release_date, PRETRIAL_PERIOD_END_DATE, pretrial_end_date, )
```

```{r}
nev_cjs %>%
  inner_join(nev_snow, by = c("book_num" = "BOOKING_KEY")) %>%
  mutate(recid_arrested_flag = if_else(is.na(recid_arrested_flag), 0, recid_arrested_flag)) %>%
  filter(HAS_NEW_CRIMINAL_ACTIVITY == "No" & recid_arrested_flag == 1)
```

```{r}
nev_cjs %>%
  inner_join(nev_snow, by = c("book_num" = "BOOKING_KEY")) %>%
  mutate(recid_arrested_flag = if_else(is.na(recid_arrested_flag), 0, recid_arrested_flag)) %>%
  count(recid_arrested_flag)
```

```{r}
filter(IS_RELEASED_PRETRIAL == "Yes" & (is.na(pretrial_release_flag) | pretrial_release_flag == 0)) %>%
  filter(is.na(RELEASE_DATE) | year(RELEASE_DATE)!= 2021)
  
full_df %>%
  filter(county == "nevada") %>%
  filter(is.na(county_sierra)) %>%
  filter(is.na(pretrial_end_date) | year(pretrial_end_date) != 2021) %>%
  filter(book_date > "2018-07-01", 
       book_date <= "2020-12-31") %>%
  mutate(pretrial_release_flag = if_else(new_arrest_flag == 1 & (!is.na(release_date) & is.na(pretrial_end_date) & !is.na(court_charge_original) | release_date < pretrial_end_date), 1, 0)) %>%
  filter(pretrial_release_flag == 1) %>%
  count(court_fta_flag, fta_flag)

court_warrants %>%
  count(fta_warrant)


```

```{r}
nev_snow %>%
  inner_join(nev_cjs, by = c("BOOKING_KEY" = "book_num")) %>%
  filter(IS_RELEASED_PRETRIAL == "No" & pretrial_release_flag == 1) %>%
  select(BOOKING_KEY, PUBLIC_CASE_NUMBER, court_case_id, RELEASE_DATE, release_date, PRETRIAL_PERIOD_END_DATE, pretrial_end_date, release_type, RELEASE_TYPE)

```
```{r}
book_df %>%
    filter(book_num == "B19003754")

  filter(book_num == "B20001841")
  
court_df %>%
  filter(court_case_id == "M20-000372") %>%
  select(contains("disp"))

full_df %>%
  count(county_sierra)
```


```{r}
son_cjs %>%
  inner_join(son_snow, by = c("book_num" = "BOOKING_ID")) %>%
  filter(!is.na(court_case_id)) %>%
  count(year(book_date), is.na(court_charge_original))


son_snow %>%
  summarise(min_book = min(BOOKING_DATE, na.rm = T), max_book = max(BOOKING_DATE, na.rm = T))

court_disposition %>%
  filter(disposition_date > "2018-07-01", 
       disposition_date <= "2020-12-31")

son_cjs %>%
  inner_join(son_snow, by = c("book_num" = "BOOKING_ID")) %>%
  filter(pts_release_flag == 1 & IS_RELEASED_TO_PRETRIAL_SERVICES == "No") %>%
  select(book_num)


son_cjs %>%
  filter(book_num == "10216370")
  inner_join(son_snow, by = c("book_num" = "BOOKING_ID")) %>%
  filter(pts_release_flag == 1 & IS_RELEASED_TO_PRETRIAL_SERVICES == "No") 
  
son_cjs %>%
  inner_join(son_snow, by = c("book_num" = "BOOKING_ID")) %>%
  filter(HAS_NEW_CRIMINAL_ACTIVITY == "Yes", recid_arrested_flag == 0) %>%
  select(book_num, BOOKING_DATE, book_date, release_date, RELEASE_DATE, release_type, RELEASE_TYPE, pretrial_end_date, PRETRIAL_PERIOD_END_DATE, RECIDIVISM_DATE, PUBLIC_CASE_NUMBER, court_case_id, court_docket_id, file_date, arraignment_date)
```


```{r}
filter(!is.na(court_case_id) & is.na(PUBLIC_CASE_NUMBER))
  filter(court_docket_id != PUBLIC_CASE_NUMBER) %>%
  filter(court_docket_id != "NULL") %>%
  filter(pretrial_end_date >=book_date) %>%
  select(court_docket_id, PUBLIC_CASE_NUMBER, pretrial_end_date, PRETRIAL_PERIOD_END_DATE, book_date, book_num, everything())

  filter(IS_RELEASED_PRETRIAL == "Yes") %>%
  filter(is.na(pretrial_release_flag) | pretrial_release_flag == 0)

sm_cjs %>%
  count(pretrial_end_date < book_date)

sm_cjs %>%
  count(pretrial_release_flag)

sm_cjs %>%
  count(IS_RELEASED_PRETRIAL)

sm_snow %>%
  mutate(BOOKING_KEY = 100*as.numeric(BOOKING_KEY)) %>%
  anti_join(sm_cjs %>%
               mutate(book_num = as.numeric(book_num)), by = c("BOOKING_KEY" = "book_num"))
  count(IS_RELEASED_PRETRIAL)

full_df %>%
  filter(county == "san_mateo") %>%
  count(year(book_date), month(book_date))
  filter(grepl("0007065579", cii)) %>%
  select(book_num, book_date, release_date, pretrial_end_date, court_case_id, disposition_date, disposition_type, sentence_date, pretrial_end_date, pretrial_end_date_doj) %>%
  arrange(book_date)
  
sm_snow %>%
  filter(HAS_NEW_CRIMINAL_ACTIVITY == "Yes") %>%
  #filter(is.na(PRETRIAL_PERIOD_END_DATE)) %>%
  #count(RECIDIVISM_DATE > BOOKING_DATE)
  #count(RECIDIVISM_DATE > BOOKING_DATE)
  #count(is.na(PRETRIAL_PERIOD_END_DATE), RECIDIVISM_DATE < PRETRIAL_PERIOD_END_DATE)
  count(IS_RELEASED_PRETRIAL, HAS_NEW_CRIMINAL_ACTIVITY, is.na(PRETRIAL_PERIOD_END_DATE))
```

# Calaveras check
```{sql connection = con, output.var = cal_snow}

SELECT County, Booking_Key, Booking_ID, Public_Case_Number, Booking_Date, Assessment_Date, Release_Date, Case_Filed_Date, Arraignment_Date, Pretrial_Period_End_Date, Failure_To_Appear_Date, Is_Release_Eligible, Is_Released_Pretrial, Is_Released_To_Pretrial_Services, Recidivism_Date, Has_New_Criminal_Activity, Release_Type
FROM "05_CALAVERAS-DWH_UAT"."SECURE_SHARE"."AGG_PRETRIAL_KPI"
WHERE County = 'Calaveras';

```

```{r}
cal_cjs <- full_df %>%
  filter(county == "calaveras") %>%
  #filter(new_arrest_flag == 1) %>%
  filter(is.na(pretrial_end_date) | !pretrial_end_date < book_date) %>%
  #filter(!is.na(pretrial_end_date)) %>%
  filter(book_date > "2018-07-01", 
       book_date <= "2020-12-31") %>%
  filter(is.na(pretrial_end_date) | year(pretrial_end_date) != 2021) %>%
   mutate(release_elig_flag = if_else(new_arrest_flag == 1 & (is.na(pretrial_end_date)  | !pretrial_end_date < book_date), 1, 0),
         pretrial_release_flag = if_else(new_arrest_flag == 1 & (!is.na(release_date) & is.na(pretrial_end_date) & !is.na(court_charge_original) | release_date < pretrial_end_date), 1, 0),
         pts_release_flag = if_else(new_arrest_flag == 1 & release_decision == "Monitor", 1, 0),
         fta_flag = if_else(pretrial_release_flag ==1 & (fta_flag == 1|arrest_fta_flag == 1|court_fta_flag == 1), 1, 0),
         recid_arrested_flag = if_else(pretrial_release_flag ==1, recid_arrested_flag, 0)) %>%
  select(book_num, court_docket_id, court_case_id, book_date, assessment_date, release_date, release_type, file_date, arraignment_date, pretrial_end_date, fta_flag, fta_date, release_elig_flag, pretrial_release_flag, pts_release_flag, release_decision, release_decision_original, recid_arrested_flag)



nev_cjs %>%
  inner_join(nev_snow, by = c("book_num" = "BOOKING_KEY")) %>%
  mutate(recid_arrested_flag = if_else(is.na(recid_arrested_flag), 0, recid_arrested_flag)) %>%
  filter(HAS_NEW_CRIMINAL_ACTIVITY == "Yes" & IS_RELEASED_PRETRIAL  == "Yes" & pretrial_release_flag == 1 & recid_arrested_flag == 0) %>%
 # count(pretrial_release_flag)
  select(book_num, PUBLIC_CASE_NUMBER, court_case_id, RELEASE_DATE, release_date, PRETRIAL_PERIOD_END_DATE, pretrial_end_date, )
```

```{r}
nev_cjs %>%
  inner_join(nev_snow, by = c("book_num" = "BOOKING_KEY")) %>%
  mutate(recid_arrested_flag = if_else(is.na(recid_arrested_flag), 0, recid_arrested_flag)) %>%
  filter(HAS_NEW_CRIMINAL_ACTIVITY == "No" & recid_arrested_flag == 1)
```

```{r}
nev_cjs %>%
  inner_join(nev_snow, by = c("book_num" = "BOOKING_KEY")) %>%
  mutate(recid_arrested_flag = if_else(is.na(recid_arrested_flag), 0, recid_arrested_flag)) %>%
  count(recid_arrested_flag)
```

```{r}
filter(IS_RELEASED_PRETRIAL == "Yes" & (is.na(pretrial_release_flag) | pretrial_release_flag == 0)) %>%
  filter(is.na(RELEASE_DATE) | year(RELEASE_DATE)!= 2021)
  
full_df %>%
  filter(county == "nevada") %>%
  filter(is.na(county_sierra)) %>%
  filter(is.na(pretrial_end_date) | year(pretrial_end_date) != 2021) %>%
  filter(book_date > "2018-07-01", 
       book_date <= "2020-12-31") %>%
  mutate(pretrial_release_flag = if_else(new_arrest_flag == 1 & (!is.na(release_date) & is.na(pretrial_end_date) & !is.na(court_charge_original) | release_date < pretrial_end_date), 1, 0)) %>%
  filter(pretrial_release_flag == 1) %>%
  count(court_fta_flag, fta_flag)

court_warrants %>%
  count(fta_warrant)


```

```{r}
nev_snow %>%
  inner_join(nev_cjs, by = c("BOOKING_KEY" = "book_num")) %>%
  filter(IS_RELEASED_PRETRIAL == "No" & pretrial_release_flag == 1) %>%
  select(BOOKING_KEY, PUBLIC_CASE_NUMBER, court_case_id, RELEASE_DATE, release_date, PRETRIAL_PERIOD_END_DATE, pretrial_end_date, release_type, RELEASE_TYPE)

```
```{r}
book_df %>%
    filter(book_num == "B19003754")

  filter(book_num == "B20001841")
  
court_df %>%
  filter(court_case_id == "M20-000372") %>%
  select(contains("disp"))

full_df %>%
  count(county_sierra)
```





# Yuba check
```{sql connection = con, output.var = yub_snow}

SELECT County, Booking_Key, Booking_ID, Public_Case_Number, Booking_Date, Assessment_Date, Release_Date, Case_Filed_Date, Arraignment_Date, Pretrial_Period_End_Date, Failure_To_Appear_Date, Is_Release_Eligible, Is_Released_Pretrial, Is_Released_To_Pretrial_Services, Recidivism_Date, Has_New_Criminal_Activity, Release_Type
FROM "58_YUBA-DWH_UAT"."SECURE_SHARE"."AGG_PRETRIAL_KPI"
WHERE County = 'Yuba';

```

```{r}
yub_cjs <- full_df %>%
  filter(county == "yuba") %>%
  mutate(new_arrest_flag = if_else(is.na(pretrial_end_date), 1, new_arrest_flag)) %>%
  #filter(new_arrest_flag == 1) %>%
  #filter(is.na(pretrial_end_date) | !pretrial_end_date < book_date) %>%
  #filter(!is.na(pretrial_end_date)) %>%
  filter(book_date > "2018-07-01", 
       book_date <= "2020-12-31") %>%
  filter(is.na(pretrial_end_date) | year(pretrial_end_date) != 2021) %>%
   mutate(release_elig_flag = if_else(new_arrest_flag == 1 & (is.na(pretrial_end_date)  | !pretrial_end_date < book_date), 1, 0),
         pretrial_release_flag = if_else(new_arrest_flag == 1 & (!is.na(release_date) & is.na(pretrial_end_date) & !is.na(court_charge_original) | release_date < pretrial_end_date), 1, 0),
         pts_release_flag = if_else(new_arrest_flag == 1 & release_decision == "Monitor", 1, 0),
         fta_flag = if_else(pretrial_release_flag ==1 & (fta_flag == 1|arrest_fta_flag == 1|court_fta_flag == 1), 1, 0),
         recid_arrested_flag = if_else(pretrial_release_flag ==1, recid_arrested_flag, 0)) %>%
  select(book_num, court_docket_id, court_case_id, court_charge_original, book_date, assessment_date, release_date, release_type, file_date, arraignment_date, pretrial_end_date, fta_flag, fta_date, release_elig_flag, pretrial_release_flag, pts_release_flag, release_decision, release_decision_original, recid_arrested_flag, release_type_original, disposition_date, disposition_type, disposition_type_original, new_arrest_flag, book_type, book_type_original)


```

```{r}
yub_snow %>%
  inner_join(yub_cjs, by = c("BOOKING_KEY" = "book_num")) %>%
  filter(court_case_id != "", is.na(PUBLIC_CASE_NUMBER)) %>%
  #filter(!is.na(PRETRIAL_PERIOD_END_DATE) & is.na(pretrial_end_date)) %>%
  select(BOOKING_KEY, BOOKING_DATE, PUBLIC_CASE_NUMBER, court_case_id, court_charge_original, CASE_FILED_DATE, file_date, PRETRIAL_PERIOD_END_DATE) %>%
  filter(!is.na(court_charge_original)) %>%
  filter(file_date > "2018-07-01", 
         file_date <= "2020-12-31") 

yub_cjs %>%
  filter(court_case_id != "") %>%
  select(court_case_id, file_date)
  count(is.na(file_date))
```

```{r}
yub_snow %>%
  inner_join(yub_cjs, by = c("BOOKING_KEY" = "book_num")) %>%
  filter(is.na(PRETRIAL_PERIOD_END_DATE) & !is.na(pretrial_end_date)) %>%
  select(BOOKING_KEY, PUBLIC_CASE_NUMBER, court_case_id, CASE_FILED_DATE, file_date, PRETRIAL_PERIOD_END_DATE)
```

```{r}
yub_snow %>%
  inner_join(yub_cjs, by = c("BOOKING_KEY" = "book_num")) %>%
  filter(IS_RELEASED_PRETRIAL == "Yes") %>%
  filter(pretrial_release_flag == 0) %>%
  select(BOOKING_KEY, PUBLIC_CASE_NUMBER, court_case_id, PRETRIAL_PERIOD_END_DATE, pretrial_end_date, RELEASE_DATE, release_date, RELEASE_TYPE, release_type, disposition_date, disposition_type, disposition_type_original, file_date, new_arrest_flag, book_type, book_type_original) 
  

yub_cjs %>%
  count(new_arrest_flag, is.na(pretrial_end_date))
# new_arrest_flag is incorrectly set to 0 when pretrial end date is NA, for the moment just swapped it out in the sample pulled in here. code is fixed in final pretrial data processing 1 so it will parse correctly if it is run again.
```
```{r}
book_df %>%
  filter(book_num == "260148")
```


```{r}
yub_snow %>%
  inner_join(yub_cjs, by = c("BOOKING_KEY" = "book_num")) %>%
  filter(!is.na(PRETRIAL_PERIOD_END_DATE)) %>%
  filter(is.na(pretrial_end_date))
  
```


# Kings check
```{sql connection = con, output.var = kin_snow}

SELECT County, Booking_Key, Booking_ID, Public_Case_Number, Booking_Date, Assessment_Date, Release_Date, Case_Filed_Date, Arraignment_Date, Pretrial_Period_End_Date, Failure_To_Appear_Date, Is_Release_Eligible, Is_Released_Pretrial, Is_Released_To_Pretrial_Services, Recidivism_Date, Has_New_Criminal_Activity, Release_Type
FROM "16_KINGS-DWH_QA"."SECURE_SHARE"."AGG_PRETRIAL_KPI"
WHERE County = 'Kings';

```

```{r}
kin_cjs <- full_df %>%
  filter(county == "kings") %>%
  #filter(new_arrest_flag == 1) %>%
  filter(is.na(pretrial_end_date) | !pretrial_end_date < book_date) %>%
  #filter(!is.na(pretrial_end_date)) %>%
  filter(book_date > "2018-07-01", 
       book_date <= "2020-12-31") %>%
  filter(is.na(pretrial_end_date) | year(pretrial_end_date) != 2021) %>%
   mutate(release_elig_flag = if_else(new_arrest_flag == 1 & (is.na(pretrial_end_date)  | !pretrial_end_date < book_date), 1, 0),
         pretrial_release_flag = if_else(new_arrest_flag == 1 & (!is.na(release_date) & is.na(pretrial_end_date) & !is.na(court_charge_original) | release_date < pretrial_end_date), 1, 0),
         pts_release_flag = if_else(new_arrest_flag == 1 & release_decision == "Monitor", 1, 0),
         fta_flag = if_else(pretrial_release_flag ==1 & (fta_flag == 1|arrest_fta_flag == 1|court_fta_flag == 1), 1, 0),
         recid_arrested_flag = if_else(pretrial_release_flag ==1, recid_arrested_flag, 0)) %>%
  select(book_num, court_docket_id, court_case_id, book_date, assessment_date, release_date, release_type, file_date, arraignment_date, pretrial_end_date, fta_flag, fta_date, release_elig_flag, pretrial_release_flag, pts_release_flag, release_decision, release_decision_original, recid_arrested_flag)



kin_cjs %>%
  inner_join(kin_snow, by = c("book_num" = "BOOKING_ID")) %>%
  filter(!is.na(court_case_id) & is.na(PUBLIC_CASE_NUMBER)) %>%
  select(book_num, court_case_id)
```






# Ventura check
```{sql connection = con, output.var = ven_snow}

SELECT County, Booking_Key, Booking_ID, Public_Case_Number, Booking_Date, Assessment_Date, Release_Date, Case_Filed_Date, Arraignment_Date, Pretrial_Period_End_Date, Failure_To_Appear_Date, Is_Release_Eligible, Is_Released_Pretrial, Is_Released_To_Pretrial_Services, Recidivism_Date, Has_New_Criminal_Activity, Release_Type
FROM "56_VENTURA-DWH_UAT"."SECURE_SHARE"."AGG_PRETRIAL_KPI"
WHERE County = 'Ventura';

```

```{r}
ven_cjs <- full_df %>%
  filter(county == "ventura") %>%
  #filter(new_arrest_flag == 1) %>%
  filter(is.na(pretrial_end_date) | !pretrial_end_date < book_date) %>%
  #filter(!is.na(pretrial_end_date)) %>%
  filter(book_date > "2018-07-01", 
       book_date <= "2020-12-31") %>%
  filter(is.na(pretrial_end_date) | year(pretrial_end_date) != 2021) %>%
   mutate(release_elig_flag = if_else(new_arrest_flag == 1 & (is.na(pretrial_end_date)  | !pretrial_end_date < book_date), 1, 0),
         pretrial_release_flag = if_else(new_arrest_flag == 1 & (!is.na(release_date) & is.na(pretrial_end_date) & !is.na(court_charge_original) | release_date < pretrial_end_date), 1, 0),
         pts_release_flag = if_else(new_arrest_flag == 1 & release_decision == "Monitor", 1, 0),
         fta_flag = if_else(pretrial_release_flag ==1 & (fta_flag == 1|arrest_fta_flag == 1|court_fta_flag == 1), 1, 0),
         recid_arrested_flag = if_else(pretrial_release_flag ==1, recid_arrested_flag, 0)) %>%
  select(book_num, court_docket_id, court_case_id, court_charge_original, book_date, assessment_date, release_date, release_type, file_date, arraignment_date, pretrial_end_date, fta_flag, fta_date, release_elig_flag, pretrial_release_flag, pts_release_flag, release_decision, release_decision_original, recid_arrested_flag)



ven_cjs %>%
  inner_join(ven_snow, by = c("book_num" = "BOOKING_ID")) %>%
  filter(is.na(court_case_id) & !is.na(PUBLIC_CASE_NUMBER)) %>%
  select(book_num, PUBLIC_CASE_NUMBER, BOOKING_DATE, CASE_FILED_DATE)

ven_cjs %>%
  inner_join(ven_snow, by = c("book_num" = "BOOKING_ID")) %>%
  filter(!is.na(pretrial_end_date) & is.na(PRETRIAL_PERIOD_END_DATE)) %>%
  select(book_num, court_case_id, PUBLIC_CASE_NUMBER, book_date, CASE_FILED_DATE, pretrial_end_date, RELEASE_TYPE) 
```
```{r}
court_df %>%
  filter(court_case_id %in% c("2017010642", "2017040565", "2018022845")) %>%
  select(court_case_id, filing_date, disposition_date, court_charge_original, sentence_date)
  #filter(court_case_id == "2018022690")

```

```{r}
book_df %>%
  filter(book_num == "2049444") %>%
  #filter(book_num %in% c("2049342", "2081216", "2098962")) %>%
  select(book_num, court_case_id, book_date, release_date, release_type)
```
```{r}
ven_cjs %>%
  filter(book_num == "2081216")
```

```{r}
court_df2 %>%
  filter(is.na(court_charge_original))

court_df
```



# Old
```{r}
mydata <- dbGetQuery(con,"SELECT * FROM \"54_TULARE-DWH_UAT\".\"SECURE_SHARE\".\"DIM_PLEA_DATE\"")

tbl(con, "AGG_PRETRIAL_KPI")

tbl(con, "54_TULARE-DWH_UAT\".\"SECURE_SHARE\".\"AGG_PRETRIAL_KPI")

head(mydata)

dbListTables(con)

tbl(con, in_schema("SECURE_SHARE", "DIM_PLEA_DATE"))
```



# Pull dataframe column names
```{r}
df_names <- names(df)
eval_df_names <- names(eval_df)
join_df_names <- names(join_df)

# write.csv(df_names, file = "G:/CrimJustice/PretrialAssessmentPilot/df_names.csv")
# write.csv(eval_df_names, file = "G:/CrimJustice/PretrialAssessmentPilot/eval_df_names.csv")
# write.csv(join_df_names, file = "G:/CrimJustice/PretrialAssessmentPilot/join_df_names.csv")


```

