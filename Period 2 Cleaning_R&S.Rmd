---
title: "County Data Loading"
author: "Noah Lehman"
date: "10/15/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Libraries
```{r}
library(data.table)
library(openxlsx)
library(readxl)
library(lubridate)
library(tidyverse)
```

# Function Creation
```{r}
# name_keeper <- function(df){
#   attr(df, "names_original") <- names(df)
# }

rm(name_keeper)
```





# Nevada-Sierra
Jail Data
```{r eval=FALSE, include=FALSE}
#Jail Bookings Data Import--Nevada Jail Data
 ## book_df contains booking data that is arranged by booking number, there are multiple lines for each booking number one line for each charge
 ## Sierra county uses Nevadas jail, so there is a county name in the data for the origin of the arrest
 


#Jail Bookings Data Import--Nevada Jail Data 1/1/2015 to 7/27/2020
  ##this is a new file they sent that has all data from 1/1/2015 to 7/27/2020
  ##they fixed it so it also has the code (PC, VC, HS)
  ##they also added a charge description. 
  ## this is the new data it came through, but the dates for arrest, book and rls came in as times only, also there were 39 variables in   the extract Cory sent, rather than 19 as before.  I asked cory to give us all the data back to 1/1/2015 with the dates corrected in     the 39 variable format.
book_df<- read_excel("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Nevada/P2 Submission-June 30/Jail Data Extract2.xlsx", col_types = c("text", rep("guess", 10), "date", rep("guess", 8)), na = "NULL") %>%
  bind_rows() %>%
  distinct () 

# Variable name standardization--See pg. xxx for more details
names(book_df) <- c("cii", "name", "dob", "arrest_date_time", "book_num", "book_date_time", "book_type_original", "court_case_id", "arrest_charge_original", "charge_description", "arrest_charge_level_original", "release_date_time", "release_type_original", "fbi", "cdl_id", "sex_original", "race_original", "bail_amt", "employment_status", "county")




# Date Reformatting (as well as court_case_id)--See pg. xxx for more details.
 
book_df <- book_df %>%
  mutate(dob = as_date(dob),
         arrest_date = as_date(arrest_date_time),
         book_date = as_date(book_date_time),
         release_date = as_date(release_date_time),
         arrest_date_time = as_datetime(arrest_date_time),
         book_date_time = as_datetime(book_date_time),
         release_date_time = as_datetime(release_date_time)) %>%
  mutate(court_case_id = as.character(court_case_id))

# Standardize Factors
book_df <- book_df %>%
  mutate(sex = case_when(sex_original %in% c("M") ~ "Male",
                         sex_original %in% c("F") ~ "Female",
                         sex_original %in% c("U") |
                           is.na(sex_original) ~ "Other_Unknown"),
         
         race = case_when(race_original %in% c("B") ~ "Black",
                          race_original %in% c("H") ~ "Hispanic",
                          race_original %in% c("W") ~ "White",
                          T ~ "Other_Unknown"), 

         book_type = case_when(book_type_original %in% c("STANDARD NEW CHARGES", "STANDARD") ~ "On_View",
                               book_type_original %in% c("COURT COMMIT") ~ "Commitment",
                               book_type_original %in% c("COURTESY" ) ~ "Hold",
                               book_type_original %in% c("COURT BOOK AND RELEA", "CONTRACT" ) ~ "Other"),
         release_type = case_when(release_type_original %in% c("CITE") ~ "Cite_Release",
                                  release_type_original %in% c("CTS") ~ "Time_Served",
                                  release_type_original %in% c("BAIL BOND", "CASH BAIL") ~ "Bail_Bond",
                                  release_type_original %in% c("CASE DISMISSED", "849.5 PC", 
                                                               "48 HR", "825 PC") ~ "Dismissed_Dropped",
                                  release_type_original %in% c("OR") ~ "OR",
                                  release_type_original %in% c("COR", "CD", "JUDGE") ~ "Court_Order",
                                  release_type_original %in% c("SCOR") ~"Pretrial_Sup", 
                                  release_type_original %in% c("BK AND RELEASE") ~"Administrative",
                                  release_type_original %in% c("849 PC", "849(B) PC") ~"Detain_Only",
                                  release_type_original %in% c("TSP") ~ "Prison",
                                  release_type_original %in% c("ICE", "USMS") ~ "Fed",
                                  release_type_original %in% c("") ~ "Unknown",
                                  release_type_original %in% c("AG") ~ "Hold_Released", T ~ "Other"))

           

# Standardize Charges and join charge hierarchy--See pg. xxx for more details about this process. 
  ## also standardize names and CIIs
  ##this name fix is not perfect it misses last names that are spelled with a space in them  fix later
  
book_df <- book_df %>%
  mutate(arrest_charge_code = str_extract(arrest_charge_original, "([A-Z]){2}$"),
         arrest_charge_code = if_else(!arrest_charge_code %in% c("PC", "VC", "HS", "BP", "WI", "US"), "Other", arrest_charge_code))%>%
  mutate(arrest_charge=gsub("([A-Z]){2}$", "", arrest_charge_original)) %>%
        
  mutate(name = toupper(name)) %>% 
  mutate(name = (gsub(" -| - |- ", "-", name))) %>%
  separate(name, c("first_name", "last_name", "middle_name", "suffix"),  sep = " ") %>%
  mutate_at(vars(first_name, last_name, middle_name), trimws) %>%
  
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, (cii))) %>%
         
  mutate(attempt = if_else(grepl("^664\\/", arrest_charge_original), 1, 0)) %>%
  separate_rows(arrest_charge_original, sep = "\\\\|\\/") %>%
  mutate(arrest_charge_level = case_when(arrest_charge_level_original %in% c("M", "MI") ~ "M",
                                         arrest_charge_level_original %in% c("F", "FE") ~ "F",
                                         arrest_charge_level_original %in% c("I") ~ "I",
                                         T ~ "Other"),
         arrest_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}","", arrest_charge_original))) %>%
 unite(join_var, arrest_charge_level, arrest_charge_code, arrest_charge, remove = F) 




#Flag Construction
  ##not seeing any qualifier charges here  arrest_qualifier_flag=if_else()
book_df<- book_df %>%
    mutate(arrest_misd_flag=if_else(arrest_charge_level=="M", 1, 0),
           arrest_felony_flag =if_else(arrest_charge_level=="F", 1, 0),
           attempt_flag=if_else(attempt=="1", 1, 0)) 
           


# Code for Charge Hierarchy
  ## county data has no charge code data, so we had to make join_var2 for the join with the hierarchy/this is corrected 
  ## ordering charge_code so that we join using join_var2 we select only one and get a PC or HS preferentially if there is also and other 
  ## some codes section occur in both PC and VC or (other combo), so we may be getting wring section, but only happends with about 30 code sections
load("Complete Charge Code Hierarchy.RData")

charge_hier<-charge_hier%>%
    mutate(charge_code = ordered(charge_code, levels = c("Other", "BP", "HS", "PC", "US", "VC", "WI"))) %>%
    arrange(desc(charge_code)) %>%
    unite(join_var, charge_level, charge_code, charge, remove = F) %>%
    distinct(join_var, .keep_all = T)


book_df <- left_join(book_df, charge_hier, by = "join_var")



Jail Collapse
# Nevada Jail Collapse
  ## if court_case_id is NA when we collapse on court_case_id and book_num we keep both NA lines and actual court_case_id lines 
book_df <- book_df %>%
  mutate(time_first_release = release_date_time - book_date_time) %>%
  mutate(hierarchy = if_else(is.na(hierarchy), 1e6, as.numeric(hierarchy))) %>%
  group_by(book_num) %>%
  mutate(max_booktype = book_type[hierarchy == min(hierarchy)][1],
        max_arrest_charge = arrest_charge[hierarchy == min(hierarchy)][1],
         max_charge_description = master_charge_description[hierarchy == min(hierarchy)][1],
         max_hier = min(hierarchy)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, .))) %>%
  mutate_at(vars(contains("flag")), funs("count" = sum(.))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  group_by(book_num, court_case_id) %>%
  filter(hierarchy == min(hierarchy)) %>%
  ungroup() %>%
  distinct(book_num, court_case_id, .keep_all = T) 

Jail Diagnostics

# Nevada Jail Diagnostics
 ## some codes section occur in both PC and VC or (other combo), so we may be getting wring section, but only happends with about 30 code sections
charge_hier %>%
  add_count(join_var2) %>%
  filter(n>1) %>%
  filter(charge_code != "Other") %>%
  select(-n) %>%
  add_count(join_var2) %>%
  filter(n>1) %>%
  arrange(join_var2)

book_df %>%
  distinct(book_num) %>%
  arrange(book_num) %>%
  group_by(book_num) %>%
  add_count() %>%
  filter(n>1)
 book_df %>%
  
  distinct(arrest_date) %>%
  arrange(desc(arrest_date))
  
 # diagnostics for charge Hierarchy 
 
   # 1 - 7,901/267,372 = 97% non-match rate
(1 - nrow(book_df %>% filter(is.na(hierarchy)))/nrow(book_df))*100

  #book_df %>%
  filter(is.na(hierarchy)) %>%
  count(join_var2) %>%
  arrange(desc(n))

  # book_df%>%
  #   filter(grepl("F_12032", join_var2))%>%
  #   group_by(join_var2)%>%
  #   count()
  # 
  # charge_hier%>%
  #   filter(grepl("PROB", master_charge_description))

   length(unique(book_df$book_num))

table(book_df$arrest_charge_original)[order(table(book_df$arrest_charge_original), decreasing = T)]


table(grep("\\/", book_df$arrest_charge_original, value = TRUE))

table(book_df$arrest_charge_level_original)

table(book_df$arrest_charge_original)[order(table(book_charge$arrest_charge_original), decreasing = T)]

book_df %>%
  count(arrest_charge_original, arrest_charge) %>%
  group_by(arrest_charge_original) %>%
  add_count() %>%
  filter(n > 1)

book_df$aco_count <- sapply(book_df$arrest_charge_original, function(x) length(which(book_df$arrest_charge_original == x)))
book_df$ac_count <- sapply(book_df$arrest_charge, function(x) length(which(book_df$arrest_charge == x)))
book_df$ac_counts_match <- book_df$aco_count == book_df$ac_count
table(book_df$ac_counts_match, useNA = "ifany")

book_df[!(book_df$ac_counts_match),
        c("book_num", "arrest_charge_level_original", "arrest_charge_original", "arrest_charge", "attempt",
          "aco_count", "ac_count")][order(book_df$arrest_charge[!(book_df$ac_counts_match)]), ]


```
Court Data Nevada
```{r eval=FALSE, include=FALSE}

# Nevada Court Case Data Import 1/2/2015-6/30/2020
  ##Court Status (renamed court_df contains dispostion type) file_date 1/2/2015-12/13/19
  ##Court Charges (also has plea type and dispo type contains plea_date range 9/8/2014-12/24/2019  and disposition_date range 1/22/1949-12/23/2019)
  ##Court hearings (hearing dates range from 1/2/2015-5/31/2019)
  ##Court Warrants (warrant date range 1/5/2015-12/30/2019)

####

#Court Status Nevada
  ##court_df has one row per case and has information on the case status as well as demographic information on the defendant
  ## Status of GC Services means that the case has been referred to a collections agency.  It is effectivly a closed case. They do     not use "inactive" any more, they used closed.  A and B suffixes appear to be codefendants on a case.
  ## running distinct () drops size from 13,687 to 13,675  
  ## file_date range 1/2/2015-12/31/2019  with latest data date range goes up to 6/30/2020
  ## status_date_time range 1/6/2015-12/24/2019 with latest data date range goes up to 7/23/2020
  ## disposition_date range 1/2/2015-9/2/2027 (two later than current date) with latest data date range goes up to 7/23/2020
  ## dob range 3/10/1924-6/3/2001 with latest data date range goes up to 2/20/2002

court_df <- lapply(c("Historical Data Submissions/Nevada/PTRiskAss-Case+PtyData.csv",
                     "Historical Data Submissions/Nevada/Submitted 2-3/PTRiskAss-Case+PtyData.csv",
                     "Historical Data Submissions/Nevada/P2 Submission-June 30/PTRiskAss-Case+PtyData.csv",
                     "Historical Data Submissions/Nevada/P2 Submission-June 30/PTRiskAss-Case+PtyData.csv"),
                   function(x) {
                     fread(x, colClasses = "character")
                   }) %>%
  bind_rows() %>%
  distinct()

 
 
# Variable name standardization--See pg. xxx for more details. 
names(court_df) <- c("court_docket_id", "court_case_id", "file_date", "status", "status_date_time", "court_charge_description", "disposition_type_original", "disposition_date", "local_id", "first_name", "middle_name", "last_name", "suffix", "party_code", "ssn", "dob", "cii", "fbi", "sex_original", "race_original")


# Date Reformatting--See pg. xxx for more details.  Also reformatting CII
court_df <- court_df %>%
  mutate(dob = mdy(dob),
         status_date_time = mdy_hms(status_date_time),
         file_date = mdy(file_date),
         disposition_date = mdy(disposition_date),
         status_date = as_date(status_date_time)) %>%
        
  mutate(cii = gsub("-", "", cii), 
         cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, (cii)))



# Standardize Factors--See pg. xxx for more details.
court_df <- court_df %>%
  mutate(sex = case_when(sex_original %in% c("M") ~ "Male",
                         sex_original %in% c("F") ~ "Female", T ~ "Other_Unknown"),
         race = case_when(race_original %in% c("AA") ~ "Black",
                          race_original %in% c("HISP") ~ "Hispanic",
                          race_original %in% c("CAU") ~ "White",
                          T ~ "Other_Unknown"),
         disposition_type = case_when(disposition_type_original %in% c("DISMISSED", 
                                                                       "DISMISS AFTER APPEARANCE",
                                                                       "DISMISSED BEFORE TRIAL (W/O APPEARANCE)",
                                                                       "DISMISS/ACQUIT BEFORE EVIDENCE BY COURT",
                                                                       "DISMISS AFTER EVIDENCE BY JURY TRIAL",
                                                                       "DISMISS/ACQUIT AFTER EVIDENCE BY COURT",
                                                                       "DISMISSAL AFTER HEARING/PRELIM",
                                                                       "DISMISSAL BEFORE HEARING/PRELIM",
                                                                       "DISMISS/ACQUIT BEFORE EVIDENCE BY JURY TRIAL",
                                                                       "DISMISS W/O APPEARANCE") ~ "Dismissed",
                                      disposition_type_original %in% c("PLEA GUILTY/NOLO",
                                                                       "PLEA GUILTY/NOLO/MISD OTHER",
                                                                       "PLEA GUILTY/NOLO/MISD 17B",
                                                                       "CONVICT AFTER EVIDENCE BY COURT/FELONY",
                                                                       "CONVICT BEFORE EVIDENCE BY COURT",
                                                                       "CONVICT BEFORE EVIDENCE BY COURT/17B", 
                                                                       "PLEA GUILTY/NOLO/FELONY") ~ "Nolo_Contendere",
                                      disposition_type_original %in% c("CONVICTED",
                                                                       "CONVICT AFTER EVIDENCE BY JURY TRIAL",
                                                                       "CONVICT AFTER EVIDENCE BY JURY TRIAL/FELONY",
                                                                       "CONVICT AFTER EVIDENCE BY COURT",
                                                                       "CONVICT AFTER EVIDENCE BY JURY TRIAL/MISD OTHER",
                                                                       "CONVICT BEFORE EVIDENCE BY COURT/MISD OTHER",
                                                                       "CONVICT BEFORE EVIDENCE BY COURT/FELONY") ~ "Guilty",
                                      disposition_type_original %in% c("ACQUITTED/NOT GUILTY", 
                                                                       "NOT GUILTY/INSANE",
                                                                       "DO NOT USE - ACQUITTAL AFTER JURY TRIAL") ~ "Not_Guilty",
                                      disposition_type_original %in% c("CONSOLIDATED", 
                                                                       "EXTRADITED", 
                                                                       "CERTIFIED TO JUVENILE COURT", 
                                                                       "DO NOT USE THIS CODE!", 
                                                                       " ", 
                                                                       "UNDISPOSED",
                                                                       "PROBATION SUPERVISION - TRANSFER IN",
                                                                       "WAIVER OF EXTRADITION SIGNED",
                                                                       "CONSOLIDATED BEFORE HEARING/PRELIM/TRIAL",
                                                                       "COURT FINDING",
                                                                       "BAIL FORFEITURE",
                                                                       "UNKNOWN",
                                                                       "TRAFFIC SCHOOL - AFTER APPEARANCE/HEARING",
                                                                       "CONSOLIDATED AFTER HEARING/PRELIM/TRIAL",
                                                                       "TRAFFIC SCHOOL - BEFORE APPEARANCE/HEARING",
                                                                       "CHANGE OF VENUE - AFTER HEARING/PRELIM/TRIAL",
                                                                       "TRANSFER TO ANOTHER COURT") ~ "Other"))





####


# Court Filing Charges 
  ## court_charges contains one row per each charge associated with a court case and includes information on the charges and dispostions of each charge.
  ## court_charges contains a disposition_date, but there can be multiple disposition dates within a court case when VOP charges are dealt with after the main court case. It appears that the disposition_date in court_df would be a better source of disposition date

court_charge <- lapply(c("Historical Data Submissions/Nevada/PTRiskAss-Chg.csv",
                          "Historical Data Submissions/Nevada/Submitted 2-3/PTRiskAss-Chg.csv",
                           "G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Nevada/P2 Submission-June 30/PTRiskAss-ChargeData.csv"),
                        fread) %>%
  bind_rows() %>%
  distinct()




# Variable name standardization--See pg. xxx for more details. 
names(court_charge) <- c("court_docket_id", "court_case_id", "local_id", "court_charge_number", "court_charge_code_original", "court_charge_level_original", "court_charge_description", "plea_type_original", "plea_date", "disposition_type_original", "disposition_date")

# Date Reformatting--See pg. xxx for more details.
  ## plea_date range 9/8/2014-7/22/2020
  ## disposition_date range 1/22/1949-7/23/2020
  
  
court_charge <- court_charge %>%
  mutate(plea_date = mdy(plea_date),
         disposition_date = mdy(disposition_date))





# Court Filing Charges 
   ## the most frequent "other" charge level is "NOT CHARGED"
   ## seems like about 100 court charges are strung together"290012A290018" "290010290018B" "290013A29018B" "23152A23550A"  "23152A235505"                  "23152B235505"  "23152A23550"
   ## removing sentence date beacuse not needed


court_charge <- court_charge %>%
  mutate(attempt = if_else(grepl("\\(664\\)$|\\/664$|^664\\/", court_charge_code_original), 1, 0)) %>%
  mutate(court_charge_code = substr(court_charge_code_original, 1, 2),
         court_charge_code = ifelse(!(court_charge_code %in% c("PC", "VC", "HS", "BP", "WI","US")), "Other",
                                    court_charge_code),
         court_charge = ifelse(court_charge_code != "Other", substr(court_charge_code_original, 3,
                                                                    nchar(court_charge_code_original)), NA),
         court_charge = gsub("M$|F$|I$", "", court_charge), 
         court_charge = gsub("\\(664\\)$|\\/664$|^664\\)", "", court_charge),
         court_charge = gsub("\\(2ND\\)", "", court_charge),
         court_charge = gsub("\\-U18|\\-O21|\\-?18\\-21", "", court_charge),
         court_charge = gsub("\\+$|\\-", "", court_charge),
         court_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}","", court_charge)),
         court_charge_level = str_extract(court_charge_level_original, "[A-Z]{1}"),
         court_charge_level = if_else(court_charge_level  %in% c("F1"), "F" , court_charge_level),
         court_charge_level = if_else(!court_charge_level %in% c("F", "I", "M"), "Other", court_charge_level)) %>%
  unite(join_var, court_charge_level, court_charge_code, court_charge, remove = F) 

# Standardize Factors--See pg. xxx for more details.
court_charge <- court_charge %>%
  mutate(disposition_type = case_when(disposition_type_original %in% c("DISMISSED") ~ "Dismissed",
                         #disposition_type_original %in% c("") ~ "Dropped",
                         #disposition_type_original %in% c("") ~ "Nolo_Contendere",
                         disposition_type_original %in% c("CONVICTED") ~ "Guilty",
                         disposition_type_original %in% c("ACQUITTED/NOT GUILTY", "NOT GUILTY/INSANE") ~ "Not_Guilty",
                         disposition_type_original %in% c("CONSOLIDATED", "EXTRADITED", "CERTIFIED TO JUVENILE COURT", "DO NOT USE THIS CODE!", " ") ~ "Other"),
         plea_type = case_when(plea_type_original %in% c("NO CONTEST PLEA", "NO CONTEST ADMISSION") ~ "Nolo_Contendere",
                               plea_type_original %in% c("ADMIT", "GUILTY") ~ "Guilty",
                               plea_type_original %in% c("DENY", "NOT GUILTY", "NOT GUILTY BY REASON OF INSANITY PLEA") ~ "Not_Guilty",
                               plea_type_original %in% c("NO PLEA", "DIVERSION", " ") ~ "Other"))
                               
                               
  #sentence_date = if_else(disposition_type_original %in% c("CONVICTED"), disposition_date, as_date(NA)))


 
# Code for Charge Hierarchy and
#Make flags
load("Complete Charge Code Hierarchy.RData")



court_charge <- left_join(court_charge, charge_hier, by = "join_var") %>%
  mutate(felony_flag = if_else(court_charge_level == "F", 1, 0),
         misd_flag = if_else(court_charge_level == "M", 1, 0)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, as.numeric(.)))) %>%
  mutate_at(vars(contains("flag")), funs("conviction" = if_else(. == 1 & disposition_type %in% c("Guilty", "Nolo_Contendere"), 1, 0))) %>%
  rename_at(vars(contains("flag"), -contains("conviction")), funs(paste0("court_", .))) %>%
  rename_at(vars(contains("conviction")), funs(paste0("conviction_", gsub("_conviction", "", .)))) 

####

# Court Hearings
  ## court_hearing contains one row per hearing event on each court case and includes informatioin about each hearing. 
    ## hearing dates range from 1/2/2015-6/30/2020



court_hearing <-lapply(c("Historical Data Submissions/Nevada/PTRiskAss-Evnt3.csv",
                         "G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Nevada/P2 Submission-June 30/PTRiskAss-EventData.csv"), 
                       fread)%>%
  bind_rows() %>%
  distinct()



# Variable name standardization--See pg. xxx for more details.
names(court_hearing) <-
  c( "court_docket_id","court_case_id", "local_id", "hearing_id", "hearing_date", "hearing_type_original", "hearing_result")

# Date Reformatting--See pg. xxx for more details.
court_hearing <- court_hearing %>%
  mutate(hearing_date = mdy(hearing_date))
 


# Standardize Factors--See pg. xxx for more details.
court_hearing <- court_hearing %>%
  mutate(
    hearing_type = case_when(
      hearing_type_original %in% c("ARRAIGNMENT","WARRANT ARRAIGNMENT", "ARRAIGNMENT ON VIOLATION OF PROBATION (VOP)",
                                   "CONTINUED ARRAIGNMENT", "ARRAIGNMENT ON VIOLATION OF PROBATION-FELONY",
                                   "ARRAIGNMENT ON INFORMATION", "ARR ON PETITION TO REVOKE/MODIFY PAROLE",
                                   "ARR ON PETITION TO REV/MOD MANDATORY SUPERVISION", "FELONY ARRAIGNMENT",
                                   "DUI ARRAIGNMENT") ~ "Arraignment",
      hearing_type_original %in% c(
        "SENTENCING", "FELONY SENTENCING",  "SENTENCING ON VIOLATION OF PROBATION", "SENTENCING ON VIOLATION OF PROBATION - FELONY",
        "SENTENCING ON PETITION TO REVOKE/MODIFY PAROLE", "SENTENCING ON PET TO REV/MOD MANDATORY SUPERVISION",
        "SENTENCING ON PETITION TO MODIFY/REVOKE PRCS" ) ~ "Sentencing",  T ~ "Other_Unknown"),
    court_fta_flag = if_else(grepl("FTA|FAILURE TO APPEAR", hearing_result), 1, 0))

####

# Court FTAs with Warrants date range 1/5/2015-7/6/2020
court_warrants <- lapply(c("Historical Data Submissions/Nevada/PTRiskAss-BW.csv",
                           "Historical Data Submissions/Nevada/Submitted 2-3/PTRiskAss-BW.csv",
                           "G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Nevada/P2 Submission-June 30/PTRiskAss-BenchWarrantData.csv"),
                         fread) %>%
  bind_rows() %>%
  distinct()



names(court_warrants) <- c("court_docket_id", "court_case_id", "hearing_id", "hearing_date", "fta_warrant", "fta_warrant_date")


court_warrants <- court_warrants %>%
  mutate(hearing_date = mdy(hearing_date),
         fta_warrant_date = mdy(fta_warrant_date),
         fta_flag = 1)


####

Nevada Court Collapse 

##dispostion date in court charge is a charge dispostion date rather than a case dispostion date, I think we want dispostion date from court_df
##Nevada did not provide sentence date or sentence type

court_dispo <- court_charge %>%   
  mutate(disposition_type = ordered(disposition_type, levels = c("Other", "Dismissed", "Not_Guilty", "Nolo_Contendere", "Guilty"))) %>%
  group_by(court_case_id) %>%
  mutate(hierarchy = if_else(is.na(hierarchy), 1e6, as.numeric(hierarchy))) %>%
  group_by(court_case_id) %>%
  # mutate(disposition_date = max(disposition_date), disposition_type = max(disposition_type)) %>%
  select (-disposition_date) %>%
  # mutate(sentence_date=min(sentence_date, na.rm=TRUE)) %>%
  mutate(max_court_charge_level = court_charge_level[hierarchy == min(hierarchy)][1],
         max_court_charge_code = court_charge_code[hierarchy == min(hierarchy)][1],
         max_court_charge = court_charge[hierarchy == min(hierarchy)][1],
         max_charge_description = master_charge_description[hierarchy == min(hierarchy)][1],
         max_hier = min(hierarchy)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, .))) %>%
  mutate_at(vars(contains("flag")), funs("count" = sum(.))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  filter(hierarchy == min(hierarchy)) %>%
  ungroup() %>%
  distinct(court_case_id, .keep_all = T)



#This code adds flags for FTAs this comes from court hearing data that i ran below
  ## court_warrants only contains lines with FTA flags no need to make fta_date or fta_flag 
court_fta_war <- court_warrants %>%
  arrange(fta_warrant_date) %>%
  group_by(court_case_id) %>%
  mutate(fta_flag_count = sum(fta_flag))%>%
  distinct(court_case_id, .keep_all = T) %>%  
 select(court_case_id,  fta_warrant_date, fta_flag, fta_flag_count)


#This code makes arraignment date
court_arraign <- court_hearing %>%
  filter(hearing_type == "Arraignment") %>%
  rename(arraignment_date = hearing_date) %>%
  arrange(arraignment_date) %>%
  distinct(court_case_id, .keep_all = T) %>%
  select(court_case_id, arraignment_date)


#This code makes a plea date
court_plea <- court_charge %>%
  arrange(disposition_date) %>%
  mutate(guilty_flag = if_else(disposition_type == "Guilty", 1, 0)) %>%
  group_by(court_case_id) %>%
  filter(guilty_flag == 1|sum(guilty_flag) == 0) %>%
  ungroup() %>%
  distinct(court_case_id, .keep_all = T) %>%
  select(court_case_id, plea_date , plea_type)



#this creates court sentence dates (I dont have a sentence date in Nevada it was created above so I dont think I need this code)
  ##not including this becuase it is making up fake data
#court_sent <- court_hearing %>%
  #arrange(sentence_date) %>%
  #distinct(court_case_id, .keep_all = T) %>%
  #select(court_case_id, sentence_date)

#this part does something not sure what
 ## leaving out mutate f final dispo date becasue we dont have sentence date in this dataset
 ## court_df is already came to us collapsed at level of case
court_df <- reduce(list(court_df, court_dispo, court_fta_war, court_arraign, court_plea), left_join, by = "court_case_id") %>%
  select(-contains(".y")) %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x", "", .))) %>%
  #mutate(final_disposition_date = if_else(disposition_date <= sentence_date|is.na(sentence_date), disposition_date, sentence_date),
  mutate(conviction_flag = if_else(disposition_type %in% c("Guilty","Nolo_Contendere"), 1, 0))



Court Diagnostics


  # not seeing any qualifier charges here  arrest_qualifier_flag=if_else()
            #sup_vio_post_flag=if_else(book_type=="Sup_Vio", 1, 0),

# Diagnostics

summary(court_df$dob)


sort(table(court_charges$court_charge_code_original[court_charges$court_charge_code == "Other"]), decreasing = TRUE)
unique(court_charges$court_charge[order(nchar(court_charges$court_charge), decreasing = TRUE)])
court_charges[grep("\\(F\\)$|\\(I\\)$", court_charges$court_charge_code_original), ]   

#court_charges%>%
 # table(court_charges$disposition_type, useNA="ifany")
#Court Charge Diagnositics  

lapply(court_df, function(i){
  if (is.character(i)==T){
    sum(is.na(i)|i=="NULL")
  }
  else{
    sum(is.na(i))
  }
})

lapply(court_df, function(i){
  if(length (unique(i)) <=50)
    table(i, useNA="always")})


court_df %>%
  distinct(court_case_id)%>%
  semi_join(court_charge, by="court_case_id")


court_df %>% 
    arrange (court_case_id, file_date) %>%
    add_count(court_case_id) %>%
    filter(n>1)  

table(court_charges[grep("attempt", court_charges$court_charge_description, ignore.case = T ), c("court_charge_description", "court_attempt_flag")])

court_charges[grep("attempt", court_charges$court_charge_description, ignore.case = T ), c("court_charge_description", "court_attempt_flag", "court_charge_code_original")]
# 

# "M_VC_231035A" this charge never used during arrest usually arrest is DUI then they plead down to receless driving"wet"
# "Other_PC_6665" special allegation prior auto theft

# Diagnostic Code for Charge Hierarchy
# 1 - 7,901/267,372 = 97% non-match rate
(1 - nrow(court_charge %>% filter(is.na(hierarchy)))/nrow(court_charge))*100

court_charge %>%
  filter(is.na(hierarchy)) %>%
  count(join_var) %>%
  arrange(desc(n))

court_charge%>%
  filter(grepl("Other_Other_NA", join_var))%>%
  group_by()%>%
  count() 


court_charge %>%
   filter(grepl("Other_Other_NA", join_var))%>%
  select(join_var, court_charge_level_original, court_charge_level, court_charge_code,court_charge_code_original, court_charge_level_original, disposition_type_original)

charge_hier%>%
  filter(grepl("12032", charge))

# some charges end with a "+" 
# some end with "M" or "F" or "I"
# some have "(664)" or "/664" at the end (attempt) or "664/" at the beginning
# some have "(2ND)"
# some have "-o21" or "-u18" or "-18-21" at end
# some have multiple statutes, but with either slash between or one in parentheses at end or neither

# court_charges[c("court_charge_code_original", "court_charge_level_original", "court_charge_code", "court_charge")]

# table(court_charges$court_charge_code)[order(table(court_charges$court_charge_code), decreasing = TRUE)]

# Code to check ones that don't start with two letters
# unique(court_charges$court_charge_code_original[!(grepl("^[A-Z]{2}", court_charges$court_charge_code_original)) | grepl("^[A-Z]{3}", court_charges$court_charge_code_original)])

# court_charges[substr(court_charges$court_charge_code_original, 1, 2) == "MC", ]

#Court hearing data
# court_hearing <- lapply(c("Historical Data Submissions/Nevada/PTRiskAss-Evnt3.csv",
#                           "Historical Data Submissions/Nevada/Submitted 2-3/PTRiskAss-Evnts.csv"),
#                         fread) %>%
#   bind_rows()
# new hearings file is actually duplicate of bench warrants data also sent separately. no q1 hearings data yet.
```

Import Court Data Sierra
```{r eval=FALSE, include=FALSE}

 ## On jan 7 and jan 14, 2020 we got these two files, but no similar files came in for period 2.  We had a cll with them and they will resubmit the data
court_pt_1_fta <- read.csv("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Sierra/Pretrial_1_FTA.csv",
                              as.is = TRUE)

names(court_pt_1_fta) <- c("case_id", "case_name", "first_name", "last_name", "cdl_id", "cdl_id_type", "file_date", "charge_level", "disposition_date", "disposition_type", "disposition_manner", "fta_warrant_date", "fta_warrant_type")

court_pt_1_ftat <- court_pt_1_fta %>%
  mutate_at(vars(contains("date")), mdy)

court_pt_grant <- read.xlsx("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Sierra/Pretrial Grant Cases.xlsx")


names(court_pt_grant) <- c("case_id", "case_name", "charge_number", "charge_level", "charge", "violation_date", "file_date", "disposition_date", "disposition_type", "disposition_manner")

court_pt_grant <- court_pt_grant %>%
  mutate_at(vars(contains("date")), as_date, origin = "1899-12-30")



#These 3 tables were submitted 7/28/2020 : contain historical data through P2 data  
  ##Court Demogrpahics: contain court case id, first name, last name, DOB, race, sex
  ##FTA, 
  ##charges_dispostions
 


## Court Demographics
court_df_s <- read.csv("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Sierra/P2 Submission-June 30/Pretrial_4_Demographics-VH(SierraProd-2020-07-28).csv", as.is=TRUE) 

# Date Reformatting--See pg. xxx for more details.  
court_df_s <- court_df_s %>%  
  mutate_at(vars(contains("Date")), mdy) 


# Name Standardization--See pg. xxx for more details. 
names(court_df_s) <- c("court_case_id", "first_name", "last_name","dob",  "race_original","sex_original")



# Standardize Factors--See pg. xxx for more details.
court_df_s <- court_df_s %>%
  mutate(sex = case_when(sex_original %in% c("Male") ~ "Male",
                         sex_original %in% c("Female") ~ "Female", T ~ "Other_Unknown"),
         race = case_when(race_original %in% c("Black") ~ "Black",
                          race_original %in% c("Hispanic") ~ "Hispanic",
                          race_original %in% c("White") ~ "White",
                          T ~ "Other_Unknown"))


 ####

court_warrant_s <- read_csv("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Sierra/P2 Submission-June 30/Pretrial_2_ScheduledEvents_Warrant-VH(SierraProd-2020-07-28).csv") 

# Date Reformatting--See pg. xxx for more details.  
court_warrant_s <- court_warrant_s%>%  
  mutate_at(vars(contains("date")), mdy) 


# Name Standardization--See pg. xxx for more details. 
names(court_warrant_s) <- c("case_id", "case_name", "hearing_type", "hearing_result_date", "hearing_result_type", "fta_warrant_date", "fta_warrant_type")

####


#Import Court Charges and Dispostions
  ## Date range for filing date is 9/16/2019 to 6/23/2020
 ## Dispostion Date range 10/23/2007 to 7/21/2020
 ##sentence date 5/11/2018 to 7/23/2020
court_dispos_s <- read_csv("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Sierra/P2 Submission-June 30/Pretrial_3_Charges-VH(SierraProd-2020-07-28).csv") 

# Name Standardization--See pg. xxx for more details. 
names(court_dispos_s) <- c("court_case_id", "case_name", "file_date", "charge_number", "charge_level", "charge", "disposition_date", "disposition_type", "disposition_manner", "sentence_date", "sentence_type", "sentence_amount", "sentence_length", "sentence_length_unit")


# Date Reformatting--See pg. xxx for more details.  
court_dispos_s <- court_dispos_s%>%  
  mutate_at(vars(contains("date")), mdy) 


summary(court_dispos_s$sentence_date)

court_df_s %>%
  semi_join(court_dispos_s)


####

```

Probation Data New
```{r eval=FALSE, include=FALSE}

assess_df_case <- read_excel("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Nevada/P2 Submission-June 30/pretrial_data.xlsx",  sheet = 1)

# Format Names
assess_df_case <- assess_df_case %>%
  mutate (name = toupper(Name)) %>% 
  separate(name, c("last_name", "first_name", "suffix"),  sep = ",") %>%
  mutate_at(vars(first_name, last_name, suffix), trimws) %>%
  separate(first_name, c("first_name", "middle_name"), sep = " ") 

# Standardize Names
names(assess_df_case) <- c("pretrial_id", "pretrial_id1", "pretrial_id2", "arresting_agency", "name","zip_code",
                            "release_recommendation_original", "pretrial_release_type_original",
                           "pretrial_release_date_time",
                            "court_date_reminder", "pretrial_termination_outcome_original", "pretrial_termination_date",
                            "last_name","first_name", "middle_name","suffix")


# Date Reformatting--See pg. xxx for more details.
assess_df_case <- assess_df_case %>%
  mutate(pretrial_release_date = as_date(pretrial_release_date_time))  



assess_df_demo <- read_excel("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Nevada/P2 Submission-June 30/pretrial_data.xlsx", col_types= c("text" , "text" , "text" , "text" ,  "text" , "text" ,
                                                    "text" , "date" , "text" ,  "text" ) , sheet = 2)


assess_df_demo <- assess_df_demo %>%
  mutate (name = toupper(Name)) %>% 
  separate(name, c("last_name", "first_name", "suffix"),  sep = ",") %>%
  mutate_at(vars(first_name, last_name, suffix), trimws) %>%
  separate(first_name, c("first_name", "middle_name"), sep = " ")

 
# Standardize Names
names(assess_df_demo) <- c("pretrial_id1", "pretrial_id2", "arresting_agency", "cii", "fbi", "cdl_id",
                            "name", "dob", "sex_original", "race_original",
                            "last_name","first_name", "middle_name","suffix")



assess_df_demo %>%
  count (sex_original)
  
#Standardize Factors
assess_df_demo <- assess_df_demo %>%
 mutate(sex = case_when(sex_original %in% c("Female") ~ "Female",
                         sex_original %in% c("Male") ~ "Male"),
         race = case_when(race_original %in% c("Hispanic") ~ "Hispanic",
                          race_original %in% c("Black") ~ "Black",
                          race_original %in% c("White") ~ "White",
                          race_original %in% c("NULL", "Pacific Islander", "Unknown") ~ "Other_Unknown"))


#Readin Scores

assess_df_score <- read_excel("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Nevada/P2 Submission-June 30/pretrial_data.xlsx", sheet = 3, na = "NULL")

# Standardize Names
assess_df_score <- assess_df_score %>%
  mutate (name = toupper(Name)) %>% 
  separate(name, c("last_name", "first_name", "suffix"),  sep = ",") %>%
  mutate_at(vars(first_name, last_name, suffix), trimws) %>%
  separate(first_name, c("first_name", "middle_name"), sep = " ") 



# Rearrange Scores from Long to Wide
assess_df_score <- assess_df_score %>%
  group_by (IdNumber, Assessment_Date_Time, arrestingagency) %>%
  pivot_wider(names_from = Tool_Question,  values_from = Tool_Response) %>%
  ungroup() %>%
  select(-`NA`)
  
  
# Standardize Names
names(assess_df_score) <- c("pretrial_id1", "pretrial_id2", "arresting_agency", "name","tool_name",
                            "assessment_date_time", "oras_risk_score", "last_name", "first_name",
                            "middle_name","suffix","oras_tool_response_1", "oral_tool_response_2",
                            "oras_tool_response_3",	"oras_tool_response_4","oras_tool_response_5",
                            "oras_tool_response_6", "oras_tool_response_7")



# Date Reformatting--See pg. xxx for more details.
assess_df_score <- assess_df_score %>%
  mutate(assess_date = as_date(assess_date_time)) %>%
  

# Readin Terms and Conditions
  
assess_df_terms <- read_excel("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Nevada/P2 Submission-June 30/pretrial_data.xlsx", sheet = 4)

#need to pivot wider on this table.

"pretrial_id", "pretrial_id1", "pretrial_id2", "arresting_agency", "name", "release_conditions_original"

names(assess_df) <- c("pretrial_id", "cii", "court_case_id", "court_docket_id", "fbi", "local_id", "cdl_id", "first_name", "last_name", "dob", "sex_original", "race_original", "hispanic_flag", "tool_name", "assessment_date_time", "zip_code", "vprair_risk_score", "release_recommendation_original", "recommendation_comments", "release_authorization_original", "pretrial_release_type_original", "release_date", "release_conditions_original", "pretrial_violation_flag", "pretrial_violation_date",  "court_date_reminder_original", "other_pretrial_service_original", "pretrial_termination_outcome_original", "pretrial_termination_date", "open_date", "assignment_date", "arrest_date", "vprair_tool_response_1", "vprair_tool_response_4", "vprair_tool_response_2", "vprair_tool_response_8", "vprair_tool_response_7", "vprair_tool_response_3", "vprair_tool_response_5", "vprair_tool_response_6", "vprai_tool_response_1", "vprai_tool_response_3", "vprai_tool_response_8", "vprai_tool_response_6", "vprai_tool_response_7", "vprai_tool_response_2", "vprai_tool_response_4", "vprai_tool_response_5")
county
zip_code
book_num
court_case_id
court_docket_id
assessment_date
assessment_date_time

assess_df_viol <- read_excel("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Nevada/P2 Submission-June 30/pretrial_data.xlsx", sheet = 5)



assess_df <- assess_df %>% 
  mutate(assess_flag = if_else(is.na(assessment_date), 0, 1),
         rec_release_flag = if_else(release_recommendation %in% c("OR", "Monitor"), 1, 0),
         decision_release_flag = if_else(release_decision %in% c("OR", "Monitor"), 1, 0),
         #This field needs to come from the jail data.
         # pretrial_release_flag = if_else(),
         release_override_flag = if_else(rec_release_flag != decision_release_flag & 
                                            !release_recommendation %in% c("Ineligible", "Other_Unknown") & 
                                            !release_decision %in% c("Ineligible", "Other_Unknown"), 1, 0),
         rec_em_flag = if_else(grepl("SCRAM", toupper(release_recommendation_original)), 1, 0),
         # rec_phone_flag = if_else(),
         # rec_inperson_flag = if_else(),
         rec_drug_test_flag = if_else(grepl("TEST", toupper(release_recommendation_original)), 1, 0),
         # rec_other_flag = if_else(),
         condition_em_flag = if_else(grepl("ELECTRONIC MONITOR|GPS|SCRAM", toupper(release_conditions_original))|
                                             grepl("SCRAM", toupper(pretrial_release_type_original)), 1, 0),
         # Discuss release_conditions_original with Santa Barbara along with their original materias to determine phone and inperson flag. 
         # condition_phone_flag = if_else(),
         # condition_inperson_flag = if_else(),
         ## Does test as requested entail a request flag? What is the treatment program?
         condition_drug_test_flag = if_else(grepl("SCRAM|TEST", toupper(release_conditions_original))|
                                                    grepl("SCRAM|TEST", toupper(pretrial_release_type_original)), 1, 0),
         condition_no_contact_flag = if_else(grepl("NO CONTACT|136", toupper(release_conditions_original)), 1, 0),
         court_date_reminder_flag = if_else(court_date_reminder_original == "CourtAppearance"|
                                              pretrial_release_type_original %in% c("PTS with court reminders", "OR-with court reminders"), 1, 0),
         # Transit service doesn't actually exist here.  
         transit_service_flag = if_else(court_date_reminder_original == "TRANSIT", 1, 0),
         ## Are all violations violations that result in termation? 
         pretrial_violation_flag = if_else(!is.na(pretrial_violation_date), 1, 0))


# Read in Probation Risk Assessment Data
 ## This is data that covers 7/7/2011 to 2/6/2020
prob_df <- read_excel("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Nevada/Pretrial.Updated.xlsx")

names(prob_df) <- c("name", "local_id", "dob", "sex_original", "race_original", "cii", "fbi", "cdl_id", "zip_code", "case_start_date", "tool_name_original", "assessment_date_time", "assessment_id", "risk_level_original", "release_recommendation_original", "release_date_time", "ftas", "new_law_violations", "release_decision_original", "pretrial_termination_outcome", "book_num", "termination_date")

# Dates and Factors Standardization

prob_df <- prob_df %>%
  mutate_at(vars(contains("time")), convertToDateTime) %>%
  mutate_at(vars(termination_date), convertToDate) %>%
  # dob and case_start_date are already in posix at the read in, but they have all zero time stamps
  mutate(assessment_date = as_date(assessment_date_time),
         release_date = as_date(release_date_time)) %>%
  mutate(sex = case_when(sex_original %in% c("Female") ~ "Female",
                         sex_original %in% c("Male") ~ "Male"),
                         # sex_original %in% c() ~ "Other_Unknown"),
         race = case_when(race_original %in% c("Hispanic") ~ "Hispanic",
                          race_original %in% c("Black") ~ "Black",
                          race_original %in% c("White") ~ "White",
                          race_original %in% c("NULL") ~ "Other_Unknown"),
         tool_name = case_when(tool_name_original %in% c("ORAS-PAT") ~ "ORAS"),
         risk_level = case_when(risk_level_original %in% c("Low") ~ "Low",
                                risk_level_original %in% c("Moderate") ~ "Medium",
                                risk_level_original %in% c("High") ~ "High",
                                risk_level_original %in% c("NULL") ~ "Unknown"),
         release_recommendation = case_when(release_recommendation_original %in% c("Grant") ~ 1,
                                            release_recommendation_original %in% c("Deny") ~ 0),
         release_decision = case_when(release_decision_original %in% c("Granted") ~ 1,
                                      release_decision_original %in% c("Denied") ~ 0))
                                                                        
summary(prob_df$dob)                               

# grep("original", names(prob_df), value = TRUE)
# sort(table(prob_df$release_decision_original, useNA = "ifany"), decreasing = TRUE)
#  [is.na(prob_df$release_decision)]
# table(prob_df$release_recommendation, useNA = "ifany")

```

Probation data Old dont use
```{r eval=FALSE, include=FALSE}
Probation Data Old Dont Use

# decided not to use "PRETRIAL STATS" workbooks, will use "Pretrial.Updated" instead
# also not using "Pretrial.SQL.Historic" (individual item responses) or "Pretrial.Demographics" (unuseable dates)

# prob_sheets <- lapply(c("2016.", "2017.", "2018. "), 
#                       function(i){
#                         getSheetNames(paste0("Historical Data Submissions/Nevada/PRETRIAL STATS ", 
#                                        i, "Nevada.xlsx"))
#                       })
# names(prob_sheets) <- c("2016", "2017", "2018")
# 
# prob_sheets_read <- data.frame(File = c(rep("2016.", length(prob_sheets[["2016"]])), 
#                                         rep("2017.", length(prob_sheets[["2017"]])),
#                                         rep("2018. ", length(prob_sheets[["2018"]]))),
#                                Sheet = unlist(prob_sheets), 
#                                Skip = c(rep(3, 16), rep(2, length(unlist(prob_sheets)) - 16)),
#                                DNR = unlist(prob_sheets) == "Sheet3")

# problem with first sheet -- no actual data, two rows with irrelevant headers
# prob_sheets_read$DNR[prob_sheets_read$File == "2016." & prob_sheets_read$Sheet == "MAY"] <- TRUE
# 
# prob_df <-
#   lapply(c("2016.", "2017.", "2018. "), 
#          function(i){
#            lapply(getSheetNames(paste0("Historical Data Submissions/Nevada/PRETRIAL STATS ", 
#                                        i, "Nevada.xlsx")), 
#                   function(j){
#                     if(!prob_sheets_read$DNR[prob_sheets_read$File == i &
#                                              prob_sheets_read$Sheet == j]) {
#                       read_excel(paste0("Historical Data Submissions/Nevada/PRETRIAL STATS ", 
#                                         i, "Nevada.xlsx"),
#                                  col_names = F, sheet = j, col_types = "text", 
#                                  skip = prob_sheets_read$Skip[prob_sheets_read$File == i &
#                                                               prob_sheets_read$Sheet == j])
#                     }
#                   }) %>% bind_rows()
#          }) %>% bind_rows()
# 
# names(prob_df) <- c("name", "charge_original", "charge_level_original", "risk_level_original", "risk_other", "sex_original", "age", "book_date", "release_date", "po", "ref", "or_flag", "or_condition_flag", "gps_flag", "alcohol_flag", "denied_flag", "other_flag", "termination_type", "termination_date", "termination_reason", "release_recommendation_original", "release_decision_original")

# "ref" is a completely blank column

# original_field <- as.character(read_excel("Historical Data Submissions/Nevada/PRETRIAL STATS 2018. Nevada.xlsx",
#                                        sheet = "JAN", skip = 1, n_max = 1, col_names = FALSE))
# 
# original_field[19:20] <- c("TERM DATE", "TERM REASON")
# 
# original_df[[2]] <- tibble(table_name = "prob_df", original_field = original_field, modified_field = names(prob_df))


# prob_df <- prob_df %>%
#   filter(grepl("^[0-9]", charge))

# prob_df$book_date <- as_date(as.integer(prob_df$book_date), origin = "1899-12-30")
# prob_df[prob_df$book_date < as_date("2015-01-01"), ]
# 8 individuals reported with 2018 data who appear to have dob in place of book date
# (no dob column but there is an "age")
# prob_df$release_date <- as_date(as.integer(prob_df$release_date), origin = "1899-12-30")
# prob_df$termination_date <- as_date(as.integer(prob_df$termination_date), origin = "1899-12-30")

# Factor Standardization
# prob_df <- prob_df %>%
#   mutate(sex = case_when(sex_original %in% c("F") ~ "Female",
#                          sex_original %in% c("M") ~ "Male",
#                          T ~ "Other_Unknown"),
#          charge_level = case_when(charge_level_original %in% c("F", "FELONY") ~ "F",
#                                   charge_level_original %in% c("M") ~ "M",
#                                   charge_level_original %in% c() ~ "I",
#                                   charge_level_original %in% c("F/M") ~ "Other"),
#          risk_level = case_when(risk_level_original %in% c("LOW") ~ "Low",
#                                 risk_level_original %in% c("MOD") ~ "Medium",
#                                 risk_level_original %in% c("HIGH") ~ "High",
#                                 risk_level_original %in% c("N/A") | is.na(risk_level_original) ~ "Unknown"),
#          release_recommendation = case_when(release_recommendation_original %in% c("YES",
#                                                                                    "YES (ORAL REC)",
#                                                                                    "YES (VIA EMAIL)",
#                                                                                    "YES BY REPORT",
#                                                                                    "YES VERBAL IN COURT",
#                                                                                    "GRANTED",
#                                                                                    "VERBAL IN COURT") ~ "OR",
#                                             release_recommendation_original %in% c("DENIED",
#                                                                                    "DENIED RELEASE",
#                                                                                    "NO") ~ "Detain",
#                                             release_recommendation_original %in% c("RELEASE WITH EM") ~ "Monitor",
#                                             prob_df$release_recommendation_original %in% c("BAILED OUT",
#                                                                                    "NO (DIRECT SENTENCE)",
#                                                                                    "NO (OUT OF CUSTODY)") ~ "Other"),
#          release_decision = case_when(release_decision_original %in% c("GRANTED",
#                                                                        "PLACED ON PT (not in custody)") ~ "OR",
#                                       release_decision_original %in% c("DENIED",
#                                                                        "DENIED (POSTED BOND)") ~ "No_Program",
#                                       release_decision_original %in% c("RELEASE WITH EM",
#                                                                        "WITH EM") ~ "Monitor",
#                                       release_decision_original %in% c("PROVIDE PROOF OF SELF HELPS") |
#                                         is.na(release_decision_original) ~ "Other"),
#          pretrial_conditions = case_when(gps_flag %in% c("YES") ~ "EM",
#                                          or_condition_flag %in% c("YES") ~ "Other", 
#                                          T ~ "None"))

         
# charge_original data combination of charge and charge code (and occasionally charge level), not something we are dealing with now
# are these conditions flags recommendations or actual conditions?
         
# table(prob_df$gps_flag, useNA = "ifany")      
# [is.na(prob_df$release_recommendation)]
# table(prob_df[c("release_decision_original", "or_condition_flag", "or_flag")], useNA = "ifany") 
# prob_df[c("or_condition_flag", "gps_flag")]
# names(prob_df)         
# table(prob_df$pretrial_conditions, useNA = "ifany")
# unique(prob_df$gps_flag)
# 
# release_decision
# pretrial_level
# None # Low # Medium # High
# 
# pretrial_service # Phone_Call  # Other # None
# 
# release_authorization # Sheriff # Judge  # NA


# original probation data names are spread across multiple rows in submitted data
# still need to decide how to name these for the code book
# still need to decide what to do with individual assessment items data received
#   -no way to link to other data currently (only 28 digit hexadecimal ID no. provided)
#   -how to incorporate assessment item data into prob_df? one col per item or per response?

# tool_resp_working <- read.csv("Historical Data Submissions/Nevada/Pretrial.SQL.Historic.Nevada.csv", header = F, fill= T, as.is = T,
#                               na.strings = "", fileEncoding = "UTF-8-BOM",
#                               col.names = c("assessment_id", "assessment_item", "assessment_response", "assessment_response_secondary"))
# 
# tool_resp_working$assessment_item[tool_resp_working$assessment_item == "Age at first arrest"] <- "Age at First Arrest"
# 
# tool_resp_working$assessment_item[tool_resp_working$assessment_item == "Illegal Drug Use during Past Six Months"] <- "Illegal Drug Use During Past Six Months"
# 
# tool_response <- spread(tool_resp_working[tool_resp_working$assessment_item != "Other Areas of Concern", 1:3], key = assessment_item, 
#                         value = assessment_response)

# table(tool_resp_working[c("assessment_item", "assessment_response_secondary")], useNA = "ifany")

# tool_response$employment_status <- 
#   sapply(tool_response$assessment_id,
#          function(x) {
#            tool_resp_working$assessment_response_secondary[tool_resp_working$assessment_id == x &
#                                                              tool_resp_working$assessment_item == "Employed at the Time of Arrest"]
#          }) 
# 
# tool_response$other_count <-
#   sapply(tool_response$assessment_id,
#          function(x) {
#            length(which(tool_resp_working$assessment_id == x &
#                           tool_resp_working$assessment_item == "Other Areas of Concern"))
#          })
# 
# table(tool_response$other_count)
# 
# tool_response$other_areas_1[tool_response$other_count > 0] <-
#   sapply(tool_response$assessment_id[tool_response$other_count > 0],
#          function(x) {
#            tool_resp_working$assessment_response[tool_resp_working$assessment_id == x &
#                                                    tool_resp_working$assessment_item == "Other Areas of Concern"][1]
#          })
# 
# tool_response$other_areas_2[tool_response$other_count > 1] <-
#   sapply(tool_response$assessment_id[tool_response$other_count > 1],
#          function(x) {
#            tool_resp_working$assessment_response[tool_resp_working$assessment_id == x &
#                                                    tool_resp_working$assessment_item == "Other Areas of Concern"][2]
#          })
# 
# tool_response$other_areas_3[tool_response$other_count > 2] <-
#   sapply(tool_response$assessment_id[tool_response$other_count > 2],
#          function(x) {
#            tool_resp_working$assessment_response[tool_resp_working$assessment_id == x &
#                                                    tool_resp_working$assessment_item == "Other Areas of Concern"][3]
#          })
# 
# summary(tool_response)

# no matching ID to prob_df table, no assessment dates
# 271 assessments but only 57 rows in main prob_df table
# all assessment IDs have at least one "Other Areas of Concern", mostly "Other" (251)
```





Code Book
```{r eval=FALSE, include=FALSE}
rm(original_field)
original_df <- bind_rows(original_df)
Nevada_df <- lapply(ls()[!grepl("original", ls())], function(i){
  df <- get(i)
  
  if(sum(grepl("date", names(df))) > 0){
  df2 <- df %>%
  select(contains("date"), -contains("time")) %>%
  gather("modified_field", "value") %>%
  group_by(modified_field) %>%
  summarise_all(funs(min = as.character(min(., na.rm = T)), mean = as.character(mean(., na.rm = T)), max = as.character(max(., na.rm = T))))
  }else{
    df2 <- tibble(modified_field = NA_character_, min = NA_character_, mean = NA_character_, max = NA_character_)
  }
  
  df <- df %>%
    mutate_if(~length(unique(.)) > 50|is.Date(.)|is.POSIXct(.), ~(. = "not_factor")) %>%    
    mutate_all(~if_else(is.na(.), "na_missing", as.character(.))) %>%
    gather(modified_field, factor_value) %>%
    count(modified_field, factor_value) %>%
    mutate(table_name = i, county = "Nevada") %>%
    mutate(factor_flag = if_else(factor_value == "not_factor", 0, 1)) %>%
    group_by(table_name, modified_field) %>%
    mutate(table_count = sum(n)) %>%
    ungroup() %>%
    rename("factor_count" = "n") %>%
    mutate(factor_count = if_else(factor_value == "not_factor", NA_integer_, factor_count),
           factor_percent = round(factor_count/table_count*100, 1)) %>%
    arrange(desc(factor_flag), modified_field, desc(factor_count))
  
  df <- left_join(df, df2, by = "modified_field")
    }) %>% 
  bind_rows() %>%
  left_join(original_df) %>%
   select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_count,
           factor_percent, table_count, min, mean, max) 
write.xlsx(Nevada_df, file = "Code Books/Nevada Code Book.xlsx")



DOJ CII/Linking Extraction
```{r}
# Grab Tables with CII
df <- sapply(ls()[which(sapply(ls(), function(i){
  sum(names(get(i)) %in% "cii")
}) == 1)], get)

# Pull CII and other identifiers
doj_book <- df[[1]] %>%
  select(cii, fbi, name, dob, cdl_id, race_original, sex_original) %>%
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) 


doj_court <- df[[2]] %>%
  select(cii, fbi, dob, race_original, sex_original, first_name, middle_name, last_name, suffix, local_id) %>%
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) 



# Examine missing ciis and duplicates on cii. 
# doj_book %>% #Off by about 55,000
#   distinct()
# 
# doj_book %>% 
#   distinct(cii)
# 
# doj_book %>% 
#   distinct() %>%
#   add_count(cii) %>%
#   filter(n > 1) %>%
#   arrange(desc(n)) %>% 
#   View()
# 
# doj_court %>% #Off by about 45,000
#   distinct()
# 
# doj_court %>% 
#   distinct(cii)
# 
# doj_court %>% 
#   distinct() %>%
#   add_count(cii) %>%
#   filter(n > 1) %>%
#   arrange(desc(n)) %>% 
#   View()
# 
# 
# doj_book %>% # Off by about 7,000
#   distinct()
# 
# doj_book %>% 
#   distinct(cii)

# doj_book %>% 
#   distinct() %>%
#   add_count(cii) %>%
#   filter(n > 1) %>%
#   arrange(desc(n)) %>% 
#   View()
# 
# doj_court %>% #Off by about 9,000
#   distinct()
# 
# doj_court %>% 
#   distinct(cii)
# 
# doj_court %>% 
#   distinct() %>%
#   add_count(cii) %>%
#   filter(n > 1) %>%
#   arrange(desc(n)) %>% 
#   View()

#CIIs for DOJ
doj_cii <- bind_rows(doj_book %>% select(cii), doj_court %>% select(cii)) %>% distinct()

doj_court <- doj_court %>%
  mutate_if(is.character, funs(trimws(gsub("[^[:alnum:]]", "", .)))) %>%
  mutate_if(is.character, funs(if_else(. == "", NA_character_, .))) 

#Create an excel workbook with all data table. Make sure to include the cii table first. 
write.xlsx(list(doj_cii, doj_book, doj_court), file = "CIIs for DOJ/Nevada CIIs and Demographics for DOJ.xlsx", sheetName = c("ciis", "booking", "court"))
```

Compile Codebook Notes
```{r}
files <- list.files("G:/CrimJustice/PretrialAssessmentPilot/Code Books/Code Book Notes", pattern = "Nevada", full.names = T)
df <- lapply(files, read_excel)


df[[3]] <- full_join(df[[1]], df[[2]]) %>%
  mutate(factor_standard = "") %>%
  select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_standard, factor_count, factor_percent, 
         table_count, "st_notes" = Notes, "nl_notes_2" = factor_collapse, "nl_notes_1" = notes, min, mean, max, )

df <- list(df[[3]], df[[1]], df[[2]])

write.xlsx(df, file = "G:/CrimJustice/PretrialAssessmentPilot/Code Books/Variable Construction/Nevada Factor Construction.xlsx", asTable = T, tableStyle = "TableStyleMedium1", sheetName = c("Variable Construction", "st_notes", "nl_notes"))
```

Create Factor Codebook
```{r}

factor_df <- lapply(ls()[!grepl("original|^df|hier", ls())], function(i){
  df <- get(i)
  if(sum(grepl("original", names(df))) == 0){
    return(NULL)
  }else{
    var_names <- names(df)[grepl("original", names(df))]
    var_names2 <- gsub("_original", "", var_names)
   
    df1 <- df %>%
     select(var_names) %>%
     gather(original_field, original_value)
   
    df2 <- df %>%
     select(var_names2) %>%
     gather(modified_field, modified_value)
   
   df <- bind_cols(df1, df2) %>%
     count(original_field, modified_field, original_value, modified_value) %>%
     arrange(modified_field, desc(n)) %>%
     group_by(modified_field) %>%
     mutate(row = row_number(),
            percent = round(n/sum(n)*100)) %>%
     ungroup() %>%
     filter(row <= 50) %>%
     select(-row) %>%
     rename("total" = n)
   }
  }) %>%
  bind_rows()

write.xlsx(factor_df, file = "G:/CrimJustice/PretrialAssessmentPilot/Code Books/Factor Code Book/Nevada Factor Code Book.xlsx", asTable = T, tableStyle = "TableStyleMedium1", colWidths = "auto")
```
 Joining All Data Post-Collapse
 Jail Court Join
```{r}
# Remove extraneous objects in the environment
rm(list = ls()[!ls() %in% ls(pattern = "df")])

#Check for common variables
#names(book_df)[names(book_df) %in% names(assess_df)] no assessment data yet

names(book_df)[names(book_df) %in% names(court_df2)]



#Turning NULL to NA to ensure non matching and removing generic charge info from data frames
book_df <- book_df %>%
  mutate_if(is.character, list(~na_if(., "NULL"))) %>%
  select(-c(charge, charge_level, charge_code)) %>%
  mutate_at(vars(first_name, last_name), toupper)

#assess_df <- assess_df %>%
 # mutate_if(is.character, list(~na_if(., "(Missing)"))) %>%
  #select(-c(id, court))

court_df2 <- court_df2 %>%
  mutate_if(is.character, list(~na_if(., "NULL"))) %>%
  select(-c(charge, charge_level, charge_code)) %>%
  mutate_at(vars(first_name, last_name), toupper) %>%
  mutate(court_case_id = as.character(court_case_id))

#Joining Assessment to Jail Data
join1 <- inner_join(book_df, assess_df, by = "book_num", na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x$", "", .))) %>%
  select(-contains(".y")) %>%
  #1 Duplicate with missing dispositions which will be dropped later. 
  distinct()

j1 <- anti_join(book_df, assess_df, by = "book_num", na_matches = "never")
a1 <- anti_join(assess_df, book_df, by = "book_num", na_matches = "never")


  #Examine if set of common variables is distinct--yes
  semi_join(book_df, assess_df, by = "book_num", na_matches = "never") %>%
    distinct()

#Joining on Name and Court ID
join2 <- inner_join(j1, a1, by = c("first_name", "last_name", "book_date" = "interview_date"), 
                    na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x$", "", .))) %>%
  select(-contains(".y")) %>%
  #1 Duplicate with missing dispositions which will be dropped later. 
  distinct()

j2 <- anti_join(j1, a1, by = c("first_name", "last_name", "book_date" = "interview_date"), na_matches = "never")
a2 <- anti_join(a1, j1, by = c("first_name", "last_name", "interview_date" = "book_date"), na_matches = "never")

  #Examine if set of common variables is distinct--yes
  semi_join(j1, a1, by = c("first_name", "last_name", "book_date" = "interview_date"), 
            na_matches = "never") %>%
    distinct()
  
#Diagnostics
  #Jail and Assessment Matches by category
tibble(
  stage = 1:2,
  match = c(
    'c("book_num")',
    'c("first_name", "last_name", "book_date" = "interview_date")'
  ),
  # jail_match_rate = sapply(1:2, function(i) {
  #   (nrow(book_df) - nrow(get(paste0("j", i)))) / nrow(book_df) * 100
  # }),
  assess_match_rate = sapply(1:2, function(i) {
    (nrow(assess_df) - nrow(get(paste0("a", i)))) / nrow(assess_df) * 100
  })
)

#Recreating Booking--Should be same number of rows.
book_df <- bind_rows(join1, join2, j2)  

rm(list = ls()[!ls() %in% ls(pattern = "df")])

#scratch

court_df2 %>%
 ls()
   
book_df %>%
  ls()


 join1 %>%
  select(contains(".x")) %>%
  names() %>%
  sort()

join1 %>%
  select(contains("arrest_")) %>%
  names() %>%
  sort()

names(book_df)[names(book_df) %in% names(court_df2)]

names(join1)[grepl("\\.x", names(join1)) & paste0("arrest_", gsub("\\.x$", "", names(join1))) %in% names(join1)]


names(join1)[grepl("\\.y", names(join1)) & paste0("court_", gsub("\\.y$", "", names(join1))) %in% names(join1)]
#end of scratch


# Court Matching
#Joining on cdl_id
join1 <- inner_join(book_df, court_df2, by = c("first_name", "last_name"), na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(paste0("arrest_", gsub("\\.x$", "", .)))) %>%
  rename_at(vars(contains(".y")), funs(paste0("court_", gsub("\\.y$", "", .)))) %>%
  # 8 Duplicates with missing dispositions which will be dropped later. 
  distinct()

j1 <- anti_join(book_df, court_df2, by = c("first_name", "last_name"), na_matches = "never")
c1 <- anti_join(court_df2, book_df, by = c("first_name", "last_name"), na_matches = "never")



  #Examine if set of common variables is distinct--yes except 8 spurious cases.
  join1 %>%
    select(-contains("flag")) %>%
    add_count("cdl_id") %>%
    filter(n > 1) %>%
    arrange(desc(n))

     

#Joining on Name and Court ID
join2 <- inner_join(j1, c1, by = c("court_case_id"), na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(paste0("arrest_", gsub("\\.x$", "", .)))) %>%
  rename_at(vars(contains(".y")), funs(paste0("court_", gsub("\\.y$", "", .)))) %>%
  #1 Duplicate with missing dispositions which will be dropped later. 
  distinct()

j2 <- anti_join(j1, c1, by = c("court_case_id"), na_matches = "never")
c2 <- anti_join(c1, j1, by = c("court_case_id"), na_matches = "never")

  #Examine if set of common variables is distinct--yes except 8 spurious cases.
  join2 %>%
     select(-contains("flag")) %>%
    add_count("court_case_id") %>%
    filter(n > 1) %>%
    arrange(desc(n))

#Joining on Court ID
join3 <- inner_join(j2, c2, by = c("fbi"), na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(paste0("arrest_", gsub("\\.x$", "", .)))) %>%
  rename_at(vars(contains(".y")), funs(paste0("court_", gsub("\\.y$", "", .)))) %>%
  #1 Duplicate with missing dispositions which will be dropped later. 
  distinct()

j3 <- anti_join(j2, c2, by = c("fbi"), na_matches = "never")
c3 <- anti_join(c2, j2, by = c("fbi"), na_matches = "never")

  #Examine if set of common variables is distinct--yes except 8 spurious cases.
  join3 %>%
    add_count ("fbi") %>%
    filter(n > 1) %>%
    arrange(desc(n))
  
#Diagnostics
  #Jail and Court Matches by category
tibble(
  stage = 1:3,
  match = c(
    'c("first_name", "last_name")',
    'c("court_case_id")',
    'c("fbi")'
  ),
  jail_match_rate = sapply(1:3, function(i) {
    (nrow(book_df) - nrow(get(paste0("j", i)))) / nrow(book_df) * 100
  }),
  court_match_rate = sapply(1:3, function(i) {
    (nrow(court_df2) - nrow(get(paste0("c", i)))) / nrow(court_df2) * 100
  })
)

join_df <- bind_rows(join1, join2, join3)
```







# San Mateo
San Mateo Jail Data
```{r eval=FALSE, include=FALSE}

# Jail Bookings Data Import--- San Mateo, 2015-01-01 to 06-30-2020
  ## book_df contains one row per booking/charge and includes information on the person, the time of booking and release,contains charge information, bail amount.
  ## book_num has suffix (.1, .2,...)
  ## 
 
####

# Booking Data
  ## book_df contains one row per booking/charge and includes information on the person as well as the time of booking and release. 

#This is old code from when they did not filter on both bookings and releases during the time periodS
book_df <- fread("Historical Data Submissions/San Mateo/41-SO-01OF01-JAN2015-JUN2019.csv", colClasses = "text")
book_df2 <- fread("Historical Data Submissions/San Mateo/41-SO-01OF02-JUL2019-SEPT2019.csv", colClasses = "text", header = F)
book_df3 <- fread("Historical Data Submissions/San Mateo/41-SO-01OF01-OCT2019-DEC2019.csv", colClasses = "text", header = F)
book_df4 <- fread("Historical Data Submissions/San Mateo/P2 Submission-June 30/41-SO-01OF01-JAN2020-JUN2020.csv", colClasses = "text", header = F)

names(book_df2) <- names(book_df)
names(book_df3)<- names(book_df)
names(book_df4)<- names(book_df)

book_df <- bind_rows(book_df, book_df2, book_df3, book_df4)

rm(book_df2, book_df3, book_df4)

####

#San Mateo Jail Data Import
 ## submitted 8/7/2020 to make sure file includes people who where booked or relased from Jan 2015-June 30, 2020
 ## file did not include column names, I used the same names statemetn from the old files to check if the order was the same and it is

book_df <- read_csv("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/San Mateo/P2 Submission-June 30/41-SO-01OF01-JAN2015-JUN2020.csv", col_names = F, col_types = cols( X1= "c", .default="?"))

# Variable name standardization--See pg. xxx for more details. 
  ##  cdl_id_2 is actually a partially empty, partial duplicate of cdl_id
  ## book_date range Jan 1, 2015-June 30, 2020
  ## release_date range Jan 1, 2015-June 30, 2020
names(book_df) <- c("cii", "name", "dob", "fbi", "cdl_id_2", "cdl_id", "sex_original", "race_original", "arrest_date_time", "book_num", "book_date_time", "book_type_original", "court_case_id", "arrest_charge_original", "arrest_charge_level_original", "release_date_time", "release_type_original", "bail_amt", "conviction_date", "conviction_charge", "employment_status")


# Date Reformatting (also name and CII reformat)--See pg. xxx for more details.
  ## 8 rows arrest dates 1900-01-01 00:00
  ## 4 rows arrest dates 1919 when probably should be 2019
book_df <- book_df %>%
  select(-c(conviction_date, conviction_charge, employment_status)) %>%
   mutate(arrest_date = as_date(arrest_date_time),
         book_date = as_date(book_date_time),
         release_date = as_date(release_date_time),
         dob = mdy(dob),
         name2 = str_sub(name, end=-2),
         first_name = gsub(".*, ", "", name2),
         last_name= gsub("(?=,).*$", "", name2, perl=TRUE)) %>%
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, (cii)),
         cdl_id = gsub("NONE|NONE ISSUED", "", cdl_id)) 

   
# Standardize Factors
  ## No employment data provided
book_df <- book_df %>%
  mutate(sex = case_when(sex_original %in% c("U", "") ~ "Other_Unknown",
                         sex_original %in% c("M") ~ "Male",
                         sex_original %in% c("F") ~ "Female"),

         race = case_when(race_original %in% c("B") ~ "Black",
                          race_original %in% c("H") ~ "Hispanic",
                          race_original %in% c("W") ~ "White",
                          T ~ "Other_Unknown"), 
         
         book_type = case_when(book_type_original %in% c("LOCAL WARRANT") ~ "Bench_Warrant",
                               book_type_original %in% c("COMMITMENT") ~ "Commitment",
                               book_type_original %in% c("FOREIGN HOLD - STATE SENTENCED", "FOREIGN HOLD - COMMITMENT",
                                                         "FOREIGN HOLD - DETAINER", "FOREIGN HOLD - OTHER", "FOREIGN HOLD - PAROLE", 
                                                         "FOREIGN HOLD - IMMIGRATION" ) ~ "Hold",
                               book_type_original %in% c("FOREIGN WARRANT") ~ "Other_Warrant",
                               book_type_original %in% c("REMAND") ~ "Remand",
                               book_type_original %in% c("OPEN CHARGES") ~ "Street",
                               book_type_original %in% c("PROBATION HOLD 1203.2", "PAROLE PC 3056", "PAROLE PC 3000.08", "PRCS REVOCATION PC 3455(a)", 
                                                          "MANDATORY SUPERVISION REVOCATION PC 1170(H)(5)(B)", 
                                                         "FLASH INCARCERATION PC 3454(b)") ~ "Sup_Vio"),

         release_type = case_when(release_type_original %in% c("PROMISE TO APPEAR","LAW ENFORCEMENT RELEASE") ~ "Cite_Release",
                                  release_type_original %in% c("TIME SERVED") ~ "Time_Served",
                                  release_type_original %in% c("SURETY BOND POSTED", "CHECK BAIL", "CASH BAIL POSTED") ~ "Bail_Bond",
                                  release_type_original %in% c("CASE DISMISSED") ~ "Dismissed_Dropped",
                                  release_type_original %in% c("OWN-RECOGNIZANCE") ~ "OR",
                                  release_type_original %in% c("COURT ORDERED RELEASE") ~ "Court_Order",
                                  release_type_original %in% c("") ~ "Unknown",
                                  release_type_original %in% c("RELEASE TO OTHER AGENCY", "RELEASED TO OTHER AGENCY", 
                                                               "SENTENCED TO CDCR") ~ "Hold_Released", T ~ "Other"))
  


# Standardize Charges, Join Hierarchy and flag construction
 ## some charges separated by slash /
 ## some charges end in "2ND" or "1ST"
 ## "30600  ENHANCEMENT " 8 rows
 ## most end in code: PC, VC, HS, BP, WI, CP, IC, MC, SC, 
book_df <- book_df %>%
  mutate(arrest_charge_code = gsub(".* ", "", arrest_charge_original),
         arrest_charge_code = if_else(arrest_charge_code=="USC", "US", arrest_charge_code),
         arrest_charge_code = if_else(!arrest_charge_code %in% c("PC", "VC", "HS", "BP", "WI", "US"), "Other", arrest_charge_code),
         arrest_charge_level = if_else(!arrest_charge_level_original %in% c("F", "I", "M"), "Other", arrest_charge_level_original),
         arrest_charge = gsub(">.*| .*|MISD|FEL|-FEL|INF" , "", arrest_charge_original),
         arrest_attempt_flag = if_else(grepl("664", arrest_charge_original), 1, 0),
         arrest_charge = gsub("664/", "", arrest_charge)) %>%
         separate_rows(arrest_charge, sep = "/") %>%
         mutate(arrest_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\-.*","", arrest_charge))) %>%
  unite(join_var, arrest_charge_level, arrest_charge_code, arrest_charge, remove = F)

  
# Code for Charge Hierarchy
load("Complete Charge Code Hierarchy.RData")

#remove these flags becasue they are messing up the final join of court and jail data
charge_hier <- charge_hier %>%
  select (-c(fta_flag))


book_df <- left_join(book_df, charge_hier, by = "join_var")
  
book_df<- book_df %>%
    mutate(arrest_misd_flag=if_else(arrest_charge_level=="M", 1, 0),
           arrest_felony_flag =if_else(arrest_charge_level=="F", 1, 0),
           arrest_attempt_flag=if_else(arrest_charge=="664", 1, arrest_attempt_flag),
           # not seeing any qualifier charges here  arrest_qualifier_flag=if_else()
           sup_vio_post_flag=if_else(book_type=="Sup_Vio", 1, 0),
           fta_flag=if_else(arrest_charge%in% c("8537", "1320A", "1320B", "13205", "40508A"), 1, 0))  


Jail Collapse

# Booking Collapse--See pg. xxx for more details about this process. 
 ## No join step needed becasue there is only 1 booking table
 ## Grouped by book_num rather than (book_num and book_date) otherwise some court case ID's would be lost
 ## ungroup not in Noah's code, what does it do, does it matter

book_df <- book_df %>%
  mutate(time_first_release = release_date_time - book_date_time) %>%
  mutate(hierarchy = if_else(is.na(hierarchy), 1e6, as.numeric(hierarchy))) %>%
  group_by(book_num) %>%
  mutate(max_booktype = book_type[hierarchy == min(hierarchy)][1],
        max_arrest_charge = arrest_charge[hierarchy == min(hierarchy)][1],
         max_charge_description = master_charge_description[hierarchy == min(hierarchy)][1],
         max_hier = min(hierarchy)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, .))) %>%
  mutate_at(vars(contains("flag")), funs("count" = sum(.))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  group_by(book_num, court_case_id) %>%
  filter(hierarchy == min(hierarchy)) %>%
  ungroup() %>%
  distinct(book_num, court_case_id, .keep_all = T)

San Mateo Jail Diagnostics


# Jail Diagnostics

##Period 2 jail diagnostics
summary(book_df$book_date)     
str(book_df)
lapply(book_df, function(i){if(length(unique(i)) <= 50) table (i, useNA="always")})



book_df %>%
  distinct(book_num, court_case_id) %>%
  arrange(book_num) %>%
  group_by(book_num) %>%
  add_count() %>%
  filter(n>1)

book_df %>%
  distinct(book_num, book_date) 
book_df %>%
  filter(grepl("0771037", book_num))

book_df %>%
  distinct()%>%
  arrange (book_num)

book_df %>%  
 filter(grepl("0709937", book_num))

# book_num_gs distinct=84,681
test <- book_df %>%
  mutate(book_num_gs = gsub("\\.[0-9]*", "" , book_num )) 

# book_num, book_date  distinct=84,681
test %>%
  distinct(book_num, book_date) %>%
  arrange(book_num)

# sort(table(substr(book_df$arrest_charge_original[grep("[A-Z]{2}$", book_df$arrest_charge_original)], 
#                   nchar(book_df$arrest_charge_original[grep("[A-Z]{2}$", book_df$arrest_charge_original)]) - 1, 
#                   nchar(book_df$arrest_charge_original[grep("[A-Z]{2}$", book_df$arrest_charge_original)]))), decreasing = TRUE)
# 
# sort(table(book_df$arrest_charge_original[grep("[A-Z]{2}$", book_df$arrest_charge_original)]), decreasing = TRUE)

book_df %>%
  count(arrest_charge_level_original)

book_df %>%
  filter(grepl("/", arrest_charge_original)) %>%
  count(arrest_charge) %>%
  arrange(desc(n))

book_df %>%
  filter(grepl)
  count(arrest_charge_original) %>%
  arrange(desc(n))

 # filter(attempt==1)%>%
 
# count(arrest_charge)
  
  
  mutate(attempt = if_else(grepl("^664\\/", arrest_charge_original), 1, 0)) %>%
  separate_rows(arrest_charge_original, sep = "\\\\|\\/") %>%
  mutate(
    # arrest_charge_code_original = paste0(strapplyc(charge_original, "^([A-Z]{2}).*", simplify = T)),
         # code_type = ifelse(code_type == "character(0)", NA, code_type),
         # code_type = na.locf(code_type),
         arrest_charge_level = str_extract(arrest_charge_level_original, "^(.).*"),
         # #Collapsing charge in this way does not result in any mismatched charges
         arrest_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\}","", arrest_charge_original)))
         # cii = as.numeric(gsub("[^0-9]", "", cii)),
         # conspire = if_else(grepl("^CONSPIRE", charge_description), 1, 0))
  
# No code section in these data
#book_df$arrest_charge_code <- NA

# Code to check results of above:
#
table(book_df$arrest_charge)[order(table(book_df$arrest_charge), decreasing = T)]
# 
# 
# table(grep("\\/", book_df$arrest_charge_original, value = TRUE))
# 
# table(book_df$arrest_charge_level_original)
# 
# table(book_df$arrest_charge_original)[order(table(book_charge$arrest_charge_original), decreasing = T)]
# 
# book_df %>%
#   count(arrest_charge_original, arrest_charge) %>%
#   group_by(arrest_charge_original) %>%
#   add_count() %>%
#   filter(n > 1)
# 
# book_df$aco_count <- sapply(book_df$arrest_charge_original, function(x) length(which(book_df$arrest_charge_original == x)))
# book_df$ac_count <- sapply(book_df$arrest_charge, function(x) length(which(book_df$arrest_charge == x)))
# book_df$ac_counts_match <- book_df$aco_count == book_df$ac_count
# table(book_df$ac_counts_match, useNA = "ifany")
# 
# book_df[!(book_df$ac_counts_match), 
#         c("book_num", "arrest_charge_level_original", "arrest_charge_original", "arrest_charge", "attempt", 
#           "aco_count", "ac_count")][order(book_df$arrest_charge[!(book_df$ac_counts_match)]), ]


df <- tibble(x = 1:5, y = c("a,b,c", "F", "H, I, J", "L", "V"))

df %>%
  separate_rows(y, sep = ",")

# Diagnostic Code for Charge Hierarchy
# 1 - 7,901/267,372 = 97% non-match rate
(1 - nrow(book_df %>% filter(is.na(hierarchy)))/nrow(book_df))*100

book_df %>%
  filter(is.na(hierarchy)) %>%
  count(join_var) %>%
  arrange(desc(n))

# the most common unmatching code is Other_Other_  which is almost all foreign warrants, foreign_holds committments, and F_PC_13892 it is a #foregin hold detainer, F_PC_3454B is flash incarceration, F_PC_120221 allways has an enhancement in the orginal arrest charge.
# M_VC_23578 this code says if a person is convicted of a violation of Section 23152 or 23153 and refuses breathalyzer or has BAC >.15 it is #a special factor for imposting penalties

book_df%>%
  filter(grepl("0771037", book_num))%>%
  group_by(book_type_original)%>%
  count()
```


San Mateo Court Data
```{r eval=FALSE, include=FALSE}


# Court Case Data Import--- San Mateo, 1/4/2016  to 12/31/19
  ## court_df contains multiple rows per court case, one for a complaint/indictment and another if there is an information. It includes information on the person.
  ## the letters at the end of the case number indicate co-defendants (eg -A and -B for co-defendants)
  ## Only felonies have an HTA associated with them.  If at the prelim or before the defendant admits or pleads NOLO the disposition            will show certified up but no HTA case is created.  The case starts out like 16-NF-000086-A  when the matter is held to answer that        original case gets the HTA added and a new case is created when the information is filed with the same number as it started out minus      the HTA. (st...I think this means we strip off HTA and sort by  date, casaes start with complaints or indictments)
  ## court_sentence data  contains case type, case case status, charges, pleas and sentence information. 
  ## court_hearing data contains files date, case_type, hearing dates and types, hearing results and fta, and fta warrants
    

####

# Court Cases
court_df <- lapply(c("Historical Data Submissions/San Mateo/41-COURT-01OF03-JAN2016-SEP2019.csv", 
                    "Historical Data Submissions/San Mateo/41-COURT-01OF03-OCT2019-DEC2019.csv",
                    "Historical Data Submissions/San Mateo/P2 Submission-June 30/41-COURT-01OF03-JAN2020-JUN2020.csv"), 
                                     function(x) {
                    fread(x, na.strings=c("NULL",""), colClasses = "character")
                  }) %>%
  bind_rows() %>%
  distinct()


# Variable name standardization--See pg. xxx for more details. 
names(court_df) <- c("court_docket_id", "court_case_id_original", "file_date", "court_case_type", "court_party_id", "cii", "fbi", "local_id", 
                     "cdl_id", "name", "dob", "sex_original", "race_original")

# Date Reformatting--See pg. xxx for more details.
court_df <- court_df %>%
     mutate(dob = as_date(dob)) %>%
     mutate(file_date = ymd(file_date))




# Standardize Factors, also standardize CII and name formatting--See pg. xxx for more details.
court_df <- court_df %>%
     ## remove -HTA from court_case_id_original so that information and complaint will have the same court_case_id since they are the same case at different stages
   mutate(court_case_id = gsub("-HTA", "", court_case_id_original)) %>%
    mutate(cii = as.character(cii)) %>%
    mutate(sex = case_when(sex_original %in% c("M") ~ "Male",
                         sex_original %in% c("F") ~ "Female",
                         T~"Other_Unknown"),
         race = case_when(race_original %in% c("Black") ~ "Black",
                          race_original %in% c("Hispanic") ~ "Hispanic",
                          race_original %in% c("White") ~ "White",
                          T ~ "Other_Unknown"),
        name = toupper(name)) %>% 
        separate(name, c("last_name", "first_name", "suffix"),  sep = ",") %>%
        mutate_at(vars(first_name, last_name, suffix), trimws) %>%
        separate(first_name, c("first_name", "middle_name"), sep = " ") %>%
        mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, (cii)))





####

# Court Sentences and Court Filing Charges 
 ## court sentence contains all of the court charge data
 ## court_sentence contains one row per charge (charge_id) (with about 400 repeats, assumedly from when separate_rows was used to divide combined charges, for example PC484-490.1)
 ## dropping sentence location, it was in the first extract, but not in second extract, we dont need that variable for analysis
 ## historical data submitted had to be stripped of new line characters in the middle of lines that interfered with reading the data in


court_charge <- read_file("Historical Data Submissions/San Mateo/41-COURT-02OF03-JAN2016-SEP2019.csv")

court_charge <- gsub("\n,", ",", court_charge)

court_charge <- read_csv(court_charge, col_types = "iccccccccciiiccccccccccc_ciiiciii", na = c("", "NULL")) 

court_charge_1 <- fread("Historical Data Submissions/San Mateo/41-COURT-02OF03-OCT2019-DEC2019.csv", na.strings=c("NULL",""))

court_charge_2 <- fread("Historical Data Submissions/San Mateo/P2 Submission-June 30/41-COURT-02OF03-JAN2020-JUN2020.csv", na.strings=c("NULL",""))


court_charge <- bind_rows(court_charge, court_charge_1, court_charge_2) %>% distinct()

rm(court_charge_1, court_charge_2)


# Variable name standardization--See pg. xxx for more details.
names(court_charge) <- c("court_docket_id", "court_case_id_original", "file_date", "court_case_type", "court_case_status_original", "court_case_status_date", "book_num", "arrest_date", "arrest_control", "arrest_agency", "offense_id", "charge_id", "charge_num", "offense_date", "court_charge_original", "court_charge_level_original", "court_charge_description", "plea_type_original", "plea_date", "disposition_type_original", "disposition_date", "final_date", "sentence_type_original", "sentence_date",  "probation_type", "term_years_probation", "term_months_probation", "term_days_probation", "jail_type", "term_years_jail", "term_months_jail", "term_days_jail")


# Date Reformatting--See pg. xxx for more details.
court_charge <- court_charge %>%
  mutate_at(vars(contains("date")), as_date)


# Standardize Factors--See pg. xxx for more details.
court_charge <- court_charge %>%
     ## remove -HTA from court_case_id_original so that information and complaint will have the same court_case_id since they are the same case at different stages
   mutate(court_case_id = gsub("-HTA", "", court_case_id_original)) %>%
  mutate(
    disposition_type = case_when(
      disposition_type_original %in% c(
        "Dismissal: Negotiated Plea",
        "Dismissal: Insufficient Evidence",
        "Dismissal: Interest of Justice",
        "Dismissal: Motion of the People",
        "Dismissal: Lack of Prosecution",
        "Dismissal",
        "No Finding",
        "Dismissal: Other Dismissal",
        "Dismissal: Insufficient Grounds to HTA",
        "Dismissal: After Drug Court",
        "Dismissal: Civil Compromise",
        "Dismissal: After Military Diversion",
        "Dismissal: No Reason Available",
        "Dismissal: PC1100 -Insufficient Evid. -Witness for Co-Defend",
        "Dismissal: PC995",
        "Dismissal: Prop 64",
        "Dismissal: PC1385 PC-Furtherance of Justice",
        "Dismissal: After Deferred Entry of Judgment",
        "Dismissal: Other Dismissal",
        "Dismissal: After Diversion",
        "Dismissal: PC1377/1378-Case Compromise/Rest of Satis. Made",
        "Dismissal: Post Sentence",
        "Dismissal: PC1381/1381.5/1382-Delay; Not Timely",
        "Dismissal: PC995-Accusation Set Aside",
        "Dismissal: PC871-Court Found Insufficient Cause",
        "Dismissal: 1203.4"
      ) ~ "Dismissed",
      
      disposition_type_original %in% c(
        "Pled Nolo Contendere",
        "Pled Nolo Contendere Lesser Included Offense"
      ) ~ "Nolo_Contendere",
      
      disposition_type_original %in% c(
        "Admitted",
        "Found True",
        "Pled Guilty",
        "Jury verdict of guilty",
        "Sentenced: Plea of Guilty/Nolo Contendere",
        "Court trial found guilty",
        "Found True",
        "Found Guilty",
        "Found Guilty Lesser Included Offense"
      ) ~ "Gulity",
      
      disposition_type_original %in% c(
        "DOJ - Found Not Guilty",
        "Denied",
        "Dismissal: Insufficient Grounds to HTA",
        "Jury verdict of not guilty",
        "Found Not True",
        "Court trial found not guilty"
      ) ~ "Not_Guilty",
      
      disposition_type_original %in% c(
        "Held to Answer",
        "Certified to Superior Court: PN859",
        "Stricken",
        "Held to Answer",
        "Certified to Superior Court",
        "Not Held to Answer",
        "No Finding",
        "Extradited",
        "Consolidated",
        "Veteran's Treatment/Military Diversion",
        "NULL",
        "Mistrial",
        "Certified to Juvenile Court",
        "Certified to Superior Court: PG859"
      ) ~ "Other"
    ),
    
    plea_type = case_when(
      plea_type_original %in% c("No Contest / Nolo Contendere") ~ "Nolo_Contendere",
      plea_type_original %in% c("Admit", "Guilty") ~ "Guilty",
      plea_type_original %in% c("Deny", "Not Guilty", "Not Guilty by Reason of Insanity") ~ "Not_Guilty",
      plea_type_original %in% c("NULL", "Once in Jeopardy", "Traffic School") ~ "Other"
    ),
    
    sentence_type = case_when(
      sentence_type_original %in% c("Prison Sentence") ~ "Prison",
      sentence_type_original %in% c(
        "Sentenced  PC1170(h) - Straight",
        "Mandatory Supervision Violation Sentence",
        "Probation Violation Sentence",
        "Sentenced PC1170(h) - Split"
      ) ~ "Jail",
      sentence_type_original %in% c("Probation Sentence", "Sentenced Prop 36") ~ "Probation",
      sentence_type_original %in% c(
        "Sentenced",
        "DIVERSION",
        "na_missing",
        "Sentence Modified",
        "Drug Court Sentence"
        ,
        "DUI Court Sentence"
      ) ~ "Other"
    ),
    
    court_case_status = case_when(
      court_case_status_original %in% c("Active") ~ "Active",
      court_case_status_original %in% c("Closed") ~ "Inactive"
    )
  )


# Charge Standardization can't add Flag her becasue flags are in court hearing table below--See pg. xxx for more details.
court_charge <- court_charge %>%
  mutate(court_charge_code = str_extract(court_charge_original, "^([A-Z]{2})"),
         court_charge_code = if_else(!court_charge_code %in% c("PC", "VC", "HS", "BP", "WI", "US"), "Other", court_charge_code),
         court_charge = gsub("^[A-Z]{2}|^[A-Z]{3}", "", court_charge_original ),
         court_charge_level = if_else(court_charge_level_original  %in% c("F1"), "F" , court_charge_level_original),
         court_charge_level = if_else(!court_charge_level %in% c("F", "I", "M"), "Other", court_charge_level),
         court_attempt_flag = if_else(grepl("664", court_charge_original), 1, 0),
         court_charge = gsub("664-|-[a-z]$", "", court_charge))%>%
         separate_rows(court_charge, sep = "-") %>%
         mutate(court_charge = toupper(gsub("\\/|\\(|\\)| |\\.|\\.*|^[A-Z]*|\\\\.*|\\{|\\-.*","", court_charge)))%>%
  unite(join_var, court_charge_level, court_charge_code, court_charge, remove = F) 



         
# Code for Charge Hierarchy and
#Flag Construction

load("Complete Charge Code Hierarchy.RData")

 court_charge <- left_join(court_charge, charge_hier, by = "join_var") %>%
  mutate(felony_flag = if_else(court_charge_level == "F", 1, 0),
         misd_flag = if_else(court_charge_level == "M", 1, 0)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, as.numeric(.)))) %>%
  mutate_at(vars(contains("flag")), funs("conviction" = if_else(. == 1 & disposition_type %in% c("Guilty", "Nolo_Contendere"), 1, 0))) %>%
  rename_at(vars(contains("flag"), -contains("conviction")), funs(paste0("court_", .))) %>%
  rename_at(vars(contains("conviction")), funs(paste0("conviction_", gsub("_conviction", "", .))))  

 
####
 
# Court Hearings
  ## court_hearing contains one row per setting_id (a unique hearing event on each court case) and includes information about each hearing. 
  ## still organized by court case type (complaint, indictment, information), which are given a different suffix on the court_case_id which will need to be stripped in order to collapse to the court case
  ## NOTE: between tables court_case_id is formatted differently, fix this (aka remove dashes) across all the san mateo tables so that they will match later
  ## historical data file has a variable called DtFile in a format that only reads with the as_date
 ## the next two date files have the date in a different format so needed to use mdy
   court_hearing <-
   fread("Historical Data Submissions/San Mateo/41-COURT-03OF03-JAN2016-SEP2019.csv") %>%
     mutate_at(vars(contains("date"), DtFile), as_date)
   
   
 court_hearing_1 <-
   fread( "Historical Data Submissions/San Mateo/41-COURT-03OF03-OCT2019-DEC2019.csv",  na.strings = c("NULL", "")) %>%
       mutate_at(vars(contains("date"), DtFile), mdy)
 
  court_hearing_2 <-
   fread( "Historical Data Submissions/San Mateo/P2 Submission-June 30/41-COURT-03OF03-JAN2020-JUN2020.csv",  na.strings = c("NULL","")) %>%
        mutate_at(vars(contains("date"), DtFile), mdy)

 court_hearing <-
   bind_rows(court_hearing, court_hearing_1, court_hearing_2) %>% distinct()
 
 rm(court_hearing_1, court_hearing_2)
 
 

 
 names(court_hearing) <-
   c( "court_docket_id", "court_case_id_original", "file_date", "court_case_type", "setting_id",  "hearing_date", "hearing_type_loc", "court_loc", "hearing_type_code", "hearing_type_original",
     "hearing_result",  "hearing_date_next",  "fta", "fta_warrant" )
 
 
 court_hearing <- court_hearing %>%
   ## remove -HTA from court_case_id_original so that information and complaint will have the same court_case_id since they are the same case at different stages
   mutate(court_case_id = gsub("-HTA", "", court_case_id_original)) %>%
   mutate(
     hearing_type = case_when(
       hearing_type_original %in% c(
         "Arraignment",
         "Arraignment on Information",
         "Warrant-Arraignment",
         "Domestic Violence Complaint Arraignment",
         "Further Arraignment",
         "Arraignment - Felony Fugitive",
         "Arraignment FTA",
         "Arraignment on Information after Preliminary Hearing",
         "Arraignment Parole Violation"
       ) ~ "Arraignment",
       hearing_type_original %in% c(
         "Sentencing",
         "Probation Report and Sentencing",
         "Sentence Hearing",
         "Prob Report and Sentencing - Proof of Firearm Relinquishment",
         "Proof of Firearm and Ammo Relinquishment and Sentencing",
         "Restitution Memo and Sentencing",
         "Sentencing on Violation of Probation",
         "Surrender for execution of sentence",
         "Probation Report and Sentencing (DUI)"
       ) ~ "Sentencing",
       hearing_type_original %in% c(
         "Jury Trial",
         "Pretrial Conference",
         "Warrant-Failed to Appear",
         "To Trail",
         "Jury Trail",
         "Preliminary Hearing",
         "To Set",
         "Warrant-Arraignment",
         "Warrant-Arraignment",
         "Warrant-Arraignment",
         "Warrant-Arraignment",
         "Attorney and Plea",
         "PC 1538.5 motion",
         "Domestic Violence Pretrial",
         "Further Proceedings",
         "Continued Jury Trial",
         "Motion to Continue Trial Date",
         "Motion hearings",
         "Motion to Continue",
         "Disposition and To Set",
         "Pathways Intake",
         "Further O.R. Report",
         "Disposition",
         "Bail Motion",
         "Drug Court Status Hearing - Predisposition",
         "Reset",
         "Order for Return of Prisoner",
         "Pretrial and To Set",
         "Penal Code section 995 motion",
         "Warrant - Failure to comply",
         "Diversion Violation Arraignment",
         "ID of Counsel",
         "Military Diversion Review",
         "Veteran Treatment Court Review",
         "Marsden motion",
         "Review",
         "Warrant-Probation Violation",
         "Civil Compromise",
         "Drug Court Decision on Suitability for Drug Court Diversion",
         "Diversion Violation Conference",
         "Probation Violation Conference",
         "Motion to Consolidate",
         "Proof of Drivers License",
         "Receipt of Doctors Report",
         "Bail Bond Motion",
         "Military Diversion Intake",
         "Modification of Sentence",
         "Motion to Dismiss",
         "AB208 Diversion Violation Arr-Reinstate Criminal Proceeding",
         "Continued Preliminary Hearing",
         "Subpoenaed Records Status and Further Proceedings",
         "Probation Violation To Trail",
         "Extradition Review",
         "AB 208 Diversion Violation Conference",
         "Pitchess Motion",
         "Superior Court Review and To Set",
         "Motion to Compel",
         "Bail Review hearing",
         "Status of:",
         "Hearing on Demurrer",
         "Entry of Plea",
         "Diversion Violation to Trail",
         "Court Trial",
         "Status of Appeal",
         "Humphreys Hearing",
         "Probation Violation Arraignment",
         "Receipt of Subpoenaed Records",
         "Substitution of Attorney",
         "Petition to Extend Commitment",
         "Status Hearing",
         "AB 208 Diversion Violation to Trail",
         "Veteran Treatment Court Intake",
         "Drug Court Treatment Plan",
         "Motion - PC1203.4",
         "Drug Court Status Hearing - Post Disposition",
         "Faretta Motion",
         "Restoration of Competency Certification - PC 1372",
         "DEJ Violation Arr and Reinstate Criminal Proceedings",
         "Status Conference",
         "Identification Hearing",
         "Plea Hearings",
         "AB 208 Diversion Violation Arraignment",
         "Bail Bond Surrender",
         "Failure to Comply",
         "Proof of Completion",
         "Restitution Memo",
         "Motion to Vacate",
         "Receipt of Placement Report",
         "PC 1170.95 Petitions for Resentencing",
         "AB 208 Diversion Violation Hearing",
         "MDUI Court Review",
         "Motion to Quash",
         "Other hearing",
         "Proof of Enrollment",
         "Serna Motion (Right to Speedy Trial)",
         "Diversion hearing",
         "Order to Show Cause Hearing",
         "Proof of Firearm and Ammunition Relinquishment",
         "Probation Violation Hearing",
         "Appointment of Doctor(s)",
         "Mental Health Diversion Eligibility",
         "Doctors Report Referral",
         "Domestic Violence Probation Violation Pretrial",
         "Bridges Review Intake",
         "Hearing Re: Outpatient Status Pursuant to PC 1606",
         "Military Diversion Determination",
         "DEJ Violation Arraignment",
         "O.R. Review",
         "Bridges Review",
         "Motion - 17(b) PC",
         "Motion to Strike Prior Conviction(s)",
         "Motion to Withdraw as Attorney",
         "Domestic Violence Progress Report",
         "To Set Probation Violation",
         "Further Court Trial",
         "In Camera Hearing",
         "Mental Competence Hearing",
         "Restitution Hearing",
         "Disposition or To Set Probation Violation",
         "Hearing Re: Cert of Restoration of Competency PC 1372",
         "Order to Show Cause - Attorney",
         "Pathways Review",
         "Conference",
         "Placement Report Referral",
         "Resentencing/modification hearing",
         "Court Trial on Prior Convictions",
         "Pre-Court Trial",
         "Mental Competency Progress Report PC1370(b)(1)",
         "Proof of Restitution",
         "DEJ Violation Hearing",
         "Mental Health Diversion Suitability Hearing",
         "Petition for or Status of Commitment Regarding Competency",
         "Receipt of Medical Records",
         "Certificate of Rehabilitation and Pardon",
         "Court Trial Pursuant to PC 1026-1027",
         "DEJ Violation Pretrial",
         "Ruling on Submitted Matter",
         "Order to Show Cause - Witness",
         "Restitution Court Status Review",
         "To Set Mental Health Diversion Suitability Hearing",
         "Evidentiary Hearing",
         "Examination of Source of Bail",
         "To Set Bail",
         "Jury Trial PC 1367-68",
         "Jury Trial Pursuant to PC 1026-1027",
         "Referral to courthouse clinic for mental health evaluation",
         "Mandatory Supervision to Trail",
         "Order to Show Cause Re: Contempt",
         "Petition for Release of Commitment - PC 1026.2",
         "Petition of Writ for Habeas Corpus",
         "PRCS To Trail",
         "Return on Appeal",
         "HIV Test Results",
         "Mandatory Supervision Violation Arraignment",
         "Mandatory Supervision Violation Conference",
         "Mandatory Supervision Violation Hearing",
         "Motion for a new trial",
         "Pretrial on Probation Violation",
         "Proof of Firearms Ammo Relinquishment and Restitution Report",
         "Return on Appeal - Remittitur Issued",
         "Veteran Treatment Court Probation Violation",
         "Jury Trial - Prior Convictions",
         "Lifting of no contact order",
         "Mental Health Diversion Review",
         "Motion for Modification",
         "OSC hearing - Predisposition hearing",
         "Resentencing Pursuant to PC 1170.18",
         "Return after PC 1203.03 90-day Diagnostic",
         "Status of DA case filing",
         "Warrant-Mandatory Supervision Violation",
         "Discovery hearing",
         "Franklin Hearing",
         "Further Proceedings on Probation Violation",
         "Motion to Sanction",
         "Motion to Strike",
         "Parole Revocation Conference",
         "Petition Hearing",
         "Proof of Correction",
         "Resentencing Pursuant to Prop 64",
         "Veterans Treatment Court Graduation",
         "Superior Court Review",
         "Dispo/Confirm",
         "Mental Competency Progress Report PC1370(b)(1)"
       ) ~ "Other"
     )
   )
 
 #Flag Construction
 court_hearing <- court_hearing %>%
   mutate(
     fta_flag = if_else(fta_warrant == "Warrant", 1, 0),
     fta_nowar_flag = if_else(fta == "FTA", 1, 0)
   )

 
 ####

court diagnostics and notes 
```{r eval=FALSE, include=FALSE}






San Mateo Court Collapse 
```{r eval=FALSE, include=FALSE}
  ## court_case_id is formatted differently across cases, sometimes with dashes, and sometimes with leading file date year. Unclear whether the same cases may be formatted differently across tables, have not found any evidence of such. 


#Court df collapse
  ## sometimes there are multiple lines when a case has both a complaint and an information. In these cases we should just keep the complaint, or whatever was filed first
  ## -HTA was already removed from court_case_id in the standardization process
court_df2 <- court_df %>%
  arrange(file_date) %>%
  distinct(court_case_id, .keep_all = T)


# Court Charge Collapse--See pg. xxx for more details about this process. 
  ## plea_type_original is not updated even if final disposition reflects a guilty or nolo plea pursuant to negotiation after an initial not guilty plea
  ## therefore, guilty_plea_flag will be incorrect when a defendant has changed their plea 
  ## there are 2707 cases where guilty_plea_flag is 0, but disposition_type is guilty or nolo, 2609 of which have "Plea" or "Pled" in the original dispo type
court_dispo <- court_charge %>%   
  mutate(disposition_type = ordered(disposition_type, levels = c("Other", "Dismissed", "Not_Guilty", "Nolo_Contendere", "Guilty"))) %>%
  ## remove the -HTA from court case ids because they are the same as the court case ids without it, just are labeled differently at different stages
  mutate(court_case_id_original = court_case_id,
         court_case_id = gsub("-HTA", "", court_case_id_original)) %>%
  select(-c(charge_id,  offense_id)) %>%
  arrange(sentence_date) %>%
  mutate(guilty_plea_flag = if_else(plea_type %in% c("Guilty", "Nolo_Contendere"), 1, 0)) %>%
  group_by(court_case_id) %>%
  mutate(guilty_plea_flag = max(guilty_plea_flag)) %>%
  mutate(hierarchy = if_else(is.na(hierarchy), 1e6, as.numeric(hierarchy))) %>%
  mutate(disposition_date = max(disposition_date), disposition_type = max(disposition_type)) %>%
  mutate(max_court_charge_level = court_charge_level[hierarchy == min(hierarchy)][1],
         max_court_charge_code = court_charge_code[hierarchy == min(hierarchy)][1],
         max_court_charge = court_charge[hierarchy == min(hierarchy)][1],
         max_charge_description = master_charge_description[hierarchy == min(hierarchy)][1],
         max_hier = min(hierarchy)) %>%
  mutate_at(vars(contains("flag")), funs(if_else(is.na(.), 0, .))) %>%
  mutate_at(vars(contains("flag")), funs("count" = sum(.))) %>%
  mutate_at(vars(contains("flag")), max) %>%
  filter(hierarchy == min(hierarchy)) %>%
  ungroup() %>%
  distinct(court_case_id, .keep_all = T)



# Court FTAs are collapsed to each case. 
court_fta_war <- court_hearing %>%
  ## remove the -HTA from court case ids because they are the same as the court case ids without it, just are labeled differently at different stages
  mutate(court_case_id_original = court_case_id,
         court_case_id = gsub("-HTA", "", court_case_id_original)) %>%
  arrange(hearing_date) %>%
  group_by(court_case_id) %>%
  mutate(fta_date = min(hearing_date, na.rm = T)[fta_flag == 1][1]) %>%
  mutate(fta_flag = max(fta_flag),
         fta_flag_count = sum(fta_flag))%>%
  distinct(court_case_id, .keep_all = T) %>%  
  select(court_case_id, file_date, fta_flag, fta_nowar_flag, fta_date, fta_flag_count)



# Court hearings are filtered for arraignment information and collapsed to court case id
court_arraign <- court_hearing %>%
  ## remove the -HTA from court case ids because they are the same as the court case ids without it, just are labeled differently at different stages
  mutate(court_case_id_original = court_case_id,
         court_case_id = gsub("-HTA", "", court_case_id_original)) %>%
  filter(hearing_type == "Arraignment") %>%
  arrange(hearing_date) %>%
  rename(arraignment_date = hearing_date) %>%
  arrange(arraignment_date) %>%
  distinct(court_case_id, .keep_all = T) %>%
  select(court_case_id, arraignment_date)



# All data is joined.
court_df3 <- reduce(list(court_df2, court_dispo, court_fta_war, court_arraign), left_join, by = "court_case_id") %>%
  select(-contains(".y")) %>%
  select(-c(file_date)) %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x", "", .))) %>%
  mutate(final_disposition_date = if_else(disposition_date <= sentence_date|is.na(sentence_date), disposition_date, sentence_date),
         conviction_flag = if_else(disposition_type %in% c("Guilty","Nolo_Contendere"), 1, 0))
 

# assumes that if all charges dismissed then its over
 

```


San Mateo Court Hearing Diagnostics
```{r eval=FALSE, include=FALSE}

ls(court_charge)

court_dispo %>%
  filter(grepl("0771037", book_num))

charge_hier %>%
  filter(grepl("30800", hierarchy))

ls(charge_hier)

arrange(charge_hier, hierarchy)

court_hearing%>%
    count(hearing_type, sort=TRUE)

court_hearing %>%
  filter(grepl("0097379", court_docket_id))

court_hearing%>%
  filter(fta=="FTA")

# original_df[[4]] <- tibble(table_name = "court_hearing", original_field = original_field, modified_field = names(court_hearing))
court_hearing %>%
  count(hearing_type_code_description) %>%
  arrange(desc(n)) %>%
  mutate(hearing_type_code_description = paste0('"', hearing_type_code_description, '",'))

# Diagnostics for court collapse


court_fta_war %>%
  count(fta_flag)

# need to ask
full_join(court_fta %>% filter(fta_flag == 1), court_fta_war %>% filter(fta_flag == 1) %>% rename(fta_date = fta_war_date), by = c("court_case_id", "fta_date")) %>%
  filter(fta_all_flag != fta_flag) %>%
  add_count(court_case_id) %>%
  filter(n > 1) %>%
  arrange(court_case_id, fta_date)

court_hearing %>%
  count(hearing_type_original) %>%
  arrange(desc(n))
  
court_charge %>%
  filter(stage %in% c("DISPOSITION EVENT")) %>%
  select(-c(disposition_num, charge_id, charge_history_id, offense_id, disposition_hist_id, disposition_id, disposition_type_code, amend_reason_id, amend_reason))
  # filter(stage %in% c("Sentence Event")) %>%
  count(dispos) %>%
  arrange(desc(n))
  
court_dispo %>%
  distinct(court_case_id, disposition_date, .keep_all = T) %>%
  add_count(court_case_id) %>%
  filter(n > 1) %>%
  arrange(desc(n))

court_charge %>%
  filter(stage %in% c("PLEA EVENT")) %>%
  count(disposition_type_original) %>%
  arrange(desc(n))
  distinct(court_case_id, disposition_date, .keep_all = T) %>%
  add_count(court_case_id) %>%
  filter(n > 1) %>%
  arrange(desc(n))
  # select(-c(disposition_num, charge_id, charge_history_id, offense_id, disposition_hist_id, disposition_id, disposition_type_code, amend_reason_id, amend_reason))
  # filter(stage %in% c("Sentence Event")) %>%
  count(dispos) %>%
  arrange(desc(n))

court_charge %>%
  # filter(stage %in% c("CASE FILING")) %>%
  # filter(stage %in% c("SENTENCE EVENT", "DISPOSITION EVENT")) %>%
  # distinct(court_case_id) 
  count(stage)
  filter(court_case_id == "921214") 
  #Alameda end example
  
 ##Period 2 court diagnostics 
summary(court_hearing$file_date)     
str(court_hearing)
lapply(court_hearing, function(i){if(length(unique(i)) <= 50) table (i, useNA="always")}) 
court_charge %>%
  distinct(court_case_id)%>%
  semi_join(court_df, by="court_case_id")
 


##Period 2 court diagnostics
summary(court_charge$file_date)     
str(court_charge)
lapply(court_charge, function(i){if(length(unique(i)) <= 50) table (i, useNA="always")}) 
 
 
 
court_charge %>%
  add_count(charge_id) %>%
  filter(n>1) %>%
  arrange(charge_id)


# move to diagnostics when ready
court_df %>% 
  arrange(court_case_id, file_date) %>%
  select (court_docket_id, court_case_id, file_date, court_case_type, court_party_id)
   
# court_df diagnostics
#court_df  %>%
#court_df[, grepl("id", names(court_df))]

#court_df %>%
#distinct(court_docket_id, court_case_id)
#court_df %>%
#filter(is.na(court_docket_id))
#court_df %>%
#count(court_docket_id)
  

#court_df <- court_df %>%
  #mutate_at(vars(dob, file_date), as_date) these dates semm fine now

#court_df[, grepl("id", names(court_df))]


 #court_charge %>%  
   #arrange (court_case_id)
 #filter(grepl("2341697", court_docket_id))  
 #ls(court_charge)  
 #court_charge %>%  
 
 
  #filter(grepl("2341697", court_docket_id))  

# "M_VC_231035A" this charge never used during arrest usually arrest is DUI then they plead down to receless driving"wet"
# "Other_PC_6665" special allegation prior auto theft
           #sup_vio_post_flag=if_else(book_type=="Sup_Vio", 1, 0))

 
# write.csv(court_sentence[court_sentence$court_qualifier_flag == 1, c("court_charge_code", "court_charge",
#                                                                      "court_charge_original", 
#                                                                      "court_charge_level", "court_charge_level_original", 
#                                                                      "court_charge_description")],
#           file = "G:/CrimJustice/PretrialAssessmentPilot/Charge Definitions and Hierarchy/San_Mateo_Qualifier_Flags_Court_charges.csv")
# 
# table(court_sentence$court_qualifier_flag, useNA = "ifany")


court_dispo %>%
  filter(guilty_plea_flag == 0, disposition_type %in% c("Guilty", "Nolo_Contendere")) %>%
  count(grepl("Plea|Pled", disposition_type_original))


Diagnostic Code for Charge Hierarchy


# 1 - 7,901/267,372 = 97% non-match rate
(1 - nrow(court_sentence %>% filter(is.na(hierarchy)))/nrow(court_sentence))*100

court_sentence %>%
  filter(is.na(hierarchy)) %>%
  count(join_var) %>%
  arrange(desc(n))



court_sentence%>%
  filter(grepl("Other_PC_460A", join_var))%>%
  group_by()%>%
  count()


court_sentence %>%
  filter(grepl("2341697", court_docket_id))%>%
  count()

court_df %>%
filter(is.na(court_docket_id))

court_charge %>%
  filter(is.na(disposition_date))%>%
  select(disposition_date, sentence_date)

```



San Mateo Assessment Data (Probation) Go live date was Jan 23, 2020
```{r}
# San Mateo Assessment Data Import
  ## assess_df contains one row per risk assessment event/risk assessment question/pretrial terms and conditions. The tool questions are widened into columns.
 ##assessment date range is 1/23/2020 to 6/30/2020
 ## SM said local_id is the number their jail uses, but their jail extract does not have it.  They currently dont have         court_case_id, booking_num, or arrest_date 
 ## Condition under basic=phone 1 time per week, regular MOR= come in 1 x per week, enhanced=come in 1 x per week and       additonal conditions
 ## According to Octavio's site visit notes low risk is 0-2, med 3 and high risk 4+

assess_df <- read_csv("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/San Mateo/P2 Submission-June 30/41-Probation-01OF02-JAN232020-JUN302020.csv")


# Variable name standardization--See pg. xxx for more details.
names(assess_df) <- c("local_id", "name", "dob", "sex_original", "race_original", "hispanic_flag", "tool_name", "assessment_date_time", "zip_code", "vprair_tool_response_1", "vprair_tool_response_2", "vprair_tool_response_3", "vprair_tool_response_4", "vprair_tool_response_5", "vprair_tool_response_6", "vprair_tool_response_7", "vprair_tool_response_8",   "vprair_risk_score",  "release_recommendation_original", "release_authorization_original", "release_type_original", "release_date", "release_conditions_original", "pretrial_violation_type", "pretrial_violation_date",  "court_date_reminder_original", "other_pretrial_service_original", "pretrial_termination_outcome_original", "pretrial_termination_date")
 

# Date Reformatting--See pg. xxx for more details.
assess_df <- assess_df %>%
  mutate_at(vars(dob, release_date, pretrial_violation_date, pretrial_termination_date), mdy) %>%
  mutate (assessment_date_time=parse_date_time(assessment_date_time, c('%m/%d/%Y %H:%M %p')), 
          assessment_date=as_date(assessment_date_time))


assess_df %>%
  count(pretrial_termination_outcome_original)


# Risk Score Standardization--Tool Response values are changed to their numeric point value.
assess_df <- assess_df %>%
  mutate(vprair_tool_response_1 = if_else(vprair_tool_response_1 == "Yes", 2, 0),
         vprair_tool_response_2 = if_else(vprair_tool_response_2 == "Yes", 3, 0),
         vprair_tool_response_3 = if_else(vprair_tool_response_3 == "Yes", 2, 0),
         vprair_tool_response_4 = if_else(vprair_tool_response_4 == "Yes", 2, 0),
         vprair_tool_response_5 = if_else(vprair_tool_response_5 == "Yes", 1, 0),
         vprair_tool_response_6 = if_else(vprair_tool_response_6 == "Yes", 1, 0),
         vprair_tool_response_7 = if_else(vprair_tool_response_7 == "Yes", 1, 0),
         vprair_tool_response_8 = if_else(vprair_tool_response_8 == "Yes", 2, 0))



# Standardize Factors--See pg. xxx for more details.
## release_authorization_original is mostly NA(357) and sometimes Judge, Judge At arr or judge pre arr, not standardizing further at this point.
##release_type_original has "N/A" (26 rows none with a release date) annd "pending" (14 rwos two with a release date)
## pretrial violation flag says nothing about abscond
##there is no recommended level of supervision in the data only a risk score

assess_df <- assess_df %>%
  mutate(sex = case_when(sex_original %in% c("Male") ~ "Male",
                         sex_original %in% c("Female") ~ "Female",
                         T ~ "Other_Unknown"),
         race_original = trimws(race_original),
         race = case_when(hispanic_flag %in% c("Hispanic or Latino") ~ "Hispanic",
                          race_original %in% c("Black or African American") ~ "Black",
                          race_original %in% c("Hispanic, Latino, or Spanish origin") ~ "Hispanic",
                          race_original %in% c("White") ~ "White",
                          T ~ "Other_Unknown"),
         release_recommendation = case_when(release_recommendation_original %in% c("MOR Basic", "MOR BASIC", 
                                                                                   "Mor Enhanced", "MOR Enhanced", 
                                                                                   "MOR Regular") ~ "Monitor",
                                             release_recommendation_original %in% c("OR", "Promise to Appear") ~ "OR",
                                             release_recommendation_original %in% c("Denied") ~ "Detain",
                                             release_recommendation_original %in% c("N/A") ~ "Other_Unknown"),
         release_decision = case_when(release_type_original %in% c("OR") ~ "OR",
                                      release_type_original %in% c("MOR Basic", "MOR BASIC", "Mor Enhanced", 
                                                                   "MOR Enhanced", "MOR Regular") ~ "Monitor",
                                      release_type_original %in% c("Denied") ~ "Detain",
                                      release_type_original %in% c("Bailed Out", "DA declined to file", 
                                                                   "Case dismissed") ~ "Ineligible"), 
          risk_level = case_when(vprair_risk_score %in% c("0", "1", "2") ~ "Low",
                                  vprair_risk_score %in% c("3") ~ "Medium",                        
                                  vprair_risk_score %in% c("4", "5", "6", "7", "8", "9", "10" , "11", 
                                                           "12", "13") ~ "High"),
          pretrial_release_type = case_when(release_type_original %in% c("OR") ~ "OR",
                                      release_type_original %in% c("MOR Basic", "MOR BASIC", "Mor Enhanced", 
                                                                   "MOR Enhanced", "MOR Regular") ~ "Monitor",
                                      release_type_original %in% c("Denied") ~ "Detain",
                                      release_type_original %in% c("Bailed Out") ~ "Bail_Bond", 
                                      release_type_original %in% c("DA declined to file", 
                                                                   "Case dismissed") ~ "Other_Unknown" ),
         pretrial_ineligible_reason = case_when(release_type_original %in% c("Bailed Out") ~ "Bail_Bond",
                                                release_type_original %in% c("DA declined to file", 
                                                                              "Case dismissed") ~ "Case_Disposed"), 
                                                                               
         
         pretrial_termination_outcome = case_when(pretrial_termination_outcome_original %in% c("Successful") ~
                                                    "Successful",
                                                  pretrial_termination_outcome_original %in% c("Revoked", 
                                                                                              "Unsuccessful") ~
                                                   "Unsuccessful",
                                                  pretrial_termination_outcome_original %in%
                                                    c("Unsuccessful - Case Dismissed", 
                                                      "Unsuccessful - DA declined to file") ~ "Other_Unknown"),
         
         
         pretrial_termination_reason = case_when(pretrial_violation_type %in% c("FTA") ~
                                                    "FTA",
                                                  pretrial_violation_type %in% c("New charges") ~
                                                   "New_Crime",
                                                 pretrial_violation_type %in% c("New law violation, alcohol use") ~
                                                   "Violation",
                                                  pretrial_termination_outcome_original %in%
                                                    c("Unsuccessful - Case Dismissed", 
                                                      "Unsuccessful - DA declined to file",
                                                      "Successful") ~ "Case_Disposed"))



# Flag Standardization---See pg. xxx for more details.
  ## Need to find out what NA means in the context of recommended for release
  ## drug, alcohol flags are from a notesfield and are not consistent. 
  ## what is difference between OR and Promise to Appear, they are the same
  ## clarify that denied means recommned for detention?
  ## why so many people recommended for MOR enhanced
  ## under release type what does denied mean? does it man bail set? 
  ## under release type what does N/A mean? does it man bail set? 
  ## court_date_reminder_original has no values filled in m ay need to addd when new data comes in
 
 assess_df <- assess_df %>%
    mutate(assess_flag = if_else(is.na(assessment_date), 0, 1),
         rec_release_flag = if_else(release_recommendation %in% c("OR", "Monitor"), 1, 0),
         decision_release_flag = if_else(release_decision %in% c("OR", "Monitor"), 1, 0),
         #This field needs to come from the jail data.
         # pretrial_release_flag = if_else(),
         pretrial_override_flag = if_else(rec_release_flag != decision_release_flag & 
                                            !release_recommendation %in% c("Ineligible", "Other_Unknown") & 
                                            !release_decision %in% c("Ineligible", "Other_Unknown"), 1, 0),
         #rec_em_flag = if_else(grepl("SCRAM", toupper( )), 1, 0),
         # rec_phone_flag = if_else(),
         # rec_inperson_flag = if_else(),
         #rec_drug_test_flag = if_else(grepl("TEST", toupper( )), 1, 0),
         # rec_other_flag = if_else(),
         condition_em_flag = if_else(grepl("ELECTRONIC MONITOR|GPS|SCRAM", toupper(release_conditions_original)), 1, 0),
         # Discuss release_conditions_original with Santa Barbara along with their original materias to determine phone and inperson flag. 
         #condition_phone_flag = if_else(),
         condition_inperson_flag = if_else(grepl("ENHANCED", toupper(release_type_original)), 1, 0),
         condition_drug_test_flag = if_else(grepl("TEST", toupper(release_conditions_original)), 1, 0),
         condition_no_contact = if_else(grepl("NO CONTACT|136", toupper(release_conditions_original)), 1, 0),
         #court_date_reminder_flag = if_else(court_date_reminder_original == "CourtAppearance", 1, 0),
         # Transit service doesn't actually exist here.  
         # transit_service_flag = if_else(court_date_reminder_original == "TRANSIT", 1, 0),
         pretrial_violation_flag= if_else(!is.na(pretrial_violation_date) & 
                                           pretrial_termination_outcome_original %in% 
                                            c("Revoked", "Unsuccessful"), 1, 0))


 

##Assessment Table 
 
assess_table <- assess_df %>%
  # Collapse to each assessment.
  distinct(local_id, .keep_all = T) %>%
  # Filter for only those actually assessed
  filter(!is.na(assessment_date)) %>%
  # Create county name.
  mutate(county = "San Mateo", risk_score = vprair_risk_score) %>%
  # Select relevants variables.
  select(county, risk_level, release_recommendation, release_decision, assessment_date, risk_score, tool_name)


# Save file  
fwrite(assess_table, file = "G:/CrimJustice/PretrialAssessmentPilot/Assessment Output Tables/San Mateo Assessment Output 08-2020.csv")
                                  
 
summary(assess_df$Assessment_Date_Time)     
str(court_df)
lapply(prob_df, function(i){if(length(unique(i)) <= 50) table (i, useNA="always")}) 
assess_df %>%
  count(pretrial_termination_outcome_original)


#Matching on lacal ID only leads to 9 matches between court and assessment data,
#Below I created test to see what the match rate would be on last_name and dob it was 327 matches
#the local ID in the court data has 41,784 unique local_ids, they have between 6 to 9 digits some with two leading zeros
#in the assessment data there are 401 unique local ids and most have 7 digits

test <- assess_df %>%
        mutate (name = toupper(name)) %>% 
        separate(name, c("last_name", "first_name", "suffix"),  sep = ",") %>%
        mutate_at(vars(first_name, last_name, suffix), trimws) %>%
        separate(first_name, c("first_name", "middle_name"), sep = " ")  

test %>%
  
  semi_join(court_df, by = c("last_name",  "first_name", "dob"))


assess_df %>%
  distinct(local_id) %>%
  count(local_id)

court_df %>%
  arrange (file_date)

ls()

summary(as.numeric(court_df$local_id))

court_df %>%
  filter (last_name =="SAMAYOA", first_name == "IRVIN")

```

  Assessment Collapse
```{r}
# Assessment data is duplicated across terms and conditions. These are collapsed. 
  ## Next Time fix NULL and NA values that are missing.  
assess_df <- assess_df %>%
  group_by(pretrial_id, assessment_date) %>%
  mutate_at(vars(contains("flag")), funs(max(., na.rm = T))) %>%
  distinct(pretrial_id, assessment_date, court_docket_id)
```
Assessment Codebook (9/2020) 
```{r}
names_df <- names_df %>%
  mutate(
    modified_field = case_when(
      field == "sex_original" ~ "sex",
      field == "race_original" ~ "race",
      field == "release_recommendation_original" ~ "release_recommendation, pretrial_ineligible_reason, rec_drug_test_flag, rec_em_flag",
      field == "pretrial_release_type_original" ~ "release_decision, pretrial_ineligible_reason, condition_em_flag, condition_drug_test_flag, court_date_reminder_flag",
      field == "release_conditions_original" ~ "condition_no_contact_flag, condition_em_flag, condition_drug_test_flag",
      field == "release_authorization_original" ~ "release_authorization",
      field == "pretrial_termination_reason_original" ~ "pretrial_termination_reason",
      field == "court_date_reminder_original" ~ "court_date_reminder_flag",
      field =="other_pretrial_service_original" ~ "transit_service_flag",
      field =="pretrial_violation_original" ~ "pretrial_violation_flag")) %>%
  filter(!is.na(modified_field)) %>%
  separate_rows(modified_field, sep = ",") %>%
  mutate_all(trimws)

factor_df <- lapply(ls()[!grepl("original|^df|hier|names|factor|date|flag", ls())], function(i){
  df <- get(i)
  
  df <- lapply(c(1:nrow(names_df))[!grepl("flag", names_df$modified_field)], function(j){
    df <- df %>%
      select(value = names_df$field[j], modified_value = names_df$modified_field[j]) %>%
      group_by_all() %>%
      count() %>%
      arrange(desc(n)) %>%
      group_by(modified_value) %>%
      summarise(value = paste(value, collapse = ", "), n = sum(n)) %>%
      ungroup() %>%
      mutate(percent = round(n/sum(n)*100, 1),
             total = sum(n)) %>%
      mutate(field = names_df$field[j], modified_field = names_df$modified_field[j]) %>%
      arrange(desc(n)) %>%
      select(field, modified_field, value, modified_value, n, percent, total) %>%
      mutate_all(as.character) 
      
      
    
    return(df)
  }) %>% bind_rows()
 
  df <- df %>% mutate(table_name = i)
   }) %>% 
  bind_rows() %>%
  left_join(names_df) %>%
  select(table_name, original_field, field, modified_field, value, modified_value, total, percent)

factor_df <- factor_df %>%
  mutate(value = case_when(
  modified_field == "pretrial_ineligible_reason" & modified_value == "Bail_Bond" ~ "pretrial_release_type_original = 'Posted Bail' OR release_recommendation_original = 'Posted Bail'",
  modified_field == "pretrial_ineligible_reason" & modified_value == "Case_Disposed" ~ "pretrial_release_type_original = ('No Complaint Filed', 'Time Served') OR release_recommendation_original = ('No Complaint Filed', 'Time Served')",
  modified_field == "pretrial_ineligible_reason" & modified_value == "Other_Unknown" ~ "Other Values",
  T ~ value)) %>%
  # filter(modified_field == "pretrial_ineligible_reason") %>%
  group_by(modified_field, value) %>%
  mutate_at(vars(original_field, field), funs(paste(., collapse = ", "))) %>%
  distinct(modified_field, value, .keep_all = T)
  

flag_df <- lapply(ls()[!grepl("original|^df|hier|names|factor|date|flag", ls())], function(i){
  df <- get(i)
  
  df <- lapply(c(1:nrow(names_df))[grepl("flag", names_df$modified_field)], function(j){
    df <- df %>%
      select(value = names_df$field[j], modified_value = names_df$modified_field[j]) %>%
      group_by_all() %>%
      count() %>%
      arrange(desc(n)) %>%
      group_by(modified_value) %>%
      summarise(value = paste(value, collapse = ", "), n = sum(n)) %>%
      ungroup() %>%
      mutate(percent = round(n/sum(n)*100, 1),
             total = sum(n)) %>%
      mutate(field = names_df$field[j], modified_field = names_df$modified_field[j]) %>%
      arrange(desc(n)) %>%
      select(field, modified_field, value, modified_value, n, percent, total) %>%
      mutate_all(as.character)
    
    return(df)
  }) %>% bind_rows() 
  
 df <- df %>% mutate(table_name = i)
   }) %>%

  bind_rows() %>%
  left_join(names_df) %>%
  select(table_name, original_field, field, modified_field, value, modified_value, total, percent)


flag_df <- flag_df %>%
  filter(modified_value == 1) %>%
  mutate(value = case_when(
  modified_field == "condition_drug_test_flag" & modified_value == "1" ~ "MATCHES (SCRAM, TEST)",
  modified_field == "condition_em_flag" & modified_value == "1" ~ "MATCHES (SCRAM, ELECTRONIC MONITOR, GPS)",
  modified_field == "court_date_reminder_flag" & modified_value == "1" ~ "CourtAppearance / (PTS with court reminders, OR-with court reminders)",
  modified_field == "condition_no_contact_flag" & modified_value == "1" ~ "Matches (NO CONTACT, 136)",
  modified_field == "pretrial_violation_flag" & modified_value == "1" ~ "IF pretrial_violation_date EXISTS",
  T ~ value)) %>%
  # filter(modified_field == "pretrial_ineligible_reason") %>%
  group_by(modified_field, value) %>%
  mutate_at(vars(original_field, field), funs(paste(., collapse = ", "))) %>%
  distinct(modified_field, value, .keep_all = T) %>%
  ungroup()
  
  


date_df <- lapply(ls()[!grepl("original|^df|hier|names|factor|date|flag", ls())], function(i){
  df <- get(i)
  
   if(sum(grepl("date", names(df))) > 0){
  df2 <- df %>%
  select(contains("date"), -contains("time"), -contains("court")) %>%
  gather("field", "value") %>%
  group_by(field) %>%
  summarise_all(funs(min_date = as.character(min(., na.rm = T)),  max_date = as.character(max(., na.rm = T)))) %>%
    mutate(table_name = i)
  }else{
    df2 <- tibble(field = NA_character_, min_date = NA_character_,  max_date = NA_character_, table_name = i)
  }
}) %>%
  bind_rows() %>%
  select(table_name, field, min_date, max_date)
  

write.xlsx(list(factor_df, flag_df, date_df), file = "C:/Work/PretrialAssessmentPilot/Code Books/Assessment Code Book/Santa Barbara Assessment Code Book 9-20.xlsx", asTable = T, tableStyle = "TableStyleMedium1", colWidths = "auto", sheetName = c("Factors", "Flags", "Dates"))
```


Orignal Code Book
```{r eval=FALSE, include=FALSE}
# the original codebook got messed up, so it had to be remade
rm(original_field)

original_df <- bind_rows(original_df)

San_Mateo_df <- lapply(ls()[!grepl("original", ls())], function(i){
  df <- get(i)
  
  if(sum(grepl("date", names(df))) > 0){
  df2 <- df %>%
  select(contains("date"), -contains("time")) %>%
  gather("modified_field", "value") %>%
  group_by(modified_field) %>%
  summarise_all(funs(min = as.character(min(., na.rm = T)), mean = as.character(mean(., na.rm = T)), max = as.character(max(., na.rm = T))))
  }else{
    df2 <- tibble(modified_field = NA_character_, min = NA_character_, mean = NA_character_, max = NA_character_)
  }
  
  df <- df %>%
    mutate_if(~length(unique(.)) > 50|is.Date(.)|is.POSIXct(.), ~(. = "not_factor")) %>%    
    mutate_all(~if_else(is.na(.), "na_missing", as.character(.))) %>%
    gather(modified_field, factor_value) %>%
    count(modified_field, factor_value) %>%
    mutate(table_name = i, county = "San Mateo") %>%
    mutate(factor_flag = if_else(factor_value == "not_factor", 0, 1)) %>%
    group_by(table_name, modified_field) %>%
    mutate(table_count = sum(n)) %>%
    ungroup() %>%
    rename("factor_count" = "n") %>%
    mutate(factor_count = if_else(factor_value == "not_factor", NA_integer_, factor_count),
           factor_percent = round(factor_count/table_count*100, 1)) %>%
    arrange(desc(factor_flag), modified_field, desc(factor_count))
  
  df <- left_join(df, df2, by = "modified_field")
    }) %>% 
  bind_rows() %>%
  left_join(original_df) %>%
   select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_count,
           factor_percent, table_count, min, mean, max) 

write.xlsx(San_Mateo_df, file = "Code Books/San Mateo Code Book.xlsx")
```

DOJ CII/Linking Extraction
```{r}
# Grab Tables with CII
# df <- sapply(ls()[which(sapply(ls(), function(i){
#   sum(names(get(i)) %in% "cii")
# }) == 1)], get)

# Pull CII and other identifiers
doj_book <- book_df %>%
  select(cii, fbi, name, dob, cdl_id, race_original, sex_original) %>%
  mutate(cii = parse_number(cii),
         cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
                         nchar(cii) == 7 ~ paste0("000", cii),
                         nchar(cii) == 8 ~ paste0("00", cii),
                         nchar(cii) == 9 ~ paste0("0", cii),
                         T ~ as.character(cii)),
         cii = if_else(nchar(cii) != 10, NA_character_, cii)) %>%
  distinct()


# doj_court <- df[[2]] %>%
#   select(cii, fbi, dob, race_original, sex_original, name, local_id) %>%
#   mutate(cii = parse_number(cii),
#          cii = case_when(nchar(cii) == 6 ~ paste0("0000", cii),
#                          nchar(cii) == 7 ~ paste0("000", cii),
#                          nchar(cii) == 8 ~ paste0("00", cii),
#                          nchar(cii) == 9 ~ paste0("0", cii)),
#                          T ~ as.character(cii)),
#          cii = if_else(nchar(cii) != 10, NA_character_, cii)) %>%
#   distinct()
# 
# court_df %>%
#   filter(!is.na(cii))

# Examine missing ciis and duplicates on cii. 
# doj_book %>% #Off by about 55,000
#   distinct()
# 
# doj_book %>% 
#   distinct(cii)
# 
# doj_book %>% 
#   distinct() %>%
#   add_count(cii) %>%
#   filter(n > 1) %>%
#   arrange(desc(n)) %>% 
#   View()
# 
# doj_court %>% #Off by about 45,000
#   distinct()
# 
# doj_court %>% 
#   distinct(cii)
# 
# doj_court %>% 
#   distinct() %>%
#   add_count(cii) %>%
#   filter(n > 1) %>%
#   arrange(desc(n)) %>% 
#   View()
# 
# 
# doj_book %>% # Off by about 7,000
#   distinct()
# 
# doj_book %>% 
#   distinct(cii)

# doj_book %>% 
#   distinct() %>%
#   add_count(cii) %>%
#   filter(n > 1) %>%
#   arrange(desc(n)) %>% 
#   View()
# 
# doj_court %>% #Off by about 9,000
#   distinct()
# 
# doj_court %>% 
#   distinct(cii)
# 
# doj_court %>% 
#   distinct() %>%
#   add_count(cii) %>%
#   filter(n > 1) %>%
#   arrange(desc(n)) %>% 
#   View()

#CIIs for DOJ
doj_cii <- (doj_book %>% select(cii)) %>% distinct()


#Create an excel workbook with all data table. Make sure to include the cii table first. 
write.xlsx(list(doj_cii, doj_book), file = "CIIs for DOJ/San Mateo CIIs and Demographics for DOJ.xlsx", sheetName = c("ciis", "booking"))


```
Compile Codebook Notes
```{r}
files <- list.files("G:/CrimJustice/PretrialAssessmentPilot/Code Books/Code Book Notes", pattern = "San Mateo", full.names = T)
df <- lapply(files, read_excel)


df[[3]] <- full_join(df[[1]], df[[2]]) %>%
  mutate(factor_standard = "") %>%
  select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_standard, factor_count, factor_percent, 
         table_count, "nl_notes_2" = factor_collapse, "nl_notes_1" = notes, min, mean, max, "st_notes" = Notes)

df <- list(df[[3]], df[[1]], df[[2]])

write.xlsx(df, file = "G:/CrimJustice/PretrialAssessmentPilot/Code Books/Variable Construction/San Mateo Factor Construction.xlsx", asTable = T, tableStyle = "TableStyleMedium1", sheetName = c("Variable Construction", "st_notes", "nl_notes"))
```
Create Factor Codebook
```{r}
#Create Factor Codebook
factor_df <- lapply(ls()[!grepl("original|^df|hier", ls())], function(i){
  df <- get(i)
  if(sum(grepl("original", names(df))) == 0){
    return(NULL)
  }else{
    var_names <- names(df)[grepl("original", names(df))]
    var_names2 <- gsub("_original", "", var_names)
   
    df1 <- df %>%
     select(var_names) %>%
     gather(original_field, original_value)
   
    df2 <- df %>%
     select(var_names2) %>%
     gather(modified_field, modified_value)
   
   df <- bind_cols(df1, df2) %>%
     count(original_field, modified_field, original_value, modified_value) %>%
     arrange(modified_field, desc(n)) %>%
     group_by(modified_field) %>%
     mutate(row = row_number(),
            percent = round(n/sum(n)*100)) %>%
     ungroup() %>%
     filter(row <= 50) %>%
     select(-row) %>%
     rename("total" = n)
   }
  }) %>%
  bind_rows()

write.xlsx(factor_df, file = "G:/CrimJustice/PretrialAssessmentPilot/Code Books/Factor Code Book/San Mateo Factor Code Book.xlsx", asTable = T, tableStyle = "TableStyleMedium1", colWidths = "auto")

```
 Joining All Data Post-Collapse
 Jail Court Join
```{r}
# Remove extraneous objects in the environment
rm(list = ls()[!ls() %in% ls(pattern = "df")])

#Check for common variables
#names(book_df)[names(book_df) %in% names(assess_df)] no assessment data yet

names(book_df)[names(book_df) %in% names(court_df2)]



#Turning NULL to NA to ensure non matching and removing generic charge info from data frames
book_df <- book_df %>%
  mutate_if(is.character, list(~na_if(., "NULL"))) %>%
  select(-c(charge, charge_level, charge_code)) %>%
  mutate_at(vars(first_name, last_name), toupper)

#assess_df <- assess_df %>%
 # mutate_if(is.character, list(~na_if(., "(Missing)"))) %>%
  #select(-c(id, court))

court_df2 <- court_df2 %>%
  mutate_if(is.character, list(~na_if(., "NULL"))) %>%
  select(-c(charge, charge_level, charge_code)) %>%
  mutate_at(vars(first_name, last_name), toupper) %>%
  mutate(court_case_id = as.character(court_case_id))

#Joining Assessment to Jail Data
join1 <- inner_join(book_df, assess_df, by = "book_num", na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x$", "", .))) %>%
  select(-contains(".y")) %>%
  #1 Duplicate with missing dispositions which will be dropped later. 
  distinct()

j1 <- anti_join(book_df, assess_df, by = "book_num", na_matches = "never")
a1 <- anti_join(assess_df, book_df, by = "book_num", na_matches = "never")


  #Examine if set of common variables is distinct--yes
  semi_join(book_df, assess_df, by = "book_num", na_matches = "never") %>%
    distinct()

#Joining on Name and Court ID
join2 <- inner_join(j1, a1, by = c("first_name", "last_name", "book_date" = "interview_date"), 
                    na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(gsub("\\.x$", "", .))) %>%
  select(-contains(".y")) %>%
  #1 Duplicate with missing dispositions which will be dropped later. 
  distinct()

j2 <- anti_join(j1, a1, by = c("first_name", "last_name", "book_date" = "interview_date"), na_matches = "never")
a2 <- anti_join(a1, j1, by = c("first_name", "last_name", "interview_date" = "book_date"), na_matches = "never")

  #Examine if set of common variables is distinct--yes
  semi_join(j1, a1, by = c("first_name", "last_name", "book_date" = "interview_date"), 
            na_matches = "never") %>%
    distinct()
  
#Diagnostics
  #Jail and Assessment Matches by category
tibble(
  stage = 1:2,
  match = c(
    'c("book_num")',
    'c("first_name", "last_name", "book_date" = "interview_date")'
  ),
  # jail_match_rate = sapply(1:2, function(i) {
  #   (nrow(book_df) - nrow(get(paste0("j", i)))) / nrow(book_df) * 100
  # }),
  assess_match_rate = sapply(1:2, function(i) {
    (nrow(assess_df) - nrow(get(paste0("a", i)))) / nrow(assess_df) * 100
  })
)

#Recreating Booking--Should be same number of rows.
book_df <- bind_rows(join1, join2, j2)  

rm(list = ls()[!ls() %in% ls(pattern = "df")])

#scratch

court_df2 %>%
 ls()
   
book_df %>%
  ls()


 join1 %>%
  select(contains(".x")) %>%
  names() %>%
  sort()

join1 %>%
  select(contains("arrest_")) %>%
  names() %>%
  sort()

names(book_df)[names(book_df) %in% names(court_df2)]

names(join1)[grepl("\\.x", names(join1)) & paste0("arrest_", gsub("\\.x$", "", names(join1))) %in% names(join1)]


names(join1)[grepl("\\.y", names(join1)) & paste0("court_", gsub("\\.y$", "", names(join1))) %in% names(join1)]
#end of scratch


# Court Matching
#Joining on cdl_id
join1 <- inner_join(book_df, court_df2, by = c("cdl_id"), na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(paste0("arrest_", gsub("\\.x$", "", .)))) %>%
  rename_at(vars(contains(".y")), funs(paste0("court_", gsub("\\.y$", "", .)))) %>%
  # 8 Duplicates with missing dispositions which will be dropped later. 
  distinct()

j1 <- anti_join(book_df, court_df2, by = c("cdl_id"), na_matches = "never")
c1 <- anti_join(court_df2, book_df, by = c("cdl_id"), na_matches = "never")



  #Examine if set of common variables is distinct--yes except 8 spurious cases.
  join1 %>%
    select(-contains("flag")) %>%
    add_count("cdl_id") %>%
    filter(n > 1) %>%
    arrange(desc(n))

     

#Joining on Name and Court ID
join2 <- inner_join(j1, c1, by = c("last_name", "first_name", "dob"), na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(paste0("arrest_", gsub("\\.x$", "", .)))) %>%
  rename_at(vars(contains(".y")), funs(paste0("court_", gsub("\\.y$", "", .)))) %>%
  #1 Duplicate with missing dispositions which will be dropped later. 
  distinct()

j2 <- anti_join(j1, c1, by = c("last_name", "first_name", "dob"), na_matches = "never")
c2 <- anti_join(c1, j1, by = c("last_name", "first_name", "dob"), na_matches = "never")

  #Examine if set of common variables is distinct--yes except 8 spurious cases.
  join2 %>%
     select(-contains("flag")) %>%
    add_count("last_name", "first_name", "dob") %>%
    filter(n > 1) %>%
    arrange(desc(n))

#Joining on Court ID
join3 <- inner_join(j2, c2, by = c("fbi"), na_matches = "never") %>%
  rename_at(vars(contains(".x")), funs(paste0("arrest_", gsub("\\.x$", "", .)))) %>%
  rename_at(vars(contains(".y")), funs(paste0("court_", gsub("\\.y$", "", .)))) %>%
  #1 Duplicate with missing dispositions which will be dropped later. 
  distinct()

j3 <- anti_join(j2, c2, by = c("fbi"), na_matches = "never")
c3 <- anti_join(c2, j2, by = c("fbi"), na_matches = "never")

  #Examine if set of common variables is distinct--yes except 8 spurious cases.
  join3 %>%
    add_count ("fbi") %>%
    filter(n > 1) %>%
    arrange(desc(n))
  
#Diagnostics
  #Jail and Court Matches by category
tibble(
  stage = 1:3,
  match = c(
    'c("cdl_id")',
    'c("cdl_id", "first_name", "last_name", dob")',
    'c("cdl_id", "fbi")'
  ),
  jail_match_rate = sapply(1:3, function(i) {
    (nrow(book_df) - nrow(get(paste0("j", i)))) / nrow(book_df) * 100
  }),
  court_match_rate = sapply(1:3, function(i) {
    (nrow(court_df2) - nrow(get(paste0("c", i)))) / nrow(court_df2) * 100
  })
)

join_df <- bind_rows(join1, join2, join3)
```


# Sierra

Court Data
```{r}

original_df <- list()

# > list.files("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Sierra/")
# [1] "Charges-Disposition 01-14-20.csv" "Demographics-01-14-20.csv"        "FTA 09-15-19 thru 01-14-2020.csv" "Pretrial Grant Cases.xlsx"       
# [5] "Pretrial_1_FTA.csv"  

# "Pretrial Grant Cases.xlsx" is case information, being read to court_df

# "Demographics-01-14-20.csv" being read to court_demo

# "Charges-disposition 01-14-20.csv" being read to court_dispos


# "FTA 09-15-19 thru 01-14-2020.csv" apppers to be mostly the same as "Pretrial_1_FTA.csv" in that both share the following columns:
# "Case Number", "Case Name", "Issue Date", "Warrant Type"
# "FTA 09-15-19 thru 01-14-2020.csv" has "Type" [of hearing?], Result Date" & "Result Type" while
# "Pretrial_1_FTA.csv" has FN, LN, DL#, "Filing Date", "Case Type" [fel/misd], Disposition Date", "Disposition Type", "Disposition Manner"
# former could be list of appearances resulting in FTA warrant and latter could be list of warrants issued [?]

court_df_s_o <- read.xlsx("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Sierra/Pretrial Grant Cases.xlsx")


court_df_s_o %>%
  ls()

original_field <- names(court_df)

names(court_df_s_o) <- c("case_id", "case_name", "charge_number", "charge_level", "charge", "violation_date", "file_date", "disposition_date", "disposition_type", "disposition_manner")

original_df[[1]] <- tibble(table_name = "court_df", original_field = original_field, modified_field = names(court_df))

court_df_s_o <- court_df_s_o %>%
  mutate_at(vars(contains("date")), as_date, origin = "1899-12-30")
                       
court_df <- read.csv("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Sierra/Demographics-01-14-20.csv",
                       as.is = TRUE)

original_field <- names(court_df)

names(court_df) <- c("case_id", "first_name", "last_name", "dob", "race", "sex")

original_df[[2]] <- tibble(table_name = "court_demo", original_field = original_field, modified_field = names(court_demo))
                       
court_demo$dob <- mdy(court_demo$dob)

court_dispos <- read.csv("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Sierra/Charges-Disposition 01-14-20.csv",
                         as.is = TRUE)

original_field <- names(court_dispos)

names(court_dispos) <- c("case_id", "case_name", "file_date", "charge_number", "charge_level", "charge", "disposition_date", "disposition_type", "disposition_manner", "sentence_date", "sentence_type", "sentence_amount", "sentence_length", "sentence_length_unit")

original_df[[3]] <- tibble(table_name = "court_dispos", original_field = original_field, modified_field = names(court_dispos))

court_dispos <- court_dispos %>%
  mutate_at(vars(contains("date")), mdy)

court_fta <- read.csv("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Sierra/FTA 09-15-19 thru 01-14-2020.csv",
                      as.is = TRUE)

original_field <- names(court_fta)

names(court_fta) <- c("case_id", "case_name", "hearing_type", "hearing_result_date", "hearing_result_type", "fta_warrant_date", "fta_warrant_type")

original_df[[4]] <- tibble(table_name = "court_fta", original_field = original_field, modified_field = names(court_fta))

court_fta <- court_fta %>%
  mutate_at(vars(contains("date")), mdy)

court_fta_warrant <- read.csv("G:/CrimJustice/PretrialAssessmentPilot/Historical Data Submissions/Sierra/Pretrial_1_FTA.csv",
                              as.is = TRUE)

original_field <- names(court_fta_warrant)

names(court_fta_warrant) <- c("case_id", "case_name", "first_name", "last_name", "cdl_id", "cdl_id_type", "file_date", "charge_level", "disposition_date", "disposition_type", "disposition_manner", "fta_warrant_date", "fta_warrant_type")

original_df[[5]] <- tibble(table_name = "court_fta_warrant", original_field = original_field, modified_field = names(court_fta_warrant))

court_fta_warrant <- court_fta_warrant %>%
  mutate_at(vars(contains("date")), mdy)

```


Code Book
```{r eval=FALSE, include=FALSE}
rm(original_field)
original_df <- bind_rows(original_df)
Sierra_df <- lapply(ls()[!grepl("original", ls())], function(i){
  df <- get(i)
  
  if(sum(grepl("date", names(df))) > 0){
    df2 <- df %>%
      select(contains("date"), -contains("time")) %>%
      gather("modified_field", "value") %>%
      group_by(modified_field) %>%
    summarise_all(funs(min = as.character(min(., na.rm = T)), mean = as.character(mean(., na.rm = T)), 
                       max = as.character(max(., na.rm = T))))
  }else{
    df2 <- tibble(modified_field = NA_character_, min = NA_character_, mean = NA_character_, max = NA_character_)
  }
  
  df <- df %>%
    mutate_if(~length(unique(.)) > 50|is.Date(.)|is.POSIXct(.), ~(. = "not_factor")) %>%
    mutate_at(vars(contains("name")), ~(.="not_factor")) %>%
    mutate_at(vars(contains("_id$")), ~(.="not_factor")) %>%
    mutate_all(~if_else(is.na(.), "na_missing", as.character(.))) %>%
    gather(modified_field, factor_value) %>%
    count(modified_field, factor_value) %>%
    mutate(table_name = i, county = "Sierra") %>%
    mutate(factor_flag = if_else(factor_value == "not_factor", 0, 1)) %>%
    group_by(table_name, modified_field) %>%
    mutate(table_count = sum(n)) %>%
    ungroup() %>%
    rename("factor_count" = "n") %>%
    mutate(factor_count = if_else(factor_value == "not_factor", NA_integer_, factor_count),
           factor_percent = round(factor_count/table_count*100, 1)) %>%
    arrange(desc(factor_flag), modified_field, desc(factor_count))
  
  df <- left_join(df, df2, by = "modified_field")
    }) %>% 
  bind_rows() %>%
  left_join(original_df) %>%
   select(county, table_name, original_field, modified_field, factor_flag, factor_value, factor_count,
           factor_percent, table_count, min, mean, max) 
write.xlsx(Sierra_df, file = "Code Books/Sierra Code Book.xlsx")


```






