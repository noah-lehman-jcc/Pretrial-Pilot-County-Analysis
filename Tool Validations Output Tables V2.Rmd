---
title: "Tool Validations Output Table"
author: "Noah Lehman"
date: "5/18/2021"
output:
  pdf_document: default
---

# Settup and Library
```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
knitr::opts_knit$set(root.dir = "G:/CrimJustice/PretrialAssessmentPilot")

# library(rlang)
library(tidyverse)
library(data.table)
library(openxlsx)
library(readxl)
library(lubridate)
library(XML)
library(xml2)
# library(xmltools)o
library(gsubfn)
library(fuzzyjoin)
library(dplyr)
library(openxlsx)
library(fuzzyjoin)
# library(multidplyr)
library(pROC)
library(broom)
library(kableExtra)
library(stargazer)

# shell.exec(getwd())
```


```{r warning=FALSE, include=FALSE}
load("G:/CrimJustice/PretrialAssessmentPilot/Tool Validation Final Data Frame.RData")

eval_df <- eval_df %>%
  filter(tool_name %in% c("oras", "psa", "vprai", "vprair"))
```

```{r warning=FALSE, include=FALSE}
my_kable <- function(x){
  kable(x, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 14, latex_options = "hold_position") %>%
    row_spec(nrow(x), bold = T)
    # column_spec(2, bold = T)
  # footnote(general_title = "", general = "Source: Judicial Council of California, Recidivism Reduction Fund Quarterly Reports (July 1, 2015-March 31, 2018).")  %>%
    
}
```
\newpage

# Date Range
```{r}
date_df <- eval_df %>%
  group_by(tool_name) %>%
  summarise(min_date = min(assessment_date), max_date = max(assessment_date)) %>%
  mutate(tool_name = toupper(tool_name))

names(date_df) <- c("Tool Name", "Earliest Assessment Date", "Latest Assessment Date")

kable(date_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 14, latex_options = "hold_position") 

```

# Total Assessments by Tool 
```{r echo=FALSE}
suppressMessages(
county_df <- eval_df %>%
  count(county, tool_name) %>%
  group_by(tool_name) %>%
  summarise(county = paste(county, collapse = ", "), Total = sum(n)) %>%
  ungroup() %>%
  mutate(tool_name = toupper(tool_name)) %>%
  bind_rows(eval_df %>%
              summarise(Total = n()) %>%
              mutate(tool_name = "All", county = "All"))
)

names(county_df) <- c("Tool Name", "County", "Pretrial Observations")

kable(county_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, latex_options = "hold_position") %>%
  row_spec(nrow(county_df), bold = T)

```

# Drop-Off


```{r}
load("Assessment to Validation Drop Off.RData")

drop_df <- drop_df %>%
  # count(`Tool Name`)
  filter(!`Tool Name` %in% c("CCAT", "VPRAIO"))
  

kable(drop_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 14, 
                  latex_options = "hold_position") 

drop_df <- drop_df %>%
  group_by(`Tool Name`) %>%
  summarise_all(sum)
  

kable(drop_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 14, 
                  latex_options = "hold_position") 
```

# The Percent of Assessments by Demographic
```{r}
race_df <- eval_df %>%
  count(tool_name, race) %>%
  group_by(tool_name) %>%
  mutate(Total = sum(n)) %>%
  pivot_wider(names_from =  race, values_from =  n, values_fill = 0) %>%
  select(tool_name, Black, White, Hispanic, "Other" = Other_Unknown, Total) %>%
  bind_rows(eval_df %>%
              count(race) %>%
              mutate(Total = sum(n)) %>%
              pivot_wider(names_from =  race, values_from =  n, values_fill = 0) %>%
              mutate(tool_name = "Total") %>%
              select(tool_name, Black, White, Hispanic, "Other" = Other_Unknown, Total)) %>%
  mutate_at(vars("Black", "White", "Hispanic", "Other"), funs(round(./Total*100)))

gender_df <- eval_df %>%
  count(tool_name, sex) %>%
  group_by(tool_name) %>%
  mutate(Total = sum(n)) %>%
  pivot_wider(names_from =  sex, values_from =  n, values_fill = 0) %>%
  select(tool_name, Male, Female, Total) %>%
  bind_rows(eval_df %>%
              count(sex) %>%
              mutate(Total = sum(n)) %>%
              pivot_wider(names_from =  sex, values_from =  n, values_fill = 0) %>%
              mutate(tool_name = "Total") %>%
              select(tool_name, Male, Female, Total)) %>%
  mutate_at(vars("Male", "Female"), funs(round(./Total*100)))

age_df <- eval_df %>%
  mutate(age = as.numeric(round((assessment_date - dob)/365.25))) %>%
  group_by(tool_name) %>%
  summarise(age = median(age, na.rm = T)) %>%
  bind_rows(eval_df %>%
              mutate(age = as.numeric(round((assessment_date - dob)/365.25))) %>%
              summarise(age = median(age, na.rm = T)) %>%
              mutate(tool_name = "Total"))


demo_df <- left_join(race_df, gender_df) %>%
  left_join(age_df) %>%
  mutate(tool_name = toupper(tool_name)) %>%
  select("Tool Name" = tool_name, Total, everything(), "Median Age" = age)

my_kable(demo_df) %>%
  add_header_above(c(" " = 2, "Race/Ethnicity (%)" = 4, "Gender (%)" = 2, " " = 1))
```
Source: Pretrial Pilot Multi-Agency Linked Data. Data are limited to bookings with a defendant released pretrial and a completed pretrial period.
\newpage

# Arrest Offenses
```{r}
arrest_df <- eval_df %>%
  group_by(tool_name) %>%
  summarise_at(vars(arrest_felony_flag, arrest_misd_flag, arrest_violent_psa_flag, arrest_property_flag, arrest_drug_flag,
                    arrest_dui_flag, arrest_dv_flag), funs(round(mean(.)*100))) %>%
  mutate(arrest_misd_flag = 100 - arrest_felony_flag) %>%
  mutate(tool_name = toupper(tool_name))

names(arrest_df) <- c("Tool Name", "Felony", "Misdemeanor", "Violent", "Property", "Drug", "DUI", "DV")

kable(arrest_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 14, latex_options = "hold_position")
```

# Adverse Outcomes
```{r}
outcome_df <- eval_df %>%
  group_by(tool_name) %>%
  summarise_at(vars(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    recid_arrest_violent_psa_flag), 
                    # any_pretrial_failure_flag),
               funs(round(mean(.)*100, 1))) %>%
  mutate(tool_name = toupper(tool_name))

names(outcome_df) <- c("Tool Name", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest") 
                       # "FTA or New Arrest")

kable(outcome_df, booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 14, latex_options = "hold_position")
```


Source: Pretrial Pilot Program Probation Data (10-01-2019 through 03-31-2021).
\newline
Note: See report text for definitions of small, small/medium, medium and large.
\newpage

```{r eval=FALSE, include=FALSE}
full_df %>%
  group_by(year(book_date), month(book_date)) %>%
  summarise(arrest_violent_psa_flag = round(mean(arrest_violent_psa_flag)*100, 1)) %>%
  View()  

full_df %>%
  filter(year(book_date) > 2015, year(book_date) <= 2020) %>%
  group_by(year(book_date), month(book_date)) %>%
  # mutate(book_date = min(book_date)) %>%
  summarise(arrest_violent_psa_flag = sum(arrest_violent_psa_flag), book_date = min(book_date)) %>%
  ungroup() %>% 
  ggplot() +
  aes(x = book_date, y = arrest_violent_psa_flag) +
  geom_line()
```

## Basic Validation
# Adverse Outcome by Score
ORAS
\newline
```{r}
risk_df <- eval_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "oras", !is.na(oras_risk_score)) %>%
  group_by(oras_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing",
                                        "New Conviction", "New Violent Arrest")))
  
ggplot(risk_df %>% distinct(oras_risk_score, Total)) +
  aes(x = as.factor(oras_risk_score), y = Total) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3, aes(label = Total), size = 2.6) +
  theme_bw() +
  # ylim(0,100) +
  # facet_wrap(~name) +
  labs(x = "Risk Category", y = "Count", title = "Distribution of Assessments by ORAS Risk Category") 

ggplot(risk_df) +
  aes(x = oras_risk_score, y = value) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3,aes(label = paste0(value, "%")), size = 3) +
  theme_bw() +
  ylim(0,100) +
  facet_wrap(~name) +
  labs(x = "Risk Category", y = "Percent", title = "ORAS Outcomes by Risk Category")



```
\newpage

VPRAI
\newline
```{r}
risk_df <- eval_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "vprai", !is.na(vprai_risk_score)) %>%
  group_by(vprai_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

ggplot(risk_df %>% distinct(vprai_risk_score, Total)) +
  aes(x = as.factor(vprai_risk_score), y = Total) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3, aes(label = Total), size = 2.6) +
  theme_bw() +
  # ylim(0,100) +
  # facet_wrap(~name) +
  labs(x = "Risk Category", y = "Count", title = "Distribution of Assessments by VPRAI Risk Category")    

ggplot(risk_df) +
  aes(x = vprai_risk_score, y = value) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3, aes(label = paste0(value, "%")), size = 3) +
  theme_bw() +
  ylim(0,100) +
  facet_wrap(~name) +
  labs(x = "Risk Category", y = "Percent", title = "VPRAI Outcomes by Risk Category")

```
\newpage

VPRAI-R
\newline
```{r}
risk_df <- eval_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "vprair", !is.na(vprair_risk_score)) %>%
  group_by(vprair_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))
  
ggplot(risk_df %>% distinct(vprair_risk_score, Total)) +
  aes(x = as.factor(vprair_risk_score), y = Total) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3, aes(label = Total), size = 2.6) +
  theme_bw() +
  # ylim(0,100) +
  # facet_wrap(~name) +
  labs(x = "Risk Category", y = "Count", title = "Distribution of Assessments by VPRAIR Risk Category")  

ggplot(risk_df) +
  aes(x = as.factor(vprair_risk_score), y = value) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3, aes(label = paste0(value, "%")), size = 2.6) +
  theme_bw() +
  ylim(0,100) +
  facet_wrap(~name) +
  labs(x = "Risk Category", y = "Percent", title = "VPRAIR Outcomes by Risk Category")
```
\newpage

PSA
\newline
```{r}
risk_df <- eval_df %>%
  filter(tool_name == "psa") %>%
  group_by(psa_fta_risk_score) %>%
  summarise(across(c(fta_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag) 

names(risk_df)[1] <- "psa_risk_score"

risk_df2 <- eval_df %>%
  filter(tool_name == "psa") %>%
  group_by(psa_nca_risk_score) %>%
  summarise(across(c(recid_arrested_flag, recid_filed_flag, recid_convicted_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[1] <- "psa_risk_score"

risk_df3 <- eval_df %>%
  filter(tool_name == "psa", !is.na(psa_nvca_risk_score)) %>%
  group_by(psa_nvca_risk_score) %>%
  summarise(across(c(recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[1] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

ggplot(risk_df %>%
         filter(!name %in% c("New Filing", "New Conviction")) %>%
         mutate(name = case_when(name == "FTA" ~ "PSA FTA Risk Score",
                                 name == "New Arrest" ~ "PSA NCA Risk Score",
                                 name == "New Violent Arrest" ~ "PSA NVCA Risk Score"))) +
  aes(x = as.factor(psa_risk_score), y = Total) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3, aes(label = Total), size = 2.6) +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Count", title = "Distribution of Assessments by PSA Risk Category")  
  
ggplot(risk_df) +
  aes(x = as.factor(psa_risk_score), y = value) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3, aes(label = paste0(value, "%")), size = 2.6) +
  theme_bw() +
  ylim(0,100) +
  # scale_x_discrete(limits = 1:6) +
  facet_wrap(~name, scales = "free_x") +
  labs(x = "Risk Category", y = "Percent", title = "PSA Outcomes by Risk Category")

# risk_df %>%
#   distinct(psa_risk_score, Total)
```
\newpage

Alameda
\newline
```{r}
risk_df <- eval_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "vprair", !is.na(vprair_risk_score), county == "Alameda") %>%
  group_by(vprair_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

ggplot(risk_df %>% distinct(vprair_risk_score, Total)) +
  aes(x = as.factor(vprair_risk_score), y = Total) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3, aes(label = Total), size = 2.6) +
  theme_bw() +
  # ylim(0,100) +
  # facet_wrap(~name) +
  labs(x = "Risk Category", y = "Count", title = "Alameda Distribution of Assessments by VPRAIR Risk Category")  

ggplot(risk_df) +
  aes(x = as.factor(vprair_risk_score), y = value) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3, aes(label = paste0(value, "%")), size = 2.6) +
  theme_bw() +
  ylim(0,100) +
  facet_wrap(~name) +
  labs(x = "Risk Category", y = "Percent", title = "Alameda VPRAIR Outcomes by Risk Category")
```
\newpage

Los Angeles
\newline
```{r}
risk_df <- eval_df %>%
  filter(tool_name == "psa", county == "Los Angeles") %>%
  group_by(psa_fta_risk_score) %>%
  summarise(across(c(fta_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag) 

names(risk_df)[1] <- "psa_risk_score"

risk_df2 <- eval_df %>%
  filter(tool_name == "psa", county == "Los Angeles") %>%
  group_by(psa_nca_risk_score) %>%
  summarise(across(c(recid_arrested_flag, recid_filed_flag, recid_convicted_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[1] <- "psa_risk_score"

risk_df3 <- eval_df %>%
  filter(tool_name == "psa", !is.na(psa_nvca_risk_score), county == "Los Angeles") %>%
  group_by(psa_nvca_risk_score) %>%
  summarise(across(c(recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[1] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

ggplot(risk_df %>%
         filter(!name %in% c("New Filing", "New Conviction")) %>%
         mutate(name = case_when(name == "FTA" ~ "PSA FTA Risk Score",
                                 name == "New Arrest" ~ "PSA NCA Risk Score",
                                 name == "New Violent Arrest" ~ "PSA NVCA Risk Score"))) +
  aes(x = as.factor(psa_risk_score), y = Total) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3, aes(label = Total), size = 2.6) +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Count", title = "Los Angeles Distribution of Assessments by PSA Risk Category")  
  
ggplot(risk_df) +
  aes(x = as.factor(psa_risk_score), y = value) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3, aes(label = paste0(value, "%")), size = 2.6) +
  theme_bw() +
  ylim(0,100) +
  # scale_x_discrete(limits = 1:6) +
  facet_wrap(~name, scales = "free_x") +
  labs(x = "Risk Category", y = "Percent", title = "Los Angeles PSA Outcomes by Risk Category")

# risk_df %>%
#   distinct(psa_risk_score, Total)
```
\newpage

Sacramento
\newline
```{r}
risk_df <- eval_df %>%
  filter(tool_name == "psa", county == "Sacramento") %>%
  group_by(psa_fta_risk_score) %>%
  summarise(across(c(fta_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag) 

names(risk_df)[1] <- "psa_risk_score"

risk_df2 <- eval_df %>%
  filter(tool_name == "psa", county == "Sacramento") %>%
  group_by(psa_nca_risk_score) %>%
  summarise(across(c(recid_arrested_flag, recid_filed_flag, recid_convicted_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[1] <- "psa_risk_score"

risk_df3 <- eval_df %>%
  filter(tool_name == "psa", !is.na(psa_nvca_risk_score), county == "Sacramento") %>%
  group_by(psa_nvca_risk_score) %>%
  summarise(across(c(recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[1] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

ggplot(risk_df %>%
         filter(!name %in% c("New Filing", "New Conviction")) %>%
         mutate(name = case_when(name == "FTA" ~ "PSA FTA Risk Score",
                                 name == "New Arrest" ~ "PSA NCA Risk Score",
                                 name == "New Violent Arrest" ~ "PSA NVCA Risk Score"))) +
  aes(x = as.factor(psa_risk_score), y = Total) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3, aes(label = Total), size = 2.6) +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Count", title = "Sacramento Distribution of Assessments by PSA Risk Category")  
  
ggplot(risk_df) +
  aes(x = as.factor(psa_risk_score), y = value) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3, aes(label = paste0(value, "%")), size = 2.6) +
  theme_bw() +
  ylim(0,100) +
  # scale_x_discrete(limits = 1:6) +
  facet_wrap(~name, scales = "free_x") +
  labs(x = "Risk Category", y = "Percent", title = "Sacramento PSA Outcomes by Risk Category")

# risk_df %>%
#   distinct(psa_risk_score, Total)
```
\newpage

San Joaquin
\newline
```{r}
risk_df <- eval_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "vprai", !is.na(vprai_risk_score), county == "San Joaquin") %>%
  group_by(vprai_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

ggplot(risk_df %>% distinct(vprai_risk_score, Total)) +
  aes(x = as.factor(vprai_risk_score), y = Total) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3, aes(label = Total), size = 2.6) +
  theme_bw() +
  # ylim(0,100) +
  # facet_wrap(~name) +
  labs(x = "Risk Category", y = "Count", title = "San Joaquin Distribution of Assessments by VPRAI Risk Category")    

ggplot(risk_df) +
  aes(x = vprai_risk_score, y = value) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3, aes(label = paste0(value, "%")), size = 3) +
  theme_bw() +
  ylim(0,100) +
  facet_wrap(~name) +
  labs(x = "Risk Category", y = "Percent", title = "San Joaquin VPRAI Outcomes by Risk Category")
```
\newpage

Santa Barbara
\newline
```{r}
risk_df <- eval_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "vprair", !is.na(vprair_risk_score), county == "Santa Barbara") %>%
  group_by(vprair_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

ggplot(risk_df %>% distinct(vprair_risk_score, Total)) +
  aes(x = as.factor(vprair_risk_score), y = Total) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3, aes(label = Total), size = 2.6) +
  theme_bw() +
  # ylim(0,100) +
  # facet_wrap(~name) +
  labs(x = "Risk Category", y = "Count", title = "Santa Barbara Distribution of Assessments by VPRAIR Risk Category")  

ggplot(risk_df) +
  aes(x = as.factor(vprair_risk_score), y = value) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3, aes(label = paste0(value, "%")), size = 2.6) +
  theme_bw() +
  ylim(0,100) +
  facet_wrap(~name) +
  labs(x = "Risk Category", y = "Percent", title = "Santa Barbara VPRAIR Outcomes by Risk Category")
```
\newpage

Sonoma
\newline
```{r}
risk_df <- eval_df %>%
  filter(tool_name == "psa", county == "Sonoma") %>%
  group_by(psa_fta_risk_score) %>%
  summarise(across(c(fta_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag) 

names(risk_df)[1] <- "psa_risk_score"

risk_df2 <- eval_df %>%
  filter(tool_name == "psa", county == "Sonoma") %>%
  group_by(psa_nca_risk_score) %>%
  summarise(across(c(recid_arrested_flag, recid_filed_flag, recid_convicted_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[1] <- "psa_risk_score"

risk_df3 <- eval_df %>%
  filter(tool_name == "psa", !is.na(psa_nvca_risk_score), county == "Sonoma") %>%
  group_by(psa_nvca_risk_score) %>%
  summarise(across(c(recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[1] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

ggplot(risk_df %>%
         filter(!name %in% c("New Filing", "New Conviction")) %>%
         mutate(name = case_when(name == "FTA" ~ "PSA FTA Risk Score",
                                 name == "New Arrest" ~ "PSA NCA Risk Score",
                                 name == "New Violent Arrest" ~ "PSA NVCA Risk Score"))) +
  aes(x = as.factor(psa_risk_score), y = Total) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3, aes(label = Total), size = 2.6) +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Count", title = "Sonoma Distribution of Assessments by PSA Risk Category")  
  
ggplot(risk_df) +
  aes(x = as.factor(psa_risk_score), y = value) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3, aes(label = paste0(value, "%")), size = 2.6) +
  theme_bw() +
  ylim(0,100) +
  # scale_x_discrete(limits = 1:6) +
  facet_wrap(~name, scales = "free_x") +
  labs(x = "Risk Category", y = "Percent", title = "Sonoma PSA Outcomes by Risk Category")

# risk_df %>%
#   distinct(psa_risk_score, Total)
```
\newpage

Ventura
\newline
```{r}
risk_df <- eval_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "oras", !is.na(oras_risk_score), county == "Ventura") %>%
  group_by(oras_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing",
                                        "New Conviction", "New Violent Arrest")))
  
ggplot(risk_df %>% distinct(oras_risk_score, Total)) +
  aes(x = as.factor(oras_risk_score), y = Total) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3, aes(label = Total), size = 2.6) +
  theme_bw() +
  # ylim(0,100) +
  # facet_wrap(~name) +
  labs(x = "Risk Category", y = "Count", title = "Ventura Distribution of Assessments by ORAS Risk Category") 

ggplot(risk_df) +
  aes(x = oras_risk_score, y = value) +
  geom_col(fill = "blue") +
  geom_text(vjust = -.3,aes(label = paste0(value, "%")), size = 3) +
  theme_bw() +
  ylim(0,100) +
  facet_wrap(~name) +
  labs(x = "Risk Category", y = "Percent", title = "Ventura ORAS Outcomes by Risk Category")



```
\newpage

# Logistic Regression

VPRAI
\newline
```{r, results='asis'}
m1 <- glm(family = binomial(),fta_flag ~ vprai_risk_score + release_to_pretrial_end , data = eval_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprai_risk_score + release_to_pretrial_end , data = eval_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprai_risk_score + release_to_pretrial_end , data = eval_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprai_risk_score + release_to_pretrial_end , data = eval_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprai_risk_score + release_to_pretrial_end , data = eval_df)

stargazer(list(m1,m2,m3,m4,m5),
          # type = "text", 
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("VPRAI Risk Score", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F)
```
\newpage

VPRAI-R
\newline
```{r, results='asis'}
m1 <- glm(family = binomial(),fta_flag ~ vprair_risk_score + release_to_pretrial_end , data = eval_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprair_risk_score + release_to_pretrial_end , data = eval_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprair_risk_score + release_to_pretrial_end , data = eval_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprair_risk_score + release_to_pretrial_end , data = eval_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprair_risk_score + release_to_pretrial_end , data = eval_df)

stargazer(list(m1,m2,m3,m4,m5),
          # type = "text", 
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("VPRAIR Risk Score", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F)
```
\newpage

ORAS
\newline
```{r, results='asis'}
m1 <- glm(family = binomial(),fta_flag ~ oras_risk_score + release_to_pretrial_end , data = eval_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ oras_risk_score + release_to_pretrial_end , data = eval_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ oras_risk_score + release_to_pretrial_end , data = eval_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ oras_risk_score + release_to_pretrial_end , data = eval_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ oras_risk_score + release_to_pretrial_end , data = eval_df)

stargazer(list(m1,m2,m3,m4,m5),
          # type = "text", 
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("ORAS Risk Score", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F)
```
\newpage

PSA
\newline
```{r, results='asis'}
m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score + release_to_pretrial_end , data = eval_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score + release_to_pretrial_end , data = eval_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score + release_to_pretrial_end , data = eval_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score + release_to_pretrial_end , data = eval_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score + release_to_pretrial_end , data = eval_df)

stargazer(list(m1,m2,m3,m4,m5),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", "PSA NVCA Risk Score", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F)
```
\newpage

Alameda
\newline
```{r, results='asis'}
county_df <- eval_df %>%
  filter(county == "Alameda")

m1 <- glm(family = binomial(),fta_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)

stargazer(list(m1,m2,m3,m4,m5),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("VPRAIR Risk Score", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F)
```
\newpage

Los Angeles
\newline
```{r, results='asis'}
county_df <- eval_df %>%
  filter(county == "Los Angeles")

m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score + release_to_pretrial_end , data = county_df)

stargazer(list(m1,m2,m3,m4,m5),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", "PSA NVCA Risk Score", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F)
```
\newpage

Sacramento
\newline
```{r, results='asis'}
county_df <- eval_df %>%
  filter(county == "Sacramento")

m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score + release_to_pretrial_end , data = county_df)

stargazer(list(m1,m2,m3,m4,m5),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", "PSA NVCA Risk Score", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F)
```
\newpage

San Joaquin
\newline
```{r, results='asis'}
county_df <- eval_df %>%
  filter(county == "San Joaquin")

m1 <- glm(family = binomial(),fta_flag ~ vprai_risk_score + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprai_risk_score + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprai_risk_score + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprai_risk_score + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprai_risk_score + release_to_pretrial_end , data = county_df)

stargazer(list(m1,m2,m3,m4,m5),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("VPRAI Risk Score", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F)
```
\newpage

Santa Barbara
\newline
```{r, results='asis'}
county_df <- eval_df %>%
  filter(county == "Santa Barbara")

m1 <- glm(family = binomial(),fta_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprair_risk_score + release_to_pretrial_end , data = county_df)

stargazer(list(m1,m2,m3,m4,m5),
          # type = "text", 
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("VPRAIR Risk Score", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F)
```
\newpage

Sonoma
\newline
```{r, results='asis'}
county_df <- eval_df %>%
  filter(county == "Sonoma")

m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score + release_to_pretrial_end , data = county_df)

stargazer(list(m1,m2,m3,m4,m5),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", "PSA NVCA Risk Score", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F)
```
\newpage

Ventura
\newline
```{r, results='asis'}
county_df <- eval_df %>%
  filter(county == "Ventura")

m1 <- glm(family = binomial(),fta_flag ~ oras_risk_score + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ oras_risk_score + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ oras_risk_score + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ oras_risk_score + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ oras_risk_score + release_to_pretrial_end , data = county_df)

stargazer(list(m1,m2,m3,m4,m5),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("ORAS Risk Score", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F)
```
\newpage

# AUCs
```{r include=FALSE}
auc_df <- read.xlsx("G:/CrimJustice/PretrialAssessmentPilot/AUCs by Demographic Category.xlsx")
```

VPRAI
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "vprai", race == "All", sex == "All", county == "All") %>%
  select(outcome, AUC, CI, n) %>%
  mutate(outcome = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest", "FTA or New Arrest"))

names(tool_df) <- c("Outcome", "AUC", "CI (95%)", "N")

kable(tool_df %>% select(-starts_with("N")), booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12,
                  latex_options = "hold_position") %>%
  add_footnote(paste("N =", tool_df$N[1]))
  
```
\newpage

VPRAI-R
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "vprair", race == "All", sex == "All", county == "All") %>%
  select(outcome, AUC, CI, n) %>%
  mutate(outcome = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest", "FTA or New Arrest"))

names(tool_df) <- c("Outcome", "AUC", "CI (95%)", "N")

kable(tool_df %>% select(-starts_with("N")), booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, 
                  latex_options = "hold_position") %>%
  add_footnote(paste("N =", tool_df$N[1]))
```
\newpage

ORAS
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "oras", race == "All", sex == "All", county == "All") %>%
  select(outcome, AUC, CI, n) %>%
  mutate(outcome = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest", "FTA or New Arrest"))

names(tool_df) <- c("Outcome", "AUC", "CI (95%)", "N")

kable(tool_df %>% select(-starts_with("N")), booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, 
                  latex_options = "hold_position") %>%
  add_footnote(paste("N =", tool_df$N[1]))
```
\newpage

PSA
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "psa", race == "All", sex == "All", county == "All") %>%
  select(risk_score, outcome, AUC, CI, n) %>%
  mutate(risk_score = c("PSA FTA", rep("PSA NCA",3), "PSA NVCA"),
         outcome = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))

names(tool_df) <- c("Risk Score", "Outcome", "AUC", "CI (95%)", "N")

kable(tool_df %>% select(-starts_with("N")), booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, 
                  latex_options = "hold_position") %>%
  add_footnote(paste("N =", tool_df$N[1]))
```
\newpage

Alameda
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "vprair", race == "All", sex == "All", county == "Alameda") %>%
  select(outcome, AUC, CI, n) %>%
  mutate(outcome = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest", "FTA or New Arrest"))

names(tool_df) <- c("Outcome", "AUC", "CI (95%)", "N")

kable(tool_df %>% select(-starts_with("N")), booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12,
                  latex_options = "hold_position") %>%
  add_footnote(paste("N =", tool_df$N[1]))
```
\newpage

Los Angeles
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "psa", race == "All", sex == "All", county == "Los Angeles") %>%
  select(risk_score, outcome, AUC, CI, n) %>%
  mutate(risk_score = c("PSA FTA", rep("PSA NCA",3), "PSA NVCA"),
         outcome = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))

names(tool_df) <- c("Risk Score", "Outcome", "AUC", "CI (95%)", "N")

kable(tool_df %>% select(-starts_with("N")), booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12,
                  latex_options = "hold_position") %>%
  add_footnote(paste("N =", tool_df$N[1]))
```
\newpage

Sacramento
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "psa", race == "All", sex == "All", county == "Sacramento") %>%
  select(risk_score, outcome, AUC, CI, n) %>%
  mutate(risk_score = c("PSA FTA", rep("PSA NCA",3), "PSA NVCA"),
         outcome = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))

names(tool_df) <- c("Risk Score", "Outcome", "AUC", "CI (95%)", "N")

kable(tool_df %>% select(-starts_with("N")), booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, 
                  latex_options = "hold_position") %>%
  add_footnote(paste("N =", tool_df$N[1]))
```
\newpage

San Joaquin
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "vprai", race == "All", sex == "All", county == "San Joaquin") %>%
  select(outcome, AUC, CI, n) %>%
  mutate(outcome = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest", "FTA or New Arrest"))

names(tool_df) <- c("Outcome", "AUC", "CI (95%)", "N")

kable(tool_df %>% select(-starts_with("N")), booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, 
                  latex_options = "hold_position") %>%
  add_footnote(paste("N =", tool_df$N[1]))
```
\newpage

Santa Barbara
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "vprair", race == "All", sex == "All", county == "Santa Barbara") %>%
  select(outcome, AUC, CI, n) %>%
  mutate(outcome = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest", "FTA or New Arrest"))

names(tool_df) <- c("Outcome", "AUC", "CI (95%)", "N")

kable(tool_df %>% select(-starts_with("N")), booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, 
                  latex_options = "hold_position") %>%
  add_footnote(paste("N =", tool_df$N[1]))

```
\newpage

Sonoma
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "psa", race == "All", sex == "All", county == "Sonoma") %>%
  select(risk_score, outcome, AUC, CI, n) %>%
  mutate(risk_score = c("PSA FTA", rep("PSA NCA",3), "PSA NVCA"),
         outcome = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))

names(tool_df) <- c("Risk Score", "Outcome", "AUC", "CI (95%)", "N")

kable(tool_df %>% select(-starts_with("N")), booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, 
                  latex_options = "hold_position") %>%
  add_footnote(paste("N =", tool_df$N[1]))
```
\newpage

Ventura
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "oras", race == "All", sex == "All", county == "Ventura") %>%
  select(outcome, AUC, CI, n) %>%
  mutate(outcome = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest", "FTA or New Arrest"))

names(tool_df) <- c("Outcome", "AUC", "CI (95%)", "N")

kable(tool_df %>% select(-starts_with("N")), booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray", font_size = 12, 
                  latex_options = "hold_position") %>%
  add_footnote(paste("N =", tool_df$N[1]))
```
\newpage

# Race Table
```{r include=FALSE}
race_df <- eval_df %>%
  mutate(race = factor(race, levels = c("White", "Black", "Hispanic", "Other_Unknown"))) %>%
  filter(race != "Other_Unknown")
```

# Race Risk Distributions
ORAS
\newline
```{r}
risk_df <- race_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "oras", !is.na(oras_risk_score)) %>%
  group_by(race, oras_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing",
                                        "New Conviction", "New Violent Arrest")))
  
ggplot(risk_df %>% distinct(oras_risk_score, Total, race)) +
  aes(x = as.factor(oras_risk_score), y = Total, fill = race) +
  geom_col(position = "dodge") +
  geom_text(vjust = -.3, aes(label = Total), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +
  labs(x = "Risk Category", y = "Count", title = "Distribution of Assessments by ORAS Risk Category")
```
\newpage

VPRAI
\newline
```{r}
risk_df <- race_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "vprai", !is.na(vprai_risk_score)) %>%
  group_by(race, vprai_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

ggplot(risk_df %>% distinct(vprai_risk_score, Total)) +
  aes(x = as.factor(vprai_risk_score), y = Total, fill = race) +
  geom_col(position = "dodge") +
  geom_text(vjust = -.3, aes(label = Total), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +
  labs(x = "Risk Category", y = "Count", title = "Distribution of Assessments by VPRAI Risk Category")    

```
\newpage

VPRAI-R
\newline
```{r}
risk_df <- race_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "vprair", !is.na(vprair_risk_score)) %>%
  group_by(race, vprair_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))
  
ggplot(risk_df %>% distinct(vprair_risk_score, Total)) +
  aes(x = as.factor(vprair_risk_score), y = Total, fill = race) +
  geom_col(position = "dodge") +
  theme_bw() +
  geom_text(vjust = -.3, aes(label = Total), size = 2.6, position = position_dodge(width = .9)) +
  labs(x = "Risk Category", y = "Count", title = "Distribution of Assessments by VPRAIR Risk Category")  
```
\newpage

PSA
\newline
```{r, fig.height = 7, fig.widith = 3}
risk_df <- race_df %>%
  filter(tool_name == "psa") %>%
  group_by(race, psa_fta_risk_score) %>%
  summarise(across(c(fta_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag) 

names(risk_df)[2] <- "psa_risk_score"

risk_df2 <- race_df %>%
  filter(tool_name == "psa") %>%
  group_by(race, psa_nca_risk_score) %>%
  summarise(across(c(recid_arrested_flag, recid_filed_flag, recid_convicted_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[2] <- "psa_risk_score"

risk_df3 <- race_df %>%
  filter(tool_name == "psa", !is.na(psa_nvca_risk_score)) %>%
  group_by(race, psa_nvca_risk_score) %>%
  summarise(across(c(recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[2] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

ggplot(risk_df %>%
         filter(!name %in% c("New Filing", "New Conviction")) %>%
         mutate(name = case_when(name == "FTA" ~ "PSA FTA Risk Score",
                                 name == "New Arrest" ~ "PSA NCA Risk Score",
                                 name == "New Violent Arrest" ~ "PSA NVCA Risk Score"))) +
  aes(x = as.factor(psa_risk_score), y = Total, fill = race) +
  geom_col(position = "dodge") +
  geom_text(vjust = -.3, aes(label = Total), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +
  facet_wrap(~name, scales = "free", ncol = 1) +
  labs(x = "Risk Category", y = "Count", title = "Distribution of Assessments by PSA Risk Category") +
  scale_y_continuous(expand = expansion(mult = c(.1, .15)))
```
\newpage

Alameda
\newline
```{r}
risk_df <- race_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "vprair", !is.na(vprair_risk_score), county == "Alameda") %>%
  group_by(race, vprair_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

ggplot(risk_df %>% distinct(vprair_risk_score, Total)) +
  aes(x = as.factor(vprair_risk_score), y = Total, fill = race) +
  geom_col(position = "dodge") +
  geom_text(vjust = -.3, aes(label = Total), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +
  labs(x = "Risk Category", y = "Count", title = "Alameda Distribution of Assessments by VPRAIR Risk Category")  
```
\newpage

Los Angeles
\newline
```{r, fig.height = 7, fig.widith = 3}
risk_df <- race_df %>%
  filter(tool_name == "psa", county == "Los Angeles") %>%
  group_by(race, psa_fta_risk_score) %>%
  summarise(across(c(fta_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag) 

names(risk_df)[2] <- "psa_risk_score"

risk_df2 <- race_df %>%
  filter(tool_name == "psa", county == "Los Angeles") %>%
  group_by(race, psa_nca_risk_score) %>%
  summarise(across(c(recid_arrested_flag, recid_filed_flag, recid_convicted_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[2] <- "psa_risk_score"

risk_df3 <- race_df %>%
  filter(tool_name == "psa", !is.na(psa_nvca_risk_score), county == "Los Angeles") %>%
  group_by(race, psa_nvca_risk_score) %>%
  summarise(across(c(recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[2] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

ggplot(risk_df %>%
         filter(!name %in% c("New Filing", "New Conviction")) %>%
         mutate(name = case_when(name == "FTA" ~ "PSA FTA Risk Score",
                                 name == "New Arrest" ~ "PSA NCA Risk Score",
                                 name == "New Violent Arrest" ~ "PSA NVCA Risk Score"))) +
  aes(x = as.factor(psa_risk_score), y = Total, fill = race) +
  geom_col(position = "dodge") +
  geom_text(vjust = -.3, aes(label = Total), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free", ncol = 1) +
  labs(x = "Risk Category", y = "Count", title = "Los Angeles Distribution of Assessments by PSA Risk Category") +
  scale_y_continuous(expand = expansion(mult = c(.1, .15)))
```
\newpage

Sacramento
\newline
```{r, fig.height = 7, fig.widith = 3}
risk_df <- race_df %>%
  filter(tool_name == "psa", county == "Sacramento") %>%
  group_by(race, psa_fta_risk_score) %>%
  summarise(across(c(fta_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag) 

names(risk_df)[2] <- "psa_risk_score"

risk_df2 <- race_df %>%
  filter(tool_name == "psa", county == "Sacramento") %>%
  group_by(race, psa_nca_risk_score) %>%
  summarise(across(c(recid_arrested_flag, recid_filed_flag, recid_convicted_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[2] <- "psa_risk_score"

risk_df3 <- race_df %>%
  filter(tool_name == "psa", !is.na(psa_nvca_risk_score), county == "Sacramento") %>%
  group_by(race, psa_nvca_risk_score) %>%
  summarise(across(c(recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[2] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

ggplot(risk_df %>%
         filter(!name %in% c("New Filing", "New Conviction")) %>%
         mutate(name = case_when(name == "FTA" ~ "PSA FTA Risk Score",
                                 name == "New Arrest" ~ "PSA NCA Risk Score",
                                 name == "New Violent Arrest" ~ "PSA NVCA Risk Score"))) +
  aes(x = as.factor(psa_risk_score), y = Total, fill = race) +
  geom_col(position = "dodge") +
  geom_text(vjust = -.3, aes(label = Total), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +
  facet_wrap(~name, scales = "free", ncol = 1) +
  labs(x = "Risk Category", y = "Count", title = "Sacramento Distribution of Assessments by PSA Risk Category") +
  scale_y_continuous(expand = expansion(mult = c(.1, .15))) 
```
\newpage

San Joaquin
\newline
```{r}
risk_df <- race_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "vprai", !is.na(vprai_risk_score), county == "San Joaquin") %>%
  group_by(race, vprai_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

ggplot(risk_df %>% distinct(vprai_risk_score, Total)) +
  aes(x = as.factor(vprai_risk_score), y = Total, fill = race) +
  geom_col(position = "dodge") +
  geom_text(vjust = -.3, aes(label = Total), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +
  labs(x = "Risk Category", y = "Count", title = "San Joaquin Distribution of Assessments by VPRAI Risk Category")    
```
\newpage

Santa Barbara
\newline
```{r}
risk_df <- race_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "vprair", !is.na(vprair_risk_score), county == "Santa Barbara") %>%
  group_by(race, vprair_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

ggplot(risk_df %>% distinct(vprair_risk_score, Total)) +
  aes(x = as.factor(vprair_risk_score), y = Total, fill = race) +
  geom_col(position = "dodge") +
  geom_text(vjust = -.3, aes(label = Total), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +
  labs(x = "Risk Category", y = "Count", title = "Santa Barbara Distribution of Assessments by VPRAIR Risk Category")  
```
\newpage

Sonoma
\newline
```{r, fig.height = 7, fig.widith = 3}
risk_df <- race_df %>%
  filter(tool_name == "psa", county == "Sonoma") %>%
  group_by(race, psa_fta_risk_score) %>%
  summarise(across(c(fta_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag) 

names(risk_df)[2] <- "psa_risk_score"

risk_df2 <- race_df %>%
  filter(tool_name == "psa", county == "Sonoma") %>%
  group_by(race, psa_nca_risk_score) %>%
  summarise(across(c(recid_arrested_flag, recid_filed_flag, recid_convicted_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[2] <- "psa_risk_score"

risk_df3 <- race_df %>%
  filter(tool_name == "psa", !is.na(psa_nvca_risk_score), county == "Sonoma") %>%
  group_by(race, psa_nvca_risk_score) %>%
  summarise(across(c(recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[2] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

ggplot(risk_df %>%
         filter(!name %in% c("New Filing", "New Conviction")) %>%
         mutate(name = case_when(name == "FTA" ~ "PSA FTA Risk Score",
                                 name == "New Arrest" ~ "PSA NCA Risk Score",
                                 name == "New Violent Arrest" ~ "PSA NVCA Risk Score"))) +
  aes(x = as.factor(psa_risk_score), y = Total, fill = race) +
  geom_col(position = "dodge") +
  geom_text(vjust = -.3, aes(label = Total), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free", ncol = 1) +
  labs(x = "Risk Category", y = "Count", title = "Sonoma Distribution of Assessments by PSA Risk Category") +
  scale_y_continuous(expand = expansion(mult = c(.1, .15)))
```
\newpage

Ventura
\newline
```{r}
risk_df <- race_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "oras", !is.na(oras_risk_score), county == "Ventura") %>%
  group_by(race, oras_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing",
                                        "New Conviction", "New Violent Arrest")))
  
ggplot(risk_df %>% distinct(oras_risk_score, Total)) +
  aes(x = as.factor(oras_risk_score), y = Total, fill = race) +
  geom_col(position = "dodge") +
  geom_text(vjust = -.3, aes(label = Total), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +
  labs(x = "Risk Category", y = "Count", title = "Ventura Distribution of Assessments by ORAS Risk Category") 
```
\newpage
# Race Logistic Regression Graphs


VPRAI
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  mutate(race = factor(race, levels = c("White", "Black", "Hispanic", "Other_Unknown"))) %>%
  filter(tool_name == "vprai", !is.na(vprai_risk_score)) %>%
  group_by(vprai_risk_score, race) %>%
  select(vprai_risk_score, race, fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag,
         any_pretrial_failure_flag, recid_arrest_violent_psa_flag) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) %>%
  filter(race %in% c("White", "Black", "Hispanic")) 
  # filter(county %in% c("Los Angeles", "Sacramento"))

ggplot(risk_df) +
  aes(x = vprai_risk_score, y = value, color = race) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free_y") +
  labs(x = "Risk Category", y = "Percent", title = "Comparison of Racial Differences in Logistic Regression Curves--VPRAI") +
  scale_x_continuous(breaks = 1:5)
```
\newpage

PSA
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  filter(tool_name == "psa") %>%
  group_by(psa_fta_risk_score, race, county) %>%
  select(fta_flag) %>%
  pivot_longer(fta_flag) 

names(risk_df)[1] <- "psa_risk_score"

risk_df2 <- eval_df %>%
  filter(tool_name == "psa") %>%
  group_by(psa_nca_risk_score, race, county) %>%
  select(recid_arrested_flag, recid_filed_flag, recid_convicted_flag) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[1] <- "psa_risk_score"

risk_df3 <- eval_df %>%
  filter(tool_name == "psa", !is.na(psa_nvca_risk_score)) %>%
  group_by(psa_nvca_risk_score, race, county) %>%
  select(recid_arrest_violent_psa_flag) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[1] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(race = factor(race, levels = c("White", "Black", "Hispanic", "Other_Unknown"))) %>%
  filter(race %in% c("White", "Black", "Hispanic")) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) %>%
  filter(county %in% c("Los Angeles", "Sacramento"))

ggplot(risk_df) +
  aes(x = psa_risk_score, y = value, color = race) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_grid(county~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent", title = "Comparison of Racial Differences in Logistic Regression Curves--PSA") +
  scale_x_continuous(breaks = 1:6)

# eval_df %>%
#   filter(tool_name == "psa") %>%
#   count(county)
```
\newpage

San Joaquin
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  filter(county == "San Joaquin") %>%
  mutate(race = factor(race, levels = c("White", "Black", "Hispanic", "Other_Unknown"))) %>%
  filter(tool_name == "vprai", !is.na(vprai_risk_score)) %>%
  group_by(vprai_risk_score, race) %>%
  select(vprai_risk_score, race, fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag,
         any_pretrial_failure_flag, recid_arrest_violent_psa_flag) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) %>%
  filter(race %in% c("White", "Black", "Hispanic")) 

ggplot(risk_df) +
  aes(x = vprai_risk_score, y = value, color = race) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free_y") +
  labs(x = "Risk Category", y = "Percent",
       title = "Comparison of Racial Differences in Logistic Regression Curves--VPRAI, San Joaquin") +
  scale_x_continuous(breaks = 1:5)

# eval_df %>%
#   filter(tool_name == "vprai") %>%
#   count(county)
```
\newpage

Los Angeles
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  filter(county == "Los Angeles") %>%
  filter(tool_name == "psa") %>%
  group_by(psa_fta_risk_score, race, county) %>%
  select(fta_flag) %>%
  pivot_longer(fta_flag) 

names(risk_df)[1] <- "psa_risk_score"

risk_df2 <- eval_df %>%
  filter(county == "Los Angeles") %>%
  filter(tool_name == "psa") %>%
  group_by(psa_nca_risk_score, race, county) %>%
  select(recid_arrested_flag, recid_filed_flag, recid_convicted_flag) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[1] <- "psa_risk_score"

risk_df3 <- eval_df %>%
  filter(county == "Los Angeles") %>%
  filter(tool_name == "psa", !is.na(psa_nvca_risk_score)) %>%
  group_by(psa_nvca_risk_score, race, county) %>%
  select(recid_arrest_violent_psa_flag) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[1] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(race = factor(race, levels = c("White", "Black", "Hispanic", "Other_Unknown"))) %>%
  filter(race %in% c("White", "Black", "Hispanic")) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) %>%
  filter(county %in% c("Los Angeles", "Sacramento"))

ggplot(risk_df) +
  aes(x = psa_risk_score, y = value, color = race) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent",
       title = "Comparison of Racial Differences in Logistic Regression Curves--PSA, Los Angeles") +
  scale_x_continuous(breaks = 1:6)

# eval_df %>%
#   filter(tool_name == "psa") %>%
#   count(county)
```
\newpage

Sacramento
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  filter(county == "Sacramento") %>%
  filter(tool_name == "psa") %>%
  group_by(psa_fta_risk_score, race, county) %>%
  select(fta_flag) %>%
  pivot_longer(fta_flag) 

names(risk_df)[1] <- "psa_risk_score"

risk_df2 <- eval_df %>%
  filter(county == "Sacramento") %>%
  filter(tool_name == "psa") %>%
  group_by(psa_nca_risk_score, race, county) %>%
  select(recid_arrested_flag, recid_filed_flag, recid_convicted_flag) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[1] <- "psa_risk_score"

risk_df3 <- eval_df %>%
  filter(county == "Sacramento") %>%
  filter(tool_name == "psa", !is.na(psa_nvca_risk_score)) %>%
  group_by(psa_nvca_risk_score, race, county) %>%
  select(recid_arrest_violent_psa_flag) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[1] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(race = factor(race, levels = c("White", "Black", "Hispanic", "Other_Unknown"))) %>%
  filter(race %in% c("White", "Black", "Hispanic")) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) %>%
  filter(county %in% c("Los Angeles", "Sacramento"))

ggplot(risk_df) +
  aes(x = psa_risk_score, y = value, color = race) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent", title = "Comparison of Racial Differences in Logistic Regression Curves--PSA, Sacramento") +
  scale_x_continuous(breaks = 1:6)

# eval_df %>%
#   filter(tool_name == "psa") %>%
#   count(county)
```
\newpage

# Race Logistic Regression Tables

VPRAI--Without Interactions
\newline
```{r results='asis'}
m1 <- glm(family = binomial(),fta_flag ~ vprai_risk_score + race + release_to_pretrial_end, data = race_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprai_risk_score + race + release_to_pretrial_end, data = race_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprai_risk_score + race + release_to_pretrial_end, data = race_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprai_risk_score + race + release_to_pretrial_end, data = race_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprai_risk_score + race + release_to_pretrial_end, data = race_df)

stargazer(list(m1,m2,m3,m4,m5),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("VPRAI Risk Score", "Race:Black", "Race:Hispanic", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F)
```
\newpage

VPRAI--With Interactions
\newline
```{r results='asis'}
m1 <- glm(family = binomial(),fta_flag ~ vprai_risk_score * race + release_to_pretrial_end, data = race_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprai_risk_score * race + release_to_pretrial_end, data = race_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprai_risk_score * race + release_to_pretrial_end, data = race_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprai_risk_score * race + release_to_pretrial_end, data = race_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprai_risk_score * race + release_to_pretrial_end, data = race_df)

stargazer(list(m1,m2,m3,m4,m5),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("VPRAI Risk Score", "Race:Black", "Race:Hispanic",
                               "Days Released", "VPRAI*Black", "VPRAI*Hispanic"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F)
```
\newpage

PSA--Without Interactions
\newline
```{r, results='asis'}
m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score + race + release_to_pretrial_end , data = race_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score + race + release_to_pretrial_end , data = race_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score + race + release_to_pretrial_end , data = race_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score + race + release_to_pretrial_end , data = race_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score + race + release_to_pretrial_end , data = race_df)

stargazer(list(m1,m2,m3,m4,m5),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", 
                               "PSA NVCA Risk Score", "Race:Black", "Race:Hispanic", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F)
```
\newpage

PSA--With Interactions
\newline
```{r, results='asis'}
m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score * race + release_to_pretrial_end , data = race_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score * race + release_to_pretrial_end , data = race_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score * race + release_to_pretrial_end , data = race_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score * race + release_to_pretrial_end , data = race_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score * race + release_to_pretrial_end , data = race_df)

stargazer(list(m1,m2,m3,m4,m5),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", "PSA NVCA Risk Score", 
                               "Race:Black", "Race:Hispanic", "Days Released", "FTA*Black", "FTA*Hispanic",
                               "NCA*Black", "NCA*Hispanic", "NVCA*Black", "NVCA*Hispanic"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F)
```
\newpage

San Joaquin--Without Interactions
\newline
```{r results='asis'}
county_df <- race_df %>%
  filter(county == "San Joaquin")

m1 <- glm(family = binomial(),fta_flag ~ vprai_risk_score + race + release_to_pretrial_end, data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprai_risk_score + race + release_to_pretrial_end, data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprai_risk_score + race + release_to_pretrial_end, data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprai_risk_score + race + release_to_pretrial_end, data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprai_risk_score + race + release_to_pretrial_end, data = county_df)

stargazer(list(m1,m2,m3,m4,m5),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("VPRAI Risk Score", "Race:Black", "Race:Hispanic", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F)
```
\newpage

San Joaquin--With Interactions
\newline
```{r results='asis'}
county_df <- race_df %>%
  filter(county == "San Joaquin")

m1 <- glm(family = binomial(),fta_flag ~ vprai_risk_score * race + release_to_pretrial_end, data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprai_risk_score * race + release_to_pretrial_end, data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprai_risk_score * race + release_to_pretrial_end, data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprai_risk_score * race + release_to_pretrial_end, data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprai_risk_score * race + release_to_pretrial_end, data = county_df)

stargazer(list(m1,m2,m3,m4,m5),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("VPRAI Risk Score", "Race:Black", "Race:Hispanic",
                               "Days Released", "VPRAI*Black", "VPRAI*Hispanic"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F)
```
\newpage

Los Angeles--Without Interactions
\newline
```{r, results='asis'}
county_df <- race_df %>%
  filter(county == "Los Angeles")

m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score + race + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score + race + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score + race + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score + race + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score + race + release_to_pretrial_end , data = county_df)

stargazer(list(m1,m2,m3,m4,m5),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", 
                               "PSA NVCA Risk Score", "Race:Black", "Race:Hispanic", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F)
```
\newpage

Los Angeles--With Interactions
\newline
```{r, results='asis'}
county_df <- race_df %>%
  filter(county == "Los Angeles")

m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score * race + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score * race + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score * race + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score * race + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score * race + release_to_pretrial_end , data = county_df)

stargazer(list(m1,m2,m3,m4,m5),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", "PSA NVCA Risk Score",
                               "Race:Black", "Race:Hispanic", "Days Released", "FTA*Black", "FTA*Hispanic",
                               "NCA*Black", "NCA*Hispanic", "NVCA*Black", "NVCA*Hispanic"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F)
```
\newpage

Sacramento--Without Interactions
\newline
```{r, results='asis'}
county_df <- race_df %>%
  filter(county == "Sacramento")

m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score + race + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score + race + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score + race + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score + race + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score + race + release_to_pretrial_end , data = county_df)

stargazer(list(m1,m2,m3,m4,m5),
        # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", 
                               "PSA NVCA Risk Score", "Race:Black", "Race:Hispanic", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F)
```
\newpage

Sacramento--With Interactions
\newline
```{r, results='asis'}
county_df <- race_df %>%
  filter(county == "Sacramento")

m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score * race + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score * race + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score * race + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score * race + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score * race + release_to_pretrial_end , data = county_df)

stargazer(list(m1,m2,m3,m4,m5),
        # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", "PSA NVCA Risk Score", 
                               "Race:Black", "Race:Hispanic", "Days Released", "FTA*Black", "FTA*Hispanic",
                               "NCA*Black", "NCA*Hispanic", "NVCA*Black", "NVCA*Hispanic"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F)
```
\newpage

# Race AUCs

VPRAI
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "vprai", race != "All", sex == "All", county == "All") %>%
  select(race, outcome, AUC, CI, n) %>%
  mutate(outcome = rep(c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 3))

names(tool_df) <- c("race", "Outcome", "AUC", "CI (95%)", "N")

tool_df <- tool_df %>%
  pivot_wider(names_from = race, values_from = c(AUC, `CI (95%)`, N))

names(tool_df) <- gsub("AUC_|CI .*_", "", names(tool_df))

kable(tool_df[1:7], booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray",
                  font_size = 10, latex_options = "hold_position") %>%
  add_header_above(c(" " = 1, "AUC" = 3, "CI (95%)" = 3)) %>% 
  add_footnote(paste("N White =", tool_df$N_White[1], ", N Black =", 
                     tool_df$N_Black[1], ", N Hispanic =", tool_df$N_Hispanic[1]))
```
\newpage

PSA
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "psa", race != "All", sex == "All", county == "All") %>%
  select(race, risk_score, outcome, AUC, CI, n) %>%
  mutate(risk_score = rep(c("PSA FTA", rep("PSA NCA",3), "PSA NVCA"),3),
         outcome = rep(c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"),3))

names(tool_df) <- c("race", "Risk Score", "Outcome", "AUC", "CI (95%)", "N")

tool_df <- tool_df %>%
  pivot_wider(names_from = race, values_from = c(AUC, `CI (95%)`, N))

names(tool_df) <- gsub("AUC_|CI .*_", "", names(tool_df))

kable(tool_df[1:8], booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray",
                  font_size = 10, latex_options = "hold_position") %>%
  add_header_above(c(" " = 2, "AUC" = 3, "CI (95%)" = 3)) %>% 
  add_footnote(paste("N White =", tool_df$N_White[1], ", N Black =", 
                     tool_df$N_Black[1], ", N Hispanic =", tool_df$N_Hispanic[1]))
```
\newpage

San Joaquin
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "vprai", race != "All", sex == "All", county == "San Joaquin") %>%
  select(race, outcome, AUC, CI, n) %>%
  mutate(outcome = rep(c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 3))

names(tool_df) <- c("race", "Outcome", "AUC", "CI (95%)", "N")

tool_df <- tool_df %>%
  pivot_wider(names_from = race, values_from = c(AUC, `CI (95%)`, N))

names(tool_df) <- gsub("AUC_|CI .*_", "", names(tool_df))

kable(tool_df[1:7], booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray",
                  font_size = 10, latex_options = "hold_position") %>%
  add_header_above(c(" " = 1, "AUC" = 3, "CI (95%)" = 3)) %>% 
  add_footnote(paste("N White =", tool_df$N_White[1], ", N Black =", 
                     tool_df$N_Black[1], ", N Hispanic =", tool_df$N_Hispanic[1]))
```


\newpage

Los Angeles
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "psa", race != "All", sex == "All", county == "Los Angeles") %>%
  select(race, risk_score, outcome, AUC, CI, n) %>%
  mutate(risk_score = rep(c("PSA FTA", rep("PSA NCA",3), "PSA NVCA"),3),
         outcome = rep(c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"),3))

names(tool_df) <- c("race", "Risk Score", "Outcome", "AUC", "CI (95%)", "N")

tool_df <- tool_df %>%
  pivot_wider(names_from = race, values_from = c(AUC, `CI (95%)`, N))

names(tool_df) <- gsub("AUC_|CI .*_", "", names(tool_df))

kable(tool_df[1:8], booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray",
                  font_size = 10, latex_options = "hold_position") %>%
  add_header_above(c(" " = 2, "AUC" = 3, "CI (95%)" = 3)) %>% 
  add_footnote(paste("N White =", tool_df$N_White[1], ", N Black =", 
                     tool_df$N_Black[1], ", N Hispanic =", tool_df$N_Hispanic[1]))
```
\newpage

Sacramento
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "psa", race != "All", sex == "All", county == "Sacramento") %>%
  select(race, risk_score, outcome, AUC, CI, n) %>%
  mutate(risk_score = rep(c("PSA FTA", rep("PSA NCA",3), "PSA NVCA"),3),
         outcome = rep(c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"),3))

names(tool_df) <- c("race", "Risk Score", "Outcome", "AUC", "CI (95%)", "N")

tool_df <- tool_df %>%
  pivot_wider(names_from = race, values_from = c(AUC, `CI (95%)`, N))

names(tool_df) <- gsub("AUC_|CI .*_", "", names(tool_df))

kable(tool_df[1:8], booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray",
                  font_size = 10, latex_options = "hold_position") %>%
  add_header_above(c(" " = 2, "AUC" = 3, "CI (95%)" = 3)) %>% 
  add_footnote(paste("N White =", tool_df$N_White[1], ", N Black =", 
                     tool_df$N_Black[1], ", N Hispanic =", tool_df$N_Hispanic[1]))
```
\newpage

 

# Gender Table
```{r include=FALSE}
sex_df <- eval_df %>%
  mutate(sex = factor(sex, levels = c("Male", "Female"))) %>%
  filter(sex != "Other_Unknown")
```
# Gender Risk Distributions
ORAS
\newline
```{r}
risk_df <- sex_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "oras", !is.na(oras_risk_score)) %>%
  group_by(sex, oras_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing",
                                        "New Conviction", "New Violent Arrest")))
  
ggplot(risk_df %>% distinct(oras_risk_score, Total, sex)) +
  aes(x = as.factor(oras_risk_score), y = Total, fill = sex) +
  geom_col(position = "dodge") +
  geom_text(vjust = -.3, aes(label = Total), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +
  labs(x = "Risk Category", y = "Count", title = "Distribution of Assessments by ORAS Risk Category")
```
\newpage

VPRAI
\newline
```{r}
risk_df <- sex_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "vprai", !is.na(vprai_risk_score)) %>%
  group_by(sex, vprai_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

ggplot(risk_df %>% distinct(vprai_risk_score, Total)) +
  aes(x = as.factor(vprai_risk_score), y = Total, fill = sex) +
  geom_col(position = "dodge") +
  geom_text(vjust = -.3, aes(label = Total), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +
  labs(x = "Risk Category", y = "Count", title = "Distribution of Assessments by VPRAI Risk Category")    

```
\newpage

VPRAI-R
\newline
```{r}
risk_df <- sex_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "vprair", !is.na(vprair_risk_score)) %>%
  group_by(sex, vprair_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))
  
ggplot(risk_df %>% distinct(vprair_risk_score, Total)) +
  aes(x = as.factor(vprair_risk_score), y = Total, fill = sex) +
  geom_col(position = "dodge") +
  geom_text(vjust = -.3, aes(label = Total), size = 2.6, position = position_dodge(width = .9)) +
  labs(x = "Risk Category", y = "Count", title = "Distribution of Assessments by VPRAIR Risk Category") +
  theme_bw()
```
\newpage

PSA
\newline
```{r fig.height=7}

risk_df <- sex_df %>%
  filter(tool_name == "psa") %>%
  group_by(sex, psa_fta_risk_score) %>%
  summarise(across(c(fta_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag) 

names(risk_df)[2] <- "psa_risk_score"

risk_df2 <- sex_df %>%
  filter(tool_name == "psa") %>%
  group_by(sex, psa_nca_risk_score) %>%
  summarise(across(c(recid_arrested_flag, recid_filed_flag, recid_convicted_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[2] <- "psa_risk_score"

risk_df3 <- sex_df %>%
  filter(tool_name == "psa", !is.na(psa_nvca_risk_score)) %>%
  group_by(sex, psa_nvca_risk_score) %>%
  summarise(across(c(recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[2] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

ggplot(risk_df %>%
         filter(!name %in% c("New Filing", "New Conviction")) %>%
         mutate(name = case_when(name == "FTA" ~ "PSA FTA Risk Score",
                                 name == "New Arrest" ~ "PSA NCA Risk Score",
                                 name == "New Violent Arrest" ~ "PSA NVCA Risk Score"))) +
  aes(x = as.factor(psa_risk_score), y = Total, fill = sex) +
  geom_col(position = "dodge") +
  geom_text(vjust = -.3, aes(label = Total), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +
  facet_wrap(~name, scales = "free", ncol = 1) +
  labs(x = "Risk Category", y = "Count", title = "Distribution of Assessments by PSA Risk Category") +
  scale_y_continuous(expand = expansion(mult = c(.1, .25))) 
```
\newpage

Alameda
\newline
```{r}
risk_df <- sex_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "vprair", !is.na(vprair_risk_score), county == "Alameda") %>%
  group_by(sex, vprair_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

ggplot(risk_df %>% distinct(vprair_risk_score, Total)) +
  aes(x = as.factor(vprair_risk_score), y = Total, fill = sex) +
  geom_col(position = "dodge") +
  geom_text(vjust = -.3, aes(label = Total), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +
  labs(x = "Risk Category", y = "Count", title = "Alameda Distribution of Assessments by VPRAIR Risk Category")  
```
\newpage

Los Angeles
\newline
```{r fig.height=7}
risk_df <- sex_df %>%
  filter(tool_name == "psa", county == "Los Angeles") %>%
  group_by(sex, psa_fta_risk_score) %>%
  summarise(across(c(fta_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag) 

names(risk_df)[2] <- "psa_risk_score"

risk_df2 <- sex_df %>%
  filter(tool_name == "psa", county == "Los Angeles") %>%
  group_by(sex, psa_nca_risk_score) %>%
  summarise(across(c(recid_arrested_flag, recid_filed_flag, recid_convicted_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[2] <- "psa_risk_score"

risk_df3 <- sex_df %>%
  filter(tool_name == "psa", !is.na(psa_nvca_risk_score), county == "Los Angeles") %>%
  group_by(sex, psa_nvca_risk_score) %>%
  summarise(across(c(recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[2] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

ggplot(risk_df %>%
         filter(!name %in% c("New Filing", "New Conviction")) %>%
         mutate(name = case_when(name == "FTA" ~ "PSA FTA Risk Score",
                                 name == "New Arrest" ~ "PSA NCA Risk Score",
                                 name == "New Violent Arrest" ~ "PSA NVCA Risk Score"))) +
  aes(x = as.factor(psa_risk_score), y = Total, fill = sex) +
  geom_col(position = "dodge") +
  geom_text(vjust = -.3, aes(label = Total), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free", ncol = 1) +
  labs(x = "Risk Category", y = "Count", title = "Los Angeles Distribution of Assessments by PSA Risk Category") +
  scale_y_continuous(expand = expansion(mult = c(.1, .25))) 
```
\newpage

Sacramento
\newline
```{r fig.height=7}
risk_df <- sex_df %>%
  filter(tool_name == "psa", county == "Sacramento") %>%
  group_by(sex, psa_fta_risk_score) %>%
  summarise(across(c(fta_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag) 

names(risk_df)[2] <- "psa_risk_score"

risk_df2 <- sex_df %>%
  filter(tool_name == "psa", county == "Sacramento") %>%
  group_by(sex, psa_nca_risk_score) %>%
  summarise(across(c(recid_arrested_flag, recid_filed_flag, recid_convicted_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[2] <- "psa_risk_score"

risk_df3 <- sex_df %>%
  filter(tool_name == "psa", !is.na(psa_nvca_risk_score), county == "Sacramento") %>%
  group_by(sex, psa_nvca_risk_score) %>%
  summarise(across(c(recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[2] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

ggplot(risk_df %>%
         filter(!name %in% c("New Filing", "New Conviction")) %>%
         mutate(name = case_when(name == "FTA" ~ "PSA FTA Risk Score",
                                 name == "New Arrest" ~ "PSA NCA Risk Score",
                                 name == "New Violent Arrest" ~ "PSA NVCA Risk Score"))) +
  aes(x = as.factor(psa_risk_score), y = Total, fill = sex) +
  geom_col(position = "dodge") +
  geom_text(vjust = -.3, aes(label = Total), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +
  facet_wrap(~name, scales = "free", ncol = 1) +
  labs(x = "Risk Category", y = "Count", title = "Sacramento Distribution of Assessments by PSA Risk Category") +
  scale_y_continuous(expand = expansion(mult = c(.1, .25))) 
```
\newpage

San Joaquin
\newline
```{r}
risk_df <- sex_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "vprai", !is.na(vprai_risk_score), county == "San Joaquin") %>%
  group_by(sex, vprai_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

ggplot(risk_df %>% distinct(vprai_risk_score, Total)) +
  aes(x = as.factor(vprai_risk_score), y = Total, fill = sex) +
  geom_col(position = "dodge") +
  geom_text(vjust = -.3, aes(label = Total), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +
  labs(x = "Risk Category", y = "Count", title = "San Joaquin Distribution of Assessments by VPRAI Risk Category")    
```
\newpage

Santa Barbara
\newline
```{r}
risk_df <- sex_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "vprair", !is.na(vprair_risk_score), county == "Santa Barbara") %>%
  group_by(sex, vprair_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

ggplot(risk_df %>% distinct(vprair_risk_score, Total)) +
  aes(x = as.factor(vprair_risk_score), y = Total, fill = sex) +
  geom_col(position = "dodge") +
  geom_text(vjust = -.3, aes(label = Total), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +
  labs(x = "Risk Category", y = "Count", title = "Santa Barbara Distribution of Assessments by VPRAIR Risk Category")  
```
\newpage

Sonoma
\newline
```{r fig.height=7}
risk_df <- sex_df %>%
  filter(tool_name == "psa", county == "Sonoma") %>%
  group_by(sex, psa_fta_risk_score) %>%
  summarise(across(c(fta_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag) 

names(risk_df)[2] <- "psa_risk_score"

risk_df2 <- sex_df %>%
  filter(tool_name == "psa", county == "Sonoma") %>%
  group_by(sex, psa_nca_risk_score) %>%
  summarise(across(c(recid_arrested_flag, recid_filed_flag, recid_convicted_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[2] <- "psa_risk_score"

risk_df3 <- sex_df %>%
  filter(tool_name == "psa", !is.na(psa_nvca_risk_score), county == "Sonoma") %>%
  group_by(sex, psa_nvca_risk_score) %>%
  summarise(across(c(recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[2] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest")))

ggplot(risk_df %>%
         filter(!name %in% c("New Filing", "New Conviction")) %>%
         mutate(name = case_when(name == "FTA" ~ "PSA FTA Risk Score",
                                 name == "New Arrest" ~ "PSA NCA Risk Score",
                                 name == "New Violent Arrest" ~ "PSA NVCA Risk Score"))) +
  aes(x = as.factor(psa_risk_score), y = Total, fill = sex) +
  geom_col(position = "dodge") +
  geom_text(vjust = -.3, aes(label = Total), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free", ncol = 1) +
  labs(x = "Risk Category", y = "Count", title = "Sonoma Distribution of Assessments by PSA Risk Category") +
  scale_y_continuous(expand = expansion(mult = c(.1, .25)))  
```
\newpage

Ventura
\newline
```{r}
risk_df <- sex_df %>%
   # filter(book_date <= as_date("2021-03-31"),
   #       book_date >= as_date("2019-10-01")) %>%
  filter(tool_name == "oras", !is.na(oras_risk_score), county == "Ventura") %>%
  group_by(sex, oras_risk_score) %>%
  summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag, 
                    any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
                   ~round(mean(.x)*100, 1)), Total = n()) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing",
                                        "New Conviction", "New Violent Arrest")))
  
ggplot(risk_df %>% distinct(oras_risk_score, Total)) +
  aes(x = as.factor(oras_risk_score), y = Total, fill = sex) +
  geom_col(position = "dodge") +
  geom_text(vjust = -.3, aes(label = Total), size = 2.6, position = position_dodge(width = .9)) +
  theme_bw() +
  labs(x = "Risk Category", y = "Count", title = "Ventura Distribution of Assessments by ORAS Risk Category") 
```
\newpage
# Gender Logistic Regression Graphs

VPRAI
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  mutate(sex = factor(sex, levels = c("Male", "Female"))) %>%
  filter(tool_name == "vprai", !is.na(vprai_risk_score)) %>%
  group_by(vprai_risk_score, sex) %>%
  select(vprai_risk_score, sex, fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag,
         any_pretrial_failure_flag, recid_arrest_violent_psa_flag) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) %>%
  filter(sex %in% c("Male", "Female")) 
  # filter(county %in% c("Los Angeles", "Sacramento"))

ggplot(risk_df) +
  aes(x = vprai_risk_score, y = value, color = sex) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free_y") +
  labs(x = "Risk Category", y = "Percent", title = "Comparison of Gender Differences in Logistic Regression Curves--VPRAI") +
  scale_x_continuous(breaks = 1:5)

# eval_df %>%
#   filter(tool_name == "vprai") %>%
#   count(county)
```
\newpage

PSA
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  filter(tool_name == "psa") %>%
  group_by(psa_fta_risk_score, sex, county) %>%
  select(fta_flag) %>%
  pivot_longer(fta_flag) 

names(risk_df)[1] <- "psa_risk_score"

risk_df2 <- eval_df %>%
  filter(tool_name == "psa") %>%
  group_by(psa_nca_risk_score, sex, county) %>%
  select(recid_arrested_flag, recid_filed_flag, recid_convicted_flag) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[1] <- "psa_risk_score"

risk_df3 <- eval_df %>%
  filter(tool_name == "psa", !is.na(psa_nvca_risk_score)) %>%
  group_by(psa_nvca_risk_score, sex, county) %>%
  select(recid_arrest_violent_psa_flag) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[1] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(sex = factor(sex, levels = c("Male", "Female"))) %>%
  filter(sex %in% c("Male", "Female")) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) %>%
  filter(county %in% c("Los Angeles", "Sacramento"))

ggplot(risk_df) +
  aes(x = psa_risk_score, y = value, color = sex) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_grid(county~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent", title = "Comparison of Gender Differences in Logistic Regression Curves--PSA") +
  scale_x_continuous(breaks = 1:6)

# eval_df %>%
#   filter(tool_name == "psa") %>%
#   count(county)
```
\newpage

San Joaquin
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  filter(county == "San Joaquin") %>%
  mutate(sex = factor(sex, levels = c("Male", "Female"))) %>%
  filter(tool_name == "vprai", !is.na(vprai_risk_score)) %>%
  group_by(vprai_risk_score, sex) %>%
  select(vprai_risk_score, sex, fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag,
         any_pretrial_failure_flag, recid_arrest_violent_psa_flag) %>%
  pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) %>%
  filter(sex %in% c("Male", "Female")) 

ggplot(risk_df) +
  aes(x = vprai_risk_score, y = value, color = sex) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free_y") +
  labs(x = "Risk Category", y = "Percent",
       title = "Comparison of Gender Differences in Logistic Regression Curves--VPRAI, San Joaquin") +
  scale_x_continuous(breaks = 1:5)

# eval_df %>%
#   filter(tool_name == "vprai") %>%
#   count(county)
```
\newpage

Los Angeles
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  filter(county == "Los Angeles") %>%
  filter(tool_name == "psa") %>%
  group_by(psa_fta_risk_score, sex, county) %>%
  select(fta_flag) %>%
  pivot_longer(fta_flag) 

names(risk_df)[1] <- "psa_risk_score"

risk_df2 <- eval_df %>%
  filter(county == "Los Angeles") %>%
  filter(tool_name == "psa") %>%
  group_by(psa_nca_risk_score, sex, county) %>%
  select(recid_arrested_flag, recid_filed_flag, recid_convicted_flag) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[1] <- "psa_risk_score"

risk_df3 <- eval_df %>%
  filter(county == "Los Angeles") %>%
  filter(tool_name == "psa", !is.na(psa_nvca_risk_score)) %>%
  group_by(psa_nvca_risk_score, sex, county) %>%
  select(recid_arrest_violent_psa_flag) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[1] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(sex = factor(sex, levels = c("Male", "Female"))) %>%
  filter(sex %in% c("Male", "Female")) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) %>%
  filter(county %in% c("Los Angeles"))

ggplot(risk_df) +
  aes(x = psa_risk_score, y = value, color = sex) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent", 
       title = "Comparison of Gender Differences in Logistic Regression Curves--PSA, Los Angeles") +
  scale_x_continuous(breaks = 1:6)
```
\newpage

Sacramento
\newline
```{r fig.height=6, fig.width=10, dpi=1200}
risk_df <- eval_df %>%
  filter(county == "Sacramento") %>%
  filter(tool_name == "psa") %>%
  group_by(psa_fta_risk_score, sex, county) %>%
  select(fta_flag) %>%
  pivot_longer(fta_flag) 

names(risk_df)[1] <- "psa_risk_score"

risk_df2 <- eval_df %>%
  filter(county == "Sacramento") %>%
  filter(tool_name == "psa") %>%
  group_by(psa_nca_risk_score, sex, county) %>%
  select(recid_arrested_flag, recid_filed_flag, recid_convicted_flag) %>%
  pivot_longer(recid_arrested_flag:recid_convicted_flag) 

names(risk_df2)[1] <- "psa_risk_score"

risk_df3 <- eval_df %>%
  filter(county == "Sacramento") %>%
  filter(tool_name == "psa", !is.na(psa_nvca_risk_score)) %>%
  group_by(psa_nvca_risk_score, sex, county) %>%
  select(recid_arrest_violent_psa_flag) %>%
  pivot_longer(recid_arrest_violent_psa_flag) 

names(risk_df3)[1] <- "psa_risk_score"

risk_df <- bind_rows(risk_df, risk_df2, risk_df3)
  
rm(risk_df2, risk_df3)

risk_df <- risk_df %>%
  mutate(sex = factor(sex, levels = c("Male", "Female"))) %>%
  filter(sex %in% c("Male", "Female")) %>%
  mutate(name = case_when(name == "fta_flag" ~ "FTA",
                          name == "recid_arrested_flag" ~ "New Arrest",
                          name == "recid_filed_flag" ~ "New Filing",
                          name == "recid_convicted_flag" ~ "New Conviction",
                          name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
         name = factor(name, levels = c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) %>%
  filter(county %in% c("Sacramento"))

ggplot(risk_df) +
  aes(x = psa_risk_score, y = value, color = sex) +
  geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
  # geom_line() +
  # geom_point() +
  theme_bw() +
  # ylim(0,100) +
  facet_wrap(~name, scales = "free") +
  labs(x = "Risk Category", y = "Percent", 
       title = "Comparison of Racial Differences in Logistic Regression Curves--PSA, Sacramento") +
  scale_x_continuous(breaks = 1:6)

# eval_df %>%
#   filter(tool_name == "psa") %>%
#   count(county)
```
\newpage

# Gender Logistic Regression Tables

VPRAI--Without Interactions
\newline
```{r results='asis'}
m1 <- glm(family = binomial(),fta_flag ~ vprai_risk_score + sex + release_to_pretrial_end, data = sex_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprai_risk_score + sex + release_to_pretrial_end, data = sex_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprai_risk_score + sex + release_to_pretrial_end, data = sex_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprai_risk_score + sex + release_to_pretrial_end, data = sex_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprai_risk_score + sex + release_to_pretrial_end, data = sex_df)

stargazer(list(m1,m2,m3,m4,m5),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("VPRAI Risk Score", "sex:Black", "sex:Hispanic", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F)
```
\newpage

VPRAI--With Interactions
\newline
```{r results='asis'}
m1 <- glm(family = binomial(),fta_flag ~ vprai_risk_score * sex + release_to_pretrial_end, data = sex_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprai_risk_score * sex + release_to_pretrial_end, data = sex_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprai_risk_score * sex + release_to_pretrial_end, data = sex_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprai_risk_score * sex + release_to_pretrial_end, data = sex_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprai_risk_score * sex + release_to_pretrial_end, data = sex_df)

stargazer(list(m1,m2,m3,m4,m5),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("VPRAI Risk Score", "sex:Black", "sex:Hispanic",
                               "Days Released", "VPRAI*Black", "VPRAI*Hispanic"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F)
```
\newpage

PSA--Without Interactions
\newline
```{r, results='asis'}
m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score + sex + release_to_pretrial_end , data = sex_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score + sex + release_to_pretrial_end , data = sex_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score + sex + release_to_pretrial_end , data = sex_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score + sex + release_to_pretrial_end , data = sex_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score + sex + release_to_pretrial_end , data = sex_df)

stargazer(list(m1,m2,m3,m4,m5),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", 
                               "PSA NVCA Risk Score", "sex:Black", "sex:Hispanic", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F)
```
\newpage

PSA--With Interactions
\newline
```{r, results='asis'}
m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score * sex + release_to_pretrial_end , data = sex_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score * sex + release_to_pretrial_end , data = sex_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score * sex + release_to_pretrial_end , data = sex_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score * sex + release_to_pretrial_end , data = sex_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score * sex + release_to_pretrial_end , data = sex_df)

stargazer(list(m1,m2,m3,m4,m5),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", "PSA NVCA Risk Score", 
                               "sex:Black", "sex:Hispanic", "Days Released", "FTA*Black", "FTA*Hispanic",
                               "NCA*Black", "NCA*Hispanic", "NVCA*Black", "NVCA*Hispanic"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F)
```
\newpage

San Joaquin--Without Interactions
\newline
```{r results='asis'}
county_df <- sex_df %>%
  filter(county == "San Joaquin")

m1 <- glm(family = binomial(),fta_flag ~ vprai_risk_score + sex + release_to_pretrial_end, data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprai_risk_score + sex + release_to_pretrial_end, data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprai_risk_score + sex + release_to_pretrial_end, data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprai_risk_score + sex + release_to_pretrial_end, data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprai_risk_score + sex + release_to_pretrial_end, data = county_df)

stargazer(list(m1,m2,m3,m4,m5),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("VPRAI Risk Score", "sex:Black", "sex:Hispanic", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F)
```
\newpage

San Joaquin--With Interactions
\newline
```{r results='asis'}
county_df <- sex_df %>%
  filter(county == "San Joaquin")

m1 <- glm(family = binomial(),fta_flag ~ vprai_risk_score * sex + release_to_pretrial_end, data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprai_risk_score * sex + release_to_pretrial_end, data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprai_risk_score * sex + release_to_pretrial_end, data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprai_risk_score * sex + release_to_pretrial_end, data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprai_risk_score * sex + release_to_pretrial_end, data = county_df)

stargazer(list(m1,m2,m3,m4,m5),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("VPRAI Risk Score", "sex:Black", "sex:Hispanic",
                               "Days Released", "VPRAI*Black", "VPRAI*Hispanic"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F)
```
\newpage

Los Angeles--Without Interactions
\newline
```{r, results='asis'}
county_df <- sex_df %>%
  filter(county == "Los Angeles")

m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score + sex + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score + sex + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score + sex + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score + sex + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score + sex + release_to_pretrial_end , data = county_df)

stargazer(list(m1,m2,m3,m4,m5),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", 
                               "PSA NVCA Risk Score", "sex:Black", "sex:Hispanic", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F)
```
\newpage

Los Angeles--With Interactions
\newline
```{r, results='asis'}
county_df <- sex_df %>%
  filter(county == "Los Angeles")

m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score * sex + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score * sex + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score * sex + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score * sex + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score * sex + release_to_pretrial_end , data = county_df)

stargazer(list(m1,m2,m3,m4,m5),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", "PSA NVCA Risk Score", 
                               "sex:Black", "sex:Hispanic", "Days Released", "FTA*Black", "FTA*Hispanic",
                               "NCA*Black", "NCA*Hispanic", "NVCA*Black", "NVCA*Hispanic"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F)
```
\newpage

Sacramento--Without Interactions
\newline
```{r, results='asis'}
county_df <- sex_df %>%
  filter(county == "Sacramento")

m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score + sex + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score + sex + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score + sex + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score + sex + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score + sex + release_to_pretrial_end , data = county_df)

stargazer(list(m1,m2,m3,m4,m5),
        # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", 
                               "PSA NVCA Risk Score", "sex:Black", "sex:Hispanic", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F)
```
\newpage

Sacramento--With Interactions
\newline
```{r, results='asis'}
county_df <- sex_df %>%
  filter(county == "Sacramento")

m1 <- glm(family = binomial(),fta_flag ~ psa_fta_risk_score * sex + release_to_pretrial_end , data = county_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ psa_nca_risk_score * sex + release_to_pretrial_end , data = county_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ psa_nca_risk_score * sex + release_to_pretrial_end , data = county_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ psa_nca_risk_score * sex + release_to_pretrial_end , data = county_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ psa_nvca_risk_score * sex + release_to_pretrial_end , data = county_df)

stargazer(list(m1,m2,m3,m4,m5),
        # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("PSA FTA Risk Score", "PSA NCA Risk Score", "PSA NVCA Risk Score", 
                               "sex:Black", "sex:Hispanic", "Days Released", "FTA*Black", "FTA*Hispanic",
                               "NCA*Black", "NCA*Hispanic", "NVCA*Black", "NVCA*Hispanic"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F)
```
\newpage

# Gender AUCs

VPRAI
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "vprai", race == "All", sex != "All", county == "All") %>%
  select(sex, outcome, AUC, CI, n) %>%
  arrange(sex) %>%
  mutate(outcome = rep(c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 2))

names(tool_df) <- c("sex", "Outcome", "AUC", "CI (95%)", "N")

tool_df <- tool_df %>%
  pivot_wider(names_from = sex, values_from = c(AUC, `CI (95%)`, N))

names(tool_df) <- gsub("AUC_|CI .*_", "", names(tool_df))

kable(tool_df[1:5], booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray",
                  font_size = 10, latex_options = "hold_position") %>%
  add_header_above(c(" " = 1, "AUC" = 2, "CI (95%)" = 2)) %>% 
  add_footnote(paste("N Female =", tool_df$N_Female[1], ", N Male =", 
                     tool_df$N_Male[1]))
```
\newpage

PSA
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "psa", race == "All", sex != "All", county == "All") %>%
  select(sex, risk_score, outcome, AUC, CI, n) %>%
  arrange(sex) %>%
  mutate(risk_score = rep(c("PSA FTA", rep("PSA NCA",3), "PSA NVCA"),2),
         outcome = rep(c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"),2))

names(tool_df) <- c("sex", "Risk Score", "Outcome", "AUC", "CI (95%)", "N")

tool_df <- tool_df %>%
  pivot_wider(names_from = sex, values_from = c(AUC, `CI (95%)`, N))

names(tool_df) <- gsub("AUC_|CI .*_", "", names(tool_df))

kable(tool_df[1:6], booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray",
                  font_size = 10, latex_options = "hold_position") %>%
  add_header_above(c(" " = 2, "AUC" = 2, "CI (95%)" = 2)) %>% 
  add_footnote(paste("N Female =", tool_df$N_Female[1], ", N Male =", 
                     tool_df$N_Male[1]))
```
\newpage

San Joaquin
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "vprai", race == "All", sex != "All", county == "San Joaquin") %>%
  select(sex, outcome, AUC, CI, n) %>%
  arrange(sex) %>%
  mutate(outcome = rep(c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest", "FTA or New Arrest"), 2))

names(tool_df) <- c("sex", "Outcome", "AUC", "CI (95%)", "N")

tool_df <- tool_df %>%
  pivot_wider(names_from = sex, values_from = c(AUC, `CI (95%)`, N))

names(tool_df) <- gsub("AUC_|CI .*_", "", names(tool_df))

kable(tool_df[1:5], booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray",
                  font_size = 10, latex_options = "hold_position") %>%
  add_header_above(c(" " = 1, "AUC" = 2, "CI (95%)" = 2)) %>% 
  add_footnote(paste("N Female =", tool_df$N_Female[1], ", N Male =", 
                     tool_df$N_Male[1]))
```
\newpage

Los Angeles
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "psa", race == "All", sex != "All", county == "Los Angeles") %>%
  select(sex, risk_score, outcome, AUC, CI, n) %>%
  arrange(sex) %>%
  mutate(
    risk_score = rep(c("PSA FTA", rep("PSA NCA",3), "PSA NVCA"),2),
         outcome = rep(c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"),2))

names(tool_df) <- c("sex", "Risk Score", "Outcome", "AUC", "CI (95%)", "N")

tool_df <- tool_df %>%
  pivot_wider(names_from = sex, values_from = c(AUC, `CI (95%)`, N))

names(tool_df) <- gsub("AUC_|CI .*_", "", names(tool_df))

kable(tool_df[1:6], booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray",
                  font_size = 10, latex_options = "hold_position") %>%
  add_header_above(c(" " = 2, "AUC" = 2, "CI (95%)" = 2)) %>% 
  add_footnote(paste("N Female =", tool_df$N_Female[1], ", N Male =", 
                     tool_df$N_Male[1]))
```
\newpage

Sacramento
\newline
```{r}
tool_df <- auc_df %>%
  filter(tool_name == "psa", race == "All", sex != "All", county == "Sacramento") %>%
  select(sex, risk_score, outcome, AUC, CI, n) %>%
  arrange(sex) %>%
  mutate(risk_score = rep(c("PSA FTA", rep("PSA NCA",3), "PSA NVCA"),2),
         outcome = rep(c("FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"),2))

names(tool_df) <- c("sex", "Risk Score", "Outcome", "AUC", "CI (95%)", "N")

tool_df <- tool_df %>%
  pivot_wider(names_from = sex, values_from = c(AUC, `CI (95%)`, N))

names(tool_df) <- gsub("AUC_|CI .*_", "", names(tool_df))

kable(tool_df[1:6], booktabs = T, format.args = list(big.mark = ","), 
        # table.attr = "style = \"color: black;\"",
        format = "latex") %>%
    kable_styling(position = "center", full_width = F, 
                  bootstrap_options = c("striped", "hover"), stripe_color = "gray",
                  font_size = 10, latex_options = "hold_position") %>%
  add_header_above(c(" " = 2, "AUC" = 2, "CI (95%)" = 2)) %>% 
  add_footnote(paste("N Female =", tool_df$N_Female[1], ", N Male =", 
                     tool_df$N_Male[1]))
```
\newpage

# Old But Possibly Useful
ORAS Race Logistic Regression--NOT USED
```{r, results='asis'}
m1 <- glm(family = binomial(),fta_flag ~ oras_risk_score + race + release_to_pretrial_end , data = race_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ oras_risk_score + race + release_to_pretrial_end , data = race_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ oras_risk_score + race + release_to_pretrial_end , data = race_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ oras_risk_score + race + release_to_pretrial_end , data = race_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ oras_risk_score + race + release_to_pretrial_end , data = race_df)

stargazer(list(m1,m2,m3,m4,m5),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("ORAS Risk Score", "Race:Black", "Race:Hispanic", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F)
```
VPRAIR Race Logistic Regression--NOT USED
```{r, results='asis'}
m1 <- glm(family = binomial(),fta_flag ~ vprair_risk_score + race + release_to_pretrial_end , data = race_df)
m2 <- glm(family = binomial(),recid_arrested_flag ~ vprair_risk_score + race + release_to_pretrial_end , data = race_df)
m3 <- glm(family = binomial(),recid_filed_flag ~ vprair_risk_score + race + release_to_pretrial_end , data = race_df)
m4 <- glm(family = binomial(),recid_convicted_flag ~ vprair_risk_score + race + release_to_pretrial_end , data = race_df)
m5 <- glm(family = binomial(),recid_arrest_violent_psa_flag ~ vprair_risk_score + race + release_to_pretrial_end , data = race_df)

stargazer(list(m1,m2,m3,m4,m5),
          # type = "text",
          dep.var.labels = c("FTA", "New Arrest", "New Filing", 
                             "New Conviction", "New Violent Arrest"), 
          covariate.labels = c("VPRAIR Risk Score", "Race:Black", "Race:Hispanic", "Days Released"),
          star.char = c("*", "**", "***"),
          star.cutoffs = c(.05, .01, .001),
          notes = c("*p<0.05; **p<0.01; ***p<.001"),
          notes.append = F)
```

\newpage
OLD Race Graph VPRAI
```{r eval=FALSE, include=FALSE}

# risk_df <- eval_df %>%
#   mutate(race = factor(race, levels = c("White", "Black", "Hispanic", "Other_Unknown"))) %>%
#   filter(tool_name == "vprai", !is.na(vprai_risk_score)) %>%
#   group_by(vprai_risk_score, race) %>%
#   # select(vprai_risk_score, race, fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag,
#   #        any_pretrial_failure_flag, recid_arrest_violent_psa_flag) %>% 
#   summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag,
#                     any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
#                    ~round(mean(.x)*100, 1)), Total = n()) %>%
#   pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
#   mutate(name = case_when(name == "fta_flag" ~ "FTA",
#                           name == "recid_arrested_flag" ~ "New Arrest",
#                           name == "recid_filed_flag" ~ "New Filing",
#                           name == "recid_convicted_flag" ~ "New Conviction",
#                           name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
#                           name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
#          name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) %>%
#   filter(race %in% c("White", "Black", "Hispanic")) 
# 
# risk_df2 <- eval_df %>%
#   mutate(race = factor(race, levels = c("White", "Black", "Hispanic", "Other_Unknown"))) %>%
#   filter(tool_name == "vprai", !is.na(vprai_risk_score)) %>%
#   group_by(vprai_risk_score, race) %>%
#   # select(vprai_risk_score, race, fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag,
#   #        any_pretrial_failure_flag, recid_arrest_violent_psa_flag) %>% 
#   summarise(across(c(fta_flag, recid_arrested_flag, recid_filed_flag, recid_convicted_flag,
#                     any_pretrial_failure_flag, recid_arrest_violent_psa_flag),
#                    ~round(sd(.x)/sqrt(length(.x))*100, 1)), Total = n()) %>%
#   pivot_longer(fta_flag:recid_arrest_violent_psa_flag) %>%
#   mutate(name = case_when(name == "fta_flag" ~ "FTA",
#                           name == "recid_arrested_flag" ~ "New Arrest",
#                           name == "recid_filed_flag" ~ "New Filing",
#                           name == "recid_convicted_flag" ~ "New Conviction",
#                           name == "any_pretrial_failure_flag" ~ "FTA or New Arrest",
#                           name == "recid_arrest_violent_psa_flag" ~ "New Violent Arrest"),
#          name = factor(name, levels = c("FTA or New Arrest", "FTA", "New Arrest", "New Filing", "New Conviction", "New Violent Arrest"))) %>%
#   filter(race %in% c("White", "Black", "Hispanic")) %>%
#   rename(sd = value)
# 
# risk_df <- risk_df %>%
#   left_join(risk_df2)
# 
#   
# ggplot(risk_df) +
#   aes(x = vprai_risk_score, y = value, fill = race) +
#   # geom_smooth(method = "glm", method.args = list(family=binomial), alpha = .2) +
#   # geom_line() +
#   # geom_point() +
#   geom_col(position = "dodge") +
#   geom_errorbar(aes(ymin = value - sd, ymax = value + sd), position = "dodge")  +
#   theme_bw() +
#   # ylim(0,100) +
#   facet_wrap(~name, scales = "free_y") +
#   labs(x = "Risk Category", y = "Percent", title = "vprai Outcomes by Risk Category", 
#        caption = "Observations: 1 = 139, 2 = 118, 3 = 142, 4 = 143, 5 = 104, 6 = 49") +
#   scale_x_continuous(breaks = 1:6)
```